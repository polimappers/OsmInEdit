(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{198:function(e){e.exports={name:"osm-indoor-editor",version:"1.0.15",description:"Web tool for editing OpenStreetMap building indoors data",main:"index.js",scripts:{start:"react-scripts start",build:"react-scripts build",test:"react-scripts test",doc:"npm run doc:js:check && npm run doc:js","doc:js":"documentation build ./src/*.js ./src/ctrl ./src/model ./src/view -f html -o doc/ --shallow","doc:js:check":"documentation lint ./src/*.js ./src/ctrl ./src/model ./src/view --shallow","i18n:build":"i18nline synch && node presets_extract_labels.js","i18n:add":"tx set --auto-local -r osminedit.ui 'src/config/locales/ui/<lang>.json' --source-lang en --type KEYVALUEJSON","i18n:push":"tx push -s","i18n:pull":"tx pull -a --minimum-perc=75 && node fix_i18n_files.js && i18nline index && node presets_merge_labels.js","i18n:clean":"rm -rf ./src/config/locales/**/*.js*",icons:"for i in public/img/icons/*.svg ; do inkscape -z -e ${i%.*}.png -w 32 -h 32 $i ; done",clean:"rm -rf build/* doc/*"},repository:{type:"git",url:"https://framagit.org/PanierAvide/osminedit.git"},keywords:["openstreetmap","indoor","editor","osm","building"],author:"Adrien PAVIE, Daimler AG",license:"ISC",dependencies:{"@turf/area":"^6.0.1","@turf/bbox":"^6.0.1","@turf/bearing":"^6.0.1","@turf/boolean-contains":"^6.0.1","@turf/boolean-disjoint":"^6.0.2","@turf/boolean-intersects":"^6.0.2","@turf/boolean-point-in-polygon":"^6.0.1","@turf/boolean-point-on-line":"^6.0.1","@turf/buffer":"^5.1.5","@turf/center-of-mass":"^6.0.1","@turf/helpers":"^6.1.4","@turf/intersect":"^6.1.3","@turf/meta":"^6.0.2","@turf/nearest-point":"^6.0.1","@turf/point-on-feature":"^5.1.5","@turf/point-to-line-distance":"^6.0.0","@turf/polygon-to-line":"^6.0.3","@turf/transform-translate":"^5.1.5","array-flat-polyfill":"^1.0.1",bootstrap:"^4.3.1","fast-deep-equal":"^2.0.1","file-saver":"^2.0.2","fuse.js":"^3.4.5","geojson-validation":"^0.2.1",leaflet:"^1.5.1","leaflet-distortableimage":"^0.6.7","leaflet-draw":"^1.0.4","leaflet-editable":"^1.2.0","leaflet-geometryutil":"^0.9.1","leaflet-hash":"^0.2.1","leaflet-polylinedecorator":"^1.6.0","leaflet-textpath":"^1.2.0","leaflet-toolbar":"^0.4.0-alpha.2","martinez-polygon-clipping":"^0.7.3","mdi-react":"^5.5.0",mousetrap:"^1.6.3","nominatim-browser":"^2.0.2","object-hash":"^1.3.1","osm-auth":"^2.4.0","osm-request":"^1.2.4",osmtogeojson:"^3.0.0-beta.5","popper.js":"^1.16.1","pubsub-js":"^1.7.0",react:"^16.8.6","react-bootstrap":"^1.0.0-beta.10","react-bootstrap-multiselect":"^2.4.1","react-dom":"^16.8.6","react-dropzone":"^10.1.6","react-leaflet":"^2.4.0","react-leaflet-bing":"^4.1.0","react-scripts":"2.1.5","react-three-state-checkbox":"^1.2.2",xml2js:"^0.6.2",jquery:"^3.7.1"},devDependencies:{assert:"^1.5.0",documentation:"^9.3.1",i18nline:"^2.0.1"},eslintConfig:{extends:"react-app"},browserslist:[">0.2%","not dead","not ie <= 11","not op_mini all"],i18n:{out:"src/config/locales/ui"},homepage:"."}},407:function(e,t,a){e.exports=a(714)},430:function(e,t){L.Snap={},L.Snap.isDifferentLayer=function(e,t){var a,n,r=L.stamp(e);if(t.hasOwnProperty("_snapIgnore"))return!1;if(t.hasOwnProperty("_topOwner")&&e.hasOwnProperty("_topOwner"))return t._topOwner!==e._topOwner;if(t instanceof L.Marker)return r!==L.stamp(t);if(t.editing&&t.editing._enabled)if(t.editing._verticesHandlers){var i=t.editing._verticesHandlers[0]._markerGroup.getLayers();for(a=0,n=i.length;a<n;a++)if(L.stamp(i[a])===r)return!1}else if(t.editing._resizeMarkers){for(a=0;a<t.editing._resizeMarkers.length;a++){var o=t.editing._resizeMarkers[a];if(L.stamp(o)===r)return!1}return!t.editing._moveMarker||r!==L.stamp(t.editing._moveMarker)}return!0},L.Snap.processGuide=function(e,t,a,n,r){if(void 0!==a._layers&&"function"!==typeof a.searchBuffer)for(var i in a._layers)a._layers.hasOwnProperty(i)&&L.Snap.processGuide(e,t,a._layers[i],n,r);else if("function"===typeof a.searchBuffer){var o=a.searchBuffer(e,r);n=n.concat(o.filter(function(e){return L.Snap.isDifferentLayer(e)}))}else L.Snap.isDifferentLayer(t,a)&&n.push(a)},L.Snap.findClosestLayerSnap=function(e,t,a,n,r){for(var i,o=L.GeometryUtil.nClosestLayers(e,t,a,6),s=[],l=[],u=[],c=[],d=0;d<o.length;d++){var p=o[d];p.distance<n&&(s.push(p),p.layer.hasOwnProperty("_latlng")?l.push(p):p.layer.hasOwnProperty("_gridlineGroup")||p.layer.hasOwnProperty("_guidelineGroup")?p.layer.hasOwnProperty("_guidelineGroup")&&c.push(p):u.push(p))}if(0===s.length)return null;var h=s[0].layer,f=s[0].latlng;if(l.length>0){var m=l[0];h=m.layer,f=m.latlng}else if(u.length>0){var g=u[0];if(h=g.layer,f=g.latlng,r&&"function"===typeof g.layer.getLatLngs){var y=L.GeometryUtil.closest(e,g.layer,g.latlng,!0);if(y)L.GeometryUtil.distance(e,a,y)<n&&(f=new L.LatLng(y.lat,y.lng))}}else if(c.length>0){for(var v=c[0],b=v.layer._guidelineGroup,_=0;_<s.length;_++)if(s[_].layer._gridlineGroup!==b&&(i=L.Snap.findGuideIntersection("guide",e,a,[v,s[_]])).distance<n){f=i.intersection;break}}else 2===s.length&&(i=L.Snap.findGuideIntersection("grid",e,a,s)).distance<n&&(f=i.intersection);return{layer:h,latlng:f}},L.Snap.defaultShape=function(e){return L.Polyline._flat?L.Polyline._flat(e)?e:e[0]:e},L.Snap.findGuideIntersection=function(e,t,a,n){var r="NS"===n[0].layer["_"+e+"lineGroup"]?1:0,i="NS"===n[0].layer["_"+e+"lineGroup"]?0:1,o=L.Snap.defaultShape(n[r].layer._latlngs)[0],s=L.Snap.defaultShape(n[i].layer._latlngs)[0],l=new L.LatLng(o.lat,s.lng);return{intersection:l,distance:L.GeometryUtil.distance(t,l,a)}},L.Snap.updateSnap=function(e,t,a){e.hasOwnProperty("_latlng")&&(t&&a?(e._latlng=L.latLng(a),e.update(),e.snap!==t&&(e.snap=t,e._icon&&L.DomUtil.addClass(e._icon,"marker-snapped"),e.fire("snap",{layer:t,latlng:a}))):(e.snap&&(e._icon&&L.DomUtil.removeClass(e._icon,"marker-snapped"),e.fire("unsnap",{layer:e.snap})),delete e.snap))},L.Snap.snapMarker=function(e,t,a,n,r){var i=e.target,o=e.target._latlng||e.latlng;if(o){for(var s=[],l=0,u=t.length;l<u;l++){var c=t[l];i.hasOwnProperty("_owner")&&c._leaflet_id===i._owner||L.Snap.processGuide(o,i,c,s,r)}if(0!==s.length){var d=L.Snap.findClosestLayerSnap(a,s,o,n.snapDistance,n.snapVertices);return d=d||{layer:null,latlng:null},L.Snap.updateSnap(i,d.layer,d.latlng),e.latlng&&d.latlng&&(e.latlng=d.latlng),d}}},L.Handler.MarkerSnap=L.Handler.extend({options:{snapDistance:15,snapVertices:!0},initialize:function(e,t,a){function n(){this._buffer=e.layerPointToLatLng(new L.Point(0,0)).lat-e.layerPointToLatLng(new L.Point(this.options.snapDistance,0)).lat}L.Handler.prototype.initialize.call(this,e),this._markers=[],this._guides=[],2===arguments.length&&(t instanceof L.Class||(a=t,t=null)),L.Util.setOptions(this,a||{}),t&&(t.dragging||(t.dragging=new L.Handler.MarkerDrag(t)),t.dragging.enable(),this.watchMarker(t)),e.on("zoomend",n,this),e.whenReady(n,this),n.call(this)},enable:function(){this.disable();for(var e=0;e<this._markers.length;e++)this.watchMarker(this._markers[e])},disable:function(){for(var e=0;e<this._markers.length;e++)this.unwatchMarker(this._markers[e])},watchMarker:function(e){-1===this._markers.indexOf(e)&&this._markers.push(e),e.on("move",this._snapMarker,this),this._map.on("touchmove",this._snapMarker,this)},unwatchMarker:function(e){e.off("move",this._snapMarker,this),this._map.off("touchmove",this._snapMarker,this),delete e.snap},addGuideLayer:function(e){for(var t=0,a=this._guides.length;t<a;t++)if(L.stamp(e)===L.stamp(this._guides[t]))return;this._guides.push(e)},_snapMarker:function(e){var t=L.Snap.snapMarker(e,this._guides,this._map,this.options,this._buffer);if(e.originalEvent&&e.originalEvent.clientX&&t&&t.layer&&t.latlng){var a=this._map.project(t.latlng,this._map.getZoom());e.originalEvent.clientX=a.x,e.originalEvent.clientY=a.y,e.originalEvent.snapped=!0}}}),L.Handler.PolylineSnap=L.Edit.Poly.extend({initialize:function(e,t,a){var n=this;L.Edit.Poly.prototype.initialize.call(this,t,a),this._snapper=new L.Handler.MarkerSnap(e,a),t.on("remove",function(){n.disable()})},addGuideLayer:function(e){this._snapper.addGuideLayer(e)},_createMoveMarker:function(e,t){var a=L.Edit.Poly.prototype._createMoveMarker.call(this,e,t);return this._poly.snapediting._snapper.watchMarker(a),a},_initHandlers:function(){this._verticesHandlers=[];for(var e=0;e<this.latlngs.length;e++)this._verticesHandlers.push(new L.Edit.PolyVerticesEditSnap(this._poly,this.latlngs[e],this.options))}}),L.Edit.PolyVerticesEditSnap=L.Edit.PolyVerticesEdit.extend({_createMarker:function(e,t){var a=L.Edit.PolyVerticesEdit.prototype._createMarker.call(this,e,t);return null===t||"undefined"===typeof t?a.on("dragstart",function(){this._poly.snapediting._snapper.watchMarker(a)},this):this._poly.snapediting._snapper.watchMarker(a),a}}),L.Handler.RectangleSnap=L.Edit.Rectangle.extend({initialize:function(e,t,a){L.Edit.Rectangle.prototype.initialize.call(this,t,a),this._snapper=new L.Handler.MarkerSnap(e,a)},_createMarker:function(e,t){var a=L.Edit.Rectangle.prototype._createMarker.call(this,e,t);return this._shape.snapediting._snapper.watchMarker(a),a},addGuideLayer:function(e){this._snapper.addGuideLayer(e)}}),L.Handler.CircleSnap=L.Edit.Circle.extend({initialize:function(e,t,a){L.Edit.Circle.prototype.initialize.call(this,t,a),this._snapper=new L.Handler.MarkerSnap(e,a)},_createMarker:function(e,t){var a=L.Edit.Circle.prototype._createMarker.call(this,e,t);return this._shape.snapediting._snapper.watchMarker(a),a},addGuideLayer:function(e){this._snapper.addGuideLayer(e)}}),L.EditToolbar.SnapEdit=L.EditToolbar.Edit.extend({snapOptions:{snapDistance:15,snapVertices:!0},initialize:function(e,t){L.EditToolbar.Edit.prototype.initialize.call(this,e,t),t.snapOptions&&L.Util.extend(this.snapOptions,t.snapOptions),Array.isArray(this.snapOptions.guideLayers)?this._guideLayers=this.snapOptions.guideLayers:t.guideLayers instanceof L.LayerGroup?this._guideLayers=this.snapOptions.guideLayers.getLayers():this._guideLayers=[]},addGuideLayer:function(e){-1===this._guideLayers.findIndex(function(t){return L.stamp(e)===L.stamp(t)})&&(this._guideLayers.push(e),this._featureGroup.eachLayer(function(e){e.snapediting&&e.snapediting._guides.push(e)}))},removeGuideLayer:function(e){var t=this._guideLayers.findIndex(function(t){return L.stamp(e)===L.stamp(t)});-1!==t&&(this._guideLayers.splice(t,1),this._featureGroup.eachLayer(function(e){e.snapediting&&e.snapediting._guides.splice(t,1)}))},clearGuideLayers:function(){this._guideLayers=[],this._featureGroup.eachLayer(function(e){e.snapediting&&(e.snapediting._guides=[])})},_enableLayerEdit:function(e){L.EditToolbar.Edit.prototype._enableLayerEdit.call(this,e);var t=e.layer||e.target||e;if(!t.snapediting){t.hasOwnProperty("_mRadius")?(t.editing&&(t.editing._markerGroup.clearLayers(),delete t.editing),t.editing=t.snapediting=new L.Handler.CircleSnap(t._map,t,this.snapOptions)):t.getLatLng?t.snapediting=new L.Handler.MarkerSnap(t._map,t,this.snapOptions):t.editing?t.editing.hasOwnProperty("_shape")?(t.editing._markerGroup.clearLayers(),t.editing._shape instanceof L.Rectangle?(delete t.editing,t.editing=t.snapediting=new L.Handler.RectangleSnap(t._map,t,this.snapOptions)):t.editing._shape instanceof L.FeatureGroup?(delete t.editing,t.editing=t.snapediting=new L.Handler.FeatureGroupSnap(t._map,t,this.snapOptions)):(delete t.editing,t.editing=t.snapediting=new L.Handler.CircleSnap(t._map,t,this.snapOptions))):(t.editing._markerGroup.clearLayers(),t.editing._verticesHandlers[0]._markerGroup.clearLayers(),delete t.editing,t.editing=t.snapediting=new L.Handler.PolylineSnap(t._map,t,this.snapOptions)):t.editing=t.snapediting=new L.Handler.PolylineSnap(t._map,t,this.snapOptions);for(var a=0,n=this._guideLayers.length;a<n;a++)t.snapediting.addGuideLayer(this._guideLayers[a])}t.snapediting.enable()}}),L.EditToolbar.prototype.getEditHandler=function(e,t){return new L.EditToolbar.SnapEdit(e,{snapOptions:this.options.snapOptions,featureGroup:t,selectedPathOptions:this.options.edit.selectedPathOptions,poly:this.options.poly})},L.Draw.Feature.SnapMixin={_snap_initialize:function(){this.on("enabled",this._snap_on_enabled,this),this.on("disabled",this._snap_on_disabled,this)},_snap_on_enabled:function(){if(this.options.guideLayers)if(this._mouseMarker){this._map.off("layeradd",this._snap_on_enabled,this),this._snapper||(this._snapper=new L.Handler.MarkerSnap(this._map),this.options.snapDistance&&(this._snapper.options.snapDistance=this.options.snapDistance),this.options.snapVertices&&(this._snapper.options.snapVertices=this.options.snapVertices));for(var e=0,t=this.options.guideLayers.length;e<t;e++)this._snapper.addGuideLayer(this.options.guideLayers[e]);var a=this._mouseMarker;this._snapper.watchMarker(a);var n=a.options.icon;a.on("snap",function(e){a.setIcon(this.options.icon),a.setOpacity(1)},this),a.on("unsnap",function(e){a.setIcon(n),a.setOpacity(0)},this),a.on("click",this._snap_on_click,this),this._map.on("mousedown",this._snap_on_click,this),this._map.on("touchstart",this._snap_on_click,this)}else this._map.on("layeradd",this._snap_on_enabled,this)},_snap_on_click:function(e){if(!this._errorShown){if(this._markers){var t=this._markers.length,a=this._markers[t-1];a&&this._mouseMarker.snap&&L.DomUtil.addClass(a._icon,"marker-snapped")}if(this._startLatLng){var n=this._manuallyCorrectClick(this._startLatLng);n.latlng&&(this._mouseMarker.setLatLng(n.latlng),this._startLatLng=n.latlng)}if(this._mouseDownOrigin){var r=this._map.getZoom(),i=this._map.unproject(this._mouseDownOrigin,r),o=this._manuallyCorrectClick(i);if(o.latlng&&(this._mouseMarker.setLatLng(o.latlng),this._mouseDownOrigin=this._map.project(o.latlng,r)),e.originalEvent){var s=this._map.unproject([e.originalEvent.clientX,e.originalEvent.clientY],r),l=this._manuallyCorrectClick(s);l.latlng&&(e.originalEvent=this._map.project(l.latlng,r))}}}},_manuallyCorrectClick:function(e){var t={target:this._mouseMarker,latlng:e};if(!this._mouseMarker)return{latlng:null};var a=0;return this.hasOwnProperty("_snapper")&&this._snapper.hasOwnProperty("_buffer")&&(a=this._snapper._buffer),L.Snap.snapMarker(t,this.options.guideLayers||[],this._map,this.options,a)},_snap_on_disabled:function(){delete this._snapper}},L.Draw.Feature.include(L.Draw.Feature.SnapMixin),L.Draw.Feature.addInitHook("_snap_initialize")},48:function(module,__webpack_exports__,__webpack_require__){"use strict";var MapCSSStyle=function(){this.__init__()};MapCSSStyle.prototype={merged:!1,edited:!1,properties:[],styleType:"Style",evals:null,__init__:function(){this.evals={}},drawn:function(){return!1},has:function(e){return this.properties.indexOf(e)>-1},mergeWith:function(e){for(var t in this.properties)e[t]&&(this[t]=e[t]);this.merged=!0},setPropertyFromString:function(e,t,a){if(this.edited=!0,!a)return"boolean"===typeof this[e]?t=Boolean(t):"number"===typeof this[e]?t=Number(t):this[e]&&this[e].constructor===Array&&(t=t.split(",").map(function(e){return Number(e)})),this[e]=t,!0;this.evals[e]=t},runEvals:function runEvals(tags){var eval_functions={tag:function(e){return tags[e]},prop:function(e){},cond:function(e,t,a){return e?t:a},any:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])return arguments[e]},max:Math.max,min:Math.min};for(var k in this.evals)try{this.setPropertyFromString(k,eval("with (tags) with (eval_functions) {"+this.evals[k]+"}"),!1)}catch(e){}},toString:function(){var e="";for(var t in this.properties)this.hasOwnProperty(t)&&(e+=t+"="+this[t]+"; ");return e}},__webpack_exports__.a=MapCSSStyle},497:function(e,t){},499:function(e,t){},529:function(e,t){},530:function(e,t){},595:function(e,t){},714:function(e,t,a){"use strict";a.r(t);var n=a(6),r=a(7),i=a(0),o=a.n(i),s=a(43),l=a.n(s),u=a(179),c=a(21),d=a.n(c),p=a(23),h=a(32),f=a(38),m=a(75),g=a(11),y=a(10),v=a(12),b=a(352),_=(a(414),a(120)),E=a.n(_),w=a(28),O=a(13),k=a(159),L=a.n(k);L.a.supportedLocales=["de","en","fr","it"],L.a.defaultLocale="en",L.a.import=function(e){switch(e){case"de":return a.e(0).then(a.t.bind(null,720,3));case"en":return a.e(2).then(a.t.bind(null,721,3));case"fr":return a.e(3).then(a.t.bind(null,722,3));case"it":return a.e(4).then(a.t.bind(null,723,3));default:return a.e(1).then(a.t.bind(null,724,3))}};var S=L.a,I=a(26),N=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){return o.a.createElement(I.a,{show:this.props.show,onHide:this.props.onClose,size:"lg"},o.a.createElement(I.a.Header,{closeButton:!0},o.a.createElement(I.a.Title,null,S.t("Add level information"))),o.a.createElement(I.a.Body,null,S.t("To make your floor plans appear correctly when editing indoors, please make sure you set on which level they should show up on the left panel.")),o.a.createElement(I.a.Footer,null,o.a.createElement(O.a,{variant:"secondary",onClick:this.props.onClose},S.t("OK"))))}}]),t}(i.Component),D=a(69),M=a.n(D),C=a(130),j=a.n(C),A=a(354),x=a.n(A),T=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=this;return o.a.createElement(I.a,{show:this.props.show,onHide:this.props.onCancel,size:"lg"},o.a.createElement(I.a.Header,{closeButton:!0},o.a.createElement(I.a.Title,null,S.t("Confirm delete of %{f}",{f:this.props.name}))),o.a.createElement(I.a.Body,null,S.t("Are you sure you want to delete this feature ? You can either cancel this operation, delete only the contour of the feature, or delete the feature and everything inside (quite dangerous).")),o.a.createElement(I.a.Footer,null,o.a.createElement(O.a,{variant:"secondary",onClick:this.props.onCancel},o.a.createElement(M.a,null)," ",S.t("Cancel")),o.a.createElement(O.a,{variant:"warning",onClick:function(){return e.props.onConfirm(!1)}},o.a.createElement(x.a,null)," ",S.t("Delete only contour")),o.a.createElement(O.a,{variant:"danger",onClick:function(){return e.props.onConfirm(!0)}},o.a.createElement(j.a,null)," ",S.t("Delete everything"))))}}]),t}(i.Component),F=a(56),G=a(18),P=a.n(G),U=a(103),R=(a(257),a(3)),B=a.n(R),z=a(53),W=a(16),H=(a(428),a(429),a(430),a(258),a(431),a(432),a(153)),V=a.n(H),J=a(154),Z=a.n(J),$=a(36),q=a.n($),Y=a(400),X=a(355),K=a.n(X),Q=a(1),ee=a.n(Q),te={yes:"fwd",forward:"fwd",backward:"bwd",reversible:"both"},ae={color:"purple",fillColor:"black",opacity:.5,fillOpacity:.2,zIndex:-10},ne={},re=B.a.Handler.MarkerSnap.extend({removeGuideGeoJSON:function(e){var t=this._guides.findIndex(function(t){if(t.toGeoJSON){var a=t.toGeoJSON(8);return"Feature"===a.type&&P()(a.geometry,e)||"FeatureCollection"===a.type&&1===a.features.length&&P()(a.features[0].geometry,e)}return!1});-1!==t&&this._guides.splice(t,1)}}),ie=B.a.CircleMarker.extend({_containsPoint:function(e){return e.distanceTo(this._point)<=this._radius}}),oe=B.a.Icon.extend({_createImg:function(e,t){return(t=t||document.createElement("img")).src=e,t.onerror=function(){window.UNUSABLE_ICONS.add(t.src),t.style.display="none"},t}}),se=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"createLeafletElement",value:function(e){var t=this,a=e.styler.getFeatureStyle.bind(e.styler),n=Object.assign({},{pointToLayer:function(t,n){var r=new ie(n,a(t));return r.on("click",function(){return e.onFeatureClick(t)}),r},onFeatureClick:function(){},style:a,onEachFeature:function(a,n){n instanceof B.a.Polyline&&!(n instanceof B.a.Polygon)&&t._setLayerStyle(n,e,!1,!0)}},e);return this._createSnapHandler(e.leaflet.map),this._populateLayer(new B.a.GeoJSON(null,this.getOptions(n)),n)}},{key:"componentDidMount",value:function(){var e=this;Object(U.a)(Object(y.a)(t.prototype),"componentDidMount",this).call(this);var a=this.props.leaflet.map;ee.a.subscribe("map.editablelayer.redraw",function(t,a){e.updateLeafletElement({},e.props)}),a.on("editable:vertex:dragstart",function(t){e.leafletElement.eachLayer(function(e){return e.off("mouseover")}),e._snapFollowMarker(t.vertex),e._linesDirIcons&&t.layer&&t.layer.feature&&t.layer.feature.id&&e._linesDirIcons[t.layer.feature.id]&&a.hasLayer(e._linesDirIcons[t.layer.feature.id])&&(a.removeLayer(e._linesDirIcons[t.layer.feature.id]),delete e._linesDirIcons[t.layer.feature.id]),e._markerMove&&e._markerMove.setOpacity(0)}),a.on("editable:vertex:dragend",function(t){e.snap.unwatchMarker(t.vertex),ee.a.publish("body.edit.feature",{feature:t.layer.toGeoJSON(8)})}),this.props.allowVertexClick&&a.on("editable:vertex:rawclick",function(e){var t=window.vectorDataManager.findNodeFeature(e.latlng);!t||t.properties.own&&t.properties.own.utilityNode||(ee.a.publish("body.select.feature",{feature:t}),e.cancel())}),a.on("editable:vertex:deleted",function(e){ee.a.publish("body.edit.feature",{feature:e.layer.toGeoJSON(8)})}),a.on("editable:drawing:start",function(t){a.on("mousemove",e._followMouse,e)}),a.on("editable:drawing:click",function(t){var a=e.snapMarker.getLatLng();t.latlng.lat=a.lat,t.latlng.lng=a.lng}),ee.a.publishSync("map.editablelayer.redraw")}},{key:"componentWillUnmount",value:function(){Object(U.a)(Object(y.a)(t.prototype),"componentWillUnmount",this).call(this);var e=this.props.leaflet.map;ee.a.unsubscribe("map.editablelayer.redraw"),e.off("editable:vertex:dragstart"),e.off("editable:vertex:dragend"),e.off("editable:vertex:rawclick"),e.off("editable:vertex:deleted"),e.off("editable:drawing:start"),e.off("editable:drawing:end"),e.off("editable:drawing:click"),e.off("mousemove"),this.snapMarker&&(this.snapMarker.off("snap"),this.snapMarker.off("unsnap")),this._cleanLinesDirIcons(this.props.leaflet.map),this.updateLeafletElement(this.props,{leaflet:this.props.leaflet})}},{key:"updateLeafletElement",value:function(e,t){var a=this,n=!1,r=!1,i=!1;if(!t.style&&t.styler&&(t=Object.assign({},t,{style:t.styler.getFeatureStyle.bind(t.styler)})),e.styler!==t.styler?(this.setStyle(t.style),n=!0):this.setStyleIfChanged(e,t),e.data===t.data||P()(e.data,t.data)||(this.leafletElement.clearLayers(),!t.data||e.draw!==t.draw&&e.draw&&!t.draw||this._populateLayer(this.leafletElement,t),n=!0),e.draw!==t.draw&&(!e.draw&&t.draw?(r=!0,this._startDrawing(t)):e.draw&&!t.draw&&(this._stopDrawing(t),i=!0,this.leafletElement.clearLayers(),t.data&&this._populateLayer(this.leafletElement,t))),e.selection===t.selection&&null!==t.selection&&(r=!0,this.leafletElement.eachLayer(function(e){e.feature&&t.selection.id===e.feature.id&&e.enableEdit&&e.enableEdit()})),e.selection!==t.selection&&(!e.selection&&t.selection&&(r=!0),e.selection&&!t.selection&&(i=!0)),e.selection!==t.selection){if(this._markerMove&&e.selection&&(this.leafletElement.removeLayer(this._markerMove),e.selection.id.startsWith("node/")&&(i=!0,this._markerMove.off("moveend mousemove move"),this.snap.unwatchMarker(this._markerMove)),delete this._markerMove),t.selection!==e.selection&&this._featureIcons){if(e.selection&&t.data){var o=t.data.features.find(function(t){return t.id===e.selection.id});o&&this._addIconForLayer(o,t.styler.getFeatureStyle(o).iconImage)}if(t.selection){var s=this._featureIcons.getLayers().find(function(e){return e.options&&e.options.fid===t.selection.id});s&&this._featureIcons.removeLayer(s)}}if(t.selection&&(!t.selection.id.startsWith("node/")||!t.selection.properties.own.utilityNode)||e.selection&&(!e.selection.id.startsWith("node/")||!e.selection.properties.own.utilityNode)){var l=null;if(this.leafletElement.eachLayer(function(n){n.feature&&(e.selection&&e.selection.id===n.feature.id&&(a._setLayerStyle(n,t,!1),n.disableEdit&&n.editEnabled()&&n.disableEdit(),a.snap&&a.snap.addGuideLayer&&a.snap.addGuideLayer(new B.a.GeoJSON(n.feature.geometry))),t.selection&&t.selection.id===n.feature.id&&(a._setLayerStyle(n,t,!0),n.enableEdit&&(n.enableEdit(),l=n),a.snap&&a.snap.removeGuideGeoJSON&&a.snap.removeGuideGeoJSON(n.feature.geometry)))}),l&&t.allowFeatureDrag){var u=null,c=l.getCenter();if("LineString"===l.feature.geometry.type){var d=l.feature.geometry.coordinates[0],p=l.feature.geometry.coordinates[l.feature.geometry.coordinates.length-1];c=new B.a.LatLng((2*d[1]+p[1])/3,(2*d[0]+p[0])/3)}this._markerMove=this._createMarkerMove(c),this.leafletElement.addLayer(this._markerMove),this._markerMove.on("move",function(e){u||(u=e.target.dragging._draggable._startPos);var n=e.target.dragging._draggable._newPos,r=n.subtract(u);u=n;l.setLatLngs(function e(a){return a.lat?t.leaflet.map.layerPointToLatLng(t.leaflet.map.latLngToLayerPoint(a).add(r)):a.map(e)}(l.getLatLngs())),a._linesDirIcons&&l.feature.id&&a._linesDirIcons[l.feature.id]&&t.leaflet.map.hasLayer(a._linesDirIcons[l.feature.id])&&(t.leaflet.map.removeLayer(a._linesDirIcons[l.feature.id]),delete a._linesDirIcons[l.feature.id]),l.disableEdit&&l.disableEdit()}),this._markerMove.on("moveend",function(e){var a=Object.assign({},t.selection);a.geometry=l.toGeoJSON(8).geometry,ee.a.publish("body.edit.feature",{feature:a})})}}if(t.selection&&t.selection.id.startsWith("node/")||e.selection&&e.selection.id.startsWith("node/")){var h=t.selection&&t.selection.id.startsWith("node/")?new B.a.LatLng(t.selection.geometry.coordinates[1],t.selection.geometry.coordinates[0]):null;if((e.selection&&this._isADoorWithWidth(e.selection)||t.selection&&this._isADoorWithWidth(t.selection))&&this._addDoorLines(this.leafletElement,t.leaflet.map),t.selection&&t.selection.id.startsWith("node/")&&!t.selection.properties.own.utilityNode){this._markerMove=this._createMarkerMove(h),this.leafletElement.addLayer(this._markerMove),r=this._markerMove;var f=[];t.keepRoutingGraphConnected&&this._isRoutingGraphRelated(t.selection)&&(f=this.leafletElement.getLayers().filter(function(e){return e.feature&&a._containsCoordinates(e.feature.geometry,t.selection.geometry.coordinates)}).map(function(e){return[e,a._findNodesToUpdate(e,B.a.GeoJSON.coordsToLatLng(t.selection.geometry.coordinates))]})),this._markerMove.on("moveend",function(e){var n=Object.assign({},t.selection);n.geometry=a._markerMove.toGeoJSON(8).geometry,ee.a.publish("body.edit.feature",{feature:n});var r=a._fixLatLng(a._markerMove.getLatLng());a._updateConnectedLayers(f,r),f.forEach(function(e){if(e[0].feature){var t=Object.assign({},e[0].feature);t.geometry=e[0].toGeoJSON(8).geometry,ee.a.publish("body.edit.feature",{feature:t,select:!1})}})}),t.selection&&this._isADoorWithWidth(t.selection)&&this._doorLines&&this._markerMove.on("movestart",function(e){var n=B.a.GeoJSON.coordsToLatLng(t.selection.geometry.coordinates);a._doorLines.getLayers().filter(function(e){return e.getLatLngs().find(function(e){return e.equals(n)})}).forEach(function(e){a._doorLines.removeLayer(e)})});var m=null;this.leafletElement.eachLayer(function(e){e.feature&&e.feature.id===t.selection.id&&(m=e)}),m&&this._markerMove.on("mousemove",function(e){var t=a._fixLatLng(e.latlng);m.setLatLng(t),a._updateConnectedLayers(f,t)})}}}if(t.selection&&e.selection===t.selection&&(this._isADoorWithWidth(t.selection)&&this._addDoorLines(this.leafletElement,t.leaflet.map),"LineString"===t.selection.geometry.type)){var g=this.leafletElement.getLayers().find(function(e){return e.feature&&e.feature.id===t.selection.id});g&&this._setLayerStyle(g,t,!0,!0)}this._sortFeaturesZIndex(this.leafletElement),n&&this._addIcons(this.leafletElement),r&&(this._enableSnapping(t.leaflet.map),"object"===typeof r&&this._snapFollowMarker(r)),i&&!r&&this._disableSnapping()}},{key:"_sortFeaturesZIndex",value:function(e){var t=[];e.eachLayer(function(e){e.feature&&e instanceof B.a.Polygon&&(e.ownArea||(e._ownArea=V()(e.feature)),t.push(e))}),t.sort(function(e,t){var a=e.options&&e.options.zIndex&&!isNaN(parseInt(e.options.zIndex))?parseInt(e.options.zIndex):0,n=t.options&&t.options.zIndex&&!isNaN(parseInt(t.options.zIndex))?parseInt(t.options.zIndex):0;return a!==n?n-a:e._ownArea-t._ownArea}),t.forEach(function(e){return e.bringToBack()}),e.eachLayer(function(e){e.feature&&e instanceof B.a.Polyline&&!(e instanceof B.a.Polygon)&&e.bringToFront()}),e.eachLayer(function(e){e.feature&&e.feature.id.startsWith("node/")&&e.bringToFront()})}},{key:"_cleanLinesDirIcons",value:function(e){this._linesDirIcons&&(Object.values(this._linesDirIcons).forEach(function(t){e.hasLayer(t)&&e.removeLayer(t)}),this._linesDirIcons={})}},{key:"_populateLayer",value:function(e,t){var a=this,n=t.leaflet.map;(this._cleanLinesDirIcons(n),t.shadowData)&&new B.a.GeoJSON(t.shadowData,{style:ae}).eachLayer(function(t){t.own={shadow:!0},e.addLayer(t)});e.addData(t.data),this._addDoorLines(e,n);var r=[];return e.eachLayer(function(e){e.own&&e.own.shadow||!e.enableEdit||!e.feature||(t.draw||e.on("click",function(n){t.onFeatureClick(e.feature),a._setLayerStyle(e,t,!0)}),t.selection&&t.selection.id===e.feature.id&&a._setLayerStyle(e,t,!0)),!e.toGeoJSON||!e.feature||t.selection&&e.feature.id===t.selection.id||r.push(new B.a.GeoJSON(e.feature.geometry))}),this._snapReplaceGuideLayers(r),e}},{key:"_startDrawing",value:function(e,a){var n=this;if(a=a||this.leafletElement,this._guideAngleShow||(this._guideAngleShow=!1),e.draw&&a){var r=e.leaflet.map;a.eachLayer(function(e){return e.off("click")}),e.draw===t.DRAW_POLYGON?r.editTools.startPolygon():e.draw===t.DRAW_LINE?r.editTools.startPolyline():e.draw===t.DRAW_MARKER&&r.editTools.startMarker(),[t.DRAW_LINE,t.DRAW_POLYGON].includes(e.draw)&&r.on("editable:vertex:new",function(e){var t=e.layer.getLatLngs();if(t&&t.length>0&&Array.isArray(t[0])&&(t=t[0]),t&&t.length>1){n._guideAngleLines?(n.snap&&n._guideAngleLines.eachLayer(function(e){return n.snap.removeGuideGeoJSON(e.toGeoJSON(8))}),n._guideAngleLines.clearLayers(),r.hasLayer(n._guideAngleLines)&&r.removeLayer(n._guideAngleLines)):n._guideAngleLines=B.a.layerGroup();var a=t[t.length-1],i=t[t.length-2],o=B.a.GeometryUtil.bearing(a,i),s=B.a.GeometryUtil.destination(a,o+90,500),l=B.a.GeometryUtil.destination(a,o-90,500),u=B.a.GeometryUtil.destination(a,B.a.GeometryUtil.bearing(i,a),500),c={color:"purple",dashArray:"4",weight:2,lineCap:"butt"},d=B.a.polyline([s,l],c),p=B.a.polyline([a,u],c);n._guideAngleLines.addLayer(d),n._guideAngleLines.addLayer(p),n._lastGuideAngleLinesGeojson=[d.toGeoJSON(8),p.toGeoJSON(8)],n._guideAngleShow&&!r.hasLayer(n._guideAngleLines)&&(r.addLayer(n._guideAngleLines),n._lastGuideAngleLinesGeojson.forEach(function(e){return n.snap.addGuideLayer(new B.a.GeoJSON(e))})),q.a.unbind("a"),q.a.bind("a",function(){r.hasLayer(n._guideAngleLines)?(r.removeLayer(n._guideAngleLines),n._lastGuideAngleLinesGeojson.forEach(function(e){return n.snap.removeGuideGeoJSON(e)}),n._guideAngleShow=!1):(r.addLayer(n._guideAngleLines),n._lastGuideAngleLinesGeojson.forEach(function(e){return n.snap.addGuideLayer(new B.a.GeoJSON(e))}),n._guideAngleShow=!0)},"keypress")}else q.a.bind("a",function(){n._guideAngleShow=!n._guideAngleShow})}),r.on("editable:drawing:end",function(e){r.removeLayer(e.layer),r.off("editable:drawing:end"),r.off("editable:vertex:new"),q.a.unbind("a"),r.off("mousemove",n._followMouse,n),n.snapMarker.remove();try{var t=e.layer.toGeoJSON(8);Z.a.valid(t)?ee.a.publish("body.draw.done",{feature:t}):ee.a.publish("body.draw.cancel")}catch(e){ee.a.publish("body.draw.cancel")}})}}},{key:"_stopDrawing",value:function(e){var t=e.leaflet.map;t.off("editable:drawing:end"),t.off("editable:vertex:new"),q.a.unbind("a"),t.off("mousemove",this._followMouse,this),this.snapMarker.remove(),t.on("editable:drawing:end",function(e){t.removeLayer(e.layer)}),this._guideAngleLines&&t.hasLayer(this._guideAngleLines)&&t.removeLayer(this._guideAngleLines),t.editTools.stopDrawing()}},{key:"_followMouse",value:function(e){this.snapMarker.setLatLng(e.latlng)}},{key:"_createSnapHandler",value:function(e){var t=this;this.snap=new re(e,{snapDistance:20}),this.snapMarker=new B.a.Marker(e.getCenter(),{icon:e.editTools.createVertexIcon({className:"leaflet-div-icon leaflet-drawing-icon"}),opacity:1,zIndexOffset:1e3}),this.snapMarker.on("snap",function(a){t.snapMarker.addTo(e)}),this.snapMarker.on("unsnap",function(a){t.snapMarker.remove(),e.removeLayer(t.snapMarker)}),this._snapEnabled=!1}},{key:"_enableSnapping",value:function(e){this._snapEnabled||(this._snapEnabled=!0,this._snapFollowMarker(this.snapMarker))}},{key:"_snapFollowMarker",value:function(e){this.snap.enable(),this.snap._markers=[],this.snap.watchMarker(e)}},{key:"_snapReplaceGuideLayers",value:function(e){var t=this;this.snap._guides=[],e.forEach(function(e){return t.snap.addGuideLayer(e)})}},{key:"_disableSnapping",value:function(){this._snapEnabled&&(this.snap&&this.snap.disable(),this._snapEnabled=!1)}},{key:"_isADoorWithWidth",value:function(e){return e&&e.id&&e.id.startsWith("node/")&&e.properties.tags&&(e.properties.tags.door||e.properties.tags.entrance)&&e.properties.tags.width&&!isNaN(parseFloat(e.properties.tags.width))&&parseFloat(e.properties.tags.width)>0}},{key:"_addDoorLines",value:function(e,t){var a=this;this._doorLines&&e.hasLayer(this._doorLines)&&e.removeLayer(this._doorLines),this._doorLines=B.a.layerGroup();var n=e.getLayers().filter(function(e){return e.getLatLng&&a._isADoorWithWidth(e.feature)}),r=e.getLayers().filter(function(e){return e.feature&&e.feature.properties.tags&&a._isRoomLikeFeature(e.feature)}).map(function(e){switch(e.feature.geometry.type){case"LineString":e._asLine=e.feature;break;case"Polygon":e._asLine={type:"Feature",geometry:{type:"LineString",coordinates:e.feature.geometry.coordinates[0]}};break;default:e._asLine=null}return e}).filter(function(e){return e._asLine});n.forEach(function(e){var t=parseFloat(e.feature.properties.tags.width);if(t>0){for(var n=e.getLatLng(),i={type:"Feature",geometry:{type:"Point",coordinates:B.a.GeoJSON.latLngToCoords(n)}},o=null,s=null,l=0;l<r.length;l++){var u=r[l];if(u._asLine&&u.getBounds().contains(n)){var c=K()(i,u._asLine,{unit:"meters"});c<.1&&(!s||c<s)&&(o=u,s=c)}}if(o){var d=o.getLatLngs();if(d.length>0){Array.isArray(d[0])||(d=[d]);for(var p=null,h=0;h<d.length;h++){var f=d[h];f[0].equals(f[f.length-1])||f.push(f[0]);for(var m=0;m<f.length-1;m++)if(f[m].equals(n)||f[m+1].equals(n)||window.vectorDataManager._isOnLine(f[m].lng,f[m].lat,n.lng,n.lat,f[m+1].lng,f[m+1].lat,1e-6)){p=[f[m],f[m+1]],f[m].equals(n)&&(p[0]=m>0?f[m-1]:f[f.length-2]),f[m+1].equals(n)&&(p[1]=m+2<=f.length-1?f[m+2]:f[1]);break}if(p)break}if(p){var g=B.a.GeometryUtil.destination(n,B.a.GeometryUtil.bearing(n,p[0]),t/2),y=B.a.GeometryUtil.destination(n,B.a.GeometryUtil.bearing(n,p[1]),t/2),v=B.a.polyline([g,n,y],{color:"green",weight:12,lineCap:"butt"});v._isDoorLine=!0,v.on("click",function(){return ee.a.publish("body.select.feature",{feature:e.feature})}),a._doorLines.addLayer(v)}}}}}),e.addLayer(this._doorLines)}},{key:"_addIcons",value:function(e){var t=this;this._featureIcons&&e.hasLayer(this._featureIcons)&&e.removeLayer(this._featureIcons),this._featureIcons=B.a.layerGroup(),e.getLayers().filter(function(e){return e.options&&e.options.iconImage&&(!t.props.selection||e.feature.id!==t.props.selection.id)}).forEach(function(e){return t._addIconForLayer(e.feature,e.options.iconImage)}),e.addLayer(this._featureIcons)}},{key:"_addIconForLayer",value:function(e,t){if(e&&t){var a=window.EDITOR_URL+"img/icons/"+t;if(!window.UNUSABLE_ICONS.has(a)){var n=ne[a];n||(n=new oe({iconUrl:a,iconSize:[20,20],iconAnchor:[10,10]}),ne[a]=n),this._featureIcons.addLayer(new B.a.marker(B.a.GeoJSON.coordsToLatLng(Object(Y.a)(e).geometry.coordinates),{icon:n,interactive:!1,fid:e.id}))}}}},{key:"_removeTexts",value:function(e){document.querySelectorAll("text[clearable=true]").forEach(function(e){e.parentNode.removeChild(e)})}},{key:"_setLayerStyle",value:function(e,t,a,n){var r,i=t.style||t.styler.getFeatureStyle.bind(t.styler);if(n||(r=i(e.feature,a),e.setStyle(r)),e.feature&&"LineString"===e.feature.geometry.type){var o=this._getDirection(e.feature),s=e.feature.properties.tags;if(this._linesDirIcons&&this._linesDirIcons[e.feature.id]&&t.leaflet.map.hasLayer(this._linesDirIcons[e.feature.id])&&t.leaflet.map.removeLayer(this._linesDirIcons[e.feature.id]),s.incline||s.conveying||s.oneway)if(r||(r=i(e.feature,a)||{}),e.setText(null),"steps"!==s.highway&&(s.incline||s.conveying)||"steps"===s.highway&&s.incline){var l=!1;try{var u=e.getLatLngs();l=B.a.GeometryUtil.bearing(u[0],u[u.length-1])<0}catch(g){}var c="direction_",d=s.incline?"down"===s.incline||s.incline.startsWith("-")?"down":"up":"front",p=te[s.conveying]?te[s.conveying]:"fwd";l&&"both"!==p&&(p="fwd"===p?"bwd":"fwd"),"front"!==d&&(!l&&"bwd"===p||l&&("fwd"===p||"both"===p))&&(d="up"===d?"down":"up"),c+=d+"_"+p+"_",c+=parseInt(e.feature.id.slice(-1))%2===0?"m":"f",c+=".png";var h=window.EDITOR_URL+"img/icons/"+c;if(!window.UNUSABLE_ICONS.has(h)){var f=ne[h];f||(f=new oe({iconUrl:h,iconSize:[28,28],iconAnchor:[14,14]}),ne[h]=f),this._linesDirIcons||(this._linesDirIcons={});var m=B.a.polylineDecorator(e,{patterns:[{offset:50,repeat:100,symbol:B.a.Symbol.marker({rotate:!0,angleCorrection:l?90:-90,markerOptions:{icon:f}})}]});this._linesDirIcons[e.feature.id]=m,m.addTo(t.leaflet.map)}}else s.oneway&&e.setText("   \u27a1   ",{offset:5,repeat:!0,attributes:{fill:"#333",clearable:!0,"font-size":r.width||15},orientation:1===o?void 0:"flip"});else a?(e.setText(null),e.setText("        \u25ba",{offset:5,center:!0,attributes:{fill:"#333",clearable:!0}})):e.setText(null)}}},{key:"_getDirection",value:function(e){if(e.properties&&e.properties.tags)if(e.properties.tags.oneway)switch(e.properties.tags.oneway){case"yes":return 1;case"-1":return-1;default:return 0}else if(e.properties.tags.incline)switch(e.properties.tags.incline){case"up":return 1;case"down":return-1;default:return 0}return 0}},{key:"_createMarkerMove",value:function(e){return new B.a.Marker(e,{draggable:!0,icon:new B.a.Icon({iconUrl:"img/move.png",iconSize:[32,32],iconAnchor:[16,16]})})}},{key:"_isRoomLikeFeature",value:function(e){return e.id&&(e.id.startsWith("way/")||e.id.startsWith("relation/"))&&this._hasTags(e,{indoor:"area|room|corridor|wall",highway:"elevator"})}},{key:"_isRoutingGraphRelated",value:function(e){return this._hasTags(e,{door:"*",highway:"*",entrance:"*"})}},{key:"_hasTags",value:function(e,t){for(var a=0,n=Object.entries(t);a<n.length;a++){var r=n[a],i=Object(f.a)(r,2),o=i[0],s=i[1];if(e.properties.tags[o]===s||"*"===s&&void 0!==e.properties.tags[o]||s.split("|").includes(e.properties.tags[o]))return!0}return!1}},{key:"_containsCoordinates",value:function(e,t){switch(e.type){case"Point":return P()(e.coordinates,t);case"LineString":return-1!==e.coordinates.findIndex(function(e){return P()(e,t)});case"Polygon":for(var a=0;a<e.coordinates.length;a++)if(-1!==e.coordinates[a].findIndex(function(e){return P()(e,t)}))return!0;return!1;default:return!1}}},{key:"_findNodesToUpdate",value:function(e,t){var a=null;if(e.getLatLngs){var n=e.getLatLngs();n[0].lat?(a=[],n.forEach(function(e,n){e.lat===t.lat&&e.lng===t.lng&&a.push(n)})):(a={},n.forEach(function(e,n){e.forEach(function(e,r){e.lat===t.lat&&e.lng===t.lng&&(a[n]||(a[n]=[]),a[n].push(r))})}))}else a=e.getLatLng().equals(t);return a}},{key:"_updateConnectedLayers",value:function(e,t){e.forEach(function(e){if(e[0].setLatLngs){var a=e[0].getLatLngs();Array.isArray(e[1])?e[1].forEach(function(e){a[e]=t}):Object.entries(e[1]).forEach(function(e){e[1].forEach(function(n){a[e[0]][n]=t})}),e[0].setLatLngs(a)}else e[0].setLatLng&&!0===e[1]&&e[0].setLatLng(t)})}},{key:"_fixLatLng",value:function(e){return new B.a.LatLng(e.lat.toFixed(8),e.lng.toFixed(8))}}]),t}(z.a);se.DRAW_POLYGON=1,se.DRAW_MARKER=2,se.DRAW_LINE=3,se.PRESET_TO_DRAW={node:se.DRAW_MARKER,way:se.DRAW_LINE,closedway:se.DRAW_POLYGON};var le=Object(W.d)(se),ue=a(361),ce=a(113),de=a(185),pe=a.n(de),he=a(256),fe=a(161),me=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){return o.a.createElement(fe.a,{className:"justify-content-center bc-dense breadcrumb-arrow"},o.a.createElement(fe.a.Item,{onClick:function(e){ee.a.publishSync("body.mode.set",{mode:Jn.MODE_BUILDING}),ee.a.publish("body.unselect.feature")},active:this.props.mode===Jn.MODE_BUILDING&&!this.props.building,title:S.t("Go back to building selection")},S.t("All buildings")),this.props.building&&o.a.createElement(fe.a.Item,{onClick:function(e){return ee.a.publish("body.mode.set",{mode:Jn.MODE_BUILDING})},active:this.props.mode===Jn.MODE_BUILDING,title:S.t("Edit this single building")},Jn.GetFeatureName(this.props.building)),[Jn.MODE_LEVELS,Jn.MODE_FEATURES].includes(this.props.mode)&&o.a.createElement(fe.a.Item,{onClick:function(e){return ee.a.publish("body.unselect.feature")},active:!0},this.props.mode===Jn.MODE_LEVELS?S.t("Levels structure (level %{lvl})",{lvl:this.props.level}):S.t("Features (level %{lvl})",{lvl:this.props.level})))}}]),t}(i.Component),ge=a(90),ye=a.n(ge),ve=a(405),be=a(74),_e=a(35),Ee=a(357),we=a.n(Ee),Oe=a(123),ke=a.n(Oe),Le=a(204),Se=a(24),Ie=a(94);function Ne(e){if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=function(e,t){if(!e)return;if("string"===typeof e)return De(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return De(e,t)}(e))){var t=0,a=function(){};return{s:a,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,r,i=!0,o=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){o=!0,r=e},f:function(){try{i||null==n.return||n.return()}finally{if(o)throw r}}}}function De(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var Me=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(g.a)(this,Object(y.a)(t).call(this))).state={selectedEntries:new Set},e}return Object(v.a)(t,e),Object(r.a)(t,[{key:"_onEntrySelected",value:function(e){if("single"===this.props.type||"oneshot"===this.props.type)this.setState({selectedEntries:new Set([e])}),this.props.onChange([this.props.data[e]]);else{var t=new Set(this.state.selectedEntries);t.has(e)?t.delete(e):t.add(e),this.setState({selectedEntries:t});var a,n=[],r=Ne(t.values());try{for(r.s();!(a=r.n()).done;){var i=a.value;n.push(this.props.data[i])}}catch(o){r.e(o)}finally{r.f()}this.props.onChange(n)}}},{key:"_reloadSelection",value:function(e){if(!e||!P()(e.data,this.props.data)){var t=[];this.props.data.forEach(function(e,a){e.selected&&t.push(a)}),t.length>0&&this.setState({selectedEntries:new Set(t)})}}},{key:"render",value:function(){var e=this;return o.a.createElement(Ie.a,{style:this.props.style},this.props.data.map(function(t,a){var n=e.state.selectedEntries.has(a),r=function(){return e._onEntrySelected(a)};return o.a.createElement(Ie.a.Item,{action:!0,className:"p-2",key:a,onClick:r,active:n},"single"===e.props.type&&o.a.createElement(Se.a.Check,{type:"radio",checked:n,onChange:r,label:t.label}),"multi"===e.props.type&&o.a.createElement(Se.a.Check,{type:"checkbox",checked:n,onChange:r,label:t.label}),"oneshot"===e.props.type&&t.label)}))}},{key:"componentDidMount",value:function(){this._reloadSelection()}},{key:"componentDidUpdate",value:function(e){this._reloadSelection(e)}}]),t}(i.Component),Ce=a(111),je=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(g.a)(this,Object(y.a)(t).call(this))).state={text:"",loading:!1,searchResults:[],showList:!1},e}return Object(v.a)(t,e),Object(r.a)(t,[{key:"_search",value:function(e,t){var a=this;t=t||!1,this.setState({text:e}),(t||e!==this.state.text&&e.length>=3)&&(this.setState({loading:!0,showList:!0}),this._searchTimer&&clearTimeout(this._searchTimer),this._searchTimer=setTimeout(function(){we.a.geocode({q:e,"accept-language":S.locale}).then(function(e){e=e.map(function(e){return{label:e.display_name,coordinates:[e.lat,e.lon],bbox:e.boundingbox}}),a.setState({loading:!1,showList:!0,searchResults:e},function(){a._update&&a._update()})}).catch(function(e){console.error(e),a.setState({loading:!1,searchResults:null,showList:!1})})},t?0:2e3))}},{key:"_onSelect",value:function(e){this.setState({searchResults:[],text:"",showList:!1}),ee.a.publish("map.position.set",e)}},{key:"render",value:function(){var e=this;return o.a.createElement("div",null,o.a.createElement(Le.a,{placement:"bottom-end",show:this.state.showList,target:this.refs.input,onHide:function(){return e.setState({showList:!1,searchResults:[]})},rootClose:!0},function(t){t.placement;var a=t.scheduleUpdate,n=(t.arrowProps,t.outOfBoundaries,t.show,Object(ve.a)(t,["placement","scheduleUpdate","arrowProps","outOfBoundaries","show"]));return e._update=a,o.a.createElement("div",Object.assign({},n,{style:Object(u.a)({},n.style,{zIndex:1e4})}),e.state.searchResults?o.a.createElement(Me,{data:e.state.searchResults,type:"oneshot",onChange:function(t){return e._onSelect(t[0])},style:{fontSize:"0.8em"}}):o.a.createElement("p",null,S.t("An error happened when searching address. Please retry.")),e.state.loading&&o.a.createElement("div",{className:"text-center",style:{backgroundColor:"#f8f9fa",borderRadius:"0.25rem",border:"1px solid rgba(0, 0, 0, 0.125)",padding:"0.5rem"}},o.a.createElement(Ce.a,{animation:"grow",className:"align-middle"})," ",S.t("Searching address...")))}),o.a.createElement(_e.a,{className:"mw-25",style:{width:300},ref:"input"},o.a.createElement(be.a,{placeholder:S.t("Search a city, street..."),value:this.state.text,onChange:function(t){return e._search(t.target.value,!1)}}),o.a.createElement(_e.a.Append,null,o.a.createElement(O.a,{variant:"outline-secondary",onClick:function(){return e._search(e.state.text,!0)}},o.a.createElement(ke.a,{size:16})))))}}]),t}(i.Component),Ae=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=[Jn.MODE_BUILDING,Jn.MODE_LEVELS,Jn.MODE_FEATURES].includes(this.props.mode);return o.a.createElement(he.a,{className:this.props.className,bg:"light",expand:"xs"},o.a.createElement("div",{className:"d-flex"},o.a.createElement(he.a.Brand,{className:"app-brand",style:{cursor:"pointer"},title:S.t("Go back to map explorer"),onClick:function(){return ee.a.publish("body.mode.set",{mode:Jn.MODE_EXPLORE})}},window.EDITOR_NAME),o.a.createElement(ue.a,{className:"ml-2 hide-xsDown"},o.a.createElement(O.a,{variant:"primary",className:"mr-2 btn-mode-floorplan",active:this.props.mode===Jn.MODE_FLOOR_IMAGERY,disabled:this.props.mode===Jn.MODE_FLOOR_IMAGERY,onClick:function(){return ee.a.publish("body.mode.set",{mode:Jn.MODE_FLOOR_IMAGERY})},title:S.t("Import floor plans")},o.a.createElement(pe.a,null)," ",o.a.createElement("span",{className:"hide-smDown"},S.t("Import floor plans"))),o.a.createElement(ce.a,null,o.a.createElement(ce.a.Toggle,{variant:"primary",className:"btn-mode-editindoor",title:S.t("Edit map")},o.a.createElement(ye.a,null)," ",o.a.createElement("span",{className:"hide-smDown"},S.t("Edit map"))),o.a.createElement(ce.a.Menu,null,o.a.createElement(ce.a.Item,{active:this.props.mode===Jn.MODE_BUILDING,onClick:function(){return ee.a.publish("body.mode.set",{mode:Jn.MODE_BUILDING})}},S.t("Edit buildings")),o.a.createElement(ce.a.Item,{active:this.props.mode===Jn.MODE_LEVELS,disabled:!this.props.building,onClick:function(){return ee.a.publish("body.mode.set",{mode:Jn.MODE_LEVELS})}},S.t("Edit levels outlines (%{name})",{name:this.props.building?Jn.GetFeatureName(this.props.building):S.t("no selected building")})),o.a.createElement(ce.a.Item,{active:this.props.mode===Jn.MODE_FEATURES,disabled:!this.props.building,onClick:function(){return ee.a.publish("body.mode.set",{mode:Jn.MODE_FEATURES})}},S.t("Edit features (%{name})",{name:this.props.building?Jn.GetFeatureName(this.props.building):S.t("no selected building")})))))),e&&o.a.createElement("div",{className:"hide-mdDown"},o.a.createElement(me,this.props)),this.props.mode===Jn.MODE_EXPLORE&&o.a.createElement("span",{className:"hide-xsDown"},o.a.createElement(je,null)))}}]),t}(i.Component),xe=a(60),Te=a.n(xe),Fe=a(362),Ge=a.n(Fe),Pe=a(363),Ue=a.n(Pe),Re=a(364),Be=a.n(Re),ze=a(403),We=a(404);a(463);function He(e){if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=function(e,t){if(!e)return;if("string"===typeof e)return Ve(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Ve(e,t)}(e))){var t=0,a=function(){};return{s:a,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,r,i=!0,o=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){o=!0,r=e},f:function(){try{i||null==n.return||n.return()}finally{if(o)throw r}}}}function Ve(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var Je=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(g.a)(this,Object(y.a)(t).call(this))).state={value:null},e}return Object(v.a)(t,e),Object(r.a)(t,[{key:"_onEdit",value:function(e){var t=this;this.setState({value:e});var a=function(){var a=Object.assign({},t.props.tags,Object(m.a)({},t.props.data.key,e));"null"!==e&&""!==e.trim()||delete a[t.props.data.key],ee.a.publish("body.tags.set",{tags:a})};["combo","check","multiselect"].includes(this.props.type)?a():(this._timer&&clearTimeout(this._timer),this._timer=setTimeout(a,500))}},{key:"render",value:function(){var e=this,t=this.props.data,a="string"===typeof this.state.value?this.state.value:this.props.tags[t.key]||"",n=null,r=null;if(t.info){var i=o.a.createElement(We.a,{id:"popover-basic",title:S.t("Help"),style:{padding:"5px 0px 5px 6px"}},t.info);r=o.a.createElement(ze.a,{placement:"right",overlay:i,popperConfig:{modifiers:{preventOverflow:{boundariesElement:"window"}}}},o.a.createElement(Ue.a,null))}if(["text","number"].includes(this.props.type))n=o.a.createElement(Se.a.Group,{className:"m-0 mb-3"},o.a.createElement(Se.a.Label,null,t.text||t.key," ",r),o.a.createElement(Se.a.Control,{type:this.props.type,placeholder:t.default,value:a,onChange:function(t){return e._onEdit(t.target.value)},size:"sm"}));else if("textarea"===this.props.type)n=o.a.createElement(Se.a.Group,{className:"m-0 mb-3"},o.a.createElement(Se.a.Label,null,t.text||t.key," ",r),o.a.createElement(Se.a.Control,{as:"textarea",rows:"3",placeholder:t.default,value:a,onChange:function(t){return e._onEdit(t.target.value)},size:"sm"}));else if("combo"===this.props.type){var s=t.list_entrys?t.list_entrys.map(function(e){return e.value}):(t.values||"").split(","),l=t.list_entrys?t.list_entrys.map(function(e){return e.display_value||e.value}):t.display_values?t.display_values.split(","):s;n=o.a.createElement(Se.a.Group,{className:"m-0 mb-3"},o.a.createElement(Se.a.Label,null,t.text||t.key," ",r),o.a.createElement(Se.a.Control,{as:"select",onChange:function(t){return e._onEdit(t.target.value)},value:a,size:"sm"},(void 0===t.use_last_as_default||"false"===t.use_last_as_default)&&o.a.createElement("option",{value:"null"}),s.map(function(e,t){return o.a.createElement("option",{key:t,value:e||""},l[t])})))}else if("check"===this.props.type){var u=[{id:0,val:t.value_on||"yes",label:S.t("Yes")},{id:1,val:t.value_off||"no",label:S.t("No")},{id:2,val:"null",label:S.t("Unknown")}],c=2,d=u.filter(function(e){return e.val===a});1===d.length&&(c=d[0].id);var p=function(){var t=(c+1)%3;e._onEdit(u[t].val)};n=o.a.createElement(Se.a.Group,{className:"m-0 mb-3 form-group-check"},o.a.createElement("p",{className:"m-0"},t.text||t.key," ",r),o.a.createElement(Ge.a,{checked:0===c,indeterminate:2===c,onChange:function(){return p()}}),o.a.createElement(Se.a.Check.Label,{onClick:function(){return p()}},u[c].label))}else if("binarycheck"===this.props.type){var h=[{id:0,val:t.value_on||"yes"},{id:1,val:t.value_off||"null"}],f=1,m=h.filter(function(e){return e.val===a});1===m.length&&(f=m[0].id);var g=function(){var t=(f+1)%2;e._onEdit(h[t].val)};n=o.a.createElement(Se.a.Group,{className:"m-0 mb-3"},o.a.createElement(Se.a.Check,{type:"checkbox"},o.a.createElement(Se.a.Check.Input,{type:"checkbox",checked:0===f,onChange:function(){return g()}}),o.a.createElement(Se.a.Check.Label,{onClick:function(){return g()}},t.text||t.key," ",r)))}else if("multiselect"===this.props.type){var y=null,v=a.split(";");t.list_entrys?y=t.list_entrys.map(function(e){return{value:e.value,label:e.display_value||e.value,title:e.short_description,selected:v.includes(e.value)}}):(y=t.values.split(";").map(function(e){return{value:e,selected:v.includes(e)}}),t.display_values&&t.display_values.split(";").forEach(function(e,t){y[t].label=e})),n=o.a.createElement(Se.a.Group,{className:"m-0 mb-3"},o.a.createElement(Se.a.Label,null,t.text||t.key," ",r),o.a.createElement(Se.a.Control,{as:Be.a,data:y,multiple:!0,ref:"multiselect-"+t.key,size:"sm"}))}return n}},{key:"componentDidMount",value:function(){var e=this;if("multiselect"===this.props.type){var t=this.refs["multiselect-"+this.props.data.key].$multiselect[0];t.onchange=function(){var a,n=[],r=He(t.selectedOptions);try{for(r.s();!(a=r.n()).done;){var i=a.value;n.push(i.value)}}catch(o){r.e(o)}finally{r.f()}e._onEdit(n.join(";"))}}}},{key:"componentDidUpdate",value:function(e){(!(this.props.tags&&this.props.data&&this.props.data.key&&this.props.tags[this.props.data.key])||e.tags&&e.data&&e.data.key&&e.tags[e.data.key]&&e.tags[e.data.key]===this.props.tags[this.props.data.key])&&(!(e.tags&&e.data&&e.data.key&&e.tags[e.data.key])||this.props.tags&&this.props.data&&this.props.data.key&&this.props.tags[this.props.data.key]&&e.tags[e.data.key]===this.props.tags[this.props.data.key])||this.setState({value:null})}}]),t}(i.Component),Ze=a(55),$e=a(365),qe=a.n($e),Ye=a(366),Xe=a.n(Ye);function Ke(e){if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=function(e,t){if(!e)return;if("string"===typeof e)return Qe(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Qe(e,t)}(e))){var t=0,a=function(){};return{s:a,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,r,i=!0,o=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){o=!0,r=e},f:function(){try{i||null==n.return||n.return()}finally{if(o)throw r}}}}function Qe(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var et=["building","highway","natural","surface","landuse","power","waterway","amenity","barrier","place","leisure","railway","shop","man_made","public_transport","tourism","emergency","historic","indoor"],tt=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(g.a)(this,Object(y.a)(t).call(this))).state={tags:null,newline:!1,focusKey:null,focusVal:null},e}return Object(v.a)(t,e),Object(r.a)(t,[{key:"_tagsObjToArray",value:function(e){return e?Object.entries(e):null}},{key:"_tagsArrayToObj",value:function(e){if(e){var t={};return e.forEach(function(e){t[e[0]]=e[1]}),t}return null}},{key:"_onTagsChanged",value:function(){var e,t=this,a=[],n=Ke(document.getElementsByClassName("app-tags-row"));try{for(n.s();!(e=n.n()).done;){var r=e.value,i=r.getElementsByClassName("app-tags-row-key")[0].value,o=r.getElementsByClassName("app-tags-row-val")[0].value;a.push([i,o])}}catch(l){n.e(l)}finally{n.f()}this._timer&&(clearTimeout(this._timer),this._timer=null),this._timer=setTimeout(function(){ee.a.publish("body.tags.set",{tags:t._tagsArrayToObj(a)}),t._timer=null},500);var s={newline:!1,tags:a,focusKey:null,focusVal:null};this.state.newline&&document.activeElement&&(document.activeElement.classList.contains("app-tags-row-key")?s.focusKey=document.activeElement.value:document.activeElement.classList.contains("app-tags-row-val")&&(s.focusVal=document.activeElement.value)),this.setState(s)}},{key:"_onTagDeleted",value:function(e){var t=this._tagsArrayToObj(this.state.tags);delete t[e],ee.a.publish("body.tags.set",{tags:t}),this.state.newline&&this.setState({newline:!1,focusKey:null,focusVal:null})}},{key:"_getWikiURL",value:function(e,t){var a="https://wiki.openstreetmap.org/wiki/";return et.includes(e)?a+="Tag:"+e+"="+t:a+="Key:"+e,a}},{key:"render",value:function(){var e=this,t=(this.state.tags||[]).slice(0);return this.state.newline&&t.push(["",""]),o.a.createElement("div",{className:this.props.className},o.a.createElement("div",{className:"app-tags"},t.map(function(a,n){return o.a.createElement(_e.a,{size:"sm",className:"m-0 app-tags-row",key:n},o.a.createElement(be.a,{className:"app-tags-row-key",type:"text",size:"sm",value:a[0],disabled:e.props.locked,onChange:function(t){return e._onTagsChanged()},autoFocus:e.state.newline&&n===t.length-1||e.state.focusKey===a[0]}),o.a.createElement(be.a,{className:"app-tags-row-val",type:"text",size:"sm",value:a[1],disabled:e.props.locked,onChange:function(t){return e._onTagsChanged()},autoFocus:!e.state.newline&&e.state.focusVal===a[1]}),o.a.createElement(_e.a.Append,null,!e.props.locked&&o.a.createElement(O.a,{variant:"outline-danger",tabIndex:"-1",disabled:e.props.noDelete&&e.props.noDelete.includes(a[0]),onClick:function(){return e._onTagDeleted(a[0])}},o.a.createElement(M.a,{size:16})),o.a.createElement(O.a,{variant:"outline-info",href:e._getWikiURL(a[0],a[1]),target:"_blank",tabIndex:"-1"},o.a.createElement(qe.a,{size:16}))))})),!this.props.locked&&o.a.createElement(O.a,{variant:"secondary",className:"app-tags-add",size:"sm",block:!0,onClick:function(){return e.setState({newline:!0})},tabIndex:"-1"},o.a.createElement(Xe.a,{size:16})))}},{key:"componentDidMount",value:function(){this.setState({tags:this._tagsObjToArray(this.props.tags)})}},{key:"componentDidUpdate",value:function(e){P()(e.tags,this.props.tags)||this.setState({tags:this._tagsObjToArray(this.props.tags)})}}]),t}(i.Component),at=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"_onDone",value:function(){ee.a.publish("body.unselect.feature")}},{key:"render",value:function(){var e=this;if(!this.props.building)return o.a.createElement("div",null);var t=this.props.building,a=t.properties.tags,n=o.a.createElement("span",null,S.t("Number of levels above ground (roof excluded), here B + C + D = 3 levels"),o.a.createElement("img",{src:"img/building_levels.png",style:{height:200},alt:S.t("Schema explaining how should be set amount of levels")})),r=o.a.createElement("span",null,S.t("Number of levels completely underground, here E = 1 level"),o.a.createElement("img",{src:"img/building_levels.png",style:{height:200},alt:S.t("Schema explaining how should be set amount of levels")})),i=o.a.createElement("span",null,S.t("Number of levels under the roof, here A = 1 level"),o.a.createElement("img",{src:"img/building_levels.png",style:{height:200},alt:S.t("Schema explaining how should be set amount of levels")}));return o.a.createElement("div",null,o.a.createElement(F.a,{className:"m-0 pl-2 pr-2 mt-2"},o.a.createElement(Ze.a,{className:"d-flex align-items-top justify-content-between"},o.a.createElement(w.a,null,o.a.createElement("h3",{className:"m-0 p-0"},Jn.GetFeatureName(t))),o.a.createElement(w.a,{className:"text-right"},o.a.createElement(O.a,{variant:"outline-secondary",size:"sm",title:S.t("Done"),onClick:function(){return e._onDone()}},o.a.createElement(Te.a,null))))),o.a.createElement("div",{className:"m-2 mb-4"},o.a.createElement(Je,{type:"text",data:{text:S.t("Name"),key:"name"},tags:a}),o.a.createElement(Je,{type:"combo",data:{text:S.t("Type of building"),key:"building",values:"retail,commercial,parking,industrial,apartments,garage,school,church,warehouse,university,office,hospital,hotel,train_station,college,civic,public,yes",use_last_as_default:"force"},tags:a}),o.a.createElement(Je,{type:"text",data:{text:S.t("Total height (in meters)"),key:"building:height"},tags:a}),o.a.createElement(Je,{type:"number",data:{text:S.t("Number of overground levels (roof excluded)"),info:n,key:"building:levels"},tags:a}),o.a.createElement(Je,{type:"number",data:{text:S.t("Number of underground levels"),info:r,key:"building:levels:underground"},tags:a}),o.a.createElement(Je,{type:"number",data:{text:S.t("Number of levels under roof"),info:i,key:"roof:levels"},tags:a})),o.a.createElement("div",{className:"m-2"},o.a.createElement(tt,{tags:a,noDelete:["building","building:part"]})))}}]),t}(i.Component),nt=a(367),rt=a.n(nt),it=a(128),ot=a.n(it),st=a(192),lt=a.n(st),ut=a(93),ct=a.n(ut),dt=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e={Point:o.a.createElement(ot.a,null),LineString:o.a.createElement(lt.a,null),Polygon:o.a.createElement(ct.a,null),MultiPolygon:o.a.createElement(ct.a,null)};return o.a.createElement(Ie.a,null,Object.entries(this.props.diff).map(function(t){var a=Object(f.a)(t,2),n=a[0],r=a[1],i=r.created?"green":r.deleted?"red":"orange";return o.a.createElement(Ie.a.Item,{action:!0,className:"p-1",key:n,style:{color:i},title:Object.entries(r.metadata.tags).map(function(e){return e.join(" = ")}).join("\n")},e[r.metadata.geometry]||o.a.createElement(rt.a,null),r.metadata.name)}))}}]),t}(i.Component),pt=a(368),ht=a.n(pt),ft=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=this;return this.props.changeset?o.a.createElement("div",null,o.a.createElement("div",{className:"m-2 mb-4"},o.a.createElement("h3",{className:"m-0 p-0 mb-1"},S.t("Send changes to OpenStreetMap")),"preparing"===this.props.changeset.status&&o.a.createElement("div",{className:"text-center"},o.a.createElement(Ce.a,{animation:"grow",variant:"secondary",className:"align-middle"})," ",S.t("Analyzing your changes...")),"check"===this.props.changeset.status?o.a.createElement("div",null,o.a.createElement(Je,{type:"textarea",data:{text:S.t("Changeset comment"),key:"comment",default:S.t("Describe briefly but explicitely your edits (required)")},tags:this.props.changeset.tags}),o.a.createElement(Je,{type:"multiselect",data:{text:S.t("Sources"),key:"source",list_entrys:[{value:"local knowledge",display_value:S.t("Local knowledge")},{value:"survey",display_value:S.t("Ground survey")},{value:"aerial imagery",display_value:S.t("Aerial imagery")},{value:"streetlevel imagery",display_value:S.t("Street-level imagery")},{value:"emergency map",display_value:S.t("Emergency map")}],info:S.t("List all sources you have used to make your edits (recommended)")},tags:this.props.changeset.tags}),o.a.createElement(Je,{type:"binarycheck",data:{text:S.t("I would like someone to review my edits"),key:"review_requested"},tags:this.props.changeset.tags})):o.a.createElement("div",{className:"text-center"},"upload"===this.props.changeset.status&&o.a.createElement("div",null,o.a.createElement(Ce.a,{animation:"grow",variant:"success",className:"align-middle"})," ",S.t("Uploading your changes...")),"sent"===this.props.changeset.status&&o.a.createElement("div",null,o.a.createElement(Te.a,{size:42,style:{color:"green"}})," ",S.t("Thanks for your contribution !"),o.a.createElement("br",null),o.a.createElement(O.a,{variant:"outline-success",size:"sm",block:!0,href:window.CONFIG.osm_api_url+"/changeset/"+this.props.changeset.id,target:"_blank",rel:"noopener noreferrer"},o.a.createElement(ke.a,{size:24})," ",S.t("See your changes on OpenStreetMap")),o.a.createElement(O.a,{variant:"outline-primary",size:"sm",block:!0,onClick:function(){return ee.a.publish("body.action.cleanup")}},o.a.createElement(ye.a,{size:24})," ",S.t("Go back to editing"))),"error"===this.props.changeset.status&&o.a.createElement("div",null,o.a.createElement(ht.a,{size:42,style:{color:"red"}})," ",S.t("Oops ! There was an error during upload..."),o.a.createElement("br",null),"changeset_failed"===this.props.changeset.reason?S.t("OpenStreetMap server can't be contacted. Check your Internet connection and retry in a few minutes."):S.t("Some of your edits could have been lost, please reload and retry."),"changeset_failed"===this.props.changeset.reason&&o.a.createElement(O.a,{variant:"outline-secondary",size:"sm",onClick:function(){return ee.a.publish("body.mode.set",{mode:Jn.MODE_BUILDING})},block:!0},S.t("Go back to editing"))))),"check"===this.props.changeset.status&&o.a.createElement("div",{className:"m-2 mb-4 d-flex justify-content-between"},o.a.createElement(O.a,{variant:"success",size:"sm",onClick:function(){e.props.changeset.tags&&e.props.changeset.tags.comment&&e.props.changeset.tags.comment.trim().length>0?ee.a.publish("body.action.save"):alert(S.t("You have to give us more details about your changes using Changeset comment text field."))},className:"flex-grow-1 mr-1"},S.t("Send")),o.a.createElement(O.a,{variant:"secondary",size:"sm",onClick:function(){return ee.a.publish("body.mode.set",{mode:Jn.MODE_BUILDING})},className:"flex-grow-1 ml-1"},S.t("Cancel"))),"check"===this.props.changeset.status&&o.a.createElement("div",{className:"m-2"},o.a.createElement("h5",{className:"m-0 mt-2 p-0 mb-2"},S.t("Changeset tags")),o.a.createElement(tt,{tags:this.props.changeset.tags}),o.a.createElement("h5",{className:"m-0 mt-4 p-0 mb-2"},S.t("Your edits")),o.a.createElement(dt,{diff:this.props.changeset.diff}))):o.a.createElement("div",null)}}]),t}(i.Component),mt=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=this,t=[{id:"node",name:S.t("Point"),icon:o.a.createElement(ot.a,null),desc:S.t("For small features (size less than 2 meters)")},{id:"way",name:S.t("Line"),icon:o.a.createElement(lt.a,null),desc:S.t("For long but not large features")},{id:"closedway",name:S.t("Area"),icon:o.a.createElement(ct.a,null),desc:S.t("For wide features (surface of more than a few m\xb2)")}].filter(function(t){return!e.props.types||0===e.props.types.length||e.props.types.includes(t.id)});return o.a.createElement(F.a,null,t.map(function(t,a){return o.a.createElement(Ze.a,{key:a,className:"app-geomtype",onClick:function(){return e.props.onClick(t.id)}},o.a.createElement(w.a,{xs:2},t.icon),o.a.createElement(w.a,{className:"app-geomtype-text"},o.a.createElement("span",null,t.name),o.a.createElement("span",null,t.desc)))}))}}]),t}(i.Component),gt=a(369),yt=a.n(gt),vt=a(370),bt=a.n(vt),_t=a(371),Et=a.n(_t),wt=a(372),Ot=a.n(wt),kt=a(160),Lt=["amenity","aeroway","barrier","emergency","highway","historic","man_made","railway","shop","tourism"],St=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=this;if(this.props.preset){var t=this.props.preset.icon||null,a=void 0===this.props.preset.tags;if(!t&&this.props.preset.tags){var n=Object.entries(this.props.preset.tags).filter(function(e){return Lt.includes(e[0])});n.length>0&&(t=window.EDITOR_URL+"img/icons/"+n[0][0]+"_"+n[0][1]+".png",window.UNUSABLE_ICONS.has(t)&&(t=null))}return o.a.createElement(kt.a,{className:(this.props.className||"")+" p-1 app-preset-card"+(a?" app-preset-card-group":""),onClick:function(){return e.props.onClick(e.props.preset)}},t&&o.a.createElement("img",{width:32,height:32,className:"align-self-center mr-2 app-preset-symbol",src:t,alt:this.props.preset.name,onError:function(t){t.target.style.display="none",window.UNUSABLE_ICONS.add(t.target.src),e.forceUpdate()}}),!t&&(this.props.preset.groups||this.props.preset.items?o.a.createElement(Et.a,{size:32,className:"align-self-center mr-2 app-preset-symbol",style:{color:"gray"}}):o.a.createElement(ot.a,{size:32,className:"align-self-center mr-2 app-preset-symbol",style:{color:"gray"}})),o.a.createElement(kt.a.Body,null,o.a.createElement("h5",null,this.props.preset.name)),(this.props.preset.groups||this.props.preset.items)&&o.a.createElement(bt.a,{className:"app-preset-enter align-self-center",size:32}))}return o.a.createElement(kt.a,{className:(this.props.className||"")+" p-1 app-preset-card",onClick:function(){return e.props.onClick()}},o.a.createElement(Ot.a,{size:32,className:"align-self-center mr-2",style:{color:"gray"}}),o.a.createElement(kt.a.Body,null,o.a.createElement("h5",null,S.t("Select a preset"))))}}]),t}(i.Component),It=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(g.a)(this,Object(y.a)(t).call(this))).state={path:"/",text:""},e}return Object(v.a)(t,e),Object(r.a)(t,[{key:"_onPresetClicked",value:function(e){e.groups||e.items?this.setState({path:this.state.path+e.name+"/"}):this.props.onSelect&&this.props.onSelect(e)}},{key:"_onBackClicked",value:function(){if("/"===this.state.path&&this.props.onBack)this.props.onBack();else{var e=this.state.path.split("/").filter(function(e){return""!==e});e.pop(),this.setState({path:e.length>0?"/"+e.join("/")+"/":"/"})}}},{key:"_createEntry",value:function(e,t){return o.a.createElement(St,{key:e,className:"mb-2",preset:t,onClick:this._onPresetClicked.bind(this)})}},{key:"render",value:function(){var e,t=this,a=this.state.text.trim().length>0;return e=a?window.presetsManager.findPresetsByName(this.state.text,this.props.filter):window.presetsManager.getPresets(this.state.path,this.props.filter),o.a.createElement("div",{className:this.props.className},o.a.createElement(_e.a,{className:"mb-2"},!a&&o.a.createElement(_e.a.Prepend,null,o.a.createElement(_e.a.Text,null,o.a.createElement(ke.a,{size:18}))),o.a.createElement(be.a,{placeholder:S.t("Search a type of feature..."),value:this.state.text,onChange:function(e){return t.setState({text:e.target.value})}}),a&&o.a.createElement(_e.a.Append,null,o.a.createElement(O.a,{variant:"outline-secondary",onClick:function(){return t.setState({text:""})}},o.a.createElement(M.a,{size:16})))),("/"!==this.state.path||this.props.onBack)&&o.a.createElement(O.a,{variant:"outline-secondary",block:!0,className:"mb-2",onClick:function(){return t._onBackClicked()}},o.a.createElement(yt.a,{style:{float:"left"}})," ",S.t("Back")),"/"===this.state.path&&!a&&this.props.lastUsedPresets&&this.props.lastUsedPresets.length>0&&this.props.lastUsedPresets.map(function(e,a){return t._createEntry("lu"+a,e)}),e&&e.groups&&e.groups.map(function(e,a){return t._createEntry("g"+a,e)}),e&&e.items&&e.items.map(function(e,a){return t._createEntry("i"+a,e)}))}},{key:"componentDidMount",value:function(){this.props.initialPath&&this.setState({path:this.props.initialPath})}}]),t}(i.Component),Nt=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=this;return o.a.createElement("div",null,o.a.createElement("h3",{className:"m-2"},S.t("Add features")),!this.props.preset&&o.a.createElement(It,{key:1,className:"m-2",lastUsedPresets:this.props.lastUsedPresets,onSelect:function(e){return ee.a.publish("body.select.preset",{preset:e})}}),this.props.preset&&!this.props.draw&&o.a.createElement("div",{className:"m-2"},o.a.createElement("p",null,S.t("Please select how you want to represent your feature.")),o.a.createElement(mt,{types:this.props.preset.type,onClick:function(t){return ee.a.publish("body.select.preset",{preset:e.props.preset,type:t})}}),o.a.createElement(O.a,{variant:"outline-danger",size:"sm",onClick:function(){return ee.a.publish("body.select.preset",{preset:null})},block:!0},o.a.createElement(M.a,null)," ",S.t("Cancel"))),this.props.preset&&this.props.draw&&o.a.createElement("div",{className:"m-2"},o.a.createElement("p",null,S.t("You can draw your feature on the map. Click on done button or click again on last node you created to finish."))))}}]),t}(i.Component),Dt=a(193),Mt=a.n(Dt),Ct=a(131),jt=a(201),At={Point:"node",LineString:"way",Polygon:"closedway",MultiPolygon:"closedway"},xt=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(g.a)(this,Object(y.a)(t).call(this))).state={tab:"functional",showPresetSelect:!1},e}return Object(v.a)(t,e),Object(r.a)(t,[{key:"_onDone",value:function(){ee.a.publish("body.mode.set",{mode:this.props.mode})}},{key:"_presetToComponent",value:function(e){var t=this,a=[];if(!e)return a;var n=e.showLevel;if(e.combos&&(a=a.concat(e.combos.map(function(e,a){return o.a.createElement(Je,{type:"combo",data:e,tags:t.props.feature.properties.tags,key:"c"+a})}))),e.texts&&(a=a.concat(e.texts.map(function(e,a){return o.a.createElement(Je,{type:"text",data:e,tags:t.props.feature.properties.tags,key:"t"+a})}))),e.multiselects&&(a=a.concat(e.multiselects.filter(function(e){return"level"!==e.key||(n=!0,!1)}).map(function(e,a){return o.a.createElement(Je,{type:"multiselect",data:e,tags:t.props.feature.properties.tags,key:"m"+a})}))),e.checks&&(a=a.concat(e.checks.map(function(e,a){return o.a.createElement(Je,{type:"check",data:e,tags:t.props.feature.properties.tags,key:"ch"+a})}))),e.optionals&&(a=a.concat(this._presetToComponent(e.optionals))),n){var r=this.props.feature.properties.own&&this.props.feature.properties.own.levels||[-5,-4,-3,-2,-1,0,1,2,3,4,5];this.props.building&&this.props.building.properties.own&&this.props.building.properties.own.levels&&(r=r.concat(this.props.building.properties.own.levels));var i=Object.assign({},this.props.feature.properties.tags,{level:this.props.feature.properties.own.levels.join(";")});delete i.repeat_on,a.push(o.a.createElement(Je,{type:"multiselect",data:{key:"level",text:S.t("Floors served"),values:Object(p.a)(new Set(r)).map(function(e){return parseFloat(e)}).sort(function(e,t){return e-t}).join(";")},tags:i,key:"lvl"}))}return a}},{key:"_combinePresets",value:function(e){var t={name:Jn.GetFeatureName(this.props.feature,Object(p.a)(new Set(e.map(function(e){return e.name}))).join(", "))},a=[];return e.forEach(function(e){Object.entries(e).forEach(function(e){var n=Object(f.a)(e,2),r=n[0],i=n[1];"type"===r?(t.type||(t.type=[]),t.type=Object(p.a)(new Set(t.type.concat(i)))):Array.isArray(i)?(t[r]||(t[r]=[]),i.forEach(function(e){a.includes(e.key)||(t[r].push(e),a.push(e.key))})):"tags"===r&&(t.tags||(t.tags={}),t.tags=Object.assign({},t.tags,i))})}),t}},{key:"_lookForPreset",value:function(){this.setState({showPresetSelect:!0})}},{key:"_onChangePreset",value:function(e,t){if(t&&this.props.feature){var a=Object.assign({},this.props.feature.properties.tags);e&&e.tags&&Object.keys(e.tags).forEach(function(e){return delete a[e]}),t.tags&&(a=Object.assign(a,t.tags)),ee.a.publish("body.tags.set",{tags:a})}this.setState({showPresetSelect:!1})}},{key:"render",value:function(){var e=this;if(!this.props.feature)return o.a.createElement("div",null);var t=this.props.feature,a=t.properties.tags,n=["Polygon","MultiPolygon"].includes(t.geometry.type),r=window.presetsManager.findPresetsForFeature(t),i=this._combinePresets(r),s=r.filter(function(e){return!e.indoor_structure||"no"===e.indoor_structure});s=s.length>0?s[s.length-1]:null;var l=r.filter(function(e){return["only","yes"].includes(e.indoor_structure)});l=l.length>0?l[l.length-1]:null,this._tabFunDisabled=l&&"only"===l.indoor_structure,this._tabStrDisabled=!n||s&&"no"===s.indoor_structure,this._hasFunPreset=null!==s&&void 0!==s,this._hasStrPreset=null!==l&&void 0!==l;var u="functional"!==this.state.tab||this._tabFunDisabled?"structural":"functional";return o.a.createElement("div",null,o.a.createElement(F.a,{className:"m-0 pl-2 pr-2 mt-2"},o.a.createElement(Ze.a,{className:"d-flex align-items-top justify-content-between"},o.a.createElement(w.a,null,o.a.createElement("h3",{className:"m-0 p-0"},Jn.GetFeatureName(t))),o.a.createElement(w.a,{className:"text-right"},o.a.createElement(O.a,{variant:"outline-secondary",size:"sm",title:S.t("Done"),onClick:function(){return e._onDone()}},o.a.createElement(Te.a,null))))),o.a.createElement("div",{className:"m-2"},o.a.createElement(jt.a,{activeKey:u,id:"preset-tabs",className:"mb-2",onSelect:function(t){return e.setState({showPresetSelect:!1,tab:t})}},o.a.createElement(Ct.a,{eventKey:"functional",title:S.t("Usage"),disabled:this._tabFunDisabled},!this.state.showPresetSelect&&o.a.createElement(St,{preset:n?s:i,onClick:this._lookForPreset.bind(this),className:"mb-2"}),!this.state.showPresetSelect&&this._presetToComponent(n?s:i)),o.a.createElement(Ct.a,{eventKey:"structural",title:S.t("Structure"),disabled:this._tabStrDisabled},!this.state.showPresetSelect&&o.a.createElement(St,{preset:l,onClick:this._lookForPreset.bind(this),className:"mb-2"}),!this.state.showPresetSelect&&this._presetToComponent(l))),this.state.showPresetSelect&&o.a.createElement(It,{onSelect:function(t){return e._onChangePreset("functional"===u?s:l,t)},onBack:function(){return e.setState({showPresetSelect:!1})},filter:function(e){return(!e.type||e.type.includes(At[t.geometry.type]))&&("functional"===u||["yes","only"].includes(e.indoor_structure))}}),!this.state.showPresetSelect&&o.a.createElement(tt,{className:"mt-3",tags:a}),!this.state.showPresetSelect&&(!t.properties.own||!t.properties.own.new)&&o.a.createElement(O.a,{className:"mb-3 mt-3",variant:"outline-secondary",block:!0,size:"sm",href:window.CONFIG.osm_api_url+"/"+t.id+"/history",target:"_blank"},o.a.createElement(Mt.a,{size:20})," ",S.t("See feature history on OpenStreetMap"))))}},{key:"componentDidMount",value:function(){if(this.props.feature){var e=this._tabFunDisabled&&!this._tabStrDisabled||!this._tabFunDisabled&&!this._tabStrDisabled&&!this._hasFunPreset&&this._hasStrPreset?"structural":"functional";e!==this.state.tab&&this.setState({tab:e})}}},{key:"componentDidUpdate",value:function(e){if(e.feature&&this.props.feature&&e.feature.id!==this.props.feature.id){var t={showPresetSelect:!1},a=this._tabFunDisabled&&!this._tabStrDisabled||!this._tabFunDisabled&&!this._tabStrDisabled&&!this._hasFunPreset&&this._hasStrPreset?"structural":"functional";a!==this.state.tab&&(t.tab=a),this.setState(t)}}}]),t}(i.Component),Tt=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"_onEdit",value:function(){if(this.props.feature&&this.props.feature.properties.tags){var e=this.props.feature.properties.tags;e.building?(ee.a.publishSync("body.mode.set",{mode:Jn.MODE_BUILDING}),ee.a.publishSync("body.select.building",{building:this.props.feature})):"level"===e.indoor&&this.props.building?(ee.a.publishSync("body.mode.set",{mode:Jn.MODE_LEVELS}),ee.a.publishSync("body.select.floor",{floor:this.props.feature})):this.props.building&&(ee.a.publishSync("body.mode.set",{mode:Jn.MODE_FEATURES}),ee.a.publishSync("body.select.feature",{feature:this.props.feature}))}}},{key:"render",value:function(){var e=this;if(!this.props.feature)return o.a.createElement("div",null);var t=this.props.feature,a=t.properties.tags,n=window.presetsManager.findPresetsForFeature(t),r=Jn.GetFeatureName(t,Object(p.a)(new Set(n.map(function(e){return e.name}))).join(", "));return o.a.createElement("div",null,o.a.createElement(F.a,{className:"m-0 pl-2 pr-2 mt-2"},o.a.createElement(Ze.a,{className:"d-flex align-items-top justify-content-between"},o.a.createElement(w.a,null,o.a.createElement("h3",{className:"m-0 p-0"},r)),o.a.createElement(w.a,{className:"text-right"},o.a.createElement(O.a,{variant:"outline-secondary",size:"sm",title:S.t("Done"),onClick:function(){return ee.a.publish("body.unselect.feature")}},o.a.createElement(Te.a,null))))),o.a.createElement("div",{className:"m-2 mb-3"},this.props.building&&o.a.createElement(O.a,{variant:"outline-secondary",block:!0,size:"sm",onClick:function(){return e._onEdit()}},o.a.createElement(ye.a,null)," ",S.t("Edit this feature"))),o.a.createElement("div",{className:"m-2"},o.a.createElement(tt,{tags:a,locked:!0}),(!t.properties.own||!t.properties.own.new)&&o.a.createElement(O.a,{className:"mb-3 mt-3",variant:"outline-secondary",block:!0,size:"sm",href:window.CONFIG.osm_api_url+"/"+t.id+"/history",target:"_blank"},o.a.createElement(Mt.a,{size:20})," ",S.t("See feature history on OpenStreetMap"))))}}]),t}(i.Component),Ft=a(402),Gt=a(374),Pt=a.n(Gt),Ut=a(375),Rt=a.n(Ut),Bt=a(155),zt=a.n(Bt),Wt=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"_onOpacityChanged",value:function(e){ee.a.publish("body.imagery.opacity",{opacity:parseInt(e)/100,type:"floor"})}},{key:"_onDropImages",value:function(e){if(e.length>0)if(1===e.length&&"application/json"===e[0].type){var t=new FileReader;t.onload=function(){try{var e=JSON.parse(t.result);e&&e.length>0&&(ee.a.publish("body.floorimagery.remove"),e.forEach(function(e){if(!(e.image&&e.label&&e.id))throw new Error("Read data from JSON is missing information");e.topleft=new R.LatLng(e.topleft.lat,e.topleft.lng),e.topright=new R.LatLng(e.topright.lat,e.topright.lng),e.bottomleft=new R.LatLng(e.bottomleft.lat,e.bottomleft.lng),e.level=parseFloat(e.level)}),ee.a.publish("body.floorimagery.add",{imagery:e}))}catch(a){console.error(a)}},t.readAsText(e[0])}else Promise.all(e.filter(function(e){return e.type.startsWith("image/")}).map(function(e){return new Promise(function(t){var a=new FileReader;a.onload=function(){t({label:e.name,level:null,image:a.result,id:zt()(a.result)})},a.readAsDataURL(e)})})).then(function(e){return ee.a.publish("body.floorimagery.add",{imagery:e})})}},{key:"render",value:function(){var e=this,t=window.imageryManager.getFloorImages(),a=t&&t.find(function(e){return e.selected&&e.visible});return a&&void 0===a.opacity&&(a.opacity=1),o.a.createElement("div",{className:"m-0 pl-2 pr-2 mt-2"},o.a.createElement("h3",{className:"m-0 p-0"},S.t("Floor plan")),o.a.createElement(Ft.a,{accept:"image/jpeg, image/png, application/json",onDrop:function(t){return e._onDropImages(t)}},function(e){var t=e.getRootProps,a=e.getInputProps;return o.a.createElement("div",Object.assign({className:"dropzone m-0 mt-3 w-100"},t()),o.a.createElement("input",a()),o.a.createElement("p",null,S.t("Drag and drop your images here (or click to open file browser)"),o.a.createElement("br",null),o.a.createElement("small",null,S.t("Supported formats: JPEG, PNG, Imagery JSON"))))}),a&&o.a.createElement(_e.a,{className:"mt-3"},o.a.createElement(_e.a.Prepend,null,o.a.createElement(_e.a.Text,null,S.t("Opacity"))),o.a.createElement("div",{className:"form-control",style:{flexGrow:2}},o.a.createElement("input",{type:"range",min:"0",max:"100",step:"5",onChange:function(t){return e._onOpacityChanged(t.target.value)},value:100*a.opacity,style:{maxWidth:"100%"}})),o.a.createElement(be.a,{type:"number",min:"0",max:"100",onChange:function(t){return e._onOpacityChanged(t.target.value)},value:(100*a.opacity).toFixed(0)}),o.a.createElement(_e.a.Append,null,o.a.createElement(_e.a.Text,null,"%"))),o.a.createElement(Ie.a,{className:"mt-3",style:{width:"100%"}},t.map(function(a,n){var r=function(e){e.stopPropagation(),ee.a.publish("body.floorimagery.update",{imagery:t.map(function(e){var t=Object.assign({},e);return t.visible=e.id===a.id?!e.visible:e.visible,t})})};return o.a.createElement(Ie.a.Item,{key:n,style:{display:"flex",alignItems:"center",paddingLeft:"0.5rem"},active:a.selected,onClick:function(){ee.a.publish("body.floorimagery.update",{imagery:t.map(function(e){var t=Object.assign({},e);return t.selected=e.id===a.id,t})}),e.props.floorImageryMode||ee.a.publish("body.floorimagery.mode",{mode:"scale"})}},a.visible?o.a.createElement(Pt.a,{size:28,onClick:function(e){return r(e)}}):o.a.createElement(Rt.a,{size:28,onClick:function(e){return r(e)}}),o.a.createElement("img",{src:a.image,style:{width:30,height:30,margin:"0 5px",border:"1px solid #ccc"},alt:""}),a.label.substring(0,a.label.lastIndexOf(".")),o.a.createElement(Se.a.Control,{type:"number",placeholder:S.t("Level"),value:null===a.level||isNaN(a.level)?"":a.level,step:"any",onChange:function(e){return ee.a.publish("body.floorimagery.update",{imagery:[Object.assign({},a,{level:parseFloat(e.target.value)})]})},style:{width:80,display:"inline-block",position:"absolute",right:5},required:!0,isInvalid:null===a.level||isNaN(a.level)}),o.a.createElement(Se.a.Control.Feedback,{type:"invalid",style:a.selected?{color:"white"}:{}},S.t("Please choose a level")))})))}}]),t}(i.Component),Ht=a(376),Vt=a.n(Ht),Jt=a(377),Zt=a.n(Jt),$t=a(197),qt=a.n($t),Yt=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"_editWithoutFloorContour",value:function(){ee.a.publish("body.select.floor",{floor:this.props.building}),ee.a.publish("body.mode.set",{mode:Jn.MODE_FEATURES})}},{key:"render",value:function(){var e=this;if(!this.props.building)return o.a.createElement("div",null);var t=window.vectorDataManager.getLevelFootprint(this.props.building,this.props.level||0),a=window.vectorDataManager.getCopiableLevels(this.props.building).filter(function(t){return t!==e.props.level});return a.reverse(),o.a.createElement("div",{className:"m-0 pl-2 pr-2 mt-2"},o.a.createElement("h3",{className:"m-0 mb-2 p-0"},S.t("Level %{lvl}",{lvl:this.props.level})),this.props.draw&&o.a.createElement("p",null,S.t("You can draw your feature on the map. Click on done button or click again on last node you created to finish.")),!this.props.draw&&!this.props.floor&&t.length>0&&o.a.createElement("p",null,S.t("Please select the floor part to edit using the map.")),!this.props.draw&&!this.props.floor&&0===t.length&&[o.a.createElement("p",{className:"m-0",key:0},S.t("This level doesn't have a precise floor outline defined yet.")),o.a.createElement(O.a,{variant:"outline-primary",className:"mt-2 w-100",key:1,onClick:function(){return ee.a.publish("body.create.floor",{feature:e.props.building})}},o.a.createElement(Zt.a,null)," ",S.t("Use the whole building footprint")),o.a.createElement(O.a,{variant:"outline-secondary",className:"mt-2 w-100",key:2,onClick:function(){return ee.a.publish("body.draw.floor")}},o.a.createElement(qt.a,null)," ",S.t("Draw this floor outline"))],!this.props.draw&&!this.props.floor&&0===t.length&&a.length>0&&o.a.createElement(_e.a,{className:"mt-2 w-100"},o.a.createElement(_e.a.Prepend,null,o.a.createElement(_e.a.Text,null,o.a.createElement(Vt.a,{size:18})," ",S.t("Copy level"))),o.a.createElement(Se.a.Control,{as:"select",ref:"levelSelect"},a.map(function(e,t){return o.a.createElement("option",{key:t},e)})),o.a.createElement(_e.a.Append,null,o.a.createElement(O.a,{variant:"outline-secondary",title:S.t("Copy selected level data in the current level"),onClick:function(){return ee.a.publish("body.level.copy",{use:e.refs.levelSelect.value})}},o.a.createElement(Te.a,{size:18})))))}}]),t}(i.Component),Xt=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){if(!this.props.floor)return o.a.createElement("div",null);var e=o.a.createElement("span",null,S.t("Relative floor level height in meters"),o.a.createElement("img",{src:"img/floor_height.jpg",style:{height:200},alt:S.t("Schema explaining how should be set level height")}));return o.a.createElement(F.a,{className:"m-0 pl-2 pr-2 mt-2"},o.a.createElement(Ze.a,{className:"d-flex align-items-top justify-content-between"},o.a.createElement(w.a,null,o.a.createElement("h3",{className:"m-0 p-0"},Jn.GetFeatureName(this.props.floor))),o.a.createElement(w.a,{className:"text-right"},o.a.createElement(O.a,{variant:"outline-secondary",size:"sm",title:S.t("Done"),onClick:function(){return ee.a.publish("body.unselect.feature")}},o.a.createElement(Te.a,null)))),o.a.createElement(Ze.a,{className:"mt-2"},o.a.createElement(w.a,{className:"m-0 p-2"},o.a.createElement("div",{className:"m-2 mb-4"},o.a.createElement(Je,{type:"text",data:{text:S.t("Name"),key:"name"},tags:this.props.floor.properties.tags}),o.a.createElement(Je,{type:"text",data:{text:S.t("Height (in meters)"),key:"height",info:e},tags:this.props.floor.properties.tags}),o.a.createElement(Je,{type:"check",data:{text:S.t("Surrounded by walls"),key:"wall"},tags:this.props.floor.properties.tags})),o.a.createElement("div",{className:"m-2"},o.a.createElement(tt,{tags:this.props.floor.properties.tags})))))}}]),t}(i.Component),Kt=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e;switch(this.props.pane){case t.PANE_BUILDING_EDIT:e=o.a.createElement(at,this.props);break;case t.PANE_LEVELS_ADD:e=o.a.createElement(Yt,this.props);break;case t.PANE_LEVELS_EDIT:e=o.a.createElement(Xt,this.props);break;case t.PANE_FEATURE_ADD:e=o.a.createElement(Nt,this.props);break;case t.PANE_FEATURE_EDIT:e=o.a.createElement(xt,this.props);break;case t.PANE_FEATURE_VIEW:e=o.a.createElement(Tt,this.props);break;case t.PANE_CHANGESET:e=o.a.createElement(ft,this.props);break;case t.PANE_FLOOR_IMAGERY:e=o.a.createElement(Wt,this.props);break;default:e=o.a.createElement("div",null)}return e}}]),t}(i.Component);Kt.PANE_BUILDING_EDIT=1,Kt.PANE_LEVELS_ADD=2,Kt.PANE_LEVELS_EDIT=3,Kt.PANE_FEATURE_ADD=4,Kt.PANE_FEATURE_EDIT=5,Kt.PANE_FEATURE_VIEW=6,Kt.PANE_CHANGESET=7,Kt.PANE_FLOOR_IMAGERY=8;var Qt=Kt,ea=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=!window.CONFIG.always_authenticated;return o.a.createElement(I.a,{show:this.props.show,onHide:this.props.onClose,style:{zIndex:20010}},o.a.createElement(I.a.Header,{closeButton:e},o.a.createElement(I.a.Title,null,S.t("Login or create account"))),o.a.createElement(I.a.Body,null,window.CONFIG.always_authenticated?S.t("To view and edit map data, you need to connect first using an OpenStreetMap account."):S.t("To edit map data, you need to connect first using an OpenStreetMap account.")),o.a.createElement(I.a.Footer,null,e&&o.a.createElement(O.a,{variant:"secondary",onClick:this.props.onClose},S.t("Cancel")),o.a.createElement(O.a,{variant:"primary",onClick:this.props.onLogin},S.t("Login or create account"))))}}]),t}(i.Component),ta=(a(464),a(465),a(270)),aa=a(271),na=a(268),ra=a(266),ia=a(269),oa=a(378),sa=a(267),la=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=window.vectorDataManager.getOSMBuildings(this.props.level);return this.props.locked?o.a.createElement(sa.a,{data:e,style:{color:"purple",fillColor:"black",opacity:.5,fillOpacity:.2}}):o.a.createElement(le,{data:e,onFeatureClick:function(e){return ee.a.publish("body.select.building",{building:e})},selection:this.props.building,styler:this.props.styler,draw:this.props.draw})}}]),t}(i.Component),ua={},ca=R.Icon.extend({_createImg:function(e,t){return(t=t||document.createElement("img")).src=e,t.onerror=function(){window.UNUSABLE_ICONS.add(t.src),t.style.display="none"},t}}),da=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"createLeafletElement",value:function(e){var t=e.styler.getFeatureStyle.bind(e.styler),a=Object.assign({},{pointToLayer:function(e,a){return new R.CircleMarker(a,t(e))},onFeatureClick:function(){},onEachFeature:function(e,t){t.on("click",function(){ee.a.publish("body.select.feature",{feature:e})})},style:t},e);return this._populateLayer(new R.GeoJSON(null,this.getOptions(a)),a)}},{key:"componentDidMount",value:function(){Object(U.a)(Object(y.a)(t.prototype),"componentDidMount",this).call(this),this._sortFeaturesZIndex(this.leafletElement)}},{key:"updateLeafletElement",value:function(e,t){t.style||(t=Object.assign({},t,{style:t.styler.getFeatureStyle.bind(t.styler)})),e.styler!==t.styler?this.setStyle(t.style):this.setStyleIfChanged(e,t),e.data===t.data||P()(e.data,t.data)||(this.leafletElement.clearLayers(),this._populateLayer(this.leafletElement,t)),this._sortFeaturesZIndex(this.leafletElement)}},{key:"_sortFeaturesZIndex",value:function(e){e.eachLayer(function(e){e.feature&&e instanceof R.Polyline&&!(e instanceof R.Polygon)&&e.bringToFront()}),e.eachLayer(function(e){e.feature&&e.feature.id.startsWith("node/")&&e.bringToFront()})}},{key:"_addIcons",value:function(e){var t=this;this._featureIcons&&e.hasLayer(this._featureIcons)&&e.removeLayer(this._featureIcons),this._featureIcons=new R.LayerGroup;var a=e.getLayers().filter(function(e){return e.options&&e.options.iconImage&&(!t.props.selection||e.feature.id!==t.props.selection.id)});a.forEach(function(e){var a=window.EDITOR_URL+"img/icons/"+e.options.iconImage,n=e.getLatLng?e.getLatLng():e.getBounds?e.getBounds().getCenter():null;if(n&&!window.UNUSABLE_ICONS.has(a)){var r=ua[a];r||(r=new ca({iconUrl:a,iconSize:[20,20],iconAnchor:[10,10]}),ua[a]=r),t._featureIcons.addLayer(new R.Marker(n,{icon:r,interactive:!1}))}}),e.addLayer(this._featureIcons)}},{key:"_populateLayer",value:function(e,t){return e.addData(t.data),this._addIcons(e),e}}]),t}(z.a),pa=Object(W.d)(da),ha=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){if(this.props.locked){var e=window.vectorDataManager.getFeaturesInLevel(null,this.props.level),t=window.vectorDataManager.getOSMBuildings(this.props.level).features;return e.features=t.concat(e.features),o.a.createElement(pa,{data:e,styler:this.props.styler,level:this.props.level})}var a=window.vectorDataManager.getFeaturesInLevel(this.props.building,this.props.level),n=this.props.building;return n&&(n={type:"FeatureCollection",features:window.vectorDataManager.getLevelFootprint(this.props.building,this.props.level).concat(n)}),o.a.createElement(le,{data:a,shadowData:n,selection:this.props.feature,onFeatureClick:function(e){return ee.a.publish("body.select.feature",{feature:e})},styler:this.props.styler,draw:this.props.draw,allowVertexClick:!0,allowFeatureDrag:!0,keepRoutingGraphConnected:!0,level:this.props.level})}}]),t}(i.Component),fa=a(58),ma=(a(466),a(467),a(468),{0:3,1:2,2:1,3:0});B.a.DistortableImage.Edit.include({_scaleBy:function(e){(e===1/0||isNaN(e)||0===e)&&(e=1);var t,a,n=this._overlay,r=n._map,i=r.getZoom(),o=r.project(n.getCorner(ma[this._lastDragUsed]),i);for(t=0;t<4;t++)t!==ma[this._lastDragUsed]&&(a=r.project(n.getCorner(t),i).subtract(o).multiplyBy(e).add(o),n.setCorner(t,r.unproject(a,i)));n._reset()},_rotateBy:function(e){var t,a,n,r=this._overlay,i=r._map,o=i.getZoom(),s=i.project(r.getCenter(),o);for(t=0;t<4;t++)a=i.project(r.getCorner(t),o).subtract(s),n=B.a.point(Math.cos(e)*a.x-Math.sin(e)*a.y,Math.sin(e)*a.x+Math.cos(e)*a.y),r.setCorner(t,i.unproject(n.add(s),o));this._overlay.rotation-=B.a.TrigUtil.radiansToDegrees(e),r._reset()},_showMarkers:function(){var e=this;if("lock"!==this._mode){var t=this._handles[this._mode],a=0;t.eachLayer(function(t){var n=t.dragging,r=t.options;t.setOpacity(1),n&&n.enable(),r.draggable&&(r.draggable=!0);var i=parseInt(a.toString());t.once("dragstart",function(){e._lastDragUsed=i}),a++})}}}),B.a.ScaleHandle.include({_calculateScalingFactor:function(e,t){var a=this._handled,n=a._map,r=n.latLngToLayerPoint(a.getCorner(ma[this._corner])),i=n.latLngToLayerPoint(e),o=n.latLngToLayerPoint(t),s=this._d2(r,i),l=this._d2(r,o);return Math.sqrt(l/s)}});var ga=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"createLeafletElement",value:function(e){return B.a.distortableImageOverlay(e.data.image,{selected:e.data.editing,corners:[e.data.topleft,e.data.topright,e.data.bottomleft,e.data.bottomright?e.data.bottomright:B.a.latLng(e.data.bottomleft.lat,e.data.topright.lng)],keymapper:!1,suppressToolbar:!0,mode:"scale"})}},{key:"componentDidMount",value:function(){var e=this;Object(U.a)(Object(y.a)(t.prototype),"componentDidMount",this).call(this),this.leafletElement.setOpacity(this.props.opacity),this.updateLeafletElement({tool:"scale",data:{}},this.props),this._onDragging(this.leafletElement,this.props),this._checkSelect=setInterval(function(){e.props.mode===Jn.MODE_FLOOR_IMAGERY&&e.props.data.selected&&e.props.tool&&e.props.data.visible&&(e.leafletElement.editing.enabled()||e.leafletElement.editing.enable(),e.leafletElement.editing._selected||e.leafletElement.editing._select())},100)}},{key:"_onDragEnd",value:function(e,t){var a=this;return function(){a._timerDragend&&clearTimeout(a._timerDragend),a._timerDragend=setTimeout(function(){var a=e.getCorners();ee.a.publish("body.floorimagery.update",{imagery:[Object.assign({},t.data,{topleft:a[0],topright:a[1],bottomleft:a[2],bottomright:a[3]})]})},10)}}},{key:"_onDragging",value:function(e,t){var a=this._onDragEnd(e,t);e.editing.dragging&&e.editing.dragging.once("dragend",a),e.editing._handles&&Object.entries(e.editing._handles).forEach(function(e){e[1].eachLayer(function(e){e.once("dragend",a)})})}},{key:"updateLeafletElement",value:function(e,t){if(t.data.image!==e.data.image&&this.leafletElement.setUrl(t.data.image),t.bounds!==e.bounds&&this.leafletElement.setBounds(B.a.latLngBounds(t.bounds)),t.data.topleft!==e.data.topleft||t.data.topright!==e.data.topright||t.data.bottomleft!==e.data.bottomleft||t.data.bottomright!==e.data.bottomright){var a=this.leafletElement.getCorners(),n=[t.data.topleft,t.data.topright,t.data.bottomleft,t.data.bottomright?t.data.bottomright:B.a.latLng(t.data.bottomleft.lat,t.data.topright.lng)];P()(a,n)||(this.leafletElement.setCorners(n),this.leafletElement.editing&&this.leafletElement.editing._handles&&Object.values(this.leafletElement.editing._handles).forEach(function(e){e.eachLayer(function(e){e.updateHandle&&e.updateHandle()})}))}t.tool&&t.data.selected&&t.data.visible&&(this.leafletElement.editing.enabled()||this.leafletElement.editing.enable(),this.leafletElement.editing._selected||this.leafletElement.editing._select(),this.leafletElement.setZIndex(1e3)),t.tool&&t.data.selected&&t.data.visible||(this.leafletElement.editing.enabled()&&this.leafletElement.editing.disable(),this.leafletElement.editing._selected&&this.leafletElement.editing._deselect(),this.leafletElement.setZIndex(1)),t.data.visible&&(e.tool!==t.tool&&t.data.selected||e.data.selected!==t.data.selected&&t.data.selected)&&("scale"===t.tool&&("scale"!==this.leafletElement.editing._mode&&this.leafletElement.editing._toggleScale(),this.leafletElement.setOpacity(t.opacity)),"rotate"===t.tool&&"rotate"!==this.leafletElement.editing._mode&&this.leafletElement.editing._toggleRotate(),"distort"===t.tool&&"distort"!==this.leafletElement.editing._mode&&("rotate"===this.leafletElement.editing._mode&&this.leafletElement.editing._toggleRotate(),"scale"===this.leafletElement.editing._mode&&this.leafletElement.editing._toggleScale())),t.data.visible?t.mode===Jn.MODE_FLOOR_IMAGERY?(this.leafletElement.setOpacity(t.opacity),this._onDragging(this.leafletElement,t)):isNaN(t.data.level)||t.level!==t.data.level?this.leafletElement.setOpacity(0):this.leafletElement.setOpacity(t.opacity):this.leafletElement.setOpacity(0)}},{key:"componentWillUnmount",value:function(){Object(U.a)(Object(y.a)(t.prototype),"componentWillUnmount",this).call(this),this._checkSelect&&(clearInterval(this._checkSelect),delete this._checkSelect)}}]),t}(fa.a),ya=Object(W.d)(ga),va=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=window.vectorDataManager.getLevelFootprint(this.props.building,this.props.level)||[],t={type:"FeatureCollection",features:e};return this.props.floor&&!e.includes(this.props.floor)&&e.push(this.props.floor),o.a.createElement(le,{data:t,shadowData:this.props.building,selection:this.props.floor,onFeatureClick:function(e){return ee.a.publish("body.select.floor",{floor:e})},draw:this.props.draw,styler:this.props.styler})}}]),t}(i.Component),ba=a(79);function _a(e){if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=function(e,t){if(!e)return;if("string"===typeof e)return Ea(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Ea(e,t)}(e))){var t=0,a=function(){};return{s:a,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,r,i=!0,o=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){o=!0,r=e},f:function(){try{i||null==n.return||n.return()}finally{if(o)throw r}}}}function Ea(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var wa=R.Control.extend({onAdd:function(e){return this.container=R.DomUtil.create("div","leaflet-bar leaflet-control-levels"),this.setAvailableLevels(this.options.levels),this.setLevel(this.options.level),this.container},setAvailableLevels:function(e){var t=this;this.container.innerHTML="",this._levels=e.map(function(e){return parseFloat(e)})||[0],this._levels.sort(function(e,t){return e-t});for(var a=0;a<this._levels.length-1;a++){var n=this._levels[a],r=this._levels[a+1];if(r-n>1)for(var i=Math.floor(n+1),o=Math.floor(r)===r?r-1:Math.floor(r);o>=i;o--)this._levels.splice(a+1,0,o)}var s=this._levels[0],l=this._levels[this._levels.length-1];if(this._levels.length>10){this._mode="condensed",this._lastByTen=null;for(var u=Math.floor(s/10),c=function(e){var a=parseInt(e.toString()),n=R.DomUtil.create("a","leaflet-control-level-byten lvl-byten"+a);n.innerHTML=a+"X",n.addEventListener("click",function(e){var n,r=_a(t.container.getElementsByClassName("leaflet-control-level-byten-extended"));try{for(r.s();!(n=r.n()).done;){n.value.classList.remove("leaflet-control-level-byten-extended")}}catch(p){r.e(p)}finally{r.f()}var i,o=_a(t.container.getElementsByClassName("leaflet-control-levels-inten"));try{for(o.s();!(i=o.n()).done;){var s=i.value;t.container.removeChild(s)}}catch(p){o.e(p)}finally{o.f()}if(t._lastByTen!==a){e.target.classList.add("leaflet-control-level-byten-extended");var l=R.DomUtil.create("div","leaflet-bar leaflet-control-levels-inten");l.style.position="absolute",l.style.top=e.target.offsetTop-4+"px",l.style.right="32px";for(var u=t._levels.filter(function(e){return e>=10*a&&e<10*a+10}),c=function(e){var a=u[e],n=parseFloat(a.toString()),r=R.DomUtil.create("a","leaflet-control-level lvl"+n);r.innerHTML=n,r.addEventListener("click",function(){ee.a.publish("body.level.set",{level:n})}),a===t._level&&r.classList.add("leaflet-control-level-selected"),l.appendChild(r)},d=u.length-1;d>=0;d--)c(d);t.container.appendChild(l),t._lastByTen=a}else t._lastByTen=null}),t.container.appendChild(n)},d=Math.floor(l/10);d>=u;d--)c(d)}else{this._mode="extended";for(var p=function(e){var a=t._levels[e],n=parseFloat(a.toString()),r=R.DomUtil.create("a","leaflet-control-level lvl"+n);r.innerHTML=n,r.addEventListener("click",function(){ee.a.publish("body.level.set",{level:n})}),t.container.appendChild(r)},h=this._levels.length-1;h>=0;h--)p(h)}},setLevel:function(e){var t,a=_a(this.container.getElementsByClassName("leaflet-control-level-selected"));try{for(a.s();!(t=a.n()).done;){t.value.classList.remove("leaflet-control-level-selected")}}catch(l){a.e(l)}finally{a.f()}var n,r=_a(this.container.getElementsByClassName("leaflet-control-level-byten-selected"));try{for(r.s();!(n=r.n()).done;){n.value.classList.remove("leaflet-control-level-byten-selected")}}catch(l){r.e(l)}finally{r.f()}if("extended"===this._mode||null!==this._lastByTen){var i=this.container.getElementsByClassName("lvl"+e)[0];i?(i.classList.add("leaflet-control-level-selected"),this._level=e):(this.setAvailableLevels(this._levels.concat([e])),this.setLevel(e))}if("condensed"===this._mode){var o=Math.floor(e/10),s=this.container.getElementsByClassName("lvl-byten"+o)[0];s?(s.classList.add("leaflet-control-level-byten-selected"),this._level=e):(this.setAvailableLevels(this._levels.concat([e])),this.setLevel(e))}},onRemove:function(e){}}),Oa=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"createLeafletElement",value:function(e){return new wa(e)}},{key:"updateLeafletElement",value:function(e,t){P()(e.levels,t.levels)||(this.leafletElement.setAvailableLevels(t.levels),this.leafletElement.setLevel(t.level)),e.level!==t.level&&this.leafletElement.setLevel(t.level)}}]),t}(ba.a),ka=Object(W.d)(Oa),La=function(){};La.prototype={type:"",params:[],init:function(e){return this.type=e,this.params=Array.prototype.slice.call(arguments,1),this},test:function(e){var t=this.params;switch(this.type){case"eq":return e[t[0]]===t[1];case"ne":return e[t[0]]!==t[1];case"regex":return new RegExp(t[1],"i").test(e[t[0]]);case"true":return"true"===e[t[0]]||"yes"===e[t[0]]||"1"===e[t[0]];case"false":return"false"===e[t[0]]||"no"===e[t[0]]||"0"===e[t[0]];case"set":return void 0!==e[t[0]]&&""!==e[t[0]];case"unset":return void 0===e[t[0]]||""===e[t[0]];case"<":return Number(e[t[0]])<Number(t[1]);case"<=":return Number(e[t[0]])<=Number(t[1]);case">":return Number(e[t[0]])>Number(t[1]);case">=":return Number(e[t[0]])>=Number(t[1]);default:return!1}},toString:function(){return"["+this.type+": "+this.params+"]"}};var Sa=La,Ia=a(48),Na=function(){this.__init__()};for(var Da in Na.prototype={set_tags:null,breaker:!1,styleType:"InstructionStyle",__init__:function(){},addSetTag:function(e,t){this.edited=!0,this.set_tags||(this.set_tags={}),this.set_tags[e]=t}},Ia.a.prototype)void 0===Na.prototype[Da]&&(Na.prototype[Da]=Ia.a.prototype[Da]);var Ma=Na,Ca=function(){this.__init__()};for(var ja in Ca.prototype={properties:["title"],styleType:"MetaStyle"},Ia.a.prototype)void 0===Ca.prototype[ja]&&(Ca.prototype[ja]=Ia.a.prototype[ja]);var Aa=Ca,xa=function(){this.__init__()};for(var Ta in xa.prototype={properties:["icon_image","icon_width","icon_height","icon_opacity","rotation","icon_image_aliases","symbol_size"],icon_image:null,icon_width:0,icon_height:NaN,icon_image_aliases:"",rotation:NaN,styleType:"PointStyle",drawn:function(){return null!==this.icon_image},maxwidth:function(){return this.evals.icon_width?0:this.icon_width},setImageAliases:function(){if(this.icon_image_aliases.replace){var e="{ "+this.icon_image_aliases.replace(/'/g,"")+" }";this.icon_image_aliases=JSON.parse(e)}}},Ia.a.prototype)void 0===xa.prototype[Ta]&&(xa.prototype[Ta]=Ia.a.prototype[Ta]);var Fa=xa,Ga=function(){this.__init__()};for(var Pa in Ga.prototype={properties:["width","offset","color","opacity","dashes","linecap","linejoin","line_style","fill_image","fill_color","fill_opacity","casing_width","casing_color","casing_opacity","casing_dashes","layer","z_index"],width:0,color:null,opacity:NaN,dashes:[],linecap:null,linejoin:null,line_style:null,fill_image:null,fill_color:null,fill_opacity:NaN,casing_width:NaN,casing_color:null,casing_opacity:NaN,casing_dashes:[],z_index:NaN,layer:NaN,styleType:"ShapeStyle",drawn:function(){return this.fill_image||!isNaN(this.fill_color)||this.width||this.casing_width},maxwidth:function(){return this.evals.width||this.evals.casing_width?0:this.width+(this.casing_width?2*this.casing_width:0)},strokeStyler:function(){var e,t;switch(this.linecap){case"round":e="round";break;case"square":e="square";break;default:e="butt"}switch(this.linejoin){case"bevel":t="bevel";break;case"miter":t=4;break;default:t="round"}return{color:this.dojoColor(this.color?this.color:0,this.opacity?this.opacity:1),style:"Solid",width:this.width,cap:e,join:t}},shapeStrokeStyler:function(){return isNaN(this.casing_color)?{width:0}:{color:this.dojoColor(this.casing_color,this.casing_opacity?this.casing_opacity:1),width:this.casing_width?this.casing_width:1}},shapeFillStyler:function(){return isNaN(this.color)?null:this.dojoColor(this.color,this.opacity?this.opacity:1)},fillStyler:function(){return this.dojoColor(this.fill_color,this.fill_opacity?this.fill_opacity:1)},casingStyler:function(){var e,t;switch(this.linecap){case"round":e="round";break;case"square":e="square";break;default:e="butt"}switch(this.linejoin){case"bevel":t="bevel";break;case"miter":t=4;break;default:t="round"}return{color:this.dojoColor(this.casing_color?this.casing_color:0,this.casing_opacity?this.casing_opacity:1),width:this.width+2*this.casing_width,style:"Solid",cap:e,join:t}}},Ia.a.prototype)void 0===Ga.prototype[Pa]&&(Ga.prototype[Pa]=Ia.a.prototype[Pa]);var Ua=Ga,Ra=function(){this.__init__()};for(var Ba in Ra.prototype={has:function(e){return this.properties.indexOf(e)>-1},properties:["shield_image","shield_width","shield_height"],shield_image:null,shield_width:NaN,shield_height:NaN,styleType:"ShieldStyle"},Ia.a.prototype)void 0===Ra.prototype[Ba]&&(Ra.prototype[Ba]=Ia.a.prototype[Ba]);var za=Ra,Wa=function(){};Wa.prototype={conditions:[],isAnd:!0,minZoom:0,maxZoom:255,subject:"",addSubject:function(e){this.subject=e,this.conditions=[]},addCondition:function(e){this.conditions.push(e)},test:function(e,t,a){if(""!==this.subject&&"*"!==this.subject&&!e.isSubject(this.subject))return!1;if(a<this.minZoom||a>this.maxZoom)return!1;var n=!0,r=0,i=this.isAnd;return this.conditions.filter(function(e){return null!==e}).forEach(function(e){var a=e.test(t);n=0===r?a:i?n&&a:n||a,r++}),n},toString:function(){return this.subject+" z"+this.minZoom+"-"+this.maxZoom+": "+this.conditions}};var Ha=Wa,Va=function(){function e(){Object(n.a)(this,e),this.rules=[],this.subpart="default"}return Object(r.a)(e,[{key:"addRule",value:function(e){this.rules.push(new Ha),this.rules[this.rules.length-1].addSubject(e)}},{key:"addConditionToLast",value:function(e){this.rules[this.rules.length-1].addCondition(e)}},{key:"addZoomToLast",value:function(e,t){this.rules[this.rules.length-1].minZoom=e,this.rules[this.rules.length-1].maxZoom=t}},{key:"length",value:function(){return this.rules.length}},{key:"setSubpart",value:function(e){this.subpart=e||"default"}},{key:"test",value:function(e,t,a,n){if(0===this.rules.length)return!0;if(-1===e&&(e=this.rules.length-1),!this.rules[e].test(t,a,n))return!1;if(0===e)return!0;for(var r=t.getParentObjects(),i=0;i<r.length;i++){var o=r[i];if(this.test(e-1,o,o.tags,n))return!0}return!1}}]),e}(),Ja=function(){this.ruleChains=[new Va],this.styles=[]};Ja.prototype={ruleChains:[],styles:[],zoomSpecific:!1,rcpos:0,stylepos:0,constructor:function(){},currentChain:function(){return this.ruleChains[this.ruleChains.length-1]},newRuleChain:function(){this.ruleChains[this.ruleChains.length-1].length()>0&&this.ruleChains.push(new Va)},addStyles:function(e){this.styles=this.styles.concat(e)},updateStyles:function(e,t,a,n){for(var r in this.zoomSpecific&&(a.validAt=n),this.ruleChains){var i=this.ruleChains[r];if(i.test(-1,e,t,n))for(var o in a.addSubpart(i.subpart),this.styles){var s,l=function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a]);return e},u=this.styles[o];switch(u.styleType){case"ShapeStyle":a.maxwidth=Math.max(a.maxwidth,u.maxwidth()),s=a.shapeStyles;break;case"ShieldStyle":s=a.shieldStyles;break;case"TextStyle":s=a.textStyles;break;case"MetaStyle":s=a.metaStyles;break;case"PointStyle":a.maxwidth=Math.max(a.maxwidth,u.maxwidth()),u.setImageAliases(),s=a.pointStyles;break;case"InstructionStyle":if(u.breaker)return;for(var c in u.set_tags)t[c]=u.set_tags[c];s={};break;default:s={}}u.drawn()&&(t[":drawn"]="yes"),t._width=a.maxwidth,u.runEvals(t),s[i.subpart]?l(s[i.subpart],u):s[i.subpart]=l({},u)}}}};var Za=Ja,$a=function(){function e(){Object(n.a)(this,e),this.shapeStyles={},this.textStyles={},this.pointStyles={},this.shieldStyles={},this.metaStyles={},this.maxwidth=0,this.subparts=[],this.validAt=-1}return Object(r.a)(e,[{key:"hasStyles",value:function(){return this.hasShapeStyles()||this.hasTextStyles()||this.hasPointStyles()||this.hasShieldStyles()||this.hasMetaStyles()}},{key:"hasFills",value:function(){for(var e in this.shapeStyles)if(!isNaN(this.shapeStyles(e).fill_color)||this.shapeStyles(e).fill_image)return!0;return!1}},{key:"layerOverride",value:function(){for(var e in this.shapeStyles)if(!isNaN(this.shapeStyles[e].layer))return this.shapeStyles[e].layer;return NaN}},{key:"addSubpart",value:function(e){-1===this.subparts.indexOf(e)&&this.subparts.push(e)}},{key:"isValidAt",value:function(e){return-1===this.validAt||this.validAt===e}},{key:"toString",value:function(){var e,t="";for(e in this.shapeStyles)t+="- SS "+e+"="+this.shapeStyles[e]+"\n";for(e in this.textStyles)t+="- TS "+e+"="+this.textStyles[e]+"\n";for(e in this.pointStyles)t+="- PS "+e+"="+this.pointStyles[e]+"\n";for(e in this.shieldStyles)t+="- sS "+e+"="+this.shieldStyles[e]+"\n";for(e in this.metaStyles)t+="- MS "+e+"="+this.metaStyles[e]+"\n";return t}},{key:"hasShapeStyles",value:function(){for(var e in this.shapeStyles)return!0;return!1}},{key:"hasTextStyles",value:function(){for(var e in this.textStyles)return!0;return!1}},{key:"hasPointStyles",value:function(){for(var e in this.pointStyles)return!0;return!1}},{key:"hasShieldStyles",value:function(){for(var e in this.shieldStyles)return!0;return!1}},{key:"hasMetaStyles",value:function(){for(var e in this.metaStyles)return!0;return!1}}]),e}(),qa=function(){this.__init__()};for(var Ya in qa.prototype={properties:["font_family","font_bold","font_italic","font_caps","font_underline","font_size","text_color","text_offset","max_width","text","text_halo_color","text_halo_radius","text_center","letter_spacing","text_opacity"],font_family:null,font_bold:!1,font_italic:!1,font_underline:!1,font_caps:!1,font_size:NaN,text_color:null,text_offset:NaN,max_width:NaN,text:null,text_halo_color:null,text_halo_radius:0,text_center:!0,letter_spacing:0,styleType:"TextStyle",fontStyler:function(){return{family:this.font_family?this.font_family:"Arial",size:this.font_size?2*this.font_size:"10px",weight:this.font_bold?"bold":"normal",style:this.font_italic?"italic":"normal"}},textStyler:function(e){return{decoration:this.font_underline?"underline":"none",align:"middle",text:e}},fillStyler:function(){return this.dojoColor(0,1)}},Ia.a.prototype)void 0===qa.prototype[Ya]&&(qa.prototype[Ya]=Ia.a.prototype[Ya]);var Xa=qa,Ka=function(){};Ka.prototype={choosers:[],getStyles:function(e,t,a){var n=new $a;for(var r in this.choosers)this.choosers[r].updateStyles(e,t,n,a);return n},parseCSS:function(e){var t=0,a=new Za;this.choosers=[],e=e.replace(/[\r\n]/g,"");for(var n={};e.length>0;)if(n=this.COMMENT.exec(e))e=e.replace(this.COMMENT,"");else if(n=this.WHITESPACE.exec(e))e=e.replace(this.WHITESPACE,"");else if(n=this.CLASS.exec(e))t===this.oDECLARATION&&(this.saveChooser(a),a=new Za),e=e.replace(this.CLASS,""),a.currentChain().addConditionToLast((new Sa).init("set",n[1])),t=this.oCONDITION;else if(n=this.NOT_CLASS.exec(e))t===this.oDECLARATION&&(this.saveChooser(a),a=new Za),e=e.replace(this.NOT_CLASS,""),a.currentChain().addConditionToLast((new Sa).init("unset",n[1])),t=this.oCONDITION;else if(n=this.ZOOM.exec(e)){t!==this.oOBJECT&&t!==this.oCONDITION&&a.currentChain().addRule(),e=e.replace(this.ZOOM,"");var r=this.parseZoom(n[1]);a.currentChain().addZoomToLast(r[0],r[1]),a.zoomSpecific=!0,t=this.oZOOM}else if(n=this.GROUP.exec(e))e=e.replace(this.GROUP,""),a.newRuleChain(),t=this.oGROUP;else if(n=this.CONDITION.exec(e))t===this.oDECLARATION&&(this.saveChooser(a),a=new Za),t!==this.oOBJECT&&t!==this.oZOOM&&t!==this.oCONDITION&&a.currentChain().addRule(),e=e.replace(this.CONDITION,""),a.currentChain().addConditionToLast(this.parseCondition(n[1])),t=this.oCONDITION;else if(n=this.OBJECT.exec(e))t===this.oDECLARATION&&(this.saveChooser(a),a=new Za),e=e.replace(this.OBJECT,""),a.currentChain().addRule(n[1]),t=this.oOBJECT;else if(n=this.SUBPART.exec(e))t===this.oDECLARATION&&(this.saveChooser(a),a=new Za),e=e.replace(this.SUBPART,""),a.currentChain().setSubpart(n[1]),t=this.oSUBPART;else{if(!(n=this.DECLARATION.exec(e)))throw(n=this.UNKNOWN.exec(e))?(e=e.replace(this.UNKNOWN,""),new Error('Error while parsing MapCSS at "'+n[1]+(e.length>38?e.substr(0,36)+"...":e)+'"')):new Error("MapCSS parsing choked on "+e);e=e.replace(this.DECLARATION,""),a.addStyles(this.parseDeclaration(n[1])),t=this.oDECLARATION}t===this.oDECLARATION&&(this.saveChooser(a),a=new Za),this.callback&&this.callback()},saveChooser:function(e){this.choosers.push(e)},parseDeclaration:function(e){var t,a,n=[],r={},i={},o=new Ua,s=new Fa,l=new Xa,u=new za,c=new Ma,d=new Aa,p=e.split(";"),h={};for(var f in p){var m=p[f];(i=this.ASSIGNMENT_EVAL.exec(m))?(r[t=i[1].replace(this.DASH,"_")]=i[2],h[t]=!0):(i=this.ASSIGNMENT.exec(m))?r[t=i[1].replace(this.DASH,"_")]=i[2]:(i=this.SET_TAG_EVAL.exec(m))||((i=this.SET_TAG.exec(m))?c.addSetTag(i[1],i[2]):(i=this.SET_TAG_TRUE.exec(m))?c.addSetTag(i[1],!0):(i=this.EXIT.exec(m))&&c.setPropertyFromString("breaker",!0))}for(m in r.font_weight&&(r.font_bold=!!r.font_weight.match(this.BOLD),delete r.font_weight),r.font_style&&(r.font_italic=!!r.font_style.match(this.ITALIC),delete r.font_style),r.text_decoration&&(r.font_underline=!!r.text_decoration.match(this.UNDERLINE),delete r.text_decoration),r.text_position&&(r.text_center=!!r.text_position.match(this.CENTER),delete r.text_position),r.text_transform&&(r.text_transform.match(this.CAPS)?r.font_caps=!0:r.font_caps=!1,delete r.text_transform),r)a=r[m],o.has(m)?o.setPropertyFromString(m,a,h[m]):s.has(m)?s.setPropertyFromString(m,a,h[m]):l.has(m)?l.setPropertyFromString(m,a,h[m]):u.has(m)?u.setPropertyFromString(m,a,h[m]):d.has(m)&&d.setPropertyFromString(m,a,h[m]);return o.edited&&n.push(o),s.edited&&n.push(s),l.edited&&n.push(l),u.edited&&n.push(u),c.edited&&n.push(c),d.edited&&n.push(d),n},parseZoom:function(e){var t={};return(t=this.ZOOM_MINMAX.exec(e))?[t[1],t[2]]:(t=this.ZOOM_MIN.exec(e))?[t[1],999]:(t=this.ZOOM_MAX.exec(e))?[-999,t[1]]:(t=this.ZOOM_SINGLE.exec(e))?[t[1],t[1]]:null},parseCondition:function(e){var t={};return(t=this.CONDITION_TRUE.exec(e))?(new Sa).init("true",t[1]):(t=this.CONDITION_FALSE.exec(e))?(new Sa).init("false",t[1]):(t=this.CONDITION_SET.exec(e))?(new Sa).init("set",t[1]):(t=this.CONDITION_UNSET.exec(e))?(new Sa).init("unset",t[1]):(t=this.CONDITION_NE.exec(e))?(new Sa).init("ne",t[1],t[2]):(t=this.CONDITION_GT.exec(e))?(new Sa).init(">",t[1],t[2]):(t=this.CONDITION_GE.exec(e))?(new Sa).init(">=",t[1],t[2]):(t=this.CONDITION_LT.exec(e))?(new Sa).init("<",t[1],t[2]):(t=this.CONDITION_LE.exec(e))?(new Sa).init("<=",t[1],t[2]):(t=this.CONDITION_REGEX.exec(e))?(new Sa).init("regex",t[1],t[2]):(t=this.CONDITION_EQ.exec(e))?(new Sa).init("eq",t[1],t[2]):null},parseCSSColor:function(e){if(e=e.toLowerCase(),this.CSSCOLORS[e])return this.CSSCOLORS[e];var t=this.HEX.exec(e);return t?3===t[1].length?Number("0x"+t[1].charAt(0)+t[1].charAt(0)+t[1].charAt(1)+t[1].charAt(1)+t[1].charAt(2)+t[1].charAt(2)):6===t[1].length?Number("0x"+t[1]):Number("0x000000"):0},WHITESPACE:/^\s+/,COMMENT:/\/\*.+?\*\/\s*/,CLASS:/^([.:]\w+)\s*/,NOT_CLASS:/^!([.:]\w+)\s*/,ZOOM:/^\|\s*z([\d-]+)\s*/i,GROUP:/^,\s*/i,CONDITION:/^\[(.+?)\]\s*/,OBJECT:/^(\w+|\*)\s*/,DECLARATION:/^\{(.+?)\}\s*/,SUBPART:/^::(\w+)\s*/,UNKNOWN:/^(\S+)\s*/,ZOOM_MINMAX:/^(\d+)-(\d+)$/,ZOOM_MIN:/^(\d+)-$/,ZOOM_MAX:/^-(\d+)$/,ZOOM_SINGLE:/^(\d+)$/,CONDITION_TRUE:/^\s*([:\w]+)\s*=\s*yes\s*$/i,CONDITION_FALSE:/^\s*([:\w]+)\s*=\s*no\s*$/i,CONDITION_SET:/^\s*([:\w]+)\s*$/,CONDITION_UNSET:/^\s*!([:\w]+)\s*$/,CONDITION_EQ:/^\s*([:\w]+)\s*=\s*(.+)\s*$/,CONDITION_NE:/^\s*([:\w]+)\s*!==\s*(.+)\s*$/,CONDITION_GT:/^\s*([:\w]+)\s*>\s*(.+)\s*$/,CONDITION_GE:/^\s*([:\w]+)\s*>=\s*(.+)\s*$/,CONDITION_LT:/^\s*([:\w]+)\s*<\s*(.+)\s*$/,CONDITION_LE:/^\s*([:\w]+)\s*<=\s*(.+)\s*$/,CONDITION_REGEX:/^\s*([:\w]+)\s*=~\/\s*(.+)\/\s*$/,ASSIGNMENT_EVAL:/^\s*(\S+)\s*:\s*eval\s*\(\s*['"](.+?)['"]\s*\)\s*$/i,ASSIGNMENT:/^\s*(\S+)\s*:\s*(.+?)\s*$/,SET_TAG_EVAL:/^\s*set\s+(\S+)\s*=\s*eval\s*\(\s*'(.+?)'\s*\)\s*$/i,SET_TAG:/^\s*set\s+(\S+)\s*=\s*(.+?)\s*$/i,SET_TAG_TRUE:/^\s*set\s+(\S+)\s*$/i,EXIT:/^\s*exit\s*$/i,oZOOM:2,oGROUP:3,oCONDITION:4,oOBJECT:5,oDECLARATION:6,oSUBPART:7,DASH:/-/g,COLOR:/color$/,BOLD:/^bold$/i,ITALIC:/^italic|oblique$/i,UNDERLINE:/^underline$/i,CAPS:/^uppercase$/i,CENTER:/^center$/i,FALSE:/^(no|false|0)$/i,HEX:/^#([0-9a-f]+)$/i,CSSCOLORS:{aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgrey:13882323,lightgreen:9498256,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662680,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14184595,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074}};var Qa=Ka,en=function(){function e(){var t=this;Object(n.a)(this,e),fetch("./style.mapcss").then(function(e){return e.text()}).then(function(e){t.mapcss=new Qa,t.mapcss.parseCSS(e)})}return Object(r.a)(e,[{key:"getFeatureStyle",value:function(e,t){if(!e)return{};if(e.properties.tags&&e.properties.tags.door&&e.properties.own&&e.properties.own.onBuildingContour)return{opacity:1,fillOpacity:1,weight:2,radius:7,color:"#8B3100",fillColor:"#FF6B00"};var a={},n=this._getFeatureStyleMapCSS(e,t);if(!n)return a;var r,i=function(e,t){if(e&&t)for(var a=t.length-1;a>=0;a--)if(e&&void 0!==e[t[a]])return e[t[a]]};switch(e.geometry.type){case"Point":r=Object.assign({},n.shapeStyles.default,n.pointStyles.default),a.color=i(r,["color","symbol_stroke_color"]),a.opacity=i(r,["opacity","symbol_stroke_opacity"]),a.weight=i(r,["width","symbol_stroke_width"]),a.radius=i(r,["symbol_size"]),a.radius&&(a.radius=a.radius/2),a.fillColor=i(r,["fill_color","symbol_fill_color"]),a.fillOpacity=i(r,["fill_opacity","symbol_fill_opacity"]),a.zIndex=i(r,["z_index"]),a.iconImage=this._getImageIconUrl(r,e);var o=i(r,["dashes"]);void 0!==o&&(a.dashArray=o.join(","));break;case"LineString":case"MultiLineString":r=Object.assign({},n.shapeStyles.default,n.pointStyles.default),a.color=i(r,["color"]),a.opacity=i(r,["opacity"]),a.weight=i(r,["width"]),a.lineCap=i(r,["linecap"]),a.zIndex=i(r,["z_index"]),a.iconImage=this._getImageIconUrl(r,e),"none"===a.lineCap&&(a.lineCap="butt");var s=i(r,["offset"]);void 0!==s&&(a.offset=-s);var l=i(r,["dashes"]);void 0!==l&&(a.dashArray=l.join(","));break;case"Polygon":case"MultiPolygon":r=Object.assign({},n.shapeStyles.default,n.pointStyles.default),a.color=i(r,["color","casing_color"]),a.zIndex=i(r,["z_index"]),a.iconImage=this._getImageIconUrl(r,e),a.opacity=i(r,["opacity","casing_opacity"]),a.weight=i(r,["width","casing_width"]),a.fillColor=i(r,["fill_color"]),a.fillOpacity=i(r,["fill_opacity"]);var u=i(r,["dashes"]);void 0!==u&&(a.dashArray=u.join(","))}for(var c in a)void 0===a[c]&&delete a[c];return a}},{key:"_getFeatureStyleMapCSS",value:function(e,t){return this.mapcss?this.mapcss.getStyles({isSubject:this._isSubject(e),getParentObjects:this._getParentObjects(e)},Object.assign(e.properties&&e.properties.tainted?{":tainted":!0}:{},e.properties&&e.properties.geometry?{":placeholder":!0}:{},e.is_placeholder?{":placeholder":!0}:{},this._hasInterestingTags(e.properties)?{":tagged":!0}:{":untagged":!0},t?{":active":!0}:{},function(t,a,n){var r={"@id":e.properties.id};for(var i in a)r["@"+i]=a[i];for(var o in t)r[o.replace(/^@/,"@@")]=t[o];return r}(e.properties.tags,e.properties.meta)),18):null}},{key:"_hasInterestingTags",value:function(e){return!0}},{key:"_getImageIconUrl",value:function(e,t){if(e&&e.icon_image){var a=/url\('([a-zA-Z0-9.-_$[\]]+)'\)/,n=/\$\[(\w+)\]/;if(e.icon_image.match(a)){for(var r=a.exec(e.icon_image)[1];r&&n.test(r);){var i=n.exec(r)[1],o=t.properties.tags[i];"string"===typeof e.icon_image_aliases[o]&&(o=e.icon_image_aliases[o]),r=r.replace(n,o)}return r}}else;}},{key:"_isSubject",value:function(e){return function(t){switch(t){case"node":return"node"===e.properties.type||"Point"===e.geometry.type;case"area":return"Polygon"===e.geometry.type||"MultiPolygon"===e.geometry.type;case"line":return"LineString"===e.geometry.type||"MultiLineString"===e.geometry.type;case"way":return"way"===e.properties.type;case"relation":return"relation"===e.properties.type;default:return!1}}}},{key:"_getParentObjects",value:function(e){return function(){return e.properties.relations&&Array.isArray(e.properties.relations)&&0!==e.properties.relations.length?e.properties.relations.map(function(e){return{tags:e.reltags,isSubject:function(t){return"relation"===t||"area"===t&&"multipolyon"===e.reltags.type},getParentObjects:function(){return[]}}}):[]}}}]),e}(),tn=R.Control.extend({onAdd:function(e){var t=R.DomUtil.create("div","leaflet-bar leaflet-control-north"),a=R.DomUtil.create("img");return a.src="img/north.png",t.appendChild(a),t}}),an=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"createLeafletElement",value:function(e){return new tn(e)}}]),t}(ba.a),nn=Object(W.d)(an),rn=a(198),on=R.Control.extend({onAdd:function(e){this.container=R.DomUtil.create("div","leaflet-bar leaflet-control-sidepanelbtn hide-xsDown");var t=R.DomUtil.create("a");return t.innerHTML="<svg><path d='M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z' /></svg>",t.addEventListener("click",function(){return ee.a.publish("body.panel.toggle",{panel:"right"})}),this.container.appendChild(t),this.container}}),sn=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"createLeafletElement",value:function(e){return new on(e)}}]),t}(ba.a),ln=Object(W.d)(sn);B.a.Hash.parseHash=function(e){0===e.indexOf("#")&&(e=e.substr(1));var t=e.split("/");if(t.length>=3&&t.length<=4){var a=parseInt(t[0],10),n=parseFloat(t[1]),r=parseFloat(t[2]),i=4===t.length?parseInt(t[3],10):0;return!(isNaN(a)||isNaN(n)||isNaN(r))&&{center:new B.a.LatLng(n,r),zoom:a,level:isNaN(i)?0:i}}return!1},B.a.Hash.prototype.parseHash=B.a.Hash.parseHash,B.a.Hash.formatHash=function(e){var t=e.getCenter(),a=e.getZoom(),n=Math.max(0,Math.ceil(Math.log(a)/Math.LN2));return"#"+[a,t.lat.toFixed(n),t.lng.toFixed(n),this._level||"0"].join("/")},B.a.Hash.prototype.formatHash=B.a.Hash.formatHash,B.a.Hash.prototype.setLevel=function(e){if(this._level!==e){this._level=e;var t=this.formatHash(this.map);window.location.replace(t),this.lastHash=t}},B.a.Hash.prototype.update=function(){var e=window.location.hash;if(e!==this.lastHash){var t=this.parseHash(e);t?(this.movingMap=!0,this.map.setView(t.center,t.zoom),this.movingMap=!1,ee.a.publish("body.level.set",{level:t.level})):this.onMapMove(this.map)}};var un=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(g.a)(this,Object(y.a)(t).call(this))).state={loading:!1,dataready:!1},e.mapStyler=new en,e.loadedArea=null,e}return Object(v.a)(t,e),Object(r.a)(t,[{key:"invalidateSize",value:function(){this.elem&&this.elem.leafletElement&&this.elem.leafletElement.invalidateSize()}},{key:"cleanUp",value:function(){this.loadedArea=null,this.setState({loading:!1,dataready:!1})}},{key:"getCenter",value:function(){return this.elem&&this.elem.leafletElement?this.elem.leafletElement.getCenter():null}},{key:"getBounds",value:function(){return this.elem&&this.elem.leafletElement?this.elem.leafletElement.getBounds():null}},{key:"isLoading",value:function(){return this.state.loading}},{key:"_loadData",value:function(){var e=Object(h.a)(d.a.mark(function e(t){var a,n=this;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.props.datalocked||window.CONFIG.always_authenticated&&!window.editor_user)){e.next=4;break}return e.abrupt("return",new Promise(function(e){setTimeout(function(){return e(n._loadData(t))},100)}));case 4:if(!this.props.draw&&this.getBounds()&&this.elem.leafletElement.getZoom()>=window.CONFIG.data_min_zoom&&(a=t||this.getBounds())&&a.getSouth()!==a.getNorth()&&a.getWest()!==a.getEast()&&(!this.loadedArea||!this.loadedArea.contains(a))){for(;a.getSouthWest().distanceTo(a.getNorthEast())<400;)a=a.pad(.1);this.loadedArea=a,this.setState({loading:!0},Object(h.a)(d.a.mark(function e(){var t;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,window.vectorDataManager.loadOSMData(a);case 3:t=e.sent,n.setState({loading:!1,dataready:t}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),alert(S.t("Can't download data from OSM server. Please retry later.")),n.setState({loading:!1,dataready:!1});case 11:case"end":return e.stop()}},e,null,[[0,7]])})))}case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_getLayer",value:function(e,t){if(!e||!e.properties||!e.properties.url)return null;if("tms"===e.properties.type){var a=e.properties.url.replace(/\{zoom\}/g,"{z}").replace(/\{switch:.+?\}/g,"{s}").replace(/\{-y\}/g,"{y}");return o.a.createElement(ta.a,{attribution:e.properties.attribution?'<a href="'+e.properties.attribution.url+'" target="_blank">'+e.properties.attribution.text+"</a>":"",url:a,key:a,minZoom:e.properties.min_zoom,maxNativeZoom:e.properties.max_zoom,maxZoom:26,opacity:t,tms:e.properties.url.indexOf("{-y}")>0})}if("wms"===e.properties.type){var n=e.properties.url,r={},i=e.properties.url.split("?");if(i.length>1){n=i[0];var s=["srs","width","height","format","service","request","bbox","key","crs"];i[1].split("&").forEach(function(e){var t=e.split("="),a=Object(f.a)(t,2),n=a[0],i=a[1];s.includes(n.toLowerCase())?["key"].includes(n.toLowerCase())&&(r[n.toUpperCase()]=i):r[n.toLowerCase()]=i})}return o.a.createElement(aa.a,Object.assign({attribution:e.properties.attribution?'<a href="'+e.properties.attribution.url+'" target="_blank">'+e.properties.attribution.text+"</a>":"",url:n,key:e.properties.url,opacity:t},r))}return"bing"===e.properties.type&&window.CONFIG.providers&&window.CONFIG.providers.bing?o.a.createElement(oa.BingLayer,{bingkey:window.CONFIG.providers.bing,type:"Aerial",maxNativeZoom:20,maxZoom:26}):null}},{key:"_getFloorMapLayer",value:function(e){return e&&e.topleft?o.a.createElement(ya,{data:e,key:e.id,opacity:void 0===e.opacity||isNaN(parseFloat(e.opacity))?1:e.opacity,ref:"floormap_"+e.id,level:this.props.level,mode:this.props.mode,tool:this.props.floorImageryMode}):null}},{key:"render",value:function(){var e=this,t=window.imageryManager.getFloorImages(),a=null;return this.props.mode===Jn.MODE_EXPLORE?a=window.vectorDataManager.getAllLevels(!0):this.props.mode===Jn.MODE_BUILDING?this.props.building?(a=this.props.building.properties.own.levels.slice(0)).sort():a=window.vectorDataManager.getAllLevels(!1):[Jn.MODE_LEVELS,Jn.MODE_FEATURES].includes(this.props.mode)&&this.props.building&&(a=this.props.building.properties.own.levels.slice(0)).sort(),o.a.createElement("div",{className:"app-map-container"},(this.props.mode===Jn.MODE_CHANGESET||this.state.loading)&&o.a.createElement("div",{style:{zIndex:2e4,background:"rgba(0,0,0,0.5)",position:"absolute",top:0,right:0,left:0,bottom:0,textAlign:"center",display:"flex",alignItems:"center"}},this.state.loading&&o.a.createElement(Ce.a,{animation:"grow",variant:"light",size:"lg",style:{margin:"auto",width:"5rem",height:"5rem"}})),o.a.createElement(na.a,{maxZoom:26,className:"app-map"+(this.props.draw?" leaflet-clickable":""),ref:function(t){return e.elem=t},preferCanvas:!1,editable:!0,scrollWheelZoom:!0,doubleClickZoom:this.props.mode===Jn.MODE_EXPLORE,attributionControl:!1,boxSelector:!1,boxZoom:!1},o.a.createElement(ra.a,{prefix:"<a href='https://framagit.org/PanierAvide/osminedit' target='_blank'>"+window.EDITOR_NAME+"</a> v"+rn.version+" "+("GIT_HASH"===window.CONFIG.hash?"dev":window.CONFIG.hash)}),o.a.createElement(ia.a,{position:"bottomleft",imperial:!1}),o.a.createElement(nn,{position:"bottomright"}),o.a.createElement(ln,{position:"topright"}),[Jn.MODE_EXPLORE,Jn.MODE_BUILDING,Jn.MODE_LEVELS,Jn.MODE_FEATURES].includes(this.props.mode)&&!this.state.loading&&this.state.dataready&&a&&o.a.createElement(ka,{position:"topright",levels:a,level:this.props.level}),this.props.selectedBaseImagery&&this._getLayer(this.props.selectedBaseImagery,this.props.baseImageryOpacity),this.props.selectedOverlaysImagery&&this.props.selectedOverlaysImagery.map(function(t){return e._getLayer(t,e.props.overlaysImageryOpacity)}),this.props.mode!==Jn.MODE_EXPLORE&&t&&t.map(function(t){return e._getFloorMapLayer(t)}),!this.state.loading&&this.state.dataready&&[Jn.MODE_BUILDING,Jn.MODE_FLOOR_IMAGERY].includes(this.props.mode)&&o.a.createElement(la,{styler:this.mapStyler,building:this.props.building,draw:this.props.draw,level:this.props.level,locked:this.props.mode===Jn.MODE_FLOOR_IMAGERY}),!this.state.loading&&this.state.dataready&&this.props.mode===Jn.MODE_LEVELS&&this.props.building&&o.a.createElement(va,{styler:this.mapStyler,level:this.props.level,building:this.props.building,floor:this.props.floor,draw:this.props.draw}),!this.state.loading&&this.state.dataready&&(this.props.mode===Jn.MODE_EXPLORE||this.props.mode===Jn.MODE_FEATURES&&this.props.building)&&o.a.createElement(ha,{styler:this.mapStyler,level:this.props.level,building:this.props.building,feature:this.props.feature,draw:this.props.draw,locked:this.props.mode===Jn.MODE_EXPLORE})))}},{key:"_followMouse",value:function(e){this._mouseCoords=e.latlng}},{key:"componentDidMount",value:function(){var e=this;if(setTimeout(function(){e.invalidateSize(),e._loadData()},500),this._mapHash=new B.a.Hash(this.elem.leafletElement),!window.location.hash||!window.location.hash.match(/^#\d+\/-?\d+(.\d+)?\/-?\d+(.\d+)?(\/(-?\d+(.\d+)?)?)?$/)){var t,a=document.cookie.replace(/(?:(?:^|.*;\s*)lasthash\s*=\s*([^;]*).*$)|^.*$/,"$1");t=a&&B.a.Hash.parseHash(a)?a:"#"+window.CONFIG.map_initial_zoom+"/"+window.CONFIG.map_initial_latlng.join("/"),window.history.pushState({},"",window.location.href.split("#")[0]+t)}B.a.DomEvent.addListener(window,"hashchange",function(){document.cookie="lasthash="+window.location.hash}),this.elem.leafletElement.on("dblclick",function(t){e.props.draw||e.props.mode===Jn.MODE_EXPLORE||ee.a.publish("body.unselect.feature")}),this.elem.leafletElement.on("zoomend moveend",function(){if(e.elem&&e.elem.leafletElement){e._loadData();var t=e.elem.leafletElement.getZoom();t<window.CONFIG.data_min_zoom&&(!e._lastZoom||e._lastZoom>=window.CONFIG.data_min_zoom)?(e.elem.container.classList.add("app-map-novector"),ee.a.publishSync("body.unselect.feature")):t>=window.CONFIG.data_min_zoom&&(!e._lastZoom||e._lastZoom<window.CONFIG.data_min_zoom)&&e.elem.container.classList.remove("app-map-novector"),e._lastZoom=t}}),this.elem.leafletElement.on("mousemove",this._followMouse,this);var n=function(){e.elem&&e.elem.leafletElement&&ee.a.publish("map.zoom.changed",{zoom:e.elem.leafletElement.getZoom()})};this.elem.leafletElement.on("zoomend",n),n(),ee.a.subscribe("map.position.set",function(t,a){if(a.bbox){var n=Object(f.a)(a.bbox,4),r=n[0],i=n[1],o=n[2],s=n[3];e.elem.leafletElement.fitBounds([[r,o],[i,s]])}else a.zoom?e.elem.leafletElement.setView(a.coordinates,a.zoom):e.elem.leafletElement.panTo(a.coordinates)})}},{key:"componentDidUpdate",value:function(e){var t=this;this.props.level!==e.level&&this._mapHash.setLevel(this.props.level);var a=window.imageryManager.getFloorImages();e.mode!==this.props.mode&&(this.invalidateSize(),a.forEach(function(e){t.refs["floormap_"+e.id]&&t.refs["floormap_"+e.id].forceUpdate()})),this.elem.leafletElement.off("mousemove",this._followMouse,this),this.elem.leafletElement.on("mousemove",this._followMouse,this),!this.props.draw&&!this.state.loading&&this.elem.leafletElement.getZoom()>19&&this._loadData(this.getBounds().pad(.5*(this.elem.leafletElement.getZoom()-19)))}},{key:"componentWillUnmount",value:function(){ee.a.unsubscribe("map"),this.elem.leafletElement.off("mousemove",this._followMouse,this),this.elem.leafletElement.off("load"),this.elem.leafletElement.off("zoomend"),this.elem.leafletElement.off("moveend"),this.elem.leafletElement.off("dblclick")}}]),t}(i.Component),cn=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){return o.a.createElement(I.a,{show:this.props.show,onHide:this.props.onClose,size:"lg"},o.a.createElement(I.a.Header,{closeButton:!0},o.a.createElement(I.a.Title,null,S.t("Geometry outside of the bounds"))),o.a.createElement(I.a.Body,null,this.props.mode===Jn.MODE_LEVELS&&S.t("The level contour you just edited is partially or completely outside of the building contour. Please make sure that the level contour is mostly contained in the building."),this.props.mode===Jn.MODE_FEATURES&&S.t("The feature contour you just edited is partially or completely outside of the level contour. Please make sure that the feature contour is mostly contained in the floor.")),o.a.createElement(I.a.Footer,null,o.a.createElement(O.a,{variant:"secondary",onClick:this.props.onClose},S.t("OK"))))}}]),t}(i.Component),dn=a(255),pn=a.n(dn),hn=a(157),fn=a.n(hn),mn=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){return o.a.createElement(I.a,{show:null!==this.props.missingOutlines&&void 0!==this.props.missingOutlines&&Object.keys(this.props.missingOutlines).length>0,size:"lg",style:{zIndex:20050},onHide:this.props.onIgnore},o.a.createElement(I.a.Header,{closeButton:!0},o.a.createElement(I.a.Title,null,S.t("Floor outlines are missing"))),o.a.createElement(I.a.Body,null,o.a.createElement("p",null,S.t("These buildings lack some floor outlines :")),o.a.createElement("ul",null,this.props.missingOutlines&&Object.values(this.props.missingOutlines).map(function(e,t){return o.a.createElement("li",{key:t},S.t("Building %{b} (levels : %{lvl})",{b:e.name,lvl:e.levels.join(", ")}))})),o.a.createElement("p",null,S.t("These floor outlines are optional in OSM, but are useful for various tools people use."),o.a.createElement("br",null),S.t("You have the choice between following options :")),o.a.createElement("ul",{className:"pl-3 pb-0 mb-0",style:{listStyle:"none"}},o.a.createElement("li",null,o.a.createElement(ye.a,null)," ",S.t("Go back to editing and create levels outline by yourself (recommended for complex buildings)")),o.a.createElement("li",null,o.a.createElement(fn.a,null)," ",S.t("Use building outline as default level outline (recommended for simple buildings)")),o.a.createElement("li",null,o.a.createElement(pn.a,null)," ",S.t("Ignore this warning and do not create missing level outlines (not recommended)")))),o.a.createElement(I.a.Footer,null,o.a.createElement(O.a,{variant:"primary",onClick:this.props.onEdit},o.a.createElement(ye.a,null)," ",S.t("Edit outlines")),o.a.createElement(O.a,{variant:"secondary",onClick:this.props.onUseDefault},o.a.createElement(fn.a,null)," ",S.t("Use building ones")),o.a.createElement(O.a,{variant:"danger",onClick:this.props.onIgnore},o.a.createElement(pn.a,null)," ",S.t("Ignore this"))))}}]),t}(i.Component),gn=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(g.a)(this,Object(y.a)(t).call(this))).state={backgrounds:[],overlays:[],customUrl:""},e}return Object(v.a)(t,e),Object(r.a)(t,[{key:"_updateImagery",value:function(e){var t=this;if(this.props.imagery){var a={backgrounds:[],overlays:[]};this.props.imagery.forEach(function(e){e.properties.overlay?a.overlays.push(Object.assign({},e,{label:e.properties.name||e.properties.id,selected:t.props.selectedOverlaysImagery&&t.props.selectedOverlaysImagery.filter(function(t){return t.properties.id===e.properties.id}).length>0})):a.backgrounds.push(Object.assign({},e,{label:e.properties.name||e.properties.id||t._customImagery.label,selected:t.props.selectedBaseImagery&&t.props.selectedBaseImagery.properties.id===e.properties.id}))}),P()(a.backgrounds,this.state.backgrounds)&&P()(a.overlays,this.state.overlays)||this.setState(a)}}},{key:"_onSelect",value:function(e,t){ee.a.publish("body.imagery.set",{imagery:e,type:t})}},{key:"_onOpacityChanged",value:function(e,t){ee.a.publish("body.imagery.opacity",{opacity:parseInt(e)/100,type:t})}},{key:"_onCustomChanged",value:function(e){this.setState({customUrl:e}),e=e.trim();var t=Object.assign({},this.props.selectedBaseImagery);t.properties.url=0===e.length?null:e,this._onSelect([t],"background")}},{key:"render",value:function(){var e=this;return o.a.createElement("div",{className:"m-2"},o.a.createElement("h4",null,S.t("Imagery")),o.a.createElement(jt.a,{defaultActiveKey:"background",className:"dense-tabs",id:"imagery-tab"},o.a.createElement(Ct.a,{eventKey:"background",title:S.t("Background")},o.a.createElement(F.a,{className:"mt-3 mb-3 p-0 d-flex overflow-hidden"},o.a.createElement(Ze.a,{className:"flex-nowrap"},o.a.createElement(w.a,{className:"m-0"},S.t("Opacity")," ",o.a.createElement("span",{className:"font-weight-light"},(100*this.props.baseImageryOpacity).toFixed(0)+"%")),o.a.createElement(w.a,{className:"m-0"},o.a.createElement("input",{type:"range",min:"0",max:"100",onChange:function(t){return e._onOpacityChanged(t.target.value,"background")},value:100*this.props.baseImageryOpacity,className:"p-0 m-0 w-100"})))),this.state.backgrounds?o.a.createElement(Me,{data:this.state.backgrounds,type:"single",onChange:function(t){return e._onSelect(t,"background")}}):o.a.createElement("p",null,S.t("Loading...")),this.props.selectedBaseImagery&&"custom"===this.props.selectedBaseImagery.properties.id&&o.a.createElement(Se.a.Group,{controlId:"imagery-custom",className:"mt-2"},o.a.createElement(Se.a.Label,null,S.t("Custom imagery URL")),o.a.createElement(Se.a.Control,{type:"text",placeholder:"https://mytil.es/{z}/{x}/{y}.jpg",value:this.state.customUrl,onChange:function(t){return e._onCustomChanged(t.target.value)}}),o.a.createElement(Se.a.Text,{className:"text-muted"},S.t("You can use any TMS-like URL")))),o.a.createElement(Ct.a,{eventKey:"overlay",title:S.t("Overlay")},o.a.createElement(F.a,{className:"mt-3 mb-3 p-0 d-flex overflow-hidden"},o.a.createElement(Ze.a,{className:"flex-nowrap"},o.a.createElement(w.a,{className:"m-0"},S.t("Opacity")," ",o.a.createElement("span",{className:"font-weight-light"},(100*this.props.overlaysImageryOpacity).toFixed(0)+"%")),o.a.createElement(w.a,{className:"m-0"},o.a.createElement("input",{type:"range",min:"0",max:"100",onChange:function(t){return e._onOpacityChanged(t.target.value,"overlay")},value:100*this.props.overlaysImageryOpacity,style:{width:"100%"},className:"p-0 m-0 w-100"})))),this.state.overlays?o.a.createElement(Me,{data:this.state.overlays,type:"multi",onChange:function(t){return e._onSelect(t,"overlay")}}):o.a.createElement("p",null,S.t("Loading...")))))}},{key:"componentDidMount",value:function(){this._updateImagery()}},{key:"componentDidUpdate",value:function(e){this._updateImagery(e)}}]),t}(i.Component),yn=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){return o.a.createElement("div",null,o.a.createElement(gn,this.props))}}]),t}(i.Component),vn=a(92),bn=a(379),_n=a.n(bn),En=a(380),wn=a.n(En),On=a(381),kn=a.n(On),Ln=a(382),Sn=a.n(Ln),In=a(383),Nn=a.n(In),Dn=a(384),Mn=a.n(Dn),Cn=a(385),jn=a.n(Cn),An=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=this,t=window.imageryManager.getFloorImages().find(function(e){return e.selected});return t?o.a.createElement("div",null,o.a.createElement(vn.a,null,o.a.createElement(O.a,{size:"sm",variant:"distort"===this.props.floorImageryMode?"primary":"outline-secondary",onClick:function(){return ee.a.publish("body.floorimagery.mode",{mode:"distort"===e.props.floorImageryMode?null:"distort"})},disabled:!t.visible,title:S.t("Distort this plan")},o.a.createElement(Sn.a,null)),o.a.createElement(O.a,{size:"sm",variant:"scale"===this.props.floorImageryMode?"primary":"outline-secondary",onClick:function(){return ee.a.publish("body.floorimagery.mode",{mode:"scale"===e.props.floorImageryMode?null:"scale"})},disabled:!t.visible,title:S.t("Scale this plan")},o.a.createElement(kn.a,null)),o.a.createElement(O.a,{size:"sm",variant:"rotate"===this.props.floorImageryMode?"primary":"outline-secondary",onClick:function(){return ee.a.publish("body.floorimagery.mode",{mode:"rotate"===e.props.floorImageryMode?null:"rotate"})},disabled:!t.visible,title:S.t("Rotate this plan")},o.a.createElement(jn.a,null))),o.a.createElement(vn.a,null,o.a.createElement(O.a,{size:"sm",variant:"outline-secondary",className:"ml-1",onClick:function(){return ee.a.publish("body.floorimagery.copyposition")},disabled:!t.visible,title:S.t("Copy position of this plan")},o.a.createElement(Nn.a,null)),o.a.createElement(O.a,{size:"sm",variant:"outline-secondary",onClick:function(){return ee.a.publish("body.floorimagery.pasteposition")},disabled:!t.visible||!this.props.floorImageryCopyPaste,title:S.t("Move this plan to copied position")},o.a.createElement(Mn.a,null))),o.a.createElement(O.a,{variant:"outline-danger",onClick:function(){return ee.a.publish("body.floorimagery.remove",{id:t.id})},className:"ml-1",size:"sm",title:S.t("Delete this plan")},o.a.createElement(M.a,null)," ",o.a.createElement("span",{className:"hide-mdDown"},S.t("Delete this plan")))):o.a.createElement("div",null)}}]),t}(i.Component),xn=a(386),Tn=a.n(xn),Fn=a(387),Gn=a.n(Fn),Pn=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){return o.a.createElement("div",null,S.t("Click on the map to start drawing the feature"),o.a.createElement(vn.a,{style:{marginLeft:10}},o.a.createElement(O.a,{variant:"success",size:"sm",onClick:function(){return ee.a.publish("body.draw.stop")}},o.a.createElement(Te.a,{size:24})," ",S.t("Done")),o.a.createElement(O.a,{variant:"outline-danger",size:"sm",onClick:function(){return ee.a.publish("body.draw.cancel")}},o.a.createElement(M.a,{size:24})," ",S.t("Cancel"))))}}]),t}(i.Component),Un=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){if(this.props.draw)return o.a.createElement(Pn,null);if(this.props.zoom&&this.props.zoom<window.CONFIG.data_min_zoom)return o.a.createElement("p",null,S.t("Please zoom-in to edit data"));if(this.props.mode===Jn.MODE_BUILDING)return o.a.createElement("div",null,this.props.building&&[o.a.createElement(O.a,{variant:"primary",title:S.t("Edit objects contained in this floor"),onClick:function(){return ee.a.publish("body.mode.set",{mode:Jn.MODE_FEATURES})},size:"sm",className:"mr-1",key:0},o.a.createElement(pe.a,null)," ",S.t("Edit features")),o.a.createElement(O.a,{variant:"outline-danger",onClick:function(){return ee.a.publish("body.delete.feature")},size:"sm",className:"mr-1",key:1,title:S.t("Delete this building")},o.a.createElement(j.a,null))],this.props.building&&o.a.createElement(O.a,{variant:"outline-secondary",onClick:function(){return ee.a.publish("body.square.feature")},size:"sm",className:"mr-1",title:S.t("Square this building")},o.a.createElement(ct.a,null)),o.a.createElement(O.a,{variant:this.props.building?"outline-secondary":"primary",size:"sm",title:S.t("Click to start creating a new building from scratch"),onClick:function(){return ee.a.publish("body.draw.building")}},o.a.createElement(fn.a,null)," ",o.a.createElement("span",{className:this.props.building?"hide-mdDown":""},S.t("New building"))));if(this.props.mode===Jn.MODE_LEVELS){var e=window.vectorDataManager.getLevelFootprint(this.props.building,this.props.level||0);return o.a.createElement("div",null,this.props.floor&&[o.a.createElement(O.a,{variant:"outline-secondary",onClick:function(){return ee.a.publish("body.square.feature")},size:"sm",className:"mr-1",key:0,title:S.t("Square this floor part")},o.a.createElement(ct.a,null)),o.a.createElement(O.a,{variant:"outline-danger",onClick:function(){return ee.a.publish("body.delete.feature")},size:"sm",className:"mr-1",key:1,title:S.t("Delete this floor part")},o.a.createElement(j.a,null))],e.length>0&&o.a.createElement(O.a,{variant:"outline-secondary",onClick:function(){return ee.a.publish("body.draw.floor")},size:"sm",className:"mr-1",title:S.t("Create a new floor part in this level. Useful for giving different names to parts of a single level.")},o.a.createElement(qt.a,null)," ",o.a.createElement("span",{className:"hide-mdDown"},S.t("Add another floor part"))),o.a.createElement(vn.a,null,o.a.createElement(O.a,{variant:"outline-primary",title:S.t("Create a new level on top of existing ones"),onClick:function(){return ee.a.publish("body.level.add",{where:"upper"})},size:"sm"},o.a.createElement(Gn.a,null)," ",o.a.createElement("span",{className:"hide-mdDown"},S.t("New upper level"))),o.a.createElement(O.a,{variant:"outline-primary",title:S.t("Create a new level under existing ones"),onClick:function(){return ee.a.publish("body.level.add",{where:"below"})},size:"sm"},o.a.createElement(Tn.a,null)," ",o.a.createElement("span",{className:"hide-mdDown"},S.t("New below level")))))}return this.props.mode===Jn.MODE_FEATURES?o.a.createElement("div",null,this.props.feature&&this.props.feature.id.startsWith("way/")&&o.a.createElement(O.a,{variant:"outline-secondary",onClick:function(){return ee.a.publish("body.square.feature")},size:"sm",className:"mr-1",title:S.t("Square this feature")},o.a.createElement(ct.a,null)),this.props.feature&&o.a.createElement(O.a,{variant:"outline-danger",onClick:function(){return ee.a.publish("body.delete.feature")},size:"sm",title:S.t("Delete this feature")},o.a.createElement(j.a,null))):o.a.createElement("span",null)}}]),t}(i.Component),Rn=a(388),Bn=a.n(Rn),zn=a(389),Wn=a.n(zn),Hn=function(e){function t(){return Object(n.a)(this,t),Object(g.a)(this,Object(y.a)(t).apply(this,arguments))}return Object(v.a)(t,e),Object(r.a)(t,[{key:"_onSave",value:function(){this.props.mode===Jn.MODE_FLOOR_IMAGERY?ee.a.publish("body.floorimagery.save"):ee.a.publish("body.mode.set",{mode:Jn.MODE_CHANGESET})}},{key:"render",value:function(){var e,t,a,n,r=this;return this.props.mode===Jn.MODE_FLOOR_IMAGERY?(e=window.imageryManager.canUndo(),t=window.imageryManager.canRedo(),a=window.imageryManager.getFloorImages().length>0,n=window.imageryManager.getAmountEdits()):(e=window.vectorDataManager.canUndo(),t=window.vectorDataManager.canRedo(),a=e,n=window.vectorDataManager.getAmountEdits()),o.a.createElement("div",{className:"app-toolbar p-2"},o.a.createElement("div",{className:"d-flex justify-content-between"},o.a.createElement("div",null,this.props.mode===Jn.MODE_FLOOR_IMAGERY?o.a.createElement(An,this.props):o.a.createElement(Un,this.props)),o.a.createElement("div",null,o.a.createElement(vn.a,{className:"mr-2","aria-label":"Undo and redo"},o.a.createElement(O.a,{variant:"outline-secondary",size:"sm",disabled:!e,title:S.t("Cancel last operation"),onClick:function(){return ee.a.publish("body.action.undo")}},o.a.createElement(Bn.a,null)),o.a.createElement(O.a,{variant:"outline-secondary",size:"sm",disabled:!t,title:S.t("Apply again last cancelled operation"),onClick:function(){return ee.a.publish("body.action.redo")}},o.a.createElement(Wn.a,null))),o.a.createElement(O.a,{variant:"primary",size:"sm",className:"mr-2",active:this.props.mode===Jn.MODE_PREVIEW,disabled:this.props.mode===Jn.MODE_PREVIEW,onClick:function(){return ee.a.publish("body.preview.open")},title:S.t("Preview your changes on indoor=")},o.a.createElement(wn.a,null),o.a.createElement("span",{className:"hide-mdDown"},S.t("Preview"))),o.a.createElement(O.a,{variant:n<30?"success":n<100?"warning":"danger",size:"sm",disabled:!a,title:this.props.mode===Jn.MODE_FLOOR_IMAGERY?S.t("Save positionning of floor plans"):S.t("Send your changes to OpenStreetMap"),onClick:function(){return r._onSave()}},o.a.createElement(_n.a,null),o.a.createElement("span",{className:"hide-mdDown"},S.t("Save")),n>0&&" ("+n+")"))))}}]),t}(i.Component),Vn=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(g.a)(this,Object(y.a)(t).call(this))).state={leftPanelOpen:!1,rightPanelOpen:!1,mode:t.MODE_EXPLORE,level:0,building:null,floor:null,feature:null,copyingFeature:null,preset:null,draw:null,pane:null,imagery:null,selectedOverlaysImagery:null,selectedBaseImagery:null,overlaysImageryOpacity:1,baseImageryOpacity:1,floorImageryMode:null,floorImageryCopyPaste:null,changeset:{tags:{}},datalocked:!1,lastUsedPresets:[],zoom:window.CONFIG.map_initial_zoom},e._usedImageryNames=new Set,e}return Object(v.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e,a=this,n=(e={},Object(m.a)(e,t.MODE_EXPLORE,"mode-explore"),Object(m.a)(e,t.MODE_FLOOR_IMAGERY,"mode-floorplan"),e),r=n[this.state.mode]?n[this.state.mode]:"mode-editindoor";return o.a.createElement(F.a,{fluid:!0,className:"h-100 m-0 p-0 "+r},o.a.createElement(Ae,Object.assign({className:"app-header"},this.state)),o.a.createElement(Ze.a,{className:"m-0 p-0 app-body"},this.state.leftPanelOpen&&o.a.createElement(w.a,{className:"m-0 p-0 h-100",style:{overflowX:"hidden",overflowY:"auto",borderRight:"3px solid #d0d0d0"},xs:"6",sm:"5",md:"4",lg:"4",xl:"3"},o.a.createElement(Qt,this.state)),o.a.createElement(w.a,{className:"m-0 p-0"},this.state.mode!==t.MODE_EXPLORE&&o.a.createElement(Hn,this.state),o.a.createElement(un,Object.assign({ref:function(e){return a.map=e}},this.state))),this.state.rightPanelOpen&&o.a.createElement(w.a,{className:"m-0 p-0 h-100 overflow-auto",style:{borderLeft:"3px solid #d0d0d0"},xs:"6",sm:"5",md:"4",lg:"4",xl:"3"},o.a.createElement(yn,this.state))),o.a.createElement(T,{show:this.state.showDialogConfirmDeletion,name:this.state.mode===t.MODE_BUILDING&&this.state.building?t.GetFeatureName(this.state.building,S.t("Selected building")):this.state.mode===t.MODE_LEVELS&&this.state.floor?t.GetFeatureName(this.state.floor,S.t("Selected floor")):"",onCancel:function(){return a.setState({showDialogConfirmDeletion:!1})},onConfirm:function(e){a.setState({showDialogConfirmDeletion:!1}),ee.a.publish("body.delete.feature",{confirmed:!0,deleteAll:e})}}),o.a.createElement(N,{show:this.state.showDialogCompleteFloorImagery,onClose:function(){return a.setState({showDialogCompleteFloorImagery:!1})}}),o.a.createElement(cn,{show:this.state.showDialogOutOfBoundsGeometry,onClose:function(){return a.setState({showDialogOutOfBoundsGeometry:!1})},mode:this.state.mode}),o.a.createElement(mn,{missingOutlines:this.state.showDialogMissingLevelOutlines,onIgnore:function(){return a.setState({showDialogMissingLevelOutlines:null})},onUseDefault:function(){return a._onMissingOutlineUseDefault()},onEdit:function(){return a._onMissingOutlineGoEdit()}}),o.a.createElement(ea,{show:this.state.showDialogLogin,onLogin:function(){return ee.a.publish("app.user.login")},onClose:function(){window.CONFIG.always_authenticated||(ee.a.publishSync("body.mode.set",{mode:t.MODE_EXPLORE}),a.setState({showDialogLogin:!1}))}}))}},{key:"_onMissingOutlineUseDefault",value:function(){Object.keys(this.state.showDialogMissingLevelOutlines).length>0&&Object.entries(this.state.showDialogMissingLevelOutlines).forEach(function(e){var t=Object(f.a)(e,2),a=t[0],n=t[1],r=window.vectorDataManager.findFeature(a);r&&n.levels.length>0&&n.levels.forEach(function(e){ee.a.publish("body.create.floor",{feature:r,level:e})})}),this.setState({showDialogMissingLevelOutlines:null}),ee.a.publish("body.mode.set",{mode:t.MODE_CHANGESET})}},{key:"_onMissingOutlineGoEdit",value:function(){try{if(0===Object.keys(this.state.showDialogMissingLevelOutlines).length)throw new Error;var e=Object(f.a)(Object.entries(this.state.showDialogMissingLevelOutlines)[0],2),a=e[0],n=e[1],r=window.vectorDataManager.findFeature(a);if(!r||0===n.levels.length)throw new Error;this.setState({building:r,level:n.levels[0],showDialogMissingLevelOutlines:null},function(){ee.a.publish("body.mode.set",{mode:t.MODE_LEVELS});var e=E()(r),a=Object(f.a)(e,4),n=a[0],i=a[1],o=a[2],s=a[3];ee.a.publish("map.position.set",{bbox:[i,s,n,o]})})}catch(i){this.setState({showDialogMissingLevelOutlines:null}),ee.a.publish("body.mode.set",{mode:t.MODE_BUILDING})}}},{key:"_updateImagery",value:function(){var e=this;window.imageryManager.getAvailableImagery(this.map.getCenter()).then(function(t){t.push({properties:{id:"custom",type:"tms",url:null,name:S.t("Custom imagery")},geometry:null});var a={};P()(t,e.state.imagery)||(a.imagery=t);var n=t.filter(function(e){return!e.properties.overlay});(!e.state.selectedBaseImagery&&n.length>0||e.state.selectedBaseImagery&&!n.find(function(t){return e.state.selectedBaseImagery.properties.id===t.properties.id}))&&(a.selectedBaseImagery=n[0]);var r=t.find(function(e){return"mapbox_locator_overlay"===e.properties.id});e.state.selectedOverlaysImagery||!r||e.state.zoom&&r.properties.max_zoom&&!(e.state.zoom<=r.properties.max_zoom)||(a.selectedOverlaysImagery=[t.find(function(e){return"mapbox_locator_overlay"===e.properties.id})]),Object.keys(a).length>0&&e.setState(a)})}},{key:"_pushUsedPreset",value:function(e){if(null===e||void 0===e)return null;var t=this.state.lastUsedPresets.slice(0);if(0===t.length)t.push(e);else{var a=t.findIndex(function(t){return P()(t,e)});a<0?(3===t.length&&t.pop(),t.unshift(e)):(t.splice(a,1),t.unshift(e))}P()(t,this.state.lastUsedPresets)||this.setState({lastUsedPresets:t})}},{key:"_checkUserLoggedIn",value:function(){var e=this;return window.editor_user&&window.editor_user_auth&&window.editor_user_auth.authenticated()?(this.state.showDialogLogin&&this.setState({showDialogLogin:!1}),!0):(this.state.showDialogLogin||!window.CONFIG.always_authenticated&&![t.MODE_FLOOR_IMAGERY,t.MODE_BUILDING,t.MODE_FEATURES,t.MODE_LEVELS,t.MODE_CHANGESET].includes(this.state.mode)||(this._timerLogin&&(clearTimeout(this._timerLogin),this._timerLogin=null),this._timerLogin=setTimeout(function(){return e.setState({showDialogLogin:!0})},1e3)),!1)}},{key:"_addUsedImagery",value:function(){var e=this;this.state.selectedBaseImagery&&this.state.selectedBaseImagery.properties&&this._usedImageryNames.add(this.state.selectedBaseImagery.properties.name||this.state.selectedBaseImagery.properties.id),this.state.selectedOverlaysImagery&&this.state.selectedOverlaysImagery.length>0&&this.state.selectedOverlaysImagery.forEach(function(t){t.properties&&e._usedImageryNames.add(t.properties.name||t.properties.id)})}},{key:"componentDidMount",value:function(){var e,a=this;this._timerImagery=setInterval(function(){return a._updateImagery()},1e3),this._checkUserLoggedIn(),ee.a.subscribe("app.user.ready",function(e,t){a._checkUserLoggedIn()}),ee.a.subscribe("app.user.left",function(e,t){a._checkUserLoggedIn()}),ee.a.subscribe("body.mode.set",function(e,n){if(a.state.mode===t.MODE_FLOOR_IMAGERY&&n.mode!==t.MODE_FLOOR_IMAGERY&&(window.imageryManager.lockFloorImagery(),window.imageryManager.getFloorImages().filter(function(e){return void 0===e.level||null===e.level||isNaN(e.level)}).length>0))return void a.setState({showDialogCompleteFloorImagery:!0});if(n.mode===t.MODE_EXPLORE)a.setState({mode:n.mode,building:null,floor:null,feature:null,copyingFeature:null,draw:null,preset:null,leftPanelOpen:!1,pane:null});else if(n.mode===t.MODE_BUILDING)a.setState({mode:n.mode,floor:null,feature:null,copyingFeature:null,draw:null,preset:null,leftPanelOpen:null!==a.state.building,pane:null!==a.state.building?Qt.PANE_BUILDING_EDIT:null},function(){a.state.building&&ee.a.publish("body.select.building",{building:a.state.building})});else if(n.mode===t.MODE_LEVELS){var r=a.state.floor!==a.state.building?a.state.floor:null;if(!r){var i=window.vectorDataManager.getLevelFootprint(a.state.building,a.state.level);r=1===i.length?i[0]:null}a.setState({mode:n.mode,building:window.vectorDataManager.getBuildingLevels(a.state.building),floor:r,feature:null,copyingFeature:null,draw:null,preset:null,leftPanelOpen:!0,pane:r?Qt.PANE_LEVELS_EDIT:Qt.PANE_LEVELS_ADD})}else n.mode===t.MODE_FEATURES?a.setState({mode:n.mode,feature:null,copyingFeature:null,draw:null,preset:null,leftPanelOpen:!0,pane:Qt.PANE_FEATURE_ADD}):n.mode===t.MODE_CHANGESET?a.setState({mode:n.mode,building:null,floor:null,feature:null,copyingFeature:null,draw:null,preset:null,leftPanelOpen:!0,pane:Qt.PANE_CHANGESET,changeset:{status:"preparing"},rightPanelOpen:!1},Object(h.a)(d.a.mark(function e(){var t,n;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,window.vectorDataManager.computeDiff();case 2:t=e.sent,n=window.vectorDataManager.findMissingLevelOutlines(t),a.setState({showDialogMissingLevelOutlines:n,changeset:{tags:{comment:"",imagery_used:a._usedImageryNames&&a._usedImageryNames.size>0?Object(p.a)(a._usedImageryNames).join(";"):void 0},diff:t,status:"check"}});case 5:case"end":return e.stop()}},e)}))):n.mode===t.MODE_FLOOR_IMAGERY?a.setState({mode:n.mode,draw:null,leftPanelOpen:!0,pane:Qt.PANE_FLOOR_IMAGERY}):a.setState({mode:n.mode,pane:null,leftPanelOpen:!1})}),ee.a.subscribe("body.level.set",function(e,n){var r={level:n.level};if(a.state.mode===t.MODE_LEVELS){var i=window.vectorDataManager.getLevelFootprint(a.state.building,n.level);r.floor=1===i.length?i[0]:null,r.pane=1===i.length?Qt.PANE_LEVELS_EDIT:Qt.PANE_LEVELS_ADD,r.draw=null}else a.state.mode===t.MODE_FEATURES&&(a.state.feature&&a.state.feature.properties.own&&a.state.feature.properties.own.levels&&a.state.feature.properties.own.levels.includes(n.level)||(r.feature=null,r.pane=Qt.PANE_FEATURE_ADD),r.floor=null,r.draw=null,r.preset=null,a._pushUsedPreset(a.state.preset));a.setState(r)}),ee.a.subscribe("body.level.add",function(e,t){if(a.state.datalocked)return setTimeout(function(){return ee.a.publish("body.level.add",t)},100),null;var n=a.state.building.properties.own.levels;if("upper"===t.where){var r=Math.floor(n[n.length-1]),i=Object.assign({},a.state.building);i.properties.own.levels.push(r+1),a.setState({datalocked:!0},function(){return a.setState({datalocked:!1,building:window.vectorDataManager.editFeature(i,!0),level:r+1,floor:null,pane:Qt.PANE_LEVELS_ADD,leftPanelOpen:!0})})}else if("below"===t.where){var o=Math.ceil(n[0]),s=Object.assign({},a.state.building);s.properties.own.levels.unshift(o-1),a.setState({datalocked:!0},function(){return a.setState({datalocked:!1,building:window.vectorDataManager.editFeature(s,!0),level:o-1,floor:null,pane:Qt.PANE_LEVELS_ADD,leftPanelOpen:!0})})}}),ee.a.subscribe("body.level.copy",function(e,n){if(a.state.datalocked)return setTimeout(function(){return ee.a.publish("body.level.copy",n)},100),null;a.state.mode===t.MODE_LEVELS&&a.state.building&&a.state.level&&n.use&&a.setState({datalocked:!0},function(){window.vectorDataManager.copyLevel(a.state.building,n.use,a.state.level),a.setState({datalocked:!1})})}),ee.a.subscribe("body.panel.toggle",function(e,t){"right"===t.panel?a.setState({rightPanelOpen:!a.state.rightPanelOpen}):"left"===t.panel&&a.setState({leftPanelOpen:!a.state.leftPanelOpen})}),ee.a.subscribe("body.select.building",function(e,t){var n={building:t.building?window.vectorDataManager.getBuildingLevels(t.building):null,leftPanelOpen:null!==t.building,pane:t.building?Qt.PANE_BUILDING_EDIT:null};a.setState(n)}),ee.a.subscribe("body.select.floor",function(e,t){var n={floor:t.floor,pane:t.floor?Qt.PANE_LEVELS_EDIT:Qt.PANE_LEVELS_ADD};a.setState(n)}),ee.a.subscribe("body.select.feature",function(e,n){var r={feature:n.feature,leftPanelOpen:!!n.feature};a.state.mode===t.MODE_EXPLORE?(r.pane=n.feature?Qt.PANE_FEATURE_VIEW:null,r.building=n.feature?window.vectorDataManager.findAssociatedBuilding(n.feature):null):(r.pane=n.feature?Qt.PANE_FEATURE_EDIT:Qt.PANE_FEATURE_ADD,r.preset=n.feature?a.state.preset:null),a.setState(r)}),ee.a.subscribe("body.select.preset",function(e,n){if(a.state.mode===t.MODE_FEATURES&&(a.setState({preset:n.preset?Object.assign({type:[]},n.preset):null}),n.preset)){var r=n.preset.type?n.preset.type.map(function(e){return le.PRESET_TO_DRAW[e]}).filter(function(e){return void 0!==e}):[];(le.PRESET_TO_DRAW[n.type]||1===r.length)&&ee.a.publish("body.draw.feature",{type:le.PRESET_TO_DRAW[n.type]||r[0]})}}),ee.a.subscribe("body.unselect.feature",function(e,n){a.state.mode===t.MODE_BUILDING?ee.a.publish("body.select.building",{building:null}):a.state.mode===t.MODE_LEVELS?ee.a.publish("body.select.floor",{floor:null}):a.state.mode===t.MODE_FEATURES?ee.a.publish("body.select.feature",{feature:null}):a.state.mode===t.MODE_EXPLORE&&(ee.a.publish("body.select.feature",{feature:null}),ee.a.publish("body.select.floor",{floor:null}),ee.a.publish("body.select.building",{building:null}))}),ee.a.subscribe("body.draw.building",function(e,t){a.state.building&&ee.a.publishSync("body.unselect.feature"),a.setState({draw:le.DRAW_POLYGON})}),ee.a.subscribe("body.draw.floor",function(e,t){a.setState({floor:null,draw:le.DRAW_POLYGON,pane:null,leftPanelOpen:!1})}),ee.a.subscribe("body.draw.feature",function(e,t){a.setState({feature:null,draw:t.type,pane:null,leftPanelOpen:!1})}),ee.a.subscribe("body.draw.stop",function(e,t){a.state.draw&&a.map&&a.map.elem&&a.map.elem.leafletElement&&a.map.elem.leafletElement.editTools&&a.map.elem.leafletElement.editTools.stopDrawing()}),ee.a.subscribe("body.draw.done",function(e,n){!a.map||a.map.isLoading()||a.state.datalocked?setTimeout(function(){return ee.a.publish("body.draw.done",n)},100):a.setState({datalocked:!0},function(){a._addUsedImagery();var e={draw:null,datalocked:!1,leftPanelOpen:!0};a.state.mode===t.MODE_BUILDING?(e.building=window.vectorDataManager.createNewBuilding(n.feature),e.pane=Qt.PANE_BUILDING_EDIT):a.state.mode===t.MODE_LEVELS?window.vectorDataManager.isOverlappingEnough(a.state.building,n.feature)?(e.floor=window.vectorDataManager.createNewFloor(n.feature,a.state.level),e.pane=Qt.PANE_LEVELS_EDIT):(e.showDialogOutOfBoundsGeometry=!0,delete e.leftPanelOpen):a.state.mode===t.MODE_FEATURES&&a.state.preset&&(a.state.preset.tags&&!a.state.preset.tags.indoor||window.vectorDataManager.isOverlappingEnough(a.state.building,n.feature)?(e.feature=window.vectorDataManager.createNewFeature(n.feature,a.state.level,a.state.preset),e.pane=Qt.PANE_FEATURE_EDIT,a._pushUsedPreset(a.state.preset)):(e.showDialogOutOfBoundsGeometry=!0,e.feature=null,e.pane=Qt.PANE_FEATURE_ADD,e.preset=null,a._pushUsedPreset(a.state.preset),ee.a.publish("map.editablelayer.redraw"))),a.setState(e)})}),ee.a.subscribe("body.draw.cancel",function(e,n){var r={draw:null};a.state.mode===t.MODE_FEATURES?(r.preset=null,r.pane=Qt.PANE_FEATURE_ADD,r.leftPanelOpen=!0):a.state.mode===t.MODE_LEVELS&&(r.pane=Qt.PANE_LEVELS_ADD,r.leftPanelOpen=!0),a.setState(r)}),ee.a.subscribe("body.create.floor",function(e,n){if(a.state.datalocked)return setTimeout(function(){return ee.a.publish("body.create.floor",n)},100),null;var r={type:"Feature",geometry:Object.assign({},n.feature.geometry),properties:{}};a.state.mode===t.MODE_LEVELS?window.vectorDataManager.isOverlappingEnough(a.state.building,r)?a.setState({datalocked:!0},function(){a._addUsedImagery(),a.setState({datalocked:!1,floor:window.vectorDataManager.createNewFloor(r,a.state.level),pane:Qt.PANE_LEVELS_EDIT})}):a.setState({showDialogOutOfBoundsGeometry:!0}):a.state.mode!==t.MODE_CHANGESET||isNaN(n.level)||window.vectorDataManager.createNewFloor(r,n.level)}),ee.a.subscribe("body.edit.feature",function(e,n){if(a.state.datalocked)return setTimeout(function(){return ee.a.publish("body.edit.feature",n)},100),null;n.feature&&n.feature.id?!n.feature.id.startsWith("relation/")||window.vectorDataManager.isRelationEditingSupported(window.vectorDataManager.findFeature(n.feature.id),n.feature)?n.feature.properties.tags&&!n.feature.properties.tags.indoor||window.vectorDataManager.isOverlappingEnough(a.state.building,n.feature)?a.setState({datalocked:!0},Object(h.a)(d.a.mark(function e(){var r;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a._addUsedImagery(),e.next=3,window.vectorDataManager.editFeatureGeometry(n.feature.id,n.feature.geometry);case 3:r=e.sent,a.setState({datalocked:!1},function(){!r||void 0!==n.select&&!0!==n.select||(a.state.mode===t.MODE_BUILDING?ee.a.publish("body.select.building",{building:r}):a.state.mode===t.MODE_LEVELS?ee.a.publish("body.select.floor",{floor:r}):a.state.mode===t.MODE_FEATURES&&ee.a.publish("body.select.feature",{feature:r}))});case 5:case"end":return e.stop()}},e)}))):a.setState({showDialogOutOfBoundsGeometry:!0,floor:null,pane:Qt.PANE_LEVELS_ADD},function(){ee.a.publish("map.editablelayer.redraw")}):(alert(S.t("The editor doesn't support yet this kind of complex geometry editing.")),ee.a.publish("map.editablelayer.redraw")):console.log("Missing information for editing this feature",n.feature)}),ee.a.subscribe("body.delete.feature",function(e,n){if(a.state.datalocked)return setTimeout(function(){return ee.a.publish("body.delete.feature",n)},100),null;n=n||{},a.state.mode===t.MODE_FEATURES&&a.state.feature?a.setState({datalocked:!0},function(){a._addUsedImagery(),window.vectorDataManager.deleteFeature(a.state.feature),ee.a.publish("body.unselect.feature"),a.setState({datalocked:!1})}):n.confirmed?a.setState({datalocked:!0},function(){a._addUsedImagery(),a.state.mode===t.MODE_BUILDING&&a.state.building?(window.vectorDataManager.deleteFeature(a.state.building,n.deleteAll),ee.a.publish("body.unselect.feature")):a.state.mode===t.MODE_LEVELS&&a.state.floor&&(window.vectorDataManager.deleteFeature(a.state.floor,n.deleteAll),ee.a.publish("body.unselect.feature")),a.setState({datalocked:!1})}):(a.state.mode===t.MODE_BUILDING&&a.state.building||a.state.mode===t.MODE_LEVELS&&a.state.floor)&&a.setState({showDialogConfirmDeletion:!0})}),ee.a.subscribe("body.square.feature",function(e,n){if(a.state.datalocked)return setTimeout(function(){return ee.a.publish("body.square.feature",n)},100),null;a.setState({datalocked:!0},Object(h.a)(d.a.mark(function e(){var n;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=function(){var e=Object(h.a)(d.a.mark(function e(t){return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,window.vectorDataManager.makeFeatureSquare(t.id,a.map.elem.leafletElement);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),a.state.mode!==t.MODE_BUILDING||!a.state.building){e.next=10;break}return e.t0=ee.a,e.next=5,n(a.state.building);case 5:e.t1=e.sent,e.t2={building:e.t1},e.t0.publish.call(e.t0,"body.select.building",e.t2),e.next=26;break;case 10:if(a.state.mode!==t.MODE_LEVELS||!a.state.floor){e.next=19;break}return e.t3=ee.a,e.next=14,n(a.state.floor);case 14:e.t4=e.sent,e.t5={floor:e.t4},e.t3.publish.call(e.t3,"body.select.floor",e.t5),e.next=26;break;case 19:if(a.state.mode!==t.MODE_FEATURES||!a.state.feature){e.next=26;break}return e.t6=ee.a,e.next=23,n(a.state.feature);case 23:e.t7=e.sent,e.t8={feature:e.t7},e.t6.publish.call(e.t6,"body.select.feature",e.t8);case 26:a.setState({datalocked:!1});case 27:case"end":return e.stop()}},e)})))}),ee.a.subscribe("body.copy.feature",function(e,n){a.state.mode===t.MODE_FEATURES&&a.state.feature&&a.setState({copyingFeature:a.state.feature})}),ee.a.subscribe("body.paste.feature",function(e,n){if(a.state.datalocked)return setTimeout(function(){return ee.a.publish("body.paste.feature",n)},100),null;if(a.state.mode===t.MODE_FEATURES&&a.state.copyingFeature){var r=a.map&&a.map._mouseCoords;r&&a.setState({datalocked:!0},function(){a._addUsedImagery(),a.setState({feature:window.vectorDataManager.copyFeature(a.state.copyingFeature,a.state.level,r),leftPanelOpen:!0,pane:Qt.PANE_FEATURE_EDIT,datalocked:!1})})}}),ee.a.subscribe("body.paste.tags",function(e,n){if(a.state.datalocked)return setTimeout(function(){return ee.a.publish("body.paste.tags",n)},100),null;if(a.state.mode===t.MODE_FEATURES&&a.state.copyingFeature&&a.state.feature){var r=Object.assign({},a.state.feature.properties.tags,a.state.copyingFeature.properties.tags);ee.a.publish("body.tags.set",{tags:r})}}),ee.a.subscribe("body.imagery.set",function(e,t){"overlay"===t.type?a.setState({selectedOverlaysImagery:t.imagery}):"background"===t.type&&a.setState({selectedBaseImagery:t.imagery[0]})}),ee.a.subscribe("body.imagery.opacity",function(e,t){if("floor"!==t.type){a.setState(Object(m.a)({},{background:"baseImageryOpacity",overlay:"overlaysImageryOpacity"}[t.type],t.opacity))}else{var n=window.imageryManager.getFloorImages().find(function(e){return e.selected&&e.visible});n&&ee.a.publish("body.floorimagery.update",{imagery:[Object.assign({},n,{opacity:t.opacity})]})}}),ee.a.subscribe("body.floorimagery.add",function(){var e=Object(h.a)(d.a.mark(function e(t,n){return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,window.imageryManager.addFloorImagery(n.imagery,a.map.getBounds(),a.map.elem.leafletElement);case 2:null===a.state.floorImageryMode?a.setState({floorImageryMode:"scale"}):a.forceUpdate();case 3:case"end":return e.stop()}},e)}));return function(t,a){return e.apply(this,arguments)}}()),ee.a.subscribe("body.floorimagery.update",function(){var e=Object(h.a)(d.a.mark(function e(t,n){return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,window.imageryManager.updateFloorImagery(n.imagery);case 2:a.forceUpdate();case 3:case"end":return e.stop()}},e)}));return function(t,a){return e.apply(this,arguments)}}()),ee.a.subscribe("body.floorimagery.mode",function(){var e=Object(h.a)(d.a.mark(function e(t,n){return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a.setState({floorImageryMode:n.mode});case 1:case"end":return e.stop()}},e)}));return function(t,a){return e.apply(this,arguments)}}()),ee.a.subscribe("body.floorimagery.remove",function(){var e=Object(h.a)(d.a.mark(function e(t,n){return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,window.imageryManager.removeFloorImagery(n&&n.id);case 2:a.forceUpdate();case 3:case"end":return e.stop()}},e)}));return function(t,a){return e.apply(this,arguments)}}()),ee.a.subscribe("body.floorimagery.save",function(e,t){Object(b.saveAs)(new Blob([JSON.stringify(window.imageryManager.getFloorImages(),null,2)],{type:"text/plain;charset=utf-8"}),"osminedit_floor_imagery.json")}),ee.a.subscribe("body.floorimagery.copyposition",function(){var e=Object(h.a)(d.a.mark(function e(t,n){var r;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:(r=window.imageryManager.getFloorImages().find(function(e){return e.selected&&e.visible}))&&a.setState({floorImageryCopyPaste:{topleft:r.topleft,topright:r.topright,bottomleft:r.bottomleft,bottomright:r.bottomright,origWidth:r.origWidth,origHeight:r.origHeight}});case 2:case"end":return e.stop()}},e)}));return function(t,a){return e.apply(this,arguments)}}()),ee.a.subscribe("body.floorimagery.pasteposition",function(){var e=Object(h.a)(d.a.mark(function e(t,n){return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,window.imageryManager.moveFloorImagery(a.map&&a.map.elem&&a.map.elem.leafletElement,a.state.floorImageryCopyPaste);case 2:a.forceUpdate();case 3:case"end":return e.stop()}},e)}));return function(t,a){return e.apply(this,arguments)}}()),ee.a.subscribe("body.tags.set",function(e,n){if(a.state.datalocked)return setTimeout(function(){return ee.a.publish("body.tags.set",n)},100),null;if(a.state.mode===t.MODE_CHANGESET){var r=Object.assign({},a.state.changeset,{tags:n.tags});a.setState({changeset:r})}else a.setState({datalocked:!0},function(){if(a._addUsedImagery(),a.state.mode===t.MODE_BUILDING){var e=Object.assign({},a.state.building);n.tags.building&&""!==n.tags.building.trim()||(n.tags.building="yes"),a.setState({building:window.vectorDataManager.setFeatureTags(e.id,n.tags),datalocked:!1})}else if(a.state.mode===t.MODE_LEVELS){var r=Object.assign({},a.state.floor);a.setState({floor:window.vectorDataManager.setFeatureTags(r.id,n.tags),datalocked:!1})}else if(a.state.mode===t.MODE_FEATURES){var i=Object.assign({},a.state.feature),o=a.state.feature.properties.own.levels;a.setState({feature:window.vectorDataManager.setFeatureTags(i.id,n.tags),datalocked:!1},function(){if(!P()(o,a.state.feature.properties.own.levels)&&a.state.building&&a.state.feature.properties.own.levels.findIndex(function(e){return!a.state.building.properties.own.levels.includes(e)})>=0){var e=Object.assign({},a.state.building);e.properties.own.levelsComputed=!1,window.vectorDataManager.getBuildingLevels(e),a.setState({building:e})}})}else a.setState({datalocked:!1})})}),ee.a.subscribe("body.action.undo",function(e,n){if(a.state.datalocked)return setTimeout(function(){return ee.a.publish("body.action.undo",n)},100),null;a.setState({datalocked:!0},function(){a.state.mode===t.MODE_FLOOR_IMAGERY?window.imageryManager.undo():[t.MODE_BUILDING,t.MODE_LEVELS,t.MODE_FEATURES].includes(a.state.mode)&&(a.state.draw?ee.a.publish("body.draw.cancel"):window.vectorDataManager.undo()),a.setState({datalocked:!1}),a.forceUpdate()})}),ee.a.subscribe("body.action.redo",function(e,n){if(a.state.datalocked)return setTimeout(function(){return ee.a.publish("body.action.redo",n)},100),null;a.setState({datalocked:!0},function(){a.state.mode===t.MODE_FLOOR_IMAGERY?window.imageryManager.redo():[t.MODE_BUILDING,t.MODE_LEVELS,t.MODE_FEATURES].includes(a.state.mode)&&!a.state.draw&&window.vectorDataManager.redo(),a.setState({datalocked:!1}),a.forceUpdate()})}),ee.a.subscribe("body.action.save",function(){var e=Object(h.a)(d.a.mark(function e(t,n){var r,i;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a.setState({changeset:Object.assign({},a.state.changeset,{status:"upload"})}),e.next=3,window.vectorDataManager.sendOSMData(a.state.changeset.tags);case 3:"number"===typeof(r=e.sent)?a.setState({changeset:{status:"sent",id:r}}):(console.error(r),i={changeset:{status:"error"}},"Changeset creation failed"===r.message&&(i.changeset.reason="changeset_failed"),a.setState(i));case 5:case"end":return e.stop()}},e)}));return function(t,a){return e.apply(this,arguments)}}()),ee.a.subscribe("body.action.cleanup",function(e,n){window.vectorDataManager.cleanUp(),a.map&&a.map.cleanUp(),a._usedImageryNames=new Set,ee.a.publish("body.mode.set",{mode:t.MODE_BUILDING})}),ee.a.subscribe("map.zoom.changed",function(e,t){a.setState({zoom:t.zoom});var n=a.state.selectedOverlaysImagery&&a.state.selectedOverlaysImagery.find(function(e){return"mapbox_locator_overlay"===e.properties.id});if(n&&t.zoom&&n.properties.max_zoom&&t.zoom>n.properties.max_zoom){var r=a.state.selectedOverlaysImagery.filter(function(e){return"mapbox_locator_overlay"!==e.properties.id});a.setState({selectedOverlaysImagery:0===r.length?null:r})}});var n=function(){var t,n=new File([JSON.stringify((t=window.vectorDataManager._cacheOsmGeojson,t.features.forEach(function(e){e.properties=Object(u.a)({},e.properties,e.properties.tags)}),t))],"osminedit.geojson");e.postMessage({command:"preview",file:n},"*"),e.postMessage({command:"level",level:a.state.level.toString()},"*"),e.focus()};ee.a.subscribe("body.preview.open",function(){!e||e.closed?(e=window.open("https://indoorequal.org/"),window.addEventListener("message",function(e){"ready"===e.data.event&&n()})):n()}),q.a.bind("esc",function(){a.state.draw?ee.a.publish("body.draw.stop"):a.state.mode===t.MODE_BUILDING&&a.state.building||a.state.mode===t.MODE_LEVELS&&a.state.floor||a.state.mode===t.MODE_FEATURES&&a.state.feature?ee.a.publish("body.unselect.feature"):a.state.mode===t.MODE_FEATURES?ee.a.publish("body.mode.set",{mode:t.MODE_LEVELS}):a.state.mode===t.MODE_LEVELS&&ee.a.publish("body.mode.set",{mode:t.MODE_BUILDING})}),q.a.bind("enter",function(){a.state.draw&&ee.a.publish("body.draw.stop")}),q.a.bind("ctrl+z",function(){ee.a.publish("body.action.undo")}),q.a.bind("ctrl+shift+z",function(){ee.a.publish("body.action.redo")}),q.a.bind("del",function(){ee.a.publish("body.delete.feature")}),q.a.bind("ctrl+c",function(){ee.a.publish("body.copy.feature")}),q.a.bind("ctrl+v",function(){ee.a.publish("body.paste.feature")}),q.a.bind("ctrl+shift+v",function(){ee.a.publish("body.paste.tags")}),S.on("change",function(e){a.forceUpdate(),console.log("Loaded locale",e)})}},{key:"componentDidUpdate",value:function(e,a){var n={};this.map&&this.map.invalidateSize(),this.state.pane&&a.pane!==this.state.pane&&!this.state.leftPanelOpen&&(n.leftPanelOpen=!0),!this.state.pane&&a.pane!==this.state.pane&&this.state.leftPanelOpen&&(n.leftPanelOpen=!1),[t.MODE_FEATURES,t.MODE_LEVELS].includes(this.state.mode)&&!this.state.building&&(n.mode=t.MODE_BUILDING,n.pane=null,n.leftPanelOpen=!1),this.state.mode===t.MODE_BUILDING&&this.state.pane&&this.state.pane!==Qt.PANE_BUILDING_EDIT&&(n.pane=this.state.building?Qt.PANE_BUILDING_EDIT:null,n.leftPanelOpen=!!this.state.building),this.state.mode===t.MODE_LEVELS&&this.state.pane&&![Qt.PANE_LEVELS_ADD,Qt.PANE_LEVELS_EDIT].includes(this.state.pane)&&(n.pane=this.state.floor?Qt.PANE_LEVELS_EDIT:Qt.PANE_LEVELS_ADD,n.leftPanelOpen=!0),this.state.mode===t.MODE_FEATURES&&this.state.pane&&![Qt.PANE_FEATURE_ADD,Qt.PANE_FEATURE_EDIT].includes(this.state.pane)&&(n.pane=this.state.feature?Qt.PANE_FEATURE_EDIT:Qt.PANE_FEATURE_ADD,n.leftPanelOpen=!0),this._checkUserLoggedIn(),this.state.mode!==t.MODE_FLOOR_IMAGERY||1!==window.imageryManager.getFloorImages().length||window.imageryManager.getFloorImages()[0].selected||(window.imageryManager._updateSelectedImage(),0===Object.keys(n).length&&this.forceUpdate()),Object.keys(n).length>0&&this.setState(n)}},{key:"componentWillUnmount",value:function(){ee.a.unsubscribe("body.*"),ee.a.unsubscribe("map.zoom.changed"),ee.a.unsubscribe("app.user.*"),q.a.unbind("esc"),q.a.unbind("enter"),q.a.unbind("del"),q.a.unbind("ctrl+c"),q.a.unbind("ctrl+z"),q.a.unbind("ctrl+v"),q.a.unbind("ctrl+shift+z"),clearInterval(this._timerImagery)}}],[{key:"GetFeatureName",value:function(e,t){var a=e.properties.tags;return a.name||a.ref||a.brand?a.name||a.ref||a.brand:a.building?e.properties.own.new?S.t("New building"):S.t("Building"):"level"===a.indoor&&e.properties.own&&e.properties.own.levels?S.t("New floor part (level %{lvl})",{lvl:e.properties.own.levels.join(", ")}):t||(e.properties.own.new?S.t("New feature"):e.id)}}]),t}(i.Component);Vn.MODE_BUILDING=0,Vn.MODE_LEVELS=1,Vn.MODE_FEATURES=2,Vn.MODE_CHANGESET=4,Vn.MODE_FLOOR_IMAGERY=5,Vn.MODE_EXPLORE=6;var Jn=Vn,Zn=function e(t,a,r){Object(n.a)(this,e),this.type=t,this.prev=a,this.next=r};Zn.FEATURE_TAGS_EDIT=0,Zn.FEATURE_GEOM_EDIT=1,Zn.FEATURE_NEW=2,Zn.FEATURE_GEOM_SQUARE=11,Zn.FLOOR_NEW=3,Zn.FLOOR_COPY=10,Zn.BUILDING_NEW=4,Zn.FEATURE_DELETE=5,Zn.FEATURE_COPY=6,Zn.FLOOR_IMG_ADD=7,Zn.FLOOR_IMG_UPDATE=8,Zn.FLOOR_IMG_DELETE=9;var $n=Zn,qn=a(95),Yn=a.n(qn),Xn=function(){function e(){Object(n.a)(this,e),this._actions=[],this._lastActionId=-1}return Object(r.a)(e,[{key:"undo",value:function(){throw new Error("Should be overridden by subclass")}},{key:"redo",value:function(){if(this.canRedo()){var e=this._actions[this._lastActionId+1];this._lastActionId++,this._do(e,!0)}}},{key:"canUndo",value:function(){return this._lastActionId>-1}},{key:"canRedo",value:function(){return this._lastActionId<this._actions.length-1}},{key:"getAmountEdits",value:function(){return this._lastActionId+1}},{key:"_do",value:function(e,t){throw new Error("Should be overridden by subclass")}}]),e}(),Kn=a(129),Qn=a.n(Kn),er=["osmbe","osmfr","osm-mapnik-german_style","HDM_HOT","osm-mapnik-black_and_white","osm-mapnik-no_labels","OpenStreetMap-turistautak","hike_n_bike","landsat","skobbler","public_transport_oepnv","tf-cycle","tf-landscape","qa_no_address","wikimedia-map","openinframap-petroleum","openinframap-power","openinframap-telecoms","openpt_map","openrailwaymap","openseamap","opensnowmap-overlay","US-TIGER-Roads-2012","US-TIGER-Roads-2014","Waymarked_Trails-Cycling","Waymarked_Trails-Hiking","Waymarked_Trails-Horse_Riding","Waymarked_Trails-MTB","Waymarked_Trails-Skating","Waymarked_Trails-Winter_Sports","OSM_Inspector-Addresses","OSM_Inspector-Geometry","OSM_Inspector-Highways","OSM_Inspector-Multipolygon","OSM_Inspector-Places","OSM_Inspector-Routing","OSM_Inspector-Tagging","EsriWorldImagery"],tr=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(g.a)(this,Object(y.a)(t).call(this)))._rawLayers=null,e._floorImagery=[],e._isLoading=!1,e}return Object(v.a)(t,e),Object(r.a)(t,[{key:"getAvailableImagery",value:function(e){var t=this;if(this._isLoading)return new Promise(function(a){setTimeout(function(){return a(t.getAvailableImagery(e))},200)});if(this._rawLayers){var a=e?{type:"Point",coordinates:[e.lng,e.lat]}:null;return new Promise(function(e){return e(t._rawLayers.filter(function(e){return null===a||null===e.geometry||Yn()(e,a)}).sort(function(e,t){var a=e.properties,n=t.properties;return a.best&&n.best?0:a.best?-1:n.best?1:a.default&&n.default?0:a.default?-1:n.default?1:0}))})}return this._isLoading=!0,Qn()("https://osmlab.github.io/editor-layer-index/imagery.geojson").then(function(a){return a=JSON.parse(a),t._rawLayers=[],a.features.forEach(function(e){var a=e.properties,n=!0;if(er.includes(a.id)&&(n=!1),["bing","tms","wms"].includes(a.type)||(n=!1),a.end_date){var r=new Date(a.end_date);if(!isNaN(r.getTime())){var i=new Date;i.setFullYear(i.getFullYear()-10),r<=i&&(n=!1)}}"fr.ign.bdortho"===a.id&&(a.max_zoom=19),a.url.includes(".mapbox.com")&&(a.url=a.url.replace(/access_token=.*$/,"access_token=pk.eyJ1Ijoib3BlbnN0cmVldG1hcCIsImEiOiJjbGZkenFib3IyazZlNDRwYzd5eWg5Mjl2In0.Gha0ZtI4GZy36s8h8ClbaQ")),n&&t._rawLayers.push(e)}),t._isLoading=!1,t.getAvailableImagery(e)})}},{key:"getFloorImages",value:function(){return this._floorImagery}},{key:"addFloorImagery",value:function(e,t,a){return this._do(new $n($n.FLOOR_IMG_ADD,null,arguments))}},{key:"_addFloorImagery",value:function(){var e=Object(h.a)(d.a.mark(function e(t,a,n){var r,i,o=this;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this._floorImagery=this._floorImagery.map(function(e){return e.selected=!1,e}),r=this._floorImagery.map(function(e){return e.id}),i=this._floorImagery.length>0?this._floorImagery[this._floorImagery.length-1]:null,a&&(a=a.pad(-.3)),e.abrupt("return",Promise.all(t.map(function(e){return new Promise(function(t){if(e.id||(e.id=zt()(e.image)),void 0===e.visible&&(e.visible=!0),r.includes(e.id))t();else{var s=function(a){o._floorImagery.push(e),r.push(e.id),t(),a&&o.moveFloorImagery(n,i,e)};if(e.topleft)s();else if(a){var l=!1,u=new Image;u.src=e.image,u.onload=function(){if(i&&i.origWidth===u.width&&i.origHeight===u.height)e.topleft=i.topleft,e.topright=i.topright,e.bottomleft=i.bottomleft,e.bottomright=i.bottomright,e.origWidth=i.origWidth,e.origHeight=i.origHeight;else{var t=n.latLngToContainerPoint(a.getCenter()),r=n.latLngToContainerPoint(a.getNorthEast()),o=n.latLngToContainerPoint(a.getSouthWest()),c=r.y-o.y,d=u.width*c/u.height,p=n.containerPointToLatLng([t.x+Math.round(d/2),o.y]),h=n.containerPointToLatLng([t.x-Math.round(d/2),r.y]);e.topleft=[h.lat,p.lng],e.topright=h,e.bottomleft=p,e.bottomright=[p.lat,h.lng],e.origWidth=u.width,e.origHeight=u.height,n&&i&&(l=!0)}s(l)}}}})})).then(function(){return o._updateSelectedImage(),o._floorImagery}));case 5:case"end":return e.stop()}},e,this)}));return function(t,a,n){return e.apply(this,arguments)}}()},{key:"updateFloorImagery",value:function(e){return this._do(new $n($n.FLOOR_IMG_UPDATE,this._floorImagery,arguments))}},{key:"_updateFloorImagery",value:function(e){var t={};return e.forEach(function(e){t[e.id]=e}),this._floorImagery=this._floorImagery.map(function(e){return t[e.id]?t[e.id]:e}),this._floorImagery.filter(function(e){return e.selected}).length>1&&(this._floorImagery=this._floorImagery.map(function(e){return e.selected=!1,e}),this._updateSelectedImage()),this._floorImagery}},{key:"moveFloorImagery",value:function(e,t,a){var n=a||this._floorImagery.find(function(e){return e.selected&&e.visible});if(n&&t){var r=Object.assign({},n);if(n.origWidth/n.origHeight===t.origWidth/t.origHeight)r.topleft=t.topleft,r.topright=t.topright,r.bottomleft=t.bottomleft,r.bottomright=t.bottomright;else if(e){var i=B.a.latLngBounds(n.bottomright,n.topleft).getCenter(),o=B.a.latLngBounds(t.bottomright,t.topleft).getCenter(),s=B.a.GeometryUtil.bearing(i,o),l=i.distanceTo(o),u=B.a.GeometryUtil.destination(B.a.latLng(n.topleft),s,l),c=B.a.GeometryUtil.destination(B.a.latLng(n.topright),s,l),d=B.a.GeometryUtil.destination(B.a.latLng(n.bottomleft),s,l),p=B.a.GeometryUtil.destination(B.a.latLng(n.bottomright),s,l),h=B.a.latLngBounds(t.topleft,t.topright).getCenter(),f=B.a.latLngBounds(u,c).getCenter(),m=h.distanceTo(o),g=f.distanceTo(o),y=B.a.GeometryUtil.bearing(o,h)-B.a.GeometryUtil.bearing(o,f),v=B.a.GeometryUtil.rotatePoint(e,u,y,o),b=B.a.GeometryUtil.rotatePoint(e,c,y,o),_=B.a.GeometryUtil.rotatePoint(e,d,y,o),E=B.a.GeometryUtil.rotatePoint(e,p,y,o),w=m/g,O=B.a.GeometryUtil.destination(o,B.a.GeometryUtil.bearing(o,v),o.distanceTo(v)*w),k=B.a.GeometryUtil.destination(o,B.a.GeometryUtil.bearing(o,b),o.distanceTo(b)*w),L=B.a.GeometryUtil.destination(o,B.a.GeometryUtil.bearing(o,_),o.distanceTo(_)*w),S=B.a.GeometryUtil.destination(o,B.a.GeometryUtil.bearing(o,E),o.distanceTo(E)*w);r.topleft=O,r.topright=k,r.bottomleft=L,r.bottomright=S}else console.error("Can't paste position on this floor plan");return this.updateFloorImagery([r])}}},{key:"lockFloorImagery",value:function(){return this._floorImagery=this._floorImagery.map(function(e){return e.selected=!1,e}),this._floorImagery}},{key:"removeFloorImagery",value:function(e){return this._do(new $n($n.FLOOR_IMG_DELETE,this._floorImagery.filter(function(t){return t.id===e}),arguments))}},{key:"_removeFloorImagery",value:function(e){return e?(this._floorImagery=this._floorImagery.filter(function(t){return t.id!==e}),this._updateSelectedImage()):this._floorImagery=[],this._floorImagery}},{key:"_updateSelectedImage",value:function(){this._floorImagery.length>0&&!this._floorImagery.find(function(e){return e.selected})&&(this._floorImagery[this._floorImagery.length-1].selected=!0)}},{key:"undo",value:function(){var e=this;if(this.canUndo()){var t=this._actions[this._lastActionId];switch(this._lastActionId--,t.type){case $n.FLOOR_IMG_ADD:t.next[0]?t.next[0].forEach(function(t){var a=t.id||zt()(t.image);e._removeFloorImagery(a)}):this._removeFloorImagery();break;case $n.FLOOR_IMG_UPDATE:this._floorImagery=t.prev;break;case $n.FLOOR_IMG_DELETE:this._addFloorImagery(t.prev)}}}},{key:"_do",value:function(e,t){var a=this;t||e.type!==$n.FLOOR_IMG_UPDATE||0===e.next[0].filter(function(e){var t=a._floorImagery.find(function(t){return t.id===e.id});return!t||t.topleft!==e.topleft||t.topright!==e.topright||t.bottomleft!==e.bottomleft||t.bottomright!==e.bottomright||t.level!==e.level}).length&&(t=!0);switch(t||(this._actions.length>this._lastActionId+1&&(this._actions=this._actions.slice(0,this._lastActionId+1)),this._actions.push(e),this._lastActionId++),e.type){case $n.FLOOR_IMG_ADD:return this._addFloorImagery.apply(this,Object(p.a)(e.next));case $n.FLOOR_IMG_UPDATE:return this._updateFloorImagery.apply(this,Object(p.a)(e.next));case $n.FLOOR_IMG_DELETE:return this._removeFloorImagery.apply(this,Object(p.a)(e.next));default:return null}}}]),t}(Xn),ar=a(390),nr=a(391),rr=function(e){return e&&"object"===typeof e&&!Array.isArray(e)},ir=function e(t){for(var a=arguments.length,n=new Array(a>1?a-1:0),r=1;r<a;r++)n[r-1]=arguments[r];if(!n.length)return t;var i=n.shift();if(rr(t)&&rr(i))for(var o in i)rr(i[o])?(t[o]||Object.assign(t,Object(m.a)({},o,{})),e(t[o],i[o])):Array.isArray(i[o])&&Array.isArray(t[o])?t[o]=t[o].concat(i[o]):Object.assign(t,Object(m.a)({},o,i[o]));return e.apply(void 0,[t].concat(n))},or=function(e){return e.map(function(e){return"string"===typeof e&&(e=parseFloat(e)),parseFloat(e.toFixed(8))})},sr=function(e,t){var a=[],n=e.length<t.length?e:t,r=e.length<t.length?t:e;return n.forEach(function(e){r.find(function(t){return P()(e,t)})&&!a.find(function(t){return P()(e,t)})&&a.push(e)}),a},lr=a(392),ur=a.n(lr);function cr(e){if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=function(e,t){if(!e)return;if("string"===typeof e)return dr(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return dr(e,t)}(e))){var t=0,a=function(){};return{s:a,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,r,i=!0,o=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){o=!0,r=e},f:function(){try{i||null==n.return||n.return()}finally{if(o)throw r}}}}function dr(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var pr=function(){function e(){Object(n.a)(this,e),this._presetsURL=["./presets/indoor.xml","./presets/default.xml"],this._presets=null,this._loading=!1}return Object(r.a)(e,[{key:"loadPresets",value:function(){var e=this;this._loading=!0,Promise.all(this._presetsURL.map(function(t){return Qn()(window.EDITOR_URL+t).then(e._xmlToJson).then(function(t){return e._simplifyJSONPreset(t.presets,"presets")}).catch(function(){return null})})).then(function(t){e._presets=ir.apply(void 0,[{}].concat(Object(p.a)(t.filter(function(e){return null!==e}))));e._searcher=new ur.a(function e(t){var a=[];return t.items&&(a=a.concat(t.items.map(function(e){return e.tags&&(e.kv=Object.entries(e.tags).flat().map(function(e){return e.replace(/_/g," ")})),e}))),t.groups&&(a=a.concat(t.groups.map(function(t){return e(t)}).flat())),a}(e._presets),{shouldSort:!0,threshold:.4,maxPatternLength:32,minMatchCharLength:3,keys:[{name:"name",weight:.7},{name:"kv",weight:.3}]}),e._loading=!1})}},{key:"getPresets",value:function(e,t){if(this._presets){var a;if("/"===e)a=this._presets;else{var n,r=e.split("/").filter(function(e){return""!==e}),i=this._presets,o=cr(r);try{var s=function(){var e=n.value,t=i.groups&&i.items?i.groups.concat(i.items):i.items?i.items:i.groups;if(1!==(t=t.filter(function(t){return t.name===e})).length)return i=null,"break";i=t[0]};for(o.s();!(n=o.n()).done;){if("break"===s())break}}catch(l){o.e(l)}finally{o.f()}a=i}return this._applyFiltering(a,t)}return null}},{key:"findPresetsByName",value:function(e,t){if(e&&0!==e.trim().length){if(this._presets){var a=this._searcher.search(e);return this._applyFiltering({items:a},t)}return null}return null}},{key:"_applyFiltering",value:function(e,t){if(e&&t){e=function e(a){var n=Object.assign({},a);return a.items&&(n.items=a.items.filter(t)),a.groups&&(n.groups=a.groups.map(function(t){return e(t)}).filter(function(e){return null!==e})),n.groups&&0!==n.groups.length||n.items&&0!==n.items.length||(n=null),!n||!n.groups||1!==n.groups.length||n.items&&0!==n.items.length||(n=n.groups[0]),n}(e)}return e}},{key:"findPresetsForFeature",value:function(e){if(this._presets){var t=[],a=e.properties.tags;return function e(n){n.groups&&n.groups.forEach(e),n.items&&n.items.filter(function(e){return e.tags}).forEach(function(e){var n=!0;for(var r in e.tags)if("none"!==e.tagMatch[r]&&a[r]!==e.tags[r]&&(void 0===a[r]||"key"!==e.tagMatch[r])){n=!1;break}n&&t.push(e)})}(this._presets),t}return null}},{key:"_simplifyJSONPreset",value:function(e,t){var a=this,n={},r=function(r,i){i.includes(t)&&e[r]&&(n[r+"s"]=e[r].map(function(e){return a._simplifyJSONPreset(e,r)}))};if(["item","chunk"].includes(t)&&e.optional&&(n.optionals=ir.apply(void 0,[{}].concat(Object(p.a)(e.optional.map(function(e){return a._simplifyJSONPreset(e,"optional")}))))),e.checkgroup&&(e.check=e.check||[],e.checkgroup.forEach(function(t){e.check=e.check.concat(t.check)})),r("group",["presets","group"]),r("item",["group"]),r("link",["item","chunk","optional"]),r("text",["item","chunk","optional"]),r("combo",["item","chunk","optional"]),r("reference",["item","chunk","optional"]),r("multiselect",["item","chunk","optional"]),r("list_entry",["combo","multiselect"]),r("check",["item","chunk","optional"]),"presets"===t&&e.chunk){var i={};e.chunk.map(function(e){return a._simplifyJSONPreset(e,"chunk")}).forEach(function(e){i[e.id]=e}),n.chunks=i}if(["item","chunk","optional"].includes(t)&&e.key){var o={},s={};e.key.map(function(e){return a._simplifyJSONPreset(e,"key")}).forEach(function(e){o[e.key]=e.value,e.match&&"keyvalue"!==e.match&&(s[e.key]=e.match)}),n.tags=o,n.tagMatch=s}if(["icon","name","key","value","type","wiki","id","ref","href","text","default","use_last_as_default","auto_increment","length","alternative_autocomplete_keys","match","values","editable","delimiter","indoor_structure","values_from","display_values","short_descriptions","values_searchable","use_last_as_default","values_no_i18n","values_sort","rows","short_description","icon_size","display_value"].forEach(function(t){e.$&&e.$[t]&&(n[t]=e.$[t])}),S.locale&&"en"!==S.locale&&["group","item","label","text","combo","multiselect","list_entry","check"].includes(t)){["name","text","display_values","display_value"].forEach(function(t){e.$[S.locale+"."+t]&&(n[t]=e.$[S.locale+"."+t])})}if(n.type&&(n.type=n.type.split(",")),"presets"===t&&n.chunks){n=function e(t){return["groups","items"].forEach(function(a){t[a]&&(t[a]=t[a].map(e))}),t.optionals&&(t.optionals=e(t.optionals)),t.references&&delete(t=ir.apply(void 0,[{},t].concat(Object(p.a)(t.references.map(function(e){return n.chunks[e.ref]}))))).references,t}(n)}return n}},{key:"_xmlToJson",value:function(e){return new Promise(function(t,a){Object(nr.parseString)(e,function(e,n){e?a(e):t(n)})})}}]),e}(),hr=a(393),fr=a.n(hr),mr=a(52),gr=a(394),yr=a.n(gr),vr=a(253),br=a.n(vr),_r=a(178),Er=a.n(_r),wr=a(254),Or=a.n(wr),kr=a(206),Lr=a(395),Sr=a.n(Lr),Ir=a(57),Nr=a(396),Dr=a.n(Nr);function Mr(e,t,a){return a?Math.abs(e[0]-t[0])<=a&&Math.abs(e[1]-t[1])<=a:e[0]===t[0]&&e[1]===t[1]}function Cr(e,t){return[e[0]+t[0],e[1]+t[1]]}function jr(e,t){return[e[0]-t[0],e[1]-t[1]]}function Ar(e,t){return[e[0]*t,e[1]*t]}function xr(e,t,a){return[e[0]+(t[0]-e[0])*a,e[1]+(t[1]-e[1])*a]}function Tr(e,t){t=t||[0,0];var a=e[0]-t[0],n=e[1]-t[1];return Math.sqrt(a*a+n*n)}function Fr(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]);return 0!==t?Ar(e,1/t):[0,0]}function Gr(e,t,a){var n=jr(e,a=a||[0,0]),r=jr(t,a);return n[0]*r[0]+n[1]*r[1]}function Pr(e,t){for(var a,n,r=1/0,i=0;i<t.length-1;i++){var o,s=t[i],l=jr(t[i+1],s),u=Gr(jr(e,s),l)/Gr(l,l),c=Tr(o=u<0?s:u>1?t[i+1]:[s[0]+u*l[0],s[1]+u*l[1]],e);c<r&&(r=c,a=i+1,n=o)}return void 0!==a?{index:a,distance:r,target:n}:null}function Ur(e,t,a){return Mr(a,e)||Mr(a,t)?1:function(e,t,a){return Gr(Fr(jr(e,a=a||[0,0])),Fr(jr(t,a)))}(e,t,a)}function Rr(e,t,a,n,r){var i=Math.abs(e);return i<t?0:r&&Math.abs(i-1)<t?0:i<a||i>n?e:null}function Br(e,t,a,n){for(var r=0,i=t?0:1,o=t?e.length:e.length-1,s=e.map(function(e){return e.coord}),l=Math.cos((90-n)*Math.PI/180),u=Math.cos(n*Math.PI/180),c=i;c<o;c++){var d=s[(c-1+s.length)%s.length],p=s[c],h=Rr(Ur(d,s[(c+1)%s.length],p),a,l,u);null!==h&&(r+=2*Math.min(Math.abs(h-1),Math.min(Math.abs(h),Math.abs(h+1))))}return r}var zr=1e-4,Wr=13;function Hr(e){return e.map(function(e){return{id:e.id,coord:[e.coord[0],e.coord[1]]}})}function Vr(e){return e.map(function(e){return{id:e.id,loc:[e.loc[0],e.loc[1]]}})}function Jr(e,t){return e.find(function(e){return e.id===t})}function Zr(e,t,a){return e.map(function(e){return e.id===t?{id:e.id,loc:a}:e})}var $r=a(397),qr=a.n($r),Yr=a(398),Xr=a.n(Yr),Kr=a(399),Qr=a.n(Kr),ei=a(199),ti=a.n(ei),ai=a(401);function ni(e){if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=function(e,t){if(!e)return;if("string"===typeof e)return ri(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return ri(e,t)}(e))){var t=0,a=function(){};return{s:a,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,r,i=!0,o=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){o=!0,r=e},f:function(){try{i||null==n.return||n.return()}finally{if(o)throw r}}}}function ri(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var ii=function(e,t){return e-t},oi=["level","repeat_on","created_by","source"],si=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(g.a)(this,Object(y.a)(t).call(this)))._cacheOsmXml=null,e._cacheOsmGeojson=null,e._cacheBbox=null,e._nextId=-1,e._osmApi=new Qr.a({endpoint:window.CONFIG.osm_api_url,always_authenticated:window.CONFIG.always_authenticated,oauthConsumerKey:window.CONFIG.oauth_consumer_key,oauthSecret:window.CONFIG.oauth_secret}),e}return Object(v.a)(t,e),Object(r.a)(t,[{key:"loadOSMData",value:function(e){var t=this;return new Promise(function(a,n){t._cacheBbox&&t._cacheBbox.filter(function(t){return t.contains(e)}).length>0&&a(!0);var r=null!==t._cacheOsmXml;t._osmApi.fetchMapByBbox(e.getWest(),e.getSouth(),e.getEast(),e.getNorth(),"both").then(function(n){var i=Object(f.a)(n,2),o=i[0],s=i[1];if(t._appendOsmXml(o,s,e),t._cacheOsmJson.node&&t._cacheOsmJson.node.length>0||t._cacheOsmJson.way&&t._cacheOsmJson.way.length>0||t._cacheOsmJson.relation&&t._cacheOsmJson.relation.length>0?t._cacheOsmGeojson=t.getBaseCollection():t._cacheOsmGeojson={type:"FeatureCollection",features:[]},r){t._nextId=-1;for(var l=0;l<=t._lastActionId;l++)t._do(t._actions[l],!0)}a(!0)}).catch(function(e){console.error("Can't load OSM data",e),n(e)})})}},{key:"_appendOsmXml",value:function(e,t,a){var n=this,r=(new window.DOMParser).parseFromString(t,"text/xml");if(this._cacheOsmXml&&this._actions.length>0){this._cacheBbox.push(a);var i=this._cacheOsmXml.children[0],o=r.children[0],s=[];["node","way","relation"].filter(function(t){return e[t]}).forEach(function(t){var a={};n._cacheOsmJson[t]&&n._cacheOsmJson[t].forEach(function(e,t){a[e.$.id]={v:e.$.version,i:t}}),e[t].forEach(function(e,r){var l=t+"[id='"+e.$.id+"']",u=a[e.$.id];if(n._cacheOsmJson[t]&&u&&u.v<e.$.version){n._cacheOsmJson[t][e.$.id]=e;var c=i.querySelector(e.$.id);c.parentNode.replaceChild(o.querySelector(l),c)}else n._cacheOsmJson[t]?n._cacheOsmJson[t].push(e):n._cacheOsmJson[t]=[e],s.push(o.querySelector(l))})}),i.append.apply(i,s)}else this._cacheOsmXml=r,this._cacheOsmJson=e,this._cacheBbox=[a]}},{key:"cleanUp",value:function(){this._cacheOsmXml=null,this._cacheOsmGeojson=null,this._cacheBbox=null,this._nextId=-1,this._actions=[],this._lastActionId=-1}},{key:"getOSMBuildings",value:function(e){var t=[];return e=void 0===e?void 0:Math.floor(e),this._cacheOsmGeojson&&(t=this._cacheOsmGeojson.features.filter(function(t){return"Feature"===t.type&&t.properties&&t.properties.tags&&t.properties.tags.building&&(void 0===e||t.properties.own&&t.properties.own.levels&&t.properties.own.levels.includes(e))})),{type:"FeatureCollection",features:t}}},{key:"getBuildingLevels",value:function(e){var t=this;if(!e.properties.own.levels||!e.properties.own.levelsComputed){if(e=this._listFeatureLevels(e,!0),this._cacheOsmGeojson){var a=new Set(e.properties.own.levels);this._cacheOsmGeojson.features.forEach(function(n){try{Yn()(e,n)&&t._listFeatureLevels(n).properties.own.levels.forEach(function(e){return a.add(e)})}catch(r){}}),e.properties.own.levels=Array.from(a)}e.properties.own.levels.sort(ii),e.properties.own.levelsComputed=!0}return e}},{key:"getAllLevels",value:function(e){var t=this;if(e=e||!1,this._cacheOsmGeojson){var a=new Set;this._cacheOsmGeojson.features.forEach(function(n){t._listFeatureLevels(n).properties.own.levels.forEach(function(t){return a.add(e?Math.floor(t):t)})});var n=Object(p.a)(a);return n.sort(function(e,t){return parseInt(e)-parseInt(t)}),n}return[0]}},{key:"isOverlappingEnough",value:function(e,t){if(e&&t&&"Feature"===e.type&&"Feature"===t.type){if(Yn()(e,t)){if(this._containsWithBoundary(e,t)||this._containsWithBoundary(t,e))return!0;if("Polygon"===e.geometry.type&&"Polygon"===t.geometry.type){var a=Dr()(e,t);return void 0!==a&&null!==a&&Z.a.valid(a)&&V()(a)>=.8*V()(t)}return!0}return!1}return!1}},{key:"findAssociatedBuilding",value:function(e){var t=this;if(e.properties.tags.building)return e;var a=this.getOSMBuildings().features.filter(function(a){return t._containsWithBoundary(a,e)});return 1===a.length?a[0]:null}},{key:"getLevelFootprint",value:function(e,t){var a=this;return this._cacheOsmGeojson?this._cacheOsmGeojson.features.filter(function(n){return"Feature"===n.type&&n.properties.tags&&"level"===n.properties.tags.indoor&&(n.properties.own.utilityNode||a._listFeatureLevels(n).properties.own.levels.includes(t))&&a.isOverlappingEnough(e,n)}):null}},{key:"getCopiableLevels",value:function(e){var t=this;if(this._cacheOsmGeojson){var a=this._cacheOsmGeojson.features.filter(function(a){return"Feature"===a.type&&a.properties.tags&&"level"===a.properties.tags.indoor&&t.isOverlappingEnough(e,a)}).map(function(e){return t._listFeatureLevels(e).properties.own.levels}).flat(),n=Object(p.a)(new Set(a));return n.sort(function(e,t){return parseFloat(e)-parseFloat(t)}),n}return null}},{key:"getFeaturesInFloor",value:function(e,t,a){var n=this;a=a||{};var r=[];if(this._cacheOsmGeojson){var i=e&&Object(kr.a)(e,20,{units:"meters"});if(r=this._cacheOsmGeojson.features.filter(function(r){try{return(n._listFeatureLevels(r).properties.own.levels||[]).includes(t)&&"Feature"===r.type&&(o=r.properties.tags,(a.includeFloorParts||"level"!==o.indoor)&&!o.building&&!o["building:part"])&&(!e||Yn()(i,r))}catch(s){return!1}var o}),a.building)r=r.map(function(e){return["Point","LineString"].includes(e.geometry.type)&&e.properties.tags.door&&(e.properties.own.onBuildingContour=n.isOnContour(a.building,e)),e});else{var o=this._cacheOsmGeojson.features.filter(function(e){return"Feature"===e.type&&["Polygon","MultiPolygon"].includes(e.geometry.type)&&e.properties.tags.building});r=r.map(function(e){if(e.properties.tags.door&&["Point","LineString"].includes(e.geometry.type)){var t,a=!1,r=ni(o);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(n.isOnContour(i,e)){a=!0;break}}}catch(s){r.e(s)}finally{r.f()}e.properties.own.onBuildingContour=a}return e})}r.sort(function(e,t){return parseInt("Point"===e.geometry.type)-parseInt("Point"===t.geometry.type)})}return{type:"FeatureCollection",features:r}}},{key:"getFeaturesInLevel",value:function(e,t){var a=this,n=[];if(this._cacheOsmGeojson){var r=e&&Object(kr.a)(e,20,{units:"meters"});n=this._cacheOsmGeojson.features.filter(function(n){try{return(a._listFeatureLevels(n).properties.own.levels||[]).includes(t)&&"Feature"===n.type&&("level"!==(i=n.properties.tags).indoor&&!i.building&&!i["building:part"])&&(!e||Yn()(r,n))}catch(o){return!1}var i}),e&&(n=n.map(function(t){return["Point","LineString"].includes(t.geometry.type)&&t.properties.tags.door&&(t.properties.own.onBuildingContour=a.isOnContour(e,t)),t})),n.sort(function(e,t){return parseInt("Point"===e.geometry.type)-parseInt("Point"===t.geometry.type)})}return{type:"FeatureCollection",features:n}}},{key:"hasIndoorFeatures",value:function(e){var t,a=!1;if(e&&this._cacheOsmGeojson)for(var n=0;n<this._cacheOsmGeojson.features.length;n++){var r=this._cacheOsmGeojson.features[n];if(r.id.startsWith("way/")&&"MultiPolygon"!==r.geometry.type&&(void 0!==(t=r.properties.tags).level&&void 0!==t.indoor&&"level"!==t.indoor&&!t.building&&!t["building:part"])&&Yn()(e,r)){a=!0;break}}return a}},{key:"findMissingLevelOutlines",value:function(e){var t=this,a={};return this._cacheOsmGeojson?(this._cacheOsmGeojson.features.forEach(function(e){if(e.properties.tags&&e.properties.tags.building){var n=e.properties.tags.name||e.properties.tags.ref||e.id,r=t._listFeatureLevels(e,!0).properties.own.levels,i=t.getCopiableLevels(e);(r=r.filter(function(e){return!i.includes(e)})).length>0&&t.hasIndoorFeatures(e)&&(a[e.id]={name:n,levels:r})}}),a):null}},{key:"_containsWithBoundary",value:function(e,t){if("Feature"!==t.type||"Feature"!==e.type)return!1;if(P()(t.geometry,e.geometry))return!0;if(this._booleanContains(e,t))return!0;if(Yn()(e,t)){var a,n=Object(Ir.coordAll)(t),r=Object(kr.a)(e,.01,{units:"meters"}),i=ni(n);try{for(i.s();!(a=i.n()).done;){var o=a.value;if(!o||!Er()(o,r))return!1}}catch(s){i.e(s)}finally{i.f()}return!0}return!1}},{key:"createNewBuilding",value:function(e){return this._do(new $n($n.BUILDING_NEW,this._nextId,arguments))}},{key:"_createNewBuilding",value:function(e){return e.id="way/"+this._nextId--,e.properties.tags={building:"yes"},e.properties.own={new:!0},e=this._listFeatureLevels(e),this._cacheOsmGeojson.features.push(e),e}},{key:"createNewFloor",value:function(e,t){return this._do(new $n($n.FLOOR_NEW,this._nextId,arguments))}},{key:"_createNewFloor",value:function(e,t){return e.id="way/"+this._nextId--,e.properties.tags={indoor:"level",level:t.toString()},e.properties.own={new:!0},e=this._listFeatureLevels(e),this._cacheOsmGeojson.features.push(e),e}},{key:"createNewFeature",value:function(e,t,a){return this._do(new $n($n.FEATURE_NEW,this._nextId,arguments))}},{key:"_createNewFeature",value:function(e,t,a){var n="invalid";return"Point"===e.geometry.type?n="node":["LineString","Polygon"].includes(e.geometry.type)&&(n="way"),e.id=n+"/"+this._nextId--,e.properties.tags=Object.assign({level:t.toString()},a.tags),e.properties.own={new:!0},e=this._listFeatureLevels(e),this._cacheOsmGeojson.features.push(e),e}},{key:"copyLevel",value:function(e,t,a){return this._do(new $n($n.FLOOR_COPY,this._nextId,arguments))}},{key:"_copyLevel",value:function(e,t,a){var n=this;a=parseFloat(a),t=parseFloat(t);var r=this.getFeaturesInFloor(e,t,{includeFloorParts:!0}).features.filter(function(e){return!n._listFeatureLevels(e).properties.own.levels.includes(a)}).map(function(e){return n._listFeatureLevels({id:e.id.split("/")[0]+"/"+n._nextId--,type:"Feature",properties:{tags:Object.assign({},e.properties.tags,{level:a.toString()}),own:{new:!0}},geometry:Object.assign({},e.geometry)})});return r.forEach(function(e){n._cacheOsmGeojson.features.push(e)}),r.map(function(e){return e.id})}},{key:"copyFeature",value:function(e,t,a){return this._do(new $n($n.FEATURE_COPY,this._nextId,arguments))}},{key:"_copyFeature",value:function(e,t,a){var n=R.GeoJSON.coordsToLatLng(Sr()(e).geometry.coordinates),r=n.distanceTo(a),i=Object(mr.bearingToAzimuth)(fr()(R.GeoJSON.latLngToCoords(n),R.GeoJSON.latLngToCoords(a))),o=Object(ai.a)(e,r,i,{units:"meters",mutate:!1});return o.id=e.id.split("/")[0]+"/"+this._nextId--,o.properties.tags.level=t.toString(),o.properties.own={new:!0},o=this._listFeatureLevels(o),this._cacheOsmGeojson.features.push(o),o}},{key:"editFeature",value:function(e,t){var a=this._findCacheId(e.id);return-1!==a?(t||(e=this._listFeatureLevels(e,!0)),this._cacheOsmGeojson.features[a]===e||P()(this._cacheOsmGeojson.features[a],e)||(this._cacheOsmGeojson.features[a]=e),e):(console.error("Can't find feature in cache"),null)}},{key:"makeFeatureSquare",value:function(e,t){var a=this._findCacheId(e);return this._do(new $n($n.FEATURE_GEOM_SQUARE,[e,-1!==a?this._cacheOsmGeojson.features[a].geometry:null],arguments))}},{key:"_makeFeatureSquare",value:function(e,t){var a=this,n=this._findCacheId(e);if(-1!==n){var r=this._listFeatureLevels(this._cacheOsmGeojson.features[n]),i=[],o=[],s=[];r.properties.own&&r.properties.own.levels&&r.properties.own.levels.length>0&&(i=this._cacheOsmGeojson.features.filter(function(e,t){if(e&&e.id!==r.id&&e.properties.own&&e.properties.own.levels&&e.geometry&&"Feature"===e.type){for(var n=!1,i=0;i<r.properties.own.levels.length;i++){var s=r.properties.own.levels[i];if(e.properties.own.levels.includes(s)){n=!0;break}}return!(!n||br()(r,e)||a._booleanContains(e,r)||a._booleanContains(r,e))&&(o.push(t),!0)}return!1}));var l=Object.assign({},this._cacheOsmGeojson.features[n]),u=function(e,t){if("Polygon"!==e.geometry.type&&"LineString"!==e.geometry.type)return e;for(var a=Math.cos((90-Wr)*Math.PI/180),n=Math.cos(Wr*Math.PI/180),r="Polygon"===e.geometry.type||P()(e.geometry.coordinates[0],e.geometry.coordinates[e.geometry.coordinates.length-1]),i=Vr(("Polygon"===e.geometry.type?e.geometry.coordinates[0]:e.geometry.coordinates).map(function(e,t){return{id:t,loc:e.slice()}})),o=0;o<i.length-1;o++)Tr(i[o].loc,i[o+1].loc)<1e-6&&(i.splice(o,1),o--);var s=Vr(i);r&&i.pop();var l,u,c,d,p,h,f,m={},g=[],y={i:0,dotp:1},v=function(e){var a=t.latLngToLayerPoint([e[1],e[0]]);return[a.x,a.y]},b=function(e){var a=t.layerPointToLatLng(e);return[a.lng,a.lat]},_=function(e,t,n){if(!r&&(0===t||t===n.length-1))return[0,0];if(m[n[t].id]>1)return[0,0];var i=n[(t-1+n.length)%n.length].coord,o=e.coord,s=n[(t+1)%n.length].coord,l=jr(i,o),u=jr(s,o),c=2*Math.min(Tr(l),Tr(u));l=Fr(l),u=Fr(u);var d=l[0]*u[0]+l[1]*u[1],p=Math.abs(d);return p<a?(y.i=t,y.dotp=p,Ar(Fr(Cr(l,u)),.1*d*c)):[0,0]};for(h=0;h<i.length;h++)l=i[h],m[l.id]=(m[l.id]||0)+1,g.push({id:l.id,coord:v(l.loc)});if(3===g.length){for(h=0;h<1e3&&(p=g.map(_),g[y.i].coord=Cr(g[y.i].coord,p[y.i]),!((d=y.dotp)<zr));h++);l=s[y.i],c=b(g[y.i].coord),i=Zr(i,l.id,xr(l.loc,c,1))}else{var E=[],w=[];for(h=0;h<g.length;h++){u=g[h];var O=0;if(r||h>0&&h<g.length-1){var k=g[(h-1+g.length)%g.length],L=g[(h+1)%g.length];O=Math.abs(Ur(k.coord,L.coord,u.coord))}O>n?E.push(u):w.push(u)}var S=Hr(w),I=Hr(w);for(d=1/0,h=0;h<1e3;h++){for(p=w.map(_),f=0;f<p.length;f++)w[f].coord=Cr(w[f].coord,p[f]);var N=Br(w,r,zr,Wr);if(N<d&&(S=Hr(w),d=N),d<zr)break}var D=S.map(function(e){return e.coord});for(r&&D.push(D[0]),h=0;h<S.length;h++)u=S[h],Mr(I[h].coord,u.coord)||(l=Jr(s,u.id),c=b(u.coord),i=Zr(i,l.id,xr(l.loc,c,1)));for(h=0;h<E.length;h++)if(u=E[h],!(m[u.id]>1)){l=Jr(s,u.id);var M=Pr(u.coord,D);M&&(c=b(M.target),i=Zr(i,l.id,xr(l.loc,c,1)))}}r&&i.push(i[0]);var C={type:"Feature",geometry:{type:e.geometry.type}};return"Polygon"===e.geometry.type?C.geometry.coordinates=[i.map(function(e){return or(e.loc)})]:C.geometry.coordinates=i.map(function(e){return or(e.loc)}),C}(l,t).geometry;if(!P()(r.geometry,u)){l.geometry=u,this._cacheOsmGeojson.features[n]=l,s.push(r);var c="LineString"===u.type?l:ti()(l),d="LineString"===r.geometry.type?r:ti()(r),p={type:"FeatureCollection",features:c.geometry.coordinates.map(function(e){return{type:"Feature",properties:{},geometry:{type:"Point",coordinates:or(e)}}})},h=function(e){return qr()({type:"Point",coordinates:e},p).geometry.coordinates},f=function(e){return e.map(function(e){return Or()(e,d)?h(e):e})};o.forEach(function(e,t){var n=Object.assign({},i[t]);n.geometry=Object.assign({},n.geometry);try{switch(n.geometry.type){case"Point":n.geometry.coordinates=h(n.geometry.coordinates);break;case"LineString":n.geometry.coordinates=f(n.geometry.coordinates);break;case"Polygon":n.geometry.coordinates=n.geometry.coordinates.map(function(e){return f(e)});break;default:console.log("Ignored snapping of feature",n.id)}P()(i[t].geometry,n.geometry)||(a._cacheOsmGeojson.features[e]=n,s.push(i[t]))}catch(r){console.error("Can't snap for feature",n.id,r)}})}return this._actions[this._lastActionId].prev=s,l}return console.error("Can't find feature in cache"),null}},{key:"editFeatureGeometry",value:function(e,t){var a=this._findCacheId(e);return this._do(new $n($n.FEATURE_GEOM_EDIT,[e,-1!==a?this._cacheOsmGeojson.features[a].geometry:null],arguments))}},{key:"_editFeatureGeometry",value:function(e,t){var a=this._findCacheId(e);if(-1!==a){var n=Object.assign({},this._cacheOsmGeojson.features[a]);return P()(n.geometry,t)||(n.geometry=t,this._cacheOsmGeojson.features[a]=n),n}return console.error("Can't find feature in cache"),null}},{key:"setFeatureTags",value:function(e,t){var a=this._findCacheId(e);return this._do(new $n($n.FEATURE_TAGS_EDIT,[e,-1!==a?this._cacheOsmGeojson.features[a].properties.tags:null],arguments))}},{key:"_setFeatureTags",value:function(e,t){var a=this._findCacheId(e);if(-1!==a){var n=this._cacheOsmGeojson.features[a];if(!P()(n.properties.tags,t)){var r=void 0!==n.properties.tags.repeat_on||void 0!==t.repeat_on;n.properties.tags=t,(n=this._listFeatureLevels(n,!0)).id.startsWith("node/")&&(n.properties.own.utilityNode=!this.hasMainTags(t)),t.level&&!r||!t.level&&r?(n.properties.tags.level=this._cleanLevelTag(n.properties.own.levels),delete n.properties.tags.repeat_on):t.level&&r&&(this._isVerticalFeature(n)&&n.properties.own.levels.length>1?(n.properties.tags.level=this._cleanLevelTag(n.properties.own.levels.slice(0,2)),n.properties.own.levels.length>2?n.properties.tags.repeat_on=this._cleanLevelTag(n.properties.own.levels.slice(2)):delete n.properties.tags.repeat_on):n.properties.own.levels.length>0?(n.properties.tags.level=n.properties.own.levels[0],n.properties.own.levels.length>1?n.properties.tags.repeat_on=this._cleanLevelTag(n.properties.own.levels.slice(1)):delete n.properties.tags.repeat_on):(delete n.properties.tags.level,delete n.properties.tags.repeat_on)),t.building&&(n.properties.own.levelsComputed=!1,n=this.getBuildingLevels(n)),this._cacheOsmGeojson.features[a]=n}return n}return console.error("Can't find feature in cache"),null}},{key:"hasMainTags",value:function(e){return Object.keys(e).filter(function(e){return!oi.includes(e)}).length>0}},{key:"_cleanLevelTag",value:function(e){var t=[];return e.forEach(function(e,a){if(0===a)t.push(e);else{var n=t[t.length-1];if(Array.isArray(n))n[1]===e-1?t[t.length-1][1]=e:t.push(e);else n===e-1?(t.pop(),t.push([n,e])):t.push(e)}}),t.map(function(e){return"number"===typeof e?e.toString():e[0]===e[1]-1?e[0].toString()+";"+e[1].toString():e[0].toString()+"-"+e[1].toString()}).join(";")}},{key:"deleteFeature",value:function(e,t){return this._do(new $n($n.FEATURE_DELETE,null,arguments))}},{key:"_deleteFeature",value:function(e,t){var a=this._findCacheId(e.id);if(-1!==a){this._cacheOsmGeojson.features.splice(a,1);var n=void 0!==e.properties.tags.building,r="level"===e.properties.tags.indoor,i=r&&parseFloat(e.properties.tags.level);if(t&&(n||r&&!isNaN(i))){for(var o=[],s=0;s<this._cacheOsmGeojson.features.length;s++){var l=this._cacheOsmGeojson.features[s];void 0===l.properties.tags.building&&void 0===l.properties.tags["building:part"]&&(n||r&&P()(l.properties.own.levels,[i]))&&this._containsWithBoundary(e,l)&&(this._cacheOsmGeojson.features.splice(s,1),o.push(l),s--)}o.length>0&&(this._actions[this._lastActionId].prev=o)}}else console.log("Feature not found in cache")}},{key:"findNodeFeature",value:function(e,t){var a=null;if(t=t||this._cacheOsmGeojson){var n=t.features.filter(function(t){return"Feature"===t.type&&"Point"===t.geometry.type&&parseFloat(t.geometry.coordinates[0])===e.lng&&parseFloat(t.geometry.coordinates[1])===e.lat});1===n.length&&(a=n[0])}return a}},{key:"findFeature",value:function(e,t){return(t||this._cacheOsmGeojson).features.find(function(t){return t.id===e})}},{key:"isOnContour",value:function(e,t){return!this._booleanContains(e,t)&&this._containsWithBoundary(e,t)}},{key:"getBaseCollection",value:function(){return this._completeGeoJSON(Xr()(this._cacheOsmXml,{flatProperties:!1,uninterestingTags:function(){return!1}}))}},{key:"computeDiff",value:function(){var e=Object(h.a)(d.a.mark(function e(){var t,a,n,r;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=Date.now(),a=this.getBaseCollection(),n=this._cacheOsmGeojson,e.t0=this,e.next=6,this._analyzeDiff(a,n);case 6:return e.t1=e.sent,e.t2=a,e.t3=n,r=e.t0._addDiffMedata.call(e.t0,e.t1,e.t2,e.t3),console.log("Processed in",Date.now()-t,"ms"),e.abrupt("return",r);case 12:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"sendOSMData",value:function(){var e=Object(h.a)(d.a.mark(function e(t){var a,n,r,i,o,s,l,u,c,p,h,m,g,y,v;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!window.editor_user||!window.editor_user_auth){e.next=66;break}return e.next=3,this.computeDiff();case 3:return a=e.sent,this._osmApi._auth=window.editor_user_auth,delete(n=Object.assign({host:window.EDITOR_URL,locale:S.locale},t)).comment,r=null,e.prev=8,e.next=11,this._osmApi.createChangeset(window.EDITOR_NAME+" "+rn.version,t.comment||S.t("Edited building indoors"),n);case 11:r=e.sent,e.next=17;break;case 14:return e.prev=14,e.t0=e.catch(8),e.abrupt("return",new Error("Changeset creation failed"));case 17:if(e.prev=17,!r){e.next=58;break}i={},o=["node-created","node-edited","way-created","way-edited","relation-created","relation-edited","relation-deleted","way-deleted","node-deleted"],s=function(e){return o.indexOf(e[0].split("/")[0]+"-"+(e[1].deleted?"deleted":e[1].created?"created":"edited"))},l=function(e,t){return s(e)-s(t)},u=Object.entries(a).sort(l),c=ni(u),e.prev=25,c.s();case 27:if((p=c.n()).done){e.next=44;break}return h=p.value,m=Object(f.a)(h,2),g=m[0],y=m[1],e.next=32,this._transformDiffIntoElements(g,y,i);case 32:if(!(v=e.sent)){e.next=41;break}return e.next=36,this._sendElementToApi(g,y,v,i,r);case 36:if(e.sent){e.next=39;break}return e.abrupt("return",new Error("Can't upload element",g));case 39:e.next=42;break;case 41:console.warn("No element found for",h);case 42:e.next=27;break;case 44:e.next=49;break;case 46:e.prev=46,e.t1=e.catch(25),c.e(e.t1);case 49:return e.prev=49,c.f(),e.finish(49);case 52:return e.next=54,this._osmApi.closeChangeset(r);case 54:return this._disableBeforeUnload(),e.abrupt("return",r);case 58:return e.abrupt("return",new Error("Can't create changeset"));case 59:e.next=64;break;case 61:return e.prev=61,e.t2=e.catch(17),e.abrupt("return",e.t2);case 64:e.next=68;break;case 66:return console.error("You should be authenticated before sending your changes"),e.abrupt("return",new Error("Not authenticated"));case 68:case"end":return e.stop()}},e,this,[[8,14],[17,61],[25,46,49,52]])}));return function(t){return e.apply(this,arguments)}}()},{key:"_transformDiffIntoElements",value:function(){var e=Object(h.a)(d.a.mark(function e(t,a,n){var r;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null,a.newNodes&&a.newNodes.filter(function(e){return e.startsWith("node/-")}).length>0&&(a.newNodes=a.newNodes.map(function(e){return e.startsWith("node/-")?n[e]:e}).filter(function(e){return"string"===typeof e})),a.newMembers&&a.newMembers.filter(function(e){return e.feature.startsWith("node/-")}).length>0&&(a.newMembers=a.newMembers.map(function(e){return e.feature.startsWith("node/-")&&(e.feature=n[e.feature]),e}).filter(function(e){return"string"===typeof e.feature})),!a.created){e.next=7;break}t.startsWith("node/")?r=this._osmApi.createNodeElement(a.newCoords[1],a.newCoords[0],a.newTags,t.substring(5)):t.startsWith("way/")?r=this._osmApi.createWayElement(a.newNodes,a.newTags,t.substring(4)):t.startsWith("relation/"),e.next=12;break;case 7:if(r=this._osmApi.findElementWithinOSMCollection(this._cacheOsmJson,t)){e.next=12;break}return e.next=11,this._osmApi.fetchElement(t);case 11:r=e.sent;case 12:return r&&(a.created||a.deleted||(a.newTags&&(r=this._osmApi.replaceTags(r,a.newTags)),a.newNodes&&(r=this._osmApi.setNodeIdsForWay(r,a.newNodes)),a.newCoords&&(r=this._osmApi.setCoordinates(r,a.newCoords[1],a.newCoords[0])),a.newMembers&&(r=this._osmApi.setRelationMembers(r,a.newMembers.map(function(e){return{id:e.feature,role:e.role}}))),r=this._osmApi.setTimestampToNow(r))),e.abrupt("return",r);case 14:case"end":return e.stop()}},e,this)}));return function(t,a,n){return e.apply(this,arguments)}}()},{key:"_sendElementToApi",value:function(){var e=Object(h.a)(d.a.mark(function e(t,a,n,r,i){var o;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!a.deleted){e.next=6;break}return e.next=3,this._osmApi.deleteElement(n,i);case 3:return e.abrupt("return",e.sent);case 6:return e.next=8,this._osmApi.sendElement(n,i);case 8:if(!(o=e.sent)){e.next=14;break}return a.created&&(r[t]=n._type+"/"+o),e.abrupt("return",!0);case 14:return e.abrupt("return",!1);case 15:case"end":return e.stop()}},e,this)}));return function(t,a,n,r,i){return e.apply(this,arguments)}}()},{key:"undo",value:function(){var e=this;if(this.canUndo()){var t=this._actions[this._lastActionId];switch(this._lastActionId--,t.type){case $n.BUILDING_NEW:ee.a.publish("body.select.building",{building:null});case $n.FLOOR_NEW:ee.a.publish("body.select.floor",{floor:null});case $n.FEATURE_NEW:ee.a.publish("body.select.feature",{feature:null});var a=this._findCacheId(t.next[0].id);-1!==a&&this._cacheOsmGeojson.features.splice(a,1),this._nextId=t.prev;break;case $n.FLOOR_COPY:ee.a.publish("body.select.feature",{feature:null}),ee.a.publish("body.select.floor",{floor:null}),this._cacheOsmGeojson.features=this._cacheOsmGeojson.features.filter(function(e){return parseInt(e.id.split("/")[1])>t.prev}),this._nextId=t.prev;break;case $n.FEATURE_TAGS_EDIT:this._setFeatureTags.apply(this,Object(p.a)(t.prev));break;case $n.FEATURE_GEOM_EDIT:this._editFeatureGeometry.apply(this,Object(p.a)(t.prev));break;case $n.FEATURE_GEOM_SQUARE:t.prev.forEach(function(t){var a=e._findCacheId(t.id);a>=0&&(e._cacheOsmGeojson.features[a]=t)});break;case $n.FEATURE_DELETE:this._cacheOsmGeojson.features.push(t.next[0]),t.next[1]&&t.prev&&(this._cacheOsmGeojson.features=this._cacheOsmGeojson.features.concat(t.prev));break;case $n.FEATURE_COPY:ee.a.publish("body.select.feature",{feature:null}),this._cacheOsmGeojson.features.pop(),this._nextId=t.prev}}}},{key:"_do",value:function(e,t){switch(t||(this._actions.length>this._lastActionId+1&&(this._actions=this._actions.slice(0,this._lastActionId+1)),this._actions.push(e),this._lastActionId++,this._enableBeforeUnload()),e.type){case $n.BUILDING_NEW:return this._createNewBuilding.apply(this,Object(p.a)(e.next));case $n.FLOOR_NEW:return this._createNewFloor.apply(this,Object(p.a)(e.next));case $n.FLOOR_COPY:return this._copyLevel.apply(this,Object(p.a)(e.next));case $n.FEATURE_NEW:return this._createNewFeature.apply(this,Object(p.a)(e.next));case $n.FEATURE_TAGS_EDIT:if(!t&&this._actions.length>=2&&this._actions[this._actions.length-2].type===$n.FEATURE_TAGS_EDIT){var a=this._actions[this._actions.length-2],n=this._actions[this._actions.length-1];if(n.next[0]===a.next[0]){var r=[],i=a.next[1],o=n.next[1];Object.entries(o).forEach(function(e){e[1]!==i[e[0]]&&r.push(e[0])}),1!==r.length||a.lastMerge&&a.lastMerge!==r[0]||(this._lastActionId===this._actions.length-1&&this._lastActionId--,this._actions.splice(this._actions.length-2,1),n.prev=a.prev,n.lastMerge=r[0])}}return this._setFeatureTags.apply(this,Object(p.a)(e.next));case $n.FEATURE_GEOM_EDIT:return this._editFeatureGeometry.apply(this,Object(p.a)(e.next));case $n.FEATURE_GEOM_SQUARE:return this._makeFeatureSquare.apply(this,Object(p.a)(e.next));case $n.FEATURE_DELETE:return this._deleteFeature.apply(this,Object(p.a)(e.next));case $n.FEATURE_COPY:return this._copyFeature.apply(this,Object(p.a)(e.next));default:return null}}},{key:"_analyzeDiff",value:function(){var e=Object(h.a)(d.a.mark(function e(t,a){var n=this;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(e){setTimeout(function(){var r={},i={};t.features.forEach(function(e){return r[e.id]=e}),a.features.forEach(function(e){return i[e.id]=e});var o={},s=a.features.filter(function(e){return e.id.startsWith("node/-")}).map(function(e){return parseInt(e.id.substring(5))});s.sort(function(e,t){return e-t});var l={val:s.length>0?s[0]-1:-1};a.features=a.features.map(function(e){return n._listFeatureLevels(e)});var u=new Set;a.features.forEach(function(e){var t;switch(e.id.split("/")[0]){case"node":e.properties.own||(e.properties.own={}),e.properties.own.fixed=e.properties.own.fixed||n.hasMainTags(e.properties.tags),e.properties.own.fixed&&u.add(e.id);break;case"way":n.hasMainTags(e.properties.tags)&&(t=r[e.id])&&P()(t.geometry,e.geometry)&&e.properties.own.nodes.filter(function(e){return!u.has(e)}).forEach(function(e){var t=i[e];t&&(t.properties.own.fixed=!0,u.add(e))})}}),t.features.forEach(function(e){var s=i[e.id],u=!s;if(u&&e.id.startsWith("node/")){var c,d=ni(a.features);try{for(d.s();!(c=d.n()).done;){var p=c.value;if(p&&p.properties.own&&(p.id.startsWith("way/")&&p.properties.own.nodes&&p.properties.own.nodes.find(function(t){return t===e.id})||p.id.startsWith("relation/")&&p.properties.own.members&&p.properties.own.members.find(function(t){return t.feature===e.id}))){u=!1,s=Object.assign({},e,{properties:{tags:{}}});break}}}catch(_){d.e(_)}finally{d.f()}}var h=!u&&!P()(e.properties.tags,s.properties.tags),f=!u&&!P()(e.geometry,s.geometry),m=!u&&e.id.startsWith("relation/")&&e.properties.own.members.filter(function(e){return o[e.feature]&&o[e.feature].deleted}).length>0;if(u||h||f||m){if(o[e.id]={},u&&(o[e.id].deleted=!0),h&&(o[e.id].newTags=n._cleanFeatureTags(s.properties.tags)),f)if(e.id.startsWith("node/"))o[e.id].newCoords=s.geometry.coordinates,s.properties.own||(s.properties.own={}),s.properties.own.fixed=n.hasMainTags(s.properties.tags);else if(e.id.startsWith("way/"))o=n._assignNodesToWay(o,t,a,r,i,e,s,l);else if(e.id.startsWith("relation/")&&"Feature"===e.type)if("MultiPolygon"===s.geometry.type&&0===e.properties.own.members.filter(function(e){return"inner"===e.role}).length&&e.properties.own.members.length===s.geometry.coordinates.length){var g=e.properties.own.members.map(function(e){return r[e.feature]}).filter(function(e){return null!==e});if(g.length===s.geometry.coordinates.length){var y=s.geometry.coordinates.map(function(e){for(var t=null,a=0;a<g.length;a++)if(P()("LineString"===g[a].geometry.type?[g[a].geometry.coordinates]:g[a].geometry.coordinates,e)){var n=i[g[a].id];t=n&&!P()(n.geometry,g[a].geometry)?n.geometry:"same",g.splice(a,0);break}return t});(y=y.map(function(e,t){if(!e){var a=0,n=null,r=s.geometry.coordinates[t];g.forEach(function(e,t){var i=sr(r[0],"LineString"===e.geometry.type?e.geometry.coordinates:e.geometry.coordinates[0]).length/r[0].length;i>a&&(a=i,n=e)}),e=i[n.id]}return e})).forEach(function(e,u){if(null!==e&&"same"!==e){var c=s.geometry.coordinates[u];e.geometry.coordinates="LineString"===e.geometry.type?c[0]:c,o=n._assignNodesToWay(o,t,a,r,i,r[e.id],e,l)}})}}else if("Polygon"===s.geometry.type&&1===e.properties.own.members.filter(function(e){return"outer"===e.role}).length&&e.geometry.coordinates.length===s.geometry.coordinates.length){var v=e.properties.own.members.map(function(e){return r[e.feature]}).filter(function(e){return null!==e});if(v.length===s.geometry.coordinates.length){var b=s.geometry.coordinates.map(function(e){for(var t=null,a=0;a<v.length;a++)if(P()("LineString"===v[a].geometry.type?v[a].geometry.coordinates:v[a].geometry.coordinates[0],e)){var n=i[v[a].id];t=n&&!P()(n.geometry,v[a].geometry)?n.geometry:"same",v.splice(a,0);break}return t});(b=b.map(function(e,t){if(!e){var a=0,n=null,r=s.geometry.coordinates[t];v.forEach(function(e,t){var i=sr(r,"LineString"===e.geometry.type?e.geometry.coordinates:e.geometry.coordinates[0]).length/r.length;i>a&&(a=i,n=e)}),e=i[n.id]}return e})).forEach(function(e,u){if(null!==e&&"same"!==e){var c=s.geometry.coordinates[u];e.geometry.coordinates="LineString"===e.geometry.type?c:[c],o=n._assignNodesToWay(o,t,a,r,i,r[e.id],e,l)}})}}else console.log("Ignored complex multipolygon",e.id);m&&(o[e.id].newMembers=e.properties.own.members.filter(function(e){return!o[e.feature]||!o[e.feature].deleted}),0===o[e.id].newMembers.length&&(o[e.id]={deleted:!0}))}}),a.features.filter(function(e){return!r[e.id]}).forEach(function(e){o[e.id]={created:!0,newTags:n._cleanFeatureTags(e.properties.tags)},e.id.startsWith("node/")?(o[e.id].newCoords=e.geometry.coordinates,e.properties.own||(e.properties.own={}),e.properties.own.fixed=!0):e.id.startsWith("way/")&&(o=n._assignNodesToWay(o,t,a,r,i,null,e,l))});var c={};a.features.forEach(function(e){if(e.id.startsWith("node/"))c[e.id]=e.geometry.coordinates;else if(e.id.startsWith("way/")){(o[e.id]&&o[e.id].newNodes?o[e.id].newNodes:e.properties.own.nodes).forEach(function(e){var t=i[e]||r[e];t&&(c[e]=t.geometry.coordinates)})}}),Object.entries(o).filter(function(e){return e[0].startsWith("node/")&&e[1].newCoords}).forEach(function(e){return c[e[0]]=e[1].newCoords});var d=["room","area","corridor","wall","level"],h=function(e){return Object(p.a)(new Set(e.map(function(e){return e.properties.own.levels}).flat().filter(function(e){return!isNaN(e)})))},m=function(e){return Object(p.a)(new Set(e.map(function(e){return o[e.id]&&o[e.id].newNodes?o[e.id].newNodes:e.properties.own.nodes}).flat())).map(function(e){return[e,c[e]]}).filter(function(e){return null!==e[1]})},g=a.features.filter(function(e){return e.id.startsWith("way/")}),y=g.filter(function(e){return e.properties.tags.highway}),v=g.filter(function(e){return e.properties.tags.indoor&&d.includes(e.properties.tags.indoor)}),b=g.filter(function(e){return e.properties.tags.building||e.properties.tags["building:part"]}),_=a.features.filter(function(e){return e.id.startsWith("node")&&(e.properties.tags.door||e.properties.tags.entrance)});_.length>0&&b.length>0&&(o=n._connectNodesToWays(o,t,a,r,i,_.map(function(e){return[e.id,c[e.id]]}),b,c)),h(_).forEach(function(e){o=n._connectNodesToWays(o,t,a,r,i,_.filter(function(t){return t.properties.own.levels.includes(e)}).map(function(e){return[e.id,c[e.id]]}),g.filter(function(t){return t.properties.own.levels.includes(e)&&(t.properties.tags.highway||t.properties.tags.indoor&&d.includes(t.properties.tags.indoor))}),c)}),h(y).forEach(function(e){var s=y.filter(function(t){return t.properties.own.levels.includes(e)});o=n._connectNodesToWays(o,t,a,r,i,m(s),s,c)}),h(v).forEach(function(e){var s=v.filter(function(t){return t.properties.own.levels.includes(e)});o=n._connectNodesToWays(o,t,a,r,i,m(s),s,c)});var E=m(v);E.length>0&&b.length>0&&(o=n._connectNodesToWays(o,t,a,r,i,E,b,c));var w={};Object.entries(c).forEach(function(e){var t=Object(f.a)(e,2),a=t[0],n=t[1],r=JSON.stringify(n);w[r]?w[r].push(a):w[r]=[a]}),Object.entries(w).map(function(e){if(e[1].length<=1)return null;var t=e[1].map(function(e){if(o[e]&&o[e].newTags)return n.hasMainTags(o[e].newTags)&&!o[e].newTags.door?null:e;var t=i[e];return t?n.hasMainTags(t.properties.tags)&&!t.properties.tags.door?null:e:null}).filter(function(e){return null!==e});return t.length>1?[e[0],t]:null}).filter(function(e){return null!==e}).forEach(function(e){var t=e[1],i=t.shift();t.forEach(function(e){var t;e.startsWith("node/-")?(t=o[e]&&o[e].newTags,delete o[e]):(t=o[e]&&o[e].newTags||r[e]&&r[e].properties.tags,o[e]={deleted:!0}),o=n._replaceNodeInDiff(o,a,e,i),t&&Object.keys(t).length>0&&(o[i]?o[i].newTags?o[i].newTags=Object.assign({},o[i].newTags,t):o[i].newTags=t:o[i]={newTags:t})})});var O=new Set;Object.entries(o).forEach(function(e){e[0].startsWith("way/")&&e[1].newNodes&&e[1].newNodes.forEach(function(e){return O.add(e)})});var k=Object.entries(o).filter(function(e){return e[0].startsWith("node/-")});a.features.filter(function(e){return e.id.startsWith("node/")&&!e.id.startsWith("node/-")&&(o[e.id]&&o[e.id].deleted||!n.hasMainTags(e.properties.tags)&&!O.has(e.id)&&(!e.properties.own||!e.properties.own.ways||0===e.properties.own.ways.filter(function(e){return void 0===o[e]||!o[e].newNodes&&!o[e].deleted}).length)&&!e.properties.own.fixed)}).forEach(function(e){if(k.length>0){var t=k.pop(),r=Object(f.a)(t,2),i=r[0],s=r[1];delete o[i],e.id.startsWith("node/-")||delete s.created,P()(s.newTags,e.properties.tags)&&delete s.newTags,o[e.id]=s,o=n._replaceNodeInDiff(o,a,i,e.id)}else e.id.startsWith("node/-")?delete o[e.id]:o[e.id]={deleted:!0}}),Object.entries(o).filter(function(e){return e[0].startsWith("way/")&&e[1].newNodes}).forEach(function(e){var t=r[e[0]];t&&P()(t.properties.own.nodes,e[1].newNodes)&&(delete e[1].newNodes,0===Object.keys(e[1]).length&&delete o[e[0]])}),Object.entries(o).filter(function(e){return 0===Object.keys(e[1]).length}).forEach(function(e){delete o[e[0]]}),e(o)},0)}));case 1:case"end":return e.stop()}},e)}));return function(t,a){return e.apply(this,arguments)}}()},{key:"_cleanFeatureTags",value:function(e){var t=Object.assign({},e);for(var a in t)0===a.trim().length||"string"!==typeof t[a]||0===t[a].trim().length?delete t[a]:(a.trim()!==a&&(t[a.trim()]=t[a].trim(),delete t[a]),t[a]&&t[a].trim()!==t[a]&&(t[a]=t[a].trim()));return t}},{key:"_addDiffMedata",value:function(e,t,a){var n={},r={};return t.features.forEach(function(e){return n[e.id]=e}),a.features.forEach(function(e){return r[e.id]=e}),Object.entries(e).forEach(function(e){var t=Object(f.a)(e,2),a=t[0],i=t[1],o=r[a]||n[a],s=i.newTags||o&&o.properties.tags||{};i.metadata={tags:s,geometry:o&&o.geometry&&o.geometry.type,name:s.name||s.ref||s.brand||window.presetsManager&&Object(p.a)(new Set(window.presetsManager.findPresetsForFeature({properties:{tags:s}}).map(function(e){return e.name}))).join(", ")||a}}),e}},{key:"_replaceNodeInDiff",value:function(e,t,a,n){return t.features.filter(function(e){return e.id.startsWith("way/")}).forEach(function(t){if(e[t.id]&&e[t.id].newNodes&&e[t.id].newNodes.includes(a))for(;e[t.id].newNodes.includes(a);)e[t.id].newNodes[e[t.id].newNodes.indexOf(a)]=n;e[t.id]&&e[t.id].newNodes||!t.properties.own||!t.properties.own.nodes||!t.properties.own.nodes.includes(a)||(e[t.id]||(e[t.id]={}),e[t.id].newNodes=t.properties.own.nodes.map(function(e){return e===a?n:e}))}),e}},{key:"_assignNodesToWay",value:function(e,t,a,n,r,i,o,s){var l=this,u=o.id,c="LineString"===o.geometry.type?o.geometry.coordinates:o.geometry.coordinates[0];c=c.filter(function(e,t){return 0===t||!P()(c[t-1],e)}),e[u]||(e[u]={}),e[u].newNodes=Array.from({length:c.length}),c.forEach(function(t,n){var r=l.findNodeFeature({lat:t[1],lng:t[0]},a);r&&(e[u].newNodes[n]=r.id)});for(var d=0;d<e[u].newNodes.length;d++){var p=e[u].newNodes[d],h=c[d];if(!p){var f=h&&this.findNodeFeature({lat:h[1],lng:h[0]},a),m=!f&&i?i.properties.own.nodes.filter(function(t){if(e[u].newNodes.includes(t))return!1;var a=r[t];return!!a&&(!a.properties||!a.properties.own||!a.properties.own.fixed&&(!a.properties.own.ways||!(a.properties.own.ways.length>1)&&(1===a.properties.own.ways.length&&a.properties.own.ways[0],!0)))}):null;if(f)e[u].newNodes[d]=f.id,f.properties.own.fixed=!0;else if(m&&m.length>0){var g=m.shift();e[g]={newCoords:h},e[u].newNodes[d]=g}else p="node/"+s.val--,e[p]={created:!0,newCoords:h,newTags:{}},e[u].newNodes[d]=p,a.features.push({type:"Feature",geometry:{type:"Point",coordinates:e[p].newCoords},id:p,properties:{tags:{},own:{fixed:!0,ways:[u]}}})}}return e}},{key:"_findCoords",value:function(e,t,a,n,r,i){if(t[e]&&t[e].newCoords)return t[e].newCoords;var o=i[e]||r[e];return o?o.geometry.coordinates:null}},{key:"_connectNodesToWays",value:function(e,t,a,n,r,i,o,s){var l=this;return i.length>0&&o.forEach(function(o){var u=E()(o),c=Object(f.a)(u,4),d=c[0],p=c[1],h=c[2],m=c[3],g=i.filter(function(e){return e[1][0]>=d&&e[1][0]<=h&&e[1][1]>=p&&e[1][1]<=m});if(g.length>0)for(var y=(e[o.id]&&e[o.id].newNodes?e[o.id].newNodes:o.properties.own.nodes).slice(0),v=!1,b=0;b<y.length-1;b++){var _=s[y[b]]||l._findCoords(y[b],e,t,a,n,r),w=s[y[b+1]]||l._findCoords(y[b+1],e,t,a,n,r);if(_&&w)for(var O=0;O<g.length;O++){var k=Object(f.a)(g[O],2),L=k[0],S=k[1];if(l._isOnLine(Number(_[0]),Number(_[1]),Number(S[0]),Number(S[1]),Number(w[0]),Number(w[1]),2e-7)){y.splice(b+1,0,L),v=!0,b--;break}}v&&(e[o.id]||(e[o.id]={}),e[o.id].newNodes=y)}}),e}},{key:"_isOnLine",value:function(e,t,a,n,r,i,o){if(e===a&&t===n||a===r&&n===i)return!1;if((e<=a&&a<=r||e>=a&&a>=r)&&(t<=n&&n<=i||t>=n&&n>=i)){var s=r-e,l=i-t;return Math.abs(l*a-s*n-e*i+r*t)/Math.sqrt(Math.pow(s,2)+Math.pow(l,2))<=o}return!1}},{key:"_completeGeoJSON",value:function(e){var t=this,a={};e.features=e.features.filter(function(e){return Z.a.valid(e)}),e.features.forEach(function(e){e.properties.own={},a[e.id]=e,t._listFeatureLevels(e,!0)});var n,r=ni(this._cacheOsmXml.children[0].children);try{for(r.s();!(n=r.n()).done;){var i=n.value;if("node"===i.nodeName){var o="node/"+i.getAttribute("id");if(!a[o]){var s={id:o,type:"Feature",geometry:{type:"Point",coordinates:or([i.getAttribute("lon"),i.getAttribute("lat")])},properties:{own:{levels:[],utilityNode:!0},tags:{}}};a[o]=s,e.features.push(s)}}else if("way"===i.nodeName){var l="way/"+i.getAttribute("id"),u=a[l];if(u){u.properties.own.nodes=[];var c,d=ni(i.children);try{for(d.s();!(c=d.n()).done;){var p=c.value;if("nd"===p.nodeName){var h="node/"+p.getAttribute("ref"),f=a[h];u.properties.own.nodes.push(h),f&&(f.properties.own.ways||(f.properties.own.ways=[]),f.properties.own.ways.push(l))}}}catch(L){d.e(L)}finally{d.f()}}}else if("relation"===i.nodeName){var m="relation/"+i.getAttribute("id"),g=a[m];if(g){g.properties.own.members=[];var y,v=ni(i.children);try{for(v.s();!(y=v.n()).done;){var b=y.value;"member"===b.nodeName&&g.properties.own.members.push({role:b.getAttribute("role"),feature:b.getAttribute("type")+"/"+b.getAttribute("ref")})}}catch(L){v.e(L)}finally{v.f()}}else{var _,E={},w=[],O=ni(i.children);try{for(O.s();!(_=O.n()).done;){var k=_.value;"member"===k.nodeName?w.push({role:k.getAttribute("role"),feature:k.getAttribute("type")+"/"+k.getAttribute("ref")}):"tag"===k.nodeName&&(E[k.getAttribute("k")]=k.getAttribute("v"))}}catch(L){O.e(L)}finally{O.f()}e.features.push({id:m,type:"Relation",geometry:null,properties:{own:{members:w},tags:E}})}}}}catch(L){r.e(L)}finally{r.f()}return e}},{key:"_findCacheId",value:function(e,t){return(t||this._cacheOsmGeojson).features.findIndex(function(t){return t.id===e})}},{key:"_listFeatureLevels",value:function(e,t){if(!t&&e.properties.own&&(e.properties.own.levels||e.properties.own.utilityNode))return e;e.properties.own||(e.properties.own={}),e.properties.own.levels=[];var a=e.properties.tags;if(null!==a&&0!==Object.keys(a).length||e.properties.relations&&0!==e.properties.relations.length){if(void 0!==a.level&&void 0!==a.repeat_on){var n=this._parseLevelsFloat(a.level),r=this._parseLevelsFloat(a.repeat_on);e.properties.own.levels=null!==n&&null!==r?n.concat(r.filter(function(e){return n.indexOf(e)<0})):null!==n?n:null!==r?r:[0]}else if(void 0!==a.level)e.properties.own.levels=this._parseLevelsFloat(a.level);else if(void 0!==a.repeat_on)e.properties.own.levels=this._parseLevelsFloat(a.repeat_on);else if(void 0!==a.min_level&&void 0!==a.max_level)e.properties.own.levels=this._parseLevelsFloat(a.min_level+"-"+a.max_level);else if(void 0!==a["buildingpart:verticalpassage:floorrange"])e.properties.own.levels=this._parseLevelsFloat(a["buildingpart:verticalpassage:floorrange"]);else if(void 0!==a["building:levels"]){var i=Math.ceil(parseFloat(a["building:levels"])),o=void 0!==a["roof:levels"]?Math.ceil(parseFloat(a["roof:levels"])):0,s=void 0!==a["building:levels:underground"]?Math.ceil(parseFloat(a["building:levels:underground"])):0;e.properties.own.levels=this._parseLevelsFloat(-s+"-"+(i+o-1))}else if(void 0!==e.properties.relations&&e.properties.relations.length>0){e.properties.own.levels=[];var l,u=ni(e.properties.relations);try{for(u.s();!(l=u.n()).done;){var c=l.value;if("level"===c.reltags.type&&void 0!==c.reltags.level){var d=this._parseLevelsFloat(c.reltags.level);1===d.length?e.properties.own.levels.push(d[0]):console.error("Invalid level value for relation "+c.rel)}else if("multipolygon"===c.reltags.type&&void 0!==c.reltags.level){this._parseLevelsFloat(c.reltags.level).forEach(function(t){e.properties.own.levels.includes(t)||e.properties.own.levels.push(t)})}}}catch(p){u.e(p)}finally{u.f()}}}else e.properties.own.levels=[0];return e.properties.own.levels||(e.properties.own.levels=[]),0!==e.properties.own.levels.length||this._isLanduse(e)||(e.properties.own.levels=[0]),e.properties.own.levels.sort(ii),e}},{key:"_isVerticalFeature",value:function(e){var t=e.properties.tags;return["elevator","steps"].includes(t.highway)||t.conveying}},{key:"_isLanduse",value:function(e){var t=e.properties.tags;return t.landuse||["school","university","college","hospital"].includes(t.amenity)||t.boundary||t["disused:boundary"]||"sports_centre"===t.leisure&&!t.building}},{key:"_booleanContains",value:function(e,t){try{return{MultiPolygon:["MultiPolygon","Polygon","LineString","Point"],Polygon:["Polygon","LineString","Point"],LineString:["LineString","Point"],Point:["Point"]}[e.geometry.type].includes(t.geometry.type)&&yr()(e,t)}catch(a){return console.error("Unsupported operation for ",e.id,t.id),!1}}},{key:"isRelationEditingSupported",value:function(e,t){if(e&&t&&"Feature"===e.type&&"Feature"===t.type&&e.geometry.type===t.geometry.type){if("MultiPolygon"===t.geometry.type)return 0===e.properties.own.members.filter(function(e){return"inner"===e.role}).length&&e.properties.own.members.length===t.geometry.coordinates.length&&0===t.geometry.coordinates.filter(function(e){return!Array.isArray(e)}).length;if("Polygon"===t.geometry.type)return 1===e.properties.own.members.filter(function(e){return"outer"===e.role}).length&&e.geometry.coordinates.length===t.geometry.coordinates.length&&0===t.geometry.coordinates.filter(function(e){return!Array.isArray(e)||new Set(e.map(function(e){return e.join(",")})).size<3}).length}return!1}},{key:"_parseLevelsFloat",value:function(e){if(!e||"string"!==typeof e||0===e.trim().length)return null;var t=null;if(/^-?\d+(?:\.\d+)?(?:;-?\d+(?:\.\d+)?)*$/.test(e))(t=e.split(";").map(parseFloat)).sort(ii);else if(/^-?\d+(?:\.\d+)?(?:,-?\d+(?:\.\d+)?)*$/.test(e))(t=e.split(",").map(parseFloat)).sort(ii);else{var a=null,n=null,r=null,i=/^(-?\d+)-(-?\d+)$/,o=/^(?:\w+ )?(-?\d+) to (-?\d+)$/;if(i.test(e)?(a=i.exec(e),n=parseInt(a[1]),r=parseInt(a[2])):o.test(e)&&(a=o.exec(e),n=parseInt(a[1]),r=parseInt(a[2])),null!==a&&null!==n&&null!==r){if(t=[],n>r){var s=n;n=r,r=s}for(var l=n;l!==r;l+=(r-n)/Math.abs(r-n))t.push(l);t.push(r)}}return t}},{key:"_enableBeforeUnload",value:function(){window.onbeforeunload=function(){return S.t("Did you save all your changes ? If not, your changes will be lost.")}}},{key:"_disableBeforeUnload",value:function(){window.onbeforeunload=null}}]),t}(Xn);function li(e){if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=function(e,t){if(!e)return;if("string"===typeof e)return ui(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return ui(e,t)}(e))){var t=0,a=function(){};return{s:a,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,r,i=!0,o=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){o=!0,r=e},f:function(){try{i||null==n.return||n.return()}finally{if(o)throw r}}}}function ui(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var ci=function(){function e(){Object(n.a)(this,e),this._initI18n(),this._initCtrl(),this._initView(),this._initAuth()}return Object(r.a)(e,[{key:"_initI18n",value:function(){var e=null;if(window.navigator.languages){var t,a=li(window.navigator.languages);try{for(a.s();!(t=a.n()).done;){var n=t.value;if(S.supportedLocales.includes(n)){e=n;break}}}catch(r){a.e(r)}finally{a.f()}}S.changeLocale(e||window.navigator.userLanguage||window.navigator.language)}},{key:"_initCtrl",value:function(){window.vectorDataManager=new si,window.presetsManager=new pr,window.imageryManager=new tr,window.presetsManager.loadPresets(),window.imageryManager.getAvailableImagery()}},{key:"_initView",value:function(){l.a.render(o.a.createElement(Jn,null),document.getElementById("root")),document.title=window.EDITOR_NAME,document.oncontextmenu=function(){return!1}}},{key:"_initAuth",value:function(){var e=this,t={apiUrl:window.CONFIG.osm_api_url,url:window.CONFIG.osm_api_url,client_id:window.CONFIG.oauth_consumer_key,redirect_uri:window.EDITOR_URL,scope:"read_prefs write_api",singlepage:!0};window.editor_user_auth=Object(ar.a)(t);var a=this._readURLParams(window.location.href);a.code?window.editor_user_auth.authenticate(function(){e._checkAuth(),localStorage.setItem("oauth_token",a.code),window.history.replaceState({},"",window.location.href.replace(/\?.*/,""))}):localStorage.getItem("oauth_token")?window.editor_user_auth.bootstrapToken(localStorage.getItem("oauth_token"),function(){e._checkAuth()}):(this._checkAuth(),this.authWait=setInterval(this._checkAuth.bind(this),100)),ee.a.subscribe("app.user.login",function(t,a){window.editor_user_auth.authenticated()||window.editor_user_auth.authenticate(function(t,a){t?(console.error(t),alert(S.t("Oops ! Something went wrong when trying to log you in")),ee.a.publish("app.user.logout")):e._checkAuth()})}),ee.a.subscribe("app.user.logout",function(e,t){window.editor_user_auth&&window.editor_user_auth.authenticated()&&window.editor_user_auth.logout(),window.editor_user=null,localStorage.removeItem("oauth_token"),ee.a.publish("app.user.left")})}},{key:"_checkAuth",value:function(){window.editor_user_auth.authenticated()&&(this.authWait&&clearInterval(this.authWait),window.editor_user_auth.xhr({method:"GET",path:"/api/0.6/user/details"},function(e,t){if(e)console.log(e),window.editor_user_auth.logout();else try{window.editor_user={id:t.firstChild.childNodes[1].attributes.id.value,name:t.firstChild.childNodes[1].attributes.display_name.value,auth:window.editor_user_auth},ee.a.publish("app.user.ready",{username:window.editor_user.name}),console.log("Logged in as",window.editor_user.name)}catch(a){console.error(a),ee.a.publish("app.user.logout")}}))}},{key:"_readURLParams",value:function(e){var t=e.split("?");return t.length>1?t[1].split("#")[0].split("&").filter(function(e){return""!==e}).reduce(function(e,t){var a=t.split("=");return e[decodeURIComponent(a[0])]=null===a[1]?"":decodeURIComponent(a[1]),e},{}):{}}}]),e}();window.EDITOR_URL=window.location.origin+window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/"))+"/",window.UNUSABLE_ICONS=new Set,Qn()(window.EDITOR_URL+"/config.json").then(function(e){window.CONFIG=JSON.parse(e),window.EDITOR_NAME=window.CONFIG.editor_name,new ci}).catch(function(e){console.error(e),alert("Can't load configuration file, please report this issue.")})}},[[407,6,7]]]);
//# sourceMappingURL=main.738aefd9.chunk.js.map