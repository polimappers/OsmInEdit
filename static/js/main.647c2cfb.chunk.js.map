{"version":3,"sources":["view/layers/leaflet.snap.js","model/mapcss/Style.js","config/locales/ui/index.js","view/dialogs/CompleteFloorImagery.js","view/dialogs/ConfirmDeletion.js","view/layers/Editable.js","view/common/Navigator.js","view/common/SelectList.js","view/common/SearchPlace.js","view/Header.js","view/common/PresetInputField.js","view/common/TagsTable.js","view/panes/BuildingEdit.js","view/common/ChangesetDiff.js","view/panes/Changeset.js","view/common/GeometryTypeSelect.js","view/common/PresetCard.js","view/common/PresetSelect.js","view/panes/features/Create.js","view/panes/features/Edit.js","view/panes/features/View.js","view/panes/FloorImagery.js","view/panes/levels/EditAll.js","view/panes/levels/EditOne.js","view/LeftPanel.js","view/dialogs/Login.js","view/layers/Building.js","view/layers/Styled.js","view/layers/Features.js","view/layers/FloorImagery.js","view/layers/Levels.js","view/common/LevelSelector.js","model/mapcss/Condition.js","model/mapcss/InstructionStyle.js","model/mapcss/MetaStyle.js","model/mapcss/PointStyle.js","model/mapcss/ShapeStyle.js","model/mapcss/ShieldStyle.js","model/mapcss/Rule.js","model/mapcss/RuleChain.js","model/mapcss/StyleChooser.js","model/mapcss/StyleList.js","model/mapcss/TextStyle.js","model/mapcss/RuleSet.js","model/mapcss/MapStyler.js","view/common/NorthPointer.js","view/common/SidePanelButton.js","view/Map.js","view/dialogs/OutOfBoundsGeometry.js","view/dialogs/MissingLevelOutlines.js","view/panes/Imagery.js","view/RightPanel.js","view/common/FloorImageryButtons.js","view/common/GeometryButtons.js","view/common/IndoorEditButtons.js","view/Toolbar.js","view/Body.js","model/Action.js","ctrl/HistorizedManager.js","ctrl/ImageryManager.js","utils.js","ctrl/PresetsManager.js","model/orthogonalize/vector.js","model/orthogonalize/ortho.js","model/orthogonalize/orthogonalize.js","ctrl/VectorDataManager.js","index.js"],"names":["L","Snap","isDifferentLayer","marker","layer","i","n","markerId","stamp","hasOwnProperty","_topOwner","Marker","editing","_enabled","_verticesHandlers","points","_markerGroup","getLayers","length","_resizeMarkers","resizeMarker","_moveMarker","processGuide","latlng","guide","snaplist","buffer","undefined","_layers","searchBuffer","id","nearlayers","concat","filter","push","findClosestLayerSnap","map","layers","tolerance","withVertices","intInfo","closest","GeometryUtil","nClosestLayers","withinTolerance","pointsWithinTolerance","shapesWithinTolerance","guidesWithinTolerance","c","layerInfo","distance","returnLayer","returnLatLng","pointInfo","shapeInfo","getLatLngs","vertexLatLng","LatLng","lat","lng","guideInfo","guideType","_guidelineGroup","_gridlineGroup","findGuideIntersection","intersection","defaultShape","latlngs","Polyline","_flat","gType","guides","nsi","wei","ns","_latlngs","we","updateSnap","_latlng","latLng","update","snap","_icon","DomUtil","addClass","fire","removeClass","snapMarker","e","options","target","_leaflet_id","_owner","snapDistance","snapVertices","Handler","MarkerSnap","extend","initialize","computeBuffer","this","_buffer","layerPointToLatLng","Point","prototype","call","_markers","_guides","arguments","Class","Util","setOptions","dragging","MarkerDrag","enable","watchMarker","on","whenReady","disable","unwatchMarker","indexOf","_snapMarker","_map","off","addGuideLayer","originalEvent","clientX","snapTouchPoint","project","getZoom","x","clientY","y","snapped","PolylineSnap","Edit","Poly","poly","that","_snapper","_createMoveMarker","icon","_poly","snapediting","_initHandlers","PolyVerticesEditSnap","PolyVerticesEdit","_createMarker","index","RectangleSnap","Rectangle","shape","_shape","CircleSnap","Circle","EditToolbar","SnapEdit","snapOptions","Array","isArray","guideLayers","_guideLayers","LayerGroup","findIndex","guideLayer","_featureGroup","eachLayer","removeGuideLayer","splice","clearGuideLayers","_enableLayerEdit","clearLayers","getLatLng","FeatureGroup","FeatureGroupSnap","getEditHandler","featureGroup","selectedPathOptions","edit","Draw","Feature","SnapMixin","_snap_initialize","_snap_on_enabled","_snap_on_disabled","_mouseMarker","setIcon","setOpacity","_snap_on_click","_errorShown","markerCount","_startLatLng","_manuallyCorrectClick","setLatLng","_mouseDownOrigin","z","mdOrigin","unproject","closestMDO","oeOrigin","closestOE","originalLatLng","ex","include","addInitHook","MapCSSStyle","__init__","merged","edited","properties","styleType","evals","drawn","has","k","mergeWith","additional","prop","setPropertyFromString","v","isEval","Boolean","Number","constructor","split","a","runEvals","tags","eval_functions","tag","t","p","cond","expr","any","max","Math","min","eval","toString","str","I18n","supportedLocales","defaultLocale","import","locale","__webpack_require__","then","bind","CompleteFloorImageryDialog","react_default","createElement","Modal","show","props","onHide","onClose","size","Header","closeButton","Title","Body","Footer","Button","variant","onClick","Component","ConfirmDeletionDialog","_this","onCancel","f","name","CloseIcon_default","onConfirm","DeleteCircleOutlineIcon_default","DeleteIcon_default","CONVEYING_TO_IMG","yes","forward","backward","reversible","stShadow","color","fillColor","opacity","fillOpacity","zIndex","existingIcons","MyMarkerSnap","removeGuideGeoJSON","geom","toGeoJSON","gj","type","deepEqual","geometry","features","MyCircleMarker","CircleMarker","_containsPoint","distanceTo","_point","_radius","MyIcon","Icon","_createImg","src","el","document","onerror","window","UNUSABLE_ICONS","add","style","display","EditableLayer","thatStyler","styler","getFeatureStyle","myprops","Object","assign","pointToLayer","feature","onFeatureClick","onEachFeature","l","Polygon","_setLayerStyle","_createSnapHandler","leaflet","_populateLayer","GeoJSON","getOptions","_this2","get","getPrototypeOf","PubSub","subscribe","msg","data","updateLeafletElement","leafletElement","_snapFollowMarker","vertex","_linesDirIcons","hasLayer","removeLayer","_markerMove","publish","allowVertexClick","node","vectorDataManager","findNodeFeature","own","utilityNode","cancel","_followMouse","publishSync","unsubscribe","_cleanLinesDirIcons","fromProps","toProps","_this3","updateIcons","enableSnap","disableSnap","setStyle","setStyleIfChanged","draw","_startDrawing","_stopDrawing","selection","enableEdit","startsWith","_featureIcons","find","d","_addIconForLayer","iconImage","iconToRemove","fid","newLayer","disableEdit","editEnabled","allowFeatureDrag","prevpos","center","getCenter","c1","coordinates","c2","_createMarkerMove","addLayer","_draggable","_startPos","newpos","_newPos","move","subtract","setLatLngs","movell","ll","latLngToLayerPoint","newfeature","newCoords","_isADoorWithWidth","_addDoorLines","layersConnected","keepRoutingGraphConnected","_isRoutingGraphRelated","_containsCoordinates","_findNodesToUpdate","coordsToLatLng","newll","_fixLatLng","_updateConnectedLayers","forEach","lc","select","_doorLines","mylatlng","equals","foundMarker","_sortFeaturesZIndex","_addIcons","_enableSnapping","_disableSnapping","polygons","ownArea","_ownArea","area","sort","b","zA","isNaN","parseInt","zB","bringToBack","bringToFront","values","ldl","_this4","shadowData","shadow","addData","guidesForSnap","_snapReplaceGuideLayers","_this5","_guideAngleShow","DRAW_POLYGON","editTools","startPolygon","DRAW_LINE","startPolyline","DRAW_MARKER","startMarker","includes","evt","coords","_guideAngleLines","layerGroup","last1","last2","angle","bearing","extPerp1","destination","extPerp2","extForward","stGuideAngle","dashArray","weight","lineCap","linePerp","polyline","lineForward","_lastGuideAngleLinesGeojson","Mousetrap","unbind","remove","GeoJSONValidation","valid","stopDrawing","_this6","createVertexIcon","className","zIndexOffset","addTo","_snapEnabled","_this7","g","door","entrance","width","parseFloat","_this8","doorLayers","potentialLayers","_isRoomLikeFeature","_asLine","doorlatlng","doorFeature","latLngToCoords","closestLayer","closestDistance","potentialLayer","getBounds","contains","dist","pointToLineDistance","unit","foundSegment","r","ring","_isOnLine","extlatlng1","extlatlng2","line","_isDoorLine","_this9","iconUrl","EDITOR_URL","iconSize","iconAnchor","ICON_SIZE","pointOnFeature","interactive","querySelectorAll","txt","parentNode","removeChild","selected","noSetStyle","myStyle","direction","_getDirection","incline","conveying","oneway","setText","highway","reverse","slice","polyDec","polylineDecorator","patterns","offset","repeat","symbol","Symbol","rotate","angleCorrection","markerOptions","attributes","fill","clearable","font-size","orientation","draggable","_hasTags","indoor","_i2","_Object$entries","entries","_e","slicedToArray","toUpdate","cr","j","newlatlngs","tu","toFixed","Path","PRESET_TO_DRAW","way","closedway","withLeaflet","Navigator","Breadcrumb","Item","mode","MODE_BUILDING","active","building","title","GetFeatureName","MODE_LEVELS","MODE_FEATURES","lvl","level","SelectList","classCallCheck","possibleConstructorReturn","state","selectedEntries","Set","setState","onChange","newSelection","delete","_step","result","_iterator","_createForOfIteratorHelper","s","done","value","err","selectionIds","ListGroup","entry","checked","changeHandler","_onEntrySelected","action","key","Form","Check","label","_reloadSelection","SearchPlace","text","loading","searchResults","showList","now","_searchTimer","clearTimeout","setTimeout","Nominatim","geocode","q","accept-language","results","display_name","lon","bbox","boundingbox","_update","catch","error","console","addr","Overlay","placement","refs","input","rootClose","_ref","scheduleUpdate","arrowProps","outOfBoundaries","objectWithoutProperties","objectSpread","common_SelectList","_onSelect","fontSize","backgroundColor","borderRadius","border","padding","Spinner","animation","InputGroup","ref","FormControl","placeholder","_search","Append","MagnifyIcon_default","isEditingIndoor","Navbar","bg","expand","Brand","cursor","MODE_EXPLORE","EDITOR_NAME","ButtonToolbar","MODE_FLOOR_IMAGERY","disabled","LayersIcon_default","Dropdown","Toggle","PencilIcon_default","Menu","common_Navigator","common_SearchPlace","PresetInputField","val","applyChange","newTags","defineProperty","trim","_timer","currentVal","res","infoTip","info","popover","Popover","OverlayTrigger","overlay","popperConfig","modifiers","preventOverflow","boundariesElement","HelpCircleIcon_default","Group","Label","Control","default","_onEdit","as","rows","list_entrys","displayValues","display_value","display_values","use_last_as_default","states","value_on","value_off","currentState","currentValState","onEvent","newState","lib_default","indeterminate","Input","currentValues","short_description","Multiselect","multiple","ms","onchange","PresetInputField_createForOfIteratorHelper","selectedOptions","elem","join","prevProps","WIKI_USE_TAG","TagsTable","newline","focusKey","focusVal","obj","arr","TagsTable_createForOfIteratorHelper","getElementsByClassName","_tagsArrayToObj","activeElement","classList","tagsObj","url","locked","_onTagsChanged","autoFocus","tabIndex","noDelete","_onTagDeleted","href","_getWikiURL","InformationVariantIcon_default","block","PlusIcon_default","_tagsObjToArray","BuildingEditPane","infoLevels","height","alt","infoLevelsUndergound","infoLevelsRoof","Container","Row","Col","_onDone","CheckIcon_default","common_PresetInputField","common_TagsTable","ChangesetDiff","typeIcon","MapMarkerIcon_default","LineString","VectorLineIcon_default","VectorSquareIcon_default","MultiPolygon","diff","elemId","elemDiff","created","deleted","metadata","DotsHorizontalIcon_default","ChangesetPane","changeset","status","CONFIG","osm_api_url","rel","CloseCircleIcon_default","reason","comment","alert","common_ChangesetDiff","GeometryTypeSelect","availableTypes","desc","types","xs","TAGS_ICONS","PresetCard","preset","isGroup","Media","onError","forceUpdate","groups","items","MapMarkerMultipleIcon_default","ChevronRightIcon_default","MapMarkerPlusIcon_default","PresetSelect","path","onSelect","onBack","pop","item","common_PresetCard","_onPresetClicked","presets","hasSearch","presetsManager","findPresetsByName","getPresets","Prepend","Text","_onBackClicked","ChevronLeftIcon_default","float","lastUsedPresets","_createEntry","it","initialPath","CreateFeaturePane","common_PresetSelect","common_GeometryTypeSelect","GEOM_TO_OSM","EditFeaturePane","tab","showPresetSelect","showLevel","combos","texts","multiselects","m","checks","ch","optionals","_presetToComponent","levels","mytags","repeat_on","toConsumableArray","usedKeys","pk","pv","prev","next","keys","mightBeStructure","findPresetsForFeature","globalPreset","_combinePresets","functionalPreset","indoor_structure","structurePreset","_tabFunDisabled","_tabStrDisabled","_hasFunPreset","_hasStrPreset","tabShown","Tabs","activeKey","Tab","eventKey","_lookForPreset","_onChangePreset","new","HistoryIcon_default","newTabVal","ViewFeaturePane","floor","FloorImageryPane","files","reader","FileReader","onload","json","JSON","parse","image","Error","topleft","topright","bottomleft","imagery","readAsText","Promise","all","resolve","Hash","readAsDataURL","floorImgs","imageryManager","getFloorImages","img","visible","es","accept","onDrop","_onDropImages","getRootProps","getInputProps","flexGrow","step","_onOpacityChanged","maxWidth","showHideClick","stopPropagation","newD","alignItems","paddingLeft","floorImageryMode","EyeIcon_default","EyeOffIcon_default","margin","substring","lastIndexOf","position","right","required","isInvalid","Feedback","EditAllLevelsPane","floorParts","getLevelFootprint","levelsForCopy","getCopiableLevels","ShapePolygonPlusIcon_default","SquareEditOutlineIcon_default","ContentDuplicateIcon_default","use","levelSelect","EditOneLevelPane","imgHeight","LeftPanel","component","pane","PANE_BUILDING_EDIT","BuildingEdit","PANE_LEVELS_ADD","EditAll","PANE_LEVELS_EDIT","EditOne","PANE_FEATURE_ADD","Create","PANE_FEATURE_EDIT","PANE_FEATURE_VIEW","View","PANE_CHANGESET","Changeset","PANE_FLOOR_IMAGERY","panes_FloorImagery","LoginDialog","canClose","always_authenticated","onLogin","BuildingLayer","getOSMBuildings","Editable","StyledLayer","featuresWithIcons","FeaturesLayer","geojson","getFeaturesInLevel","buildings","Styled","CORRESP_HANDLE","0","1","2","3","DistortableImage","_scaleBy","scale","Infinity","_overlay","zoom","getCorner","_lastDragUsed","multiplyBy","setCorner","_reset","_rotateBy","point","cos","sin","rotation","TrigUtil","radiansToDegrees","_showMarkers","_mode","currentHandle","_handles","drag","opts","myId","once","ScaleHandle","_calculateScalingFactor","latlngA","latlngB","_handled","centerPoint","_corner","formerPoint","newPoint","formerRadiusSquared","_d2","newRadiusSquared","sqrt","FloorImagery","distortableImageOverlay","corners","bottomright","keymapper","suppressToolbar","tool","_onDragging","_checkSelect","setInterval","enabled","_selected","_select","_timerDragend","crns","getCorners","dragend","_onDragEnd","setUrl","bounds","setBounds","latLngBounds","prevCorners","nextCorners","setCorners","updateHandle","setZIndex","_deselect","_toggleScale","_toggleRotate","clearInterval","MapLayer","LevelsLayer","levelParts","LevelControl","onAdd","container","create","setAvailableLevels","setLevel","lvls","innerHTML","_levels","lvlValCurr","lvlValNext","_lastByTen","minByTen","_loop","lvlByTen","myLvlByTen","cLvlByTen","addEventListener","LevelSelector_createForOfIteratorHelper","_step2","_iterator2","inten","cLvls","top","offsetTop","levelsInRange","_loop2","lvlId","myLvl","cLvl","_level","appendChild","_loop3","lid","_step3","_iterator3","_step4","_iterator4","currentRange","onRemove","LevelSelector","MapControl","MapCSSCondition","params","init","_type","test","RegExp","MapCSSInstructionStyle","set_tags","breaker","addSetTag","Style","MapCSSMetaStyle","MapCSSPointStyle","icon_image","icon_width","icon_height","NaN","icon_image_aliases","maxwidth","setImageAliases","replace","MapCSSShapeStyle","dashes","linecap","linejoin","line_style","fill_image","fill_color","fill_opacity","casing_width","casing_color","casing_opacity","casing_dashes","z_index","strokeStyler","cap","dojoColor","shapeStrokeStyler","shapeFillStyler","fillStyler","casingStyler","MapCSSShieldStyle","shield_image","shield_width","shield_height","MapCSSRule","conditions","isAnd","minZoom","maxZoom","subject","addSubject","_subject","addCondition","_condition","entity","isSubject","condition","MapCSSRuleChain","rules","subpart","Rule","z1","z2","pos","o","getParentObjects","MapCSSStyleChooser","ruleChains","RuleChain","styles","zoomSpecific","rcpos","stylepos","currentChain","newRuleChain","addStyles","updateStyles","sl","validAt","addSubpart","source","property","shapeStyles","shieldStyles","textStyles","metaStyles","pointStyles","_width","MapCSSStyleList","subparts","hasShapeStyles","hasTextStyles","hasPointStyles","hasShieldStyles","hasMetaStyles","MapCSSTextStyle","font_family","font_bold","font_italic","font_underline","font_caps","font_size","text_color","text_offset","max_width","text_halo_color","text_halo_radius","text_center","letter_spacing","fontStyler","family","textStyler","_text","decoration","align","MapCSSRuleSet","choosers","getStyles","StyleList","parseCSS","css","previous","sc","StyleChooser","COMMENT","exec","WHITESPACE","CLASS","oDECLARATION","saveChooser","addConditionToLast","Condition","oCONDITION","NOT_CLASS","ZOOM","oOBJECT","addRule","parseZoom","addZoomToLast","oZOOM","GROUP","oGROUP","CONDITION","parseCondition","OBJECT","SUBPART","setSubpart","oSUBPART","DECLARATION","UNKNOWN","substr","parseDeclaration","callback","ss","ShapeStyle","ps","PointStyle","ts","TextStyle","hs","ShieldStyle","InstructionStyle","MetaStyle","ASSIGNMENT_EVAL","DASH","ASSIGNMENT","SET_TAG_EVAL","SET_TAG","SET_TAG_TRUE","EXIT","match","BOLD","ITALIC","UNDERLINE","CENTER","CAPS","ZOOM_MINMAX","ZOOM_MIN","ZOOM_MAX","ZOOM_SINGLE","CONDITION_TRUE","CONDITION_FALSE","CONDITION_SET","CONDITION_UNSET","CONDITION_NE","CONDITION_GT","CONDITION_GE","CONDITION_LT","CONDITION_LE","CONDITION_REGEX","CONDITION_EQ","parseCSSColor","colorStr","toLowerCase","CSSCOLORS","HEX","charAt","COLOR","FALSE","aliceblue","antiquewhite","aqua","aquamarine","azure","beige","bisque","black","blanchedalmond","blue","blueviolet","brown","burlywood","cadetblue","chartreuse","chocolate","coral","cornflowerblue","cornsilk","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgray","darkgreen","darkkhaki","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategray","darkturquoise","darkviolet","deeppink","deepskyblue","dimgray","dodgerblue","firebrick","floralwhite","forestgreen","fuchsia","gainsboro","ghostwhite","gold","goldenrod","gray","green","greenyellow","honeydew","hotpink","indianred","indigo","ivory","khaki","lavender","lavenderblush","lawngreen","lemonchiffon","lightblue","lightcoral","lightcyan","lightgoldenrodyellow","lightgrey","lightgreen","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategray","lightsteelblue","lightyellow","lime","limegreen","linen","magenta","maroon","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","mintcream","mistyrose","moccasin","navajowhite","navy","oldlace","olive","olivedrab","orange","orangered","orchid","palegoldenrod","palegreen","paleturquoise","palevioletred","papayawhip","peachpuff","peru","pink","plum","powderblue","purple","red","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","seashell","sienna","silver","skyblue","slateblue","slategray","snow","springgreen","steelblue","tan","teal","thistle","tomato","turquoise","violet","wheat","white","whitesmoke","yellow","yellowgreen","MapStyler","fetch","mapcss","RuleSet","highlight","onBuildingContour","radius","stl","_getFeatureStyleMapCSS","get_property","st","_getImageIconUrl","pda","p1","p2","_isSubject","_getParentObjects","tainted",":tainted",":placeholder","is_placeholder","_hasInterestingTags",":tagged",":untagged",":active","meta","@id","rgxUrl","rgxUrlJoker","fIconRgxTagName","fIconRgxTagValue","relations","reltags","NorthPointerControl","NorthPointer","SideButtonControl","btn","panel","SidePanelButton","parseHash","hash","args","formatHash","precision","ceil","log","LN2","location","lastHash","parsed","movingMap","setView","onMapMove","MyMap","dataready","mapStyler","loadedArea","invalidateSize","datalocked","editor_user","_loadData","data_min_zoom","getSouth","getNorth","getWest","getEast","getSouthWest","getNorthEast","pad","asyncToGenerator","regenerator_default","mark","_callee","wrap","_context","loadOSMData","sent","t0","stop","TileLayer","attribution","min_zoom","maxNativeZoom","max_zoom","tms","urlParts","blacklist","_p$split","_p$split2","toUpperCase","WMSTileLayer","providers","bing","react_leaflet_bing","bingkey","floormap","layers_FloorImagery","levelsList","getAllLevels","MODE_CHANGESET","background","left","bottom","textAlign","Map","preferCanvas","editable","scrollWheelZoom","doubleClickZoom","attributionControl","boxSelector","boxZoom","AttributionControl","prefix","PACKAGE","version","ScaleControl","imperial","common_NorthPointer","common_SidePanelButton","common_LevelSelector","selectedBaseImagery","_getLayer","baseImageryOpacity","selectedOverlaysImagery","ol","overlaysImageryOpacity","fi","_getFloorMapLayer","Building","Levels","Features","_mouseCoords","_mapHash","newHash","cookieHash","cookie","map_initial_zoom","map_initial_latlng","history","pushState","DomEvent","addListener","_lastZoom","alertZoom","_data$bbox","minlat","maxlat","minlon","maxlon","fitBounds","panTo","OutOfBoundsGeometryDialog","MissingLevelOutlinesDialog","missingOutlines","onIgnore","listStyle","OfficeBuildingIcon_default","AlertIcon_default","onEdit","onUseDefault","ImageryPane","backgrounds","overlays","customUrl","l2","_customImagery","newImg","defaultActiveKey","controlId","_onCustomChanged","_updateImagery","RightPanel","Imagery","FloorImageryButtons","ButtonGroup","AxisArrowIcon_default","ArrowExpandIcon_default","RotateRightIcon_default","ContentCopyIcon_default","floorImageryCopyPaste","ContentPasteIcon_default","GeometryButtons","marginLeft","IndoorEditButtons","common_GeometryButtons","where","ArrowExpandUpIcon_default","ArrowExpandDownIcon_default","Toolbar","canUndo","canRedo","canSave","nbEdits","getAmountEdits","common_FloorImageryButtons","common_IndoorEditButtons","aria-label","UndoIcon_default","RedoIcon_default","MODE_PREVIEW","MapCheckIcon_default","_onSave","ContentSaveIcon_default","leftPanelOpen","rightPanelOpen","copyingFeature","_usedImageryNames","_modes","modes","modeName","fluid","view_Header","overflowX","overflowY","borderRight","sm","md","lg","xl","view_LeftPanel","view_Toolbar","view_Map","borderLeft","view_RightPanel","ConfirmDeletion","showDialogConfirmDeletion","deleteAll","confirmed","CompleteFloorImagery","showDialogCompleteFloorImagery","OutOfBoundsGeometry","showDialogOutOfBoundsGeometry","MissingLevelOutlines","showDialogMissingLevelOutlines","_onMissingOutlineUseDefault","_onMissingOutlineGoEdit","Login","showDialogLogin","buildingId","buildingData","findFeature","_Object$entries$","_bbox","_bbox2","minX","minY","maxX","maxY","getAvailableImagery","baseImgs","locator","newUsedPresets","pId","unshift","editor_user_auth","authenticated","_timerLogin","ovl","win","_timerImagery","_checkUserLoggedIn","lockFloorImagery","theFloor","getBuildingLevels","computeDiff","findMissingLevelOutlines","imagery_used","_pushUsedPreset","newBuilding","editFeature","copyLevel","findAssociatedBuilding","isLoading","_addUsedImagery","createNewBuilding","isOverlappingEnough","createNewFloor","createNewFeature","newFeature","isRelationEditingSupported","_callee2","_context2","editFeatureGeometry","deleteFeature","_callee4","squarify","_context4","_ref4","_callee3","_context3","makeFeatureSquare","abrupt","_x","apply","t1","t2","t3","t4","t5","t6","t7","t8","mouseCoords","copyFeature","_ref5","_callee5","_context5","addFloorImagery","_x2","_x3","_ref6","_callee6","_context6","updateFloorImagery","_x4","_x5","_ref7","_callee7","_context7","_x6","_x7","_ref8","_callee8","_context8","removeFloorImagery","_x8","_x9","saveAs","Blob","stringify","_ref9","_callee9","_context9","origWidth","origHeight","_x10","_x11","_ref10","_callee10","_context10","moveFloorImagery","_x12","_x13","setFeatureTags","oldLevels","levelsComputed","undo","redo","_ref11","_callee11","_context11","sendOSMData","message","_x14","_x15","cleanUp","newlist","sendPreviewGeoJSON","collection","file","File","_cacheOsmGeojson","postMessage","command","focus","closed","open","event","prevState","_updateSelectedImage","fallback","brand","Action","FEATURE_TAGS_EDIT","FEATURE_GEOM_EDIT","FEATURE_NEW","FEATURE_GEOM_SQUARE","FLOOR_NEW","FLOOR_COPY","BUILDING_NEW","FEATURE_DELETE","FEATURE_COPY","FLOOR_IMG_ADD","FLOOR_IMG_UPDATE","FLOOR_IMG_DELETE","HistorizedManager","_actions","_lastActionId","restore","_do","noSave","LAYERS_BLACKLIST","ImageryManager","_rawLayers","_floorImagery","_isLoading","booleanIntersects","l1","best","request","end_date","endDate","Date","getTime","pastDate","setFullYear","getFullYear","incomingImages","existingIds","lastExistingImg","onceDone","approxMove","imgobj","Image","latLngToContainerPoint","nePoint","swPoint","bboxHeightPx","imgWidthPx","imgSouthWest","containerPointToLatLng","round","imgNorthEast","updatedImages","imgs","updated","selectedCenter","destinationCenter","angleCenters","distanceCenters","updtNotRotatedTopleft","updtNotRotatedTopright","updtNotRotatedBottomleft","updtNotRotatedBottomright","destinationTopcenter","updtNotRotatedTopcenter","distanceDestCenterTop","distanceUpdtCenterTop","updtRotatedTopleft","rotatePoint","updtRotatedTopright","updtRotatedBottomleft","updtRotatedBottomright","updtTopleft","updtTopright","updtBottomleft","updtBottomright","revert","_removeFloorImagery","_addFloorImagery","nextImg","currImg","_updateFloorImagery","_isObject","mergeDeep","_len","sources","_key","shift","fixPrecision","intersectionArray","arrA","arrB","common","minimal","other","el2","PresetsManager","_presetsURL","_presets","_loading","filepath","_xmlToJson","xml","_simplifyJSONPreset","_searcher","Fuse","getItems","matches","kv","flat","shouldSort","threshold","maxPatternLength","minMatchCharLength","last","PresetsManager_createForOfIteratorHelper","sub","_applyFiltering","search","recursiveFilter","gr","fTags","check","tagMatch","transformArray","variable","optional","checkgroup","cg","chunk","chunks","$","field","replaceByChunk","references","reject","parseString","geoVecEqual","epsilon","abs","geoVecAdd","geoVecSubtract","geoVecScale","mag","geoVecInterp","geoVecLength","geoVecNormalize","geoVecDot","origin","geoVecProject","idx","proj","geoOrthoNormalizedDotProduct","geoVecNormalizedDot","geoOrthoFilterDotProduct","dotp","lowerThreshold","upperThreshold","allowStraightAngles","geoOrthoCalcScore","isClosed","score","first","coord","PI","EPSILON","THRESHOLD","clonePoints","array","cloneNodes","loc","findNode","mynodes","nodeId","moveNode","nodes","sortNumberArray","IGNORED_TAGS","VectorDataManager","_cacheOsmXml","_cacheBbox","_nextId","_osmApi","OsmRequest","endpoint","oauthConsumerKey","oauth_consumer_key","oauthSecret","oauth_secret","restoreEdits","fetchMapByBbox","_res","mapJson","mapXml","_appendOsmXml","_cacheOsmJson","relation","getBaseCollection","mapjson","mapxml","mymapxml","DOMParser","parseFromString","cacheOsmNode","children","newOsmNode","toAdd","existingVersions","xmlid","oldN","xmlnode","querySelector","replaceChild","append","_listFeatureLevels","from","rounded","levelsArray","_containsWithBoundary","intersect","rawLevels","floorBuff","units","includeFloorParts","isOnContour","onContour","VectorDataManager_createForOfIteratorHelper","_this10","buildingBuff","_this11","usedLevels","hasIndoorFeatures","large","small","_booleanContains","coordAll","wider","booleanPointInPolygon","fromLevel","toLevel","_this12","featuresToCreate","getFeaturesInFloor","prevCenter","centerOfMass","bearingToAzimuth","transformTranslate","mutate","noCheckLevels","featureCacheId","_findCacheId","featureId","_this13","connectedFeatures","connectedFeaturesCacheIds","updatedFeaturesPrev","hasSharedLevels","booleanDisjoint","originalNodes","motions","nodeCount","corner","invert","calcMotion","straights","simplified","bestPoints","originalPoints","newScore","bestCoords","choice","makeSquare","ftNearest","polygonToLine","oldFtAsLine","ftNodesNearest","getNearestCoords","nearestPoint","snapToFeature","coordsList","booleanPointOnLine","cacheId","connectedFeature","ct","hasRepeatOn","hasMainTags","_cleanLevelTag","_isVerticalFeature","ranges","prevR","deleteInside","isBuilding","isLevel","current","wide","_completeGeoJSON","osmtogeojson","flatProperties","uninterestingTags","startTs","_analyzeDiff","_addDiffMedata","_auth","host","changesetId","createChangeset","newElementsIds","order","orderFeat","_transformDiffIntoElements","element","_sendElementToApi","warn","closeChangeset","_disableBeforeUnload","newNodes","newMembers","createNodeElement","createWayElement","findElementWithinOSMCollection","fetchElement","replaceTags","setNodeIdsForWay","setCoordinates","setRelationMembers","role","setTimestampToNow","deleteElement","sendElement","_this14","_setFeatureTags","_editFeatureGeometry","_enableBeforeUnload","_createNewBuilding","_createNewFloor","_copyLevel","_createNewFeature","prevAction","currAction","tagdiff","prevTags","currTags","lastMerge","_makeFeatureSquare","_deleteFeature","_copyFeature","prevFeaturesById","nextFeaturesById","nodeNegativeIds","nextNodeId","_this15","fixedNodesIds","fNext","fPrev","fixed","nId","nNext","featDeleted","nextF","members","tagsChanged","geomChanged","mbrsChanged","_cleanFeatureTags","_assignNodesToWay","availableWays","w","polyFeatures","polygon","found","wayNext","rf","polygonId","mostCommonPct","mostCommonFeat","commonNodesPct","ringFeatures","ringId","nodesAvailable","roomIndoorTagValues","dedupeLevels","nodesFromWays","ways","waysInNext","waysRoads","waysRooms","waysBuilding","nodesDoors","_connectNodesToWays","waysRoadsLvl","waysRoomsLvl","nodesFromRooms","nodeByCoords","_e2","nid","coordsStr","nodesToMerge","toKeep","tagsToTransfer","_replaceNodeInDiff","newUsedNodes","_newNodes$pop","_newNodes$pop2","toReplaceId","toReplaceData","_e3","oldId","newId","_this16","newNode","availableNodes","nodeNext","concernedNodes","concernedWays","nodesCoords","_this17","nearNodes","wayNodesIds","hasChanged","nodeStartCoords","_findCoords","nodeEndCoords","_nearNodes$j","nodeMidId","nodeMidCoords","xa","ya","xb","yb","xc","yc","Dx","Dy","pow","_this18","featureById","_step5","_iterator5","nodeName","getAttribute","wayId","_step6","_iterator6","subentry","_step7","_iterator7","_step8","_iterator8","force","lvl1","_parseLevelsFloat","lvl2","min_level","max_level","lvlsGround","lvlsRoof","lvlsUground","_step9","_iterator9","relLevel","_isLanduse","landuse","amenity","boundary","leisure","booleanContains","regexResult","regex3","regex4","tmp","onbeforeunload","App","_initI18n","_initCtrl","_initView","_initAuth","navigator","languages","src_createForOfIteratorHelper","changeLocale","userLanguage","language","loadPresets","ReactDOM","render","view_Body","getElementById","oncontextmenu","apiUrl","client_id","redirect_uri","scope","singlepage","osmAuth","_readURLParams","code","authenticate","_checkAuth","localStorage","setItem","replaceState","getItem","bootstrapToken","authWait","logout","removeItem","xhr","method","details","firstChild","childNodes","auth","username","u","pair","reduce","parts","decodeURIComponent","pathname","configTxt","editor_name"],"mappings":"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","file":"static/js/main.647c2cfb.chunk.js","sourcesContent":["/* globals L:true */\n\n/*\n * Leaflet.Snap is an extension to allow snapping of vertices in Leaflet.\n * Based on Makina Corpus implementation\n * @see https://github.com/makinacorpus/Leaflet.Snap/\n */\n\nL.Snap = {};\n\nL.Snap.isDifferentLayer = function (marker, layer) {\n    var i;\n    var n;\n    var markerId = L.stamp(marker);\n\n    if (layer.hasOwnProperty('_snapIgnore')) {\n        return false;\n    }\n\n    if (layer.hasOwnProperty('_topOwner') && marker.hasOwnProperty('_topOwner')) {\n        return layer._topOwner !== marker._topOwner;\n    }\n\n    if (layer instanceof L.Marker) {\n        return markerId !== L.stamp(layer);\n    }\n\n    if (layer.editing && layer.editing._enabled) {\n        if (layer.editing._verticesHandlers) {\n            var points = layer.editing._verticesHandlers[0]._markerGroup.getLayers();\n            for(i = 0, n = points.length; i < n; i++) {\n                if (L.stamp(points[i]) === markerId) {\n                    return false;\n                }\n            }\n        }\n\n        else if (layer.editing._resizeMarkers) {\n            for(i = 0; i < layer.editing._resizeMarkers.length; i++) {\n                var resizeMarker = layer.editing._resizeMarkers[i];\n                if (L.stamp(resizeMarker) === markerId) {\n                    return false;\n                }\n            }\n\n            if (layer.editing._moveMarker) {\n                return markerId !== L.stamp(layer.editing._moveMarker);\n            }\n\n            return true;\n        }\n    }\n\n    return true;\n};\n\nL.Snap.processGuide = function (latlng, marker, guide, snaplist, buffer) {\n    // Guide is a layer group and has no L.LayerIndexMixin (from Leaflet.LayerIndex)\n    if ((guide._layers !== undefined) && (typeof guide.searchBuffer !== 'function')) {\n        for (var id in guide._layers) {\n            if (guide._layers.hasOwnProperty(id)) {\n                L.Snap.processGuide(latlng, marker, guide._layers[id], snaplist, buffer);\n            }\n        }\n    }\n\n    // Search snaplist around mouse\n    else if (typeof guide.searchBuffer === 'function') {\n        var nearlayers = guide.searchBuffer(latlng, buffer);\n        snaplist = snaplist.concat(nearlayers.filter(function(layer) {\n            return L.Snap.isDifferentLayer(layer);\n        }));\n    }\n\n    // Make sure the marker doesn't snap to itself or an associated polyline layer\n    else if (L.Snap.isDifferentLayer(marker, guide)) {\n        snaplist.push(guide);\n    }\n};\n\nL.Snap.findClosestLayerSnap = function (map, layers, latlng, tolerance, withVertices) {\n    var closest = L.GeometryUtil.nClosestLayers(map, layers, latlng, 6);\n\n    // code to correct prefer snap to shapes (and their vertices, if withVertices is true) to gridlines and guidelines, and then guidelines to gridlines\n    var withinTolerance = [];\n    var pointsWithinTolerance = [];\n    var shapesWithinTolerance = [];\n    var guidesWithinTolerance = [];\n    for (var c=0; c<closest.length; c++) {\n        var layerInfo = closest[c];\n        if (layerInfo.distance < tolerance) {\n            withinTolerance.push(layerInfo);\n\n            if (layerInfo.layer.hasOwnProperty('_latlng')) {\n                pointsWithinTolerance.push(layerInfo);\n            }\n            else if ((! layerInfo.layer.hasOwnProperty('_gridlineGroup')) && (! layerInfo.layer.hasOwnProperty('_guidelineGroup'))) {\n                shapesWithinTolerance.push(layerInfo);\n            }\n            else if (layerInfo.layer.hasOwnProperty('_guidelineGroup')) {\n                guidesWithinTolerance.push(layerInfo);\n            }\n        }\n    }\n\n    if (withinTolerance.length === 0) {\n        return null;\n    }\n\n    var intInfo;\n    var returnLayer = withinTolerance[0].layer;\n    var returnLatLng = withinTolerance[0].latlng;\n\n    if (pointsWithinTolerance.length > 0) {\n        var pointInfo = pointsWithinTolerance[0];\n        returnLayer = pointInfo.layer;\n        returnLatLng = pointInfo.latlng;\n    }\n\n    else if (shapesWithinTolerance.length > 0) {\n        var shapeInfo = shapesWithinTolerance[0];\n        returnLayer = shapeInfo.layer;\n        returnLatLng = shapeInfo.latlng;\n\n        // this is code from L.GeometryUtil.closestSnap that will find\n        // the closest vertex of this layer to the point\n        if (withVertices && (typeof shapeInfo.layer.getLatLngs === 'function')) {\n            var vertexLatLng = L.GeometryUtil.closest(map, shapeInfo.layer, shapeInfo.latlng, true);\n\n            if (vertexLatLng) {\n                var d = L.GeometryUtil.distance(map, latlng, vertexLatLng);\n                if (d < tolerance) {\n                    returnLatLng = new L.LatLng(vertexLatLng.lat, vertexLatLng.lng);\n                }\n            }\n        }\n    }\n\n    else if (guidesWithinTolerance.length > 0) {\n        var guideInfo = guidesWithinTolerance[0];\n        var guideType = guideInfo.layer._guidelineGroup;\n\n        for (var i=0; i<withinTolerance.length; i++) {\n            if (withinTolerance[i].layer._gridlineGroup !== guideType) {\n                intInfo = L.Snap.findGuideIntersection('guide', map, latlng, [guideInfo, withinTolerance[i]]);\n                if (intInfo.distance < tolerance) {\n                    returnLatLng = intInfo.intersection;\n                    break;\n                }\n            }\n        }\n    }\n\n    else {\n        if (withinTolerance.length === 2) {\n            intInfo = L.Snap.findGuideIntersection('grid', map, latlng, withinTolerance);\n            if (intInfo.distance < tolerance) {\n                returnLatLng = intInfo.intersection;\n            }\n        }\n    }\n\n    return {\n        'layer' : returnLayer,\n        'latlng': returnLatLng\n    };\n};\n\n\n// Compatibility method to normalize Poly* objects\n// between 0.7.x and 1.0+\n// pulled from code from L.Edit.Poly in Leaflet.Draw\nL.Snap.defaultShape = function (latlngs) {\n    if (!L.Polyline._flat) { return latlngs; }\n    return L.Polyline._flat(latlngs) ? latlngs : latlngs[0];\n};\n\n// try to prefer the corner of guidelines, or the the intersection of gridlines, if we're within the tolerance of two\nL.Snap.findGuideIntersection = function (gType, map, latlng, guides) {\n    var nsi = (guides[0].layer['_' + gType + 'lineGroup'] === 'NS') ? 1 : 0;\n    var wei = (guides[0].layer['_' + gType + 'lineGroup'] === 'NS') ? 0 : 1;\n\n    var ns = L.Snap.defaultShape(guides[nsi].layer._latlngs)[0];\n    var we = L.Snap.defaultShape(guides[wei].layer._latlngs)[0];\n\n    var intersection = new L.LatLng(ns.lat, we.lng);\n    var distance = L.GeometryUtil.distance(map, intersection, latlng);\n    return {\n        'intersection': intersection,\n        'distance': distance\n    };\n};\n\nL.Snap.updateSnap = function (marker, layer, latlng) {\n    if (! marker.hasOwnProperty('_latlng')) {\n        return;\n    }\n\n    if (layer && latlng) {\n        // don't call setLatLng so that we don't fire an unnecessary 'move' event\n        marker._latlng = L.latLng(latlng);\n        marker.update();\n        if (marker.snap !== layer) {\n            marker.snap = layer;\n            if (marker._icon) {\n                L.DomUtil.addClass(marker._icon, 'marker-snapped');\n            }\n            marker.fire('snap', {layer:layer, latlng: latlng});\n        }\n    }\n    else {\n        if (marker.snap) {\n            if (marker._icon) {\n                L.DomUtil.removeClass(marker._icon, 'marker-snapped');\n            }\n            marker.fire('unsnap', {layer: marker.snap});\n        }\n\n        delete marker.snap;\n    }\n};\n\nL.Snap.snapMarker = function (e, guides, map, options, buffer) {\n    var marker = e.target;\n    var latlng = e.target._latlng || e.latlng;\n\n    if (! latlng) {\n        return;\n    }\n\n    var snaplist = [];\n    for (var i=0, n = guides.length; i < n; i++) {\n        var guide = guides[i];\n\n        // don't snap to vertices of a poly object for poly move\n        if (marker.hasOwnProperty('_owner') && (guide._leaflet_id === marker._owner)) {\n            continue;\n        }\n\n        L.Snap.processGuide(latlng, marker, guide, snaplist, buffer);\n    }\n\n    if (snaplist.length === 0) {\n        return;\n    }\n\n    var closest = L.Snap.findClosestLayerSnap(map, snaplist, latlng, options.snapDistance, options.snapVertices);\n\n    closest = closest || {layer: null, latlng: null};\n    L.Snap.updateSnap(marker, closest.layer, closest.latlng);\n\n    if (e.latlng && closest.latlng) {\n        e.latlng = closest.latlng;\n    }\n\n    return closest;\n};\n\nL.Handler.MarkerSnap = L.Handler.extend({\n    options: {\n        snapDistance: 15, // in pixels\n        snapVertices: true\n    },\n\n    initialize: function (map, marker, options) {\n        L.Handler.prototype.initialize.call(this, map);\n        this._markers = [];\n        this._guides = [];\n\n        if (arguments.length === 2) {\n            if (!(marker instanceof L.Class)) {\n                options = marker;\n                marker = null;\n            }\n        }\n\n        L.Util.setOptions(this, options || {});\n\n        if (marker) {\n            // new markers should be draggable !\n            if (!marker.dragging) marker.dragging = new L.Handler.MarkerDrag(marker);\n            marker.dragging.enable();\n            this.watchMarker(marker);\n        }\n\n        // Convert snap distance in pixels into buffer in degres, for searching around mouse\n        // It changes at each zoom change.\n        function computeBuffer() {\n            this._buffer = map.layerPointToLatLng(new L.Point(0,0)).lat -\n                           map.layerPointToLatLng(new L.Point(this.options.snapDistance, 0)).lat;\n        }\n        map.on('zoomend', computeBuffer, this);\n        map.whenReady(computeBuffer, this);\n        computeBuffer.call(this);\n    },\n\n    enable: function () {\n        this.disable();\n        for (var i=0; i<this._markers.length; i++) {\n            this.watchMarker(this._markers[i]);\n        }\n    },\n\n    disable: function () {\n        for (var i=0; i<this._markers.length; i++) {\n            this.unwatchMarker(this._markers[i]);\n        }\n    },\n\n    watchMarker: function (marker) {\n        if (this._markers.indexOf(marker) === -1)\n            this._markers.push(marker);\n        marker.on('move', this._snapMarker, this);\n        this._map.on('touchmove', this._snapMarker, this);\n    },\n\n    unwatchMarker: function (marker) {\n        marker.off('move', this._snapMarker, this);\n        this._map.off('touchmove', this._snapMarker, this);\n        delete marker.snap;\n    },\n\n    addGuideLayer: function (layer) {\n        for (var i=0, n=this._guides.length; i<n; i++)\n            if (L.stamp(layer) === L.stamp(this._guides[i]))\n                return;\n        this._guides.push(layer);\n    },\n\n    _snapMarker: function(e) {\n        var closest = L.Snap.snapMarker(e, this._guides, this._map, this.options, this._buffer);\n\n        if (e.originalEvent && e.originalEvent.clientX && closest && closest.layer && closest.latlng) {\n            var snapTouchPoint = this._map.project(closest.latlng, this._map.getZoom());\n            e.originalEvent.clientX = snapTouchPoint.x;\n            e.originalEvent.clientY = snapTouchPoint.y;\n            e.originalEvent.snapped = true;\n        }\n    }\n});\n\nL.Handler.PolylineSnap = L.Edit.Poly.extend({\n    initialize: function (map, poly, options) {\n        var that = this;\n\n        L.Edit.Poly.prototype.initialize.call(this, poly, options);\n        this._snapper = new L.Handler.MarkerSnap(map, options);\n        poly.on('remove', function() {\n            that.disable();\n        });\n    },\n\n    addGuideLayer: function (layer) {\n        this._snapper.addGuideLayer(layer);\n    },\n\n    _createMoveMarker: function (latlng, icon) {\n        var marker = L.Edit.Poly.prototype._createMoveMarker.call(this, latlng, icon);\n        this._poly.snapediting._snapper.watchMarker(marker);\n        return marker;\n    },\n\n    _initHandlers: function () {\n        this._verticesHandlers = [];\n        for (var i = 0; i < this.latlngs.length; i++) {\n            this._verticesHandlers.push(new L.Edit.PolyVerticesEditSnap(this._poly, this.latlngs[i], this.options));\n        }\n    }\n});\n\nL.Edit.PolyVerticesEditSnap = L.Edit.PolyVerticesEdit.extend({\n    _createMarker: function (latlng, index) {\n       var marker = L.Edit.PolyVerticesEdit.prototype._createMarker.call(this, latlng, index);\n\n        // Treat middle markers differently\n        var isMiddle = ((index === null) || (typeof(index) === 'undefined'));\n        if (isMiddle) {\n            // Snap middle markers, only once they were touched\n            marker.on('dragstart', function () {\n                this._poly.snapediting._snapper.watchMarker(marker);\n            }, this);\n        }\n        else {\n            this._poly.snapediting._snapper.watchMarker(marker);\n        }\n        return marker;\n    }\n});\n\nL.Handler.RectangleSnap = L.Edit.Rectangle.extend({\n    initialize: function (map, shape, options) {\n        L.Edit.Rectangle.prototype.initialize.call(this, shape, options);\n        this._snapper = new L.Handler.MarkerSnap(map, options);\n    },\n\n    _createMarker: function (latlng, icon) {\n        var marker = L.Edit.Rectangle.prototype._createMarker.call(this, latlng, icon);\n        this._shape.snapediting._snapper.watchMarker(marker);\n        return marker;\n    },\n\n    addGuideLayer: function (layer) {\n        this._snapper.addGuideLayer(layer);\n    },\n});\n\nL.Handler.CircleSnap = L.Edit.Circle.extend({\n    initialize: function (map, shape, options) {\n        L.Edit.Circle.prototype.initialize.call(this, shape, options);\n        this._snapper = new L.Handler.MarkerSnap(map, options);\n    },\n\n    _createMarker: function (latlng, icon) {\n        var marker = L.Edit.Circle.prototype._createMarker.call(this, latlng, icon);\n        this._shape.snapediting._snapper.watchMarker(marker);\n        return marker;\n    },\n\n    addGuideLayer: function (layer) {\n        this._snapper.addGuideLayer(layer);\n    },\n});\n\nL.EditToolbar.SnapEdit = L.EditToolbar.Edit.extend({\n    snapOptions: {\n        snapDistance: 15, // in pixels\n        snapVertices: true\n    },\n\n    initialize: function(map, options) {\n        L.EditToolbar.Edit.prototype.initialize.call(this, map, options);\n\n        if (options.snapOptions) {\n            L.Util.extend(this.snapOptions, options.snapOptions);\n        }\n\n        if (Array.isArray(this.snapOptions.guideLayers)) {\n            this._guideLayers = this.snapOptions.guideLayers;\n        } else if (options.guideLayers instanceof L.LayerGroup) {\n            this._guideLayers = this.snapOptions.guideLayers.getLayers();\n        } else {\n            this._guideLayers = [];\n        }\n    },\n\n    addGuideLayer: function(layer) {\n        var index = this._guideLayers.findIndex(function(guideLayer) {\n            return L.stamp(layer) === L.stamp(guideLayer);\n        });\n\n        if (index === -1) {\n            this._guideLayers.push(layer);\n            this._featureGroup.eachLayer(function(layer) {\n                if (layer.snapediting) {\n                    layer.snapediting._guides.push(layer);\n                }\n            });\n        }\n    },\n\n    removeGuideLayer: function(layer) {\n      var index = this._guideLayers.findIndex(function(guideLayer) {\n          return L.stamp(layer) === L.stamp(guideLayer);\n      });\n\n      if (index !== -1) {\n          this._guideLayers.splice(index, 1);\n          this._featureGroup.eachLayer(function(layer) {\n              if (layer.snapediting) { layer.snapediting._guides.splice(index, 1); }\n          });\n      }\n    },\n\n    clearGuideLayers: function() {\n        this._guideLayers = [];\n        this._featureGroup.eachLayer(function(layer) {\n            if (layer.snapediting) { layer.snapediting._guides = []; }\n        });\n    },\n\n    // essentially, the idea here is that we're gonna find the currently instantiated L.Edit handler, figure out its type,\n    // get rid of it, and then replace it with a snapedit instead\n    _enableLayerEdit: function(e) {\n        L.EditToolbar.Edit.prototype._enableLayerEdit.call(this, e);\n\n        var layer = e.layer || e.target || e;\n\n        if (!layer.snapediting) {\n            if (layer.hasOwnProperty('_mRadius')) {\n                if (layer.editing) {\n                    layer.editing._markerGroup.clearLayers();\n                    delete layer.editing;\n                }\n                layer.editing = layer.snapediting = new L.Handler.CircleSnap(layer._map, layer, this.snapOptions);\n            }\n\n            else if (layer.getLatLng) {\n                layer.snapediting = new L.Handler.MarkerSnap(layer._map, layer, this.snapOptions);\n            }\n\n            else {\n                if (layer.editing) {\n                    if (layer.editing.hasOwnProperty('_shape')) {\n                        layer.editing._markerGroup.clearLayers();\n                        if (layer.editing._shape instanceof L.Rectangle) {\n                            delete layer.editing;\n                            layer.editing = layer.snapediting = new L.Handler.RectangleSnap(layer._map, layer, this.snapOptions);\n                        }\n                        else if (layer.editing._shape instanceof L.FeatureGroup) {\n                            delete layer.editing;\n                            layer.editing = layer.snapediting = new L.Handler.FeatureGroupSnap(layer._map, layer, this.snapOptions);\n                        }\n                        else {\n                            delete layer.editing;\n                            layer.editing = layer.snapediting = new L.Handler.CircleSnap(layer._map, layer, this.snapOptions);\n                        }\n                    }\n                    else {\n                        layer.editing._markerGroup.clearLayers();\n                        layer.editing._verticesHandlers[0]._markerGroup.clearLayers();\n                        delete layer.editing;\n                        layer.editing = layer.snapediting = new L.Handler.PolylineSnap(layer._map, layer, this.snapOptions);\n                    }\n                }\n                else {\n                    layer.editing = layer.snapediting = new L.Handler.PolylineSnap(layer._map, layer, this.snapOptions);\n                }\n            }\n\n            for (var i = 0, n = this._guideLayers.length; i < n; i++) {\n                layer.snapediting.addGuideLayer(this._guideLayers[i]);\n            }\n        }\n\n        layer.snapediting.enable();\n    }\n});\n\nL.EditToolbar.prototype.getEditHandler = function (map, featureGroup) {\n    return new L.EditToolbar.SnapEdit(map, {\n        snapOptions: this.options.snapOptions,\n        featureGroup: featureGroup,\n        selectedPathOptions: this.options.edit.selectedPathOptions,\n        poly: this.options.poly\n    });\n};\n\nL.Draw.Feature.SnapMixin = {\n    _snap_initialize: function () {\n        this.on('enabled', this._snap_on_enabled, this);\n        this.on('disabled', this._snap_on_disabled, this);\n    },\n\n    _snap_on_enabled: function () {\n        if (!this.options.guideLayers) {\n            return;\n        }\n\n        if (! this._mouseMarker) {\n            this._map.on('layeradd', this._snap_on_enabled, this);\n            return;\n        }\n        else {\n            this._map.off('layeradd', this._snap_on_enabled, this);\n        }\n\n        if (!this._snapper) {\n            this._snapper = new L.Handler.MarkerSnap(this._map);\n            if (this.options.snapDistance) {\n                this._snapper.options.snapDistance = this.options.snapDistance;\n            }\n            if (this.options.snapVertices) {\n                this._snapper.options.snapVertices = this.options.snapVertices;\n            }\n        }\n\n        for (var i=0, n=this.options.guideLayers.length; i<n; i++) {\n            this._snapper.addGuideLayer(this.options.guideLayers[i]);\n        }\n\n        var marker = this._mouseMarker;\n        this._snapper.watchMarker(marker);\n\n        // Show marker when (snap for user feedback)\n        var icon = marker.options.icon;\n        marker.on('snap', function (e) {\n            marker.setIcon(this.options.icon);\n            marker.setOpacity(1);\n        }, this);\n\n        marker.on('unsnap', function (e) {\n            marker.setIcon(icon);\n            marker.setOpacity(0);\n        }, this);\n\n        marker.on('click', this._snap_on_click, this);\n\n        this._map.on('mousedown', this._snap_on_click, this);\n        this._map.on('touchstart', this._snap_on_click, this);\n    },\n\n    _snap_on_click: function (e) {\n        if (this._errorShown) {\n            return;\n        }\n\n        // for touch\n        if (this._markers) {\n            var markerCount = this._markers.length;\n            var marker = this._markers[markerCount - 1];\n\n            if (marker && this._mouseMarker.snap) {\n                L.DomUtil.addClass(marker._icon, 'marker-snapped');\n            }\n        }\n\n        // for shapes\n        if (this._startLatLng) {\n            var closest = this._manuallyCorrectClick(this._startLatLng);\n\n            if (closest.latlng) {\n                this._mouseMarker.setLatLng(closest.latlng);\n                this._startLatLng = closest.latlng;\n            }\n        }\n\n        // for poly vertices\n        if (this._mouseDownOrigin) {\n            var z = this._map.getZoom();\n            var mdOrigin = this._map.unproject(this._mouseDownOrigin, z);\n            var closestMDO = this._manuallyCorrectClick(mdOrigin);\n\n            if (closestMDO.latlng) {\n                this._mouseMarker.setLatLng(closestMDO.latlng);\n                this._mouseDownOrigin = this._map.project(closestMDO.latlng, z);\n            }\n\n            if (e.originalEvent) {\n                var oeOrigin = this._map.unproject([e.originalEvent.clientX, e.originalEvent.clientY], z);\n                var closestOE = this._manuallyCorrectClick(oeOrigin);\n\n                if (closestOE.latlng) {\n                    e.originalEvent = this._map.project(closestOE.latlng, z);\n                }\n            }\n        }\n    },\n\n    _manuallyCorrectClick: function (originalLatLng) {\n        var ex = {\n            'target': this._mouseMarker,\n            'latlng': originalLatLng\n        };\n\n        if (! this._mouseMarker) {\n            return {\n                'latlng': null\n            };\n        }\n\n        var buffer = 0;\n        if (this.hasOwnProperty('_snapper') && this._snapper.hasOwnProperty('_buffer')) {\n            buffer = this._snapper._buffer;\n        }\n\n        return L.Snap.snapMarker(ex, this.options.guideLayers || [], this._map, this.options, buffer);\n    },\n\n    _snap_on_disabled: function () {\n        delete this._snapper;\n    },\n};\n\nL.Draw.Feature.include(L.Draw.Feature.SnapMixin);\nL.Draw.Feature.addInitHook('_snap_initialize');\n","/**\n * Style\n * One style property.\n * \n * Based on Overpass Turbo implementation\n * @see https://github.com/tyrasd/overpass-turbo\n */\nvar MapCSSStyle = function() {this.__init__()};\n\nMapCSSStyle.prototype = {\n\tmerged: false,\n\tedited: false,\n\t//sublayer: 5, // TODO: commented out. see RuleSet.js\n\t//interactive: true, // TODO: commented out. see RuleSet.js\n\tproperties: [],\n\tstyleType: 'Style',\n\tevals: null,\n\n    __init__: function() {\n    \tthis.evals = {};\n    },\n\n\tdrawn: function() {\n\t\treturn false;\n\t},\n\n\thas: function(k) {\n\t\treturn this.properties.indexOf(k)>-1;\n\t},\n\t\n\tmergeWith: function(additional) {\n\t\tfor (var prop in this.properties) {\n\t\t\tif (additional[prop]) {\n\t\t\t\tthis[prop]=additional[prop];\n\t\t\t}\n\t\t}\n\t\tthis.merged=true;\n\t},\n\t\n\tsetPropertyFromString: function(k,v,isEval) {\n\t\tthis.edited=true;\n\t\tif (isEval) { this.evals[k]=v; return; }\n\n\t\tif (typeof(this[k])==='boolean') {\n\t\t\tv=Boolean(v);\n\t\t} else if (typeof(this[k])==='number') {\n\t\t\tv=Number(v);\n\t\t} else if (this[k] && this[k].constructor===Array) {\n\t\t\tv = v.split(',').map(function(a) { return Number(a); });\n\t\t}\n\t\tthis[k]=v; \n\t\treturn true;\n\t},\n\n\trunEvals: function(tags) {\n\t    // helper object for eval() properties\n\t\t// eslint-disable-next-line\n        var eval_functions = {\n          // mapcss 0.2 eval function\n          tag: function(t) {return tags[t];},\n          prop: function(p) {}, // todo\n          cond: function(expr, i, e) {if (expr) return i; else return e;},\n          any: function() {for (var i=0;i<arguments.length;i++) if(arguments[i]) return arguments[i];},\n          max: Math.max,\n          min: Math.min,\n          // JOSM eval functions ?\n        };\n\t\tfor (var k in this.evals) {\n\t\t\ttry {\n\t\t\t\t// eslint-disable-next-line\n\t\t\t  this.setPropertyFromString(k, eval(\"with (tags) with (eval_functions) {\"+this.evals[k]+\"}\"),false);\n\t\t\t} catch(e) {}\n\t\t}\n\t},\n\n\ttoString: function() {\n\t\tvar str = '';\n\t\tfor (var k in this.properties) {\n\t\t\tif (this.hasOwnProperty(k)) { str+=k+\"=\"+this[k]+\"; \"; }\n\t\t}\n\t\treturn str;\n\t}\n};\n\nexport default MapCSSStyle;\n","// Generated by i18nline.\r\nimport I18n from 'i18nline';\r\n\r\nI18n.supportedLocales = ['de','en','fr','it'];\nI18n.defaultLocale = 'en';\r\n\r\nI18n.import = locale => {\r\n\t// we use a switch here so the import statements are statically\r\n\t// analyzable. the use of import() will make build tools generate\r\n\t// separate bundles which are downloaded on-demand.\r\n\tswitch (locale) {\r\n\t\tcase 'de': return import(/* webpackChunkName: 'i18n.de' */ './de.json');\n\t\tcase 'en': return import(/* webpackChunkName: 'i18n.en' */ './en.json');\n\t\tcase 'fr': return import(/* webpackChunkName: 'i18n.fr' */ './fr.json');\n\t\tcase 'it': return import(/* webpackChunkName: 'i18n.it' */ './it.json');\r\n\t\tdefault: return import(/* webpackChunkName: 'i18n.default' */ './default.json');\r\n\t}\r\n};\r\n\r\nif ((typeof module === 'object') && module.hot) {\r\n\tmodule.hot.accept('./de.json', I18n.reload('de'));\n\tmodule.hot.accept('./en.json', I18n.reload('en'));\n\tmodule.hot.accept('./fr.json', I18n.reload('fr'));\n\tmodule.hot.accept('./it.json', I18n.reload('it'));\r\n\tmodule.hot.accept('./default.json', I18n.reload('default'));\r\n}\r\n\r\nexport default I18n;\r\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Button from 'react-bootstrap/Button';\nimport I18n from '../../config/locales/ui';\nimport Modal from 'react-bootstrap/Modal';\n\n/**\n * Complete floor imagery dialog asks user to set level information before leaving the floor imagery mode.\n */\nclass CompleteFloorImageryDialog extends Component {\n\trender() {\n\t\treturn <Modal show={this.props.show} onHide={this.props.onClose} size=\"lg\">\n\t\t\t<Modal.Header closeButton>\n\t\t\t\t<Modal.Title>{I18n.t(\"Add level information\")}</Modal.Title>\n\t\t\t</Modal.Header>\n\t\t\t<Modal.Body>{I18n.t(\"To make your floor plans appear correctly when editing indoors, please make sure you set on which level they should show up on the left panel.\")}</Modal.Body>\n\t\t\t<Modal.Footer>\n\t\t\t\t<Button variant=\"secondary\" onClick={this.props.onClose}>\n\t\t\t\t\t{I18n.t(\"OK\")}\n\t\t\t\t</Button>\n\t\t\t</Modal.Footer>\n\t\t</Modal>;\n\t}\n}\n\nexport default CompleteFloorImageryDialog;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Button from 'react-bootstrap/Button';\nimport Close from 'mdi-react/CloseIcon';\nimport Delete from 'mdi-react/DeleteIcon';\nimport DeleteCircleOutline from 'mdi-react/DeleteCircleOutlineIcon';\nimport I18n from '../../config/locales/ui';\nimport Modal from 'react-bootstrap/Modal';\n\n/**\n * Confirm deletion dialog asks user if he wants to delete everything inside level/building\n */\nclass ConfirmDeletionDialog extends Component {\n\trender() {\n\t\treturn <Modal show={this.props.show} onHide={this.props.onCancel} size=\"lg\">\n\t\t\t<Modal.Header closeButton>\n\t\t\t\t<Modal.Title>{I18n.t(\"Confirm delete of %{f}\", { f: this.props.name })}</Modal.Title>\n\t\t\t</Modal.Header>\n\t\t\t<Modal.Body>{I18n.t(\"Are you sure you want to delete this feature ? You can either cancel this operation, delete only the contour of the feature, or delete the feature and everything inside (quite dangerous).\")}</Modal.Body>\n\t\t\t<Modal.Footer>\n\t\t\t\t<Button variant=\"secondary\" onClick={this.props.onCancel}>\n\t\t\t\t\t<Close /> {I18n.t(\"Cancel\")}\n\t\t\t\t</Button>\n\t\t\t\t<Button variant=\"warning\" onClick={() => this.props.onConfirm(false)}>\n\t\t\t\t\t<DeleteCircleOutline /> {I18n.t(\"Delete only contour\")}\n\t\t\t\t</Button>\n\t\t\t\t<Button variant=\"danger\" onClick={() => this.props.onConfirm(true)}>\n\t\t\t\t\t<Delete /> {I18n.t(\"Delete everything\")}\n\t\t\t\t</Button>\n\t\t\t</Modal.Footer>\n\t\t</Modal>;\n\t}\n}\n\nexport default ConfirmDeletionDialog;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport 'array-flat-polyfill';\nimport L from 'leaflet';\nimport { Path, withLeaflet } from 'react-leaflet';\nimport 'leaflet-editable';\nimport 'leaflet-draw';\nimport './leaflet.snap';\nimport 'leaflet-geometryutil';\nimport 'leaflet-textpath';\nimport 'leaflet-polylinedecorator';\nimport area from '@turf/area';\nimport deepEqual from 'fast-deep-equal';\nimport GeoJSONValidation from 'geojson-validation';\nimport Mousetrap from 'mousetrap';\nimport pointOnFeature from '@turf/point-on-feature';\nimport pointToLineDistance from '@turf/point-to-line-distance';\nimport PubSub from 'pubsub-js';\n\nconst GEOJSON_PRECISION = 8;\nconst GUIDE_LINES_ANGLE_KEY = \"a\";\nconst ICON_SIZE = 20;\nconst CONVEYING_TO_IMG = { \"yes\": \"fwd\", \"forward\": \"fwd\", \"backward\": \"bwd\", \"reversible\": \"both\" };\n\n// Default styles\nconst stShadow = { color: \"purple\", fillColor: \"black\", opacity: 0.5, fillOpacity: 0.2, zIndex: -10 };\nconst existingIcons = {};\n\n\n// Fix for excluding selected geometry from snapping guides\nconst MyMarkerSnap = L.Handler.MarkerSnap.extend({\n\tremoveGuideGeoJSON: function(geom) {\n\t\tvar index = this._guides.findIndex(function(guideLayer) {\n\t\t\tif(!guideLayer.toGeoJSON) { return false; }\n\t\t\telse {\n\t\t\t\tconst gj = guideLayer.toGeoJSON(GEOJSON_PRECISION);\n\t\t\t\treturn (gj.type === \"Feature\" && deepEqual(gj.geometry, geom)) || (gj.type === \"FeatureCollection\" && gj.features.length === 1 && deepEqual(gj.features[0].geometry, geom));\n\t\t\t}\n\t\t});\n\n\t\tif (index !== -1) {\n\t\t\tthis._guides.splice(index, 1);\n\t\t}\n\t}\n});\n\n// Fix for limiting tolerance around marker click\nconst MyCircleMarker = L.CircleMarker.extend({\n\t_containsPoint: function (p) {\n\t\treturn p.distanceTo(this._point) <= this._radius;\n\t}\n});\n\n// Icon handling load errors\nconst MyIcon = L.Icon.extend({\n\t_createImg: function (src, el) {\n\t\tel = el || document.createElement('img');\n\t\tel.src = src;\n\t\tel.onerror = () => {\n\t\t\twindow.UNUSABLE_ICONS.add(el.src);\n\t\t\tel.style.display='none';\n\t\t};\n\t\treturn el;\n\t}\n});\n\n\n/**\n * Editable layer is an extension of GeoJSON layer in order to manage editing of geometries.\n * Editing is handled by leaflet-editable extension. The role of this class is to make React work nicely with this extension.\n *\n * @property {function} [onFeatureClick] Handler for click on one feature, one parameter is given : the GeoJSON feature which was clicked\n * @property {Object} [shadowData] GeoJSON features which are shown in background but you cannot interact with\n * @property {Object} [selection] GeoJSON feature which should be shown as selected at start\n * @property {MapStyler} [styler] The map styler\n */\nclass EditableLayer extends Path {\n\t/** Drawing polygon **/\n\tstatic DRAW_POLYGON = 1;\n\t/** Drawing marker **/\n\tstatic DRAW_MARKER = 2;\n\t/** Drawing line **/\n\tstatic DRAW_LINE = 3;\n\n\t/** Matching between preset types and drawing types **/\n\tstatic PRESET_TO_DRAW = { \"node\": EditableLayer.DRAW_MARKER, \"way\": EditableLayer.DRAW_LINE, \"closedway\": EditableLayer.DRAW_POLYGON };\n\n\tcreateLeafletElement(props) {\n\t\t// Add some defaults\n\t\tconst thatStyler = props.styler.getFeatureStyle.bind(props.styler);\n\t\tconst myprops = Object.assign({}, {\n\t\t\tpointToLayer: (feature, latlng) => {\n\t\t\t\tconst marker = new MyCircleMarker(latlng, thatStyler(feature));\n\t\t\t\tmarker.on(\"click\", () => props.onFeatureClick(feature));\n\t\t\t\treturn marker;\n\t\t\t},\n\t\t\tonFeatureClick: (() => {}),\n\t\t\tstyle: thatStyler,\n\t\t\tonEachFeature: (f, l) => {\n\t\t\t\tif(l instanceof L.Polyline && !(l instanceof L.Polygon)) {\n\t\t\t\t\tthis._setLayerStyle(l, props, false, true);\n\t\t\t\t}\n\t\t\t}\n\t\t}, props);\n\n\t\t// Create snap handler\n\t\tthis._createSnapHandler(props.leaflet.map);\n\n\t\t// Create the GeoJSON layer\n\t\tconst lGeojson = this._populateLayer(new L.GeoJSON(null, this.getOptions(myprops)), myprops);\n\n\t\treturn lGeojson;\n\t}\n\n\tcomponentDidMount() {\n\t\tsuper.componentDidMount();\n\t\tconst map = this.props.leaflet.map;\n\n\t\t/*\n\t\t * Bind various events for whole layer lifetime\n\t\t */\n\n\t\t// Call for forcing complete layer redraw\n\t\tPubSub.subscribe(\"map.editablelayer.redraw\", (msg, data) => {\n\t\t\tthis.updateLeafletElement({}, this.props);\n\t\t});\n\n\t\t// Disable mouseover event when dragging a vertex\n\t\tmap.on(\"editable:vertex:dragstart\", e => {\n\t\t\tthis.leafletElement.eachLayer(l => l.off(\"mouseover\"));\n\t\t\tthis._snapFollowMarker(e.vertex);\n\n\t\t\t// Hide direction icons for line if any\n\t\t\tif(\n\t\t\t\tthis._linesDirIcons\n\t\t\t\t&& e.layer && e.layer.feature && e.layer.feature.id\n\t\t\t\t&& this._linesDirIcons[e.layer.feature.id]\n\t\t\t\t&& map.hasLayer(this._linesDirIcons[e.layer.feature.id])\n\t\t\t) {\n\t\t\t\tmap.removeLayer(this._linesDirIcons[e.layer.feature.id]);\n\t\t\t\tdelete this._linesDirIcons[e.layer.feature.id];\n\t\t\t}\n\n\t\t\t// Hide cursor move\n\t\t\tif(this._markerMove) {\n\t\t\t\tthis._markerMove.setOpacity(0);\n\t\t\t}\n\t\t});\n\n\t\t// Save new geometry when vertex is released\n\t\tmap.on(\"editable:vertex:dragend\", e => {\n\t\t\tthis.snap.unwatchMarker(e.vertex);\n\t\t\tPubSub.publish(\"body.edit.feature\", { feature: e.layer.toGeoJSON(GEOJSON_PRECISION) });\n\t\t});\n\n\t\t// Click on a node vertex (for selection)\n\t\tif(this.props.allowVertexClick) {\n\t\t\tmap.on(\"editable:vertex:rawclick\", e => {\n\t\t\t\tconst node = window.vectorDataManager.findNodeFeature(e.latlng);\n\n\t\t\t\t// If node is a feature, select it\n\t\t\t\tif(node && (!node.properties.own || !node.properties.own.utilityNode)) {\n\t\t\t\t\tPubSub.publish(\"body.select.feature\", { feature: node });\n\t\t\t\t\te.cancel();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Click on a node vertex (for deletion)\n\t\tmap.on(\"editable:vertex:deleted\", e => {\n\t\t\tPubSub.publish(\"body.edit.feature\", { feature: e.layer.toGeoJSON(GEOJSON_PRECISION) });\n\t\t});\n\n\t\t// When user starts creating new feature\n\t\tmap.on(\"editable:drawing:start\", e => {\n\t\t\tmap.on(\"mousemove\", this._followMouse, this);\n\t\t});\n\n\t\t// When user click to add a vertex on a new feature\n\t\tmap.on(\"editable:drawing:click\", e => {\n\t\t\tconst latlng = this.snapMarker.getLatLng();\n\t\t\te.latlng.lat = latlng.lat;\n\t\t\te.latlng.lng = latlng.lng;\n\t\t});\n\n\n\t\t// Force update to make sure everything is set up correctly\n\t\tPubSub.publishSync(\"map.editablelayer.redraw\");\n\t}\n\n\tcomponentWillUnmount() {\n\t\tsuper.componentWillUnmount();\n\n\t\t// Clean up all bind events\n\t\tconst map = this.props.leaflet.map;\n\t\tPubSub.unsubscribe(\"map.editablelayer.redraw\");\n\t\tmap.off(\"editable:vertex:dragstart\");\n\t\tmap.off(\"editable:vertex:dragend\");\n\t\tmap.off(\"editable:vertex:rawclick\");\n\t\tmap.off(\"editable:vertex:deleted\");\n\t\tmap.off(\"editable:drawing:start\");\n\t\tmap.off(\"editable:drawing:end\");\n\t\tmap.off(\"editable:drawing:click\");\n\t\tmap.off(\"mousemove\");\n\n\t\tif(this.snapMarker) {\n\t\t\tthis.snapMarker.off(\"snap\");\n\t\t\tthis.snapMarker.off(\"unsnap\");\n\t\t}\n\n\t\tthis._cleanLinesDirIcons(this.props.leaflet.map);\n\t\tthis.updateLeafletElement(this.props, { leaflet: this.props.leaflet });\n\t}\n\n\tupdateLeafletElement(fromProps, toProps) {\n\t\tlet updateIcons = false;\n\t\tlet enableSnap = false;\n\t\tlet disableSnap = false;\n\n\t\t// Add style property according to styler\n\t\tif(!toProps.style && toProps.styler) {\n\t\t\ttoProps = Object.assign({}, toProps, { style: toProps.styler.getFeatureStyle.bind(toProps.styler) });\n\t\t}\n\n\t\t//Style\n\t\tif(fromProps.styler !== toProps.styler) {\n\t\t\tthis.setStyle(toProps.style);\n\t\t\tupdateIcons = true;\n\t\t}\n\t\telse {\n\t\t\tthis.setStyleIfChanged(fromProps, toProps);\n\t\t}\n\n\t\t//Data\n\t\tif(\n\t\t\tfromProps.data !== toProps.data\n\t\t\t&& !deepEqual(fromProps.data, toProps.data)\n\t\t) {\n\t\t\tthis.leafletElement.clearLayers();\n\t\t\tif(toProps.data && (fromProps.draw === toProps.draw || !fromProps.draw || toProps.draw)) {\n\t\t\t\tthis._populateLayer(this.leafletElement, toProps);\n\t\t\t}\n\t\t\tupdateIcons = true;\n\t\t}\n\n\t\t// Start editor if necessary\n\t\tif(fromProps.draw !== toProps.draw) {\n\t\t\tif(!fromProps.draw && toProps.draw) {\n\t\t\t\tenableSnap = true;\n\t\t\t\tthis._startDrawing(toProps);\n\t\t\t}\n\t\t\telse if(fromProps.draw && !toProps.draw) {\n\t\t\t\tthis._stopDrawing(toProps);\n\t\t\t\tdisableSnap = true;\n\t\t\t\tthis.leafletElement.clearLayers();\n\n\t\t\t\tif(toProps.data) {\n\t\t\t\t\tthis._populateLayer(this.leafletElement, toProps);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Restore editor\n\t\tif(fromProps.selection === toProps.selection && toProps.selection !== null) {\n\t\t\tenableSnap = true;\n\t\t\tthis.leafletElement.eachLayer(l => {\n\t\t\t\tif(l.feature) {\n\t\t\t\t\tif(toProps.selection.id === l.feature.id) {\n\t\t\t\t\t\tif(l.enableEdit) {\n\t\t\t\t\t\t\tl.enableEdit();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif(fromProps.selection !== toProps.selection) {\n\t\t\tif(!fromProps.selection && toProps.selection) {\n\t\t\t\tenableSnap = true;\n\t\t\t}\n\n\t\t\tif(fromProps.selection && !toProps.selection) {\n\t\t\t\tdisableSnap = true;\n\t\t\t}\n\t\t}\n\n\t\t// Change selection if updated\n\t\tif(fromProps.selection !== toProps.selection) {\n\t\t\t// Remove move cursor from previous selection\n\t\t\tif(this._markerMove && fromProps.selection) {\n\t\t\t\tthis.leafletElement.removeLayer(this._markerMove);\n\n\t\t\t\tif(fromProps.selection.id.startsWith(\"node/\")) {\n\t\t\t\t\tdisableSnap = true;\n\t\t\t\t\tthis._markerMove.off(\"moveend mousemove move\");\n\t\t\t\t\tthis.snap.unwatchMarker(this._markerMove);\n\t\t\t\t}\n\n\t\t\t\tdelete this._markerMove;\n\t\t\t}\n\n\t\t\t// Update icons when selection changes\n\t\t\tif(toProps.selection !== fromProps.selection && this._featureIcons) {\n\t\t\t\tif(fromProps.selection && toProps.data) {\n\t\t\t\t\tconst f = toProps.data.features.find(d => d.id === fromProps.selection.id);\n\t\t\t\t\tif(f) {\n\t\t\t\t\t\tthis._addIconForLayer(\n\t\t\t\t\t\t\tf,\n\t\t\t\t\t\t\ttoProps.styler.getFeatureStyle(f).iconImage\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif(toProps.selection) {\n\t\t\t\t\tconst iconToRemove = this._featureIcons.getLayers().find(l => l.options && l.options.fid === toProps.selection.id);\n\t\t\t\t\tif(iconToRemove) {\n\t\t\t\t\t\tthis._featureIcons.removeLayer(iconToRemove);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Select against non-nodes features\n\t\t\tif(\n\t\t\t\t(toProps.selection && (!toProps.selection.id.startsWith(\"node/\") || !toProps.selection.properties.own.utilityNode))\n\t\t\t\t|| (fromProps.selection && (!fromProps.selection.id.startsWith(\"node/\") || !fromProps.selection.properties.own.utilityNode))\n\t\t\t) {\n\t\t\t\tlet newLayer = null;\n\n\t\t\t\tthis.leafletElement.eachLayer(l => {\n\t\t\t\t\tif(l.feature) {\n\t\t\t\t\t\tif(fromProps.selection && fromProps.selection.id === l.feature.id) {\n\t\t\t\t\t\t\tthis._setLayerStyle(l, toProps, false);\n\n\t\t\t\t\t\t\tif(l.disableEdit && l.editEnabled()) {\n\t\t\t\t\t\t\t\tl.disableEdit();\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif(this.snap && this.snap.addGuideLayer) {\n\t\t\t\t\t\t\t\tthis.snap.addGuideLayer(new L.GeoJSON(l.feature.geometry));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif(toProps.selection && toProps.selection.id === l.feature.id) {\n\t\t\t\t\t\t\tthis._setLayerStyle(l, toProps, true);\n\n\t\t\t\t\t\t\tif(l.enableEdit) {\n\t\t\t\t\t\t\t\tl.enableEdit();\n\t\t\t\t\t\t\t\tnewLayer = l;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif(this.snap && this.snap.removeGuideGeoJSON) {\n\t\t\t\t\t\t\t\tthis.snap.removeGuideGeoJSON(l.feature.geometry);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\t// Allow dragging feature\n\t\t\t\tif(newLayer && toProps.allowFeatureDrag) {\n\t\t\t\t\tlet prevpos = null;\n\t\t\t\t\tlet center = newLayer.getCenter();\n\n\t\t\t\t\t// If geometry is a line, don't put center at center to allow creating middle vertex\n\t\t\t\t\tif(newLayer.feature.geometry.type === \"LineString\") {\n\t\t\t\t\t\tconst c1 = newLayer.feature.geometry.coordinates[0];\n\t\t\t\t\t\tconst c2 = newLayer.feature.geometry.coordinates[newLayer.feature.geometry.coordinates.length-1];\n\t\t\t\t\t\tcenter = new L.LatLng(\n\t\t\t\t\t\t\t(c1[1]*2 + c2[1]) / 3,\n\t\t\t\t\t\t\t(c1[0]*2 + c2[0]) / 3\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis._markerMove = this._createMarkerMove(center);\n\t\t\t\t\tthis.leafletElement.addLayer(this._markerMove);\n\n\t\t\t\t\tthis._markerMove.on(\"move\", e => {\n\t\t\t\t\t\t// Compute vector movement\n\t\t\t\t\t\tif(!prevpos) { prevpos = e.target.dragging._draggable._startPos; }\n\t\t\t\t\t\tconst newpos = e.target.dragging._draggable._newPos;\n\t\t\t\t\t\tconst move = newpos.subtract(prevpos);\n\t\t\t\t\t\tprevpos = newpos;\n\n\t\t\t\t\t\t// Move temporarily the Leaflet layer\n\t\t\t\t\t\tconst movell = ll => (\n\t\t\t\t\t\t\t(ll.lat) ?\n\t\t\t\t\t\t\t\ttoProps.leaflet.map.layerPointToLatLng(toProps.leaflet.map.latLngToLayerPoint(ll).add(move))\n\t\t\t\t\t\t\t\t: ll.map(movell)\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tnewLayer.setLatLngs(movell(newLayer.getLatLngs()));\n\n\t\t\t\t\t\t// Hide direction icons if any\n\t\t\t\t\t\tif(\n\t\t\t\t\t\t\tthis._linesDirIcons\n\t\t\t\t\t\t\t&& newLayer.feature.id\n\t\t\t\t\t\t\t&& this._linesDirIcons[newLayer.feature.id]\n\t\t\t\t\t\t\t&& toProps.leaflet.map.hasLayer(this._linesDirIcons[newLayer.feature.id])\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\ttoProps.leaflet.map.removeLayer(this._linesDirIcons[newLayer.feature.id]);\n\t\t\t\t\t\t\tdelete this._linesDirIcons[newLayer.feature.id];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Hide vertex editing\n\t\t\t\t\t\tif(newLayer.disableEdit) {\n\t\t\t\t\t\t\tnewLayer.disableEdit();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tthis._markerMove.on(\"moveend\", e => {\n\t\t\t\t\t\t// Make move change permanent\n\t\t\t\t\t\tconst newfeature = Object.assign({}, toProps.selection);\n\t\t\t\t\t\tnewfeature.geometry = newLayer.toGeoJSON(GEOJSON_PRECISION).geometry;\n\t\t\t\t\t\tPubSub.publish(\"body.edit.feature\", { feature: newfeature });\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Select against nodes\n\t\t\tif(\n\t\t\t\t(toProps.selection && toProps.selection.id.startsWith(\"node/\"))\n\t\t\t\t|| (fromProps.selection && fromProps.selection.id.startsWith(\"node/\"))\n\t\t\t) {\n\t\t\t\tconst newCoords = (toProps.selection && toProps.selection.id.startsWith(\"node/\")) ?\n\t\t\t\t\tnew L.LatLng(toProps.selection.geometry.coordinates[1], toProps.selection.geometry.coordinates[0])\n\t\t\t\t\t: null;\n\n\t\t\t\t// Selecting/unselecting a door = update door lines\n\t\t\t\tif((fromProps.selection && this._isADoorWithWidth(fromProps.selection)) || (toProps.selection && this._isADoorWithWidth(toProps.selection))) {\n\t\t\t\t\tthis._addDoorLines(this.leafletElement, toProps.leaflet.map);\n\t\t\t\t}\n\n\t\t\t\t// Show marker for moving\n\t\t\t\tif(toProps.selection && toProps.selection.id.startsWith(\"node/\") && !toProps.selection.properties.own.utilityNode) {\n\t\t\t\t\tthis._markerMove = this._createMarkerMove(newCoords);\n\t\t\t\t\tthis.leafletElement.addLayer(this._markerMove);\n\t\t\t\t\tenableSnap = this._markerMove;\n\t\t\t\t\tlet layersConnected = [];\n\n\t\t\t\t\t// Handle case where we're moving routing graph features\n\t\t\t\t\tif(toProps.keepRoutingGraphConnected) {\n\t\t\t\t\t\tif(this._isRoutingGraphRelated(toProps.selection)) {\n\t\t\t\t\t\t\t// Find features we should keep connected\n\t\t\t\t\t\t\tlayersConnected = this.leafletElement\n\t\t\t\t\t\t\t.getLayers()\n\t\t\t\t\t\t\t.filter(l => (\n\t\t\t\t\t\t\t\tl.feature\n// \t\t\t\t\t\t\t\t&& l.feature.properties.own && l.feature.properties.own.levels && l.feature.properties.own.levels.includes(this.props.level)\n\t\t\t\t\t\t\t\t&& this._containsCoordinates(l.feature.geometry, toProps.selection.geometry.coordinates)\n\t\t\t\t\t\t\t))\n\t\t\t\t\t\t\t// And keep track of nodes in these lines we should move\n\t\t\t\t\t\t\t.map(l => {\n\t\t\t\t\t\t\t\treturn [ l, this._findNodesToUpdate(l, L.GeoJSON.coordsToLatLng(toProps.selection.geometry.coordinates)) ];\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis._markerMove.on(\"moveend\", e => {\n\t\t\t\t\t\tconst newfeature = Object.assign({}, toProps.selection);\n\t\t\t\t\t\tnewfeature.geometry = this._markerMove.toGeoJSON(GEOJSON_PRECISION).geometry;\n\t\t\t\t\t\tPubSub.publish(\"body.edit.feature\", { feature: newfeature });\n\n\t\t\t\t\t\t// Also update connected layers if any\n\t\t\t\t\t\tconst newll = this._fixLatLng(this._markerMove.getLatLng());\n\t\t\t\t\t\tthis._updateConnectedLayers(layersConnected, newll);\n\t\t\t\t\t\tlayersConnected.forEach(lc => {\n\t\t\t\t\t\t\tif(lc[0].feature) {\n\t\t\t\t\t\t\t\tconst newfeature = Object.assign({}, lc[0].feature);\n\t\t\t\t\t\t\t\tnewfeature.geometry = lc[0].toGeoJSON(GEOJSON_PRECISION).geometry;\n\t\t\t\t\t\t\t\tPubSub.publish(\"body.edit.feature\", { feature: newfeature, select: false });\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\n\t\t\t\t\t// Remove door line if any\n\t\t\t\t\tif(toProps.selection && this._isADoorWithWidth(toProps.selection) && this._doorLines) {\n\t\t\t\t\t\tthis._markerMove.on(\"movestart\", e => {\n\t\t\t\t\t\t\tconst mylatlng = L.GeoJSON.coordsToLatLng(toProps.selection.geometry.coordinates);\n\t\t\t\t\t\t\tthis._doorLines\n\t\t\t\t\t\t\t.getLayers()\n\t\t\t\t\t\t\t.filter(l => (\n\t\t\t\t\t\t\t\tl.getLatLngs().find(ll => ll.equals(mylatlng))\n\t\t\t\t\t\t\t))\n\t\t\t\t\t\t\t.forEach(l => {\n\t\t\t\t\t\t\t\tthis._doorLines.removeLayer(l);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tlet foundMarker = null;\n\t\t\t\t\tthis.leafletElement.eachLayer(n => {\n\t\t\t\t\t\tif(n.feature && n.feature.id === toProps.selection.id) {\n\t\t\t\t\t\t\tfoundMarker = n;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\t// Sync move between this._markerMove and current feature\n\t\t\t\t\tif(foundMarker) {\n\t\t\t\t\t\tthis._markerMove.on(\"mousemove\", e => {\n\t\t\t\t\t\t\tconst newll = this._fixLatLng(e.latlng);\n\t\t\t\t\t\t\tfoundMarker.setLatLng(newll);\n\t\t\t\t\t\t\tthis._updateConnectedLayers(layersConnected, newll);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Updates on current selection\n\t\tif(toProps.selection && fromProps.selection === toProps.selection) {\n\t\t\t// Update door lines when tags are edited\n\t\t\tif(this._isADoorWithWidth(toProps.selection)) {\n\t\t\t\tthis._addDoorLines(this.leafletElement, toProps.leaflet.map);\n\t\t\t}\n\n\t\t\tif(toProps.selection.geometry.type === \"LineString\") {\n\t\t\t\tconst l = this.leafletElement.getLayers().find(l => l.feature && l.feature.id === toProps.selection.id);\n\t\t\t\tif(l) {\n\t\t\t\t\tthis._setLayerStyle(l, toProps, true, true);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis._sortFeaturesZIndex(this.leafletElement);\n\n\t\t// Display icons\n\t\tif(updateIcons) {\n\t\t\tthis._addIcons(this.leafletElement);\n\t\t}\n\n\t\t// Enable/disable snapping\n\t\tif(enableSnap) {\n\t\t\tthis._enableSnapping(toProps.leaflet.map);\n\t\t\tif(typeof enableSnap === \"object\") {\n\t\t\t\tthis._snapFollowMarker(enableSnap);\n\t\t\t}\n\t\t}\n\t\tif(disableSnap && !enableSnap) {\n\t\t\tthis._disableSnapping();\n\t\t}\n\t}\n\n\t/**\n\t * Sort features by size and type\n\t * @private\n\t */\n\t_sortFeaturesZIndex(layer) {\n\t\t// First, polygons\n\t\tconst polygons = [];\n\t\tlayer.eachLayer(l => {\n\t\t\tif(l.feature && l instanceof L.Polygon) {\n\t\t\t\tif(!l.ownArea) {\n\t\t\t\t\tl._ownArea = area(l.feature);\n\t\t\t\t}\n\t\t\t\tpolygons.push(l);\n\t\t\t}\n\t\t});\n\n\t\tpolygons.sort((a, b) => {\n\t\t\tconst zA = a.options && a.options.zIndex && !isNaN(parseInt(a.options.zIndex)) ? parseInt(a.options.zIndex) : 0;\n\t\t\tconst zB = b.options && b.options.zIndex && !isNaN(parseInt(b.options.zIndex)) ? parseInt(b.options.zIndex) : 0;\n\t\t\treturn zA !== zB ? zB - zA : a._ownArea - b._ownArea;\n\t\t});\n\t\tpolygons.forEach(p => p.bringToBack());\n\n\t\t// Then, lines\n\t\tlayer.eachLayer(l => {\n\t\t\tif(l.feature && l instanceof L.Polyline && !(l instanceof L.Polygon)) {\n\t\t\t\tl.bringToFront();\n\t\t\t}\n\t\t});\n\n\t\t// Last, nodes\n\t\tlayer.eachLayer(l => {\n\t\t\tif(l.feature && l.feature.id.startsWith(\"node/\")) {\n\t\t\t\tl.bringToFront();\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * @private\n\t */\n\t_cleanLinesDirIcons(map) {\n\t\tif(this._linesDirIcons) {\n\t\t\tObject.values(this._linesDirIcons).forEach(ldl => {\n\t\t\t\tif(map.hasLayer(ldl)) {\n\t\t\t\t\tmap.removeLayer(ldl);\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis._linesDirIcons = {};\n\t\t}\n\t}\n\n\t/**\n\t * Load content into the leaflet layer\n\t * @private\n\t */\n\t_populateLayer(layer, props) {\n\t\tconst map = props.leaflet.map;\n\n\t\t// Clean up linestring icons if any\n\t\tthis._cleanLinesDirIcons(map);\n\n\t\t/*\n\t\t * Add shadow data\n\t\t */\n\t\tif(props.shadowData) {\n\t\t\tconst lShadow = new L.GeoJSON(props.shadowData, { style: stShadow });\n\t\t\tlShadow.eachLayer(l => {\n\t\t\t\tl.own = { shadow: true };\n\t\t\t\tlayer.addLayer(l);\n\t\t\t});\n\t\t}\n\n\t\t// Add editable data\n\t\tlayer.addData(props.data);\n\n\t\t// Display lines for doors with width set\n\t\tthis._addDoorLines(layer, map);\n\n\t\t// Events specific for each layer\n\t\tconst guidesForSnap = [];\n\t\tlayer.eachLayer(l => {\n\t\t\tif((!l.own || !l.own.shadow) && l.enableEdit && l.feature) {\n\t\t\t\tif(!props.draw) {\n\t\t\t\t\t// Handle click\n\t\t\t\t\tl.on(\"click\", e => {\n\t\t\t\t\t\tprops.onFeatureClick(l.feature);\n\t\t\t\t\t\tthis._setLayerStyle(l, props, true);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// Restore selection\n\t\t\t\tif(props.selection && props.selection.id === l.feature.id) {\n\t\t\t\t\tthis._setLayerStyle(l, props, true);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Add layer as guide for snapping\n\t\t\tif(l.toGeoJSON && l.feature && (!props.selection || l.feature.id !== props.selection.id)) {\n\t\t\t\tguidesForSnap.push(new L.GeoJSON(l.feature.geometry));\n\t\t\t}\n\t\t});\n\n\t\t// Reload list of layers which should be used as guides for snapping\n\t\tthis._snapReplaceGuideLayers(guidesForSnap);\n\n\t\treturn layer;\n\t}\n\n\t/**\n\t * Start editor if draw options is present in props.\n\t * @private\n\t */\n\t_startDrawing(props, layer) {\n\t\tlayer = layer || this.leafletElement;\n\t\tif(!this._guideAngleShow) { this._guideAngleShow = false; }\n\n\t\tif(props.draw && layer) {\n\t\t\tconst map = props.leaflet.map;\n\n\t\t\t// Disable click event on features\n\t\t\tlayer.eachLayer(l => l.off(\"click\"));\n\n\t\t\t// Start drawing appropriate type\n\t\t\tif(props.draw === EditableLayer.DRAW_POLYGON) {\n\t\t\t\tmap.editTools.startPolygon();\n\t\t\t}\n\t\t\telse if(props.draw === EditableLayer.DRAW_LINE) {\n\t\t\t\tmap.editTools.startPolyline();\n\t\t\t}\n\t\t\telse if(props.draw === EditableLayer.DRAW_MARKER) {\n\t\t\t\tmap.editTools.startMarker();\n\t\t\t}\n\n\t\t\t// Show helpers for right angles\n\t\t\tif([EditableLayer.DRAW_LINE, EditableLayer.DRAW_POLYGON].includes(props.draw)) {\n\t\t\t\tmap.on(\"editable:vertex:new\", evt => {\n\t\t\t\t\tlet coords = evt.layer.getLatLngs();\n\n\t\t\t\t\tif(coords && coords.length > 0 && Array.isArray(coords[0])) {\n\t\t\t\t\t\tcoords = coords[0];\n\t\t\t\t\t}\n\n\t\t\t\t\t// Create lines\n\t\t\t\t\tif(coords && coords.length > 1) {\n\t\t\t\t\t\t// Clear previous guide lines if any\n\t\t\t\t\t\tif(this._guideAngleLines) {\n\t\t\t\t\t\t\tif(this.snap) {\n\t\t\t\t\t\t\t\tthis._guideAngleLines.eachLayer(l => this.snap.removeGuideGeoJSON(l.toGeoJSON(GEOJSON_PRECISION)));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tthis._guideAngleLines.clearLayers();\n\n\t\t\t\t\t\t\tif(map.hasLayer(this._guideAngleLines)) {\n\t\t\t\t\t\t\t\tmap.removeLayer(this._guideAngleLines);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tthis._guideAngleLines = L.layerGroup();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Project coordinates forward and on two sides\n\t\t\t\t\t\tconst last1 = coords[coords.length-1];\n\t\t\t\t\t\tconst last2 = coords[coords.length-2];\n\t\t\t\t\t\tconst angle = L.GeometryUtil.bearing(last1, last2);\n\t\t\t\t\t\tconst projDist = 500;\n\n\t\t\t\t\t\tconst extPerp1 = L.GeometryUtil.destination(last1, angle + 90, projDist);\n\t\t\t\t\t\tconst extPerp2 = L.GeometryUtil.destination(last1, angle - 90, projDist);\n\t\t\t\t\t\tconst extForward = L.GeometryUtil.destination(last1, L.GeometryUtil.bearing(last2, last1), projDist);\n\n\t\t\t\t\t\t// Create lines and make them visible\n\t\t\t\t\t\tconst stGuideAngle = { color: \"purple\", dashArray: \"4\", weight: 2, lineCap: \"butt\" };\n\t\t\t\t\t\tconst linePerp = L.polyline([extPerp1, extPerp2], stGuideAngle);\n\t\t\t\t\t\tconst lineForward = L.polyline([last1, extForward], stGuideAngle);\n\n\t\t\t\t\t\tthis._guideAngleLines.addLayer(linePerp);\n\t\t\t\t\t\tthis._guideAngleLines.addLayer(lineForward);\n\t\t\t\t\t\tthis._lastGuideAngleLinesGeojson = [\n\t\t\t\t\t\t\tlinePerp.toGeoJSON(GEOJSON_PRECISION),\n\t\t\t\t\t\t\tlineForward.toGeoJSON(GEOJSON_PRECISION)\n\t\t\t\t\t\t];\n\n\t\t\t\t\t\tif(this._guideAngleShow && !map.hasLayer(this._guideAngleLines)) {\n\t\t\t\t\t\t\tmap.addLayer(this._guideAngleLines);\n\t\t\t\t\t\t\tthis._lastGuideAngleLinesGeojson.forEach(l => this.snap.addGuideLayer(new L.GeoJSON(l)));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tMousetrap.unbind(GUIDE_LINES_ANGLE_KEY);\n\t\t\t\t\t\tMousetrap.bind(GUIDE_LINES_ANGLE_KEY, () => {\n\t\t\t\t\t\t\tif(!map.hasLayer(this._guideAngleLines)) {\n\t\t\t\t\t\t\t\tmap.addLayer(this._guideAngleLines);\n\t\t\t\t\t\t\t\tthis._lastGuideAngleLinesGeojson.forEach(l => this.snap.addGuideLayer(new L.GeoJSON(l)));\n\t\t\t\t\t\t\t\tthis._guideAngleShow = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tmap.removeLayer(this._guideAngleLines);\n\t\t\t\t\t\t\t\tthis._lastGuideAngleLinesGeojson.forEach(l => this.snap.removeGuideGeoJSON(l));\n\t\t\t\t\t\t\t\tthis._guideAngleShow = false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, \"keypress\");\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tMousetrap.bind(GUIDE_LINES_ANGLE_KEY, () => {\n\t\t\t\t\t\t\tthis._guideAngleShow = !this._guideAngleShow;\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Handler when shape is created\n\t\t\tmap.on(\"editable:drawing:end\", e => {\n\t\t\t\tmap.removeLayer(e.layer);\n\t\t\t\tmap.off(\"editable:drawing:end\");\n\t\t\t\tmap.off(\"editable:vertex:new\");\n\t\t\t\tMousetrap.unbind(GUIDE_LINES_ANGLE_KEY);\n\t\t\t\tmap.off(\"mousemove\", this._followMouse, this);\n\t\t\t\tthis.snapMarker.remove();\n\n\t\t\t\t// Check geometry validity\n\t\t\t\ttry {\n\t\t\t\t\tconst f = e.layer.toGeoJSON(GEOJSON_PRECISION);\n\n\t\t\t\t\tif(GeoJSONValidation.valid(f)) {\n\t\t\t\t\t\tPubSub.publish(\"body.draw.done\", { feature: f });\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tPubSub.publish(\"body.draw.cancel\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch(e) {\n\t\t\t\t\tPubSub.publish(\"body.draw.cancel\");\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * End current editing\n\t * @private\n\t */\n\t_stopDrawing(props) {\n\t\tconst map = props.leaflet.map;\n\n\t\t// Replace done event to cancel drawing\n\t\tmap.off(\"editable:drawing:end\");\n\t\tmap.off(\"editable:vertex:new\");\n\t\tMousetrap.unbind(GUIDE_LINES_ANGLE_KEY);\n\t\tmap.off(\"mousemove\", this._followMouse, this);\n\t\tthis.snapMarker.remove();\n\n\t\tmap.on(\"editable:drawing:end\", e => {\n\t\t\tmap.removeLayer(e.layer);\n\t\t});\n\n\t\t// Hide eventual guide layers\n\t\tif(this._guideAngleLines && map.hasLayer(this._guideAngleLines)) {\n\t\t\tmap.removeLayer(this._guideAngleLines);\n\t\t}\n\n\t\t// Stop actual drawing\n\t\tmap.editTools.stopDrawing();\n\t}\n\n\t/**\n\t * @private\n\t */\n\t_followMouse(e) {\n\t\tthis.snapMarker.setLatLng(e.latlng);\n\t}\n\n\t/**\n\t * Create snap handler\n\t */\n\t_createSnapHandler(map) {\n\t\tthis.snap = new MyMarkerSnap(map, { snapDistance: 20 });\n\n\t\tthis.snapMarker = new L.Marker(map.getCenter(), {\n\t\t\ticon: map.editTools.createVertexIcon({className: 'leaflet-div-icon leaflet-drawing-icon'}),\n\t\t\topacity: 1,\n\t\t\tzIndexOffset: 1000\n\t\t});\n\n\t\t// Events\n\t\tthis.snapMarker.on('snap', e => {\n\t\t\tthis.snapMarker.addTo(map);\n\t\t});\n\t\tthis.snapMarker.on('unsnap', e => {\n\t\t\tthis.snapMarker.remove();\n\t\t\tmap.removeLayer(this.snapMarker);\n\t\t});\n\n\t\tthis._snapEnabled = false;\n\t}\n\n\t/**\n\t * Enable snapping on editing\n\t * @private\n\t */\n\t_enableSnapping(map) {\n\t\tif(!this._snapEnabled) {\n\t\t\t// Create snapping tools\n\t\t\tthis._snapEnabled = true;\n\t\t\tthis._snapFollowMarker(this.snapMarker);\n\t\t}\n\t}\n\n\t/**\n\t * Set the marker to use for snapping\n\t * @private\n\t */\n\t_snapFollowMarker(marker) {\n\t\tthis.snap.enable();\n\t\tthis.snap._markers = [];\n\t\tthis.snap.watchMarker(marker);\n\t}\n\n\t/**\n\t * Change list of layers to use as guides for snapping\n\t * @private\n\t */\n\t_snapReplaceGuideLayers(guides) {\n\t\tthis.snap._guides = [];\n\t\tguides.forEach(g => this.snap.addGuideLayer(g));\n\t}\n\n\t/**\n\t * Disable snapping\n\t * @private\n\t */\n\t_disableSnapping() {\n\t\tif(this._snapEnabled) {\n\t\t\tif(this.snap) {\n\t\t\t\tthis.snap.disable();\n\t\t\t}\n\n\t\t\tthis._snapEnabled = false;\n\t\t}\n\t}\n\n\t/**\n\t * Is this feature a door with width set ?\n\t * @private\n\t */\n\t_isADoorWithWidth(feature) {\n\t\treturn feature && feature.id && feature.id.startsWith(\"node/\") && feature.properties.tags\n\t\t\t&& (feature.properties.tags.door ||feature.properties.tags.entrance)\n\t\t\t&& feature.properties.tags.width && !isNaN(parseFloat(feature.properties.tags.width))\n\t\t\t&& parseFloat(feature.properties.tags.width) > 0;\n\t}\n\n\t/**\n\t * Add the symbol for showing door width\n\t * @private\n\t */\n\t_addDoorLines(layer, map) {\n\t\tif(this._doorLines && layer.hasLayer(this._doorLines)) {\n\t\t\tlayer.removeLayer(this._doorLines);\n\t\t}\n\n\t\tthis._doorLines = L.layerGroup();\n\n\t\tconst doorLayers = layer.getLayers().filter(l => l.getLatLng && this._isADoorWithWidth(l.feature));\n\t\tconst potentialLayers = layer\n\t\t\t.getLayers()\n\t\t\t.filter(l => l.feature && l.feature.properties.tags && this._isRoomLikeFeature(l.feature))\n\t\t\t.map(l => {\n\t\t\t\tswitch(l.feature.geometry.type) {\n\t\t\t\t\tcase \"LineString\":\n\t\t\t\t\t\tl._asLine = l.feature;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"Polygon\":\n\t\t\t\t\t\tl._asLine = { type: \"Feature\", geometry: { type: \"LineString\", coordinates: l.feature.geometry.coordinates[0] } };\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tl._asLine = null;\n\t\t\t\t}\n\n\t\t\t\treturn l;\n\t\t\t})\n\t\t\t.filter(l => l._asLine);\n\n\t\tdoorLayers.forEach(l => {\n\t\t\tconst width = parseFloat(l.feature.properties.tags.width);\n\n\t\t\tif(width > 0) {\n\t\t\t\tconst doorlatlng = l.getLatLng();\n\t\t\t\tconst doorFeature = { type: \"Feature\", geometry: { type: \"Point\", coordinates: L.GeoJSON.latLngToCoords(doorlatlng) } };\n\n\t\t\t\tlet closestLayer = null;\n\t\t\t\tlet closestDistance = null;\n\n\t\t\t\tfor(let i=0; i < potentialLayers.length; i++) {\n\t\t\t\t\tconst potentialLayer = potentialLayers[i];\n\t\t\t\t\tif(potentialLayer._asLine && potentialLayer.getBounds().contains(doorlatlng)) {\n\t\t\t\t\t\tconst dist = pointToLineDistance(doorFeature, potentialLayer._asLine, { unit: \"meters\" });\n\n\t\t\t\t\t\tif(dist < 0.1 && (!closestDistance || dist < closestDistance)) {\n\t\t\t\t\t\t\tclosestLayer = potentialLayer;\n\t\t\t\t\t\t\tclosestDistance = dist;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Find correct segment\n\t\t\t\tif(closestLayer) {\n\t\t\t\t\tlet latlngs = closestLayer.getLatLngs();\n\n\t\t\t\t\tif(latlngs.length > 0) {\n\t\t\t\t\t\tif(!Array.isArray(latlngs[0])) {\n\t\t\t\t\t\t\tlatlngs = [ latlngs ];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet foundSegment = null;\n\n\t\t\t\t\t\tfor(let r=0; r < latlngs.length; r++) {\n\t\t\t\t\t\t\tconst ring = latlngs[r];\n\t\t\t\t\t\t\tif(!ring[0].equals(ring[ring.length-1])) {\n\t\t\t\t\t\t\t\tring.push(ring[0]);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tfor(let i=0; i < ring.length - 1; i++) {\n\t\t\t\t\t\t\t\tif(\n\t\t\t\t\t\t\t\t\tring[i].equals(doorlatlng) || ring[i+1].equals(doorlatlng)\n\t\t\t\t\t\t\t\t\t|| window.vectorDataManager._isOnLine(ring[i].lng, ring[i].lat, doorlatlng.lng, doorlatlng.lat, ring[i+1].lng, ring[i+1].lat, 1e-6)\n\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\tfoundSegment = [ ring[i], ring[i+1] ];\n\n\t\t\t\t\t\t\t\t\tif(ring[i].equals(doorlatlng)) {\n\t\t\t\t\t\t\t\t\t\tfoundSegment[0] = i > 0 ? ring[i-1] : ring[ring.length-2];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif(ring[i+1].equals(doorlatlng)) {\n\t\t\t\t\t\t\t\t\t\tfoundSegment[1] = i+2 <= ring.length-1 ? ring[i+2] : ring[1];\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif(foundSegment) { break; }\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif(foundSegment) {\n\t\t\t\t\t\t\tconst extlatlng1 = L.GeometryUtil.destination(\n\t\t\t\t\t\t\t\tdoorlatlng,\n\t\t\t\t\t\t\t\tL.GeometryUtil.bearing(doorlatlng, foundSegment[0]),\n\t\t\t\t\t\t\t\twidth / 2\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tconst extlatlng2 = L.GeometryUtil.destination(\n\t\t\t\t\t\t\t\tdoorlatlng,\n\t\t\t\t\t\t\t\tL.GeometryUtil.bearing(doorlatlng, foundSegment[1]),\n\t\t\t\t\t\t\t\twidth / 2\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tconst line = L.polyline([extlatlng1, doorlatlng, extlatlng2], { color: \"green\", weight: 12, lineCap: \"butt\" });\n\t\t\t\t\t\t\tline._isDoorLine = true;\n\t\t\t\t\t\t\tline.on(\"click\", () => PubSub.publish(\"body.select.feature\", { feature: l.feature }));\n\t\t\t\t\t\t\tthis._doorLines.addLayer(line);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tlayer.addLayer(this._doorLines);\n\t}\n\n\t/**\n\t * Add icons of features\n\t * @private\n\t */\n\t_addIcons(layer) {\n\t\tif(this._featureIcons && layer.hasLayer(this._featureIcons)) {\n\t\t\tlayer.removeLayer(this._featureIcons);\n\t\t}\n\n\t\tthis._featureIcons = L.layerGroup();\n\n\t\tconst featuresWithIcons = layer.getLayers().filter(l => l.options && l.options.iconImage && (!this.props.selection || l.feature.id !== this.props.selection.id));\n\n\t\tfeaturesWithIcons.forEach(l => this._addIconForLayer(\n\t\t\tl.feature,\n\t\t\tl.options.iconImage\n\t\t));\n\t\tlayer.addLayer(this._featureIcons);\n\t}\n\n\t/**\n\t * Add icon for one specific layer\n\t * @private\n\t */\n\t_addIconForLayer(f, iconImage) {\n\t\tif(f && iconImage) {\n\t\t\tconst iconUrl = window.EDITOR_URL + \"img/icons/\"+iconImage;\n\n\t\t\tif(!window.UNUSABLE_ICONS.has(iconUrl)) {\n\t\t\t\tlet icon = existingIcons[iconUrl];\n\n\t\t\t\tif(!icon) {\n\t\t\t\t\ticon = new MyIcon({\n\t\t\t\t\t\ticonUrl: iconUrl,\n\t\t\t\t\t\ticonSize: [ICON_SIZE, ICON_SIZE],\n\t\t\t\t\t\ticonAnchor: [ICON_SIZE/2, ICON_SIZE/2]\n\t\t\t\t\t});\n\t\t\t\t\texistingIcons[iconUrl] = icon;\n\t\t\t\t}\n\n\t\t\t\tthis._featureIcons.addLayer(new L.marker(L.GeoJSON.coordsToLatLng(pointOnFeature(f).geometry.coordinates), { icon: icon, interactive: false, fid: f.id }));\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Remove overlay texts\n\t * @private\n\t */\n\t_removeTexts(layer) {\n\t\tdocument.querySelectorAll('text[clearable=true]').forEach(function(txt){\n\t\t\ttxt.parentNode.removeChild(txt);\n\t\t})\n;\n\t}\n\n\t/**\n\t * Change layer style\n\t * @private\n\t */\n\t_setLayerStyle(l, props, selected, noSetStyle) {\n\t\tconst style = props.style || props.styler.getFeatureStyle.bind(props.styler);\n\t\tlet myStyle;\n\n\t\tif(!noSetStyle) {\n\t\t\tmyStyle = style(l.feature, selected);\n\t\t\tl.setStyle(myStyle);\n\t\t}\n\n\t\t// Show way direction\n\t\tif(l.feature && l.feature.geometry.type === \"LineString\") {\n\t\t\tconst direction = this._getDirection(l.feature);\n\t\t\tconst tags = l.feature.properties.tags;\n\n\t\t\tif(this._linesDirIcons && this._linesDirIcons[l.feature.id] && props.leaflet.map.hasLayer(this._linesDirIcons[l.feature.id])) {\n\t\t\t\tprops.leaflet.map.removeLayer(this._linesDirIcons[l.feature.id]);\n\t\t\t}\n\n\t\t\tif(tags.incline || tags.conveying || tags.oneway) {\n\t\t\t\tif(!myStyle) {\n\t\t\t\t\tmyStyle = style(l.feature, selected) || {};\n\t\t\t\t}\n\n\t\t\t\tl.setText(null);\n\n\t\t\t\tif((tags.highway !== \"steps\" && (tags.incline || tags.conveying)) || (tags.highway === \"steps\" && tags.incline)) {\n\t\t\t\t\t// Find bearing\n\t\t\t\t\tlet reverse = false;\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst coords = l.getLatLngs();\n\t\t\t\t\t\treverse = L.GeometryUtil.bearing(coords[0], coords[coords.length-1]) < 0;\n\t\t\t\t\t}\n\t\t\t\t\tcatch(e) {}\n\n\t\t\t\t\t// Compute icon name\n\t\t\t\t\tlet iconImage = \"direction_\";\n\n\t\t\t\t\tlet incline = tags.incline ? ((tags.incline === \"down\" || tags.incline.startsWith(\"-\")) ? \"down\" : \"up\") : \"front\";\n\t\t\t\t\tlet conveying = CONVEYING_TO_IMG[tags.conveying] ? CONVEYING_TO_IMG[tags.conveying] : \"fwd\";\n\n\t\t\t\t\tif(reverse && conveying !== \"both\") { conveying = conveying === \"fwd\" ? \"bwd\" : \"fwd\"; }\n\t\t\t\t\tif(\n\t\t\t\t\t\tincline !== \"front\"\n\t\t\t\t\t\t&& (\n\t\t\t\t\t\t\t(!reverse && conveying === \"bwd\")\n\t\t\t\t\t\t\t|| (reverse && (conveying === \"fwd\" || conveying === \"both\"))\n\t\t\t\t\t\t)\n\t\t\t\t\t) {\n\t\t\t\t\t\tincline = incline === \"up\" ? \"down\" : \"up\";\n\t\t\t\t\t}\n\n\t\t\t\t\ticonImage += incline + \"_\" + conveying + \"_\";\n\n\t\t\t\t\t// Gender\n\t\t\t\t\ticonImage += parseInt(l.feature.id.slice(-1)) % 2 === 0 ? \"m\" : \"f\";\n\t\t\t\t\ticonImage += \".png\";\n\n\t\t\t\t\tconst iconUrl = window.EDITOR_URL + \"img/icons/\"+iconImage;\n\n\t\t\t\t\tif(!window.UNUSABLE_ICONS.has(iconUrl)) {\n\t\t\t\t\t\tlet icon = existingIcons[iconUrl];\n\n\t\t\t\t\t\tif(!icon) {\n\t\t\t\t\t\t\ticon = new MyIcon({\n\t\t\t\t\t\t\t\ticonUrl: iconUrl,\n\t\t\t\t\t\t\t\ticonSize: [28,28],\n\t\t\t\t\t\t\t\ticonAnchor: [14,14]\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\texistingIcons[iconUrl] = icon;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif(!this._linesDirIcons) {\n\t\t\t\t\t\t\tthis._linesDirIcons = {};\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst polyDec = L.polylineDecorator(\n\t\t\t\t\t\t\tl,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tpatterns: [\n\t\t\t\t\t\t\t\t\t{ offset: 50, repeat: 100, symbol: L.Symbol.marker({rotate: true, angleCorrection: reverse ? 90 : -90, markerOptions: { icon: icon }})}\n\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tthis._linesDirIcons[l.feature.id] = polyDec;\n\t\t\t\t\t\tpolyDec.addTo(props.leaflet.map);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if(tags.oneway) {\n\t\t\t\t\tl.setText(\n\t\t\t\t\t\t\"      \",\n\t\t\t\t\t\t{ offset: 5, repeat: true, attributes: { fill: '#333', clearable: true, \"font-size\": myStyle.width || 15 }, orientation: direction === 1 ? undefined : \"flip\" }\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if(selected) {\n\t\t\t\tl.setText(null);\n\t\t\t\tl.setText(\n\t\t\t\t\t'        ',\n\t\t\t\t\t{ offset: 5, center: true, attributes: { fill: '#333', clearable: true }}\n\t\t\t\t);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tl.setText(null);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Get way direction (-1 = backward, 0 = both ways, 1 = forward)\n\t * @private\n\t */\n\t_getDirection(f) {\n\t\tif(f.properties && f.properties.tags) {\n\t\t\tif(f.properties.tags.oneway) {\n\t\t\t\tswitch(f.properties.tags.oneway) {\n\t\t\t\t\tcase \"yes\":\n\t\t\t\t\t\treturn 1;\n\t\t\t\t\tcase \"-1\":\n\t\t\t\t\t\treturn -1;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\treturn 0;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if(f.properties.tags.incline) {\n\t\t\t\tswitch(f.properties.tags.incline) {\n\t\t\t\t\tcase \"up\":\n\t\t\t\t\t\treturn 1;\n\t\t\t\t\tcase \"down\":\n\t\t\t\t\t\treturn -1;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\treturn 0;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn 0;\n\t}\n\n\t/**\n\t * New marker for moving features\n\t * @private\n\t */\n\t_createMarkerMove(coords) {\n\t\treturn new L.Marker(coords, { draggable: true, icon: new L.Icon({ iconUrl: 'img/move.png', iconSize: [32,32], iconAnchor: [16,16]}) });\n\t}\n\n\t/**\n\t * Check if an object looks like a wall/room/area\n\t * @private\n\t */\n\t_isRoomLikeFeature(feature) {\n\t\tconst tags = {\n\t\t\t\"indoor\": \"area|room|corridor|wall\",\n\t\t\t\"highway\": \"elevator\"\n\t\t};\n\t\treturn feature.id && (feature.id.startsWith(\"way/\") || feature.id.startsWith(\"relation/\")) && this._hasTags(feature, tags);\n\t}\n\n\t/**\n\t * Check if a feature is a part of the routing graph\n\t * @private\n\t */\n\t_isRoutingGraphRelated(feature) {\n\t\tconst tags = {\n\t\t\t\"door\": \"*\",\n\t\t\t\"highway\": \"*\",\n\t\t\t\"entrance\": \"*\"\n\t\t};\n\n\t\treturn this._hasTags(feature, tags);\n\t}\n\n\t_hasTags(feature, tags) {\n\t\tfor(const e of Object.entries(tags)) {\n\t\t\tconst [k,v] = e;\n\t\t\tif(\n\t\t\t\tfeature.properties.tags[k] === v\n\t\t\t\t|| (v === \"*\" && feature.properties.tags[k] !== undefined)\n\t\t\t\t|| v.split(\"|\").includes(feature.properties.tags[k])\n\t\t\t) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Does this GeoJSON geometry contains a certain coordinates\n\t * @private\n\t */\n\t_containsCoordinates(geom, coords) {\n\t\tswitch(geom.type) {\n\t\t\tcase \"Point\":\n\t\t\t\treturn deepEqual(geom.coordinates, coords);\n\t\t\tcase \"LineString\":\n\t\t\t\treturn geom.coordinates.findIndex(c => deepEqual(c, coords)) !== -1;\n\t\t\tcase \"Polygon\":\n\t\t\t\tfor(let i=0; i < geom.coordinates.length; i++) {\n\t\t\t\t\tif(geom.coordinates[i].findIndex(c => deepEqual(c, coords)) !== -1) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\tdefault:\n\t\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Find which nodes should be updated to follow one vertex\n\t * @private\n\t */\n\t_findNodesToUpdate(layer, latlng) {\n\t\tlet toUpdate = null;\n\n\t\tif(layer.getLatLngs) {\n\t\t\tconst latlngs = layer.getLatLngs();\n\n\t\t\t// Simple array\n\t\t\tif(latlngs[0].lat) {\n\t\t\t\ttoUpdate = [];\n\t\t\t\tlatlngs.forEach((c,i) => {\n\t\t\t\t\tif(c.lat === latlng.lat && c.lng === latlng.lng) {\n\t\t\t\t\t\ttoUpdate.push(i);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\t// Nested array\n\t\t\telse {\n\t\t\t\ttoUpdate = {};\n\t\t\t\tlatlngs.forEach((cr,i) => {\n\t\t\t\t\tcr.forEach((c,j) => {\n\t\t\t\t\t\tif(c.lat === latlng.lat && c.lng === latlng.lng) {\n\t\t\t\t\t\t\tif(!toUpdate[i]) { toUpdate[i] = []; }\n\t\t\t\t\t\t\ttoUpdate[i].push(j);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\ttoUpdate = layer.getLatLng().equals(latlng);\n\t\t}\n\n\t\treturn toUpdate;\n\t}\n\n\t/**\n\t * Change coordinates in connected layers\n\t * @private\n\t */\n\t_updateConnectedLayers(layersConnected, newll) {\n\t\tlayersConnected.forEach(lc => {\n\t\t\tif(lc[0].setLatLngs) {\n\t\t\t\tconst newlatlngs = lc[0].getLatLngs();\n\n\t\t\t\tif(Array.isArray(lc[1])) {\n\t\t\t\t\tlc[1].forEach(tu => { newlatlngs[tu] = newll; });\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tObject.entries(lc[1]).forEach(e => {\n\t\t\t\t\t\te[1].forEach(tu => { newlatlngs[e[0]][tu] = newll; });\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tlc[0].setLatLngs(newlatlngs);\n\t\t\t}\n\t\t\telse if(lc[0].setLatLng && lc[1] === true) {\n\t\t\t\tlc[0].setLatLng(newll);\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Set coordinates precision of LatLng\n\t * @private\n\t */\n\t_fixLatLng(ll) {\n\t\treturn new L.LatLng(ll.lat.toFixed(GEOJSON_PRECISION), ll.lng.toFixed(GEOJSON_PRECISION));\n\t}\n}\n\nexport default withLeaflet(EditableLayer);\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Body from '../Body';\nimport Breadcrumb from 'react-bootstrap/Breadcrumb';\nimport I18n from '../../config/locales/ui';\nimport PubSub from 'pubsub-js';\n\n/**\n * Navigator is the breadcrumb allowing to travel through building hierarchy.\n */\nclass Navigator extends Component {\n\trender() {\n\t\treturn <Breadcrumb className=\"justify-content-center bc-dense breadcrumb-arrow\">\n\t\t\t<Breadcrumb.Item\n\t\t\t\tonClick={e => {\n\t\t\t\t\tPubSub.publishSync(\"body.mode.set\", { mode: Body.MODE_BUILDING });\n\t\t\t\t\tPubSub.publish(\"body.unselect.feature\");\n\t\t\t\t}}\n\t\t\t\tactive={this.props.mode === Body.MODE_BUILDING && !this.props.building}\n\t\t\t\ttitle={I18n.t(\"Go back to building selection\")}\n\t\t\t>\n\t\t\t\t{I18n.t(\"All buildings\")}\n\t\t\t</Breadcrumb.Item>\n\n\t\t\t{this.props.building &&\n\t\t\t\t<Breadcrumb.Item\n\t\t\t\t\tonClick={e => PubSub.publish(\"body.mode.set\", { mode: Body.MODE_BUILDING })}\n\t\t\t\t\tactive={this.props.mode === Body.MODE_BUILDING}\n\t\t\t\t\ttitle={I18n.t(\"Edit this single building\")}\n\t\t\t\t>\n\t\t\t\t\t{Body.GetFeatureName(this.props.building)}\n\t\t\t\t</Breadcrumb.Item>\n\t\t\t}\n\n\t\t\t{[Body.MODE_LEVELS, Body.MODE_FEATURES].includes(this.props.mode) &&\n\t\t\t\t<Breadcrumb.Item\n\t\t\t\t\tonClick={e => PubSub.publish(\"body.unselect.feature\")}\n\t\t\t\t\tactive={true}\n\t\t\t\t>\n\t\t\t\t\t{this.props.mode === Body.MODE_LEVELS ?\n\t\t\t\t\t\tI18n.t(\"Levels structure (level %{lvl})\", { lvl: this.props.level })\n\t\t\t\t\t\t: I18n.t(\"Features (level %{lvl})\", { lvl: this.props.level })}\n\t\t\t\t</Breadcrumb.Item>\n\t\t\t}\n\t\t</Breadcrumb>;\n\t}\n}\n\nexport default Navigator;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport deepEqual from 'fast-deep-equal';\nimport Form from 'react-bootstrap/Form';\nimport ListGroup from 'react-bootstrap/ListGroup';\n\n/**\n * A select list takes a list of entries, and shows a list of selectable entries.\n * @property {Object[]} data The list of entries (each entry must have at least a \"label\" property). Entries could have a boolean \"selected\" property for setting their initial state.\n * @property {string} type Type of list (single, multi, oneshot)\n * @property {function} onChange Function called when one entry is clicked. First parameter is an array of currently selected items\n */\nclass SelectList extends Component {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.state = {\n\t\t\tselectedEntries: new Set()\n\t\t};\n\t}\n\n\t/**\n\t * Event handler when one entry is selected\n\t * @private\n\t */\n\t_onEntrySelected(id) {\n\t\t//If single mode, replace selected entry\n\t\tif(this.props.type === \"single\" || this.props.type === \"oneshot\") {\n\t\t\tthis.setState({ selectedEntries: new Set([ id ]) });\n\t\t\tthis.props.onChange([ this.props.data[id] ]);\n\t\t}\n\t\t//If multi mode, toggle value in selection set\n\t\telse {\n\t\t\tconst newSelection = new Set(this.state.selectedEntries);\n\n\t\t\tif(newSelection.has(id)) {\n\t\t\t\tnewSelection.delete(id);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tnewSelection.add(id);\n\t\t\t}\n\n\t\t\tthis.setState({ selectedEntries: newSelection });\n\n\t\t\t//Convert set into selected data array\n\t\t\tconst result = [];\n\t\t\tfor(const v of newSelection.values()) {\n\t\t\t\tresult.push(this.props.data[v]);\n\t\t\t}\n\t\t\tthis.props.onChange(result);\n\t\t}\n\t}\n\n\t/**\n\t * Change selection if necessary\n\t * @private\n\t */\n\t_reloadSelection(fromProps) {\n\t\tif(!fromProps || !deepEqual(fromProps.data, this.props.data)) {\n\t\t\t//Set default selection at first load\n\t\t\tconst selectionIds = [];\n\t\t\tthis.props.data.forEach((e, i) => {\n\t\t\t\tif(e.selected) {\n\t\t\t\t\tselectionIds.push(i);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif(selectionIds.length > 0) {\n\t\t\t\tthis.setState({ selectedEntries: new Set(selectionIds) });\n\t\t\t}\n\t\t}\n\t}\n\n\trender() {\n\t\treturn <ListGroup style={this.props.style}>\n\t\t\t{this.props.data.map((entry, id) => {\n\t\t\t\tconst checked = this.state.selectedEntries.has(id);\n\t\t\t\tconst changeHandler = () => this._onEntrySelected(id);\n\n\t\t\t\treturn <ListGroup.Item\n\t\t\t\t\taction\n\t\t\t\t\tclassName=\"p-2\"\n\t\t\t\t\tkey={id}\n\t\t\t\t\tonClick={changeHandler}\n\t\t\t\t\tactive={checked}\n\t\t\t\t>\n\t\t\t\t\t{this.props.type === \"single\" &&\n\t\t\t\t\t\t<Form.Check type=\"radio\" checked={checked} onChange={changeHandler} label={entry.label} />\n\t\t\t\t\t}\n\t\t\t\t\t{this.props.type === \"multi\" &&\n\t\t\t\t\t\t<Form.Check type=\"checkbox\" checked={checked} onChange={changeHandler} label={entry.label} />\n\t\t\t\t\t}\n\t\t\t\t\t{this.props.type === \"oneshot\" &&\n\t\t\t\t\t\tentry.label\n\t\t\t\t\t}\n\t\t\t\t</ListGroup.Item>\n\t\t\t})}\n\t\t</ListGroup>;\n\t}\n\n\tcomponentDidMount() {\n\t\tthis._reloadSelection();\n\t}\n\n\tcomponentDidUpdate(fromProps) {\n\t\tthis._reloadSelection(fromProps);\n\t}\n}\n\nexport default SelectList;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Button from 'react-bootstrap/Button';\nimport FormControl from 'react-bootstrap/FormControl';\nimport I18n from '../../config/locales/ui';\nimport InputGroup from 'react-bootstrap/InputGroup';\nimport Nominatim from 'nominatim-browser';\nimport Magnify from 'mdi-react/MagnifyIcon';\nimport Overlay from 'react-bootstrap/Overlay';\nimport PubSub from 'pubsub-js';\nimport SelectList from '../common/SelectList';\nimport Spinner from 'react-bootstrap/Spinner';\n\n/**\n * SearchPlace is a search bar for searching cities or streets.\n */\nclass SearchPlace extends Component {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.state = {\n\t\t\ttext: \"\",\n\t\t\tloading: false,\n\t\t\tsearchResults: [],\n\t\t\tshowList: false\n\t\t};\n\t}\n\n\t/**\n\t * @private\n\t */\n\t_search(text, now) {\n\t\tnow = now || false;\n\t\tthis.setState({ text: text });\n\n\t\tif(now || (text !== this.state.text && text.length >= 3)) {\n\t\t\tthis.setState({ loading: true, showList: true });\n\n\t\t\tif(this._searchTimer) {\n\t\t\t\tclearTimeout(this._searchTimer);\n\t\t\t}\n\n\t\t\tthis._searchTimer = setTimeout(() => {\n\t\t\t\tNominatim.geocode({\n\t\t\t\t\tq: text,\n\t\t\t\t\t\"accept-language\": I18n.locale\n\t\t\t\t})\n\t\t\t\t.then(results => {\n\t\t\t\t\tresults = results.map(r => ({ label: r.display_name, coordinates: [ r.lat, r.lon ], bbox: r.boundingbox }));\n\t\t\t\t\tthis.setState({\n\t\t\t\t\t\tloading: false,\n\t\t\t\t\t\tshowList: true,\n\t\t\t\t\t\tsearchResults: results\n\t\t\t\t\t}, () => {\n\t\t\t\t\t\tif(this._update) {\n\t\t\t\t\t\t\tthis._update();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch(error => {\n\t\t\t\t\tconsole.error(error);\n\t\t\t\t\tthis.setState({ loading: false, searchResults: null, showList: false });\n\t\t\t\t});\n\t\t\t}, now ? 0 : 2000);\n\t\t}\n\t}\n\n\t/**\n\t * @private\n\t */\n\t_onSelect(addr) {\n\t\tthis.setState({ searchResults: [], text: \"\", showList: false });\n\t\tPubSub.publish(\"map.position.set\", addr);\n\t}\n\n\trender() {\n\t\treturn <div>\n\t\t\t<Overlay\n\t\t\t\tplacement=\"bottom-end\"\n\t\t\t\tshow={this.state.showList}\n\t\t\t\ttarget={this.refs.input}\n\t\t\t\tonHide={() => this.setState({ showList: false, searchResults: [] })}\n\t\t\t\trootClose={true}\n\t\t\t>\n\t\t\t\t{({\n\t\t\t\t\tplacement,\n\t\t\t\t\tscheduleUpdate,\n\t\t\t\t\tarrowProps,\n\t\t\t\t\toutOfBoundaries,\n\t\t\t\t\tshow: _show,\n\t\t\t\t\t...props\n\t\t\t\t}) => {\n\t\t\t\t\tthis._update = scheduleUpdate;\n\t\t\t\t\treturn <div\n\t\t\t\t\t\t{...props}\n\t\t\t\t\t\tstyle={{...props.style, zIndex: 10000}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{this.state.searchResults ?\n\t\t\t\t\t\t\t<SelectList\n\t\t\t\t\t\t\t\tdata={this.state.searchResults}\n\t\t\t\t\t\t\t\ttype=\"oneshot\"\n\t\t\t\t\t\t\t\tonChange={selection => this._onSelect(selection[0])}\n\t\t\t\t\t\t\t\tstyle={{fontSize: \"0.8em\"}}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t:\n\t\t\t\t\t\t\t<p>{I18n.t(\"An error happened when searching address. Please retry.\")}</p>\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t{this.state.loading &&\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclassName=\"text-center\"\n\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\tbackgroundColor: \"#f8f9fa\",\n\t\t\t\t\t\t\t\t\tborderRadius: \"0.25rem\",\n\t\t\t\t\t\t\t\t\tborder: \"1px solid rgba(0, 0, 0, 0.125)\",\n\t\t\t\t\t\t\t\t\tpadding: \"0.5rem\"\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<Spinner animation=\"grow\" className=\"align-middle\" /> {I18n.t(\"Searching address...\")}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t}\n\t\t\t\t\t</div>;\n\t\t\t\t}}\n\t\t\t</Overlay>\n\n\t\t\t<InputGroup className=\"mw-25\" style={{width: 300}} ref=\"input\">\n\t\t\t\t<FormControl\n\t\t\t\t\tplaceholder={I18n.t(\"Search a city, street...\")}\n\t\t\t\t\tvalue={this.state.text}\n\t\t\t\t\tonChange={e => this._search(e.target.value, false)}\n\t\t\t\t/>\n\t\t\t\t<InputGroup.Append>\n\t\t\t\t\t<Button\n\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\tonClick={() => this._search(this.state.text, true)}\n\t\t\t\t\t>\n\t\t\t\t\t\t<Magnify size={16} />\n\t\t\t\t\t</Button>\n\t\t\t\t</InputGroup.Append>\n\t\t\t</InputGroup>\n\t\t</div>;\n\t}\n}\n\nexport default SearchPlace;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Body from './Body';\nimport Button from 'react-bootstrap/Button';\nimport ButtonToolbar from 'react-bootstrap/ButtonToolbar';\nimport Dropdown from 'react-bootstrap/Dropdown';\nimport Layers from 'mdi-react/LayersIcon';\nimport I18n from '../config/locales/ui';\nimport Navbar from 'react-bootstrap/Navbar';\nimport Navigator from './common/Navigator';\nimport Pencil from 'mdi-react/PencilIcon';\nimport PubSub from 'pubsub-js';\nimport SearchPlace from './common/SearchPlace';\n\n/**\n * Header component handles the whole header bar.\n */\nclass Header extends Component {\n\trender() {\n\t\tconst isEditingIndoor = [Body.MODE_BUILDING, Body.MODE_LEVELS, Body.MODE_FEATURES].includes(this.props.mode);\n\n\t\treturn <Navbar className={this.props.className} bg=\"light\" expand=\"xs\">\n\t\t\t<div className=\"d-flex\">\n\t\t\t\t<Navbar.Brand\n\t\t\t\t\tclassName=\"app-brand\"\n\t\t\t\t\tstyle={{cursor: \"pointer\"}}\n\t\t\t\t\ttitle={I18n.t(\"Go back to map explorer\")}\n\t\t\t\t\tonClick={() => PubSub.publish(\"body.mode.set\", { mode: Body.MODE_EXPLORE })}\n\t\t\t\t>\n\t\t\t\t\t{window.EDITOR_NAME}\n\t\t\t\t</Navbar.Brand>\n\n\t\t\t\t<ButtonToolbar className=\"ml-2 hide-xsDown\">\n\t\t\t\t\t<Button\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\tclassName=\"mr-2 btn-mode-floorplan\"\n\t\t\t\t\t\tactive={this.props.mode === Body.MODE_FLOOR_IMAGERY}\n\t\t\t\t\t\tdisabled={this.props.mode === Body.MODE_FLOOR_IMAGERY}\n\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.mode.set\", { mode: Body.MODE_FLOOR_IMAGERY })}\n\t\t\t\t\t\ttitle={I18n.t(\"Import floor plans\")}\n\t\t\t\t\t>\n\t\t\t\t\t\t<Layers /> <span className=\"hide-smDown\">{I18n.t(\"Import floor plans\")}</span>\n\t\t\t\t\t</Button>\n\n\t\t\t\t\t<Dropdown>\n\t\t\t\t\t\t<Dropdown.Toggle\n\t\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\t\tclassName=\"btn-mode-editindoor\"\n\t\t\t\t\t\t\ttitle={I18n.t(\"Edit map\")}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Pencil /> <span className=\"hide-smDown\">{I18n.t(\"Edit map\")}</span>\n\t\t\t\t\t\t</Dropdown.Toggle>\n\n\t\t\t\t\t\t<Dropdown.Menu>\n\t\t\t\t\t\t\t<Dropdown.Item\n\t\t\t\t\t\t\t\tactive={this.props.mode === Body.MODE_BUILDING}\n\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.mode.set\", { mode: Body.MODE_BUILDING })}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{I18n.t(\"Edit buildings\")}\n\t\t\t\t\t\t\t</Dropdown.Item>\n\t\t\t\t\t\t\t<Dropdown.Item\n\t\t\t\t\t\t\t\tactive={this.props.mode === Body.MODE_LEVELS}\n\t\t\t\t\t\t\t\tdisabled={!this.props.building}\n\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.mode.set\", { mode: Body.MODE_LEVELS })}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{I18n.t(\"Edit levels outlines (%{name})\", {\n\t\t\t\t\t\t\t\t\tname: this.props.building ? Body.GetFeatureName(this.props.building) : I18n.t(\"no selected building\")\n\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t</Dropdown.Item>\n\t\t\t\t\t\t\t<Dropdown.Item\n\t\t\t\t\t\t\t\tactive={this.props.mode === Body.MODE_FEATURES}\n\t\t\t\t\t\t\t\tdisabled={!this.props.building}\n\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.mode.set\", { mode: Body.MODE_FEATURES })}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{I18n.t(\"Edit features (%{name})\", {\n\t\t\t\t\t\t\t\t\tname: this.props.building ? Body.GetFeatureName(this.props.building) : I18n.t(\"no selected building\")\n\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t</Dropdown.Item>\n\t\t\t\t\t\t</Dropdown.Menu>\n\t\t\t\t\t</Dropdown>\n\t\t\t\t</ButtonToolbar>\n\t\t\t</div>\n\n\t\t\t{isEditingIndoor &&\n\t\t\t\t<div className=\"hide-mdDown\"><Navigator {...this.props} /></div>\n\t\t\t}\n\n\t\t\t{this.props.mode === Body.MODE_EXPLORE &&\n\t\t\t\t<span className=\"hide-xsDown\"><SearchPlace /></span>\n\t\t\t}\n\t\t</Navbar>;\n\t}\n}\n\nexport default Header;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Checkbox from 'react-three-state-checkbox';\nimport Form from 'react-bootstrap/Form';\nimport HelpCircle from 'mdi-react/HelpCircleIcon';\nimport I18n from '../../config/locales/ui';\nimport Multiselect from 'react-bootstrap-multiselect';\nimport OverlayTrigger from 'react-bootstrap/OverlayTrigger';\nimport Popover from 'react-bootstrap/Popover';\nimport PubSub from 'pubsub-js';\nimport 'react-bootstrap-multiselect/css/bootstrap-multiselect.css';\n\n/**\n * Preset input field is a component allowing user to set value for a certain tag, according to preset definition.\n */\nclass PresetInputField extends Component {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.state = {\n\t\t\tvalue: null\n\t\t};\n\t}\n\n\t/**\n\t * Event handler for change in field value\n\t * @private\n\t */\n\t_onEdit(val) {\n\t\tthis.setState({ value: val });\n\n\t\tconst applyChange = () => {\n\t\t\tconst newTags = Object.assign({}, this.props.tags, { [this.props.data.key]: val });\n\n\t\t\tif(val === \"null\" || val.trim() === \"\") {\n\t\t\t\tdelete newTags[this.props.data.key];\n\t\t\t}\n\n\t\t\tPubSub.publish(\"body.tags.set\", { tags: newTags });\n\t\t};\n\n\t\t// Should we delay tags change event or not (according to if its text input) ?\n\t\tif([\"combo\", \"check\", \"multiselect\"].includes(this.props.type)) {\n\t\t\tapplyChange();\n\t\t}\n\t\telse {\n\t\t\tif(this._timer) {\n\t\t\t\tclearTimeout(this._timer);\n\t\t\t}\n\n\t\t\tthis._timer = setTimeout(applyChange, 500);\n\t\t}\n\t}\n\n\trender() {\n\t\tconst d = this.props.data;\n\t\tconst currentVal = typeof this.state.value === \"string\" ? this.state.value : (this.props.tags[d.key] || \"\");\n\t\tlet res = null;\n\t\tlet infoTip = null;\n\n\t\tif(d.info) {\n\t\t\tconst popover = <Popover id=\"popover-basic\" title={I18n.t(\"Help\")} style={{padding: \"5px 0px 5px 6px\"}}>\n\t\t\t\t{d.info}\n\t\t\t</Popover>;\n\t\t\tinfoTip = <OverlayTrigger placement=\"right\" overlay={popover} popperConfig={{modifiers:{preventOverflow:{boundariesElement: \"window\"}}}}>\n\t\t\t\t<HelpCircle />\n\t\t\t</OverlayTrigger>;\n\t\t}\n\n\t\tif([\"text\", \"number\"].includes(this.props.type)) {\n\t\t\tres = <Form.Group className=\"m-0 mb-3\">\n\t\t\t\t<Form.Label>{d.text || d.key} {infoTip}</Form.Label>\n\t\t\t\t<Form.Control\n\t\t\t\t\ttype={this.props.type}\n\t\t\t\t\tplaceholder={d.default}\n\t\t\t\t\tvalue={currentVal}\n\t\t\t\t\tonChange={e => this._onEdit(e.target.value)}\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t/>\n\t\t\t</Form.Group>;\n\t\t}\n\t\telse if(this.props.type === \"textarea\") {\n\t\t\tres = <Form.Group className=\"m-0 mb-3\">\n\t\t\t\t<Form.Label>{d.text || d.key} {infoTip}</Form.Label>\n\t\t\t\t<Form.Control\n\t\t\t\t\tas=\"textarea\"\n\t\t\t\t\trows=\"3\"\n\t\t\t\t\tplaceholder={d.default}\n\t\t\t\t\tvalue={currentVal}\n\t\t\t\t\tonChange={e => this._onEdit(e.target.value)}\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t/>\n\t\t\t</Form.Group>;\n\t\t}\n\t\telse if(this.props.type === \"combo\") {\n\t\t\tconst values = d.list_entrys ? d.list_entrys.map(d => d.value) : (d.values || \"\").split(\",\" || d.delimiter);\n\t\t\tconst displayValues = d.list_entrys ?\n\t\t\t\td.list_entrys.map(d => d.display_value || d.value)\n\t\t\t\t: (d.display_values ?\n\t\t\t\t\td.display_values.split(\",\" || d.delimiter)\n\t\t\t\t\t: values);\n\n\t\t\tres = <Form.Group className=\"m-0 mb-3\">\n\t\t\t\t<Form.Label>{d.text || d.key} {infoTip}</Form.Label>\n\t\t\t\t<Form.Control\n\t\t\t\t\tas=\"select\"\n\t\t\t\t\tonChange={e => this._onEdit(e.target.value)}\n\t\t\t\t\tvalue={currentVal}\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t>\n\t\t\t\t\t{(d.use_last_as_default === undefined || d.use_last_as_default === \"false\") &&\n\t\t\t\t\t\t<option value={\"null\"}></option>\n\t\t\t\t\t}\n\t\t\t\t\t{values.map((e,i) => (\n\t\t\t\t\t\t<option key={i} value={e || \"\"}>{displayValues[i]}</option>\n\t\t\t\t\t))}\n\t\t\t\t</Form.Control>\n\t\t\t</Form.Group>;\n\t\t}\n\t\telse if(this.props.type === \"check\") {\n\t\t\tconst states = [\n\t\t\t\t{ id: 0, val: d.value_on || \"yes\", label: I18n.t(\"Yes\") },\n\t\t\t\t{ id: 1, val: d.value_off || \"no\", label: I18n.t(\"No\") },\n\t\t\t\t{ id: 2, val: \"null\", label: I18n.t(\"Unknown\") }\n\t\t\t];\n\n\t\t\tlet currentState = 2;\n\t\t\tconst currentValState = states.filter(s => s.val === currentVal);\n\t\t\tif(currentValState.length === 1) {\n\t\t\t\tcurrentState = currentValState[0].id;\n\t\t\t}\n\n\t\t\tconst onEvent = () => {\n\t\t\t\tconst newState = (currentState+1) % 3;\n\t\t\t\tthis._onEdit(states[newState].val);\n\t\t\t};\n\n\t\t\tres = <Form.Group className=\"m-0 mb-3 form-group-check\">\n\t\t\t\t<p className=\"m-0\">{d.text || d.key} {infoTip}</p>\n\n\t\t\t\t<Checkbox\n\t\t\t\t\tchecked={currentState === 0}\n\t\t\t\t\tindeterminate={currentState === 2}\n\t\t\t\t\tonChange={() => onEvent()}\n\t\t\t\t/>\n\n\t\t\t\t<Form.Check.Label onClick={() => onEvent()}>\n\t\t\t\t\t{states[currentState].label}\n\t\t\t\t</Form.Check.Label>\n\t\t\t</Form.Group>;\n\t\t}\n\t\telse if(this.props.type === \"binarycheck\") {\n\t\t\tconst states = [\n\t\t\t\t{ id: 0, val: d.value_on || \"yes\" },\n\t\t\t\t{ id: 1, val: d.value_off || \"null\" }\n\t\t\t];\n\n\t\t\tlet currentState = 1;\n\t\t\tconst currentValState = states.filter(s => s.val === currentVal);\n\t\t\tif(currentValState.length === 1) {\n\t\t\t\tcurrentState = currentValState[0].id;\n\t\t\t}\n\n\t\t\tconst onEvent = () => {\n\t\t\t\tconst newState = (currentState+1) % 2;\n\t\t\t\tthis._onEdit(states[newState].val);\n\t\t\t};\n\n\t\t\tres = <Form.Group className=\"m-0 mb-3\">\n\t\t\t\t<Form.Check type=\"checkbox\">\n\t\t\t\t\t<Form.Check.Input\n\t\t\t\t\t\ttype=\"checkbox\"\n\t\t\t\t\t\tchecked={currentState === 0}\n\t\t\t\t\t\tonChange={() => onEvent()}\n\t\t\t\t\t/>\n\t\t\t\t\t<Form.Check.Label\n\t\t\t\t\t\tonClick={() => onEvent()}\n\t\t\t\t\t>\n\t\t\t\t\t\t{d.text || d.key} {infoTip}\n\t\t\t\t\t</Form.Check.Label>\n\t\t\t\t</Form.Check>\n\t\t\t</Form.Group>;\n\t\t}\n\t\telse if(this.props.type === \"multiselect\") {\n\t\t\tlet data = null;\n\t\t\tconst currentValues = currentVal.split(\";\");\n\n\t\t\tif(d.list_entrys) {\n\t\t\t\tdata = d.list_entrys.map(e => ({\n\t\t\t\t\tvalue: e.value,\n\t\t\t\t\tlabel: e.display_value || e.value,\n\t\t\t\t\ttitle: e.short_description,\n\t\t\t\t\tselected: currentValues.includes(e.value)\n\t\t\t\t}));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata = d.values.split(\";\" || d.delimiter).map(e => ({ value: e, selected: currentValues.includes(e) }));\n\t\t\t\tif(d.display_values) {\n\t\t\t\t\td.display_values.split(\";\" || d.delimiter).forEach((e,i) => {\n\t\t\t\t\t\tdata[i].label = e;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tres = <Form.Group className=\"m-0 mb-3\">\n\t\t\t\t<Form.Label>{d.text || d.key} {infoTip}</Form.Label>\n\t\t\t\t<Form.Control\n\t\t\t\t\tas={Multiselect}\n\t\t\t\t\tdata={data}\n\t\t\t\t\tmultiple\n\t\t\t\t\tref={\"multiselect-\"+d.key}\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t/>\n\t\t\t</Form.Group>;\n\t\t}\n\n\t\treturn res;\n\t}\n\n\tcomponentDidMount() {\n\t\tif(this.props.type === \"multiselect\") {\n\t\t\t// Handle value changes on multiselect (is broken when using onChange prop on react component)\n\t\t\tconst ms = this.refs[\"multiselect-\"+this.props.data.key][\"$multiselect\"][0];\n\t\t\tms.onchange = () => {\n\t\t\t\tlet val = [];\n\t\t\t\tfor(const elem of ms.selectedOptions) {\n\t\t\t\t\tval.push(elem.value);\n\t\t\t\t}\n\t\t\t\tthis._onEdit(val.join(\";\"));\n\t\t\t};\n\t\t}\n\t}\n\n\tcomponentDidUpdate(prevProps) {\n\t\t// Re-sync internal state with value in component props\n\t\tif(\n\t\t\t(this.props.tags && this.props.data && this.props.data.key && this.props.tags[this.props.data.key] && (!prevProps.tags || !prevProps.data || !prevProps.data.key || !prevProps.tags[prevProps.data.key] || prevProps.tags[prevProps.data.key] !== this.props.tags[this.props.data.key]))\n\t\t\t||\n\t\t\t(prevProps.tags && prevProps.data && prevProps.data.key && prevProps.tags[prevProps.data.key] && (!this.props.tags || !this.props.data || !this.props.data.key || !this.props.tags[this.props.data.key] || prevProps.tags[prevProps.data.key] !== this.props.tags[this.props.data.key]))\n\t\t) {\n\t\t\tthis.setState({ value: null });\n\t\t}\n\t}\n}\n\nexport default PresetInputField;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Button from 'react-bootstrap/Button';\nimport Close from 'mdi-react/CloseIcon';\nimport deepEqual from 'fast-deep-equal';\nimport FormControl from 'react-bootstrap/FormControl';\nimport InformationVariant from 'mdi-react/InformationVariantIcon';\nimport InputGroup from 'react-bootstrap/InputGroup';\nimport Plus from 'mdi-react/PlusIcon';\nimport PubSub from 'pubsub-js';\n\nconst WIKI_USE_TAG = [ \"building\", \"highway\", \"natural\", \"surface\", \"landuse\", \"power\", \"waterway\", \"amenity\", \"barrier\", \"place\", \"leisure\", \"railway\", \"shop\", \"man_made\", \"public_transport\", \"tourism\", \"emergency\", \"historic\", \"indoor\" ];\n\n/**\n * Tags table component allows display of raw OSM tags.\n * It also editing these tags, directly by user.\n *\n * @property {Object} tags Initial tag list\n */\nclass TagsTable extends Component {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.state = {\n\t\t\ttags: null,\n\t\t\tnewline: false,\n\t\t\tfocusKey: null,\n\t\t\tfocusVal: null\n\t\t};\n\t}\n\n\t_tagsObjToArray(obj) {\n\t\treturn obj ? Object.entries(obj) : null;\n\t}\n\n\t_tagsArrayToObj(arr) {\n\t\tif(!arr) { return null; }\n\t\telse {\n\t\t\tconst obj = {};\n\t\t\tarr.forEach(e => { obj[e[0]] = e[1]; });\n\t\t\treturn obj;\n\t\t}\n\t}\n\n\t/**\n\t * Event handler for tag changes\n\t * @private\n\t */\n\t_onTagsChanged() {\n\t\tconst tags = [];\n\t\tconst tagsDom = document.getElementsByClassName(\"app-tags-row\");\n\n\t\t// Read all tags from table\n\t\tfor(const d of tagsDom) {\n\t\t\tconst key = d.getElementsByClassName(\"app-tags-row-key\")[0].value;\n\t\t\tconst val = d.getElementsByClassName(\"app-tags-row-val\")[0].value;\n\t\t\ttags.push([ key, val ]);\n\t\t}\n\n\t\tif(this._timer) {\n\t\t\tclearTimeout(this._timer);\n\t\t\tthis._timer = null;\n\t\t}\n\n\t\tthis._timer = setTimeout(() => {\n\t\t\tPubSub.publish(\"body.tags.set\", { tags: this._tagsArrayToObj(tags) });\n\t\t\tthis._timer = null;\n\t\t}, 500);\n\n\t\tconst newState = { newline: false, tags: tags, focusKey: null, focusVal: null };\n\n\t\tif(this.state.newline && document.activeElement) {\n\t\t\tif(document.activeElement.classList.contains(\"app-tags-row-key\")) {\n\t\t\t\tnewState.focusKey = document.activeElement.value;\n\t\t\t}\n\t\t\telse if(document.activeElement.classList.contains(\"app-tags-row-val\")) {\n\t\t\t\tnewState.focusVal = document.activeElement.value;\n\t\t\t}\n\t\t}\n\n\t\tthis.setState(newState);\n\t}\n\n\t/**\n\t * Event handler for tag deletion\n\t * @private\n\t */\n\t_onTagDeleted(k) {\n\t\tconst tagsObj = this._tagsArrayToObj(this.state.tags);\n\t\tdelete tagsObj[k];\n\t\tPubSub.publish(\"body.tags.set\", { tags: tagsObj });\n\n\t\tif(this.state.newline) {\n\t\t\tthis.setState({ newline: false, focusKey: null, focusVal: null });\n\t\t}\n\t}\n\n\t/**\n\t * Get the correct wiki URL for getting details about a tag\n\t * @private\n\t */\n\t_getWikiURL(key, value) {\n\t\tlet url = \"https://wiki.openstreetmap.org/wiki/\";\n\n\t\tif(WIKI_USE_TAG.includes(key)) {\n\t\t\turl += \"Tag:\"+key+\"=\"+value;\n\t\t}\n\t\telse {\n\t\t\turl += \"Key:\"+key;\n\t\t}\n\n\t\treturn url;\n\t}\n\n\trender() {\n\t\tconst entries = (this.state.tags || []).slice(0);\n\n\t\tif(this.state.newline) {\n\t\t\tentries.push([ \"\", \"\" ]);\n\t\t}\n\n\t\treturn <div className={this.props.className}>\n\t\t\t<div className=\"app-tags\">\n\t\t\t\t{entries.map((e,i) => (\n\t\t\t\t\t<InputGroup size=\"sm\" className=\"m-0 app-tags-row\" key={i}>\n\t\t\t\t\t\t<FormControl\n\t\t\t\t\t\t\tclassName=\"app-tags-row-key\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\tvalue={e[0]}\n\t\t\t\t\t\t\tdisabled={this.props.locked}\n\t\t\t\t\t\t\tonChange={e => this._onTagsChanged()}\n\t\t\t\t\t\t\tautoFocus={(this.state.newline && i === entries.length-1) || this.state.focusKey === e[0]}\n\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t<FormControl\n\t\t\t\t\t\t\tclassName=\"app-tags-row-val\"\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\tvalue={e[1]}\n\t\t\t\t\t\t\tdisabled={this.props.locked}\n\t\t\t\t\t\t\tonChange={e => this._onTagsChanged()}\n\t\t\t\t\t\t\tautoFocus={!this.state.newline && this.state.focusVal === e[1]}\n\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t<InputGroup.Append>\n\t\t\t\t\t\t\t{!this.props.locked &&\n\t\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\t\tvariant=\"outline-danger\"\n\t\t\t\t\t\t\t\t\ttabIndex=\"-1\"\n\t\t\t\t\t\t\t\t\tdisabled={this.props.noDelete && this.props.noDelete.includes(e[0])}\n\t\t\t\t\t\t\t\t\tonClick={() => this._onTagDeleted(e[0])}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<Close size={16} />\n\t\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"outline-info\"\n\t\t\t\t\t\t\t\thref={this._getWikiURL(e[0], e[1])}\n\t\t\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t\t\ttabIndex=\"-1\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<InformationVariant size={16} />\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t</InputGroup.Append>\n\t\t\t\t\t</InputGroup>\n\t\t\t\t))}\n\t\t\t</div>\n\t\t\t{!this.props.locked &&\n\t\t\t\t<Button\n\t\t\t\t\tvariant=\"secondary\"\n\t\t\t\t\tclassName=\"app-tags-add\"\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\tblock\n\t\t\t\t\tonClick={() => this.setState({ newline: true })}\n\t\t\t\t\ttabIndex=\"-1\"\n\t\t\t\t>\n\t\t\t\t\t<Plus size={16} />\n\t\t\t\t</Button>\n\t\t\t}\n\t\t</div>;\n\t}\n\n\tcomponentDidMount() {\n\t\tthis.setState({ tags: this._tagsObjToArray(this.props.tags) });\n\t}\n\n\tcomponentDidUpdate(prevProps) {\n\t\tif(!deepEqual(prevProps.tags, this.props.tags)) {\n\t\t\tthis.setState({ tags: this._tagsObjToArray(this.props.tags) });\n\t\t}\n\t}\n}\n\nexport default TagsTable;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Body from '../Body';\nimport Button from 'react-bootstrap/Button';\nimport Check from 'mdi-react/CheckIcon';\nimport Col from 'react-bootstrap/Col';\nimport Container from 'react-bootstrap/Container';\nimport I18n from '../../config/locales/ui';\nimport PresetInputField from '../common/PresetInputField';\nimport PubSub from 'pubsub-js';\nimport Row from 'react-bootstrap/Row';\nimport TagsTable from '../common/TagsTable';\n\n/**\n * BuildingEdit pane allows to change a building description for user.\n *\n * @property {Object} feature The building feature to edit\n */\nclass BuildingEditPane extends Component {\n\t/**\n\t * Event handler when \"Done\" button is clicked\n\t * @private\n\t */\n\t_onDone() {\n\t\tPubSub.publish(\"body.unselect.feature\");\n\t}\n\n\trender() {\n\t\tif(!this.props.building) { return <div></div>; }\n\n\t\tconst feature = this.props.building;\n\t\tconst tags = feature.properties.tags;\n\t\tconst infoLevels = <span>{I18n.t(\"Number of levels above ground (roof excluded), here B + C + D = 3 levels\")}<img src='img/building_levels.png' style={{height: 200}} alt={I18n.t(\"Schema explaining how should be set amount of levels\")} /></span>;\n\t\tconst infoLevelsUndergound = <span>{I18n.t(\"Number of levels completely underground, here E = 1 level\")}<img src='img/building_levels.png' style={{height: 200}} alt={I18n.t(\"Schema explaining how should be set amount of levels\")} /></span>;\n\t\tconst infoLevelsRoof = <span>{I18n.t(\"Number of levels under the roof, here A = 1 level\")}<img src='img/building_levels.png' style={{height: 200}} alt={I18n.t(\"Schema explaining how should be set amount of levels\")} /></span>;\n\n\t\treturn <div>\n\t\t\t<Container className=\"m-0 pl-2 pr-2 mt-2\">\n\t\t\t\t<Row className=\"d-flex align-items-top justify-content-between\">\n\t\t\t\t\t<Col>\n\t\t\t\t\t\t<h3 className=\"m-0 p-0\">{Body.GetFeatureName(feature)}</h3>\n\t\t\t\t\t</Col>\n\n\t\t\t\t\t<Col className=\"text-right\">\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\ttitle={I18n.t(\"Done\")}\n\t\t\t\t\t\t\tonClick={() => this._onDone()}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Check />\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</Col>\n\t\t\t\t</Row>\n\t\t\t</Container>\n\n\t\t\t<div className=\"m-2 mb-4\">\n\t\t\t\t<PresetInputField\n\t\t\t\t\ttype=\"text\"\n\t\t\t\t\tdata={{ text: I18n.t(\"Name\"), key: \"name\" }}\n\t\t\t\t\ttags={tags}\n\t\t\t\t/>\n\n\t\t\t\t<PresetInputField\n\t\t\t\t\ttype=\"combo\"\n\t\t\t\t\tdata={{ text: I18n.t(\"Type of building\"), key: \"building\", values: \"retail,commercial,parking,industrial,apartments,garage,school,church,warehouse,university,office,hospital,hotel,train_station,college,civic,public,yes\" , use_last_as_default: \"force\" }}\n\t\t\t\t\ttags={tags}\n\t\t\t\t/>\n\n\t\t\t\t<PresetInputField\n\t\t\t\t\ttype=\"text\"\n\t\t\t\t\tdata={{ text: I18n.t(\"Total height (in meters)\"), key: \"building:height\" }}\n\t\t\t\t\ttags={tags}\n\t\t\t\t/>\n\n\t\t\t\t<PresetInputField\n\t\t\t\t\ttype=\"number\"\n\t\t\t\t\tdata={{ text: I18n.t(\"Number of overground levels (roof excluded)\"), info: infoLevels, key: \"building:levels\" }}\n\t\t\t\t\ttags={tags}\n\t\t\t\t/>\n\n\t\t\t\t<PresetInputField\n\t\t\t\t\ttype=\"number\"\n\t\t\t\t\tdata={{ text: I18n.t(\"Number of underground levels\"), info: infoLevelsUndergound, key: \"building:levels:underground\" }}\n\t\t\t\t\ttags={tags}\n\t\t\t\t/>\n\n\t\t\t\t<PresetInputField\n\t\t\t\t\ttype=\"number\"\n\t\t\t\t\tdata={{ text: I18n.t(\"Number of levels under roof\"), info: infoLevelsRoof, key: \"roof:levels\" }}\n\t\t\t\t\ttags={tags}\n\t\t\t\t/>\n\t\t\t</div>\n\n\t\t\t<div className=\"m-2\">\n\t\t\t\t<TagsTable\n\t\t\t\t\ttags={tags}\n\t\t\t\t\tnoDelete={[\"building\", \"building:part\"]}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>;\n\t}\n}\n\nexport default BuildingEditPane;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport DotsHorizontal from 'mdi-react/DotsHorizontalIcon';\nimport ListGroup from 'react-bootstrap/ListGroup';\nimport MapMarker from 'mdi-react/MapMarkerIcon';\nimport VectorLine from 'mdi-react/VectorLineIcon';\nimport VectorSquare from 'mdi-react/VectorSquareIcon';\n\n/**\n * Changeset diff component allows to show to user what edits have been done.\n */\nclass ChangesetDiff extends Component {\n\trender() {\n\t\tconst typeIcon = {\n\t\t\t\"Point\": <MapMarker />,\n\t\t\t\"LineString\": <VectorLine />,\n\t\t\t\"Polygon\": <VectorSquare />,\n\t\t\t\"MultiPolygon\": <VectorSquare />\n\t\t};\n\n\t\treturn <ListGroup>\n\t\t\t{Object.entries(this.props.diff)\n\t\t\t\t.map(e => {\n\t\t\t\t\tconst [ elemId, elemDiff ] = e;\n\t\t\t\t\tconst color = elemDiff.created ? \"green\" : (elemDiff.deleted ? \"red\" : \"orange\");\n\n\t\t\t\t\treturn <ListGroup.Item\n\t\t\t\t\t\taction\n\t\t\t\t\t\tclassName=\"p-1\"\n\t\t\t\t\t\tkey={elemId}\n\t\t\t\t\t\tstyle={{color: color}}\n\t\t\t\t\t\ttitle={Object.entries(elemDiff.metadata.tags).map(e => e.join(\" = \")).join(\"\\n\")}\n\t\t\t\t\t>\n\t\t\t\t\t\t{typeIcon[elemDiff.metadata.geometry] || <DotsHorizontal />}\n\t\t\t\t\t\t{elemDiff.metadata.name}\n\t\t\t\t\t</ListGroup.Item>;\n\t\t\t\t})\n\t\t\t}\n\t\t</ListGroup>;\n\t}\n}\n\nexport default ChangesetDiff;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Body from '../Body';\nimport Button from 'react-bootstrap/Button';\nimport ChangesetDiff from '../common/ChangesetDiff';\nimport Check from 'mdi-react/CheckIcon';\nimport CloseCircle from 'mdi-react/CloseCircleIcon';\nimport I18n from '../../config/locales/ui';\nimport Magnify from 'mdi-react/MagnifyIcon';\nimport Pencil from 'mdi-react/PencilIcon';\nimport PresetInputField from '../common/PresetInputField';\nimport PubSub from 'pubsub-js';\nimport Spinner from 'react-bootstrap/Spinner';\nimport TagsTable from '../common/TagsTable';\n\n/**\n * Changeset pane allows user to review edits before sending to OSM.\n */\nclass ChangesetPane extends Component {\n\trender() {\n\t\tif(!this.props.changeset) { return <div></div>; }\n\n\t\treturn <div>\n\t\t\t<div className=\"m-2 mb-4\">\n\t\t\t\t<h3 className=\"m-0 p-0 mb-1\">{I18n.t(\"Send changes to OpenStreetMap\")}</h3>\n\n\t\t\t\t{this.props.changeset.status === \"preparing\" &&\n\t\t\t\t\t<div className=\"text-center\">\n\t\t\t\t\t\t<Spinner animation=\"grow\" variant=\"secondary\" className=\"align-middle\" /> {I18n.t(\"Analyzing your changes...\")}\n\t\t\t\t\t</div>\n\t\t\t\t}\n\n\t\t\t\t{this.props.changeset.status === \"check\" ?\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<PresetInputField\n\t\t\t\t\t\t\ttype=\"textarea\"\n\t\t\t\t\t\t\tdata={{ text: I18n.t(\"Changeset comment\"), key: \"comment\", default: I18n.t(\"Describe briefly but explicitely your edits (required)\") }}\n\t\t\t\t\t\t\ttags={this.props.changeset.tags}\n\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t<PresetInputField\n\t\t\t\t\t\t\ttype=\"multiselect\"\n\t\t\t\t\t\t\tdata={{\n\t\t\t\t\t\t\t\ttext: I18n.t(\"Sources\"),\n\t\t\t\t\t\t\t\tkey: \"source\",\n\t\t\t\t\t\t\t\tlist_entrys: [\n\t\t\t\t\t\t\t\t\t{ value: \"local knowledge\", display_value: I18n.t(\"Local knowledge\") },\n\t\t\t\t\t\t\t\t\t{ value: \"survey\", display_value: I18n.t(\"Ground survey\") },\n\t\t\t\t\t\t\t\t\t{ value: \"aerial imagery\", display_value: I18n.t(\"Aerial imagery\") },\n\t\t\t\t\t\t\t\t\t{ value: \"streetlevel imagery\", display_value: I18n.t(\"Street-level imagery\") },\n\t\t\t\t\t\t\t\t\t{ value: \"emergency map\", display_value: I18n.t(\"Emergency map\") }\n\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\tinfo: I18n.t(\"List all sources you have used to make your edits (recommended)\"),\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\ttags={this.props.changeset.tags}\n\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t<PresetInputField\n\t\t\t\t\t\t\ttype=\"binarycheck\"\n\t\t\t\t\t\t\tdata={{ text: I18n.t(\"I would like someone to review my edits\"), key: \"review_requested\" }}\n\t\t\t\t\t\t\ttags={this.props.changeset.tags}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t:\n\t\t\t\t\t<div className=\"text-center\">\n\t\t\t\t\t\t{this.props.changeset.status === \"upload\" &&\n\t\t\t\t\t\t\t<div><Spinner animation=\"grow\" variant=\"success\" className=\"align-middle\" /> {I18n.t(\"Uploading your changes...\")}</div>\n\t\t\t\t\t\t}\n\t\t\t\t\t\t{this.props.changeset.status === \"sent\" &&\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<Check size={42} style={{color: \"green\"}} /> {I18n.t(\"Thanks for your contribution !\")}<br />\n\n\t\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\t\tvariant=\"outline-success\"\n\t\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\t\tblock\n\t\t\t\t\t\t\t\t\thref={window.CONFIG.osm_api_url+\"/changeset/\"+this.props.changeset.id}\n\t\t\t\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t\t\t\trel=\"noopener noreferrer\"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<Magnify size={24} /> {I18n.t(\"See your changes on OpenStreetMap\")}\n\t\t\t\t\t\t\t\t</Button>\n\n\t\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\t\tvariant=\"outline-primary\"\n\t\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\t\tblock\n\t\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.action.cleanup\")}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<Pencil size={24} /> {I18n.t(\"Go back to editing\")}\n\t\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t}\n\t\t\t\t\t\t{this.props.changeset.status === \"error\" &&\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<CloseCircle size={42} style={{color: \"red\"}} /> {I18n.t(\"Oops ! There was an error during upload...\")}<br />\n\n\t\t\t\t\t\t\t\t{this.props.changeset.reason === \"changeset_failed\" ?\n\t\t\t\t\t\t\t\t\tI18n.t(\"OpenStreetMap server can't be contacted. Check your Internet connection and retry in a few minutes.\")\n\t\t\t\t\t\t\t\t\t:\n\t\t\t\t\t\t\t\t\tI18n.t(\"Some of your edits could have been lost, please reload and retry.\")\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t{this.props.changeset.reason === \"changeset_failed\" &&\n\t\t\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.mode.set\", { mode: Body.MODE_BUILDING })}\n\t\t\t\t\t\t\t\t\t\tblock\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t{I18n.t(\"Go back to editing\")}\n\t\t\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t}\n\t\t\t\t\t</div>\n\t\t\t\t}\n\t\t\t</div>\n\n\t\t\t{this.props.changeset.status === \"check\" &&\n\t\t\t\t<div className=\"m-2 mb-4 d-flex justify-content-between\">\n\t\t\t\t\t<Button\n\t\t\t\t\t\tvariant=\"success\"\n\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tif(this.props.changeset.tags && this.props.changeset.tags.comment && this.props.changeset.tags.comment.trim().length > 0) {\n\t\t\t\t\t\t\t\tPubSub.publish(\"body.action.save\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\talert(I18n.t(\"You have to give us more details about your changes using Changeset comment text field.\"));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tclassName=\"flex-grow-1 mr-1\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{I18n.t(\"Send\")}\n\t\t\t\t\t</Button>\n\t\t\t\t\t<Button\n\t\t\t\t\t\tvariant=\"secondary\"\n\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.mode.set\", { mode: Body.MODE_BUILDING })}\n\t\t\t\t\t\tclassName=\"flex-grow-1 ml-1\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{I18n.t(\"Cancel\")}\n\t\t\t\t\t</Button>\n\t\t\t\t</div>\n\t\t\t}\n\n\t\t\t{this.props.changeset.status === \"check\" &&\n\t\t\t\t<div className=\"m-2\">\n\t\t\t\t\t<h5 className=\"m-0 mt-2 p-0 mb-2\">{I18n.t(\"Changeset tags\")}</h5>\n\t\t\t\t\t<TagsTable\n\t\t\t\t\t\ttags={this.props.changeset.tags}\n\t\t\t\t\t/>\n\n\t\t\t\t\t<h5 className=\"m-0 mt-4 p-0 mb-2\">{I18n.t(\"Your edits\")}</h5>\n\t\t\t\t\t<ChangesetDiff diff={this.props.changeset.diff} />\n\t\t\t\t</div>\n\t\t\t}\n\t\t</div>;\n\t}\n}\n\nexport default ChangesetPane;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Col from 'react-bootstrap/Col';\nimport Container from 'react-bootstrap/Container';\nimport I18n from '../../config/locales/ui';\nimport MapMarker from 'mdi-react/MapMarkerIcon';\nimport VectorLine from 'mdi-react/VectorLineIcon';\nimport VectorSquare from 'mdi-react/VectorSquareIcon';\nimport Row from 'react-bootstrap/Row';\n\n/**\n * Geometry type select allows user to choose one type of geometry between several available.\n */\nclass GeometryTypeSelect extends Component {\n\trender() {\n\t\tconst availableTypes = [\n\t\t\t{ id: \"node\", name: I18n.t(\"Point\"), icon: <MapMarker />, desc: I18n.t(\"For small features (size less than 2 meters)\") },\n\t\t\t{ id: \"way\", name: I18n.t(\"Line\"), icon: <VectorLine />, desc: I18n.t(\"For long but not large features\") },\n\t\t\t{ id: \"closedway\", name: I18n.t(\"Area\"), icon: <VectorSquare />, desc: I18n.t(\"For wide features (surface of more than a few m)\") }\n\t\t].filter(t => !this.props.types || this.props.types.length === 0 || this.props.types.includes(t.id));\n\n\t\treturn <Container>\n\t\t\t{availableTypes.map((t,i) => (\n\t\t\t\t<Row\n\t\t\t\t\tkey={i}\n\t\t\t\t\tclassName=\"app-geomtype\"\n\t\t\t\t\tonClick={() => this.props.onClick(t.id)}\n\t\t\t\t>\n\t\t\t\t\t<Col xs={2}>\n\t\t\t\t\t\t{t.icon}\n\t\t\t\t\t</Col>\n\t\t\t\t\t<Col className=\"app-geomtype-text\">\n\t\t\t\t\t\t<span>{t.name}</span>\n\t\t\t\t\t\t<span>{t.desc}</span>\n\t\t\t\t\t</Col>\n\t\t\t\t</Row>\n\t\t\t))}\n\t\t</Container>;\n\t}\n}\n\nexport default GeometryTypeSelect;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport ChevronRight from 'mdi-react/ChevronRightIcon';\nimport I18n from '../../config/locales/ui';\nimport MapMarker from 'mdi-react/MapMarkerIcon';\nimport MapMarkerMultiple from 'mdi-react/MapMarkerMultipleIcon';\nimport MapMarkerPlus from 'mdi-react/MapMarkerPlusIcon';\nimport Media from 'react-bootstrap/Media';\n\nconst TAGS_ICONS = [ \"amenity\", \"aeroway\", \"barrier\", \"emergency\", \"highway\", \"historic\", \"man_made\", \"railway\", \"shop\", \"tourism\" ];\n\n/**\n * Preset card is a single entry of a PresetSelect list.\n */\nclass PresetCard extends Component {\n\trender() {\n\t\tif(!this.props.preset) {\n\t\t\treturn <Media\n\t\t\t\tclassName={(this.props.className || \"\")+\" p-1 app-preset-card\"}\n\t\t\t\tonClick={() => this.props.onClick()}\n\t\t\t>\n\t\t\t\t<MapMarkerPlus size={32} className=\"align-self-center mr-2\" style={{color: \"gray\"}} />\n\n\t\t\t\t<Media.Body>\n\t\t\t\t\t<h5>{I18n.t(\"Select a preset\")}</h5>\n\t\t\t\t</Media.Body>\n\t\t\t</Media>;\n\t\t}\n\t\telse {\n\t\t\tlet icon = this.props.preset.icon || null;\n\t\t\tconst isGroup = this.props.preset.tags === undefined;\n\n\t\t\tif(!icon && this.props.preset.tags) {\n\t\t\t\tconst tags = Object.entries(this.props.preset.tags).filter(e => TAGS_ICONS.includes(e[0]));\n\t\t\t\tif(tags.length > 0) {\n\t\t\t\t\ticon = window.EDITOR_URL + \"img/icons/\"+tags[0][0]+\"_\"+tags[0][1]+\".png\";\n\n\t\t\t\t\tif(window.UNUSABLE_ICONS.has(icon)) {\n\t\t\t\t\t\ticon = null;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn <Media\n\t\t\t\tclassName={(this.props.className || \"\")+\" p-1 app-preset-card\"+(isGroup ? \" app-preset-card-group\" : \"\")}\n\t\t\t\tonClick={() => this.props.onClick(this.props.preset)}\n\t\t\t>\n\t\t\t\t{icon &&\n\t\t\t\t\t<img\n\t\t\t\t\t\twidth={32}\n\t\t\t\t\t\theight={32}\n\t\t\t\t\t\tclassName=\"align-self-center mr-2 app-preset-symbol\"\n\t\t\t\t\t\tsrc={icon}\n\t\t\t\t\t\talt={this.props.preset.name}\n\t\t\t\t\t\tonError={e => {\n\t\t\t\t\t\t\te.target.style.display = \"none\";\n\t\t\t\t\t\t\twindow.UNUSABLE_ICONS.add(e.target.src);\n\t\t\t\t\t\t\tthis.forceUpdate();\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t}\n\n\t\t\t\t{!icon && (this.props.preset.groups || this.props.preset.items ?\n\t\t\t\t\t<MapMarkerMultiple size={32} className=\"align-self-center mr-2 app-preset-symbol\" style={{color: \"gray\"}} />\n\t\t\t\t\t:\n\t\t\t\t\t<MapMarker size={32} className=\"align-self-center mr-2 app-preset-symbol\" style={{color: \"gray\"}} />\n\t\t\t\t)}\n\n\t\t\t\t<Media.Body>\n\t\t\t\t\t<h5>{this.props.preset.name}</h5>\n\t\t\t\t</Media.Body>\n\n\t\t\t\t{(this.props.preset.groups || this.props.preset.items) &&\n\t\t\t\t\t<ChevronRight className=\"app-preset-enter align-self-center\" size={32} />\n\t\t\t\t}\n\t\t\t</Media>;\n\t\t}\n\t}\n}\n\nexport default PresetCard;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Button from 'react-bootstrap/Button';\nimport ChevronLeft from 'mdi-react/ChevronLeftIcon';\nimport Close from 'mdi-react/CloseIcon';\nimport FormControl from 'react-bootstrap/FormControl';\nimport I18n from '../../config/locales/ui';\nimport InputGroup from 'react-bootstrap/InputGroup';\nimport Magnify from 'mdi-react/MagnifyIcon';\nimport PresetCard from './PresetCard';\n\n/**\n * Preset select allows user to choose one preset between a structured list of presets.\n */\nclass PresetSelect extends Component {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.state = {\n\t\t\tpath: \"/\",\n\t\t\ttext: \"\"\n\t\t};\n\t}\n\n\t/**\n\t * Event handler for click on one entry\n\t * @private\n\t */\n\t_onPresetClicked(preset) {\n\t\tif(preset.groups || preset.items) {\n\t\t\tthis.setState({ path: this.state.path+preset.name+\"/\" });\n\t\t}\n\t\telse if(this.props.onSelect) {\n\t\t\tthis.props.onSelect(preset);\n\t\t}\n\t}\n\n\t/**\n\t * Event handler for click on back button\n\t * @private\n\t */\n\t_onBackClicked() {\n\t\tif(this.state.path === \"/\" && this.props.onBack) {\n\t\t\tthis.props.onBack();\n\t\t}\n\t\telse {\n\t\t\tconst entries = this.state.path.split(\"/\").filter(e => e !== \"\");\n\t\t\tentries.pop();\n\t\t\tthis.setState({ path: entries.length > 0 ? \"/\"+entries.join(\"/\")+\"/\" : \"/\" });\n\t\t}\n\t}\n\n\t/**\n\t * Generate one entry for preset\n\t * @private\n\t */\n\t_createEntry(key, item) {\n\t\treturn <PresetCard\n\t\t\tkey={key}\n\t\t\tclassName=\"mb-2\"\n\t\t\tpreset={item}\n\t\t\tonClick={this._onPresetClicked.bind(this)}\n\t\t/>;\n\t}\n\n\trender() {\n\t\tlet presets;\n\t\tconst hasSearch = this.state.text.trim().length > 0;\n\n\t\tif(hasSearch) {\n\t\t\tpresets = window.presetsManager.findPresetsByName(this.state.text, this.props.filter);\n\t\t}\n\t\telse {\n\t\t\tpresets = window.presetsManager.getPresets(this.state.path, this.props.filter);\n\t\t}\n\n\t\treturn <div className={this.props.className}>\n\t\t\t<InputGroup className=\"mb-2\">\n\t\t\t\t{!hasSearch &&\n\t\t\t\t\t<InputGroup.Prepend>\n\t\t\t\t\t\t<InputGroup.Text>\n\t\t\t\t\t\t\t<Magnify size={18} />\n\t\t\t\t\t\t</InputGroup.Text>\n\t\t\t\t\t</InputGroup.Prepend>\n\t\t\t\t}\n\n\t\t\t\t<FormControl\n\t\t\t\t\tplaceholder={I18n.t(\"Search a type of feature...\")}\n\t\t\t\t\tvalue={this.state.text}\n\t\t\t\t\tonChange={e => this.setState({ text: e.target.value })}\n\t\t\t\t/>\n\n\t\t\t\t{hasSearch &&\n\t\t\t\t\t<InputGroup.Append>\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\t\tonClick={() => this.setState({ text: \"\" })}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Close size={16} />\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</InputGroup.Append>\n\t\t\t\t}\n\t\t\t</InputGroup>\n\n\t\t\t{(this.state.path !== \"/\" || this.props.onBack) &&\n\t\t\t\t<Button\n\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\tblock\n\t\t\t\t\tclassName=\"mb-2\"\n\t\t\t\t\tonClick={() => this._onBackClicked()}\n\t\t\t\t>\n\t\t\t\t\t<ChevronLeft style={{ float: \"left\" }} /> {I18n.t(\"Back\")}\n\t\t\t\t</Button>\n\t\t\t}\n\n\t\t\t{this.state.path === \"/\" && !hasSearch && this.props.lastUsedPresets && this.props.lastUsedPresets.length > 0 &&\n\t\t\t\tthis.props.lastUsedPresets.map((p,i) => this._createEntry(\"lu\"+i, p))\n\t\t\t}\n\t\t\t{presets && presets.groups && presets.groups.map((g,i) => this._createEntry(\"g\"+i, g))}\n\t\t\t{presets && presets.items && presets.items.map((it,i) => this._createEntry(\"i\"+i, it))}\n\t\t</div>;\n\t}\n\n\tcomponentDidMount() {\n\t\tif(this.props.initialPath) {\n\t\t\tthis.setState({ path: this.props.initialPath });\n\t\t}\n\t}\n}\n\nexport default PresetSelect;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Button from 'react-bootstrap/Button';\nimport Close from 'mdi-react/CloseIcon';\nimport GeometryTypeSelect from '../../common/GeometryTypeSelect';\nimport I18n from '../../../config/locales/ui';\nimport PresetSelect from '../../common/PresetSelect';\nimport PubSub from 'pubsub-js';\n\n/**\n * Create feature pane allows user to choose the kind of feature to create.\n */\nclass CreateFeaturePane extends Component {\n\trender() {\n\t\treturn <div>\n\t\t\t<h3 className=\"m-2\">{I18n.t(\"Add features\")}</h3>\n\n\t\t\t{!this.props.preset &&\n\t\t\t\t<PresetSelect\n\t\t\t\t\tkey={1}\n\t\t\t\t\tclassName=\"m-2\"\n\t\t\t\t\tlastUsedPresets={this.props.lastUsedPresets}\n\t\t\t\t\tonSelect={p => PubSub.publish(\"body.select.preset\", { preset: p })}\n\t\t\t\t/>\n\t\t\t}\n\n\t\t\t{this.props.preset && !this.props.draw &&\n\t\t\t\t<div className=\"m-2\">\n\t\t\t\t\t<p>\n\t\t\t\t\t\t{I18n.t(\"Please select how you want to represent your feature.\")}\n\t\t\t\t\t</p>\n\t\t\t\t\t<GeometryTypeSelect\n\t\t\t\t\t\ttypes={this.props.preset.type}\n\t\t\t\t\t\tonClick={type => PubSub.publish(\"body.select.preset\", { preset: this.props.preset, type: type })}\n\t\t\t\t\t/>\n\t\t\t\t\t<Button\n\t\t\t\t\t\tvariant=\"outline-danger\"\n\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.select.preset\", { preset: null })}\n\t\t\t\t\t\tblock\n\t\t\t\t\t>\n\t\t\t\t\t\t<Close /> {I18n.t(\"Cancel\")}\n\t\t\t\t\t</Button>\n\t\t\t\t</div>\n\t\t\t}\n\n\t\t\t{this.props.preset && this.props.draw &&\n\t\t\t\t<div className=\"m-2\">\n\t\t\t\t\t<p>{I18n.t(\"You can draw your feature on the map. Click on done button or click again on last node you created to finish.\")}</p>\n\t\t\t\t</div>\n\t\t\t}\n\t\t</div>;\n\t}\n}\n\nexport default CreateFeaturePane;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Body from '../../Body';\nimport Button from 'react-bootstrap/Button';\nimport Check from 'mdi-react/CheckIcon';\nimport Col from 'react-bootstrap/Col';\nimport Container from 'react-bootstrap/Container';\nimport History from 'mdi-react/HistoryIcon';\nimport I18n from '../../../config/locales/ui';\nimport PresetCard from '../../common/PresetCard';\nimport PresetInputField from '../../common/PresetInputField';\nimport PresetSelect from '../../common/PresetSelect';\nimport PubSub from 'pubsub-js';\nimport Row from 'react-bootstrap/Row';\nimport Tab from 'react-bootstrap/Tab';\nimport Tabs from 'react-bootstrap/Tabs';\nimport TagsTable from '../../common/TagsTable';\n\nconst GEOM_TO_OSM = { \"Point\": \"node\", \"LineString\": \"way\", \"Polygon\": \"closedway\", \"MultiPolygon\": \"closedway\" };\n\n/**\n * Edit feature pane allows user to change one feature description\n */\nclass EditFeaturePane extends Component {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.state = {\n\t\t\ttab: \"functional\",\n\t\t\tshowPresetSelect: false\n\t\t};\n\t}\n\n\t/**\n\t * Event handler when \"Done\" button is clicked\n\t * @private\n\t */\n\t_onDone() {\n\t\tPubSub.publish(\"body.mode.set\", { mode: this.props.mode });\n\t}\n\n\t/**\n\t * Transform a preset definition into components\n\t * @private\n\t */\n\t_presetToComponent(p) {\n\t\tlet res = [];\n\n\t\tif(!p) { return res; }\n\n\t\tlet showLevel = p.showLevel;\n\n\t\tif(p.combos) {\n\t\t\tres = res.concat(p.combos.map((c,i) => <PresetInputField type=\"combo\" data={c} tags={this.props.feature.properties.tags} key={\"c\"+i} />));\n\t\t}\n\t\tif(p.texts) {\n\t\t\tres = res.concat(p.texts.map((t,i) => <PresetInputField type=\"text\" data={t} tags={this.props.feature.properties.tags} key={\"t\"+i} />));\n\t\t}\n\t\tif(p.multiselects) {\n\t\t\tres = res.concat(\n\t\t\t\tp.multiselects\n\t\t\t\t.filter(m => {\n\t\t\t\t\tif(m.key === \"level\") {\n\t\t\t\t\t\tshowLevel = true;\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\telse { return true; }\n\t\t\t\t})\n\t\t\t\t.map((m,i) => <PresetInputField type=\"multiselect\" data={m} tags={this.props.feature.properties.tags} key={\"m\"+i} />)\n\t\t\t);\n\t\t}\n\t\tif(p.checks) {\n\t\t\tres = res.concat(p.checks.map((ch,i) => <PresetInputField type=\"check\" data={ch} tags={this.props.feature.properties.tags} key={\"ch\"+i} />));\n\t\t}\n\t\tif(p.optionals) {\n\t\t\tres = res.concat(this._presetToComponent(p.optionals));\n\t\t}\n\n\t\t// Add level field\n\t\tif(showLevel) {\n\t\t\t// List available levels\n\t\t\tlet levels = (this.props.feature.properties.own && this.props.feature.properties.own.levels) || [-5,-4,-3,-2,-1,0,1,2,3,4,5];\n\t\t\tif(this.props.building && this.props.building.properties.own && this.props.building.properties.own.levels) {\n\t\t\t\tlevels = levels.concat(this.props.building.properties.own.levels);\n\t\t\t}\n\t\t\tconst mytags = Object.assign({}, this.props.feature.properties.tags, { level: this.props.feature.properties.own.levels.join(\";\") });\n\t\t\tdelete mytags.repeat_on;\n\n\t\t\t// Create input\n\t\t\tres.push(<PresetInputField\n\t\t\t\ttype=\"multiselect\"\n\t\t\t\tdata={{\n\t\t\t\t\tkey: \"level\",\n\t\t\t\t\ttext: I18n.t(\"Floors served\"),\n\t\t\t\t\tvalues: [...new Set(levels)].map(a => parseFloat(a)).sort((a,b) => a-b).join(\";\")\n\t\t\t\t}}\n\t\t\t\ttags={mytags}\n\t\t\t\tkey={\"lvl\"}\n\t\t\t/>);\n\t\t}\n\n\t\treturn res;\n\t}\n\n\t/**\n\t * Merge and deduplicate presets fields\n\t * @private\n\t */\n\t_combinePresets(presets) {\n\t\tconst result = {\n\t\t\tname: Body.GetFeatureName(this.props.feature, [...new Set(presets.map(p => p.name))].join(\", \"))\n\t\t};\n\n\t\tconst usedKeys = [];\n\n\t\tpresets.forEach(p => {\n\t\t\tObject.entries(p).forEach(e => {\n\t\t\t\tconst [pk,pv] = e;\n\n\t\t\t\tif(pk === \"type\") {\n\t\t\t\t\tif(!result.type) { result.type = []; }\n\n\t\t\t\t\tresult.type = [...new Set(result.type.concat(pv))];\n\t\t\t\t}\n\t\t\t\telse if(Array.isArray(pv)) {\n\t\t\t\t\tif(!result[pk]) { result[pk] = []; }\n\n\t\t\t\t\tpv.forEach(v => {\n\t\t\t\t\t\tif(!usedKeys.includes(v.key)) {\n\t\t\t\t\t\t\tresult[pk].push(v);\n\t\t\t\t\t\t\tusedKeys.push(v.key);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\telse if(pk === \"tags\") {\n\t\t\t\t\tif(!result.tags) { result.tags = {}; }\n\n\t\t\t\t\tresult.tags = Object.assign({}, result.tags, pv);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * @private\n\t */\n\t_lookForPreset() {\n\t\tthis.setState({ showPresetSelect: true });\n\t}\n\n\t/**\n\t * @private\n\t */\n\t_onChangePreset(prev, next) {\n\t\tif(next && this.props.feature) {\n\t\t\tlet newTags = Object.assign({}, this.props.feature.properties.tags);\n\n\t\t\t// Remove hard tags from previous preset\n\t\t\tif(prev && prev.tags) {\n\t\t\t\tObject.keys(prev.tags).forEach(k => delete newTags[k]);\n\t\t\t}\n\n\t\t\t// Add hard tags from new preset\n\t\t\tif(next.tags) {\n\t\t\t\tnewTags = Object.assign(newTags, next.tags);\n\t\t\t}\n\n\t\t\tPubSub.publish(\"body.tags.set\", { tags: newTags });\n\t\t}\n\n\t\tthis.setState({ showPresetSelect: false });\n\t}\n\n\trender() {\n\t\tif(!this.props.feature) { return <div></div>; }\n\n\t\tconst feature = this.props.feature;\n\t\tconst tags = feature.properties.tags;\n\t\tlet mightBeStructure = [\"Polygon\",\"MultiPolygon\"].includes(feature.geometry.type);\n\t\tconst presets = window.presetsManager.findPresetsForFeature(feature);\n\t\tconst globalPreset = this._combinePresets(presets);\n\n\t\t// Find functional presets (not structural ones)\n\t\tlet functionalPreset = presets.filter(p => !p.indoor_structure || p.indoor_structure === \"no\");\n\t\tif(functionalPreset.length > 0) { functionalPreset = functionalPreset[functionalPreset.length-1]; }\n\t\telse { functionalPreset = null; }\n\n\t\t// Find structural presets (room, area, corridor...)\n\t\tlet structurePreset = presets.filter(p => [\"only\", \"yes\"].includes(p.indoor_structure));\n\t\tif(structurePreset.length > 0) { structurePreset = structurePreset[structurePreset.length-1]; }\n\t\telse { structurePreset = null; }\n\n\t\t// Tabs management\n\t\tthis._tabFunDisabled = structurePreset && structurePreset.indoor_structure === \"only\";\n\t\tthis._tabStrDisabled = !mightBeStructure || (functionalPreset && functionalPreset.indoor_structure === \"no\");\n\t\tthis._hasFunPreset = functionalPreset !== null && functionalPreset !== undefined;\n\t\tthis._hasStrPreset = structurePreset !== null && structurePreset !== undefined;\n\n\t\tconst tabShown = this.state.tab === \"functional\" && !this._tabFunDisabled ? \"functional\" : \"structural\";\n\n\t\treturn <div>\n\t\t\t<Container className=\"m-0 pl-2 pr-2 mt-2\">\n\t\t\t\t<Row className=\"d-flex align-items-top justify-content-between\">\n\t\t\t\t\t<Col>\n\t\t\t\t\t\t<h3 className=\"m-0 p-0\">{Body.GetFeatureName(feature)}</h3>\n\t\t\t\t\t</Col>\n\n\t\t\t\t\t<Col className=\"text-right\">\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\ttitle={I18n.t(\"Done\")}\n\t\t\t\t\t\t\tonClick={() => this._onDone()}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Check />\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</Col>\n\t\t\t\t</Row>\n\t\t\t</Container>\n\n\t\t\t<div className=\"m-2\">\n\t\t\t\t<Tabs\n\t\t\t\t\tactiveKey={tabShown}\n\t\t\t\t\tid=\"preset-tabs\"\n\t\t\t\t\tclassName=\"mb-2\"\n\t\t\t\t\tonSelect={k => this.setState({ showPresetSelect: false, tab: k })}\n\t\t\t\t>\n\t\t\t\t\t<Tab\n\t\t\t\t\t\teventKey=\"functional\"\n\t\t\t\t\t\ttitle={I18n.t(\"Usage\")}\n\t\t\t\t\t\tdisabled={this._tabFunDisabled}\n\t\t\t\t\t>\n\t\t\t\t\t\t{!this.state.showPresetSelect &&\n\t\t\t\t\t\t\t<PresetCard\n\t\t\t\t\t\t\t\tpreset={mightBeStructure ? functionalPreset : globalPreset}\n\t\t\t\t\t\t\t\tonClick={this._lookForPreset.bind(this)}\n\t\t\t\t\t\t\t\tclassName=\"mb-2\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t{!this.state.showPresetSelect && this._presetToComponent(mightBeStructure ? functionalPreset : globalPreset)}\n\t\t\t\t\t</Tab>\n\n\t\t\t\t\t<Tab\n\t\t\t\t\t\teventKey=\"structural\"\n\t\t\t\t\t\ttitle={I18n.t(\"Structure\")}\n\t\t\t\t\t\tdisabled={this._tabStrDisabled}\n\t\t\t\t\t>\n\t\t\t\t\t\t{!this.state.showPresetSelect &&\n\t\t\t\t\t\t\t<PresetCard\n\t\t\t\t\t\t\t\tpreset={structurePreset}\n\t\t\t\t\t\t\t\tonClick={this._lookForPreset.bind(this)}\n\t\t\t\t\t\t\t\tclassName=\"mb-2\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t{!this.state.showPresetSelect && this._presetToComponent(structurePreset)}\n\t\t\t\t\t</Tab>\n\t\t\t\t</Tabs>\n\n\t\t\t\t{this.state.showPresetSelect &&\n\t\t\t\t\t<PresetSelect\n\t\t\t\t\t\tonSelect={preset => this._onChangePreset(tabShown === \"functional\" ? functionalPreset : structurePreset, preset)}\n\t\t\t\t\t\tonBack={() => this.setState({ showPresetSelect: false })}\n\t\t\t\t\t\tfilter={p => (\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t!p.type\n\t\t\t\t\t\t\t\t|| p.type.includes(GEOM_TO_OSM[feature.geometry.type])\n\t\t\t\t\t\t\t) && (\n\t\t\t\t\t\t\t\ttabShown === \"functional\"\n\t\t\t\t\t\t\t\t|| [\"yes\",\"only\"].includes(p.indoor_structure)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t)}\n\t\t\t\t\t/>\n\t\t\t\t}\n\n\t\t\t\t{!this.state.showPresetSelect &&\n\t\t\t\t\t<TagsTable\n\t\t\t\t\t\tclassName=\"mt-3\"\n\t\t\t\t\t\ttags={tags}\n\t\t\t\t\t/>\n\t\t\t\t}\n\n\t\t\t\t{!this.state.showPresetSelect && (!feature.properties.own || !feature.properties.own.new) &&\n\t\t\t\t\t<Button\n\t\t\t\t\t\tclassName=\"mb-3 mt-3\"\n\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\tblock\n\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\thref={window.CONFIG.osm_api_url+\"/\"+feature.id+\"/history\"}\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<History size={20} /> {I18n.t(\"See feature history on OpenStreetMap\")}\n\t\t\t\t\t</Button>\n\t\t\t\t}\n\t\t\t</div>\n\t\t</div>;\n\t}\n\n\tcomponentDidMount() {\n\t\tif(this.props.feature) {\n\t\t\tconst newTabVal =\n\t\t\t\t(this._tabFunDisabled && !this._tabStrDisabled)\n\t\t\t\t|| (!this._tabFunDisabled && !this._tabStrDisabled && !this._hasFunPreset && this._hasStrPreset) ?\n\t\t\t\t\t\"structural\"\n\t\t\t\t\t: \"functional\";\n\n\t\t\tif(newTabVal !== this.state.tab) {\n\t\t\t\tthis.setState({ tab: newTabVal });\n\t\t\t}\n\t\t}\n\t}\n\n\tcomponentDidUpdate(prevProps) {\n\t\tif(prevProps.feature && this.props.feature && prevProps.feature.id !== this.props.feature.id) {\n\t\t\tconst newState = { showPresetSelect: false };\n\t\t\tconst newTabVal =\n\t\t\t\t(this._tabFunDisabled && !this._tabStrDisabled)\n\t\t\t\t|| (!this._tabFunDisabled && !this._tabStrDisabled && !this._hasFunPreset && this._hasStrPreset) ?\n\t\t\t\t\t\"structural\"\n\t\t\t\t\t: \"functional\";\n\n\t\t\tif(newTabVal !== this.state.tab) {\n\t\t\t\tnewState.tab = newTabVal;\n\t\t\t}\n\n\t\t\tthis.setState(newState);\n\t\t}\n\t}\n}\n\nexport default EditFeaturePane;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Body from '../../Body';\nimport Button from 'react-bootstrap/Button';\nimport Check from 'mdi-react/CheckIcon';\nimport Col from 'react-bootstrap/Col';\nimport Container from 'react-bootstrap/Container';\nimport History from 'mdi-react/HistoryIcon';\nimport I18n from '../../../config/locales/ui';\nimport Pencil from 'mdi-react/PencilIcon';\nimport PubSub from 'pubsub-js';\nimport Row from 'react-bootstrap/Row';\nimport TagsTable from '../../common/TagsTable';\n\n/**\n * Edit feature pane allows user to change one feature description\n */\nclass ViewFeaturePane extends Component {\n\t_onEdit() {\n\t\tif(this.props.feature && this.props.feature.properties.tags) {\n\t\t\tconst t = this.props.feature.properties.tags;\n\n\t\t\tif(t.building) {\n\t\t\t\tPubSub.publishSync(\"body.mode.set\", { mode: Body.MODE_BUILDING });\n\t\t\t\tPubSub.publishSync(\"body.select.building\", { building: this.props.feature });\n\t\t\t}\n\t\t\telse if(t.indoor === \"level\" && this.props.building) {\n\t\t\t\tPubSub.publishSync(\"body.mode.set\", { mode: Body.MODE_LEVELS });\n\t\t\t\tPubSub.publishSync(\"body.select.floor\", { floor: this.props.feature });\n\t\t\t}\n\t\t\telse if(this.props.building) {\n\t\t\t\tPubSub.publishSync(\"body.mode.set\", { mode: Body.MODE_FEATURES });\n\t\t\t\tPubSub.publishSync(\"body.select.feature\", { feature: this.props.feature });\n\t\t\t}\n\t\t}\n\t}\n\n\trender() {\n\t\tif(!this.props.feature) { return <div></div>; }\n\n\t\tconst feature = this.props.feature;\n\t\tconst tags = feature.properties.tags;\n\t\tconst presets = window.presetsManager.findPresetsForFeature(feature);\n\t\tconst name = Body.GetFeatureName(feature, [...new Set(presets.map(p => p.name))].join(\", \"))\n\n\t\treturn <div>\n\t\t\t<Container className=\"m-0 pl-2 pr-2 mt-2\">\n\t\t\t\t<Row className=\"d-flex align-items-top justify-content-between\">\n\t\t\t\t\t<Col>\n\t\t\t\t\t\t<h3 className=\"m-0 p-0\">{name}</h3>\n\t\t\t\t\t</Col>\n\n\t\t\t\t\t<Col className=\"text-right\">\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\ttitle={I18n.t(\"Done\")}\n\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.unselect.feature\")}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Check />\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</Col>\n\t\t\t\t</Row>\n\t\t\t</Container>\n\n\t\t\t<div className=\"m-2 mb-3\">\n\t\t\t\t{this.props.building &&\n\t\t\t\t\t<Button\n\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\tblock\n\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\tonClick={() => this._onEdit()}\n\t\t\t\t\t>\n\t\t\t\t\t\t<Pencil /> {I18n.t(\"Edit this feature\")}\n\t\t\t\t\t</Button>\n\t\t\t\t}\n\t\t\t</div>\n\n\t\t\t<div className=\"m-2\">\n\t\t\t\t<TagsTable\n\t\t\t\t\ttags={tags}\n\t\t\t\t\tlocked={true}\n\t\t\t\t/>\n\n\t\t\t\t{(!feature.properties.own || !feature.properties.own.new) &&\n\t\t\t\t\t<Button\n\t\t\t\t\t\tclassName=\"mb-3 mt-3\"\n\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\tblock\n\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\thref={window.CONFIG.osm_api_url+\"/\"+feature.id+\"/history\"}\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<History size={20} /> {I18n.t(\"See feature history on OpenStreetMap\")}\n\t\t\t\t\t</Button>\n\t\t\t\t}\n\t\t\t</div>\n\t\t</div>;\n\t}\n}\n\nexport default ViewFeaturePane;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport { LatLng } from 'leaflet';\nimport Dropzone from 'react-dropzone';\nimport Eye from 'mdi-react/EyeIcon';\nimport EyeOff from 'mdi-react/EyeOffIcon';\nimport Form from 'react-bootstrap/Form';\nimport FormControl from 'react-bootstrap/FormControl';\nimport Hash from 'object-hash';\nimport I18n from '../../config/locales/ui';\nimport InputGroup from 'react-bootstrap/InputGroup';\nimport ListGroup from 'react-bootstrap/ListGroup';\nimport PubSub from 'pubsub-js';\n\n/**\n * Floor imagery component handles editing of floor plans\n */\nclass FloorImageryPane extends Component {\n\t/**\n\t * Event handler for opacity change\n\t * @private\n\t */\n\t_onOpacityChanged(val) {\n\t\tPubSub.publish(\"body.imagery.opacity\", { opacity: parseInt(val)/100, type: \"floor\" });\n\t}\n\n\t/**\n\t * Event handler for floor plans being dropped\n\t * @private\n\t */\n\t_onDropImages(files) {\n\t\tif(files.length > 0) {\n\t\t\t// Full config file\n\t\t\tif(files.length === 1 && files[0].type === \"application/json\") {\n\t\t\t\t// Parse\n\t\t\t\tconst reader = new FileReader();\n\t\t\t\treader.onload = () => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst json = JSON.parse(reader.result);\n\n\t\t\t\t\t\tif(json && json.length > 0) {\n\t\t\t\t\t\t\tPubSub.publish(\"body.floorimagery.remove\");\n\n\t\t\t\t\t\t\tjson.forEach(e => {\n\t\t\t\t\t\t\t\tif(!e.image || !e.label || !e.id) {\n\t\t\t\t\t\t\t\t\tthrow new Error(\"Read data from JSON is missing information\");\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\te.topleft = new LatLng(e.topleft.lat, e.topleft.lng);\n\t\t\t\t\t\t\t\t\te.topright = new LatLng(e.topright.lat, e.topright.lng);\n\t\t\t\t\t\t\t\t\te.bottomleft = new LatLng(e.bottomleft.lat, e.bottomleft.lng);\n\t\t\t\t\t\t\t\t\te.level = parseFloat(e.level);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tPubSub.publish(\"body.floorimagery.add\", { imagery: json });\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcatch(e) { console.error(e); }\n\t\t\t\t};\n\t\t\t\treader.readAsText(files[0]);\n\t\t\t}\n\t\t\t// Classic images\n\t\t\telse {\n\t\t\t\t// Convert files into data URL\n\t\t\t\tPromise.all(\n\t\t\t\t\tfiles\n\t\t\t\t\t.filter(f => f.type.startsWith(\"image/\"))\n\t\t\t\t\t.map(f => new Promise(resolve => {\n\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\treader.onload = () => {\n\t\t\t\t\t\t\tresolve({\n\t\t\t\t\t\t\t\tlabel: f.name,\n\t\t\t\t\t\t\t\tlevel: null,\n\t\t\t\t\t\t\t\timage: reader.result,\n\t\t\t\t\t\t\t\tid: Hash(reader.result)\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t};\n\t\t\t\t\t\treader.readAsDataURL(f);\n\t\t\t\t\t}))\n\t\t\t\t)\n\t\t\t\t// Save loaded floors\n\t\t\t\t.then(res => PubSub.publish(\"body.floorimagery.add\", { imagery: res }));\n\t\t\t}\n\t\t}\n\t}\n\n\trender() {\n\t\tconst floorImgs = window.imageryManager.getFloorImages();\n\t\tconst selected = floorImgs && floorImgs.find(img => img.selected && img.visible);\n\n\t\tif(selected && selected.opacity === undefined) { selected.opacity = 1; }\n\n\t\treturn <div className=\"m-0 pl-2 pr-2 mt-2\">\n\t\t\t<h3 className=\"m-0 p-0\">{I18n.t(\"Floor plan\")}</h3>\n\n\t\t\t<Dropzone\n\t\t\t\taccept=\"image/jpeg, image/png, application/json\"\n\t\t\t\tonDrop={files => this._onDropImages(files)}\n\t\t\t>\n\t\t\t\t{({getRootProps, getInputProps}) => (\n\t\t\t\t\t<div className=\"dropzone m-0 mt-3 w-100\" {...getRootProps()}>\n\t\t\t\t\t\t<input {...getInputProps()} />\n\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t{I18n.t(\"Drag and drop your images here (or click to open file browser)\")}<br />\n\t\t\t\t\t\t\t<small>{I18n.t(\"Supported formats: JPEG, PNG, Imagery JSON\")}</small>\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</Dropzone>\n\n\t\t\t{selected &&\n\t\t\t\t<InputGroup className=\"mt-3\">\n\t\t\t\t\t<InputGroup.Prepend>\n\t\t\t\t\t\t<InputGroup.Text>{I18n.t(\"Opacity\")}</InputGroup.Text>\n\t\t\t\t\t</InputGroup.Prepend>\n\n\t\t\t\t\t<div className=\"form-control\" style={{flexGrow: 2}}>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"range\"\n\t\t\t\t\t\t\tmin=\"0\"\n\t\t\t\t\t\t\tmax=\"100\"\n\t\t\t\t\t\t\tstep=\"5\"\n\t\t\t\t\t\t\tonChange={v => this._onOpacityChanged(v.target.value)}\n\t\t\t\t\t\t\tvalue={selected.opacity*100}\n\t\t\t\t\t\t\tstyle={{maxWidth: \"100%\"}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<FormControl\n\t\t\t\t\t\ttype=\"number\"\n\t\t\t\t\t\tmin=\"0\"\n\t\t\t\t\t\tmax=\"100\"\n\t\t\t\t\t\tonChange={v => this._onOpacityChanged(v.target.value)}\n\t\t\t\t\t\tvalue={(selected.opacity*100).toFixed(0)}\n\t\t\t\t\t/>\n\n\t\t\t\t\t<InputGroup.Append>\n\t\t\t\t\t\t<InputGroup.Text>%</InputGroup.Text>\n\t\t\t\t\t</InputGroup.Append>\n\t\t\t\t</InputGroup>\n\t\t\t}\n\n\t\t\t<ListGroup className=\"mt-3\" style={{width: \"100%\"}}>\n\t\t\t\t{floorImgs.map((f, i) => {\n\t\t\t\t\tconst showHideClick = evt => {\n\t\t\t\t\t\tevt.stopPropagation();\n\n\t\t\t\t\t\tPubSub.publish(\"body.floorimagery.update\", {\n\t\t\t\t\t\t\timagery: floorImgs.map(d => {\n\t\t\t\t\t\t\t\tconst newD = Object.assign({}, d);\n\t\t\t\t\t\t\t\tnewD.visible = d.id === f.id ? !d.visible : d.visible;\n\t\t\t\t\t\t\t\treturn newD;\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t});\n\t\t\t\t\t};\n\n\t\t\t\t\treturn <ListGroup.Item\n\t\t\t\t\t\tkey={i}\n\t\t\t\t\t\tstyle={{display: \"flex\", alignItems: \"center\", paddingLeft: \"0.5rem\"}}\n\t\t\t\t\t\tactive={f.selected}\n\t\t\t\t\t\tonClick={() => {\n\t\t\t\t\t\t\tPubSub.publish(\"body.floorimagery.update\", {\n\t\t\t\t\t\t\t\timagery: floorImgs.map(d => {\n\t\t\t\t\t\t\t\t\tconst newD = Object.assign({}, d);\n\t\t\t\t\t\t\t\t\tnewD.selected = d.id === f.id ? true : false;\n\t\t\t\t\t\t\t\t\treturn newD;\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tif(!this.props.floorImageryMode) { PubSub.publish(\"body.floorimagery.mode\", { mode: \"scale\" }); }\n\t\t\t\t\t\t}}\n\t\t\t\t\t>\n\t\t\t\t\t\t{f.visible ?\n\t\t\t\t\t\t\t<Eye size={28} onClick={e => showHideClick(e)} />\n\t\t\t\t\t\t\t:\n\t\t\t\t\t\t\t<EyeOff size={28} onClick={e => showHideClick(e)} />\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t<img src={f.image} style={{width: 30, height: 30, margin: \"0 5px\", border: \"1px solid #ccc\" }} alt=\"\" />\n\n\t\t\t\t\t\t{f.label.substring(0, f.label.lastIndexOf(\".\"))}\n\n\t\t\t\t\t\t<Form.Control\n\t\t\t\t\t\t\ttype=\"number\"\n\t\t\t\t\t\t\tplaceholder={I18n.t(\"Level\")}\n\t\t\t\t\t\t\tvalue={f.level === null || isNaN(f.level) ? \"\" : f.level}\n\t\t\t\t\t\t\tstep=\"any\"\n\t\t\t\t\t\t\tonChange={e => PubSub.publish(\"body.floorimagery.update\", {\n\t\t\t\t\t\t\t\timagery: [ Object.assign({}, f, { level: parseFloat(e.target.value) }) ]\n\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\tstyle={{width: 80, display: \"inline-block\", position: \"absolute\", right: 5}}\n\t\t\t\t\t\t\trequired\n\t\t\t\t\t\t\tisInvalid={f.level === null || isNaN(f.level)}\n\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t<Form.Control.Feedback type=\"invalid\" style={f.selected ? { color: \"white\" } : {}}>\n\t\t\t\t\t\t\t{I18n.t(\"Please choose a level\")}\n\t\t\t\t\t\t</Form.Control.Feedback>\n\t\t\t\t\t</ListGroup.Item>;\n\t\t\t\t})}\n\t\t\t</ListGroup>\n\t\t</div>;\n\t}\n}\n\nexport default FloorImageryPane;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Body from '../../Body';\nimport Button from 'react-bootstrap/Button';\nimport Check from 'mdi-react/CheckIcon';\nimport ContentDuplicate from 'mdi-react/ContentDuplicateIcon';\nimport I18n from '../../../config/locales/ui';\nimport InputGroup from 'react-bootstrap/InputGroup';\nimport Form from 'react-bootstrap/Form';\nimport PubSub from 'pubsub-js';\nimport ShapePolygonPlus from 'mdi-react/ShapePolygonPlusIcon';\nimport SquareEditOutline from 'mdi-react/SquareEditOutlineIcon';\n\n/**\n * EditAllLevels pane allows to select and create levels in a given building.\n */\nclass EditAllLevelsPane extends Component {\n\t/**\n\t * Event handler for click on \"Create using floor outline\" button\n\t * @private\n\t */\n\t_editWithoutFloorContour() {\n\t\tPubSub.publish(\"body.select.floor\", { floor: this.props.building });\n\t\tPubSub.publish(\"body.mode.set\", { mode: Body.MODE_FEATURES });\n\t}\n\n\trender() {\n\t\tif(!this.props.building) { return <div></div>; }\n\n\t\tconst floorParts = window.vectorDataManager.getLevelFootprint(this.props.building, this.props.level || 0);\n\t\tconst levelsForCopy = window.vectorDataManager.getCopiableLevels(this.props.building).filter(lvl => lvl !== this.props.level);\n\t\tlevelsForCopy.reverse();\n\n\t\treturn <div className=\"m-0 pl-2 pr-2 mt-2\">\n\t\t\t<h3 className=\"m-0 mb-2 p-0\">{I18n.t(\"Level %{lvl}\", { lvl: this.props.level })}</h3>\n\n\t\t\t{this.props.draw &&\n\t\t\t\t<p>{I18n.t(\"You can draw your feature on the map. Click on done button or click again on last node you created to finish.\")}</p>\n\t\t\t}\n\n\t\t\t{!this.props.draw && !this.props.floor && floorParts.length > 0 &&\n\t\t\t\t<p>{I18n.t(\"Please select the floor part to edit using the map.\")}</p>\n\t\t\t}\n\n\t\t\t{!this.props.draw && !this.props.floor && floorParts.length === 0 && [\n\t\t\t\t<p className=\"m-0\" key={0}>{I18n.t(\"This level doesn't have a precise floor outline defined yet.\")}</p>\n\t\t\t\t,\n\t\t\t\t<Button\n\t\t\t\t\tvariant=\"outline-primary\"\n\t\t\t\t\tclassName=\"mt-2 w-100\"\n\t\t\t\t\tkey={1}\n\t\t\t\t\tonClick={() => PubSub.publish(\"body.create.floor\", { feature: this.props.building })}\n\t\t\t\t>\n\t\t\t\t\t<ShapePolygonPlus /> {I18n.t(\"Use the whole building footprint\")}\n\t\t\t\t</Button>\n\t\t\t\t,\n\t\t\t\t<Button\n\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\tclassName=\"mt-2 w-100\"\n\t\t\t\t\tkey={2}\n\t\t\t\t\tonClick={() => PubSub.publish(\"body.draw.floor\")}\n\t\t\t\t>\n\t\t\t\t\t<SquareEditOutline /> {I18n.t(\"Draw this floor outline\")}\n\t\t\t\t</Button>\n\t\t\t]}\n\n\t\t\t{!this.props.draw && !this.props.floor && floorParts.length === 0 && levelsForCopy.length > 0 &&\n\t\t\t\t<InputGroup\n\t\t\t\t\tclassName=\"mt-2 w-100\"\n\t\t\t\t>\n\t\t\t\t\t<InputGroup.Prepend>\n\n\t\t\t\t\t\t<InputGroup.Text><ContentDuplicate size={18} /> {I18n.t(\"Copy level\")}</InputGroup.Text>\n\n\t\t\t\t\t</InputGroup.Prepend>\n\n\t\t\t\t\t<Form.Control as=\"select\" ref=\"levelSelect\">\n\n\t\t\t\t\t\t{levelsForCopy.map((lvl,i) => (\n\t\t\t\t\t\t\t<option key={i}>{lvl}</option>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</Form.Control>\n\n\t\t\t\t\t<InputGroup.Append>\n\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\t\ttitle={I18n.t(\"Copy selected level data in the current level\")}\n\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.level.copy\", { use: this.refs.levelSelect.value })}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Check size={18} />\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</InputGroup.Append>\n\t\t\t\t</InputGroup>\n\t\t\t}\n\t\t</div>;\n\t}\n}\n\nexport default EditAllLevelsPane;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Body from '../../Body';\nimport Button from 'react-bootstrap/Button';\nimport Check from 'mdi-react/CheckIcon';\nimport Col from 'react-bootstrap/Col';\nimport Container from 'react-bootstrap/Container';\nimport I18n from '../../../config/locales/ui';\nimport PresetInputField from '../../common/PresetInputField';\nimport PubSub from 'pubsub-js';\nimport Row from 'react-bootstrap/Row';\nimport TagsTable from '../../common/TagsTable';\n\n/**\n * EditOneLevel pane allows to change a level description.\n */\nclass EditOneLevelPane extends Component {\n\trender() {\n\t\tif(!this.props.floor) { return <div></div>; }\n\n\t\tconst imgHeight = <span>{I18n.t(\"Relative floor level height in meters\")}<img src='img/floor_height.jpg' style={{height: 200}} alt={I18n.t(\"Schema explaining how should be set level height\")} /></span>;\n\n\t\treturn <Container className=\"m-0 pl-2 pr-2 mt-2\">\n\t\t\t<Row className=\"d-flex align-items-top justify-content-between\">\n\t\t\t\t<Col>\n\t\t\t\t\t<h3 className=\"m-0 p-0\">{Body.GetFeatureName(this.props.floor)}</h3>\n\t\t\t\t</Col>\n\n\t\t\t\t<Col className=\"text-right\">\n\t\t\t\t\t<Button\n\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\ttitle={I18n.t(\"Done\")}\n\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.unselect.feature\")}\n\t\t\t\t\t>\n\t\t\t\t\t\t<Check />\n\t\t\t\t\t</Button>\n\t\t\t\t</Col>\n\t\t\t</Row>\n\t\t\t<Row className=\"mt-2\">\n\t\t\t\t<Col className=\"m-0 p-2\">\n\t\t\t\t\t<div className=\"m-2 mb-4\">\n\t\t\t\t\t\t<PresetInputField\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tdata={{ text: I18n.t(\"Name\"), key: \"name\" }}\n\t\t\t\t\t\t\ttags={this.props.floor.properties.tags}\n\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t<PresetInputField\n\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\tdata={{ text: I18n.t(\"Height (in meters)\"), key: \"height\", info: imgHeight }}\n\t\t\t\t\t\t\ttags={this.props.floor.properties.tags}\n\t\t\t\t\t\t/>\n\n\t\t\t\t\t\t<PresetInputField\n\t\t\t\t\t\t\ttype=\"check\"\n\t\t\t\t\t\t\tdata={{ text: I18n.t(\"Surrounded by walls\"), key: \"wall\" }}\n\t\t\t\t\t\t\ttags={this.props.floor.properties.tags}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div className=\"m-2\">\n\t\t\t\t\t\t<TagsTable\n\t\t\t\t\t\t\ttags={this.props.floor.properties.tags}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</Col>\n\t\t\t</Row>\n\t\t</Container>;\n\t}\n}\n\nexport default EditOneLevelPane;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport BuildingEdit from './panes/BuildingEdit';\nimport Changeset from './panes/Changeset';\nimport FeatureCreate from './panes/features/Create';\nimport FeatureEdit from './panes/features/Edit';\nimport FeatureView from './panes/features/View';\nimport FloorImagery from './panes/FloorImagery';\nimport LevelsEditAll from './panes/levels/EditAll';\nimport LevelsEditOne from './panes/levels/EditOne';\n\n/**\n * Left panel component handles everything being on the left of the map.\n * It manages mainly places search, various feature editing.\n */\nclass LeftPanel extends Component {\n\t/** ID for building edit pane **/\n\tstatic PANE_BUILDING_EDIT = 1;\n\n\t/** ID for adding new levels contour pane **/\n\tstatic PANE_LEVELS_ADD = 2;\n\n\t/** ID for all levels edit pane **/\n\tstatic PANE_LEVELS_EDIT = 3;\n\n\t/** ID for new feature pane **/\n\tstatic PANE_FEATURE_ADD = 4;\n\n\t/** ID for feature edit pane **/\n\tstatic PANE_FEATURE_EDIT = 5;\n\n\t/** ID for feature view pane **/\n\tstatic PANE_FEATURE_VIEW = 6;\n\n\t/** ID for review changeset pane **/\n\tstatic PANE_CHANGESET = 7;\n\n\t/** ID for floor imagery pane **/\n\tstatic PANE_FLOOR_IMAGERY = 8;\n\n\trender() {\n\t\tlet component;\n\n\t\tswitch(this.props.pane) {\n\t\t\tcase LeftPanel.PANE_BUILDING_EDIT:\n\t\t\t\tcomponent = <BuildingEdit {...this.props} />;\n\t\t\t\tbreak;\n\n\t\t\tcase LeftPanel.PANE_LEVELS_ADD:\n\t\t\t\tcomponent = <LevelsEditAll {...this.props} />;\n\t\t\t\tbreak;\n\n\t\t\tcase LeftPanel.PANE_LEVELS_EDIT:\n\t\t\t\tcomponent = <LevelsEditOne {...this.props} />;\n\t\t\t\tbreak;\n\n\t\t\tcase LeftPanel.PANE_FEATURE_ADD:\n\t\t\t\tcomponent = <FeatureCreate {...this.props} />;\n\t\t\t\tbreak;\n\n\t\t\tcase LeftPanel.PANE_FEATURE_EDIT:\n\t\t\t\tcomponent = <FeatureEdit {...this.props} />;\n\t\t\t\tbreak;\n\n\t\t\tcase LeftPanel.PANE_FEATURE_VIEW:\n\t\t\t\tcomponent = <FeatureView {...this.props} />;\n\t\t\t\tbreak;\n\n\t\t\tcase LeftPanel.PANE_CHANGESET:\n\t\t\t\tcomponent = <Changeset {...this.props} />;\n\t\t\t\tbreak;\n\n\t\t\tcase LeftPanel.PANE_FLOOR_IMAGERY:\n\t\t\t\tcomponent = <FloorImagery {...this.props} />;\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tcomponent = <div></div>;\n\t\t}\n\n\t\treturn component;\n\t}\n}\n\nexport default LeftPanel;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Button from 'react-bootstrap/Button';\nimport I18n from '../../config/locales/ui';\nimport Modal from 'react-bootstrap/Modal';\n\n/**\n * Login dialog asks user to login or create account on OSM.org before editing.\n */\nclass LoginDialog extends Component {\n\trender() {\n\t\tconst canClose = !window.CONFIG.always_authenticated;\n\n\t\treturn <Modal show={this.props.show} onHide={this.props.onClose} style={{zIndex: 20010}}>\n\t\t\t<Modal.Header closeButton={canClose}>\n\t\t\t\t<Modal.Title>{I18n.t(\"Login or create account\")}</Modal.Title>\n\t\t\t</Modal.Header>\n\n\t\t\t<Modal.Body>\n\t\t\t\t{window.CONFIG.always_authenticated ?\n\t\t\t\t\tI18n.t(\"To view and edit map data, you need to connect first using an OpenStreetMap account.\")\n\t\t\t\t\t: I18n.t(\"To edit map data, you need to connect first using an OpenStreetMap account.\")\n\t\t\t\t}\n\t\t\t</Modal.Body>\n\n\t\t\t<Modal.Footer>\n\t\t\t\t{canClose &&\n\t\t\t\t\t<Button variant=\"secondary\" onClick={this.props.onClose}>\n\t\t\t\t\t\t{I18n.t(\"Cancel\")}\n\t\t\t\t\t</Button>\n\t\t\t\t}\n\n\t\t\t\t<Button variant=\"primary\" onClick={this.props.onLogin}>\n\t\t\t\t\t{I18n.t(\"Login or create account\")}\n\t\t\t\t</Button>\n\t\t\t</Modal.Footer>\n\t\t</Modal>;\n\t}\n}\n\nexport default LoginDialog;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Editable from './Editable';\nimport { GeoJSON } from 'react-leaflet';\nimport PubSub from 'pubsub-js';\n\n/**\n * Building layer allows to show OSM data for building contours.\n */\nclass BuildingLayer extends Component {\n\trender() {\n\t\tconst data = window.vectorDataManager.getOSMBuildings(this.props.level);\n\n\t\tif(this.props.locked) {\n\t\t\treturn <GeoJSON\n\t\t\t\tdata={data}\n\t\t\t\tstyle={{ color: \"purple\", fillColor: \"black\", opacity: 0.5, fillOpacity: 0.2 }}\n\t\t\t/>;\n\t\t}\n\t\telse {\n\t\t\treturn <Editable\n\t\t\t\tdata={data}\n\t\t\t\tonFeatureClick={feature => PubSub.publish(\"body.select.building\", { building: feature })}\n\t\t\t\tselection={this.props.building}\n\t\t\t\tstyler={this.props.styler}\n\t\t\t\tdraw={this.props.draw}\n\t\t\t/>;\n\t\t}\n\t}\n}\n\nexport default BuildingLayer;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport { Path, withLeaflet } from 'react-leaflet';\nimport { CircleMarker, GeoJSON, Icon, LayerGroup, Marker, Polygon, Polyline } from 'leaflet';\nimport deepEqual from 'fast-deep-equal';\nimport PubSub from 'pubsub-js';\n\nconst existingIcons = {};\n\n// Icon handling load errors\nconst MyIcon = Icon.extend({\n\t_createImg: function (src, el) {\n\t\tel = el || document.createElement('img');\n\t\tel.src = src;\n\t\tel.onerror = () => {\n\t\t\twindow.UNUSABLE_ICONS.add(el.src);\n\t\t\tel.style.display='none';\n\t\t};\n\t\treturn el;\n\t}\n});\n\n/**\n * Styled layer is an extension of GeoJSON layer in order to manage advanced styling of geometries.\n *\n * @property {MapStyler} [styler] The map styler\n */\nclass StyledLayer extends Path {\n\tcreateLeafletElement(props) {\n\t\t// Add some defaults\n\t\tconst thatStyler = props.styler.getFeatureStyle.bind(props.styler);\n\t\tconst myprops = Object.assign({}, {\n\t\t\tpointToLayer: (feature, latlng) => {\n\t\t\t\tconst marker = new CircleMarker(latlng, thatStyler(feature));\n\t\t\t\treturn marker;\n\t\t\t},\n\t\t\tonFeatureClick: (() => {}),\n\t\t\tonEachFeature: (feature, layer) => {\n\t\t\t\tlayer.on(\"click\", () => {\n\t\t\t\t\tPubSub.publish(\"body.select.feature\", { feature: feature });\n\t\t\t\t});\n\t\t\t},\n\t\t\tstyle: thatStyler\n\t\t}, props);\n\n\t\t// Create the GeoJSON layer\n\t\tconst lGeojson = this._populateLayer(new GeoJSON(null, this.getOptions(myprops)), myprops);\n\n\t\treturn lGeojson;\n\t}\n\n\tcomponentDidMount() {\n\t\tsuper.componentDidMount();\n\n\t\tthis._sortFeaturesZIndex(this.leafletElement);\n\t}\n\n\tupdateLeafletElement(fromProps, toProps) {\n\t\t// Add style property according to styler\n\t\tif(!toProps.style) {\n\t\t\ttoProps = Object.assign({}, toProps, { style: toProps.styler.getFeatureStyle.bind(toProps.styler) });\n\t\t}\n\n\t\t//Style\n\t\tif(fromProps.styler !== toProps.styler) {\n\t\t\tthis.setStyle(toProps.style);\n\t\t}\n\t\telse {\n\t\t\tthis.setStyleIfChanged(fromProps, toProps);\n\t\t}\n\n\t\t//Data\n\t\tif(\n\t\t\tfromProps.data !== toProps.data\n\t\t\t&& !deepEqual(fromProps.data, toProps.data)\n\t\t) {\n\t\t\tthis.leafletElement.clearLayers();\n\t\t\tthis._populateLayer(this.leafletElement, toProps);\n\t\t}\n\n\t\tthis._sortFeaturesZIndex(this.leafletElement);\n\t}\n\n\t/**\n\t * Sort features by size and type\n\t * @private\n\t */\n\t_sortFeaturesZIndex(layer) {\n\t\t// First, lines\n\t\tlayer.eachLayer(l => {\n\t\t\tif(l.feature && l instanceof Polyline && !(l instanceof Polygon)) {\n\t\t\t\tl.bringToFront();\n\t\t\t}\n\t\t});\n\t\t// Last, nodes\n\t\tlayer.eachLayer(l => {\n\t\t\tif(l.feature && l.feature.id.startsWith(\"node/\")) {\n\t\t\t\tl.bringToFront();\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Add icons of features\n\t * @private\n\t */\n\t_addIcons(layer) {\n\t\tif(this._featureIcons && layer.hasLayer(this._featureIcons)) {\n\t\t\tlayer.removeLayer(this._featureIcons);\n\t\t}\n\n\t\tthis._featureIcons = new LayerGroup();\n\n\t\tconst featuresWithIcons = layer.getLayers().filter(l => l.options && l.options.iconImage && (!this.props.selection || l.feature.id !== this.props.selection.id));\n\t\tconst iconSize = 20;\n\n\t\tfeaturesWithIcons.forEach(l => {\n\t\t\tconst iconUrl = window.EDITOR_URL + \"img/icons/\"+l.options.iconImage;\n\t\t\tconst coords = l.getLatLng ? l.getLatLng() : (l.getBounds ? l.getBounds().getCenter() : null);\n\n\t\t\tif(coords && !window.UNUSABLE_ICONS.has(iconUrl)) {\n\t\t\t\tlet icon = existingIcons[iconUrl];\n\n\t\t\t\tif(!icon) {\n\t\t\t\t\ticon = new MyIcon({\n\t\t\t\t\t\ticonUrl: iconUrl,\n\t\t\t\t\t\ticonSize: [iconSize,iconSize],\n\t\t\t\t\t\ticonAnchor: [iconSize/2,iconSize/2]\n\t\t\t\t\t});\n\t\t\t\t\texistingIcons[iconUrl] = icon;\n\t\t\t\t}\n\n\t\t\t\tthis._featureIcons.addLayer(new Marker(coords, { icon: icon, interactive: false }));\n\t\t\t}\n\t\t});\n\n\t\tlayer.addLayer(this._featureIcons);\n\t}\n\n\t/**\n\t * Load content into the leaflet layer\n\t * @private\n\t */\n\t_populateLayer(layer, props) {\n\t\tlayer.addData(props.data);\n\t\tthis._addIcons(layer);\n\t\treturn layer;\n\t}\n}\n\nexport default withLeaflet(StyledLayer);\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Editable from './Editable';\nimport PubSub from 'pubsub-js';\nimport Styled from './Styled';\n\n/**\n * Features layer allows to show OSM data of a specific floor\n */\nclass FeaturesLayer extends Component {\n\trender() {\n\t\tif(!this.props.locked) {\n\t\t\tconst geojson = window.vectorDataManager.getFeaturesInLevel(this.props.building, this.props.level);\n\t\t\tlet shadow = this.props.building;\n\n\t\t\t// Get level footprint\n\t\t\tif(shadow) {\n\t\t\t\tconst lvlFootprints = window.vectorDataManager.getLevelFootprint(this.props.building, this.props.level);\n\t\t\t\tshadow = { type: \"FeatureCollection\", features: lvlFootprints.concat(shadow) };\n\t\t\t}\n\n\t\t\treturn <Editable\n\t\t\t\tdata={geojson}\n\t\t\t\tshadowData={shadow}\n\t\t\t\tselection={this.props.feature}\n\t\t\t\tonFeatureClick={feature => PubSub.publish(\"body.select.feature\", { feature: feature })}\n\t\t\t\tstyler={this.props.styler}\n\t\t\t\tdraw={this.props.draw}\n\t\t\t\tallowVertexClick={true}\n\t\t\t\tallowFeatureDrag={true}\n\t\t\t\tkeepRoutingGraphConnected={true}\n\t\t\t\tlevel={this.props.level}\n\t\t\t/>;\n\t\t}\n\t\telse {\n\t\t\tconst geojson = window.vectorDataManager.getFeaturesInLevel(null, this.props.level);\n\t\t\tconst buildings = window.vectorDataManager.getOSMBuildings(this.props.level).features;\n\t\t\tgeojson.features = buildings.concat(geojson.features);\n\n\t\t\treturn <Styled\n\t\t\t\tdata={geojson}\n\t\t\t\tstyler={this.props.styler}\n\t\t\t\tlevel={this.props.level}\n\t\t\t/>;\n\t\t}\n\t}\n}\nexport default FeaturesLayer;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport L from 'leaflet'\nimport { MapLayer, withLeaflet } from 'react-leaflet';\nimport 'leaflet-toolbar';\nimport 'leaflet-distortableimage';\nimport 'leaflet-distortableimage/dist/leaflet.distortableimage.css';\nimport Body from '../Body';\nimport deepEqual from 'fast-deep-equal';\nimport PubSub from 'pubsub-js';\n\n\n// Fix for _scaleBy function and 0-sized images\nconst CORRESP_HANDLE = { 0: 3, 1: 2, 2: 1, 3: 0 };\n\nL.DistortableImage.Edit.include({\n\t_scaleBy: function(scale) {\n\t\tif(scale === Infinity || isNaN(scale) || scale === 0) {\n\t\t\tscale = 1;\n\t\t}\n\n\t\tlet overlay = this._overlay,\n\t\t\tmap = overlay._map,\n\t\t\tzoom = map.getZoom(),\n\t\t\tcenter = map.project(overlay.getCorner(CORRESP_HANDLE[this._lastDragUsed]), zoom),\n\t\t\ti,\n\t\t\tp;\n\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\tif(i !== CORRESP_HANDLE[this._lastDragUsed]) {\n\t\t\t\tp = map\n\t\t\t\t\t.project(overlay.getCorner(i), zoom)\n\t\t\t\t\t.subtract(center)\n\t\t\t\t\t.multiplyBy(scale)\n\t\t\t\t\t.add(center);\n\t\t\t\toverlay.setCorner(i, map.unproject(p, zoom));\n\t\t\t}\n\t\t}\n\n\t\toverlay._reset();\n\t},\n\n\t_rotateBy: function(angle) {\n\t\tvar overlay = this._overlay,\n\t\t\tmap = overlay._map,\n\t\t\tzoom = map.getZoom(),\n\t\t\tcenter = map.project(overlay.getCenter(), zoom),\n\t\t\ti,\n\t\t\tp,\n\t\t\tq;\n\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\tp = map.project(overlay.getCorner(i), zoom).subtract(center);\n\t\t\tq = L.point(\n\t\t\t\tMath.cos(angle) * p.x - Math.sin(angle) * p.y,\n\t\t\t\tMath.sin(angle) * p.x + Math.cos(angle) * p.y\n\t\t\t);\n\t\t\toverlay.setCorner(i, map.unproject(q.add(center), zoom));\n\t\t}\n\n\t\t// window.angle = L.TrigUtil.radiansToDegrees(angle);\n\n\t\tthis._overlay.rotation -= L.TrigUtil.radiansToDegrees(angle);\n\n\t\toverlay._reset();\n\t},\n\n\t_showMarkers: function() {\n\t\tif (this._mode === 'lock') { return; }\n\n\t\tvar currentHandle = this._handles[this._mode];\n\n\t\tlet i=0;\n\t\tcurrentHandle.eachLayer((layer) => {\n\t\t\tvar drag = layer.dragging,\n\t\t\t\topts = layer.options;\n\n\t\t\tlayer.setOpacity(1);\n\t\t\tif (drag) { drag.enable(); }\n\t\t\tif (opts.draggable) { opts.draggable = true; }\n\n\t\t\tconst myId = parseInt(i.toString());\n\n\t\t\tlayer.once(\"dragstart\", () => {\n\t\t\t\tthis._lastDragUsed = myId;\n\t\t\t});\n\n\t\t\ti++;\n\t\t});\n\t}\n});\n\nL.ScaleHandle.include({\n\t_calculateScalingFactor: function(latlngA, latlngB) {\n\t\tvar overlay = this._handled,\n\t\t\tmap = overlay._map,\n\n\t\tcenterPoint = map.latLngToLayerPoint(overlay.getCorner(CORRESP_HANDLE[this._corner])),\n\t\tformerPoint = map.latLngToLayerPoint(latlngA),\n\t\tnewPoint = map.latLngToLayerPoint(latlngB),\n\t\tformerRadiusSquared = this._d2(centerPoint, formerPoint),\n\t\tnewRadiusSquared = this._d2(centerPoint, newPoint);\n\n\t\treturn Math.sqrt(newRadiusSquared / formerRadiusSquared);\n\t}\n});\n\n\n/**\n * FloorImagery is a Leaflet layer allowing display of images, and their manipulation.\n */\nclass FloorImagery extends MapLayer {\n\tcreateLeafletElement(props) {\n\t\tconst img = L.distortableImageOverlay(\n\t\t\tprops.data.image,\n\t\t\t{\n\t\t\t\tselected: props.data.editing,\n\t\t\t\tcorners: [\n\t\t\t\t\tprops.data.topleft,\n\t\t\t\t\tprops.data.topright,\n\t\t\t\t\tprops.data.bottomleft,\n\t\t\t\t\tprops.data.bottomright ? props.data.bottomright : L.latLng(props.data.bottomleft.lat, props.data.topright.lng)\n\t\t\t\t],\n\t\t\t\tkeymapper: false,\n\t\t\t\tsuppressToolbar: true,\n\t\t\t\tmode: \"scale\"\n\t\t\t}\n\t\t);\n\n\t\treturn img;\n\t}\n\n\tcomponentDidMount() {\n\t\tsuper.componentDidMount();\n\t\tthis.leafletElement.setOpacity(this.props.opacity);\n\n\t\tthis.updateLeafletElement({ tool: \"scale\", data: {} }, this.props);\n\n\t\t// Look for dragend events to avoid too much floorimagery updates\n\t\tthis._onDragging(this.leafletElement, this.props);\n\n\t\t// Check if image is still selected\n\t\tthis._checkSelect = setInterval(() => {\n\t\t\tif(this.props.mode === Body.MODE_FLOOR_IMAGERY && this.props.data.selected && this.props.tool && this.props.data.visible) {\n\t\t\t\tif(!this.leafletElement.editing.enabled()) {\n\t\t\t\t\tthis.leafletElement.editing.enable();\n\t\t\t\t}\n\t\t\t\tif(!this.leafletElement.editing._selected) {\n\t\t\t\t\tthis.leafletElement.editing._select();\n\t\t\t\t}\n\t\t\t}\n\t\t}, 100);\n\t}\n\n\t_onDragEnd(elem, props) {\n\t\treturn () => {\n\t\t\tif(this._timerDragend) {\n\t\t\t\tclearTimeout(this._timerDragend);\n\t\t\t}\n\t\t\tthis._timerDragend = setTimeout(() => {\n\t\t\t\tconst crns = elem.getCorners();\n\t\t\t\tPubSub.publish(\"body.floorimagery.update\", { imagery: [ Object.assign({}, props.data, {\n\t\t\t\t\ttopleft: crns[0],\n\t\t\t\t\ttopright: crns[1],\n\t\t\t\t\tbottomleft: crns[2],\n\t\t\t\t\tbottomright: crns[3]\n\t\t\t\t}) ] });\n\t\t\t}, 10);\n\t\t};\n\t}\n\n\t_onDragging(elem, props) {\n\t\tconst dragend = this._onDragEnd(elem, props);\n\n\t\tif(elem.editing.dragging) {\n\t\t\telem.editing.dragging.once(\"dragend\", dragend);\n\t\t}\n\n\t\tif(elem.editing._handles) {\n\t\t\tObject.entries(elem.editing._handles).forEach(e => {\n\t\t\t\te[1].eachLayer(l => {\n\t\t\t\t\tl.once(\"dragend\", dragend);\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\tupdateLeafletElement(fromProps, toProps) {\n\t\tif(toProps.data.image !== fromProps.data.image) {\n\t\t\tthis.leafletElement.setUrl(toProps.data.image)\n\t\t}\n\n\t\tif(toProps.bounds !== fromProps.bounds) {\n\t\t\tthis.leafletElement.setBounds(L.latLngBounds(toProps.bounds))\n\t\t}\n\n\t\t// Position changes\n\t\tif(\n\t\t\ttoProps.data.topleft !== fromProps.data.topleft\n\t\t\t|| toProps.data.topright !== fromProps.data.topright\n\t\t\t|| toProps.data.bottomleft !== fromProps.data.bottomleft\n\t\t\t|| toProps.data.bottomright !== fromProps.data.bottomright\n\t\t) {\n\t\t\tconst prevCorners = this.leafletElement.getCorners();\n\t\t\tconst nextCorners = [\n\t\t\t\ttoProps.data.topleft,\n\t\t\t\ttoProps.data.topright,\n\t\t\t\ttoProps.data.bottomleft,\n\t\t\t\ttoProps.data.bottomright ? toProps.data.bottomright : L.latLng(toProps.data.bottomleft.lat, toProps.data.topright.lng)\n\t\t\t];\n\n\t\t\tif(!deepEqual(prevCorners, nextCorners)) {\n\t\t\t\tthis.leafletElement.setCorners(nextCorners);\n\n\t\t\t\t// Hack for forcing refresh of handles\n\t\t\t\tif(this.leafletElement.editing && this.leafletElement.editing._handles) {\n\t\t\t\t\tObject.values(this.leafletElement.editing._handles).forEach(layer => {\n\t\t\t\t\t\tlayer.eachLayer(l => {\n\t\t\t\t\t\t\tif(l.updateHandle) {\n\t\t\t\t\t\t\t\tl.updateHandle();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Enable/disable\n\t\tif(toProps.tool && toProps.data.selected && toProps.data.visible) {\n\t\t\tif(!this.leafletElement.editing.enabled()) {\n\t\t\t\tthis.leafletElement.editing.enable();\n\t\t\t}\n\t\t\tif(!this.leafletElement.editing._selected) {\n\t\t\t\tthis.leafletElement.editing._select();\n\t\t\t}\n\t\t\tthis.leafletElement.setZIndex(1000);\n\t\t}\n\t\tif(!toProps.tool || !toProps.data.selected || !toProps.data.visible) {\n\t\t\tif(this.leafletElement.editing.enabled()) {\n\t\t\t\tthis.leafletElement.editing.disable();\n\t\t\t}\n\t\t\tif(this.leafletElement.editing._selected) {\n\t\t\t\tthis.leafletElement.editing._deselect();\n\t\t\t}\n\t\t\tthis.leafletElement.setZIndex(1);\n\t\t}\n\n\t\tif(\n\t\t\ttoProps.data.visible\n\t\t\t&& (\n\t\t\t\t(fromProps.tool !== toProps.tool && toProps.data.selected)\n\t\t\t\t|| (fromProps.data.selected !== toProps.data.selected && toProps.data.selected)\n\t\t\t)\n\t\t) {\n\t\t\t// Editing changes\n\t\t\tif(toProps.tool === \"scale\") {\n\t\t\t\tif(this.leafletElement.editing._mode !== \"scale\") {\n\t\t\t\t\tthis.leafletElement.editing._toggleScale();\n\t\t\t\t}\n\t\t\t\tthis.leafletElement.setOpacity(toProps.opacity);\n\t\t\t}\n\n\t\t\t// Rotating changes\n\t\t\tif(toProps.tool === \"rotate\") {\n\t\t\t\tif(this.leafletElement.editing._mode !== \"rotate\") {\n\t\t\t\t\tthis.leafletElement.editing._toggleRotate();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Distorting changes\n\t\t\tif(toProps.tool === \"distort\") {\n\t\t\t\tif(this.leafletElement.editing._mode !== \"distort\") {\n\t\t\t\t\tif(this.leafletElement.editing._mode === \"rotate\") {\n\t\t\t\t\t\tthis.leafletElement.editing._toggleRotate();\n\t\t\t\t\t}\n\t\t\t\t\tif(this.leafletElement.editing._mode === \"scale\") {\n\t\t\t\t\t\tthis.leafletElement.editing._toggleScale();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Mode changes\n\t\tif(!toProps.data.visible) {\n\t\t\tthis.leafletElement.setOpacity(0);\n\t\t}\n\t\telse if(toProps.mode === Body.MODE_FLOOR_IMAGERY) {\n\t\t\tthis.leafletElement.setOpacity(toProps.opacity);\n\t\t\tthis._onDragging(this.leafletElement, toProps);\n\t\t}\n\t\telse {\n\t\t\t// Opacity changes\n\t\t\tif(!isNaN(toProps.data.level) && toProps.level === toProps.data.level) {\n\t\t\t\tthis.leafletElement.setOpacity(toProps.opacity);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.leafletElement.setOpacity(0);\n\t\t\t}\n\t\t}\n\t}\n\n\tcomponentWillUnmount() {\n\t\tsuper.componentWillUnmount();\n\n\t\tif(this._checkSelect) {\n\t\t\tclearInterval(this._checkSelect);\n\t\t\tdelete this._checkSelect;\n\t\t}\n\t}\n}\n\nexport default withLeaflet(FloorImagery);\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Editable from './Editable';\nimport PubSub from 'pubsub-js';\n\n/**\n * Levels layer allows to show OSM data of levels contained in one particular building\n */\nclass LevelsLayer extends Component {\n\trender() {\n\t\tconst levelParts = window.vectorDataManager.getLevelFootprint(this.props.building, this.props.level) || [];\n\t\tconst data = { type: \"FeatureCollection\", features: levelParts };\n\n\t\tif(this.props.floor && !levelParts.includes(this.props.floor)) {\n\t\t\tlevelParts.push(this.props.floor);\n\t\t}\n\n\t\treturn <Editable\n\t\t\tdata={data}\n\t\t\tshadowData={this.props.building}\n\t\t\tselection={this.props.floor}\n\t\t\tonFeatureClick={feature => PubSub.publish(\"body.select.floor\", { floor: feature })}\n\t\t\tdraw={this.props.draw}\n\t\t\tstyler={this.props.styler}\n\t\t/>;\n\t}\n}\n\nexport default LevelsLayer;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport { Control, DomUtil } from 'leaflet';\nimport { withLeaflet, MapControl } from 'react-leaflet';\nimport deepEqual from 'fast-deep-equal';\nimport PubSub from 'pubsub-js';\n\nconst LevelControl = Control.extend({\n\tonAdd: function(map) {\n\t\tthis.container = DomUtil.create(\"div\", \"leaflet-bar leaflet-control-levels\");\n\t\tthis.setAvailableLevels(this.options.levels);\n\t\tthis.setLevel(this.options.level);\n\t\treturn this.container;\n\t},\n\n\tsetAvailableLevels(lvls) {\n\t\tthis.container.innerHTML = \"\";\n\t\tthis._levels = lvls.map(l => parseFloat(l)) || [ 0 ];\n\n\t\tthis._levels.sort((a,b) => a - b);\n\n\t\t// Add missing integer levels value\n\t\tfor(let i=0; i < this._levels.length - 1; i++) {\n\t\t\tconst lvlValCurr = this._levels[i];\n\t\t\tconst lvlValNext = this._levels[i+1];\n\t\t\tif(lvlValNext - lvlValCurr > 1) {\n\t\t\t\tconst next = Math.floor(lvlValCurr+1);\n\t\t\t\tconst until = Math.floor(lvlValNext) === lvlValNext ? lvlValNext - 1 : Math.floor(lvlValNext);\n\t\t\t\tfor(let j=until; j >= next; j--) {\n\t\t\t\t\tthis._levels.splice(i+1, 0, j);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst min = this._levels[0];\n\t\tconst max = this._levels[this._levels.length-1];\n\n\t\t// Condensed version (levels shown in ranges)\n\t\tif(this._levels.length > 10) {\n\t\t\tthis._mode = \"condensed\";\n\t\t\tthis._lastByTen = null;\n\t\t\tconst minByTen = Math.floor(min / 10);\n\t\t\tconst maxByTen = Math.floor(max / 10);\n\n\t\t\t// Display buttons for ranges (0X, 1X, 2X...)\n\t\t\tfor(let lvlByTen = maxByTen; lvlByTen >= minByTen; lvlByTen--) {\n\t\t\t\tconst myLvlByTen = parseInt(lvlByTen.toString());\n\n\t\t\t\tconst cLvlByTen = DomUtil.create(\"a\", \"leaflet-control-level-byten lvl-byten\"+myLvlByTen);\n\t\t\t\tcLvlByTen.innerHTML = myLvlByTen+\"X\";\n\n\t\t\t\t// Click event on range button\n\t\t\t\tcLvlByTen.addEventListener(\"click\", evt => {\n\t\t\t\t\t// Clean-up last selection\n\t\t\t\t\tfor(let last of this.container.getElementsByClassName(\"leaflet-control-level-byten-extended\")) {\n\t\t\t\t\t\tlast.classList.remove(\"leaflet-control-level-byten-extended\");\n\t\t\t\t\t}\n\n\t\t\t\t\tfor(let inten of this.container.getElementsByClassName(\"leaflet-control-levels-inten\")) {\n\t\t\t\t\t\tthis.container.removeChild(inten);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Click on other range : show in-range selector\n\t\t\t\t\tif(this._lastByTen !== myLvlByTen) {\n\t\t\t\t\t\tevt.target.classList.add(\"leaflet-control-level-byten-extended\");\n\n\t\t\t\t\t\t// Show list of levels in range\n\t\t\t\t\t\tconst cLvls = DomUtil.create(\"div\", \"leaflet-bar leaflet-control-levels-inten\");\n\t\t\t\t\t\tcLvls.style.position = \"absolute\";\n\t\t\t\t\t\tcLvls.style.top = (evt.target.offsetTop-4)+\"px\";\n\t\t\t\t\t\tcLvls.style.right = 32+\"px\";\n\n\t\t\t\t\t\tconst levelsInRange = this._levels.filter(lvl => lvl >= myLvlByTen*10 && lvl < (myLvlByTen*10+10));\n\n\t\t\t\t\t\tfor(let lvlId = levelsInRange.length-1; lvlId >= 0; lvlId--) {\n\t\t\t\t\t\t\tconst lvl = levelsInRange[lvlId];\n\t\t\t\t\t\t\tconst myLvl = parseFloat(lvl.toString());\n\t\t\t\t\t\t\tconst cLvl = DomUtil.create(\"a\", \"leaflet-control-level lvl\"+myLvl);\n\t\t\t\t\t\t\tcLvl.innerHTML = myLvl;\n\t\t\t\t\t\t\tcLvl.addEventListener(\"click\", () => {\n\t\t\t\t\t\t\t\tPubSub.publish(\"body.level.set\", { level: myLvl });\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tif(lvl === this._level) {\n\t\t\t\t\t\t\t\tcLvl.classList.add(\"leaflet-control-level-selected\");\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tcLvls.appendChild(cLvl);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.container.appendChild(cLvls);\n\t\t\t\t\t\tthis._lastByTen = myLvlByTen;\n\t\t\t\t\t}\n\t\t\t\t\t// Click on same range : hide in-range selector\n\t\t\t\t\telse {\n\t\t\t\t\t\tthis._lastByTen = null;\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tthis.container.appendChild(cLvlByTen);\n\t\t\t}\n\t\t}\n\t\t// Extended version (all levels shown)\n\t\telse {\n\t\t\tthis._mode = \"extended\";\n\n\t\t\tfor(let lid = this._levels.length-1; lid >= 0; lid--) {\n\t\t\t\tconst lvl = this._levels[lid];\n\t\t\t\tconst myLvl = parseFloat(lvl.toString());\n\t\t\t\tconst cLvl = DomUtil.create(\"a\", \"leaflet-control-level lvl\"+myLvl);\n\t\t\t\tcLvl.innerHTML = myLvl;\n\t\t\t\tcLvl.addEventListener(\"click\", () => {\n\t\t\t\t\tPubSub.publish(\"body.level.set\", { level: myLvl });\n\t\t\t\t});\n\n\t\t\t\tthis.container.appendChild(cLvl);\n\t\t\t}\n\t\t}\n\t},\n\n\tsetLevel(l) {\n\t\t// Clean previous selection\n\t\tfor(let last of this.container.getElementsByClassName(\"leaflet-control-level-selected\")) {\n\t\t\tlast.classList.remove(\"leaflet-control-level-selected\");\n\t\t}\n\n\t\tfor(let last of this.container.getElementsByClassName(\"leaflet-control-level-byten-selected\")) {\n\t\t\tlast.classList.remove(\"leaflet-control-level-byten-selected\");\n\t\t}\n\n\t\t// Highlight current level/range\n\t\tif(this._mode === \"extended\" || this._lastByTen !== null) {\n\t\t\tconst next = this.container.getElementsByClassName(\"lvl\"+l)[0];\n\t\t\tif(next) {\n\t\t\t\tnext.classList.add(\"leaflet-control-level-selected\");\n\t\t\t\tthis._level = l;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.setAvailableLevels(this._levels.concat([ l ]));\n\t\t\t\tthis.setLevel(l);\n\t\t\t}\n\t\t}\n\n\t\tif(this._mode === \"condensed\") {\n\t\t\tconst currentRange = Math.floor(l/10);\n\n\t\t\tconst next = this.container.getElementsByClassName(\"lvl-byten\"+currentRange)[0];\n\t\t\tif(next) {\n\t\t\t\tnext.classList.add(\"leaflet-control-level-byten-selected\");\n\t\t\t\tthis._level = l;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.setAvailableLevels(this._levels.concat([ l ]));\n\t\t\t\tthis.setLevel(l);\n\t\t\t}\n\t\t}\n\t},\n\n\tonRemove: function(map) {\n\t}\n});\n\n/**\n * Level selector is a React-Leaflet control to allow user choosing the indoor level to display.\n */\nclass LevelSelector extends MapControl {\n\tcreateLeafletElement(props) {\n\t\treturn new LevelControl(props);\n\t}\n\n\tupdateLeafletElement(fromProps, toProps) {\n\t\tif(!deepEqual(fromProps.levels, toProps.levels)) {\n\t\t\tthis.leafletElement.setAvailableLevels(toProps.levels);\n\t\t\tthis.leafletElement.setLevel(toProps.level);\n\t\t}\n\n\t\tif(fromProps.level !== toProps.level) {\n\t\t\tthis.leafletElement.setLevel(toProps.level);\n\t\t}\n\t}\n}\n\nexport default withLeaflet(LevelSelector);\n","/**\n * Condition\n * A condition is a boolean test in style selector.\n * \n * Based on Overpass Turbo implementation\n * @see https://github.com/tyrasd/overpass-turbo\n */\nvar MapCSSCondition = function() {};\nMapCSSCondition.prototype = {\n\ttype: '',\t\t\t\t// eq/ne/regex etc.\n\tparams: [],\t\t\t\t// what to test against\n\n\tinit:function(_type) {\n\t\tthis.type  =_type;\n\t\tthis.params=Array.prototype.slice.call(arguments,1);\n                return this;\n\t},\n\t\n\ttest:function(tags) {\n\t\t// summary:\t\tRun the condition against the supplied tags.\n\t\tvar p=this.params;\n\t\tswitch (this.type) {\n\t\t\tcase 'eq':\t\treturn (tags[p[0]]===p[1]);\n\t\t\tcase 'ne':\t\treturn (tags[p[0]]!==p[1]);\n\t\t\tcase 'regex':\tvar r=new RegExp(p[1],\"i\");\n\t\t\t\t\t\t\treturn (r.test(tags[p[0]]));\n\t\t\tcase 'true':\treturn (tags[p[0]]==='true' || tags[p[0]]==='yes' || tags[p[0]]==='1');\n\t\t\tcase 'false':\treturn (tags[p[0]]==='false' || tags[p[0]]==='no' || tags[p[0]]==='0');\n\t\t\tcase 'set':\t\treturn (tags[p[0]] !== undefined && tags[p[0]]!=='');\n\t\t\tcase 'unset':\treturn (tags[p[0]] === undefined || tags[p[0]]==='');\n\t\t\tcase '<':\t\treturn (Number(tags[p[0]])< Number(p[1]));\n\t\t\tcase '<=':\t\treturn (Number(tags[p[0]])<=Number(p[1]));\n\t\t\tcase '>':\t\treturn (Number(tags[p[0]])> Number(p[1]));\n\t\t\tcase '>=':\t\treturn (Number(tags[p[0]])>=Number(p[1]));\n\t\t\tdefault:\n\t\t\t\treturn false;\n\t\t}\n\t},\n\t\n\ttoString:function() {\n\t\treturn \"[\"+this.type+\": \"+this.params+\"]\";\n\t}\n};\n\nexport default MapCSSCondition;\n","import Style from \"./Style\";\n\n/**\n * InstructionStyle\n * Based on Overpass Turbo implementation\n * @see https://github.com/tyrasd/overpass-turbo\n */\nvar MapCSSInstructionStyle = function() {this.__init__()};\nMapCSSInstructionStyle.prototype = {\n\tset_tags: null,\n\tbreaker: false,\n\tstyleType: 'InstructionStyle',\n\t\n\t__init__: function() {\n\t},\n\t\n\taddSetTag: function(k,v) {\n\t\tthis.edited=true;\n\t\tif (!this.set_tags) this.set_tags={};\n\t\tthis.set_tags[k]=v;\n\t},\n\t\n};\n\n//Inherit from Style\nfor(var p in Style.prototype) {\n\tif (MapCSSInstructionStyle.prototype[p] === undefined) {\n\t\tMapCSSInstructionStyle.prototype[p] = Style.prototype[p];\n\t}\n}\n\nexport default MapCSSInstructionStyle;\n","import Style from \"./Style\";\n\n/**\n * MetaStyle\n * Handles properties specific to meta rules.\n * \n * Based on Overpass Turbo implementation\n * @see https://github.com/tyrasd/overpass-turbo\n */\nvar MapCSSMetaStyle = function() {this.__init__()};\nMapCSSMetaStyle.prototype = {\n\tproperties: ['title'],\n\n\tstyleType: 'MetaStyle'\n};\n\n//Inherit from Style\nfor(var p in Style.prototype) {\n\tif (MapCSSMetaStyle.prototype[p] === undefined) {\n\t\tMapCSSMetaStyle.prototype[p] = Style.prototype[p];\n\t}\n}\n\nexport default MapCSSMetaStyle;\n","import Style from \"./Style\";\n\n/**\n * PointStyle\n * Based on Overpass Turbo implementation\n * @see https://github.com/tyrasd/overpass-turbo\n */\nvar MapCSSPointStyle = function() {this.__init__()};\nMapCSSPointStyle.prototype = {\n\tproperties: ['icon_image','icon_width','icon_height','icon_opacity','rotation','icon_image_aliases', 'symbol_size' ],\n\ticon_image: null,\n\ticon_width: 0,\n\ticon_height: NaN,\n\ticon_image_aliases: '',\n\trotation: NaN,\n\tstyleType: 'PointStyle',\n\t\n\tdrawn:function() {\n\t\treturn (this.icon_image !== null);\n\t},\n\t\n\tmaxwidth:function() {\n\t\treturn this.evals.icon_width ? 0 : this.icon_width;\n\t},\n\t\n\tsetImageAliases:function() {\n\t\tif(this.icon_image_aliases.replace) {\n\t\t\tvar json = '{ '+this.icon_image_aliases.replace(/'/g, \"\")+' }';\n\t\t\tthis.icon_image_aliases = JSON.parse(json);\n\t\t}\n\t}\n};\n\n//Inherit from Style\nfor(var p in Style.prototype) {\n\tif (MapCSSPointStyle.prototype[p] === undefined) {\n\t\tMapCSSPointStyle.prototype[p] = Style.prototype[p];\n\t}\n}\n\nexport default MapCSSPointStyle;\n","import Style from \"./Style\";\n\n/**\n * ShapeStyle\n * Based on Overpass Turbo implementation\n * @see https://github.com/tyrasd/overpass-turbo\n */\nvar MapCSSShapeStyle = function() {this.__init__()};\n\nMapCSSShapeStyle.prototype = {\n\tproperties: ['width','offset','color','opacity','dashes','linecap','linejoin','line_style',\n\t'fill_image','fill_color','fill_opacity','casing_width','casing_color','casing_opacity','casing_dashes','layer','z_index'],\n\n\twidth:0, color:null, opacity:NaN, dashes:[],\n\tlinecap:null, linejoin:null, line_style:null,\n\tfill_image:null, fill_color:null, fill_opacity:NaN,\n\tcasing_width:NaN, casing_color:null, casing_opacity:NaN, casing_dashes:[],z_index:NaN,\n\tlayer:NaN,\t\t\t\t// optional layer override (usually set by OSM tag)\n\tstyleType: 'ShapeStyle',\n\n\tdrawn:function() {\n\t\treturn (this.fill_image || !isNaN(this.fill_color) || this.width || this.casing_width);\n\t},\n\tmaxwidth:function() {\n\t\t// If width is set by an eval, then we can't use it to calculate maxwidth, or it'll just grow on each invocation...\n\t\tif (this.evals.width || this.evals.casing_width) { return 0; }\n\t\treturn (this.width + (this.casing_width ? this.casing_width*2 : 0));\n\t},\n\tstrokeStyler:function() {\n\t\tvar cap,join;\n\t\tswitch (this.linecap ) { case 'round': cap ='round'; break; case 'square': cap='square'; break; default: cap ='butt' ; break; }\n\t\tswitch (this.linejoin) { case 'bevel': join='bevel'; break; case 'miter' : join=4      ; break; default: join='round'; break; }\n\t\treturn {\n\t\t\tcolor: this.dojoColor(this.color ? this.color : 0, this.opacity ? this.opacity : 1),\n\t\t\tstyle: 'Solid',\t\t\t// needs to parse dashes\n\t\t\twidth: this.width,\n\t\t\tcap:   cap,\n\t\t\tjoin:  join\n\t\t};\n\t},\n\tshapeStrokeStyler:function() {\n\t\tif (isNaN(this.casing_color)) { return { width:0 }; }\n\t\treturn {\n\t\t\tcolor: this.dojoColor(this.casing_color, this.casing_opacity ? this.casing_opacity : 1),\n\t\t\twidth: this.casing_width ? this.casing_width : 1\n\t\t};\n\t},\n\tshapeFillStyler:function() {\n\t\tif (isNaN(this.color)) { return null; }\n\t\treturn this.dojoColor(this.color, this.opacity ? this.opacity : 1);\n\t},\n\tfillStyler:function() {\n\t\treturn this.dojoColor(this.fill_color, this.fill_opacity ? this.fill_opacity : 1);\n\t},\n\tcasingStyler:function() {\n\t\tvar cap,join;\n\t\tswitch (this.linecap ) { case 'round': cap ='round'; break; case 'square': cap='square'; break; default: cap ='butt' ; break; }\n\t\tswitch (this.linejoin) { case 'bevel': join='bevel'; break; case 'miter' : join=4      ; break; default: join='round'; break; }\n\t\treturn {\n\t\t\tcolor: this.dojoColor(this.casing_color ? this.casing_color : 0, this.casing_opacity ? this.casing_opacity : 1),\n\t\t\twidth: this.width+this.casing_width*2,\n\t\t\tstyle: 'Solid',\n\t\t\tcap:   cap,\n\t\t\tjoin:  join\n\t\t};\n\t},\n\n};\n\n//Inherit from Style\nfor(var p in Style.prototype) {\n\tif (MapCSSShapeStyle.prototype[p] === undefined) {\n\t\tMapCSSShapeStyle.prototype[p] = Style.prototype[p];\n\t}\n}\n\nexport default MapCSSShapeStyle;\n","import Style from \"./Style\";\n\n/**\n * ShieldStyle\n * Based on Overpass Turbo implementation\n * @see https://github.com/tyrasd/overpass-turbo\n */\nvar MapCSSShieldStyle = function() {this.__init__()};\n\nMapCSSShieldStyle.prototype = {\n\thas: function(k) {\n\t\treturn this.properties.indexOf(k)>-1;\n\t},\n\tproperties: ['shield_image','shield_width','shield_height'],\n\tshield_image: null,\n\tshield_width: NaN,\n\tshield_height: NaN,\n\tstyleType: 'ShieldStyle',\n};\n\n//Inherit from Style\nfor(var p in Style.prototype) {\n\tif (MapCSSShieldStyle.prototype[p] === undefined) {\n\t\tMapCSSShieldStyle.prototype[p] = Style.prototype[p];\n\t}\n}\n\nexport default MapCSSShieldStyle;\n","/**\n * Rule\n * A MapCSS selector. Contains a list of Conditions; the entity type to which the selector applies; \n * and the zoom levels at which it is true. way[waterway=river*][boat=yes] would be parsed into one Rule.\n * The selectors and declaration together form a StyleChooser.\n * \n * Based on Overpass Turbo implementation\n * @see https://github.com/tyrasd/overpass-turbo\n */\nvar MapCSSRule = function() {};\nMapCSSRule.prototype = {\n\n    conditions: [],\t\t// the Conditions to be evaluated for the Rule to be fulfilled\n    isAnd: true,\t\t// do all Conditions need to be true for the Rule to be fulfilled? (Always =true for MapCSS)\n    minZoom: 0,\t\t\t// minimum zoom level at which the Rule is fulfilled\n    maxZoom: 255,\t\t// maximum zoom level at which the Rule is fulfilled\n    subject: '',\t\t// entity type to which the Rule applies: 'way', 'node', 'relation', 'area' (closed way) or 'line' (unclosed way)\n\n    addSubject: function(_subject) {\n        this.subject=_subject;\n        this.conditions=[];\n    },\n\n    addCondition: function(_condition) {\n        // summary:\t\tAdd a condition to this rule.\n        this.conditions.push(_condition);\n    },\n\n    test: function(entity,tags,zoom) {\n        // summary: Evaluate the Rule on the given entity, tags and zoom level.\n        // returns: true if the Rule passes, false if the conditions aren't fulfilled.\n        if (this.subject !== '' && this.subject !== '*' && !entity.isSubject(this.subject)) {\n            return false;\n        }\n        if (zoom<this.minZoom || zoom>this.maxZoom) { return false; }\n\n        var v=true; var i=0; var isAnd=this.isAnd;\n        this.conditions.filter(c => c !== null).forEach(function(condition) {\n            var r=condition.test(tags);\n            if (i === 0) { v=r; }\n            else if (isAnd) { v=v && r; }\n            else { v = v || r; }\n            i++;\n        });\n        return v;\n    },\n\n    toString:function() {\n        return this.subject+\" z\"+this.minZoom+\"-\"+this.maxZoom+\": \"+this.conditions;\n    }\n};\n\nexport default MapCSSRule;\n","import Rule from \"./Rule\";\n\n/**\n * RuleChain\n * A descendant list of MapCSS selectors (Rules).\n * \n * For example,\n * relation[type=route] way[highway=primary]\n * ^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^\n * first Rule\t\t   second Rule\n * |------------|---------|\n * |\n * one RuleChain\n * \n * In contrast to Halcyon, note that length() is a function, not a getter property\n * \n * Based on Overpass Turbo implementation\n * @see https://github.com/tyrasd/overpass-turbo\n */\nclass MapCSSRuleChain {\n\tconstructor() {\n\t\tthis.rules=[];\t\t\t\t// list of Rules\n\t\tthis.subpart= 'default';\t\t// subpart name, as in way[highway=primary]::centreline\n\t}\n\t\n\t\n\t// Functions to define the RuleChain\n\taddRule(_subject) {\n\t\tthis.rules.push(new Rule());\n\t\tthis.rules[this.rules.length-1].addSubject(_subject);\n\t}\n\n\taddConditionToLast(_condition) {\n\t\tthis.rules[this.rules.length-1].addCondition(_condition);\n\t}\n\n\taddZoomToLast(z1,z2) {\n\t\tthis.rules[this.rules.length-1].minZoom=z1;\n\t\tthis.rules[this.rules.length-1].maxZoom=z2;\n\t}\n\n\n\tlength() {\n\t\treturn this.rules.length;\n\t}\n\n\tsetSubpart(subpart) {\n\t\tthis.subpart = subpart || 'default';\n\t}\n\n\t// Test a ruleChain\n\t// - run a set of tests in the chain\n\t//\t\tworks backwards from at position \"pos\" in array, or -1  for the last\n\t//\t\tseparate tags object is required in case they've been dynamically retagged\n\t// - if they fail, return false\n\t// - if they succeed, and it's the last in the chain, return happily\n\t// - if they succeed, and there's more in the chain, rerun this for each parent until success\n\n\ttest(pos, entity, tags, zoom) {\n\t\t// summary:\t\tTest a rule chain by running all the tests in reverse order.\n\t\tif (this.rules.length === 0) { return true; } // orig: { return false; } // todo: wildcard selector \"*\" semms broken... \n\t\tif (pos===-1) { pos=this.rules.length-1; }\n\n\t\tvar r = this.rules[pos];\n\t\tif (!r.test(entity, tags, zoom)) { return false; }\n\t\tif (pos === 0) { return true; }\n\n\t\tvar o = entity.getParentObjects();//TODO//entity.entity.parentObjects();\n\t\tfor (var i = 0; i < o.length; i++) {\n\t\t\tvar p=o[i];\n\t\t\tif (this.test(pos-1, p, p.tags, zoom)) { return true; }\n\t\t}\n\t\treturn false;\n\t}\n};\n\nexport default MapCSSRuleChain;\n","import RuleChain from \"./RuleChain\";\n\n/**\n * StyleChooser\n * A combination of the selectors (ruleChains) and declaration (styles).\n * For example, way[highway=footway] node[barrier=gate] { icon: gate.png; } is one StyleChooser.\n * \n * Based on Overpass Turbo implementation\n * @see https://github.com/tyrasd/overpass-turbo\n */\nvar MapCSSStyleChooser = function() {\n    this.ruleChains = [new RuleChain()];\n    this.styles = [];\n};\n\nMapCSSStyleChooser.prototype = {\n\t// UpdateStyles doesn't support image-widths yet\n\t// or setting maxwidth/_width\n\truleChains: [],\t\t\t\t// array of RuleChains (each one an array of Rules)\n\tstyles: [],\t\t\t\t\t// array of ShapeStyle/ShieldStyle/TextStyle/PointStyle\n\tzoomSpecific:false,\t\t\t// are any of the rules zoom-specific?\n\n\trcpos:0,\n\tstylepos:0,\n\n\tconstructor:function() {\n\t},\n\n\tcurrentChain:function() {\n\t\treturn this.ruleChains[this.ruleChains.length-1];\n\t},\n\n\tnewRuleChain:function() {\n\t\t// summary:\t\tStarts a new ruleChain in this.ruleChains.\n\t\tif (this.ruleChains[this.ruleChains.length-1].length()>0) {\n\t\t\tthis.ruleChains.push(new RuleChain());\n\t\t}\n\t},\n\n\taddStyles:function(a) {\n\t\tthis.styles=this.styles.concat(a);\n\t},\n\n\tupdateStyles:function(entity, tags, sl, zoom) {\n\t\tif (this.zoomSpecific) { sl.validAt=zoom; }\n\n\t\t// Are any of the ruleChains fulfilled?\n\t\tfor (var i in this.ruleChains) {\n\t\t\tvar c=this.ruleChains[i];\n\t\t\tif (c.test(-1, entity, tags, zoom)) {\n\t\t\t\tsl.addSubpart(c.subpart);\n\n\t\t\t\t// Update StyleList\n\t\t\t\tfor (var j in this.styles) {\n\t\t\t\t\tvar r=this.styles[j];\n\t\t\t\t\tvar a;\n\t\t\t\t\tswitch (r.styleType) {\n\n\t\t\t\t\t\tcase 'ShapeStyle' :\tsl.maxwidth=Math.max(sl.maxwidth,r.maxwidth());\n\t\t\t\t\t\t\t\t\t\t\ta=sl.shapeStyles; break;\n\t\t\t\t\t\tcase 'ShieldStyle':\ta=sl.shieldStyles; break;\n\t\t\t\t\t\tcase 'TextStyle'  :\ta=sl.textStyles; break;\n\t\t\t\t\t\tcase 'MetaStyle'  :\ta=sl.metaStyles; break;\n\t\t\t\t\t\tcase 'PointStyle' :\tsl.maxwidth=Math.max(sl.maxwidth,r.maxwidth());\n\t\t\t\t\t\t\t\t\t\t\tr.setImageAliases();\n\t\t\t\t\t\t\t\t\t\t\ta=sl.pointStyles; break;\n\t\t\t\t\t\tcase 'InstructionStyle':\n\t\t\t\t\t\t    if (r.breaker) { return; }\n\t\t\t\t\t\t\tfor (var k in r.set_tags) { tags[k]=r.set_tags[k]; }\n\t\t\t\t\t\t\ta = {}; // \"dev/null\" stylechooser reciever\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\ta = {};\n\t\t\t\t\t}\n\t\t\t\t\tif (r.drawn()) { tags[':drawn']='yes'; }\n\t\t\t\t\ttags._width = sl.maxwidth;\n\t\t\t\n\t\t\t\t\tr.runEvals(tags);\n\t\t\t\t\t\n\t\t\t\t\t// helper function\n\t\t\t\t\tfunction extend(destination, source) {\n\t\t\t\t\t\tfor (var property in source) {\n\t\t\t\t\t\t\tif (source.hasOwnProperty(property)) {\n\t\t\t\t\t\t\t\tdestination[property] = source[property];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn destination;\n\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\tif (a[c.subpart]) {\n\t\t\t\t\t\t// // If there's already a style on this sublayer, then merge them\n\t\t\t\t\t\t// // (making a deep copy if necessary to avoid altering the root style)\n\t\t\t\t\t\t// if (!a[c.subpart].merged) { a[c.subpart]=extend({},a[c.subpart]); }\n\t\t\t\t\t\textend(a[c.subpart], r);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// // Otherwise, just assign it\n\t\t\t\t\t\ta[c.subpart]=extend({},r);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n};\n\nexport default MapCSSStyleChooser;\n","/**\n * StyleList\n * A list of styles, defining the look of objects.\n * \n * Based on Overpass Turbo implementation\n * @see https://github.com/tyrasd/overpass-turbo\n */\nclass MapCSSStyleList {\n\tconstructor() {\n\t\tthis.shapeStyles  = {};\n\t\tthis.textStyles   = {};\n\t\tthis.pointStyles  = {};\n\t\tthis.shieldStyles = {};\n\t\tthis.metaStyles   = {};\n\t\t\n\t\tthis.maxwidth = 0;\n\t\tthis.subparts = [];\t\t\t// List of subparts used in this StyleList\n\t\tthis.validAt = -1;\t\t\t\t// Zoom level this is valid at (or -1 at all levels - saves recomputing)\n\n\t}\n\n\thasStyles() {\n\t\t// summary:\t\tDoes this StyleList contain any styles?\n\t\treturn (this.hasShapeStyles() || this.hasTextStyles() || this.hasPointStyles() || this.hasShieldStyles() || this.hasMetaStyles());\n\t}\n\n\thasFills() {\n\t\t// summary:\t\tDoes this StyleList contain any styles with a fill?\n\t\tfor (var s in this.shapeStyles) {\n\t\t\tif (!isNaN(this.shapeStyles(s).fill_color) || this.shapeStyles(s).fill_image) return true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tlayerOverride() {\n\t\t// summary:\t\tIf this StyleList manually forces an OSM layer, return it, otherwise null.\n\t\tfor (var s in this.shapeStyles) {\n\t\t\tif (!isNaN(this.shapeStyles[s].layer)) return this.shapeStyles[s].layer;\n\t\t}\n\t\treturn NaN;\n\t}\n\n\taddSubpart(s) {\n\t\t// summary:\t\tRecord that a subpart is used in this StyleList. \n\t\tif (this.subparts.indexOf(s)===-1) { this.subparts.push(s); }\n\t}\n\n\tisValidAt(zoom) {\n\t\t// summary:\t\tIs this StyleList valid at a given zoom? \n\t\treturn (this.validAt===-1 || this.validAt===zoom);\n\t}\n\n\ttoString() {\n\t\t// summary:\t\tSummarise StyleList as String - for debugging\n\t\tvar str = '';\n\t\tvar k;\n\t\tfor (k in this.shapeStyles ) { str+=\"- SS \"+k+\"=\"+this.shapeStyles[k]+\"\\n\"; }\n\t\tfor (k in this.textStyles  ) { str+=\"- TS \"+k+\"=\"+this.textStyles[k]+\"\\n\"; }\n\t\tfor (k in this.pointStyles ) { str+=\"- PS \"+k+\"=\"+this.pointStyles[k]+\"\\n\"; }\n\t\tfor (k in this.shieldStyles) { str+=\"- sS \"+k+\"=\"+this.shieldStyles[k]+\"\\n\"; }\n\t\tfor (k in this.metaStyles  ) { str+=\"- MS \"+k+\"=\"+this.metaStyles[k]+\"\\n\"; }\n\t\treturn str;\n\t}\n\n\thasShapeStyles()  { for (var a in this.shapeStyles ) { return true; } return false; }\n\thasTextStyles()   { for (var a in this.textStyles  ) { return true; } return false; }\n\thasPointStyles()  { for (var a in this.pointStyles ) { return true; } return false; }\n\thasShieldStyles() { for (var a in this.shieldStyles) { return true; } return false; }\n\thasMetaStyles()   { for (var a in this.metaStyles  ) { return true; } return false; }\n}\n\nexport default MapCSSStyleList;\n","import Style from \"./Style\";\n\n/**\n * TextStyle\n * Based on Overpass Turbo implementation\n * @see https://github.com/tyrasd/overpass-turbo\n */\nvar MapCSSTextStyle = function() {this.__init__()};\nMapCSSTextStyle.prototype = {\n\tproperties: ['font_family','font_bold','font_italic','font_caps','font_underline','font_size',\n\t'text_color','text_offset','max_width',\n\t'text','text_halo_color','text_halo_radius','text_center',\n\t'letter_spacing','text_opacity'],\n\t// TODO: font_bold??? wtf? -> support propper MapCSS properites!\n\t\n\tfont_family: null,\n\tfont_bold: false,\n\tfont_italic: false,\n\tfont_underline: false,\n\tfont_caps: false,\n\tfont_size: NaN,\n\ttext_color: null,\n\ttext_offset: NaN,\n\tmax_width: NaN,\n\ttext: null,\n\ttext_halo_color: null,\n\ttext_halo_radius: 0,\n\ttext_center: true,\n\tletter_spacing: 0,\n\tstyleType: 'TextStyle',\n\t\n\tfontStyler:function() {\n\t\treturn {\n\t\t\tfamily: this.font_family ? this.font_family : 'Arial',\n\t\t\tsize: this.font_size ? this.font_size*2 : '10px' ,\n\t\t\tweight: this.font_bold ? 'bold' : 'normal',\n\t\t\tstyle: this.font_italic ? 'italic' : 'normal'\n\t\t};\n\t},\n\ttextStyler:function(_text) {\n\t\treturn {\n\t\t\tdecoration: this.font_underline ? 'underline' : 'none',\n\t\t\talign: 'middle',\n\t\t\ttext: _text\n\t\t};\n\t},\n\tfillStyler:function() {\n\t\t// not implemented yet\n\t\treturn this.dojoColor(0,1);\n\t},\n\t\n\t// getTextFormat, getHaloFilter, writeNameLabel\n};\n\n//Inherit from Style\nfor(var p in Style.prototype) {\n\tif (MapCSSTextStyle.prototype[p] === undefined) {\n\t\tMapCSSTextStyle.prototype[p] = Style.prototype[p];\n\t}\n}\n\nexport default MapCSSTextStyle;\n","import Condition from \"./Condition\";\nimport InstructionStyle from \"./InstructionStyle\";\nimport MetaStyle from \"./MetaStyle\";\nimport PointStyle from \"./PointStyle\";\nimport ShapeStyle from \"./ShapeStyle\";\nimport ShieldStyle from \"./ShieldStyle\";\nimport StyleChooser from \"./StyleChooser\";\nimport StyleList from \"./StyleList\";\nimport TextStyle from \"./TextStyle\";\n\n/**\n * RuleSet\n * A whole MapCSS definition, as a set of StyleChoosers\n * \n * Based on Overpass Turbo implementation\n * @see https://github.com/tyrasd/overpass-turbo\n */\nvar MapCSSRuleSet = function() {};\n\nMapCSSRuleSet.prototype = {\n\n    choosers: [],\t\t// list of StyleChoosers\n\n    getStyles: function(entity, tags, zoom) {\n        // summary:\t\tFind the styles for a given entity.\n        var sl=new StyleList();\n        for (var i in this.choosers) {\n            this.choosers[i].updateStyles(entity, tags, sl, zoom);\n        }\n        return sl;\t// StyleList\n    },\n\n    /*loadFromCSS: function(url, callback) {\n        // summary:\t\tLoad a MapCSS file from a URL, then throw it at the parser when it's loaded.\n        this.callback = callback;\n        $.ajax({\n            url: url,\n            success: _.bind(this.parseCSS, this)\n        });\n    },*/\n\n    parseCSS: function(css) {\n        // summary:\t\tParse a CSS document into a set of StyleChoosers.\n        var previous=0;\t\t\t\t\t\t\t\t// what was the previous CSS word?\n        var sc = new StyleChooser();\t// currently being assembled\n        this.choosers = [];\n        css = css.replace(/[\\r\\n]/g,\"\");\t\t\t\t// strip linebreaks because JavaScript doesn't have the /s modifier\n\n        var o = {};\n        while (css.length>0) {\n\n            // CSS comment\n            if ((o=this.COMMENT.exec(css))) {\n                css=css.replace(this.COMMENT,'');\n\n                // Whitespace (probably only at beginning of file)\n            } else if ((o=this.WHITESPACE.exec(css))) {\n                css=css.replace(this.WHITESPACE,'');\n\n                // Class - .motorway, .builtup, :hover\n            } else if ((o=this.CLASS.exec(css))) {\n                if (previous===this.oDECLARATION) { this.saveChooser(sc); sc=new StyleChooser(); }\n\n                css=css.replace(this.CLASS,'');\n                sc.currentChain().addConditionToLast((new Condition()).init('set',o[1]));\n                previous=this.oCONDITION;\n\n                // Not class - !.motorway, !.builtup, !:hover\n            } else if ((o=this.NOT_CLASS.exec(css))) {\n                if (previous===this.oDECLARATION) { this.saveChooser(sc); sc=new StyleChooser(); }\n\n                css=css.replace(this.NOT_CLASS,'');\n                sc.currentChain().addConditionToLast((new Condition()).init('unset',o[1]));\n                previous=this.oCONDITION;\n\n                // Zoom\n            } else if ((o=this.ZOOM.exec(css))) {\n                if (previous!==this.oOBJECT && previous!==this.oCONDITION) { sc.currentChain().addRule(); }\n\n                css=css.replace(this.ZOOM,'');\n                var z=this.parseZoom(o[1]);\n                sc.currentChain().addZoomToLast(z[0],z[1]);\n                sc.zoomSpecific=true;\n                previous=this.oZOOM;\n\n                // Grouping - just a comma\n            } else if ((o=this.GROUP.exec(css))) {\n                css=css.replace(this.GROUP,'');\n                sc.newRuleChain();\n                previous=this.oGROUP;\n\n                // Condition - [highway=primary]\n            } else if ((o=this.CONDITION.exec(css))) {\n                if (previous===this.oDECLARATION) { this.saveChooser(sc); sc=new StyleChooser(); }\n                if (previous!==this.oOBJECT && previous!==this.oZOOM && previous!==this.oCONDITION) { sc.currentChain().addRule(); }\n                css=css.replace(this.CONDITION,'');\n                sc.currentChain().addConditionToLast(this.parseCondition(o[1]));\n                previous=this.oCONDITION;\n\n                // Object - way, node, relation\n            } else if ((o=this.OBJECT.exec(css))) {\n                // TODO: raise error if object is none of node|way|relation|line|area|canvas|* ?\n                if (previous===this.oDECLARATION) { this.saveChooser(sc); sc=new StyleChooser(); }\n\n                css=css.replace(this.OBJECT,'');\n                sc.currentChain().addRule(o[1]);\n                previous=this.oOBJECT;\n\n                // Subpart - ::centreline\n            } else if ((o=this.SUBPART.exec(css))) {\n                if (previous===this.oDECLARATION) { this.saveChooser(sc); sc=new StyleChooser(); }\n                css=css.replace(this.SUBPART,'');\n                sc.currentChain().setSubpart(o[1]);\n                previous=this.oSUBPART;\n\n                // Declaration - {...}\n            } else if ((o=this.DECLARATION.exec(css))) {\n                css=css.replace(this.DECLARATION,'');\n                sc.addStyles(this.parseDeclaration(o[1]));\n                previous=this.oDECLARATION;\n\n                // Unknown pattern\n            } else if ((o=this.UNKNOWN.exec(css))) {\n                css=css.replace(this.UNKNOWN,'');\n                // TODO: own error class\n                throw new Error(\"Error while parsing MapCSS at \\\"\"+o[1]+(css.length>38?css.substr(0,36)+\"...\":css)+\"\\\"\");\n                // console.log(\"unknown: \"+o[1]);\n            } else {\n                // console.log(\"choked on \"+css);\n                throw new Error(\"MapCSS parsing choked on \"+css);\n            }\n        }\n        if (previous===this.oDECLARATION) { this.saveChooser(sc); sc=new StyleChooser(); }\n        if (this.callback) { this.callback(); }\n    },\n\n    saveChooser:function(sc) {\n        this.choosers.push(sc);\n    },\n\n    parseDeclaration:function(s) {\n        var styles=[];\n        var t={};\n        var o={};\n        var k, v;\n\n        // Create styles\n        var ss = new ShapeStyle();\n        var ps = new PointStyle();\n        var ts = new TextStyle();\n        var hs = new ShieldStyle();\n        var xs = new InstructionStyle();\n        var ms = new MetaStyle();\n\n        var r=s.split(';');\n        var isEval={};\n        for (var i in r) {\n            var a=r[i];\n            if ((o=this.ASSIGNMENT_EVAL.exec(a)))   { k=o[1].replace(this.DASH,'_'); t[k]=o[2]; isEval[k]=true; }\n            else if ((o=this.ASSIGNMENT.exec(a)))   { k=o[1].replace(this.DASH,'_'); t[k]=o[2]; }\n            else if ((o=this.SET_TAG_EVAL.exec(a))) { } // xs.addSetTag(o[1],this.saveEval(o[2]));\n            else if ((o=this.SET_TAG.exec(a)))      { xs.addSetTag(o[1],o[2]); }\n            else if ((o=this.SET_TAG_TRUE.exec(a))) { xs.addSetTag(o[1],true); }\n            else if ((o=this.EXIT.exec(a)))         { xs.setPropertyFromString('breaker',true); }\n        }\n\n        /*// Find sublayer\n        // TODO: Why the renaming z_index -> sublayer? \n        //       This hardcoded variable isn't used anywhere.\n        //       Looks like this was replaced by the \"subparts\"...\n        var sub=5;\n        if (t['z_index']) { sub=Number(t['z_index']); delete t['z_index']; }\n        ss.sublayer=ps.sublayer=ts.sublayer=hs.sublayer=sub;\n        xs.sublayer=10;*/\n\n        /*// Find \"interactive\" property - it's true unless explicitly set false\n        var inter=true;\n        if (t['interactive']) { inter=t['interactive'].match(this.FALSE) ? false : true; delete t['interactive']; }\n        ss.interactive=ps.interactive=ts.interactive=hs.interactive=xs.interactive=inter;*/\n\n        // Munge special values\n        // (we should stop doing this and do it in the style instead)\n        // TODO: font_bold??? wtf? -> support propper MapCSS properites!\n        if (t['font_weight']    ) { t['font_bold'  ]    = t['font_weight'    ].match(this.BOLD  )    ? true : false; delete t['font_weight']; }\n        if (t['font_style']     ) { t['font_italic']    = t['font_style'     ].match(this.ITALIC)    ? true : false; delete t['font_style']; }\n        if (t['text_decoration']) { t['font_underline'] = t['text_decoration'].match(this.UNDERLINE) ? true : false; delete t['text_decoration']; }\n        if (t['text_position']  ) { t['text_center']    = t['text_position'  ].match(this.CENTER)    ? true : false; delete t['text_position']; }\n        if (t['text_transform']) {\n            if (t['text_transform'].match(this.CAPS)) { t['font_caps']=true; } else { t['font_caps']=false; }\n            delete t['text_transform'];\n        }\n\n        // Assign each property to the appropriate style\n        for (a in t) {\n            // Parse properties\n            v = t[a];\n\n            // Set in styles\n            if      (ss.has(a)) { ss.setPropertyFromString(a,v,isEval[a]); }\n            else if (ps.has(a)) { ps.setPropertyFromString(a,v,isEval[a]); }\n            else if (ts.has(a)) { ts.setPropertyFromString(a,v,isEval[a]); }\n            else if (hs.has(a)) { hs.setPropertyFromString(a,v,isEval[a]); }\n            else if (ms.has(a)) { ms.setPropertyFromString(a,v,isEval[a]); }\n            else {\n                // console.log(a+\" not found\");\n            }\n        }\n\n        // Add each style to list\n        if (ss.edited) { styles.push(ss); }\n        if (ps.edited) { styles.push(ps); }\n        if (ts.edited) { styles.push(ts); }\n        if (hs.edited) { styles.push(hs); }\n        if (xs.edited) { styles.push(xs); }\n        if (ms.edited) { styles.push(ms); }\n        return styles;\n    },\n\n    parseZoom:function(s) {\n        var o={};\n        var maxscale =  999; // TODO: hardcoded\n        var minscale = -999; // TODO: hardcoded\n        if      ((o=this.ZOOM_MINMAX.exec(s))) { return [o[1],o[2]]; }\n        else if ((o=this.ZOOM_MIN.exec(s)   )) { return [o[1], maxscale]; }\n        else if ((o=this.ZOOM_MAX.exec(s)   )) { return [minscale, o[1]]; }\n        else if ((o=this.ZOOM_SINGLE.exec(s))) { return [o[1],o[1]]; }\n        return null;\n    },\n\n    parseCondition:function(s) {\n        var o={};\n        if      ((o=this.CONDITION_TRUE.exec(s)))  { return (new Condition()).init('true'\t,o[1]); }\n        else if ((o=this.CONDITION_FALSE.exec(s))) { return (new Condition()).init('false',o[1]); }\n        else if ((o=this.CONDITION_SET.exec(s)))   { return (new Condition()).init('set'\t,o[1]); }\n        else if ((o=this.CONDITION_UNSET.exec(s))) { return (new Condition()).init('unset',o[1]); }\n        else if ((o=this.CONDITION_NE.exec(s)))    { return (new Condition()).init('ne'\t,o[1],o[2]); }\n        else if ((o=this.CONDITION_GT.exec(s)))    { return (new Condition()).init('>'\t,o[1],o[2]); }\n        else if ((o=this.CONDITION_GE.exec(s)))    { return (new Condition()).init('>='\t,o[1],o[2]); }\n        else if ((o=this.CONDITION_LT.exec(s)))    { return (new Condition()).init('<'\t,o[1],o[2]); }\n        else if ((o=this.CONDITION_LE.exec(s)))    { return (new Condition()).init('<='\t,o[1],o[2]); }\n        else if ((o=this.CONDITION_REGEX.exec(s))) { return (new Condition()).init('regex',o[1],o[2]); }\n        else if ((o=this.CONDITION_EQ.exec(s)))    { return (new Condition()).init('eq'\t,o[1],o[2]); }\n        return null;\n    },\n\n    parseCSSColor:function(colorStr) {\n        // todo: this should be done at user (=style consumer) side (if necessary).\n        // -> move to a more appropriate location\n        colorStr = colorStr.toLowerCase();\n        if (this.CSSCOLORS[colorStr]) {\n            return this.CSSCOLORS[colorStr];\n        } else {\n            var match = this.HEX.exec(colorStr);\n            if ( match ) { \n                if ( match[1].length === 3) {\n                    // repeat digits. #abc => 0xaabbcc\n                    return Number(\"0x\"+match[1].charAt(0)+match[1].charAt(0)+\n                                  match[1].charAt(1)+match[1].charAt(1)+\n                                  match[1].charAt(2)+match[1].charAt(2));\n                } else if ( match[1].length === 6) {\n                    return Number(\"0x\"+match[1]);\n                } else {\n                    return Number(\"0x000000\"); //as good as any\n                }\n            }\n        }\n        return 0;\n    },\n\n    // Regular expression tests and other constants\n\n    WHITESPACE\t:/^\\s+/,\n    COMMENT\t\t:/\\/\\*.+?\\*\\/\\s*/,\n    CLASS\t\t:/^([.:]\\w+)\\s*/,\n    NOT_CLASS\t:/^!([.:]\\w+)\\s*/,\n    ZOOM\t\t:/^\\|\\s*z([\\d-]+)\\s*/i,\n    GROUP\t\t:/^,\\s*/i,\n    CONDITION\t:/^\\[(.+?)\\]\\s*/,\n    OBJECT\t\t:/^(\\w+|\\*)\\s*/,\n    DECLARATION\t:/^\\{(.+?)\\}\\s*/,\n    SUBPART\t\t:/^::(\\w+)\\s*/,\n    UNKNOWN\t\t:/^(\\S+)\\s*/,\n    \n    ZOOM_MINMAX\t:/^(\\d+)-(\\d+)$/,\n    ZOOM_MIN\t:/^(\\d+)-$/,\n    ZOOM_MAX\t:/^-(\\d+)$/,\n    ZOOM_SINGLE\t:/^(\\d+)$/,\n    \n    CONDITION_TRUE      :/^\\s*([:\\w]+)\\s*=\\s*yes\\s*$/i,\n    CONDITION_FALSE     :/^\\s*([:\\w]+)\\s*=\\s*no\\s*$/i,\n    CONDITION_SET       :/^\\s*([:\\w]+)\\s*$/,\n    CONDITION_UNSET     :/^\\s*!([:\\w]+)\\s*$/,\n    CONDITION_EQ        :/^\\s*([:\\w]+)\\s*=\\s*(.+)\\s*$/,\n    CONDITION_NE        :/^\\s*([:\\w]+)\\s*!==\\s*(.+)\\s*$/,\n    CONDITION_GT        :/^\\s*([:\\w]+)\\s*>\\s*(.+)\\s*$/,\n    CONDITION_GE        :/^\\s*([:\\w]+)\\s*>=\\s*(.+)\\s*$/,\n    CONDITION_LT        :/^\\s*([:\\w]+)\\s*<\\s*(.+)\\s*$/,\n    CONDITION_LE        :/^\\s*([:\\w]+)\\s*<=\\s*(.+)\\s*$/,\n    CONDITION_REGEX     :/^\\s*([:\\w]+)\\s*=~\\/\\s*(.+)\\/\\s*$/,\n    \n    ASSIGNMENT_EVAL\t:/^\\s*(\\S+)\\s*:\\s*eval\\s*\\(\\s*['\"](.+?)['\"]\\s*\\)\\s*$/i, // TODO: match only two matching quotes\n    ASSIGNMENT\t\t:/^\\s*(\\S+)\\s*:\\s*(.+?)\\s*$/,\n    SET_TAG_EVAL\t:/^\\s*set\\s+(\\S+)\\s*=\\s*eval\\s*\\(\\s*'(.+?)'\\s*\\)\\s*$/i,\n    SET_TAG\t\t\t:/^\\s*set\\s+(\\S+)\\s*=\\s*(.+?)\\s*$/i,\n    SET_TAG_TRUE\t:/^\\s*set\\s+(\\S+)\\s*$/i,\n    EXIT\t\t\t:/^\\s*exit\\s*$/i,\n    \n    oZOOM: \t\t\t2,\n    oGROUP: \t\t3,\n    oCONDITION: \t4,\n    oOBJECT: \t\t5,\n    oDECLARATION: \t6,\n    oSUBPART: \t\t7,\n    \n    DASH: \t/-/g,\n    COLOR: \t/color$/,\n    BOLD: \t/^bold$/i,\n    ITALIC: /^italic|oblique$/i,\n    UNDERLINE: /^underline$/i,\n    CAPS: \t/^uppercase$/i,\n    CENTER: /^center$/i,\n    FALSE: \t/^(no|false|0)$/i,\n    \n    HEX: \t/^#([0-9a-f]+)$/i,\n    \n    CSSCOLORS: {\n        aliceblue:0xf0f8ff,\n        antiquewhite:0xfaebd7,\n        aqua:0x00ffff,\n        aquamarine:0x7fffd4,\n        azure:0xf0ffff,\n        beige:0xf5f5dc,\n        bisque:0xffe4c4,\n        black:0x000000,\n        blanchedalmond:0xffebcd,\n        blue:0x0000ff,\n        blueviolet:0x8a2be2,\n        brown:0xa52a2a,\n        burlywood:0xdeb887,\n        cadetblue:0x5f9ea0,\n        chartreuse:0x7fff00,\n        chocolate:0xd2691e,\n        coral:0xff7f50,\n        cornflowerblue:0x6495ed,\n        cornsilk:0xfff8dc,\n        crimson:0xdc143c,\n        cyan:0x00ffff,\n        darkblue:0x00008b,\n        darkcyan:0x008b8b,\n        darkgoldenrod:0xb8860b,\n        darkgray:0xa9a9a9,\n        darkgreen:0x006400,\n        darkkhaki:0xbdb76b,\n        darkmagenta:0x8b008b,\n        darkolivegreen:0x556b2f,\n        darkorange:0xff8c00,\n        darkorchid:0x9932cc,\n        darkred:0x8b0000,\n        darksalmon:0xe9967a,\n        darkseagreen:0x8fbc8f,\n        darkslateblue:0x483d8b,\n        darkslategray:0x2f4f4f,\n        darkturquoise:0x00ced1,\n        darkviolet:0x9400d3,\n        deeppink:0xff1493,\n        deepskyblue:0x00bfff,\n        dimgray:0x696969,\n        dodgerblue:0x1e90ff,\n        firebrick:0xb22222,\n        floralwhite:0xfffaf0,\n        forestgreen:0x228b22,\n        fuchsia:0xff00ff,\n        gainsboro:0xdcdcdc,\n        ghostwhite:0xf8f8ff,\n        gold:0xffd700,\n        goldenrod:0xdaa520,\n        gray:0x808080,\n        green:0x008000,\n        greenyellow:0xadff2f,\n        honeydew:0xf0fff0,\n        hotpink:0xff69b4,\n        indianred:0xcd5c5c,\n        indigo:0x4b0082,\n        ivory:0xfffff0,\n        khaki:0xf0e68c,\n        lavender:0xe6e6fa,\n        lavenderblush:0xfff0f5,\n        lawngreen:0x7cfc00,\n        lemonchiffon:0xfffacd,\n        lightblue:0xadd8e6,\n        lightcoral:0xf08080,\n        lightcyan:0xe0ffff,\n        lightgoldenrodyellow:0xfafad2,\n        lightgrey:0xd3d3d3,\n        lightgreen:0x90ee90,\n        lightpink:0xffb6c1,\n        lightsalmon:0xffa07a,\n        lightseagreen:0x20b2aa,\n        lightskyblue:0x87cefa,\n        lightslategray:0x778899,\n        lightsteelblue:0xb0c4de,\n        lightyellow:0xffffe0,\n        lime:0x00ff00,\n        limegreen:0x32cd32,\n        linen:0xfaf0e6,\n        magenta:0xff00ff,\n        maroon:0x800000,\n        mediumaquamarine:0x66cdaa,\n        mediumblue:0x0000cd,\n        mediumorchid:0xba55d3,\n        mediumpurple:0x9370d8,\n        mediumseagreen:0x3cb371,\n        mediumslateblue:0x7b68ee,\n        mediumspringgreen:0x00fa9a,\n        mediumturquoise:0x48d1cc,\n        mediumvioletred:0xc71585,\n        midnightblue:0x191970,\n        mintcream:0xf5fffa,\n        mistyrose:0xffe4e1,\n        moccasin:0xffe4b5,\n        navajowhite:0xffdead,\n        navy:0x000080,\n        oldlace:0xfdf5e6,\n        olive:0x808000,\n        olivedrab:0x6b8e23,\n        orange:0xffa500,\n        orangered:0xff4500,\n        orchid:0xda70d6,\n        palegoldenrod:0xeee8aa,\n        palegreen:0x98fb98,\n        paleturquoise:0xafeeee,\n        palevioletred:0xd87093,\n        papayawhip:0xffefd5,\n        peachpuff:0xffdab9,\n        peru:0xcd853f,\n        pink:0xffc0cb,\n        plum:0xdda0dd,\n        powderblue:0xb0e0e6,\n        purple:0x800080,\n        red:0xff0000,\n        rosybrown:0xbc8f8f,\n        royalblue:0x4169e1,\n        saddlebrown:0x8b4513,\n        salmon:0xfa8072,\n        sandybrown:0xf4a460,\n        seagreen:0x2e8b57,\n        seashell:0xfff5ee,\n        sienna:0xa0522d,\n        silver:0xc0c0c0,\n        skyblue:0x87ceeb,\n        slateblue:0x6a5acd,\n        slategray:0x708090,\n        snow:0xfffafa,\n        springgreen:0x00ff7f,\n        steelblue:0x4682b4,\n        tan:0xd2b48c,\n        teal:0x008080,\n        thistle:0xd8bfd8,\n        tomato:0xff6347,\n        turquoise:0x40e0d0,\n        violet:0xee82ee,\n        wheat:0xf5deb3,\n        white:0xffffff,\n        whitesmoke:0xf5f5f5,\n        yellow:0xffff00,\n        yellowgreen:0x9acd32\n    },\n    \n};\n\nexport default MapCSSRuleSet;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport RuleSet from \"./RuleSet\";\n\n/**\n * Map styler generates style for Leaflet according to a {@link https://wiki.openstreetmap.org/wiki/MapCSS/0.2|MapCSS} stylesheet.\n * The stylesheet is automatically loaded from `src/config/style.mapcss`.\n *\n * Parts of this mapcss package are based on {@link https://github.com/tyrasd/overpass-turbo|Overpass-Turbo} MapCSS interpreter.\n */\nclass MapStyler {\n\tconstructor() {\n\t\tfetch('./style.mapcss')\n\t\t.then(res => res.text())\n\t\t.then(styles => {\n\t\t\tthis.mapcss = new RuleSet();\n\t\t\tthis.mapcss.parseCSS(styles);\n\t\t});\n\t}\n\n\t/**\n\t * Get the Leaflet Path style for given feature.\n\t * @param {Object} feature The GeoJSON feature to style\n\t * @param {boolean} highlight Is this feature selected ?\n\t * @return {Object} The style for Leaflet object (see {@link https://leafletjs.com/reference-1.4.0.html#path|documentation} for details)\n\t */\n\tgetFeatureStyle(feature, highlight) {\n\t\tif(!feature) { return {}; }\n\n\t\t// Override for building doors\n\t\tif(feature.properties.tags && feature.properties.tags.door && feature.properties.own && feature.properties.own.onBuildingContour) {\n\t\t\treturn { opacity: 1, fillOpacity: 1, weight: 2, radius: 7, color: \"#8B3100\", fillColor: \"#FF6B00\" };\n\t\t}\n\n\t\tconst stl = {};\n\t\tconst s = this._getFeatureStyleMapCSS(feature, highlight);\n\t\tif(!s) { return stl; }\n\n\t\t// apply mapcss styles\n\t\tconst get_property = (st, properties) => {\n\t\t\tif(st && properties) {\n\t\t\t\tfor (let i = properties.length - 1; i >= 0; i--) {\n\t\t\t\t\tif (st && st[properties[i]] !== undefined) {\n\t\t\t\t\t\treturn st[properties[i]];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn undefined;\n\t\t};\n\n\t\tlet styles;\n\n\t\tswitch (feature.geometry.type) {\n\t\t\tcase \"Point\":\n\t\t\t\tstyles = Object.assign(\n\t\t\t\t\t{},\n\t\t\t\t\ts.shapeStyles[\"default\"],\n\t\t\t\t\ts.pointStyles[\"default\"]\n\t\t\t\t);\n\n\t\t\t\tstl.color = get_property(styles, [\n\t\t\t\t\t\"color\",\n\t\t\t\t\t\"symbol_stroke_color\"\n\t\t\t\t]);\n\n\t\t\t\tstl.opacity = get_property(styles, [\n\t\t\t\t\t\"opacity\",\n\t\t\t\t\t\"symbol_stroke_opacity\"\n\t\t\t\t]);\n\n\t\t\t\tstl.weight = get_property(styles, [\n\t\t\t\t\t\"width\",\n\t\t\t\t\t\"symbol_stroke_width\"\n\t\t\t\t]);\n\n\t\t\t\tstl.radius = get_property(styles, [\n\t\t\t\t\t\"symbol_size\"\n\t\t\t\t]);\n\t\t\t\tif(stl.radius) { stl.radius = stl.radius/2; }\n\n\t\t\t\tstl.fillColor = get_property(styles, [\n\t\t\t\t\t\"fill_color\",\n\t\t\t\t\t\"symbol_fill_color\"\n\t\t\t\t]);\n\n\t\t\t\tstl.fillOpacity = get_property(styles, [\n\t\t\t\t\t\"fill_opacity\",\n\t\t\t\t\t\"symbol_fill_opacity\"\n\t\t\t\t]);\n\n\t\t\t\tstl.zIndex = get_property(styles, [\"z_index\"]);\n\t\t\t\tstl.iconImage = this._getImageIconUrl(styles, feature);\n\n\t\t\t\tlet pda = get_property(styles, [\"dashes\"]);\n\t\t\t\tif (pda !== undefined) stl.dashArray = pda.join(\",\");\n\n\t\t\t\tbreak;\n\n\t\t\tcase \"LineString\":\n\t\t\tcase \"MultiLineString\":\n\t\t\t\tstyles = Object.assign(\n\t\t\t\t\t{},\n\t\t\t\t\ts.shapeStyles[\"default\"],\n\t\t\t\t\ts.pointStyles[\"default\"]\n\t\t\t\t);\n\t\t\t\tstl.color = get_property(styles, [\"color\"]);\n\t\t\t\tstl.opacity = get_property(styles, [\"opacity\"]);\n\t\t\t\tstl.weight = get_property(styles, [\"width\"]);\n\t\t\t\tstl.lineCap = get_property(styles, [\"linecap\"]);\n\t\t\t\tstl.zIndex = get_property(styles, [\"z_index\"]);\n\t\t\t\tstl.iconImage = this._getImageIconUrl(styles, feature);\n\t\t\t\tif(stl.lineCap === \"none\") { stl.lineCap = \"butt\"; }\n\n\t\t\t\tlet p1 = get_property(styles, [\"offset\"]);\n\t\t\t\tif (p1 !== undefined) stl.offset = -p1; // MapCSS and PolylineOffset definitions use different signs\n\n\t\t\t\tlet p2 = get_property(styles, [\"dashes\"]);\n\t\t\t\tif (p2 !== undefined) stl.dashArray = p2.join(\",\");\n\t\t\t\tbreak;\n\n\t\t\tcase \"Polygon\":\n\t\t\tcase \"MultiPolygon\":\n\t\t\t\tstyles = Object.assign(\n\t\t\t\t\t{},\n\t\t\t\t\ts.shapeStyles[\"default\"],\n\t\t\t\t\ts.pointStyles[\"default\"]\n\t\t\t\t);\n\t\t\t\tstl.color = get_property(styles, [\"color\", \"casing_color\"]);\n\t\t\t\tstl.zIndex = get_property(styles, [\"z_index\"]);\n\t\t\t\tstl.iconImage = this._getImageIconUrl(styles, feature);\n\n\t\t\t\tstl.opacity = get_property(styles, [\n\t\t\t\t\t\"opacity\",\n\t\t\t\t\t\"casing_opacity\"\n\t\t\t\t]);\n\t\t\t\tstl.weight = get_property(styles, [\"width\", \"casing_width\"]);\n\t\t\t\tstl.fillColor = get_property(styles, [\"fill_color\"]);\n\t\t\t\tstl.fillOpacity = get_property(styles, [\"fill_opacity\"]);\n\n\t\t\t\tlet p = get_property(styles, [\"dashes\"]);\n\t\t\t\tif (p !== undefined) stl.dashArray = p.join(\",\");\n\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t}\n\n\t\t// todo: more style properties? linejoin?\n\n\t\t// Clean up undefined values\n\t\tfor(const k in stl) {\n\t\t\tif(stl[k] === undefined) { delete stl[k]; }\n\t\t}\n\n\t\t// return style object\n\t\treturn stl;\n\t}\n\n\t_getFeatureStyleMapCSS(feature, highlight) {\n\t\treturn this.mapcss ? this.mapcss.getStyles(\n\t\t\t{\n\t\t\t\tisSubject: this._isSubject(feature),\n\t\t\t\tgetParentObjects: this._getParentObjects(feature)\n\t\t\t},\n\t\t\tObject.assign(\n\t\t\t\tfeature.properties && feature.properties.tainted\n\t\t\t\t\t? {\":tainted\": true}\n\t\t\t\t\t: {},\n\t\t\t\tfeature.properties && feature.properties.geometry\n\t\t\t\t\t? {\":placeholder\": true}\n\t\t\t\t\t: {},\n\t\t\t\tfeature.is_placeholder ? {\":placeholder\": true} : {},\n\t\t\t\tthis._hasInterestingTags(feature.properties)\n\t\t\t\t\t? {\":tagged\": true}\n\t\t\t\t\t: {\":untagged\": true},\n\t\t\t\thighlight ? {\":active\": true} : {},\n\t\t\t\t(function(tags, meta, id) {\n\t\t\t\t\tconst res = {\"@id\": id};\n\t\t\t\t\tfor (let key in meta) res[\"@\" + key] = meta[key];\n\t\t\t\t\tfor (let key in tags) {\n\t\t\t\t\t\tres[key.replace(/^@/, \"@@\")] = tags[key];\n\t\t\t\t\t}\n\t\t\t\t\treturn res;\n\t\t\t\t})(\n\t\t\t\t\tfeature.properties.tags,\n\t\t\t\t\tfeature.properties.meta,\n\t\t\t\t\tfeature.properties.id\n\t\t\t\t)\n\t\t\t),\n\t\t\t18\n\t\t) : null;\n\t}\n\n\t/**\n\t * @private\n\t */\n\t_hasInterestingTags(props) {\n\t\treturn true; // disabled\n// \t\t// this checks if the node has any tags other than \"created_by\"\n// \t\treturn (\n// \t\t\tprops &&\n// \t\t\tprops.tags &&\n// \t\t\t(function(o) {\n// \t\t\t\tfor (let k in o)\n// \t\t\t\tif (k != \"created_by\" && k != \"source\") return true;\n// \t\t\t\treturn false;\n// \t\t\t})(props.tags)\n// \t\t);\n\t}\n\n\t/**\n\t * Get image URL\n\t * @private\n\t */\n\t_getImageIconUrl(styles, feature) {\n\t\tif(styles && styles.icon_image) {\n\t\t\tconst rgxUrl = /url\\('([a-zA-Z0-9.-_$[\\]]+)'\\)/;\n\t\t\tconst rgxUrlJoker = /\\$\\[(\\w+)\\]/;\n\t\t\tif(styles.icon_image.match(rgxUrl)) {\n\t\t\t\tlet img = rgxUrl.exec(styles.icon_image)[1];\n\n\t\t\t\t//Replace joker values in icon URL\n\t\t\t\twhile(img && rgxUrlJoker.test(img)) {\n\t\t\t\t\t//Replace tag name with actual tag value\n\t\t\t\t\tconst fIconRgxTagName = rgxUrlJoker.exec(img)[1];\n\t\t\t\t\tlet fIconRgxTagValue = feature.properties.tags[fIconRgxTagName];\n\n\t\t\t\t\t//If an alias exists for the given value, replace\n\t\t\t\t\tif(typeof styles.icon_image_aliases[fIconRgxTagValue] === \"string\") {\n\t\t\t\t\t\tfIconRgxTagValue = styles.icon_image_aliases[fIconRgxTagValue];\n\t\t\t\t\t}\n\n\t\t\t\t\timg = img.replace(rgxUrlJoker, fIconRgxTagValue);\n\t\t\t\t}\n\n\t\t\t\treturn img;\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\treturn undefined;\n\t\t}\n\t}\n\n\t/**\n\t * Check if current feature is concerned by style being checked\n\t * @private\n\t */\n\t_isSubject(feature) {\n\t\treturn (subject) => {\n\t\t\tswitch (subject) {\n\t\t\t\tcase \"node\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\tfeature.properties.type === \"node\" ||\n\t\t\t\t\t\tfeature.geometry.type === \"Point\"\n\t\t\t\t\t);\n\n\t\t\t\tcase \"area\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\tfeature.geometry.type === \"Polygon\" ||\n\t\t\t\t\t\tfeature.geometry.type === \"MultiPolygon\"\n\t\t\t\t\t);\n\n\t\t\t\tcase \"line\":\n\t\t\t\t\treturn (\n\t\t\t\t\t\tfeature.geometry.type === \"LineString\" ||\n\t\t\t\t\t\tfeature.geometry.type === \"MultiLineString\"\n\t\t\t\t\t);\n\n\t\t\t\tcase \"way\":\n\t\t\t\t\treturn feature.properties.type === \"way\";\n\n\t\t\t\tcase \"relation\":\n\t\t\t\t\treturn feature.properties.type === \"relation\";\n\n\t\t\t\tdefault:\n\t\t\t\t\treturn false;\n\t\t\t}\n\t\t};\n\t}\n\n\t/**\n\t * Get parent objects for this feature\n\t * @private\n\t */\n\t_getParentObjects(feature) {\n\t\treturn () => {\n\t\t\tif (!feature.properties.relations || !Array.isArray(feature.properties.relations) || feature.properties.relations.length === 0) {\n\t\t\t\treturn [];\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn feature.properties.relations.map((rel) => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttags: rel.reltags,\n\t\t\t\t\t\tisSubject: (subject) => {\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\tsubject === \"relation\" ||\n\t\t\t\t\t\t\t\t(subject === \"area\" &&\n\t\t\t\t\t\t\t\t\trel.reltags.type === \"multipolyon\")\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t},\n\t\t\t\t\t\tgetParentObjects: function() {\n\t\t\t\t\t\t\treturn [];\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\t}\n}\n\nexport default MapStyler;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport { Control, DomUtil } from 'leaflet';\nimport { withLeaflet, MapControl } from 'react-leaflet';\n\nconst NorthPointerControl = Control.extend({\n\tonAdd: function(map) {\n\t\tconst container = DomUtil.create(\"div\", \"leaflet-bar leaflet-control-north\");\n\t\tconst img = DomUtil.create(\"img\");\n\t\timg.src = \"img/north.png\";\n\t\tcontainer.appendChild(img);\n\t\treturn container;\n\t}\n});\n\n/**\n * North Pointer is a React-Leaflet control to display a north pointer.\n */\nclass NorthPointer extends MapControl {\n\tcreateLeafletElement(props) {\n\t\treturn new NorthPointerControl(props);\n\t}\n}\n\nexport default withLeaflet(NorthPointer);\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport { Control, DomUtil } from 'leaflet';\nimport { withLeaflet, MapControl } from 'react-leaflet';\nimport PubSub from 'pubsub-js';\n\nconst SideButtonControl = Control.extend({\n\tonAdd: function(map) {\n\t\tthis.container = DomUtil.create(\"div\", \"leaflet-bar leaflet-control-sidepanelbtn hide-xsDown\");\n\t\tconst btn = DomUtil.create(\"a\");\n\t\tbtn.innerHTML = \"<svg><path d='M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z' /></svg>\";\n\t\tbtn.addEventListener(\"click\", () => PubSub.publish(\"body.panel.toggle\", { panel: \"right\" }));\n\t\tthis.container.appendChild(btn);\n\t\treturn this.container;\n\t}\n});\n\n/**\n * Side panel button is a react-leaflet control for opening right panel\n */\nclass SidePanelButton extends MapControl {\n\tcreateLeafletElement(props) {\n\t\treturn new SideButtonControl(props);\n\t}\n}\n\nexport default withLeaflet(SidePanelButton);\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport 'leaflet/dist/leaflet.css';\nimport L from 'leaflet';\nimport 'leaflet-hash';\nimport { Map, TileLayer, WMSTileLayer, AttributionControl, ScaleControl } from 'react-leaflet';\nimport { BingLayer } from 'react-leaflet-bing';\nimport Body from './Body';\nimport Building from './layers/Building';\nimport Features from './layers/Features';\nimport FloorImagery from './layers/FloorImagery';\nimport I18n from '../config/locales/ui';\nimport Levels from './layers/Levels';\nimport LevelSelector from './common/LevelSelector';\nimport MapStyler from '../model/mapcss/MapStyler';\nimport NorthPointer from './common/NorthPointer';\nimport PACKAGE from '../../package.json';\nimport PubSub from 'pubsub-js';\nimport SidePanelButton from './common/SidePanelButton';\nimport Spinner from 'react-bootstrap/Spinner';\n\nconst MAP_MAX_ZOOM = 26;\n\n/*\n * Extend leaflet hash for handling level value\n */\n\nL.Hash.parseHash = function(hash) {\n\tif(hash.indexOf('#') === 0) {\n\t\thash = hash.substr(1);\n\t}\n\tvar args = hash.split(\"/\");\n\tif (args.length >= 3 && args.length <= 4) {\n\t\tvar zoom = parseInt(args[0], 10),\n\t\tlat = parseFloat(args[1]),\n\t\tlon = parseFloat(args[2]),\n\t\tlevel = args.length === 4 ? parseInt(args[3], 10) : 0;\n\n\t\tif (isNaN(zoom) || isNaN(lat) || isNaN(lon)) {\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn {\n\t\t\t\tcenter: new L.LatLng(lat, lon),\n\t\t\t\tzoom: zoom,\n\t\t\t\tlevel: isNaN(level) ? 0 : level\n\t\t\t};\n\t\t}\n\t} else {\n\t\treturn false;\n\t}\n};\nL.Hash.prototype.parseHash = L.Hash.parseHash;\n\nL.Hash.formatHash = function(map) {\n\tvar center = map.getCenter(),\n\t\tzoom = map.getZoom(),\n\t\tprecision = Math.max(0, Math.ceil(Math.log(zoom) / Math.LN2));\n\n\treturn \"#\" + [zoom,\n\t\tcenter.lat.toFixed(precision),\n\t\tcenter.lng.toFixed(precision),\n\t\tthis._level || \"0\"\n\t].join(\"/\");\n};\nL.Hash.prototype.formatHash = L.Hash.formatHash;\n\nL.Hash.prototype.setLevel = function(lvl) {\n\tif(this._level !== lvl) {\n\t\tthis._level = lvl;\n\t\tvar hash = this.formatHash(this.map);\n\t\twindow.location.replace(hash);\n\t\tthis.lastHash = hash;\n\t}\n};\n\nL.Hash.prototype.update = function() {\n\tvar hash = window.location.hash;\n\tif (hash === this.lastHash) {\n\t\treturn;\n\t}\n\tvar parsed = this.parseHash(hash);\n\tif (parsed) {\n\t\tthis.movingMap = true;\n\t\tthis.map.setView(parsed.center, parsed.zoom);\n\t\tthis.movingMap = false;\n\t\tPubSub.publish(\"body.level.set\", { level: parsed.level });\n\t} else {\n\t\tthis.onMapMove(this.map);\n\t}\n};\n\n\n/**\n * Map component handles the whole map and associated widgets.\n */\nclass MyMap extends Component {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.state = {\n\t\t\tloading: false,\n\t\t\tdataready: false\n\t\t};\n\n\t\tthis.mapStyler = new MapStyler();\n\t\tthis.loadedArea = null;\n\t}\n\n\t/**\n\t * Alert this component that its size has changed\n\t */\n\tinvalidateSize() {\n\t\tif(this.elem && this.elem.leafletElement) {\n\t\t\tthis.elem.leafletElement.invalidateSize();\n\t\t}\n\t}\n\n\t/**\n\t * Clean up map after changeset upload\n\t */\n\tcleanUp() {\n\t\tthis.loadedArea = null;\n\t\tthis.setState({ loading: false, dataready: false });\n\t}\n\n\t/**\n\t * Get the coordinates of map center\n\t * @return {LatLng} Coordinates of map center (or null if not ready)\n\t */\n\tgetCenter() {\n\t\treturn (this.elem && this.elem.leafletElement) ? this.elem.leafletElement.getCenter() : null;\n\t}\n\n\t/**\n\t * Get the bounding box of currently shown area on map\n\t * @return {LatLngBounds} Bounding box of the map\n\t */\n\tgetBounds() {\n\t\treturn (this.elem && this.elem.leafletElement) ? this.elem.leafletElement.getBounds() : null;\n\t}\n\n\t/**\n\t * Is the map currently loading data ?\n\t * @return {boolean} True if loading\n\t */\n\tisLoading() {\n\t\treturn this.state.loading;\n\t}\n\n\t/**\n\t * Event handler when map moves\n\t * @private\n\t */\n\tasync _loadData(bounds) {\n\t\tif(this.props.datalocked || (window.CONFIG.always_authenticated && !window.editor_user)) {\n\t\t\treturn new Promise(resolve => {\n\t\t\t\tsetTimeout(() => resolve(this._loadData(bounds)), 100);\n\t\t\t});\n\t\t}\n\t\telse if(!this.props.draw && this.getBounds() && this.elem.leafletElement.getZoom() >= window.CONFIG.data_min_zoom) {\n\t\t\tlet bbox = bounds || this.getBounds();\n\n\t\t\t// Only load data if bbox is valid and not in an already downloaded area\n\t\t\tif(\n\t\t\t\tbbox\n\t\t\t\t&& bbox.getSouth() !== bbox.getNorth()\n\t\t\t\t&& bbox.getWest() !== bbox.getEast()\n\t\t\t\t&& (!this.loadedArea || !this.loadedArea.contains(bbox))\n\t\t\t) {\n\t\t\t\t// Augment bbox size if too small (to avoid many data reloads)\n\t\t\t\twhile(bbox.getSouthWest().distanceTo(bbox.getNorthEast()) < 400) {\n\t\t\t\t\tbbox = bbox.pad(0.1);\n\t\t\t\t}\n\n\t\t\t\tthis.loadedArea = bbox;\n\t\t\t\tthis.setState(\n\t\t\t\t\t{ loading: true },\n\t\t\t\t\tasync () => {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst result = await window.vectorDataManager.loadOSMData(bbox);\n\t\t\t\t\t\t\tthis.setState({ loading: false, dataready: result });\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcatch(e) {\n\t\t\t\t\t\t\talert(I18n.t(\"Can't download data from OSM server. Please retry later.\"));\n\t\t\t\t\t\t\tthis.setState({ loading: false, dataready: false });\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Generate layer from given configuration\n\t * @private\n\t */\n\t_getLayer(l, opacity) {\n\t\tif(!l || !l.properties || !l.properties.url) {\n\t\t\treturn null;\n\t\t}\n\n\t\tif(l.properties.type === \"tms\") {\n\t\t\tconst url = l.properties.url\n\t\t\t\t.replace(/\\{zoom\\}/g, \"{z}\")\n\t\t\t\t.replace(/\\{switch:.+?\\}/g, \"{s}\")\n\t\t\t\t.replace(/\\{-y\\}/g, \"{y}\");\n\n\t\t\treturn <TileLayer\n\t\t\t\tattribution={l.properties.attribution ? '<a href=\"'+l.properties.attribution.url+'\" target=\"_blank\">'+l.properties.attribution.text+'</a>' : ''}\n\t\t\t\turl={url}\n\t\t\t\tkey={url}\n\t\t\t\tminZoom={l.properties.min_zoom}\n\t\t\t\tmaxNativeZoom={l.properties.max_zoom}\n\t\t\t\tmaxZoom={MAP_MAX_ZOOM}\n\t\t\t\topacity={opacity}\n\t\t\t\ttms={l.properties.url.indexOf(\"{-y}\") > 0}\n\t\t\t/>;\n\t\t}\n\t\telse if(l.properties.type === \"wms\") {\n\t\t\tlet url = l.properties.url;\n\t\t\tconst params = {};\n\t\t\tconst urlParts = l.properties.url.split('?');\n\n\t\t\tif(urlParts.length > 1) {\n\t\t\t\turl = urlParts[0];\n\t\t\t\tconst blacklist = ['srs', 'width', 'height', 'format', 'service', 'request', 'bbox', 'key', 'crs'];\n\n\t\t\t\turlParts[1].split('&').forEach(p => {\n\t\t\t\t\tconst [k,v] = p.split('=');\n\t\t\t\t\tif(!blacklist.includes(k.toLowerCase())) {\n\t\t\t\t\t\tparams[k.toLowerCase()] = v;\n\t\t\t\t\t}\n\t\t\t\t\telse if(['key'].includes(k.toLowerCase())) {\n\t\t\t\t\t\tparams[k.toUpperCase()] = v;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn <WMSTileLayer\n\t\t\t\tattribution={l.properties.attribution ? '<a href=\"'+l.properties.attribution.url+'\" target=\"_blank\">'+l.properties.attribution.text+'</a>' : ''}\n\t\t\t\turl={url}\n\t\t\t\tkey={l.properties.url}\n\t\t\t\topacity={opacity}\n\t\t\t\t{...params}\n\t\t\t/>;\n\t\t}\n\t\telse if(l.properties.type === \"bing\" && window.CONFIG.providers && window.CONFIG.providers.bing) {\n\t\t\treturn <BingLayer\n\t\t\t\tbingkey={window.CONFIG.providers.bing}\n\t\t\t\ttype=\"Aerial\"\n\t\t\t\tmaxNativeZoom={20}\n\t\t\t\tmaxZoom={MAP_MAX_ZOOM}\n\t\t\t/>;\n\t\t}\n\t\telse {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Converts floor imagery info into a Leaflet layer.\n\t * @private\n\t */\n\t_getFloorMapLayer(floormap) {\n\t\tif(!floormap || !floormap.topleft) {\n\t\t\treturn null;\n\t\t}\n\t\telse {\n\t\t\treturn <FloorImagery\n\t\t\t\tdata={floormap}\n\t\t\t\tkey={floormap.id}\n\t\t\t\topacity={floormap.opacity !== undefined && !isNaN(parseFloat(floormap.opacity)) ? floormap.opacity : 1}\n\t\t\t\tref={\"floormap_\"+floormap.id}\n\t\t\t\tlevel={this.props.level}\n\t\t\t\tmode={this.props.mode}\n\t\t\t\ttool={this.props.floorImageryMode}\n\t\t\t/>;\n\t\t}\n\t}\n\n\trender() {\n\t\tconst floorImgs = window.imageryManager.getFloorImages();\n\t\tlet levelsList = null;\n\n\t\tif(this.props.mode === Body.MODE_EXPLORE) {\n\t\t\tlevelsList = window.vectorDataManager.getAllLevels(true);\n\t\t}\n\t\telse if(this.props.mode === Body.MODE_BUILDING) {\n\t\t\tif(this.props.building) {\n\t\t\t\tlevelsList = this.props.building.properties.own.levels.slice(0);\n\t\t\t\tlevelsList.sort();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlevelsList = window.vectorDataManager.getAllLevels(false);\n\t\t\t}\n\t\t}\n\t\telse if([ Body.MODE_LEVELS, Body.MODE_FEATURES ].includes(this.props.mode) && this.props.building) {\n\t\t\tlevelsList = this.props.building.properties.own.levels.slice(0);\n\t\t\tlevelsList.sort();\n\t\t}\n\n\t\treturn <div className=\"app-map-container\">\n\t\t\t{(this.props.mode === Body.MODE_CHANGESET || this.state.loading) &&\n\t\t\t\t<div style={{\n\t\t\t\t\tzIndex: 20000,\n\t\t\t\t\tbackground: \"rgba(0,0,0,0.5)\",\n\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\ttop: 0, right: 0, left: 0, bottom: 0,\n\t\t\t\t\ttextAlign: \"center\", display: \"flex\", alignItems: \"center\"\n\t\t\t\t}}>\n\t\t\t\t\t{this.state.loading &&\n\t\t\t\t\t\t<Spinner\n\t\t\t\t\t\t\tanimation=\"grow\"\n\t\t\t\t\t\t\tvariant=\"light\"\n\t\t\t\t\t\t\tsize=\"lg\"\n\t\t\t\t\t\t\tstyle={{ margin: \"auto\", width: \"5rem\", height: \"5rem\" }}\n\t\t\t\t\t\t/>\n\t\t\t\t\t}\n\t\t\t\t</div>\n\t\t\t}\n\t\t\t<Map\n\t\t\t\tmaxZoom={MAP_MAX_ZOOM}\n\t\t\t\tclassName={\"app-map\"+(this.props.draw ? \" leaflet-clickable\" : \"\")}\n\t\t\t\tref={elem => this.elem = elem}\n\t\t\t\tpreferCanvas={false}\n\t\t\t\teditable={true}\n\t\t\t\tscrollWheelZoom={true}\n\t\t\t\tdoubleClickZoom={this.props.mode === Body.MODE_EXPLORE}\n\t\t\t\tattributionControl={false}\n\t\t\t\tboxSelector={false}\n\t\t\t\tboxZoom={false}\n\t\t\t>\n\t\t\t\t<AttributionControl\n\t\t\t\t\tprefix={\"<a href='https://framagit.org/PanierAvide/osminedit' target='_blank'>\"+window.EDITOR_NAME+\"</a> v\"+PACKAGE.version+\" \"+(window.CONFIG.hash === \"GIT_HASH\" ? \"dev\" : window.CONFIG.hash)}\n\t\t\t\t/>\n\n\t\t\t\t<ScaleControl\n\t\t\t\t\tposition=\"bottomleft\"\n\t\t\t\t\timperial={false}\n\t\t\t\t/>\n\n\t\t\t\t<NorthPointer\n\t\t\t\t\tposition=\"bottomright\"\n\t\t\t\t/>\n\n\t\t\t\t<SidePanelButton\n\t\t\t\t\tposition=\"topright\"\n\t\t\t\t/>\n\n\t\t\t\t{[Body.MODE_EXPLORE, Body.MODE_BUILDING, Body.MODE_LEVELS, Body.MODE_FEATURES].includes(this.props.mode) && !this.state.loading && this.state.dataready && levelsList &&\n\t\t\t\t\t<LevelSelector\n\t\t\t\t\t\tposition=\"topright\"\n\t\t\t\t\t\tlevels={levelsList}\n\t\t\t\t\t\tlevel={this.props.level}\n\t\t\t\t\t/>\n\t\t\t\t}\n\n\t\t\t\t{this.props.selectedBaseImagery && this._getLayer(this.props.selectedBaseImagery, this.props.baseImageryOpacity)}\n\n\t\t\t\t{this.props.selectedOverlaysImagery && this.props.selectedOverlaysImagery.map(ol => this._getLayer(ol, this.props.overlaysImageryOpacity))}\n\n\t\t\t\t{this.props.mode !== Body.MODE_EXPLORE && floorImgs && floorImgs.map(fi => this._getFloorMapLayer(fi))}\n\n\t\t\t\t{!this.state.loading && this.state.dataready && [Body.MODE_BUILDING, Body.MODE_FLOOR_IMAGERY].includes(this.props.mode) &&\n\t\t\t\t\t<Building\n\t\t\t\t\t\tstyler={this.mapStyler}\n\t\t\t\t\t\tbuilding={this.props.building}\n\t\t\t\t\t\tdraw={this.props.draw}\n\t\t\t\t\t\tlevel={this.props.level}\n\t\t\t\t\t\tlocked={this.props.mode === Body.MODE_FLOOR_IMAGERY}\n\t\t\t\t\t/>\n\t\t\t\t}\n\n\t\t\t\t{!this.state.loading && this.state.dataready && this.props.mode === Body.MODE_LEVELS && this.props.building &&\n\t\t\t\t\t<Levels\n\t\t\t\t\t\tstyler={this.mapStyler}\n\t\t\t\t\t\tlevel={this.props.level}\n\t\t\t\t\t\tbuilding={this.props.building}\n\t\t\t\t\t\tfloor={this.props.floor}\n\t\t\t\t\t\tdraw={this.props.draw}\n\t\t\t\t\t/>\n\t\t\t\t}\n\n\t\t\t\t{!this.state.loading && this.state.dataready && (this.props.mode === Body.MODE_EXPLORE || (this.props.mode === Body.MODE_FEATURES && this.props.building)) &&\n\t\t\t\t\t<Features\n\t\t\t\t\t\tstyler={this.mapStyler}\n\t\t\t\t\t\tlevel={this.props.level}\n\t\t\t\t\t\tbuilding={this.props.building}\n\t\t\t\t\t\tfeature={this.props.feature}\n\t\t\t\t\t\tdraw={this.props.draw}\n\t\t\t\t\t\tlocked={this.props.mode === Body.MODE_EXPLORE}\n\t\t\t\t\t/>\n\t\t\t\t}\n\t\t\t</Map>\n\t\t</div>;\n\t}\n\n\t/**\n\t * @private\n\t */\n\t_followMouse(e) {\n\t\tthis._mouseCoords = e.latlng;\n\t}\n\n\tcomponentDidMount() {\n\t\tsetTimeout(() => {\n\t\t\tthis.invalidateSize();\n\t\t\tthis._loadData();\n\t\t}, 500);\n\n\t\t// URL hash for map\n\t\tthis._mapHash = new L.Hash(this.elem.leafletElement);\n\n\t\t// If no valid hash found, use default coordinates from config file or stored cookie\n\t\tif(!window.location.hash || !window.location.hash.match(/^#\\d+\\/-?\\d+(.\\d+)?\\/-?\\d+(.\\d+)?(\\/(-?\\d+(.\\d+)?)?)?$/)) {\n\t\t\t// Has cookie ?\n\t\t\tconst cookieHash = document.cookie.replace(/(?:(?:^|.*;\\s*)lasthash\\s*=\\s*([^;]*).*$)|^.*$/, \"$1\");\n\t\t\tlet newHash;\n\n\t\t\tif(cookieHash && L.Hash.parseHash(cookieHash)) {\n\t\t\t\tnewHash = cookieHash;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tnewHash = \"#\"+window.CONFIG.map_initial_zoom+\"/\"+window.CONFIG.map_initial_latlng.join(\"/\");\n\t\t\t}\n\n\t\t\twindow.history.pushState({}, \"\", window.location.href.split(\"#\")[0] + newHash);\n\t\t}\n\n\t\tL.DomEvent.addListener(window, \"hashchange\", () => {\n\t\t\tdocument.cookie = \"lasthash=\"+window.location.hash;\n\t\t});\n\n\t\tthis.elem.leafletElement.on(\"dblclick\", e => {\n\t\t\tif(!this.props.draw && this.props.mode !== Body.MODE_EXPLORE) {\n\t\t\t\tPubSub.publish(\"body.unselect.feature\");\n\t\t\t}\n\t\t});\n\n\t\tthis.elem.leafletElement.on(\"zoomend moveend\", () => {\n\t\t\tif(this.elem && this.elem.leafletElement) {\n\t\t\t\tthis._loadData();\n\n\t\t\t\tconst zoom = this.elem.leafletElement.getZoom();\n\n\t\t\t\tif(zoom < window.CONFIG.data_min_zoom && (!this._lastZoom || this._lastZoom >= window.CONFIG.data_min_zoom)) {\n\t\t\t\t\tthis.elem.container.classList.add(\"app-map-novector\");\n\t\t\t\t\tPubSub.publishSync(\"body.unselect.feature\");\n// \t\t\t\t\tPubSub.publish(\"body.mode.set\", { mode: Body.MODE_BUILDING });\n\t\t\t\t}\n\t\t\t\telse if(zoom >= window.CONFIG.data_min_zoom && (!this._lastZoom || this._lastZoom < window.CONFIG.data_min_zoom)) {\n\t\t\t\t\tthis.elem.container.classList.remove(\"app-map-novector\");\n\t\t\t\t}\n\n\t\t\t\tthis._lastZoom = zoom;\n\t\t\t}\n\t\t});\n\n\t\t// Follow mouse position\n\t\tthis.elem.leafletElement.on(\"mousemove\", this._followMouse, this);\n\n\t\t/**\n\t\t * Event for map zoom changes\n\t\t * @event map.zoom.changed\n\t\t * @memberof MyMap\n\t\t * @property {int} zoom The new zoom level\n\t\t */\n\t\tconst alertZoom = () => {\n\t\t\tif(this.elem && this.elem.leafletElement) {\n\t\t\t\tPubSub.publish(\"map.zoom.changed\", { zoom: this.elem.leafletElement.getZoom() });\n\t\t\t}\n\t\t};\n\t\tthis.elem.leafletElement.on(\"zoomend\", alertZoom);\n\t\talertZoom();\n\n\t\t/**\n\t\t * Event for changing current map position\n\t\t * @event map.position.set\n\t\t * @memberof MyMap\n\t\t * @property {LatLng} coordinates The new position\n\t\t * @property {int} [zoom] The zoom level\n\t\t */\n\t\tPubSub.subscribe(\"map.position.set\", (msg, data) => {\n\t\t\tif(data.bbox) {\n\t\t\t\tconst [minlat, maxlat, minlon, maxlon] = data.bbox;\n\t\t\t\tthis.elem.leafletElement.fitBounds([[minlat, minlon], [maxlat, maxlon]]);\n\t\t\t}\n\t\t\telse if(data.zoom) {\n\t\t\t\tthis.elem.leafletElement.setView(data.coordinates, data.zoom);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.elem.leafletElement.panTo(data.coordinates);\n\t\t\t}\n\t\t});\n\t}\n\n\tcomponentDidUpdate(fromProps) {\n\t\tif(this.props.level !== fromProps.level) {\n\t\t\tthis._mapHash.setLevel(this.props.level);\n\t\t}\n\n\t\tconst floorImgs = window.imageryManager.getFloorImages();\n\n\t\t// Force update of floor imagery after mode change\n\t\tif(fromProps.mode !== this.props.mode) {\n\t\t\tthis.invalidateSize();\n\n\t\t\tfloorImgs.forEach(img => {\n\t\t\t\t// Check if we have a leaflet layer\n\t\t\t\tif(this.refs[\"floormap_\"+img.id]) {\n\t\t\t\t\tthis.refs[\"floormap_\"+img.id].forceUpdate();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Follow mouse position\n\t\tthis.elem.leafletElement.off(\"mousemove\", this._followMouse, this);\n\t\tthis.elem.leafletElement.on(\"mousemove\", this._followMouse, this);\n\n\t\t// Load wider area if necessary\n\t\tif(!this.props.draw && !this.state.loading && this.elem.leafletElement.getZoom() > 19) {\n\t\t\tthis._loadData(this.getBounds().pad(0.5*(this.elem.leafletElement.getZoom()-19)));\n\t\t}\n\t}\n\n\tcomponentWillUnmount() {\n\t\tPubSub.unsubscribe(\"map\");\n\t\tthis.elem.leafletElement.off(\"mousemove\", this._followMouse, this);\n\t\tthis.elem.leafletElement.off(\"load\");\n\t\tthis.elem.leafletElement.off(\"zoomend\");\n\t\tthis.elem.leafletElement.off(\"moveend\");\n\t\tthis.elem.leafletElement.off(\"dblclick\");\n\t}\n}\n\nexport default MyMap;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Body from '../Body';\nimport Button from 'react-bootstrap/Button';\nimport I18n from '../../config/locales/ui';\nimport Modal from 'react-bootstrap/Modal';\n\n/**\n * OutOfBoundsGeometry dialog alerts the user that the geometry he edited is outside the limits of building/level.\n */\nclass OutOfBoundsGeometryDialog extends Component {\n\trender() {\n\t\treturn <Modal show={this.props.show} onHide={this.props.onClose} size=\"lg\">\n\t\t\t<Modal.Header closeButton>\n\t\t\t\t<Modal.Title>{I18n.t(\"Geometry outside of the bounds\")}</Modal.Title>\n\t\t\t</Modal.Header>\n\t\t\t<Modal.Body>\n\t\t\t\t{this.props.mode === Body.MODE_LEVELS && I18n.t(\"The level contour you just edited is partially or completely outside of the building contour. Please make sure that the level contour is mostly contained in the building.\")}\n\t\t\t\t{this.props.mode === Body.MODE_FEATURES && I18n.t(\"The feature contour you just edited is partially or completely outside of the level contour. Please make sure that the feature contour is mostly contained in the floor.\")}\n\t\t\t</Modal.Body>\n\t\t\t<Modal.Footer>\n\t\t\t\t<Button variant=\"secondary\" onClick={this.props.onClose}>\n\t\t\t\t\t{I18n.t(\"OK\")}\n\t\t\t\t</Button>\n\t\t\t</Modal.Footer>\n\t\t</Modal>;\n\t}\n}\n\nexport default OutOfBoundsGeometryDialog;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Alert from 'mdi-react/AlertIcon';\nimport Button from 'react-bootstrap/Button';\nimport I18n from '../../config/locales/ui';\nimport Modal from 'react-bootstrap/Modal';\nimport OfficeBuilding from 'mdi-react/OfficeBuildingIcon';\nimport Pencil from 'mdi-react/PencilIcon';\n\n/**\n * Missing level outlines dialog asks user which action to perform if any level outline is missing.\n */\nclass MissingLevelOutlinesDialog extends Component {\n\trender() {\n\t\treturn <Modal\n\t\t\tshow={this.props.missingOutlines !== null && this.props.missingOutlines !== undefined && Object.keys(this.props.missingOutlines).length > 0}\n\t\t\tsize=\"lg\"\n\t\t\tstyle={{zIndex: 20050}}\n\t\t\tonHide={this.props.onIgnore}\n\t\t>\n\t\t\t<Modal.Header closeButton>\n\t\t\t\t<Modal.Title>{I18n.t(\"Floor outlines are missing\")}</Modal.Title>\n\t\t\t</Modal.Header>\n\n\t\t\t<Modal.Body>\n\t\t\t\t<p>{I18n.t(\"These buildings lack some floor outlines :\")}</p>\n\n\t\t\t\t<ul>\n\t\t\t\t\t{this.props.missingOutlines && Object.values(this.props.missingOutlines).map((d,i) => (\n\t\t\t\t\t\t<li key={i}>{I18n.t(\"Building %{b} (levels : %{lvl})\", { b: d.name, lvl: d.levels.join(\", \") })}</li>\n\t\t\t\t\t))}\n\t\t\t\t</ul>\n\n\t\t\t\t<p>{I18n.t(\"These floor outlines are optional in OSM, but are useful for various tools people use.\")}<br />{I18n.t(\"You have the choice between following options :\")}</p>\n\n\t\t\t\t<ul className=\"pl-3 pb-0 mb-0\" style={{listStyle: \"none\"}}>\n\t\t\t\t\t<li><Pencil /> {I18n.t(\"Go back to editing and create levels outline by yourself (recommended for complex buildings)\")}</li>\n\t\t\t\t\t<li><OfficeBuilding /> {I18n.t(\"Use building outline as default level outline (recommended for simple buildings)\")}</li>\n\t\t\t\t\t<li><Alert /> {I18n.t(\"Ignore this warning and do not create missing level outlines (not recommended)\")}</li>\n\t\t\t\t</ul>\n\t\t\t</Modal.Body>\n\n\t\t\t<Modal.Footer>\n\t\t\t\t<Button variant=\"primary\" onClick={this.props.onEdit}>\n\t\t\t\t\t<Pencil /> {I18n.t(\"Edit outlines\")}\n\t\t\t\t</Button>\n\t\t\t\t<Button variant=\"secondary\" onClick={this.props.onUseDefault}>\n\t\t\t\t\t<OfficeBuilding /> {I18n.t(\"Use building ones\")}\n\t\t\t\t</Button>\n\t\t\t\t<Button variant=\"danger\" onClick={this.props.onIgnore}>\n\t\t\t\t\t<Alert /> {I18n.t(\"Ignore this\")}\n\t\t\t\t</Button>\n\t\t\t</Modal.Footer>\n\t\t</Modal>;\n\t}\n}\n\nexport default MissingLevelOutlinesDialog;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Col from 'react-bootstrap/Col';\nimport Container from 'react-bootstrap/Container';\nimport deepEqual from 'fast-deep-equal';\nimport Form from 'react-bootstrap/Form';\nimport I18n from '../../config/locales/ui';\nimport PubSub from 'pubsub-js';\nimport Row from 'react-bootstrap/Row';\nimport SelectList from '../common/SelectList';\nimport Tab from 'react-bootstrap/Tab';\nimport Tabs from 'react-bootstrap/Tabs';\n\n/**\n * Imagery component handles changing background and overlay imagery of map.\n */\nclass ImageryPane extends Component {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.state = {\n\t\t\tbackgrounds: [],\n\t\t\toverlays: [],\n\t\t\tcustomUrl: \"\"\n\t\t};\n\t}\n\n\t/**\n\t * Update list of imagery\n\t * @private\n\t */\n\t_updateImagery(fromProps) {\n\t\tif(this.props.imagery) {\n\t\t\tconst newState = { backgrounds: [], overlays: [] };\n\n\t\t\tthis.props.imagery.forEach(l => {\n\t\t\t\tif(l.properties.overlay) {\n\t\t\t\t\tnewState.overlays.push(Object.assign({}, l, {\n\t\t\t\t\t\tlabel: l.properties.name || l.properties.id,\n\t\t\t\t\t\tselected: this.props.selectedOverlaysImagery && this.props.selectedOverlaysImagery.filter(l2 => l2.properties.id === l.properties.id).length > 0\n\t\t\t\t\t}));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tnewState.backgrounds.push(Object.assign({}, l, {\n\t\t\t\t\t\tlabel: l.properties.name || l.properties.id || this._customImagery.label,\n\t\t\t\t\t\tselected: this.props.selectedBaseImagery && this.props.selectedBaseImagery.properties.id === l.properties.id\n\t\t\t\t\t}));\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif(\n\t\t\t\t!deepEqual(newState.backgrounds, this.state.backgrounds)\n\t\t\t\t|| !deepEqual(newState.overlays, this.state.overlays)\n\t\t\t) {\n\t\t\t\tthis.setState(newState);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Event handler for imagery being clicked\n\t * @private\n\t */\n\t_onSelect(img, type) {\n\t\tPubSub.publish(\"body.imagery.set\", { imagery: img, type: type });\n\t}\n\n\t/**\n\t * Event handler for opacity change\n\t * @private\n\t */\n\t_onOpacityChanged(val, type) {\n\t\tPubSub.publish(\"body.imagery.opacity\", { opacity: parseInt(val)/100, type: type });\n\t}\n\n\t/**\n\t * Event handler for custom TMS URL change\n\t * @private\n\t */\n\t_onCustomChanged(url) {\n\t\tthis.setState({ customUrl: url });\n\n\t\turl = url.trim();\n\t\tconst newImg = Object.assign({}, this.props.selectedBaseImagery);\n\t\tnewImg.properties.url = url.length === 0 ? null : url;\n\n\t\tthis._onSelect([ newImg ], \"background\");\n\t}\n\n\trender() {\n\t\treturn <div className=\"m-2\">\n\t\t\t<h4>{I18n.t(\"Imagery\")}</h4>\n\n\t\t\t<Tabs defaultActiveKey=\"background\" className=\"dense-tabs\" id=\"imagery-tab\">\n\t\t\t\t<Tab eventKey=\"background\" title={I18n.t(\"Background\")}>\n\t\t\t\t\t<Container className=\"mt-3 mb-3 p-0 d-flex overflow-hidden\">\n\t\t\t\t\t\t<Row className=\"flex-nowrap\">\n\t\t\t\t\t\t\t<Col className=\"m-0\">{I18n.t(\"Opacity\")} <span className=\"font-weight-light\">{(this.props.baseImageryOpacity*100).toFixed(0)+\"%\"}</span></Col>\n\t\t\t\t\t\t\t<Col className=\"m-0\">\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"range\"\n\t\t\t\t\t\t\t\t\tmin=\"0\"\n\t\t\t\t\t\t\t\t\tmax=\"100\"\n\t\t\t\t\t\t\t\t\tonChange={v => this._onOpacityChanged(v.target.value, \"background\")}\n\t\t\t\t\t\t\t\t\tvalue={this.props.baseImageryOpacity*100}\n\t\t\t\t\t\t\t\t\tclassName=\"p-0 m-0 w-100\"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</Col>\n\t\t\t\t\t\t</Row>\n\t\t\t\t\t</Container>\n\n\t\t\t\t\t{this.state.backgrounds ?\n\t\t\t\t\t\t<SelectList\n\t\t\t\t\t\t\tdata={this.state.backgrounds}\n\t\t\t\t\t\t\ttype=\"single\"\n\t\t\t\t\t\t\tonChange={selection => this._onSelect(selection, \"background\")}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t:\n\t\t\t\t\t\t<p>{I18n.t(\"Loading...\")}</p>\n\t\t\t\t\t}\n\n\t\t\t\t\t{this.props.selectedBaseImagery && this.props.selectedBaseImagery.properties.id === \"custom\" &&\n\t\t\t\t\t\t<Form.Group controlId=\"imagery-custom\" className=\"mt-2\">\n\t\t\t\t\t\t\t<Form.Label>{I18n.t(\"Custom imagery URL\")}</Form.Label>\n\t\t\t\t\t\t\t<Form.Control\n\t\t\t\t\t\t\t\ttype=\"text\"\n\t\t\t\t\t\t\t\tplaceholder=\"https://mytil.es/{z}/{x}/{y}.jpg\"\n\t\t\t\t\t\t\t\tvalue={this.state.customUrl}\n\t\t\t\t\t\t\t\tonChange={v => this._onCustomChanged(v.target.value)}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<Form.Text className=\"text-muted\">\n\t\t\t\t\t\t\t\t{I18n.t(\"You can use any TMS-like URL\")}\n\t\t\t\t\t\t\t</Form.Text>\n\t\t\t\t\t\t</Form.Group>\n\t\t\t\t\t}\n\t\t\t\t</Tab>\n\n\t\t\t\t<Tab eventKey=\"overlay\" title={I18n.t(\"Overlay\")}>\n\t\t\t\t\t<Container className=\"mt-3 mb-3 p-0 d-flex overflow-hidden\">\n\t\t\t\t\t\t<Row className=\"flex-nowrap\">\n\t\t\t\t\t\t\t<Col className=\"m-0\">{I18n.t(\"Opacity\")} <span className=\"font-weight-light\">{(this.props.overlaysImageryOpacity*100).toFixed(0)+\"%\"}</span></Col>\n\t\t\t\t\t\t\t<Col className=\"m-0\">\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"range\"\n\t\t\t\t\t\t\t\t\tmin=\"0\"\n\t\t\t\t\t\t\t\t\tmax=\"100\"\n\t\t\t\t\t\t\t\t\tonChange={v => this._onOpacityChanged(v.target.value, \"overlay\")}\n\t\t\t\t\t\t\t\t\tvalue={this.props.overlaysImageryOpacity*100}\n\t\t\t\t\t\t\t\t\tstyle={{width: \"100%\"}}\n\t\t\t\t\t\t\t\t\tclassName=\"p-0 m-0 w-100\"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</Col>\n\t\t\t\t\t\t</Row>\n\t\t\t\t\t</Container>\n\n\t\t\t\t\t{this.state.overlays ?\n\t\t\t\t\t\t<SelectList\n\t\t\t\t\t\t\tdata={this.state.overlays}\n\t\t\t\t\t\t\ttype=\"multi\"\n\t\t\t\t\t\t\tonChange={selection => this._onSelect(selection, \"overlay\")}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t:\n\t\t\t\t\t\t<p>{I18n.t(\"Loading...\")}</p>\n\t\t\t\t\t}\n\t\t\t\t</Tab>\n\t\t\t</Tabs>\n\t\t</div>;\n\t}\n\n\tcomponentDidMount() {\n\t\tthis._updateImagery();\n\t}\n\n\tcomponentDidUpdate(fromProps) {\n\t\tthis._updateImagery(fromProps);\n\t}\n}\n\nexport default ImageryPane;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Imagery from './panes/Imagery';\n\nclass RightPanel extends Component {\n\trender() {\n\t\treturn <div>\n\t\t\t<Imagery {...this.props} />\n\t\t</div>;\n\t}\n}\n\nexport default RightPanel;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport ArrowExpand from 'mdi-react/ArrowExpandIcon';\nimport AxisArrow from 'mdi-react/AxisArrowIcon';\nimport Button from 'react-bootstrap/Button';\nimport ButtonGroup from 'react-bootstrap/ButtonGroup';\nimport Close from 'mdi-react/CloseIcon';\nimport ContentCopy from 'mdi-react/ContentCopyIcon';\nimport ContentPaste from 'mdi-react/ContentPasteIcon';\nimport I18n from '../../config/locales/ui';\nimport PubSub from 'pubsub-js';\nimport RotateRight from 'mdi-react/RotateRightIcon';\n\n/**\n * FloorImageryButtons component handles tool buttons to show in toolbar when editing floor plans.\n */\nclass FloorImageryButtons extends Component {\n\trender() {\n\t\tconst floorImgs = window.imageryManager.getFloorImages();\n\t\tconst f = floorImgs.find(f => f.selected);\n\n\t\treturn f ? <div>\n\t\t\t<ButtonGroup>\n\t\t\t\t<Button\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\tvariant={this.props.floorImageryMode === \"distort\" ? \"primary\" : \"outline-secondary\"}\n\t\t\t\t\tonClick={() => PubSub.publish(\"body.floorimagery.mode\", { mode: this.props.floorImageryMode === \"distort\" ? null : \"distort\" })}\n\t\t\t\t\tdisabled={!f.visible}\n\t\t\t\t\ttitle={I18n.t(\"Distort this plan\")}\n\t\t\t\t>\n\t\t\t\t\t<AxisArrow />\n\t\t\t\t</Button>\n\n\t\t\t\t<Button\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\tvariant={this.props.floorImageryMode === \"scale\" ? \"primary\" : \"outline-secondary\"}\n\t\t\t\t\tonClick={() => PubSub.publish(\"body.floorimagery.mode\", { mode: this.props.floorImageryMode === \"scale\" ? null : \"scale\" })}\n\t\t\t\t\tdisabled={!f.visible}\n\t\t\t\t\ttitle={I18n.t(\"Scale this plan\")}\n\t\t\t\t>\n\t\t\t\t\t<ArrowExpand />\n\t\t\t\t</Button>\n\n\t\t\t\t<Button\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\tvariant={this.props.floorImageryMode === \"rotate\" ? \"primary\" : \"outline-secondary\"}\n\t\t\t\t\tonClick={() => PubSub.publish(\"body.floorimagery.mode\", { mode: this.props.floorImageryMode === \"rotate\" ? null : \"rotate\" })}\n\t\t\t\t\tdisabled={!f.visible}\n\t\t\t\t\ttitle={I18n.t(\"Rotate this plan\")}\n\t\t\t\t>\n\t\t\t\t\t<RotateRight />\n\t\t\t\t</Button>\n\t\t\t</ButtonGroup>\n\n\t\t\t<ButtonGroup>\n\t\t\t\t<Button\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\tclassName=\"ml-1\"\n\t\t\t\t\tonClick={() => PubSub.publish(\"body.floorimagery.copyposition\")}\n\t\t\t\t\tdisabled={!f.visible}\n\t\t\t\t\ttitle={I18n.t(\"Copy position of this plan\")}\n\t\t\t\t>\n\t\t\t\t\t<ContentCopy />\n\t\t\t\t</Button>\n\n\t\t\t\t<Button\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\tonClick={() => PubSub.publish(\"body.floorimagery.pasteposition\")}\n\t\t\t\t\tdisabled={!f.visible || !this.props.floorImageryCopyPaste}\n\t\t\t\t\ttitle={I18n.t(\"Move this plan to copied position\")}\n\t\t\t\t>\n\t\t\t\t\t<ContentPaste />\n\t\t\t\t</Button>\n\t\t\t</ButtonGroup>\n\n\t\t\t<Button\n\t\t\t\tvariant=\"outline-danger\"\n\t\t\t\tonClick={() => PubSub.publish(\"body.floorimagery.remove\", { id: f.id })}\n\t\t\t\tclassName=\"ml-1\"\n\t\t\t\tsize=\"sm\"\n\t\t\t\ttitle={I18n.t(\"Delete this plan\")}\n\t\t\t>\n\t\t\t\t<Close /> <span className=\"hide-mdDown\">{I18n.t(\"Delete this plan\")}</span>\n\t\t\t</Button>\n\t\t</div> : <div></div>;\n\t}\n}\n\nexport default FloorImageryButtons;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Button from 'react-bootstrap/Button';\nimport ButtonGroup from 'react-bootstrap/ButtonGroup';\nimport Check from 'mdi-react/CheckIcon';\nimport Close from 'mdi-react/CloseIcon';\nimport I18n from '../../config/locales/ui';\nimport PubSub from 'pubsub-js';\n\n/**\n * Geometry buttons component shows confirm/cancel buttons for editing geometries.\n */\nclass GeometryButtons extends Component {\n\trender() {\n\t\treturn <div>\n\t\t\t{I18n.t(\"Click on the map to start drawing the feature\")}\n\t\t\t<ButtonGroup style={{marginLeft: 10}}>\n\t\t\t\t<Button\n\t\t\t\t\tvariant=\"success\"\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\tonClick={() => PubSub.publish(\"body.draw.stop\")}\n\t\t\t\t>\n\t\t\t\t\t<Check size={24} /> {I18n.t(\"Done\")}\n\t\t\t\t</Button>\n\t\t\t\t<Button\n\t\t\t\t\tvariant=\"outline-danger\"\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\tonClick={() => PubSub.publish(\"body.draw.cancel\")}\n\t\t\t\t>\n\t\t\t\t\t<Close size={24} /> {I18n.t(\"Cancel\")}\n\t\t\t\t</Button>\n\t\t\t</ButtonGroup>\n\t\t</div>;\n\t}\n}\n\nexport default GeometryButtons;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport ArrowExpandDown from 'mdi-react/ArrowExpandDownIcon';\nimport ArrowExpandUp from 'mdi-react/ArrowExpandUpIcon';\nimport Body from '../Body';\nimport Button from 'react-bootstrap/Button';\nimport ButtonGroup from 'react-bootstrap/ButtonGroup';\nimport Delete from 'mdi-react/DeleteIcon';\nimport GeometryButtons from './GeometryButtons';\nimport I18n from '../../config/locales/ui';\nimport Layers from 'mdi-react/LayersIcon';\nimport OfficeBuilding from 'mdi-react/OfficeBuildingIcon';\nimport PubSub from 'pubsub-js';\nimport SquareEditOutline from 'mdi-react/SquareEditOutlineIcon';\nimport VectorSquare from 'mdi-react/VectorSquareIcon';\n\n/**\n * Indoor edit buttons are buttons shown in the toolbar when editing indoor data.\n */\nclass IndoorEditButtons extends Component {\n\trender() {\n\t\t// Drawing geometry\n\t\tif(this.props.draw) {\n\t\t\treturn <GeometryButtons />;\n\t\t}\n\t\telse {\n\t\t\t// Not zoomed enough\n\t\t\tif(this.props.zoom && this.props.zoom < window.CONFIG.data_min_zoom) {\n\t\t\t\treturn <p>{I18n.t(\"Please zoom-in to edit data\")}</p>;\n\t\t\t}\n\t\t\t// Zoomed enough\n\t\t\telse {\n\t\t\t\tif(this.props.mode === Body.MODE_BUILDING) {\n\t\t\t\t\treturn <div>\n\t\t\t\t\t\t{this.props.building && [\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\t\t\ttitle={I18n.t(\"Edit objects contained in this floor\")}\n\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.mode.set\", { mode: Body.MODE_FEATURES })}\n\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\tclassName=\"mr-1\"\n\t\t\t\t\t\t\t\tkey={0}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<Layers /> {I18n.t(\"Edit features\")}\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t\t,\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"outline-danger\"\n\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.delete.feature\")}\n\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\tclassName=\"mr-1\"\n\t\t\t\t\t\t\t\tkey={1}\n\t\t\t\t\t\t\t\ttitle={I18n.t(\"Delete this building\")}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<Delete />\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t]}\n\n\t\t\t\t\t\t{this.props.building &&\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.square.feature\")}\n\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\tclassName=\"mr-1\"\n\t\t\t\t\t\t\t\ttitle={I18n.t(\"Square this building\")}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<VectorSquare />\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant={this.props.building ? \"outline-secondary\" : \"primary\"}\n\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\ttitle={I18n.t(\"Click to start creating a new building from scratch\")}\n\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.draw.building\")}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<OfficeBuilding /> <span className={this.props.building ? \"hide-mdDown\" : \"\"}>{I18n.t(\"New building\")}</span>\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</div>;\n\t\t\t\t}\n\t\t\t\telse if(this.props.mode === Body.MODE_LEVELS) {\n\t\t\t\t\tconst floorParts = window.vectorDataManager.getLevelFootprint(this.props.building, this.props.level || 0);\n\n\t\t\t\t\treturn <div>\n\t\t\t\t\t\t{this.props.floor && [\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.square.feature\")}\n\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\tclassName=\"mr-1\"\n\t\t\t\t\t\t\t\tkey={0}\n\t\t\t\t\t\t\t\ttitle={I18n.t(\"Square this floor part\")}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<VectorSquare />\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t\t,\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"outline-danger\"\n\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.delete.feature\")}\n\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\tclassName=\"mr-1\"\n\t\t\t\t\t\t\t\tkey={1}\n\t\t\t\t\t\t\t\ttitle={I18n.t(\"Delete this floor part\")}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<Delete />\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t]}\n\n\t\t\t\t\t\t{floorParts.length > 0 &&\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.draw.floor\")}\n\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\tclassName=\"mr-1\"\n\t\t\t\t\t\t\t\ttitle={I18n.t(\"Create a new floor part in this level. Useful for giving different names to parts of a single level.\")}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<SquareEditOutline /> <span className=\"hide-mdDown\">{I18n.t(\"Add another floor part\")}</span>\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t<ButtonGroup>\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"outline-primary\"\n\t\t\t\t\t\t\t\ttitle={I18n.t(\"Create a new level on top of existing ones\")}\n\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.level.add\", { where: \"upper\" })}\n\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<ArrowExpandUp /> <span className=\"hide-mdDown\">{I18n.t(\"New upper level\")}</span>\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"outline-primary\"\n\t\t\t\t\t\t\t\ttitle={I18n.t(\"Create a new level under existing ones\")}\n\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.level.add\", { where: \"below\" })}\n\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<ArrowExpandDown /> <span className=\"hide-mdDown\">{I18n.t(\"New below level\")}</span>\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t</ButtonGroup>\n\t\t\t\t\t</div>;\n\t\t\t\t}\n\t\t\t\telse if(this.props.mode === Body.MODE_FEATURES) {\n\t\t\t\t\treturn <div>\n\t\t\t\t\t\t{this.props.feature && this.props.feature.id.startsWith(\"way/\") &&\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.square.feature\")}\n\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\tclassName=\"mr-1\"\n\t\t\t\t\t\t\t\ttitle={I18n.t(\"Square this feature\")}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<VectorSquare />\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t{this.props.feature &&\n\t\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\t\tvariant=\"outline-danger\"\n\t\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.delete.feature\")}\n\t\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\t\ttitle={I18n.t(\"Delete this feature\")}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<Delete />\n\t\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t}\n\t\t\t\t\t</div>;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn <span></span>;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport default IndoorEditButtons;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport Body from './Body';\nimport Button from 'react-bootstrap/Button';\nimport ButtonGroup from 'react-bootstrap/ButtonGroup';\nimport ContentSave from 'mdi-react/ContentSaveIcon';\nimport MapCheck from 'mdi-react/MapCheckIcon';\nimport FloorImageryButtons from './common/FloorImageryButtons';\nimport I18n from '../config/locales/ui';\nimport IndoorEditButtons from './common/IndoorEditButtons';\nimport PubSub from 'pubsub-js';\nimport Undo from 'mdi-react/UndoIcon';\nimport Redo from 'mdi-react/RedoIcon';\n\n/**\n * Toolbar is a panel where user can access tools related to current mode of the editor.\n */\nclass Toolbar extends Component {\n\t_onSave() {\n\t\tif(this.props.mode === Body.MODE_FLOOR_IMAGERY) {\n\t\t\tPubSub.publish(\"body.floorimagery.save\");\n\t\t}\n\t\telse {\n\t\t\tPubSub.publish(\"body.mode.set\", { mode: Body.MODE_CHANGESET })\n\t\t}\n\t}\n\n\trender() {\n\t\tlet canUndo, canRedo, canSave, nbEdits;\n\n\t\tif(this.props.mode === Body.MODE_FLOOR_IMAGERY) {\n\t\t\tcanUndo = window.imageryManager.canUndo();\n\t\t\tcanRedo = window.imageryManager.canRedo();\n\t\t\tcanSave = window.imageryManager.getFloorImages().length > 0;\n\t\t\tnbEdits = window.imageryManager.getAmountEdits();\n\t\t}\n\t\telse {\n\t\t\tcanUndo = window.vectorDataManager.canUndo();\n\t\t\tcanRedo = window.vectorDataManager.canRedo();\n\t\t\tcanSave = canUndo;\n\t\t\tnbEdits = window.vectorDataManager.getAmountEdits();\n\t\t}\n\n\t\treturn <div className=\"app-toolbar p-2\">\n\t\t\t<div className=\"d-flex justify-content-between\">\n\t\t\t\t<div>\n\t\t\t\t\t{this.props.mode === Body.MODE_FLOOR_IMAGERY ?\n\t\t\t\t\t\t<FloorImageryButtons {...this.props} />\n\t\t\t\t\t\t:\n\t\t\t\t\t\t<IndoorEditButtons {...this.props} />\n\t\t\t\t\t}\n\t\t\t\t</div>\n\n\t\t\t\t<div>\n\t\t\t\t\t<ButtonGroup className=\"mr-2\" aria-label=\"Undo and redo\">\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\tdisabled={!canUndo}\n\t\t\t\t\t\t\ttitle={I18n.t(\"Cancel last operation\")}\n\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.action.undo\")}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Undo />\n\t\t\t\t\t\t</Button>\n\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tvariant=\"outline-secondary\"\n\t\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\t\tdisabled={!canRedo}\n\t\t\t\t\t\t\ttitle={I18n.t(\"Apply again last cancelled operation\")}\n\t\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.action.redo\")}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Redo />\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</ButtonGroup>\n\n\t\t\t\t\t<Button\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\tclassName=\"mr-2\"\n\t\t\t\t\t\tactive={this.props.mode === Body.MODE_PREVIEW}\n\t\t\t\t\t\tdisabled={this.props.mode === Body.MODE_PREVIEW}\n\t\t\t\t\t\tonClick={() => PubSub.publish(\"body.preview.open\")}\n\t\t\t\t\t\ttitle={I18n.t(\"Preview your changes on indoor=\")}\n\t\t\t\t\t>\n\t\t\t\t\t\t<MapCheck />\n\t\t\t\t\t\t<span className=\"hide-mdDown\">{I18n.t(\"Preview\")}</span>\n\t\t\t\t\t</Button>\n\n\t\t\t\t\t<Button\n\t\t\t\t\t\tvariant={nbEdits < 30 ? \"success\" : (nbEdits < 100 ? \"warning\" : \"danger\")}\n\t\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\t\tdisabled={!canSave}\n\t\t\t\t\t\ttitle={this.props.mode === Body.MODE_FLOOR_IMAGERY ? I18n.t(\"Save positionning of floor plans\") : I18n.t(\"Send your changes to OpenStreetMap\")}\n\t\t\t\t\t\tonClick={() => this._onSave()}\n\t\t\t\t\t>\n\t\t\t\t\t\t<ContentSave />\n\t\t\t\t\t\t<span className=\"hide-mdDown\">{I18n.t(\"Save\")}</span>\n\t\t\t\t\t\t{nbEdits > 0 && \" (\"+nbEdits+\")\"}\n\t\t\t\t\t</Button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>;\n\t}\n}\n\nexport default Toolbar;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React, { Component } from 'react';\nimport { saveAs } from 'file-saver';\nimport 'bootstrap/dist/css/bootstrap.css';\nimport bbox from '@turf/bbox';\nimport Col from 'react-bootstrap/Col';\nimport CompleteFloorImagery from './dialogs/CompleteFloorImagery';\nimport ConfirmDeletion from './dialogs/ConfirmDeletion';\nimport Container from 'react-bootstrap/Container';\nimport deepEqual from 'fast-deep-equal';\nimport Editable from './layers/Editable';\nimport Header from './Header';\nimport I18n from '../config/locales/ui';\nimport LeftPanel from './LeftPanel';\nimport Login from './dialogs/Login';\nimport Map from './Map';\nimport Mousetrap from 'mousetrap';\nimport OutOfBoundsGeometry from './dialogs/OutOfBoundsGeometry';\nimport MissingLevelOutlines from './dialogs/MissingLevelOutlines';\nimport PubSub from 'pubsub-js';\nimport RightPanel from './RightPanel';\nimport Row from 'react-bootstrap/Row';\nimport Toolbar from './Toolbar';\n\nconst LOCATOR_OVERLAY_ID = \"mapbox_locator_overlay\";\n\n/**\n * Body is the view main class.\n * It creates all other component in cascade.\n */\nclass Body extends Component {\n\t/** Mode for showing only building footprint **/\n\tstatic MODE_BUILDING = 0;\n\n\t/** Mode for showing only levels footprint **/\n\tstatic MODE_LEVELS = 1;\n\n\t/** Mode for showing one precise level (its features) **/\n\tstatic MODE_FEATURES = 2;\n\n\t/** Mode for saving changes **/\n\tstatic MODE_CHANGESET = 4;\n\n\t/** Mode for editing floor imagery **/\n\tstatic MODE_FLOOR_IMAGERY = 5;\n\n\t/** Mode for exploring indoor data **/\n\tstatic MODE_EXPLORE = 6;\n\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.state = {\n\t\t\tleftPanelOpen: false,\n\t\t\trightPanelOpen: false,\n\t\t\tmode: Body.MODE_EXPLORE,\n\t\t\tlevel: 0,\n\t\t\tbuilding: null,\n\t\t\tfloor: null,\n\t\t\tfeature: null,\n\t\t\tcopyingFeature: null,\n\t\t\tpreset: null,\n\t\t\tdraw: null,\n\t\t\tpane: null,\n\t\t\timagery: null,\n\t\t\tselectedOverlaysImagery: null,\n\t\t\tselectedBaseImagery: null,\n\t\t\toverlaysImageryOpacity: 1,\n\t\t\tbaseImageryOpacity: 1,\n\t\t\tfloorImageryMode: null,\n\t\t\tfloorImageryCopyPaste: null,\n\t\t\tchangeset: { tags: {} },\n\t\t\tdatalocked: false,\n\t\t\tlastUsedPresets: [],\n\t\t\tzoom: window.CONFIG.map_initial_zoom\n\t\t};\n\n\t\tthis._usedImageryNames = new Set();\n\t}\n\n\t/**\n\t * Returns a proper name for showing this feature\n\t * @param {Object} feature The feature\n\t * @param {string} [fallback] Some predefined fallback for features (for example a preset name)\n\t * @return {string} The feature name, category or ID depending what information is available\n\t */\n\tstatic GetFeatureName(feature, fallback) {\n\t\tconst t = feature.properties.tags;\n\n\t\tif(t.name || t.ref || t.brand) {\n\t\t\treturn t.name || t.ref || t.brand;\n\t\t}\n\t\telse if(t.building) {\n\t\t\treturn feature.properties.own.new ? I18n.t(\"New building\") : I18n.t(\"Building\");\n\t\t}\n\t\telse if(t.indoor === \"level\" && feature.properties.own && feature.properties.own.levels) {\n\t\t\treturn I18n.t(\"New floor part (level %{lvl})\", { lvl: feature.properties.own.levels.join(\", \") });\n\t\t}\n\t\telse if(fallback) {\n\t\t\treturn fallback;\n\t\t}\n\t\telse {\n\t\t\t return feature.properties.own.new ? I18n.t(\"New feature\") : feature.id;\n\t\t}\n\t}\n\n\trender() {\n\t\tconst modes = {\n\t\t\t[Body.MODE_EXPLORE]: \"mode-explore\",\n\t\t\t[Body.MODE_FLOOR_IMAGERY]: \"mode-floorplan\"\n\t\t};\n\t\tconst modeName = modes[this.state.mode] ? modes[this.state.mode] : \"mode-editindoor\";\n\n\t\treturn <Container fluid={true} className={\"h-100 m-0 p-0 \"+modeName}>\n\t\t\t<Header\n\t\t\t\tclassName=\"app-header\"\n\t\t\t\t{...this.state}\n\t\t\t/>\n\n\t\t\t<Row className=\"m-0 p-0 app-body\">\n\t\t\t\t{this.state.leftPanelOpen &&\n\t\t\t\t\t<Col\n\t\t\t\t\t\tclassName=\"m-0 p-0 h-100\"\n\t\t\t\t\t\tstyle={{overflowX: \"hidden\", overflowY: \"auto\", borderRight: \"3px solid #d0d0d0\"}}\n\t\t\t\t\t\txs=\"6\" sm=\"5\" md=\"4\" lg=\"4\" xl=\"3\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<LeftPanel {...this.state} />\n\t\t\t\t\t</Col>\n\t\t\t\t}\n\n\t\t\t\t<Col className=\"m-0 p-0\">\n\t\t\t\t\t{this.state.mode !== Body.MODE_EXPLORE &&\n\t\t\t\t\t\t<Toolbar {...this.state} />\n\t\t\t\t\t}\n\n\t\t\t\t\t<Map\n\t\t\t\t\t\tref={elem => this.map = elem}\n\t\t\t\t\t\t{...this.state}\n\t\t\t\t\t/>\n\t\t\t\t</Col>\n\n\t\t\t\t{this.state.rightPanelOpen &&\n\t\t\t\t\t<Col className=\"m-0 p-0 h-100 overflow-auto\" style={{borderLeft: \"3px solid #d0d0d0\"}} xs=\"6\" sm=\"5\" md=\"4\" lg=\"4\" xl=\"3\">\n\t\t\t\t\t\t<RightPanel {...this.state} />\n\t\t\t\t\t</Col>\n\t\t\t\t}\n\t\t\t</Row>\n\n\t\t\t<ConfirmDeletion\n\t\t\t\tshow={this.state.showDialogConfirmDeletion}\n\t\t\t\tname={this.state.mode === Body.MODE_BUILDING && this.state.building ?\n\t\t\t\t\tBody.GetFeatureName(this.state.building, I18n.t(\"Selected building\"))\n\t\t\t\t\t:\n\t\t\t\t\t(this.state.mode === Body.MODE_LEVELS && this.state.floor ?\n\t\t\t\t\t\tBody.GetFeatureName(this.state.floor, I18n.t(\"Selected floor\"))\n\t\t\t\t\t\t: \"\"\n\t\t\t\t\t)\n\t\t\t\t}\n\t\t\t\tonCancel={() => this.setState({ showDialogConfirmDeletion: false })}\n\t\t\t\tonConfirm={deleteAll => {\n\t\t\t\t\tthis.setState({ showDialogConfirmDeletion: false });\n\t\t\t\t\tPubSub.publish(\"body.delete.feature\", { confirmed: true, deleteAll: deleteAll });\n\t\t\t\t}}\n\t\t\t/>\n\n\t\t\t<CompleteFloorImagery\n\t\t\t\tshow={this.state.showDialogCompleteFloorImagery}\n\t\t\t\tonClose={() => this.setState({ showDialogCompleteFloorImagery: false })}\n\t\t\t/>\n\n\t\t\t<OutOfBoundsGeometry\n\t\t\t\tshow={this.state.showDialogOutOfBoundsGeometry}\n\t\t\t\tonClose={() => this.setState({ showDialogOutOfBoundsGeometry: false })}\n\t\t\t\tmode={this.state.mode}\n\t\t\t/>\n\n\t\t\t<MissingLevelOutlines\n\t\t\t\tmissingOutlines={this.state.showDialogMissingLevelOutlines}\n\t\t\t\tonIgnore={() => this.setState({ showDialogMissingLevelOutlines: null })}\n\t\t\t\tonUseDefault={() => this._onMissingOutlineUseDefault()}\n\t\t\t\tonEdit={() => this._onMissingOutlineGoEdit()}\n\t\t\t/>\n\n\t\t\t<Login\n\t\t\t\tshow={this.state.showDialogLogin}\n\t\t\t\tonLogin={() => PubSub.publish(\"app.user.login\")}\n\t\t\t\tonClose={() => {\n\t\t\t\t\tif(!window.CONFIG.always_authenticated) {\n\t\t\t\t\t\tPubSub.publishSync(\"body.mode.set\", { mode: Body.MODE_EXPLORE });\n\t\t\t\t\t\tthis.setState({ showDialogLogin: false });\n\t\t\t\t\t}\n\t\t\t\t}}\n\t\t\t/>\n\t\t</Container>;\n\t}\n\n\t/**\n\t * Event handler for click on \"use building outline\" button in missing level outline dialog\n\t * @private\n\t */\n\t_onMissingOutlineUseDefault() {\n\t\t// Create outlines\n\t\tif(Object.keys(this.state.showDialogMissingLevelOutlines).length > 0) {\n\t\t\tObject.entries(this.state.showDialogMissingLevelOutlines).forEach(e => {\n\t\t\t\tconst [ buildingId, buildingData ] = e;\n\t\t\t\tconst building = window.vectorDataManager.findFeature(buildingId);\n\n\t\t\t\tif(building && buildingData.levels.length > 0) {\n\t\t\t\t\tbuildingData.levels.forEach(lvl => {\n\t\t\t\t\t\tPubSub.publish(\"body.create.floor\", { feature: building, level: lvl });\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Hide dialog\n\t\tthis.setState({ showDialogMissingLevelOutlines: null });\n\t\tPubSub.publish(\"body.mode.set\", { mode: Body.MODE_CHANGESET });\n\t}\n\n\t/**\n\t * Event handler for click on \"go back edit\" in missing level outline dialog\n\t * @private\n\t */\n\t_onMissingOutlineGoEdit() {\n\t\ttry {\n\t\t\t// No buildings info\n\t\t\tif(Object.keys(this.state.showDialogMissingLevelOutlines).length === 0) { throw new Error(); }\n\n\t\t\tconst [ buildingId, buildingData ] = Object.entries(this.state.showDialogMissingLevelOutlines)[0];\n\t\t\tconst building = window.vectorDataManager.findFeature(buildingId);\n\n\t\t\t// Building not found\n\t\t\tif(!building || buildingData.levels.length === 0) { throw new Error(); }\n\n\t\t\tthis.setState({\n\t\t\t\tbuilding: building,\n\t\t\t\tlevel: buildingData.levels[0],\n\t\t\t\tshowDialogMissingLevelOutlines: null\n\t\t\t}, () => {\n\t\t\t\tPubSub.publish(\"body.mode.set\", { mode: Body.MODE_LEVELS });\n\t\t\t\tconst [minX, minY, maxX, maxY] = bbox(building);\n\t\t\t\tPubSub.publish(\"map.position.set\", { bbox: [minY, maxY, minX, maxX] });\n\t\t\t});\n\t\t}\n\t\tcatch(e) {\n\t\t\tthis.setState({ showDialogMissingLevelOutlines: null });\n\t\t\tPubSub.publish(\"body.mode.set\", { mode: Body.MODE_BUILDING });\n\t\t}\n\t}\n\n\t_updateImagery() {\n\t\t// Load imagery\n\t\twindow.imageryManager.getAvailableImagery(this.map.getCenter())\n\t\t.then(layers => {\n\t\t\t// Adding \"custom\" entry for allowing user-defined background imagery\n\t\t\tlayers.push({ properties: {\n\t\t\t\tid: \"custom\", type: \"tms\", url: null, name: I18n.t(\"Custom imagery\")\n\t\t\t}, geometry: null });\n\n\t\t\tconst newState = {};\n\n\t\t\t// Update layers list\n\t\t\tif(!deepEqual(layers, this.state.imagery)) {\n\t\t\t\tnewState.imagery = layers;\n\t\t\t}\n\n\t\t\t// Set default background imagery using the best available around\n\t\t\tconst baseImgs = layers.filter(l => !l.properties.overlay);\n\t\t\tif(\n\t\t\t\t(!this.state.selectedBaseImagery && baseImgs.length > 0)\n\t\t\t\t|| (this.state.selectedBaseImagery && !baseImgs.find(b => this.state.selectedBaseImagery.properties.id === b.properties.id))\n\t\t\t) {\n\t\t\t\tnewState.selectedBaseImagery = baseImgs[0];\n\t\t\t}\n\n\t\t\t// Use locator overlay if available\n\t\t\tconst locator = layers.find(l => l.properties.id === LOCATOR_OVERLAY_ID);\n\t\t\tif(\n\t\t\t\t!this.state.selectedOverlaysImagery && locator\n\t\t\t\t&& (!this.state.zoom || !locator.properties.max_zoom || this.state.zoom <= locator.properties.max_zoom)\n\t\t\t) {\n\t\t\t\tnewState.selectedOverlaysImagery = [ layers.find(l => l.properties.id === LOCATOR_OVERLAY_ID) ];\n\t\t\t}\n\n\t\t\tif(Object.keys(newState).length > 0) {\n\t\t\t\tthis.setState(newState);\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Append last used preset into stack\n\t * @private\n\t */\n\t_pushUsedPreset(preset) {\n\t\tif(preset === null || preset === undefined) { return null; }\n\n\t\tlet newUsedPresets = this.state.lastUsedPresets.slice(0);\n\n\t\tif(newUsedPresets.length === 0) {\n\t\t\tnewUsedPresets.push(preset);\n\t\t}\n\t\telse {\n\t\t\tconst pId = newUsedPresets.findIndex(p => deepEqual(p, preset));\n\t\t\tif(pId < 0) {\n\t\t\t\tif(newUsedPresets.length === 3) {\n\t\t\t\t\tnewUsedPresets.pop();\n\t\t\t\t}\n\n\t\t\t\tnewUsedPresets.unshift(preset);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tnewUsedPresets.splice(pId, 1);\n\t\t\t\tnewUsedPresets.unshift(preset);\n\t\t\t}\n\t\t}\n\n\t\tif(!deepEqual(newUsedPresets, this.state.lastUsedPresets)) {\n\t\t\tthis.setState({ lastUsedPresets: newUsedPresets });\n\t\t}\n\t}\n\n\t/**\n\t * Checks if user is logged in before performing an action, if not shows login dialog\n\t * @return {boolean} true if logged in\n\t * @private\n\t */\n\t_checkUserLoggedIn() {\n\t\tif(!window.editor_user || !window.editor_user_auth || !window.editor_user_auth.authenticated()) {\n\t\t\tif(\n\t\t\t\t!this.state.showDialogLogin\n\t\t\t\t&& (\n\t\t\t\t\twindow.CONFIG.always_authenticated\n\t\t\t\t\t|| [Body.MODE_FLOOR_IMAGERY, Body.MODE_BUILDING, Body.MODE_FEATURES, Body.MODE_LEVELS, Body.MODE_CHANGESET].includes(this.state.mode)\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\t// Delay display to not be annoying\n\t\t\t\tif(this._timerLogin) {\n\t\t\t\t\tclearTimeout(this._timerLogin);\n\t\t\t\t\tthis._timerLogin = null;\n\t\t\t\t}\n\n\t\t\t\tthis._timerLogin = setTimeout(() => this.setState({ showDialogLogin: true }), 1000);\n\t\t\t}\n\n\t\t\treturn false;\n\t\t}\n\t\telse {\n\t\t\tif(this.state.showDialogLogin) {\n\t\t\t\tthis.setState({ showDialogLogin: false });\n\t\t\t}\n\n\t\t\treturn true;\n\t\t}\n\t}\n\n\t/**\n\t * Capture imagery used when user perform an action\n\t * @private\n\t */\n\t_addUsedImagery() {\n\t\t// Base imagery\n\t\tif(this.state.selectedBaseImagery && this.state.selectedBaseImagery.properties) {\n\t\t\tthis._usedImageryNames.add(this.state.selectedBaseImagery.properties.name || this.state.selectedBaseImagery.properties.id);\n\t\t}\n\n\t\t// Overlays\n\t\tif(this.state.selectedOverlaysImagery && this.state.selectedOverlaysImagery.length > 0) {\n\t\t\tthis.state.selectedOverlaysImagery.forEach(ovl => {\n\t\t\t\tif(ovl.properties) {\n\t\t\t\t\tthis._usedImageryNames.add(ovl.properties.name || ovl.properties.id);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tcomponentDidMount() {\n\t\tthis._timerImagery = setInterval(() => this._updateImagery(), 1000);\n\t\tthis._checkUserLoggedIn();\n\n\t\t// Hide login dialog when user logs in if previously shown\n\t\tPubSub.subscribe(\"app.user.ready\", (msg, data) => {\n\t\t\tthis._checkUserLoggedIn();\n\t\t});\n\n\t\t// Show login dialog after logout if necessary\n\t\tPubSub.subscribe(\"app.user.left\", (msg, data) => {\n\t\t\tthis._checkUserLoggedIn();\n\t\t});\n\n\t\t/**\n\t\t * Event for changing view mode (what kind of features is shown)\n\t\t * @event body.mode.set\n\t\t * @memberof Body\n\t\t * @property {int} mode The map mode (use Body.MODE_* constants)\n\t\t * @property {Object} [options] The options for current mode\n\t\t */\n\t\tPubSub.subscribe(\"body.mode.set\", (msg, data) => {\n\t\t\t// Checks when leaving floor imagery editing\n\t\t\tif(this.state.mode === Body.MODE_FLOOR_IMAGERY && data.mode !== Body.MODE_FLOOR_IMAGERY) {\n\t\t\t\t// Lock floor imagery\n\t\t\t\twindow.imageryManager.lockFloorImagery();\n\n\t\t\t\t// Show complete levels dialog if necessary\n\t\t\t\tconst imagesNoLevel = window.imageryManager.getFloorImages().filter(img => img.level === undefined || img.level === null || isNaN(img.level));\n\t\t\t\tif(imagesNoLevel.length > 0) {\n\t\t\t\t\tthis.setState({ showDialogCompleteFloorImagery: true });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif(data.mode === Body.MODE_EXPLORE) {\n\t\t\t\tthis.setState({\n\t\t\t\t\tmode: data.mode,\n\t\t\t\t\tbuilding: null,\n\t\t\t\t\tfloor: null,\n// \t\t\t\t\tlevel: 0,\n\t\t\t\t\tfeature: null,\n\t\t\t\t\tcopyingFeature: null,\n\t\t\t\t\tdraw: null,\n\t\t\t\t\tpreset: null,\n\t\t\t\t\tleftPanelOpen: false,\n\t\t\t\t\tpane: null\n\t\t\t\t});\n\t\t\t}\n\t\t\telse if(data.mode === Body.MODE_BUILDING) {\n\t\t\t\tthis.setState({\n\t\t\t\t\tmode: data.mode,\n\t\t\t\t\tfloor: null,\n// \t\t\t\t\tlevel: 0,\n\t\t\t\t\tfeature: null,\n\t\t\t\t\tcopyingFeature: null,\n\t\t\t\t\tdraw: null,\n\t\t\t\t\tpreset: null,\n\t\t\t\t\tleftPanelOpen: this.state.building !== null,\n\t\t\t\t\tpane: this.state.building !== null ? LeftPanel.PANE_BUILDING_EDIT : null\n\t\t\t\t}, () => {\n\t\t\t\t\tif(this.state.building) {\n\t\t\t\t\t\tPubSub.publish(\"body.select.building\", { building: this.state.building });\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\telse if(data.mode === Body.MODE_LEVELS) {\n\t\t\t\tlet theFloor = this.state.floor !== this.state.building ? this.state.floor : null;\n\n\t\t\t\tif(!theFloor) {\n\t\t\t\t\tconst floorParts = window.vectorDataManager.getLevelFootprint(this.state.building, this.state.level);\n\t\t\t\t\ttheFloor = floorParts.length === 1 ? floorParts[0] : null;\n\t\t\t\t}\n\n\t\t\t\tthis.setState({\n\t\t\t\t\tmode: data.mode,\n\t\t\t\t\tbuilding: window.vectorDataManager.getBuildingLevels(this.state.building),\n\t\t\t\t\tfloor: theFloor,\n\t\t\t\t\tfeature: null,\n\t\t\t\t\tcopyingFeature: null,\n\t\t\t\t\tdraw: null,\n\t\t\t\t\tpreset: null,\n\t\t\t\t\tleftPanelOpen: true,\n\t\t\t\t\tpane: theFloor ? LeftPanel.PANE_LEVELS_EDIT : LeftPanel.PANE_LEVELS_ADD\n\t\t\t\t});\n\t\t\t}\n\t\t\telse if(data.mode === Body.MODE_FEATURES) {\n\t\t\t\tthis.setState({\n\t\t\t\t\tmode: data.mode,\n\t\t\t\t\tfeature: null,\n\t\t\t\t\tcopyingFeature: null,\n\t\t\t\t\tdraw: null,\n\t\t\t\t\tpreset: null,\n\t\t\t\t\tleftPanelOpen: true,\n\t\t\t\t\tpane: LeftPanel.PANE_FEATURE_ADD\n\t\t\t\t});\n\t\t\t}\n\t\t\telse if(data.mode === Body.MODE_CHANGESET) {\n\t\t\t\tthis.setState({\n\t\t\t\t\tmode: data.mode,\n\t\t\t\t\tbuilding: null,\n\t\t\t\t\tfloor: null,\n// \t\t\t\t\tlevel: 0,\n\t\t\t\t\tfeature: null,\n\t\t\t\t\tcopyingFeature: null,\n\t\t\t\t\tdraw: null,\n\t\t\t\t\tpreset: null,\n\t\t\t\t\tleftPanelOpen: true,\n\t\t\t\t\tpane: LeftPanel.PANE_CHANGESET,\n\t\t\t\t\tchangeset: {\n\t\t\t\t\t\tstatus: \"preparing\"\n\t\t\t\t\t},\n\t\t\t\t\trightPanelOpen: false\n\t\t\t\t}, async () => {\n\t\t\t\t\tconst diff = await window.vectorDataManager.computeDiff();\n\t\t\t\t\tconst missingOutlines = window.vectorDataManager.findMissingLevelOutlines(diff);\n\n\t\t\t\t\tthis.setState({\n\t\t\t\t\t\tshowDialogMissingLevelOutlines: missingOutlines,\n\t\t\t\t\t\tchangeset: {\n\t\t\t\t\t\t\ttags: {\n\t\t\t\t\t\t\t\tcomment: \"\",\n\t\t\t\t\t\t\t\timagery_used: this._usedImageryNames && this._usedImageryNames.size > 0 ? [...this._usedImageryNames].join(\";\") : undefined\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tdiff: diff,\n\t\t\t\t\t\t\tstatus: \"check\"\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t\telse if(data.mode === Body.MODE_FLOOR_IMAGERY) {\n\t\t\t\tthis.setState({\n\t\t\t\t\tmode: data.mode,\n\t\t\t\t\tdraw: null,\n// \t\t\t\t\tlevel: 0,\n\t\t\t\t\tleftPanelOpen: true,\n\t\t\t\t\tpane: LeftPanel.PANE_FLOOR_IMAGERY\n\t\t\t\t});\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.setState({\n\t\t\t\t\tmode: data.mode,\n\t\t\t\t\tpane: null,\n\t\t\t\t\tleftPanelOpen: false\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for changing current shown level\n\t\t * @event body.level.set\n\t\t * @memberof Body\n\t\t * @property {float} level The level to use\n\t\t */\n\t\tPubSub.subscribe(\"body.level.set\", (msg, data) => {\n\t\t\tconst newState = { level: data.level };\n\n\t\t\tif(this.state.mode === Body.MODE_LEVELS) {\n\t\t\t\tconst floorParts = window.vectorDataManager.getLevelFootprint(this.state.building, data.level);\n\n\t\t\t\tnewState.floor = floorParts.length === 1 ? floorParts[0] : null;\n\t\t\t\tnewState.pane = floorParts.length === 1 ? LeftPanel.PANE_LEVELS_EDIT : LeftPanel.PANE_LEVELS_ADD;\n\t\t\t\tnewState.draw = null;\n\t\t\t}\n\t\t\telse if(this.state.mode === Body.MODE_FEATURES) {\n\t\t\t\t// Do not keep selection if feature not present on next level\n\t\t\t\tif(\n\t\t\t\t\t!this.state.feature || !this.state.feature.properties.own\n\t\t\t\t\t|| !this.state.feature.properties.own.levels\n\t\t\t\t\t|| !this.state.feature.properties.own.levels.includes(data.level)\n\t\t\t\t) {\n\t\t\t\t\tnewState.feature = null;\n\t\t\t\t\tnewState.pane = LeftPanel.PANE_FEATURE_ADD;\n\t\t\t\t}\n\n\t\t\t\tnewState.floor = null;\n\t\t\t\tnewState.draw = null;\n\t\t\t\tnewState.preset = null;\n\t\t\t\tthis._pushUsedPreset(this.state.preset);\n\t\t\t}\n\n\t\t\tthis.setState(newState);\n\t\t});\n\n\t\t/**\n\t\t * Event for adding a new level to a building\n\t\t * @event body.level.add\n\t\t * @memberof Body\n\t\t * @property {string} where Should we add level on top (upper) or underground (below) ?\n\t\t */\n\t\tPubSub.subscribe(\"body.level.add\", (msg, data) => {\n\t\t\tif(this.state.datalocked) {\n\t\t\t\tsetTimeout(() => PubSub.publish(\"body.level.add\", data), 100);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst levels = this.state.building.properties.own.levels;\n\n\t\t\tif(data.where === \"upper\") {\n\t\t\t\tlet max = Math.floor(levels[levels.length-1]);\n\t\t\t\tconst newBuilding = Object.assign({}, this.state.building);\n\t\t\t\tnewBuilding.properties.own.levels.push(max + 1);\n\t\t\t\tthis.setState(\n\t\t\t\t\t{ datalocked: true },\n\t\t\t\t\t() => this.setState({\n\t\t\t\t\t\tdatalocked: false,\n\t\t\t\t\t\tbuilding: window.vectorDataManager.editFeature(newBuilding, true),\n\t\t\t\t\t\tlevel: max+1,\n\t\t\t\t\t\tfloor: null,\n\t\t\t\t\t\tpane: LeftPanel.PANE_LEVELS_ADD,\n\t\t\t\t\t\tleftPanelOpen: true\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t}\n\t\t\telse if(data.where === \"below\") {\n\t\t\t\tlet min = Math.ceil(levels[0]);\n\t\t\t\tconst newBuilding = Object.assign({}, this.state.building);\n\t\t\t\tnewBuilding.properties.own.levels.unshift(min - 1);\n\t\t\t\tthis.setState(\n\t\t\t\t\t{ datalocked: true },\n\t\t\t\t\t() => this.setState({\n\t\t\t\t\t\tdatalocked: false,\n\t\t\t\t\t\tbuilding: window.vectorDataManager.editFeature(newBuilding, true),\n\t\t\t\t\t\tlevel: min-1,\n\t\t\t\t\t\tfloor: null,\n\t\t\t\t\t\tpane: LeftPanel.PANE_LEVELS_ADD,\n\t\t\t\t\t\tleftPanelOpen: true\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for copying data from another level into the current one.\n\t\t * @event body.level.copy\n\t\t * @memberof Body\n\t\t * @property {float} use The level to copy data from\n\t\t */\n\t\tPubSub.subscribe(\"body.level.copy\", (msg, data) => {\n\t\t\tif(this.state.datalocked) {\n\t\t\t\tsetTimeout(() => PubSub.publish(\"body.level.copy\", data), 100);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tif(this.state.mode === Body.MODE_LEVELS && this.state.building && this.state.level && data.use) {\n\t\t\t\tthis.setState(\n\t\t\t\t\t{ datalocked: true },\n\t\t\t\t\t() => {\n\t\t\t\t\t\twindow.vectorDataManager.copyLevel(this.state.building, data.use, this.state.level);\n\t\t\t\t\t\tthis.setState({ datalocked: false });\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for toggling one of the side panels\n\t\t * @event body.panel.toggle\n\t\t * @memberof Body\n\t\t * @property {string} panel The panel to toggle (either right or left)\n\t\t */\n\t\tPubSub.subscribe(\"body.panel.toggle\", (msg, data) => {\n\t\t\tif(data.panel === \"right\") {\n\t\t\t\tthis.setState({ rightPanelOpen: !this.state.rightPanelOpen });\n\t\t\t}\n\t\t\telse if(data.panel === \"left\") {\n\t\t\t\tthis.setState({ leftPanelOpen: !this.state.leftPanelOpen });\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event when a particular building has been selected\n\t\t * @event body.select.building\n\t\t * @memberof Body\n\t\t * @property {Object} building The selected building GeoJSON feature\n\t\t */\n\t\tPubSub.subscribe(\"body.select.building\", (msg, data) => {\n\t\t\tconst newState = {\n\t\t\t\tbuilding: data.building ? window.vectorDataManager.getBuildingLevels(data.building) : null,\n\t\t\t\tleftPanelOpen: data.building !== null,\n\t\t\t\tpane: data.building ? LeftPanel.PANE_BUILDING_EDIT : null\n\t\t\t};\n\n\t\t\tthis.setState(newState);\n\t\t});\n\n\t\t/**\n\t\t * Event when a particular floor has been selected\n\t\t * @event body.select.floor\n\t\t * @memberof Body\n\t\t * @property {Object} floor The selected floor GeoJSON feature (or eventually building if no floor was found)\n\t\t */\n\t\tPubSub.subscribe(\"body.select.floor\", (msg, data) => {\n\t\t\tconst newState = {\n\t\t\t\tfloor: data.floor,\n\t\t\t\tpane: data.floor ? LeftPanel.PANE_LEVELS_EDIT : LeftPanel.PANE_LEVELS_ADD\n\t\t\t};\n\n\t\t\tthis.setState(newState);\n\t\t});\n\n\t\t/**\n\t\t * Event when a particular feature has been selected\n\t\t * @event body.select.feature\n\t\t * @memberof Body\n\t\t * @property {Object} feature The selected feature as GeoJSON\n\t\t */\n\t\tPubSub.subscribe(\"body.select.feature\", (msg, data) => {\n\t\t\tconst newState = {\n\t\t\t\tfeature: data.feature,\n\t\t\t\tleftPanelOpen: data.feature ? true : false\n\t\t\t};\n\n\t\t\tif(this.state.mode === Body.MODE_EXPLORE) {\n\t\t\t\tnewState.pane = data.feature ? LeftPanel.PANE_FEATURE_VIEW : null;\n\t\t\t\tnewState.building = data.feature ? window.vectorDataManager.findAssociatedBuilding(data.feature) : null;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tnewState.pane = data.feature ? LeftPanel.PANE_FEATURE_EDIT : LeftPanel.PANE_FEATURE_ADD;\n\t\t\t\tnewState.preset = data.feature ? this.state.preset : null;\n\t\t\t}\n\n\t\t\tthis.setState(newState);\n\t\t});\n\n\t\t/**\n\t\t * Event when a particular preset has been selected\n\t\t * @event body.select.preset\n\t\t * @memberof Body\n\t\t * @property {Object} preset The selected preset (or null to unselect)\n\t\t * @property {string} [type] The geometry type to use for drawing\n\t\t */\n\t\tPubSub.subscribe(\"body.select.preset\", (msg, data) => {\n\t\t\tif(this.state.mode === Body.MODE_FEATURES) {\n\t\t\t\tthis.setState({ preset: data.preset ? Object.assign({ type: [] }, data.preset) : null });\n\n\t\t\t\t// Start editing directly if only one geometry type allowed, or explictly defined in event data\n\t\t\t\tif(data.preset) {\n\t\t\t\t\tconst types = data.preset.type ? data.preset.type.map(p => Editable.PRESET_TO_DRAW[p]).filter(p => p !== undefined) : [];\n\t\t\t\t\tif(Editable.PRESET_TO_DRAW[data.type] || types.length === 1) {\n\t\t\t\t\t\tPubSub.publish(\"body.draw.feature\", { type: Editable.PRESET_TO_DRAW[data.type] || types[0] });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for unselecting currently selected feature\n\t\t * @event body.unselect.feature\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.unselect.feature\", (msg, data) => {\n\t\t\tif(this.state.mode === Body.MODE_BUILDING) {\n\t\t\t\tPubSub.publish(\"body.select.building\", { building: null });\n\t\t\t}\n\t\t\telse if(this.state.mode === Body.MODE_LEVELS) {\n\t\t\t\tPubSub.publish(\"body.select.floor\", { floor: null });\n\t\t\t}\n\t\t\telse if(this.state.mode === Body.MODE_FEATURES) {\n\t\t\t\tPubSub.publish(\"body.select.feature\", { feature: null });\n\t\t\t}\n\t\t\telse if(this.state.mode === Body.MODE_EXPLORE) {\n\t\t\t\tPubSub.publish(\"body.select.feature\", { feature: null });\n\t\t\t\tPubSub.publish(\"body.select.floor\", { floor: null });\n\t\t\t\tPubSub.publish(\"body.select.building\", { building: null });\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event when user should start drawing a new building\n\t\t * @event body.draw.building\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.draw.building\", (msg, data) => {\n\t\t\tif(this.state.building) {\n\t\t\t\tPubSub.publishSync(\"body.unselect.feature\");\n\t\t\t}\n\t\t\tthis.setState({ draw: Editable.DRAW_POLYGON });\n\t\t});\n\n\t\t/**\n\t\t * Event when user should start drawing a new floor\n\t\t * @event body.draw.floor\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.draw.floor\", (msg, data) => {\n\t\t\tthis.setState({ floor: null, draw: Editable.DRAW_POLYGON, pane: null, leftPanelOpen: false });\n\t\t});\n\n\t\t/**\n\t\t * Event when user should start drawing a new feature\n\t\t * @event body.draw.feature\n\t\t * @memberof Body\n\t\t * @property {int} type The type of geometry (use EditableLayer.DRAW_* constants)\n\t\t */\n\t\tPubSub.subscribe(\"body.draw.feature\", (msg, data) => {\n\t\t\tthis.setState({ feature: null, draw: data.type, pane: null, leftPanelOpen: false });\n\t\t});\n\n\t\t/**\n\t\t * Event for stopping current drawing.\n\t\t * If geometry is valid, it will be kept. If not, it is removed from map.\n\t\t * @event body.draw.stop\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.draw.stop\", (msg, data) => {\n\t\t\tif(\n\t\t\t\tthis.state.draw && this.map && this.map.elem\n\t\t\t\t&& this.map.elem.leafletElement && this.map.elem.leafletElement.editTools\n\t\t\t) {\n\t\t\t\tthis.map.elem.leafletElement.editTools.stopDrawing();\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event when user has done drawing the requested feature\n\t\t * @event body.draw.done\n\t\t * @memberof Body\n\t\t * @property {Object} feature The GeoJSON feature that was created\n\t\t */\n\t\tPubSub.subscribe(\"body.draw.done\", (msg, data) => {\n\t\t\t// If data is currently loading, wait before creating new geometry\n\t\t\tif(this.map && !this.map.isLoading() && !this.state.datalocked) {\n\t\t\t\tthis.setState(\n\t\t\t\t\t{ datalocked: true },\n\t\t\t\t\t() => {\n\t\t\t\t\t\tthis._addUsedImagery();\n\t\t\t\t\t\tconst newState = { draw: null, datalocked: false, leftPanelOpen: true };\n\n\t\t\t\t\t\tif(this.state.mode === Body.MODE_BUILDING) {\n\t\t\t\t\t\t\tnewState.building = window.vectorDataManager.createNewBuilding(data.feature);\n\t\t\t\t\t\t\tnewState.pane = LeftPanel.PANE_BUILDING_EDIT;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if(this.state.mode === Body.MODE_LEVELS) {\n\t\t\t\t\t\t\tif(window.vectorDataManager.isOverlappingEnough(this.state.building, data.feature)) {\n\t\t\t\t\t\t\t\tnewState.floor = window.vectorDataManager.createNewFloor(data.feature, this.state.level);\n\t\t\t\t\t\t\t\tnewState.pane = LeftPanel.PANE_LEVELS_EDIT;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tnewState.showDialogOutOfBoundsGeometry = true;\n\t\t\t\t\t\t\t\tdelete newState.leftPanelOpen;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if(this.state.mode === Body.MODE_FEATURES && this.state.preset) {\n\t\t\t\t\t\t\tif(\n\t\t\t\t\t\t\t\t(this.state.preset.tags && !this.state.preset.tags.indoor)\n\t\t\t\t\t\t\t\t|| window.vectorDataManager.isOverlappingEnough(this.state.building, data.feature)\n\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\tnewState.feature = window.vectorDataManager.createNewFeature(data.feature, this.state.level, this.state.preset);\n\t\t\t\t\t\t\t\tnewState.pane = LeftPanel.PANE_FEATURE_EDIT;\n\t\t\t\t\t\t\t\tthis._pushUsedPreset(this.state.preset);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tnewState.showDialogOutOfBoundsGeometry = true;\n\t\t\t\t\t\t\t\tnewState.feature = null;\n\t\t\t\t\t\t\t\tnewState.pane = LeftPanel.PANE_FEATURE_ADD;\n\t\t\t\t\t\t\t\tnewState.preset = null;\n\t\t\t\t\t\t\t\tthis._pushUsedPreset(this.state.preset);\n\t\t\t\t\t\t\t\tPubSub.publish(\"map.editablelayer.redraw\");\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.setState(newState);\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tsetTimeout(() => PubSub.publish(\"body.draw.done\", data), 100);\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event when user wants to abort drawing\n\t\t * @event body.draw.cancel\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.draw.cancel\", (msg, data) => {\n\t\t\tconst newState = { draw: null };\n\n\t\t\tif(this.state.mode === Body.MODE_FEATURES) {\n\t\t\t\tnewState.preset = null;\n\t\t\t\tnewState.pane = LeftPanel.PANE_FEATURE_ADD;\n\t\t\t\tnewState.leftPanelOpen = true;\n\t\t\t}\n\t\t\telse if(this.state.mode === Body.MODE_LEVELS) {\n\t\t\t\tnewState.pane = LeftPanel.PANE_LEVELS_ADD;\n\t\t\t\tnewState.leftPanelOpen = true;\n\t\t\t}\n\n\t\t\tthis.setState(newState);\n\t\t});\n\n\t\t/**\n\t\t * Event when new floor should be created directly (not using draw on map).\n\t\t * This is mainly used when user creates a new floor using building footprint.\n\t\t * @event body.create.floor\n\t\t * @memberof Body\n\t\t * @property {Object} feature The GeoJSON feature to use\n\t\t * @property {int} [level] Which level floor should be created on (by default selected level)\n\t\t */\n\t\tPubSub.subscribe(\"body.create.floor\", (msg, data) => {\n\t\t\tif(this.state.datalocked) {\n\t\t\t\tsetTimeout(() => PubSub.publish(\"body.create.floor\", data), 100);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst newFeature = {\n\t\t\t\ttype: \"Feature\",\n\t\t\t\tgeometry: Object.assign({}, data.feature.geometry),\n\t\t\t\tproperties: {}\n\t\t\t};\n\n\t\t\tif(this.state.mode === Body.MODE_LEVELS) {\n\t\t\t\tif(window.vectorDataManager.isOverlappingEnough(this.state.building, newFeature)) {\n\t\t\t\t\tthis.setState(\n\t\t\t\t\t\t{ datalocked: true },\n\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\tthis._addUsedImagery();\n\t\t\t\t\t\t\tthis.setState({\n\t\t\t\t\t\t\t\tdatalocked: false,\n\t\t\t\t\t\t\t\tfloor: window.vectorDataManager.createNewFloor(newFeature, this.state.level),\n\t\t\t\t\t\t\t\tpane: LeftPanel.PANE_LEVELS_EDIT\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.setState({ showDialogOutOfBoundsGeometry: true });\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if(this.state.mode === Body.MODE_CHANGESET && !isNaN(data.level)) {\n\t\t\t\twindow.vectorDataManager.createNewFloor(newFeature, data.level);\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event when geometry of an existing feature has been edited\n\t\t * @event body.edit.feature\n\t\t * @memberof Body\n\t\t * @property {Object} feature The edited version of the GeoJSON feature\n\t\t * @property {boolean} select Should feature be selected after update (defaults to yes)\n\t\t */\n\t\tPubSub.subscribe(\"body.edit.feature\", (msg, data) => {\n\t\t\tif(this.state.datalocked) {\n\t\t\t\tsetTimeout(() => PubSub.publish(\"body.edit.feature\", data), 100);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tif(data.feature && data.feature.id) {\n\t\t\t\tif(\n\t\t\t\t\t!data.feature.id.startsWith(\"relation/\")\n\t\t\t\t\t|| window.vectorDataManager.isRelationEditingSupported(window.vectorDataManager.findFeature(data.feature.id), data.feature)\n\t\t\t\t) {\n\t\t\t\t\tif(\n\t\t\t\t\t\t(data.feature.properties.tags && !data.feature.properties.tags.indoor)\n\t\t\t\t\t\t|| window.vectorDataManager.isOverlappingEnough(this.state.building, data.feature)\n\t\t\t\t\t) {\n\t\t\t\t\t\tthis.setState(\n\t\t\t\t\t\t\t{ datalocked: true },\n\t\t\t\t\t\t\tasync () => {\n\t\t\t\t\t\t\t\tthis._addUsedImagery();\n\t\t\t\t\t\t\t\tconst feature = await window.vectorDataManager.editFeatureGeometry(data.feature.id, data.feature.geometry);\n\t\t\t\t\t\t\t\tthis.setState({ datalocked: false }, () => {\n\t\t\t\t\t\t\t\t\tif(feature && (data.select === undefined || data.select === true)) {\n\t\t\t\t\t\t\t\t\t\tif(this.state.mode === Body.MODE_BUILDING) {\n\t\t\t\t\t\t\t\t\t\t\tPubSub.publish(\"body.select.building\", { building: feature });\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse if(this.state.mode === Body.MODE_LEVELS) {\n\t\t\t\t\t\t\t\t\t\t\tPubSub.publish(\"body.select.floor\", { floor: feature });\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse if(this.state.mode === Body.MODE_FEATURES) {\n\t\t\t\t\t\t\t\t\t\t\tPubSub.publish(\"body.select.feature\", { feature: feature });\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tthis.setState({ showDialogOutOfBoundsGeometry: true, floor: null, pane: LeftPanel.PANE_LEVELS_ADD }, () => {\n\t\t\t\t\t\t\tPubSub.publish(\"map.editablelayer.redraw\");\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\talert(I18n.t(\"The editor doesn't support yet this kind of complex geometry editing.\"));\n\t\t\t\t\tPubSub.publish(\"map.editablelayer.redraw\");\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tconsole.log(\"Missing information for editing this feature\", data.feature);\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for deleting currently selected feature\n\t\t * @event body.delete.feature\n\t\t * @memberof Body\n\t\t * @property {boolean} [confirmed] Is the action confirmed by user (for building/level only)\n\t\t * @property {boolean} [deleteAll] Delete also features contained in building/level\n\t\t */\n\t\tPubSub.subscribe(\"body.delete.feature\", (msg, data) => {\n\t\t\tif(this.state.datalocked) {\n\t\t\t\tsetTimeout(() => PubSub.publish(\"body.delete.feature\", data), 100);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tdata = data || {};\n\n\t\t\t// Erase data\n\t\t\tif(this.state.mode === Body.MODE_FEATURES && this.state.feature) {\n\t\t\t\tthis.setState(\n\t\t\t\t\t{ datalocked: true },\n\t\t\t\t\t() => {\n\t\t\t\t\t\tthis._addUsedImagery();\n\t\t\t\t\t\twindow.vectorDataManager.deleteFeature(this.state.feature);\n\t\t\t\t\t\tPubSub.publish(\"body.unselect.feature\");\n\t\t\t\t\t\tthis.setState({ datalocked: false });\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t\telse if(data.confirmed) {\n\t\t\t\tthis.setState(\n\t\t\t\t\t{ datalocked: true },\n\t\t\t\t\t() => {\n\t\t\t\t\t\tthis._addUsedImagery();\n\t\t\t\t\t\tif(this.state.mode === Body.MODE_BUILDING && this.state.building) {\n\t\t\t\t\t\t\twindow.vectorDataManager.deleteFeature(this.state.building, data.deleteAll);\n\t\t\t\t\t\t\tPubSub.publish(\"body.unselect.feature\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if(this.state.mode === Body.MODE_LEVELS && this.state.floor) {\n\t\t\t\t\t\t\twindow.vectorDataManager.deleteFeature(this.state.floor, data.deleteAll);\n\t\t\t\t\t\t\tPubSub.publish(\"body.unselect.feature\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.setState({ datalocked: false });\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t\t// Ask for confirmation first\n\t\t\telse if((this.state.mode === Body.MODE_BUILDING && this.state.building) || (this.state.mode === Body.MODE_LEVELS && this.state.floor)) {\n\t\t\t\tthis.setState({ showDialogConfirmDeletion: true });\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for orthogonalize (make square) currently selected feature\n\t\t * @event body.square.feature\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.square.feature\", (msg, data) => {\n\t\t\tif(this.state.datalocked) {\n\t\t\t\tsetTimeout(() => PubSub.publish(\"body.square.feature\", data), 100);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tthis.setState(\n\t\t\t\t{ datalocked: true },\n\t\t\t\tasync () => {\n\t\t\t\t\tconst squarify = async (feature) => {\n\t\t\t\t\t\treturn await window.vectorDataManager.makeFeatureSquare(feature.id, this.map.elem.leafletElement);\n\t\t\t\t\t};\n\n\t\t\t\t\tif(this.state.mode === Body.MODE_BUILDING && this.state.building) {\n\t\t\t\t\t\tPubSub.publish(\"body.select.building\", { building: await squarify(this.state.building) });\n\t\t\t\t\t}\n\t\t\t\t\telse if(this.state.mode === Body.MODE_LEVELS && this.state.floor) {\n\t\t\t\t\t\tPubSub.publish(\"body.select.floor\", { floor: await squarify(this.state.floor) });\n\t\t\t\t\t}\n\t\t\t\t\telse if(this.state.mode === Body.MODE_FEATURES && this.state.feature) {\n\t\t\t\t\t\tPubSub.publish(\"body.select.feature\", { feature: await squarify(this.state.feature) });\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.setState({ datalocked: false });\n\t\t\t\t}\n\t\t\t);\n\t\t});\n\n\t\t/**\n\t\t * Event for copying selected feature (and paste it later)\n\t\t * @event body.copy.feature\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.copy.feature\", (msg, data) => {\n\t\t\tif(this.state.mode === Body.MODE_FEATURES && this.state.feature) {\n\t\t\t\tthis.setState({ copyingFeature: this.state.feature });\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for pasting previously copied feature\n\t\t * @event body.paste.feature\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.paste.feature\", (msg, data) => {\n\t\t\tif(this.state.datalocked) {\n\t\t\t\tsetTimeout(() => PubSub.publish(\"body.paste.feature\", data), 100);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tif(this.state.mode === Body.MODE_FEATURES && this.state.copyingFeature) {\n\t\t\t\tconst mouseCoords = this.map && this.map._mouseCoords;\n\n\t\t\t\tif(mouseCoords) {\n\t\t\t\t\tthis.setState(\n\t\t\t\t\t\t{ datalocked: true },\n\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\tthis._addUsedImagery();\n\n\t\t\t\t\t\t\tthis.setState({\n\t\t\t\t\t\t\t\tfeature: window.vectorDataManager.copyFeature(this.state.copyingFeature, this.state.level, mouseCoords),\n\t\t\t\t\t\t\t\tleftPanelOpen: true,\n\t\t\t\t\t\t\t\tpane: LeftPanel.PANE_FEATURE_EDIT,\n\t\t\t\t\t\t\t\tdatalocked: false\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for pasting tags of previously copied feature\n\t\t * @event body.paste.tags\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.paste.tags\", (msg, data) => {\n\t\t\tif(this.state.datalocked) {\n\t\t\t\tsetTimeout(() => PubSub.publish(\"body.paste.tags\", data), 100);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tif(this.state.mode === Body.MODE_FEATURES && this.state.copyingFeature && this.state.feature) {\n\t\t\t\tconst tags = Object.assign({}, this.state.feature.properties.tags, this.state.copyingFeature.properties.tags);\n\t\t\t\tPubSub.publish(\"body.tags.set\", { tags: tags });\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for changing imagery to display on map\n\t\t * @event body.imagery.set\n\t\t * @memberof Body\n\t\t * @property {Object[]} imagery The imagery to use\n\t\t * @property {string} type The kind of layer concerned (background, overlay)\n\t\t */\n\t\tPubSub.subscribe(\"body.imagery.set\", (msg, data) => {\n\t\t\tif(data.type === \"overlay\") {\n\t\t\t\tthis.setState({ selectedOverlaysImagery: data.imagery });\n\t\t\t}\n\t\t\telse if(data.type === \"background\") {\n\t\t\t\tthis.setState({ selectedBaseImagery: data.imagery[0] });\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for changing imagery opacity on map\n\t\t * @event body.imagery.opacity\n\t\t * @memberof Body\n\t\t * @property {float} opacity The new opacity value\n\t\t * @property {string} type The kind of layer concerned (background, overlay or floor)\n\t\t */\n\t\tPubSub.subscribe(\"body.imagery.opacity\", (msg, data) => {\n\t\t\tif(data.type !== \"floor\") {\n\t\t\t\tconst typeToVar = { \"background\": \"baseImageryOpacity\", \"overlay\": \"overlaysImageryOpacity\" };\n\t\t\t\tthis.setState({ [typeToVar[data.type]]: data.opacity });\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Find selected layer\n\t\t\t\tconst selected = window.imageryManager.getFloorImages().find(img => img.selected && img.visible);\n\t\t\t\tif(selected) {\n\t\t\t\t\tPubSub.publish(\"body.floorimagery.update\", { imagery: [ Object.assign({}, selected, { opacity: data.opacity }) ] });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for adding new floor imagery on map\n\t\t * @event body.floorimagery.add\n\t\t * @memberof Body\n\t\t * @property {Object[]} imagery The imagery to add\n\t\t */\n\t\tPubSub.subscribe(\"body.floorimagery.add\", async (msg, data) => {\n\t\t\tawait window.imageryManager.addFloorImagery(data.imagery, this.map.getBounds(), this.map.elem.leafletElement);\n\t\t\tif(this.state.floorImageryMode === null) {\n\t\t\t\tthis.setState({ floorImageryMode: \"scale\" });\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.forceUpdate();\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for updating some floor imagery\n\t\t * @event body.floorimagery.update\n\t\t * @memberof Body\n\t\t * @property {Object[]} imagery The imagery to update (should have their ID defined)\n\t\t */\n\t\tPubSub.subscribe(\"body.floorimagery.update\", async (msg, data) => {\n\t\t\tawait window.imageryManager.updateFloorImagery(data.imagery);\n\t\t\tthis.forceUpdate();\n\t\t});\n\n\t\t/**\n\t\t * Event for changing editing tool\n\t\t * @event body.floorimagery.mode\n\t\t * @memberof Body\n\t\t * @property {string} [mode] The tool to use (distort, scale, rotate)\n\t\t */\n\t\tPubSub.subscribe(\"body.floorimagery.mode\", async (msg, data) => {\n\t\t\tthis.setState({ floorImageryMode: data.mode });\n\t\t});\n\n\t\t/**\n\t\t * Event for removing some floor imagery\n\t\t * @event body.floorimagery.remove\n\t\t * @memberof Body\n\t\t * @property {string} [id] The imagery ID, or all imagery if null\n\t\t */\n\t\tPubSub.subscribe(\"body.floorimagery.remove\", async (msg, data) => {\n\t\t\tawait window.imageryManager.removeFloorImagery(data && data.id);\n\t\t\tthis.forceUpdate();\n\t\t});\n\n\t\t/**\n\t\t * Event for offering user to save its floor imagery configuration\n\t\t * @event body.floorimagery.save\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.floorimagery.save\", (msg, data) => {\n\t\t\tsaveAs(\n\t\t\t\tnew Blob(\n\t\t\t\t\t[JSON.stringify(window.imageryManager.getFloorImages(), null, 2)],\n\t\t\t\t\t{ type: \"text/plain;charset=utf-8\" }\n\t\t\t\t),\n\t\t\t\t\"osminedit_floor_imagery.json\"\n\t\t\t);\n\t\t});\n\n\t\t/**\n\t\t * Event for copying current floor plan position into memory\n\t\t * @event body.floorimagery.copyposition\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.floorimagery.copyposition\", async (msg, data) => {\n\t\t\t// Find selected floor imagery\n\t\t\tconst selected = window.imageryManager.getFloorImages().find(img => img.selected && img.visible);\n\t\t\tif(selected) {\n\t\t\t\tthis.setState({ floorImageryCopyPaste: {\n\t\t\t\t\ttopleft: selected.topleft,\n\t\t\t\t\ttopright: selected.topright,\n\t\t\t\t\tbottomleft: selected.bottomleft,\n\t\t\t\t\tbottomright: selected.bottomright,\n\t\t\t\t\torigWidth: selected.origWidth,\n\t\t\t\t\torigHeight: selected.origHeight\n\t\t\t\t} });\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for pasting previously copied position on selected floor plan\n\t\t * @event body.floorimagery.pasteposition\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.floorimagery.pasteposition\", async (msg, data) => {\n\t\t\tawait window.imageryManager.moveFloorImagery(this.map && this.map.elem && this.map.elem.leafletElement, this.state.floorImageryCopyPaste);\n\t\t\tthis.forceUpdate();\n\t\t});\n\n\t\t/**\n\t\t * Event for changing tags of currently selected feature\n\t\t * @event body.tags.set\n\t\t * @memberof Body\n\t\t * @property {Object} tags The new set of tags for current feature\n\t\t */\n\t\tPubSub.subscribe(\"body.tags.set\", (msg, data) => {\n\t\t\tif(this.state.datalocked) {\n\t\t\t\tsetTimeout(() => PubSub.publish(\"body.tags.set\", data), 100);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tif(this.state.mode === Body.MODE_CHANGESET) {\n\t\t\t\tconst c = Object.assign({}, this.state.changeset, { tags: data.tags });\n\t\t\t\tthis.setState({ changeset: c });\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.setState(\n\t\t\t\t\t{ datalocked: true },\n\t\t\t\t\t() => {\n\t\t\t\t\t\tthis._addUsedImagery();\n\n\t\t\t\t\t\tif(this.state.mode === Body.MODE_BUILDING) {\n\t\t\t\t\t\t\tconst f = Object.assign({}, this.state.building);\n\t\t\t\t\t\t\tif(!data.tags.building || data.tags.building.trim() === \"\") { data.tags.building = \"yes\"; }\n\t\t\t\t\t\t\tthis.setState({ building: window.vectorDataManager.setFeatureTags(f.id, data.tags), datalocked: false });\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if(this.state.mode === Body.MODE_LEVELS) {\n\t\t\t\t\t\t\tconst f = Object.assign({}, this.state.floor);\n\t\t\t\t\t\t\tthis.setState({ floor: window.vectorDataManager.setFeatureTags(f.id, data.tags), datalocked: false });\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if(this.state.mode === Body.MODE_FEATURES) {\n\t\t\t\t\t\t\tconst f = Object.assign({}, this.state.feature);\n\t\t\t\t\t\t\tconst oldLevels = this.state.feature.properties.own.levels;\n\n\t\t\t\t\t\t\tthis.setState(\n\t\t\t\t\t\t\t\t{ feature: window.vectorDataManager.setFeatureTags(f.id, data.tags), datalocked: false },\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tif(!deepEqual(oldLevels, this.state.feature.properties.own.levels)) {\n\t\t\t\t\t\t\t\t\t\t// Find if all levels set in feature exist on building\n\t\t\t\t\t\t\t\t\t\tif(\n\t\t\t\t\t\t\t\t\t\t\tthis.state.building\n\t\t\t\t\t\t\t\t\t\t\t&& this.state.feature.properties.own.levels.findIndex(lvl => !this.state.building.properties.own.levels.includes(lvl)) >= 0\n\t\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\t\t// Process again all available levels in building\n\t\t\t\t\t\t\t\t\t\t\tconst newBuilding = Object.assign({}, this.state.building);\n\t\t\t\t\t\t\t\t\t\t\tnewBuilding.properties.own.levelsComputed = false;\n\t\t\t\t\t\t\t\t\t\t\twindow.vectorDataManager.getBuildingLevels(newBuilding);\n\t\t\t\t\t\t\t\t\t\t\tthis.setState({ building: newBuilding });\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tthis.setState({ datalocked: false });\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for cancelling last action\n\t\t * @event body.action.undo\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.action.undo\", (msg, data) => {\n\t\t\tif(this.state.datalocked) {\n\t\t\t\tsetTimeout(() => PubSub.publish(\"body.action.undo\", data), 100);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tthis.setState(\n\t\t\t\t{ datalocked: true },\n\t\t\t\t() => {\n\t\t\t\t\tif(this.state.mode === Body.MODE_FLOOR_IMAGERY) {\n\t\t\t\t\t\twindow.imageryManager.undo();\n\t\t\t\t\t}\n\t\t\t\t\telse if([Body.MODE_BUILDING, Body.MODE_LEVELS, Body.MODE_FEATURES].includes(this.state.mode)) {\n\t\t\t\t\t\tif(this.state.draw) {\n\t\t\t\t\t\t\tPubSub.publish(\"body.draw.cancel\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\twindow.vectorDataManager.undo();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tthis.setState({ datalocked: false });\n\t\t\t\t\tthis.forceUpdate();\n\t\t\t\t}\n\t\t\t);\n\t\t});\n\n\t\t/**\n\t\t * Event for restoring last action\n\t\t * @event body.action.redo\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.action.redo\", (msg, data) => {\n\t\t\tif(this.state.datalocked) {\n\t\t\t\tsetTimeout(() => PubSub.publish(\"body.action.redo\", data), 100);\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tthis.setState(\n\t\t\t\t{ datalocked: true },\n\t\t\t\t() => {\n\t\t\t\t\tif(this.state.mode === Body.MODE_FLOOR_IMAGERY) {\n\t\t\t\t\t\twindow.imageryManager.redo();\n\t\t\t\t\t}\n\t\t\t\t\telse if([Body.MODE_BUILDING, Body.MODE_LEVELS, Body.MODE_FEATURES].includes(this.state.mode) && !this.state.draw) {\n\t\t\t\t\t\twindow.vectorDataManager.redo();\n\t\t\t\t\t}\n\t\t\t\t\tthis.setState({ datalocked: false });\n\t\t\t\t\tthis.forceUpdate();\n\t\t\t\t}\n\t\t\t);\n\t\t});\n\n\t\t/**\n\t\t * Event for saving all edits\n\t\t * @event body.action.save\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.action.save\", async (msg, data) => {\n\t\t\tthis.setState({ changeset: Object.assign({}, this.state.changeset, { status: \"upload\" }) });\n\t\t\tconst res = await window.vectorDataManager.sendOSMData(this.state.changeset.tags);\n\t\t\tif(typeof res === \"number\") {\n\t\t\t\tthis.setState({ changeset: { status: \"sent\", id: res } });\n\t\t\t}\n\t\t\telse {\n\t\t\t\tconsole.error(res);\n\t\t\t\tconst newState = { changeset: { status: \"error\" } };\n\n\t\t\t\tif(res.message === \"Changeset creation failed\") {\n\t\t\t\t\tnewState.changeset.reason = \"changeset_failed\";\n\t\t\t\t}\n\n\t\t\t\tthis.setState(newState);\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for cleaning up all data after changeset upload\n\t\t * @event body.action.cleanup\n\t\t * @memberof Body\n\t\t */\n\t\tPubSub.subscribe(\"body.action.cleanup\", (msg, data) => {\n\t\t\twindow.vectorDataManager.cleanUp();\n\t\t\tif(this.map) {\n\t\t\t\tthis.map.cleanUp();\n\t\t\t}\n\t\t\tthis._usedImageryNames = new Set();\n\t\t\tPubSub.publish(\"body.mode.set\", { mode: Body.MODE_BUILDING });\n\t\t});\n\n\t\t// Map zoom changes\n\t\tPubSub.subscribe(\"map.zoom.changed\", (msg, data) => {\n\t\t\tthis.setState({ zoom: data.zoom });\n\n\t\t\t// Disable locator overlay if zooming\n\t\t\tconst locator = this.state.selectedOverlaysImagery && this.state.selectedOverlaysImagery.find(l => l.properties.id === LOCATOR_OVERLAY_ID);\n\t\t\tif(locator && data.zoom && locator.properties.max_zoom && data.zoom > locator.properties.max_zoom) {\n\t\t\t\tconst newlist = this.state.selectedOverlaysImagery.filter(l => l.properties.id !== LOCATOR_OVERLAY_ID);\n\t\t\t\tthis.setState({ selectedOverlaysImagery: newlist.length === 0 ? null : newlist });\n\t\t\t}\n\t\t});\n\n\t\tlet win;\n\t\tfunction fixGeoJSON(collection) {\n\t\t\tcollection.features.forEach((feature) => {\n\t\t\t\tfeature.properties = {\n\t\t\t\t\t...feature.properties,\n\t\t\t\t\t...feature.properties.tags\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn collection;\n\t\t}\n\t\t// Preview open\n\t\tconst sendPreviewGeoJSON = () => {\n\t\t\tconst file = new File([JSON.stringify(fixGeoJSON(window.vectorDataManager._cacheOsmGeojson))], 'osminedit.geojson');\n\t\t\twin.postMessage({ command: 'preview', file }, '*');\n\t\t\twin.postMessage({ command: 'level', level: this.state.level.toString() }, '*');\n\t\t\twin.focus();\n\t\t}\n\t\tPubSub.subscribe(\"body.preview.open\", () => {\n\t\t\tif (!win || win.closed) {\n\t\t\t\twin = window.open(\"https://indoorequal.org/\");\n\t\t\t\twindow.addEventListener('message', (e) => {\n\t\t\t\t\tif (e.data.event === 'ready') {\n\t\t\t\t\t\tsendPreviewGeoJSON();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tsendPreviewGeoJSON();\n\t\t\t}\n\t\t});\n\n\n\t\t/*\n\t\t * Keyboard events\n\t\t */\n\n\t\tMousetrap.bind(\"esc\", () => {\n\t\t\t// Drawing mode\n\t\t\tif(this.state.draw) {\n\t\t\t\tPubSub.publish(\"body.draw.stop\");\n\t\t\t}\n\t\t\t// Unselect feature\n\t\t\telse if(\n\t\t\t\t(this.state.mode === Body.MODE_BUILDING && this.state.building)\n\t\t\t\t|| (this.state.mode === Body.MODE_LEVELS && this.state.floor)\n\t\t\t\t|| (this.state.mode === Body.MODE_FEATURES && this.state.feature)\n\t\t\t) {\n\t\t\t\tPubSub.publish(\"body.unselect.feature\");\n\t\t\t}\n\t\t\t// Change mode\n\t\t\telse {\n\t\t\t\tif(this.state.mode === Body.MODE_FEATURES) {\n\t\t\t\t\tPubSub.publish(\"body.mode.set\", { mode: Body.MODE_LEVELS });\n\t\t\t\t}\n\t\t\t\telse if(this.state.mode === Body.MODE_LEVELS) {\n\t\t\t\t\tPubSub.publish(\"body.mode.set\", { mode: Body.MODE_BUILDING });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tMousetrap.bind(\"enter\", () => {\n\t\t\t// Drawing mode\n\t\t\tif(this.state.draw) {\n\t\t\t\tPubSub.publish(\"body.draw.stop\");\n\t\t\t}\n\t\t});\n\n\t\t// Undo edits\n\t\tMousetrap.bind(\"ctrl+z\", () => {\n\t\t\tPubSub.publish(\"body.action.undo\");\n\t\t});\n\n\t\t// Redo edits\n\t\tMousetrap.bind(\"ctrl+shift+z\", () => {\n\t\t\tPubSub.publish(\"body.action.redo\");\n\t\t});\n\n\t\t// Delete feature\n\t\tMousetrap.bind(\"del\", () => {\n\t\t\tPubSub.publish(\"body.delete.feature\");\n\t\t});\n\n\t\t// Copy/paste feature\n\t\tMousetrap.bind(\"ctrl+c\", () => {\n\t\t\tPubSub.publish(\"body.copy.feature\");\n\t\t});\n\t\tMousetrap.bind(\"ctrl+v\", () => {\n\t\t\tPubSub.publish(\"body.paste.feature\");\n\t\t});\n\t\tMousetrap.bind(\"ctrl+shift+v\", () => {\n\t\t\tPubSub.publish(\"body.paste.tags\");\n\t\t});\n\n\t\t// Update after locale changes\n\t\tI18n.on(\"change\", locale => {\n\t\t\tthis.forceUpdate();\n\t\t\tconsole.log(\"Loaded locale\", locale);\n\t\t});\n\t}\n\n\tcomponentDidUpdate(prevProps, prevState) {\n\t\tconst newState = {};\n\n\t\tif(this.map) {\n\t\t\t// Alert map that its size have potentially changed\n\t\t\tthis.map.invalidateSize();\n\t\t}\n\n\t\t// Open/close left panel if it changes\n\t\tif(this.state.pane && prevState.pane !== this.state.pane && !this.state.leftPanelOpen) {\n\t\t\tnewState.leftPanelOpen = true;\n\t\t}\n\t\tif(!this.state.pane && prevState.pane !== this.state.pane && this.state.leftPanelOpen) {\n\t\t\tnewState.leftPanelOpen = false;\n\t\t}\n\n\t\t// Fallback modes if info is missing (undo/redo)\n\t\tif([ Body.MODE_FEATURES, Body.MODE_LEVELS ].includes(this.state.mode) && !this.state.building) {\n\t\t\tnewState.mode = Body.MODE_BUILDING;\n\t\t\tnewState.pane = null;\n\t\t\tnewState.leftPanelOpen = false;\n\t\t}\n\n\t\t// Check pane coherence\n\t\tif(this.state.mode === Body.MODE_BUILDING && this.state.pane && this.state.pane !== LeftPanel.PANE_BUILDING_EDIT) {\n\t\t\tnewState.pane = this.state.building ? LeftPanel.PANE_BUILDING_EDIT : null;\n\t\t\tnewState.leftPanelOpen = this.state.building ? true : false;\n\t\t}\n\t\tif(this.state.mode === Body.MODE_LEVELS && this.state.pane && ![LeftPanel.PANE_LEVELS_ADD, LeftPanel.PANE_LEVELS_EDIT].includes(this.state.pane)) {\n\t\t\tnewState.pane = this.state.floor ? LeftPanel.PANE_LEVELS_EDIT : LeftPanel.PANE_LEVELS_ADD;\n\t\t\tnewState.leftPanelOpen = true;\n\t\t}\n\t\tif(this.state.mode === Body.MODE_FEATURES && this.state.pane && ![LeftPanel.PANE_FEATURE_ADD, LeftPanel.PANE_FEATURE_EDIT].includes(this.state.pane)) {\n\t\t\tnewState.pane = this.state.feature ? LeftPanel.PANE_FEATURE_EDIT : LeftPanel.PANE_FEATURE_ADD;\n\t\t\tnewState.leftPanelOpen = true;\n\t\t}\n\n\t\t// Check user status\n\t\tthis._checkUserLoggedIn();\n\n\t\t// Auto-select single floor imagery if only 1 defined\n\t\t// NOTE : should be kept as last check\n\t\tif(this.state.mode === Body.MODE_FLOOR_IMAGERY && window.imageryManager.getFloorImages().length === 1 && !window.imageryManager.getFloorImages()[0].selected) {\n\t\t\twindow.imageryManager._updateSelectedImage();\n\t\t\tif(Object.keys(newState).length === 0) {\n\t\t\t\tthis.forceUpdate();\n\t\t\t}\n\t\t}\n\n\t\t// Finally, update if necessary\n\t\tif(Object.keys(newState).length > 0) {\n\t\t\tthis.setState(newState);\n\t\t}\n\t}\n\n\tcomponentWillUnmount() {\n\t\tPubSub.unsubscribe(\"body.*\");\n\t\tPubSub.unsubscribe(\"map.zoom.changed\");\n\t\tPubSub.unsubscribe(\"app.user.*\");\n\t\tMousetrap.unbind(\"esc\");\n\t\tMousetrap.unbind(\"enter\");\n\t\tMousetrap.unbind(\"del\");\n\t\tMousetrap.unbind(\"ctrl+c\");\n\t\tMousetrap.unbind(\"ctrl+z\");\n\t\tMousetrap.unbind(\"ctrl+v\");\n\t\tMousetrap.unbind(\"ctrl+shift+z\");\n\t\tclearInterval(this._timerImagery);\n\t}\n}\n\nexport default Body;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\n/**\n * An action is what user performs on user interface.\n * It allows to track every single edit done by user.\n * This is useful for undoing/redoing some actions.\n *\n * @property {int} type The kind of action\n * @property {Object} prev The previous data (or null)\n * @property {Object} next The next data (or null)\n */\nclass Action {\n\t/** Type for editing feature tags **/\n\tstatic FEATURE_TAGS_EDIT = 0;\n\t/** Type for editing feature geometry **/\n\tstatic FEATURE_GEOM_EDIT = 1;\n\t/** Type for creating new feature **/\n\tstatic FEATURE_NEW = 2;\n\t/** Type for making feature square **/\n\tstatic FEATURE_GEOM_SQUARE = 11;\n\t/** Type for creating new floor **/\n\tstatic FLOOR_NEW = 3;\n\t/** Type for copying floor **/\n\tstatic FLOOR_COPY = 10;\n\t/** Type for creating new building **/\n\tstatic BUILDING_NEW = 4;\n\t/** Type for deleting feature **/\n\tstatic FEATURE_DELETE = 5;\n\t/** Type for copy feature **/\n\tstatic FEATURE_COPY = 6;\n\t/** Type for adding floor images **/\n\tstatic FLOOR_IMG_ADD = 7;\n\t/** Type for updating floor images **/\n\tstatic FLOOR_IMG_UPDATE = 8;\n\t/** Type for deleting floor images **/\n\tstatic FLOOR_IMG_DELETE = 9;\n\n\t/**\n\t * Class constructor\n\t * @param {int} type The kind of action (use class constants)\n\t * @param {Object} [prev] The previous data, which is edited or replaced by this action\n\t * @param {Object} [next] The new data, replacing the previous one\n\t */\n\tconstructor(type, prev, next) {\n\t\tthis.type = type;\n\t\tthis.prev = prev;\n\t\tthis.next = next;\n\t}\n}\n\nexport default Action;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\n/**\n * Historized manager allows to track actions and undo/redo them.\n * It contains common methods for history management in controllers.\n */\nclass HistorizedManager {\n\tconstructor() {\n\t\tthis._actions = [];\n\t\tthis._lastActionId = -1;\n\t}\n\n\t/**\n\t * Cancel last edit made by user (if any)\n\t */\n\tundo() {\n\t\tthrow new Error(\"Should be overridden by subclass\");\n\t}\n\n\t/**\n\t * Restore last edit made by user (if any)\n\t */\n\tredo() {\n\t\tif(this.canRedo()) {\n\t\t\tconst restore = this._actions[this._lastActionId+1];\n\t\t\tthis._lastActionId++;\n\t\t\tthis._do(restore, true);\n\t\t}\n\t}\n\n\t/**\n\t * Is there any action to undo ?\n\t * @return {boolean} True if some actions can be canceled\n\t */\n\tcanUndo() {\n\t\treturn this._lastActionId > -1;\n\t}\n\n\t/**\n\t * Is there any action to redo ?\n\t * @return {boolean} True if some actions can be restored\n\t */\n\tcanRedo() {\n\t\treturn this._lastActionId < this._actions.length - 1;\n\t}\n\n\t/**\n\t * Get the amount of edits currently taken into account\n\t * @return {int} Amount of edits\n\t */\n\tgetAmountEdits() {\n\t\treturn this._lastActionId + 1;\n\t}\n\n\t/**\n\t * Save an action into stack\n\t */\n\t_do(action, noSave) {\n\t\tthrow new Error(\"Should be overridden by subclass\");\n\t}\n}\n\nexport default HistorizedManager;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport Action from '../model/Action';\nimport booleanIntersects from '@turf/boolean-intersects';\nimport L from 'leaflet';\nimport 'leaflet-geometryutil';\nimport Hash from 'object-hash';\nimport HistorizedManager from './HistorizedManager';\nimport request from 'request-promise-native';\n\nconst LAYERS_URL = \"https://osmlab.github.io/editor-layer-index/imagery.geojson\";\nconst LAYERS_BLACKLIST = [\n\t'osmbe', 'osmfr', 'osm-mapnik-german_style', 'HDM_HOT', 'osm-mapnik-black_and_white', 'osm-mapnik-no_labels',\n\t'OpenStreetMap-turistautak', 'hike_n_bike', 'landsat', 'skobbler', 'public_transport_oepnv', 'tf-cycle',\n\t'tf-landscape', 'qa_no_address', 'wikimedia-map', 'openinframap-petroleum', 'openinframap-power', 'openinframap-telecoms',\n\t'openpt_map', 'openrailwaymap', 'openseamap', 'opensnowmap-overlay', 'US-TIGER-Roads-2012', 'US-TIGER-Roads-2014',\n\t'Waymarked_Trails-Cycling', 'Waymarked_Trails-Hiking', 'Waymarked_Trails-Horse_Riding', 'Waymarked_Trails-MTB',\n\t'Waymarked_Trails-Skating', 'Waymarked_Trails-Winter_Sports', 'OSM_Inspector-Addresses', 'OSM_Inspector-Geometry',\n\t'OSM_Inspector-Highways', 'OSM_Inspector-Multipolygon', 'OSM_Inspector-Places', 'OSM_Inspector-Routing', 'OSM_Inspector-Tagging', 'EsriWorldImagery'\n];\n\n/**\n * Imagery Manager offers a list of available imagery at a certain place for map display.\n * It is based on {@link https://github.com/osmlab/editor-layer-index|Editor Layer Index} library.\n */\nclass ImageryManager extends HistorizedManager {\n\tconstructor() {\n\t\tsuper();\n\t\tthis._rawLayers = null;\n\t\tthis._floorImagery = [];\n\t\tthis._isLoading = false;\n\t}\n\n\t/**\n\t * Get the list of available layers at given coordinates\n\t * @param {LatLng} coordinates The coordinates (map center for example)\n\t * @return {Promise} A promise resolveing on the list of layers available at this place (sorted by pertinence)\n\t */\n\tgetAvailableImagery(coordinates) {\n\t\tif(this._isLoading) {\n\t\t\treturn new Promise(resolve => {\n\t\t\t\tsetTimeout(() => resolve(this.getAvailableImagery(coordinates)), 200);\n\t\t\t});\n\t\t}\n\t\telse if(this._rawLayers) {\n\t\t\tconst location = coordinates ? { type: \"Point\", coordinates: [ coordinates.lng, coordinates.lat ] } : null;\n\n\t\t\treturn new Promise(resolve => resolve(\n\t\t\t\tthis._rawLayers\n\t\t\t\t.filter(layer => location === null || layer.geometry === null || booleanIntersects(layer, location))\n\t\t\t\t.sort((l1, l2) => {\n\t\t\t\t\tconst a = l1.properties;\n\t\t\t\t\tconst b = l2.properties;\n\n\t\t\t\t\tif(a.best && b.best) { return 0; }\n\t\t\t\t\telse if(a.best) { return -1; }\n\t\t\t\t\telse if(b.best) { return 1; }\n\t\t\t\t\telse if(a.default && b.default) { return 0; }\n\t\t\t\t\telse if(a.default) { return -1; }\n\t\t\t\t\telse if(b.default) { return 1; }\n\t\t\t\t\telse { return 0; }\n\t\t\t\t})\n\t\t\t));\n\t\t}\n\t\telse {\n\t\t\t// Load the GeoJSON containing layers data\n\t\t\tthis._isLoading = true;\n\t\t\treturn request(LAYERS_URL)\n\t\t\t.then(result => {\n\t\t\t\tresult = JSON.parse(result);\n\t\t\t\tthis._rawLayers = [];\n\n\t\t\t\t// Check every layer\n\t\t\t\tresult.features.forEach(layer => {\n\t\t\t\t\tconst props = layer.properties;\n\t\t\t\t\tlet valid = true;\n\n\t\t\t\t\tif(LAYERS_BLACKLIST.includes(props.id)) { valid = false; }\n\t\t\t\t\tif(![ \"bing\", \"tms\", \"wms\" ].includes(props.type)) { valid = false; }\n\n\t\t\t\t\tif(props.end_date) {\n\t\t\t\t\t\tconst endDate = new Date(props.end_date);\n\n\t\t\t\t\t\tif(!isNaN(endDate.getTime())) {\n\t\t\t\t\t\t\tconst pastDate = new Date();\n\t\t\t\t\t\t\tpastDate.setFullYear(pastDate.getFullYear() - 10);\n\t\t\t\t\t\t\tif(endDate <= pastDate) { valid = false; }\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Special fix for BdOrtho max zoom\n\t\t\t\t\tif(props.id === \"fr.ign.bdortho\") {\n\t\t\t\t\t\tprops.max_zoom = 19;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Special fix for Mapbox layers\n\t\t\t\t\tif(props.url.includes(\".mapbox.com\")) {\n\t\t\t\t\t\tprops.url = props.url.replace(/access_token=.*$/, \"access_token=pk.eyJ1Ijoib3BlbnN0cmVldG1hcCIsImEiOiJjbGZkenFib3IyazZlNDRwYzd5eWg5Mjl2In0.Gha0ZtI4GZy36s8h8ClbaQ\");\n\t\t\t\t\t}\n\n\t\t\t\t\tif(valid) {\n\t\t\t\t\t\tthis._rawLayers.push(layer);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tthis._isLoading = false;\n\n\t\t\t\treturn this.getAvailableImagery(coordinates);\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Get the floor images\n\t * @return {Object[]} The floor images collection\n\t */\n\tgetFloorImages() {\n\t\treturn this._floorImagery;\n\t}\n\n\t/**\n\t * Add new images in floor imagery collection\n\t * @param {Object[]} incomingImages List of images to add to collection\n\t * @param {LatLngBounds} bbox Current map bounding box\n\t * @param {Object} map The map component\n\t * @return {Promise} Promise solving on updated collection\n\t */\n\taddFloorImagery(incomingImages, bbox, map) {\n\t\treturn this._do(new Action(Action.FLOOR_IMG_ADD, null, arguments));\n\t}\n\n\t/**\n\t * Raw floor images insert\n\t * @private\n\t */\n\tasync _addFloorImagery(incomingImages, bbox, map) {\n\t\tthis._floorImagery = this._floorImagery.map(img => {\n\t\t\timg.selected = false;\n\t\t\treturn img;\n\t\t});\n\t\tconst existingIds = this._floorImagery.map(img => img.id);\n\t\tconst lastExistingImg = this._floorImagery.length > 0 ? this._floorImagery[this._floorImagery.length-1] : null;\n\t\tif(bbox) { bbox = bbox.pad(-0.3); }\n\n\t\treturn Promise.all(incomingImages.map(img => (new Promise(resolve => {\n\t\t\t// Set identifier\n\t\t\tif(!img.id) {\n\t\t\t\timg.id = Hash(img.image);\n\t\t\t}\n\n\t\t\tif(img.visible === undefined) {\n\t\t\t\timg.visible = true;\n\t\t\t}\n\n\t\t\tif(!existingIds.includes(img.id)) {\n\t\t\t\tconst onceDone = (approxMove) => {\n\t\t\t\t\tthis._floorImagery.push(img);\n\t\t\t\t\texistingIds.push(img.id);\n\t\t\t\t\tresolve();\n\n\t\t\t\t\tif(approxMove) {\n\t\t\t\t\t\tthis.moveFloorImagery(map, lastExistingImg, img);\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\t// Add default coordinates to imagery if necessary\n\t\t\t\tif(!img.topleft) {\n\t\t\t\t\t// Put at center of map\n\t\t\t\t\tif(bbox) {\n\t\t\t\t\t\tlet approxMove = false;\n\n\t\t\t\t\t\t// Compute size of image\n\t\t\t\t\t\tconst imgobj = new Image();\n\t\t\t\t\t\timgobj.src = img.image;\n\t\t\t\t\t\timgobj.onload = () => {\n\t\t\t\t\t\t\t// Reuse previous imagery if any\n\t\t\t\t\t\t\tif(lastExistingImg && lastExistingImg.origWidth === imgobj.width && lastExistingImg.origHeight === imgobj.height) {\n\t\t\t\t\t\t\t\timg.topleft = lastExistingImg.topleft;\n\t\t\t\t\t\t\t\timg.topright = lastExistingImg.topright;\n\t\t\t\t\t\t\t\timg.bottomleft = lastExistingImg.bottomleft;\n\t\t\t\t\t\t\t\timg.bottomright = lastExistingImg.bottomright;\n\t\t\t\t\t\t\t\timg.origWidth = lastExistingImg.origWidth;\n\t\t\t\t\t\t\t\timg.origHeight = lastExistingImg.origHeight;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// Or put image on center of map if no previous images\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tconst centerPoint = map.latLngToContainerPoint(bbox.getCenter());\n\t\t\t\t\t\t\t\tconst nePoint = map.latLngToContainerPoint(bbox.getNorthEast());\n\t\t\t\t\t\t\t\tconst swPoint = map.latLngToContainerPoint(bbox.getSouthWest());\n\t\t\t\t\t\t\t\tconst bboxHeightPx = nePoint.y - swPoint.y;\n\t\t\t\t\t\t\t\tconst imgWidthPx = imgobj.width * bboxHeightPx / imgobj.height;\n\t\t\t\t\t\t\t\tconst imgSouthWest = map.containerPointToLatLng([ centerPoint.x + Math.round(imgWidthPx/2), swPoint.y ]);\n\t\t\t\t\t\t\t\tconst imgNorthEast = map.containerPointToLatLng([ centerPoint.x - Math.round(imgWidthPx/2), nePoint.y ]);\n\n\t\t\t\t\t\t\t\timg.topleft = [ imgNorthEast.lat, imgSouthWest.lng ];\n\t\t\t\t\t\t\t\timg.topright = imgNorthEast;\n\t\t\t\t\t\t\t\timg.bottomleft = imgSouthWest;\n\t\t\t\t\t\t\t\timg.bottomright = [ imgSouthWest.lat, imgNorthEast.lng ];\n\t\t\t\t\t\t\t\timg.origWidth = imgobj.width;\n\t\t\t\t\t\t\t\timg.origHeight = imgobj.height;\n\n\t\t\t\t\t\t\t\t// Reuse last positioned image coordinates as an approximation\n\t\t\t\t\t\t\t\tif(map && lastExistingImg) {\n\t\t\t\t\t\t\t\t\tapproxMove = true;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tonceDone(approxMove);\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tonceDone();\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tresolve();\n\t\t\t}\n\t\t}))))\n\t\t.then(() => {\n\t\t\tthis._updateSelectedImage();\n\t\t\treturn this._floorImagery;\n\t\t});\n\t}\n\n\t/**\n\t * Changes existing configuration of floor imagery\n\t * @param {Object[]} updatedImages The images to change\n\t * @return {Object[]} The whole updated collection\n\t */\n\tupdateFloorImagery(updatedImages) {\n\t\treturn this._do(new Action(Action.FLOOR_IMG_UPDATE, this._floorImagery, arguments));\n\t}\n\n\t/**\n\t * Raw floor images update\n\t * @private\n\t */\n\t_updateFloorImagery(updatedImages) {\n\t\tconst imgs = {};\n\t\tupdatedImages.forEach(d => { imgs[d.id] = d; });\n\n\t\tthis._floorImagery = this._floorImagery.map(f => {\n\t\t\treturn (imgs[f.id]) ? imgs[f.id] : f;\n\t\t});\n\n\t\t// Check if there are several images being edited\n\t\tconst edits = this._floorImagery.filter(img => img.selected);\n\t\tif(edits.length > 1) {\n\t\t\tthis._floorImagery = this._floorImagery.map(img => {\n\t\t\t\timg.selected = false;\n\t\t\t\treturn img;\n\t\t\t});\n\t\t\tthis._updateSelectedImage();\n\t\t}\n\n\t\treturn this._floorImagery;\n\t}\n\n\t/**\n\t * Moves currently selected image to a given destination (used for copy/paste)\n\t * @param {Object} map The Leaflet map\n\t * @param {Object} destination Coordinates of corners that should be used\n\t * @param {Object} [image] Imagery to use (by default currently selected one)\n\t */\n\tmoveFloorImagery(map, destination, image) {\n\t\tconst selected = image || this._floorImagery.find(img => img.selected && img.visible);\n\n\t\tif(selected && destination) {\n\t\t\tconst updated = Object.assign({}, selected);\n\n\t\t\t// Same ratio\n\t\t\tif((selected.origWidth / selected.origHeight) === (destination.origWidth / destination.origHeight)) {\n\t\t\t\tupdated.topleft = destination.topleft;\n\t\t\t\tupdated.topright = destination.topright;\n\t\t\t\tupdated.bottomleft = destination.bottomleft;\n\t\t\t\tupdated.bottomright = destination.bottomright;\n\t\t\t}\n\t\t\t// Different ratio\n\t\t\telse if(map) {\n\t\t\t\t// Move selected image to same center as destination\n\t\t\t\tconst selectedCenter = L.latLngBounds(selected.bottomright, selected.topleft).getCenter();\n\t\t\t\tconst destinationCenter = L.latLngBounds(destination.bottomright, destination.topleft).getCenter();\n\t\t\t\tconst angleCenters = L.GeometryUtil.bearing(selectedCenter, destinationCenter);\n\t\t\t\tconst distanceCenters = selectedCenter.distanceTo(destinationCenter);\n\n\t\t\t\tconst updtNotRotatedTopleft = L.GeometryUtil.destination(L.latLng(selected.topleft), angleCenters, distanceCenters);\n\t\t\t\tconst updtNotRotatedTopright = L.GeometryUtil.destination(L.latLng(selected.topright), angleCenters, distanceCenters);\n\t\t\t\tconst updtNotRotatedBottomleft = L.GeometryUtil.destination(L.latLng(selected.bottomleft), angleCenters, distanceCenters);\n\t\t\t\tconst updtNotRotatedBottomright = L.GeometryUtil.destination(L.latLng(selected.bottomright), angleCenters, distanceCenters);\n\n\t\t\t\t// Rotate selected image\n\t\t\t\tconst destinationTopcenter = L.latLngBounds(destination.topleft, destination.topright).getCenter();\n\t\t\t\tconst updtNotRotatedTopcenter = L.latLngBounds(updtNotRotatedTopleft, updtNotRotatedTopright).getCenter();\n\t\t\t\tconst distanceDestCenterTop = destinationTopcenter.distanceTo(destinationCenter);\n\t\t\t\tconst distanceUpdtCenterTop = updtNotRotatedTopcenter.distanceTo(destinationCenter);\n\t\t\t\tconst angle = L.GeometryUtil.bearing(destinationCenter, destinationTopcenter) - L.GeometryUtil.bearing(destinationCenter, updtNotRotatedTopcenter);\n\n\t\t\t\tconst updtRotatedTopleft = L.GeometryUtil.rotatePoint(map, updtNotRotatedTopleft, angle, destinationCenter);\n\t\t\t\tconst updtRotatedTopright = L.GeometryUtil.rotatePoint(map, updtNotRotatedTopright, angle, destinationCenter);\n\t\t\t\tconst updtRotatedBottomleft = L.GeometryUtil.rotatePoint(map, updtNotRotatedBottomleft, angle, destinationCenter);\n\t\t\t\tconst updtRotatedBottomright = L.GeometryUtil.rotatePoint(map, updtNotRotatedBottomright, angle, destinationCenter);\n\n\t\t\t\t// Scale selected image\n\t\t\t\tconst scale = distanceDestCenterTop / distanceUpdtCenterTop;\n\t\t\t\tconst updtTopleft = L.GeometryUtil.destination(destinationCenter, L.GeometryUtil.bearing(destinationCenter, updtRotatedTopleft), destinationCenter.distanceTo(updtRotatedTopleft) * scale);\n\t\t\t\tconst updtTopright = L.GeometryUtil.destination(destinationCenter, L.GeometryUtil.bearing(destinationCenter, updtRotatedTopright), destinationCenter.distanceTo(updtRotatedTopright) * scale);\n\t\t\t\tconst updtBottomleft = L.GeometryUtil.destination(destinationCenter, L.GeometryUtil.bearing(destinationCenter, updtRotatedBottomleft), destinationCenter.distanceTo(updtRotatedBottomleft) * scale);\n\t\t\t\tconst updtBottomright = L.GeometryUtil.destination(destinationCenter, L.GeometryUtil.bearing(destinationCenter, updtRotatedBottomright), destinationCenter.distanceTo(updtRotatedBottomright) * scale);\n\n\t\t\t\t// Save computed coordinates\n\t\t\t\tupdated.topleft = updtTopleft;\n\t\t\t\tupdated.topright = updtTopright;\n\t\t\t\tupdated.bottomleft = updtBottomleft;\n\t\t\t\tupdated.bottomright = updtBottomright;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tconsole.error(\"Can't paste position on this floor plan\");\n\t\t\t}\n\n\t\t\treturn this.updateFloorImagery([ updated ]);\n\t\t}\n\t}\n\n\t/**\n\t * Makes all floor plans not editable\n\t * @return {Object[]} The whole updated collection\n\t */\n\tlockFloorImagery() {\n\t\tthis._floorImagery = this._floorImagery.map(f => {\n\t\t\tf.selected = false;\n\t\t\treturn f;\n\t\t});\n\t\treturn this._floorImagery;\n\t}\n\n\t/**\n\t * Remove some floor imagery from collection\n\t * @param {string} [id] The image ID, if null clears the whole collection\n\t * @return {Object[]} The updated collection\n\t */\n\tremoveFloorImagery(id){\n\t\treturn this._do(new Action(Action.FLOOR_IMG_DELETE, this._floorImagery.filter(f => f.id === id), arguments));\n\t}\n\n\t/**\n\t * Raw floor images deletion\n\t * @private\n\t */\n\t_removeFloorImagery(id) {\n\t\tif(id) {\n\t\t\tthis._floorImagery = this._floorImagery.filter(f => f.id !== id);\n\t\t\tthis._updateSelectedImage();\n\t\t}\n\t\telse {\n\t\t\tthis._floorImagery = [];\n\t\t}\n\t\treturn this._floorImagery;\n\t}\n\n\t_updateSelectedImage() {\n\t\tif(this._floorImagery.length > 0 && !this._floorImagery.find(f => f.selected)) {\n\t\t\tthis._floorImagery[this._floorImagery.length-1].selected = true;\n\t\t}\n\t}\n\n\t/**\n\t * Cancel last edit made by user (if any)\n\t */\n\tundo() {\n\t\tif(this.canUndo()) {\n\t\t\tconst revert = this._actions[this._lastActionId];\n\t\t\tthis._lastActionId--;\n\n\t\t\tswitch(revert.type) {\n\t\t\t\tcase Action.FLOOR_IMG_ADD:\n\t\t\t\t\tif(revert.next[0]) {\n\t\t\t\t\t\trevert.next[0].forEach(img => {\n\t\t\t\t\t\t\tconst id = img.id || Hash(img.image);\n\t\t\t\t\t\t\tthis._removeFloorImagery(id);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tthis._removeFloorImagery();\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase Action.FLOOR_IMG_UPDATE:\n\t\t\t\t\tthis._floorImagery = revert.prev;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase Action.FLOOR_IMG_DELETE:\n\t\t\t\t\tthis._addFloorImagery(revert.prev);\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Save an action into stack\n\t * @private\n\t */\n\t_do(action, noSave) {\n\t\t// Check if not updating only editing state\n\t\tif(!noSave && action.type === Action.FLOOR_IMG_UPDATE) {\n\t\t\tconst edits = action.next[0].filter(nextImg => {\n\t\t\t\tconst currImg = this._floorImagery.find(img => img.id === nextImg.id);\n\t\t\t\treturn !currImg\n\t\t\t\t\t|| currImg.topleft !== nextImg.topleft\n\t\t\t\t\t|| currImg.topright !== nextImg.topright\n\t\t\t\t\t|| currImg.bottomleft !== nextImg.bottomleft\n\t\t\t\t\t|| currImg.bottomright !== nextImg.bottomright\n\t\t\t\t\t|| currImg.level !== nextImg.level;\n\t\t\t});\n\t\t\tif(edits.length === 0) {\n\t\t\t\tnoSave = true;\n\t\t\t}\n\t\t}\n\n\t\tif(!noSave) {\n\t\t\t// Discard next actions, as they will be overwritten by new one\n\t\t\tif(this._actions.length > this._lastActionId + 1) {\n\t\t\t\tthis._actions = this._actions.slice(0, this._lastActionId+1);\n\t\t\t}\n\n\t\t\t// Save this action\n\t\t\tthis._actions.push(action);\n\t\t\tthis._lastActionId++;\n\t\t}\n\n\t\t// Perform the actual action\n\t\tswitch(action.type) {\n\t\t\tcase Action.FLOOR_IMG_ADD:\n\t\t\t\treturn this._addFloorImagery(...action.next);\n\n\t\t\tcase Action.FLOOR_IMG_UPDATE:\n\t\t\t\treturn this._updateFloorImagery(...action.next);\n\n\t\t\tcase Action.FLOOR_IMG_DELETE:\n\t\t\t\treturn this._removeFloorImagery(...action.next);\n\n\t\t\tdefault:\n\t\t\t\treturn null;\n\t\t}\n\t}\n}\n\nexport default ImageryManager;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport deepEqual from 'fast-deep-equal';\n\n/**\n * Simple object check.\n * @private\n */\nconst _isObject = (item) => {\n\treturn (item && typeof item === 'object' && !Array.isArray(item));\n};\n\n/**\n * Deep merge two objects.\n */\nconst mergeDeep = (target, ...sources) => {\n\tif (!sources.length) return target;\n\tconst source = sources.shift();\n\n\tif (_isObject(target) && _isObject(source)) {\n\t\tfor (const key in source) {\n\t\t\tif (_isObject(source[key])) {\n\t\t\t\tif (!target[key]) Object.assign(target, { [key]: {} });\n\t\t\t\tmergeDeep(target[key], source[key]);\n\t\t\t}\n\t\t\telse if(Array.isArray(source[key]) && Array.isArray(target[key])) {\n\t\t\t\ttarget[key] = target[key].concat(source[key]);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tObject.assign(target, { [key]: source[key] });\n\t\t\t}\n\t\t}\n\t}\n\n\treturn mergeDeep(target, ...sources);\n};\n\n/**\n * Return array of coordinates with a precision of 8 digits (OSM)\n */\nconst fixPrecision = coords => coords.map(c => {\n\tif(typeof c === \"string\") { c = parseFloat(c); }\n\treturn parseFloat(c.toFixed(8));\n});\n\n/**\n * List of common elements between two arrays (intersection)\n */\nconst intersectionArray = function(arrA, arrB) {\n\tconst common = [];\n\tconst minimal = arrA.length < arrB.length ? arrA : arrB;\n\tconst other = arrA.length < arrB.length ? arrB : arrA;\n\n\tminimal.forEach(el => {\n\t\tif(other.find(el2 => deepEqual(el, el2)) && !common.find(el2 => deepEqual(el, el2))) {\n\t\t\tcommon.push(el);\n\t\t}\n\t});\n\n\treturn common;\n}\n\nexport { mergeDeep, fixPrecision, intersectionArray };\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport request from 'request-promise-native';\nimport { parseString } from 'xml2js';\nimport { mergeDeep } from '../utils';\nimport Fuse from 'fuse.js';\nimport I18n from '../config/locales/ui';\n\n/**\n * Presets manager handles loading, listing and filtering of presets for OSM features.\n */\nclass PresetsManager {\n\tconstructor() {\n\t\tthis._presetsURL = [ './presets/indoor.xml', './presets/default.xml' ];\n\t\tthis._presets = null;\n\t\tthis._loading = false;\n\t}\n\n\t/**\n\t * Make preset data available in memory.\n\t */\n\tloadPresets() {\n\t\tthis._loading = true;\n\n\t\t// Download presets XML files using promises\n\t\tconst loaders = Promise.all(\n\t\t\tthis._presetsURL.map(filepath => {\n\t\t\t\treturn request(window.EDITOR_URL + filepath)                     // Download\n\t\t\t\t.then(this._xmlToJson)                                           // Convert XML into raw JSON\n\t\t\t\t.then(xml => this._simplifyJSONPreset(xml.presets, \"presets\"))   // Clean JSON\n\t\t\t\t.catch(() => null);\n\t\t\t})\n\t\t);\n\n\t\t// Once everything is downloaded\n\t\tloaders.then(presets => {\n\t\t\t// Merge all presets into a single one\n\t\t\tthis._presets = mergeDeep({}, ...presets.filter(p => p !== null));\n\n\t\t\t/*\n\t\t\t * Generate search index\n\t\t\t */\n\n\t\t\t// Generate flat list of items\n\t\t\tconst getItems = item => {\n\t\t\t\tlet matches = [];\n\n\t\t\t\tif(item.items) {\n\t\t\t\t\tmatches = matches.concat(item.items.map(it => {\n\t\t\t\t\t\tif(it.tags) {\n\t\t\t\t\t\t\tit.kv = Object.entries(it.tags).flat().map(v => v.replace(/_/g, \" \"));\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn it;\n\t\t\t\t\t}));\n\t\t\t\t}\n\n\t\t\t\tif(item.groups) {\n\t\t\t\t\tmatches = matches.concat(item.groups.map(it => getItems(it)).flat());\n\t\t\t\t}\n\n\t\t\t\treturn matches;\n\t\t\t};\n\n\t\t\t// Set options for search\n\t\t\tthis._searcher = new Fuse(\n\t\t\t\tgetItems(this._presets),\n\t\t\t\t{\n\t\t\t\t\tshouldSort: true,\n\t\t\t\t\tthreshold: 0.4,\n\t\t\t\t\tmaxPatternLength: 32,\n\t\t\t\t\tminMatchCharLength: 3,\n\t\t\t\t\tkeys: [\n\t\t\t\t\t\t{ name: \"name\", weight: 0.7 },\n\t\t\t\t\t\t{ name: \"kv\", weight: 0.3 }\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t);\n\n\t\t\t// Set loading done\n\t\t\tthis._loading = false;\n\t\t});\n\t}\n\n\t/**\n\t * Get the list of available presets\n\t * @param {string} path The access path (list of groups separated by /, example \"/root/highways/unpaved\")\n\t * @param {function} [filter] Function filtering presets\n\t * @return {Object[]} The presets, possibly organised by groups\n\t */\n\tgetPresets(path, filter) {\n\t\tif(this._presets) {\n\t\t\tlet result;\n\n\t\t\tif(path === \"/\") {\n\t\t\t\tresult = this._presets;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tconst entries = path.split(\"/\").filter(p => p !== \"\");\n\t\t\t\tlet last = this._presets;\n\n\t\t\t\t// Look up each entry in path\n\t\t\t\tfor(let e of entries) {\n\t\t\t\t\tlet sub = (last.groups && last.items) ? last.groups.concat(last.items) : (last.items ? last.items : last.groups);\n\t\t\t\t\tsub = sub.filter(g => g.name === e);\n\n\t\t\t\t\tif(sub.length === 1) {\n\t\t\t\t\t\tlast = sub[0];\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tlast = null;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tresult = last;\n\t\t\t}\n\n\t\t\treturn this._applyFiltering(result, filter);\n\t\t}\n\t\telse {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Search for presets by text.\n\t * @param {string} text The search text\n\t * @param {function} [filter] Function filtering presets\n\t * @return {Object[]} List of matching presets\n\t */\n\tfindPresetsByName(text, filter) {\n\t\tif(!text || text.trim().length === 0) {\n\t\t\treturn null;\n\t\t}\n\t\telse if(this._presets) {\n\t\t\tconst res = this._searcher.search(text);\n\t\t\treturn this._applyFiltering({ items: res }, filter);\n\t\t}\n\t\telse {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * @private\n\t */\n\t_applyFiltering(presets, filter) {\n\t\t// Filter presets if necessary\n\t\tif(presets && filter) {\n\t\t\t// Function to process one preset/group at a time\n\t\t\tconst recursiveFilter = g => {\n\t\t\t\tlet res = Object.assign({}, g);\n\n\t\t\t\t// Filter list of items\n\t\t\t\tif(g.items) { res.items = g.items.filter(filter); }\n\n\t\t\t\t// Filter list of groups (recursively)\n\t\t\t\tif(g.groups) { res.groups = g.groups.map(gr => recursiveFilter(gr)).filter(g => g !== null); }\n\n\t\t\t\t// If empty list of groups and items, send null\n\t\t\t\tif((!res.groups || res.groups.length === 0) && (!res.items || res.items.length === 0)) { res = null; }\n\n\t\t\t\t// If entry has a single group and no items, just send the group itself\n\t\t\t\tif(res && res.groups && res.groups.length === 1 && (!res.items || res.items.length === 0)) { res = res.groups[0]; }\n\n\t\t\t\treturn res;\n\t\t\t};\n\n\t\t\tpresets = recursiveFilter(presets);\n\t\t}\n\n\t\treturn presets;\n\t}\n\n\t/**\n\t * Search presets available for given feature\n\t * @param {Object} feature The feature to use\n\t * @return {Object[]} List of matching presets\n\t */\n\tfindPresetsForFeature(feature) {\n\t\tif(this._presets) {\n\t\t\tconst matches = [];\n\t\t\tconst fTags = feature.properties.tags;\n\n\t\t\t// Recursive function for checking one preset at a time\n\t\t\tconst check = preset => {\n\t\t\t\tif(preset.groups) {\n\t\t\t\t\tpreset.groups.forEach(check);\n\t\t\t\t}\n\t\t\t\tif(preset.items) {\n\t\t\t\t\tpreset.items\n\t\t\t\t\t.filter(item => item.tags)\n\t\t\t\t\t.forEach(item => {\n\t\t\t\t\t\tlet valid = true;\n\n\t\t\t\t\t\tfor(const k in item.tags) {\n\t\t\t\t\t\t\tif(item.tagMatch[k] !== \"none\" && fTags[k] !== item.tags[k]) {\n\t\t\t\t\t\t\t\tif(fTags[k] === undefined || item.tagMatch[k] !== \"key\") {\n\t\t\t\t\t\t\t\t\tvalid = false;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif(valid) {\n\t\t\t\t\t\t\tmatches.push(item);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tcheck(this._presets);\n\t\t\treturn matches;\n\t\t}\n\t\telse {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Make JSON preset more easily readable\n\t * @private\n\t */\n\t_simplifyJSONPreset(p, type) {\n\t\tlet res = {};\n\n\t\t// Convert various fields as simpler arrays\n\t\tconst transformArray = (variable, types) => {\n\t\t\tif(types.includes(type) && p[variable]) {\n\t\t\t\tres[variable+\"s\"] = p[variable].map(obj => this._simplifyJSONPreset(obj, variable));\n\t\t\t}\n\t\t};\n\n\t\t// Optionals\n\t\tif([ \"item\", \"chunk\" ].includes(type) && p.optional) {\n\t\t\tres.optionals = mergeDeep({}, ...p.optional.map(obj => this._simplifyJSONPreset(obj, \"optional\")));\n\t\t}\n\n\t\t// Checkgroups\n\t\tif(p.checkgroup) {\n\t\t\tp.check = (p.check || []);\n\t\t\tp.checkgroup.forEach(cg => {\n\t\t\t\tp.check = p.check.concat(cg.check);\n\t\t\t});\n\t\t}\n\n\t\ttransformArray(\"group\",       [ \"presets\", \"group\" ]);\n\t\ttransformArray(\"item\",        [ \"group\" ]);\n\t\ttransformArray(\"link\",        [ \"item\", \"chunk\", \"optional\" ]);\n\t\ttransformArray(\"text\",        [ \"item\", \"chunk\", \"optional\" ]);\n\t\ttransformArray(\"combo\",       [ \"item\", \"chunk\", \"optional\" ]);\n\t\ttransformArray(\"reference\",   [ \"item\", \"chunk\", \"optional\" ]);\n\t\ttransformArray(\"multiselect\", [ \"item\", \"chunk\", \"optional\" ]);\n\t\ttransformArray(\"list_entry\",  [ \"combo\", \"multiselect\" ]);\n\t\ttransformArray(\"check\", [ \"item\", \"chunk\", \"optional\" ]);\n\n\t\t// Chunks\n\t\tif(type === \"presets\" && p.chunk) {\n\t\t\tconst chunks = {};\n\t\t\tp.chunk.map(c => this._simplifyJSONPreset(c, \"chunk\")).forEach(c => { chunks[c.id] = c; });\n\t\t\tres.chunks = chunks;\n\t\t}\n\n\t\t// Keys\n\t\tif([ \"item\", \"chunk\", \"optional\" ].includes(type) && p.key) {\n\t\t\tconst tags = {};\n\t\t\tconst tagMatch = {};\n\t\t\tp.key.map(k => this._simplifyJSONPreset(k, \"key\")).forEach(t => {\n\t\t\t\ttags[t.key] = t.value;\n\t\t\t\tif(t.match && t.match !== \"keyvalue\") {\n\t\t\t\t\ttagMatch[t.key] = t.match;\n\t\t\t\t}\n\t\t\t});\n\t\t\tres.tags = tags;\n\t\t\tres.tagMatch = tagMatch;\n\t\t}\n\n\t\t// Copy properties\n\t\t[\n\t\t\t\"icon\", \"name\", \"key\", \"value\", \"type\", \"wiki\", \"id\", \"ref\", \"href\",\n\t\t\t\"text\", \"default\", \"use_last_as_default\", \"auto_increment\", \"length\",\n\t\t\t\"alternative_autocomplete_keys\", \"match\", \"values\", \"editable\", \"delimiter\", \"indoor_structure\",\n\t\t\t\"values_from\", \"display_values\", \"short_descriptions\", \"values_searchable\", \"use_last_as_default\",\n\t\t\t\"values_no_i18n\", \"values_sort\", \"rows\", \"short_description\", \"icon_size\", \"display_value\"\n\t\t].forEach(prop => {\n\t\t\tif(p.$ && p.$[prop]) { res[prop] = p.$[prop]; }\n\t\t});\n\n\t\t// Replace some properties by their translation (if available)\n\t\tif(\n\t\t\tI18n.locale && I18n.locale !== \"en\"\n\t\t\t&& [ \"group\", \"item\", \"label\", \"text\", \"combo\", \"multiselect\", \"list_entry\", \"check\" ].includes(type)\n\t\t) {\n\t\t\tconst i18nFields = [ \"name\", \"text\", \"display_values\", \"display_value\" ];\n\n\t\t\ti18nFields.forEach(field => {\n\t\t\t\tif(p.$[I18n.locale+\".\"+field]) {\n\t\t\t\t\tres[field] = p.$[I18n.locale+\".\"+field];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Object types\n\t\tif(res.type) {\n\t\t\tres.type = res.type.split(\",\");\n\t\t}\n\n\t\t// Replace references by actual style\n\t\tif(type === \"presets\" && res.chunks) {\n\t\t\tconst replaceByChunk = (entry) => {\n\t\t\t\t[ \"groups\", \"items\" ].forEach(v => {\n\t\t\t\t\tif(entry[v]) {\n\t\t\t\t\t\tentry[v] = entry[v].map(replaceByChunk);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tif(entry.optionals) {\n\t\t\t\t\tentry.optionals = replaceByChunk(entry.optionals);\n\t\t\t\t}\n\n\t\t\t\tif(entry.references) {\n\t\t\t\t\tentry = mergeDeep({}, entry, ...entry.references.map(r => res.chunks[r.ref]));\n\t\t\t\t\tdelete entry.references;\n\t\t\t\t}\n\t\t\t\treturn entry;\n\t\t\t};\n\n\t\t\tres = replaceByChunk(res);\n\t\t}\n\n\t\treturn res;\n\t}\n\n\t/**\n\t * Convert XML into JSON\n\t * @private\n\t */\n\t_xmlToJson(xml) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tparseString(xml, (err, result) => {\n\t\t\t\tif (err) { reject(err); }\n\t\t\t\telse { resolve(result); }\n\t\t\t});\n\t\t});\n\t}\n}\n\nexport default PresetsManager;\n","/*\r\n * Vector utility functions\r\n * Based on iD implementation\r\n * @see https://github.com/openstreetmap/iD/blob/master/modules/geo/vector.js\r\n */\r\n\r\n// vector equals\r\nexport function geoVecEqual(a, b, epsilon) {\r\n\tif (epsilon) {\r\n\t\treturn (Math.abs(a[0] - b[0]) <= epsilon) && (Math.abs(a[1] - b[1]) <= epsilon);\r\n\t} else {\r\n\t\treturn (a[0] === b[0]) && (a[1] === b[1]);\r\n\t}\r\n}\r\n\r\n// vector addition\r\nexport function geoVecAdd(a, b) {\r\n\treturn [ a[0] + b[0], a[1] + b[1] ];\r\n}\r\n\r\n// vector subtraction\r\nexport function geoVecSubtract(a, b) {\r\n\treturn [ a[0] - b[0], a[1] - b[1] ];\r\n}\r\n\r\n// vector scaling\r\nexport function geoVecScale(a, mag) {\r\n\treturn [ a[0] * mag, a[1] * mag ];\r\n}\r\n\r\n// linear interpolation\r\nexport function geoVecInterp(a, b, t) {\r\n\treturn [\r\n\t\ta[0] + (b[0] - a[0]) * t,\r\n\t\ta[1] + (b[1] - a[1]) * t\r\n\t];\r\n}\r\n\r\n// http://jsperf.com/id-dist-optimization\r\nexport function geoVecLength(a, b) {\r\n\tb = b || [0, 0];\r\n\tvar x = a[0] - b[0];\r\n\tvar y = a[1] - b[1];\r\n\treturn Math.sqrt((x * x) + (y * y));\r\n}\r\n\r\n// get a unit vector\r\nexport function geoVecNormalize(a) {\r\n\tvar length = Math.sqrt((a[0] * a[0]) + (a[1] * a[1]));\r\n\tif (length !== 0) {\r\n\t\treturn geoVecScale(a, 1 / length);\r\n\t}\r\n\treturn [0, 0];\r\n}\r\n\r\n// dot product\r\nexport function geoVecDot(a, b, origin) {\r\n\torigin = origin || [0, 0];\r\n\tvar p = geoVecSubtract(a, origin);\r\n\tvar q = geoVecSubtract(b, origin);\r\n\treturn (p[0]) * (q[0]) + (p[1]) * (q[1]);\r\n}\r\n\r\n// normalized dot product\r\nexport function geoVecNormalizedDot(a, b, origin) {\r\n\torigin = origin || [0, 0];\r\n\tvar p = geoVecNormalize(geoVecSubtract(a, origin));\r\n\tvar q = geoVecNormalize(geoVecSubtract(b, origin));\r\n\treturn geoVecDot(p, q);\r\n}\r\n\r\n// find closest orthogonal projection of point onto points array\r\nexport function geoVecProject(a, points) {\r\n\tvar min = Infinity;\r\n\tvar idx;\r\n\tvar target;\r\n\r\n\tfor (var i = 0; i < points.length - 1; i++) {\r\n\t\tvar o = points[i];\r\n\t\tvar s = geoVecSubtract(points[i + 1], o);\r\n\t\tvar v = geoVecSubtract(a, o);\r\n\t\tvar proj = geoVecDot(v, s) / geoVecDot(s, s);\r\n\t\tvar p;\r\n\r\n\t\tif (proj < 0) {\r\n\t\t\tp = o;\r\n\t\t} else if (proj > 1) {\r\n\t\t\tp = points[i + 1];\r\n\t\t} else {\r\n\t\t\tp = [o[0] + proj * s[0], o[1] + proj * s[1]];\r\n\t\t}\r\n\r\n\t\tvar dist = geoVecLength(p, a);\r\n\t\tif (dist < min) {\r\n\t\t\tmin = dist;\r\n\t\t\tidx = i + 1;\r\n\t\t\ttarget = p;\r\n\t\t}\r\n\t}\r\n\r\n\tif (idx !== undefined) {\r\n\t\treturn { index: idx, distance: min, target: target };\r\n\t} else {\r\n\t\treturn null;\r\n\t}\r\n}\r\n\r\n","import { geoVecEqual, geoVecNormalizedDot } from './vector';\r\n\r\n/*\r\n * Ortho utility functions\r\n * Based on iD implementation\r\n * @see https://github.com/openstreetmap/iD/blob/master/modules/geo/ortho.js\r\n */\r\n\r\n\r\nexport function geoOrthoNormalizedDotProduct(a, b, origin) {\r\n\tif (geoVecEqual(origin, a) || geoVecEqual(origin, b)) {\r\n\t\treturn 1;  // coincident points, treat as straight and try to remove\r\n\t}\r\n\treturn geoVecNormalizedDot(a, b, origin);\r\n}\r\n\r\n\r\nfunction geoOrthoFilterDotProduct(dotp, epsilon, lowerThreshold, upperThreshold, allowStraightAngles) {\r\n\tvar val = Math.abs(dotp);\r\n\tif (val < epsilon) {\r\n\t\treturn 0;      // already orthogonal\r\n\t} else if (allowStraightAngles && Math.abs(val-1) < epsilon) {\r\n\t\treturn 0;      // straight angle, which is okay in this case\r\n\t} else if (val < lowerThreshold || val > upperThreshold) {\r\n\t\treturn dotp;   // can be adjusted\r\n\t} else {\r\n\t\treturn null;   // ignore vertex\r\n\t}\r\n}\r\n\r\n\r\nexport function geoOrthoCalcScore(points, isClosed, epsilon, threshold) {\r\n\tvar score = 0;\r\n\tvar first = isClosed ? 0 : 1;\r\n\tvar last = isClosed ? points.length : points.length - 1;\r\n\tvar coords = points.map(function(p) { return p.coord; });\r\n\r\n\tvar lowerThreshold = Math.cos((90 - threshold) * Math.PI / 180);\r\n\tvar upperThreshold = Math.cos(threshold * Math.PI / 180);\r\n\r\n\tfor (var i = first; i < last; i++) {\r\n\t\tvar a = coords[(i - 1 + coords.length) % coords.length];\r\n\t\tvar origin = coords[i];\r\n\t\tvar b = coords[(i + 1) % coords.length];\r\n\r\n\t\tvar dotp = geoOrthoFilterDotProduct(geoOrthoNormalizedDotProduct(a, b, origin), epsilon, lowerThreshold, upperThreshold);\r\n\t\tif (dotp === null) continue;    // ignore vertex\r\n\t\tscore = score + 2.0 * Math.min(Math.abs(dotp - 1.0), Math.min(Math.abs(dotp), Math.abs(dotp + 1)));\r\n\t}\r\n\r\n\treturn score;\r\n}\r\n","import deepEqual from 'fast-deep-equal';\nimport { geoVecAdd, geoVecEqual, geoVecInterp, geoVecLength, geoVecNormalize, geoVecProject, geoVecScale, geoVecSubtract } from './vector';\nimport { geoOrthoNormalizedDotProduct, geoOrthoCalcScore } from './ortho';\nimport { fixPrecision } from '../../utils';\n\n/*\n * Constants\n */\nconst EPSILON = 1e-4;\nconst THRESHOLD = 13; // degrees within right or straight to alter\n\n/*\n * Utility functions\n */\n\nfunction clonePoints(array) {\n\treturn array.map(function(p) {\n\t\treturn { id: p.id, coord: [p.coord[0], p.coord[1]] };\n\t});\n}\n\nfunction cloneNodes(array) {\n\treturn array.map(function(p) {\n\t\treturn { id: p.id, loc: [p.loc[0], p.loc[1]] };\n\t});\n}\n\nfunction findNode(mynodes, nodeId) {\n\treturn mynodes.find(n => n.id === nodeId);\n}\n\nfunction moveNode(nodes, nodeId, newCoords) {\n\treturn nodes.map(n => n.id === nodeId ? { id: n.id, loc: newCoords } : n);\n}\n\n\n/**\n * Transform a given GeoJSON feature into an orthogonalized geometry (squarified version).\n * Based on iD editor implementation.\n * @see https://github.com/openstreetmap/iD/blob/master/modules/actions/orthogonalize.js\n */\nexport function makeSquare(feature, map) {\n\tif(feature.geometry.type !== \"Polygon\" && feature.geometry.type !== \"LineString\") { return feature; }\n\n\t// We test normalized dot products so we can compare as cos(angle)\n\tconst lowerThreshold = Math.cos((90 - THRESHOLD) * Math.PI / 180);\n\tconst upperThreshold = Math.cos(THRESHOLD * Math.PI / 180);\n\tconst t = 1;\n\n\tconst isClosed = feature.geometry.type === \"Polygon\"\n\t\t\t\t\t|| deepEqual(feature.geometry.coordinates[0], feature.geometry.coordinates[feature.geometry.coordinates.length -1]);\n\n\tlet nodes = cloneNodes(\n\t\t(feature.geometry.type === \"Polygon\" ? feature.geometry.coordinates[0] : feature.geometry.coordinates).map((n,i) => ({ id: i, loc: n.slice() }))\n\t);\n\n\t// Remove nearly duplicates\n\tfor(let i=0; i < nodes.length - 1; i++) {\n\t\tif(geoVecLength(nodes[i].loc, nodes[i+1].loc) < 1e-6) {\n\t\t\tnodes.splice(i, 1);\n\t\t\ti--;\n\t\t}\n\t}\n\n\tconst originalNodes = cloneNodes(nodes);\n\n\tif (isClosed) {\n\t\tnodes.pop();\n\t}\n\n\t// note: all geometry functions here use the unclosed node/point/coord list\n\tconst nodeCount = {};\n\tconst points = [];\n\tconst corner = { i: 0, dotp: 1 };\n\tlet node, point, loc, score, motions, i, j;\n\n\tconst project = (point) => {\n\t\tconst res = map.latLngToLayerPoint([ point[1], point[0] ]);\n\t\treturn [ res.x, res.y ];\n\t};\n\n\tconst invert = (point) => {\n\t\tconst res = map.layerPointToLatLng(point);\n\t\treturn [ res.lng, res.lat ];\n\t};\n\n\tconst calcMotion = (point, i, array) => {\n\t\t// don't try to move the endpoints of a non-closed way.\n\t\tif (!isClosed && (i === 0 || i === array.length - 1)) {\n\t\t\treturn [0, 0];\n\t\t}\n\t\t// don't try to move a node that appears more than once (self intersection)\n\t\tif (nodeCount[array[i].id] > 1) {\n\t\t\treturn [0, 0];\n\t\t}\n\n\t\tconst a = array[(i - 1 + array.length) % array.length].coord;\n\t\tconst origin = point.coord;\n\t\tconst b = array[(i + 1) % array.length].coord;\n\t\tlet p = geoVecSubtract(a, origin);\n\t\tlet q = geoVecSubtract(b, origin);\n\n\t\tconst scale = 2 * Math.min(geoVecLength(p), geoVecLength(q));\n\t\tp = geoVecNormalize(p);\n\t\tq = geoVecNormalize(q);\n\n\t\tconst dotp = (p[0] * q[0] + p[1] * q[1]);\n\t\tconst val = Math.abs(dotp);\n\n\t\tif (val < lowerThreshold) {  // nearly orthogonal\n\t\t\tcorner.i = i;\n\t\t\tcorner.dotp = val;\n\t\t\tconst vec = geoVecNormalize(geoVecAdd(p, q));\n\t\t\treturn geoVecScale(vec, 0.1 * dotp * scale);\n\t\t}\n\n\t\treturn [0, 0];   // do nothing\n\t};\n\n\t// Map nodes into points (using current Leaflet map)\n\tfor (i = 0; i < nodes.length; i++) {\n\t\tnode = nodes[i];\n\t\tnodeCount[node.id] = (nodeCount[node.id] || 0) + 1;\n\t\tpoints.push({ id: node.id, coord: project(node.loc) });\n\t}\n\n\tif (points.length === 3) {   // move only one vertex for right triangle\n\t\tfor (i = 0; i < 1000; i++) {\n\t\t\tmotions = points.map(calcMotion);\n\n\t\t\tpoints[corner.i].coord = geoVecAdd(points[corner.i].coord, motions[corner.i]);\n\t\t\tscore = corner.dotp;\n\t\t\tif (score < EPSILON) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tnode = originalNodes[corner.i];\n\t\tloc = invert(points[corner.i].coord);\n\t\tnodes = moveNode(nodes, node.id, geoVecInterp(node.loc, loc, t));\n\t}\n\telse {\n\t\tconst straights = [];\n\t\tconst simplified = [];\n\n\t\t// Remove points from nearly straight sections..\n\t\t// This produces a simplified shape to orthogonalize\n\t\tfor (i = 0; i < points.length; i++) {\n\t\t\tpoint = points[i];\n\t\t\tlet dotp = 0;\n\t\t\tif (isClosed || (i > 0 && i < points.length - 1)) {\n\t\t\t\tconst a = points[(i - 1 + points.length) % points.length];\n\t\t\t\tconst b = points[(i + 1) % points.length];\n\t\t\t\tdotp = Math.abs(geoOrthoNormalizedDotProduct(a.coord, b.coord, point.coord));\n\t\t\t}\n\n\t\t\tif (dotp > upperThreshold) {\n\t\t\t\tstraights.push(point);\n\t\t\t} else {\n\t\t\t\tsimplified.push(point);\n\t\t\t}\n\t\t}\n\n\t\t// Orthogonalize the simplified shape\n\t\tlet bestPoints = clonePoints(simplified);\n\t\tconst originalPoints = clonePoints(simplified);\n\n\t\tscore = Infinity;\n\t\tfor (i = 0; i < 1000; i++) {\n\t\t\tmotions = simplified.map(calcMotion);\n\n\t\t\tfor (j = 0; j < motions.length; j++) {\n\t\t\t\tsimplified[j].coord = geoVecAdd(simplified[j].coord, motions[j]);\n\t\t\t}\n\t\t\tconst newScore = geoOrthoCalcScore(simplified, isClosed, EPSILON, THRESHOLD);\n\t\t\tif (newScore < score) {\n\t\t\t\tbestPoints = clonePoints(simplified);\n\t\t\t\tscore = newScore;\n\t\t\t}\n\t\t\tif (score < EPSILON) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tconst bestCoords = bestPoints.map(function(p) { return p.coord; });\n\n\t\tif(isClosed) {\n\t\t\tbestCoords.push(bestCoords[0]);\n\t\t}\n\n\t\t// move the nodes that should move\n\t\tfor (i = 0; i < bestPoints.length; i++) {\n\t\t\tpoint = bestPoints[i];\n\n\t\t\tif (!geoVecEqual(originalPoints[i].coord, point.coord)) {\n\t\t\t\tnode = findNode(originalNodes, point.id);\n\t\t\t\tloc = invert(point.coord);\n\t\t\t\tnodes = moveNode(nodes, node.id, geoVecInterp(node.loc, loc, t));\n\t\t\t}\n\t\t}\n\n\t\t// move the nodes along straight segments\n\t\tfor (i = 0; i < straights.length; i++) {\n\t\t\tpoint = straights[i];\n\t\t\tif (nodeCount[point.id] > 1) continue;   // skip self-intersections\n\n\t\t\tnode = findNode(originalNodes, point.id);\n\n\t\t\t// move interesting points to the nearest edge..\n\t\t\tconst choice = geoVecProject(point.coord, bestCoords);\n\t\t\tif (choice) {\n\t\t\t\tloc = invert(choice.target);\n\t\t\t\tnodes = moveNode(nodes, node.id, geoVecInterp(node.loc, loc, t));\n\t\t\t}\n\t\t}\n\t}\n\n\tif(isClosed) {\n\t\tnodes.push(nodes[0]);\n\t}\n\n\t// Create clean feature for sending back\n\tconst newFeature = { type: \"Feature\", geometry: { type: feature.geometry.type } };\n\tif(feature.geometry.type === \"Polygon\") {\n\t\tnewFeature.geometry.coordinates = [ nodes.map(n => fixPrecision(n.loc)) ];\n\t}\n\telse {\n\t\tnewFeature.geometry.coordinates = nodes.map(n => fixPrecision(n.loc));\n\t}\n\n\treturn newFeature;\n};\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport 'array-flat-polyfill';\nimport { GeoJSON } from 'leaflet';\nimport Action from '../model/Action';\nimport area from '@turf/area';\nimport bbox from '@turf/bbox';\nimport bearing from '@turf/bearing';\nimport { bearingToAzimuth } from '@turf/helpers';\nimport booleanContains from '@turf/boolean-contains';\nimport booleanDisjoint from '@turf/boolean-disjoint';\nimport booleanIntersects from '@turf/boolean-intersects';\nimport booleanPointInPolygon from '@turf/boolean-point-in-polygon';\nimport booleanPointOnLine from '@turf/boolean-point-on-line';\nimport buffer from '@turf/buffer';\nimport centerOfMass from '@turf/center-of-mass';\nimport { coordAll } from '@turf/meta';\nimport deepEqual from 'fast-deep-equal';\nimport { fixPrecision, intersectionArray } from '../utils';\nimport GeoJSONValidation from 'geojson-validation';\nimport HistorizedManager from './HistorizedManager';\nimport I18n from '../config/locales/ui';\nimport intersect from '@turf/intersect';\nimport { makeSquare } from '../model/orthogonalize/orthogonalize';\nimport nearestPoint from '@turf/nearest-point';\nimport osmtogeojson from 'osmtogeojson';\nimport OsmRequest from 'osm-request';\nimport PACKAGE from '../../package.json';\nimport polygonToLine from '@turf/polygon-to-line';\nimport PubSub from 'pubsub-js';\nimport transformTranslate from '@turf/transform-translate';\n\nconst sortNumberArray = (a, b) => a-b;\nconst IGNORED_TAGS = [ \"level\", \"repeat_on\", \"created_by\", \"source\" ];\n\n/**\n * Vector data manager allows to retrieve and save vector data from external providers.\n * It mainly saves the data from OpenStreetMap.\n */\nclass VectorDataManager extends HistorizedManager {\n\tconstructor() {\n\t\tsuper();\n\t\tthis._cacheOsmXml = null;\n\t\tthis._cacheOsmGeojson = null;\n\t\tthis._cacheBbox = null;\n\t\tthis._nextId = -1;\n\n\t\t// Create OSM Request\n\t\tthis._osmApi = new OsmRequest({\n\t\t\tendpoint: window.CONFIG.osm_api_url,\n\t\t\talways_authenticated: window.CONFIG.always_authenticated,\n\t\t\toauthConsumerKey: window.CONFIG.oauth_consumer_key,\n\t\t\toauthSecret: window.CONFIG.oauth_secret\n\t\t});\n\t}\n\n\t/**\n\t * Downloads from OSM API data in the given bounding box.\n\t * @param {LatLngBounds} bbox The area to download\n\t * @return {Promise} Resolves when data is ready, true if everything went well\n\t */\n\tloadOSMData(bbox) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\t//If data is cached, no need to download again\n\t\t\tif(this._cacheBbox && this._cacheBbox.filter(b => b.contains(bbox)).length > 0) {\n\t\t\t\tresolve(true);\n\t\t\t}\n\n\t\t\tconst restoreEdits = this._cacheOsmXml !== null;\n\n\t\t\t// Accumulate retrieved data\n\t\t\tthis._osmApi\n\t\t\t.fetchMapByBbox(bbox.getWest(), bbox.getSouth(), bbox.getEast(), bbox.getNorth(), \"both\")\n\t\t\t.then(res => {\n\t\t\t\tconst [mapJson, mapXml] = res;\n\t\t\t\tthis._appendOsmXml(mapJson, mapXml, bbox);\n\n\t\t\t\tif(\n\t\t\t\t\t(this._cacheOsmJson.node && this._cacheOsmJson.node.length > 0)\n\t\t\t\t\t|| (this._cacheOsmJson.way && this._cacheOsmJson.way.length > 0)\n\t\t\t\t\t|| (this._cacheOsmJson.relation && this._cacheOsmJson.relation.length > 0)\n\t\t\t\t) {\n\t\t\t\t\tthis._cacheOsmGeojson = this.getBaseCollection();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis._cacheOsmGeojson = { type: \"FeatureCollection\", features: [] };\n\t\t\t\t}\n\n\t\t\t\t// Restore all edits made by user\n\t\t\t\tif(restoreEdits) {\n\t\t\t\t\tthis._nextId = -1;\n\t\t\t\t\tfor(let i=0; i <= this._lastActionId; i++) {\n\t\t\t\t\t\tthis._do(this._actions[i], true);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tresolve(true);\n\t\t\t})\n\t\t\t.catch(e => {\n\t\t\t\tconsole.error(\"Can't load OSM data\", e);\n\t\t\t\treject(e);\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Adds new data retrieved from OSM into local cache\n\t * @private\n\t */\n\t_appendOsmXml(mapjson, mapxml, bbox) {\n\t\tconst mymapxml = (new window.DOMParser()).parseFromString(mapxml, \"text/xml\");\n\n\t\t// Append to existing cache\n\t\tif(this._cacheOsmXml && this._actions.length > 0) {\n\t\t\tthis._cacheBbox.push(bbox);\n\t\t\tconst cacheOsmNode = this._cacheOsmXml.children[0];\n\t\t\tconst newOsmNode = mymapxml.children[0];\n\t\t\tconst toAdd = [];\n\n\t\t\t// Merge JSON/XML\n\t\t\t[\"node\", \"way\", \"relation\"]\n\t\t\t.filter(t => mapjson[t])\n\t\t\t.forEach(t => {\n\t\t\t\t// Find version for each ID\n\t\t\t\tconst existingVersions = {};\n\t\t\t\tif(this._cacheOsmJson[t]) {\n\t\t\t\t\tthis._cacheOsmJson[t].forEach((n,i) => {\n\t\t\t\t\t\texistingVersions[n.$.id] = { v: n.$.version, i: i };\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// Replace or append entries\n\t\t\t\tmapjson[t].forEach((n,i) => {\n\t\t\t\t\tconst xmlid = t+\"[id='\"+n.$.id+\"']\";\n\t\t\t\t\tconst oldN = existingVersions[n.$.id];\n\n\t\t\t\t\tif(this._cacheOsmJson[t] && oldN && oldN.v < n.$.version) {\n\t\t\t\t\t\tthis._cacheOsmJson[t][n.$.id] = n;\n\n\t\t\t\t\t\tconst xmlnode = cacheOsmNode.querySelector(n.$.id);\n\t\t\t\t\t\txmlnode.parentNode.replaceChild(newOsmNode.querySelector(xmlid), xmlnode);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tif(!this._cacheOsmJson[t]) {\n\t\t\t\t\t\t\tthis._cacheOsmJson[t] = [n];\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tthis._cacheOsmJson[t].push(n);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\ttoAdd.push(newOsmNode.querySelector(xmlid));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tcacheOsmNode.append(...toAdd);\n\t\t}\n\t\t// Create cache from this data\n\t\telse {\n\t\t\tthis._cacheOsmXml = mymapxml;\n\t\t\tthis._cacheOsmJson = mapjson;\n\t\t\tthis._cacheBbox = [ bbox ];\n\t\t}\n\t}\n\n\t/**\n\t * Cleans all data temporarily saved.\n\t * This is useful after successful upload.\n\t */\n\tcleanUp() {\n\t\tthis._cacheOsmXml = null;\n\t\tthis._cacheOsmGeojson = null;\n\t\tthis._cacheBbox = null;\n\t\tthis._nextId = -1;\n\t\tthis._actions = [];\n\t\tthis._lastActionId = -1;\n\t}\n\n\t/**\n\t * Get buildings from cached OSM data\n\t * @param {float} [level] Only retrieve building going through given level (no filter by default). If a decimal value is given, it will be floored.\n\t * @return {Object} Buildings features, as GeoJSON feature collection\n\t */\n\tgetOSMBuildings(level) {\n\t\tlet features = [];\n\t\tlevel = level === undefined ? undefined : Math.floor(level);\n\n\t\tif(this._cacheOsmGeojson) {\n\t\t\tfeatures = this._cacheOsmGeojson\n\t\t\t\t.features\n\t\t\t\t.filter(feature => (\n\t\t\t\t\tfeature.type === \"Feature\" && feature.properties && feature.properties.tags && feature.properties.tags.building\n\t\t\t\t\t&& (level === undefined || (feature.properties.own && feature.properties.own.levels && feature.properties.own.levels.includes(level)))\n\t\t\t\t));\n\t\t}\n\n\t\treturn { type: \"FeatureCollection\", features: features };\n\t}\n\n\t/**\n\t * Get available levels inside a building\n\t * @param {Object} building The GeoJSON feature of the building\n\t * @return {Object} The same feature, with list of levels in feature.properties.own.levels\n\t */\n\tgetBuildingLevels(building) {\n\t\tif(!building.properties.own.levels || !building.properties.own.levelsComputed) {\n\t\t\t//Levels of building itself\n\t\t\tbuilding = this._listFeatureLevels(building, true);\n\n\t\t\t//Levels of feature it contains\n\t\t\tif(this._cacheOsmGeojson) {\n\t\t\t\tconst levels = new Set(building.properties.own.levels);\n\n\t\t\t\tthis._cacheOsmGeojson.features.forEach(feature => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tif(booleanIntersects(building, feature)) {\n\t\t\t\t\t\t\tthis._listFeatureLevels(feature).properties.own.levels.forEach(l => levels.add(l));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcatch(e) {}\n\t\t\t\t});\n\n\t\t\t\tbuilding.properties.own.levels = Array.from(levels);\n\t\t\t}\n\n\t\t\tbuilding.properties.own.levels.sort(sortNumberArray);\n\t\t\tbuilding.properties.own.levelsComputed = true;\n\t\t}\n\n\t\treturn building;\n\t}\n\n\t/**\n\t * Get the list of all levels available in data\n\t * @param {boolean} [rounded] Set to true if values should be rounded\n\t * @return {int[]} List of levels available\n\t */\n\tgetAllLevels(rounded) {\n\t\trounded = rounded || false;\n\n\t\tif(this._cacheOsmGeojson) {\n\t\t\tconst levels = new Set();\n\t\t\tthis._cacheOsmGeojson.features.forEach(feature => {\n\t\t\t\tthis._listFeatureLevels(feature).properties.own.levels.forEach(l => levels.add(rounded ? Math.floor(l) : l));\n\t\t\t});\n\t\t\tconst levelsArray = [...levels];\n\t\t\tlevelsArray.sort((a,b) => parseInt(a) - parseInt(b));\n\t\t\treturn levelsArray;\n\t\t}\n\t\telse {\n\t\t\treturn [ 0 ];\n\t\t}\n\t}\n\n\t/**\n\t * Check if a feature is overlapping enough a container feature (eg level inside building)\n\t * @param {Object} container The GeoJSON feature which should contain the other one\n\t * @param {Object} feature The GeoJSON feature which should be contained\n\t * @return {boolean} True if overlapping enough\n\t */\n\tisOverlappingEnough(container, feature) {\n\t\tif(!container || !feature || container.type !== \"Feature\" || feature.type !== \"Feature\") {\n\t\t\treturn false;\n\t\t}\n\t\telse if(booleanIntersects(container, feature)) {\n\t\t\tif(this._containsWithBoundary(container, feature) || this._containsWithBoundary(feature, container)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\telse if(container.geometry.type === \"Polygon\" && feature.geometry.type === \"Polygon\") {\n\t\t\t\tconst common = intersect(container, feature);\n\t\t\t\treturn common !== undefined\n\t\t\t\t\t&& common !== null\n\t\t\t\t\t&& GeoJSONValidation.valid(common)\n\t\t\t\t\t&& area(common) >= area(feature) * 0.8;\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Find the building which contains given feature\n\t * @param {Object} feature The feature to look for\n\t * @return {Object} The found building, or null if none or several\n\t */\n\tfindAssociatedBuilding(feature) {\n\t\tif(feature.properties.tags.building) { return feature; }\n\t\tconst buildings = this.getOSMBuildings().features.filter(b => this._containsWithBoundary(b, feature));\n\t\treturn buildings.length === 1 ? buildings[0] : null;\n\t}\n\n\t/**\n\t * Retrieve the level feature in a specific building, at a given level.\n\t * @param {Object} building The GeoJSON feature of the building\n\t * @param {float} level The level value\n\t * @return {Object[]} The level footprint (possibly several), or null if none found\n\t */\n\tgetLevelFootprint(building, level) {\n\t\treturn (this._cacheOsmGeojson) ?\n\t\t\tthis._cacheOsmGeojson.features\n\t\t\t.filter(feature => (\n\t\t\t\tfeature.type === \"Feature\" && feature.properties.tags && feature.properties.tags.indoor === \"level\"\n\t\t\t\t&& (\n\t\t\t\t\tfeature.properties.own.utilityNode\n\t\t\t\t\t|| this._listFeatureLevels(feature).properties.own.levels.includes(level)\n\t\t\t\t)\n\t\t\t\t&& this.isOverlappingEnough(building, feature)\n\t\t\t))\n\t\t\t:\n\t\t\tnull;\n\t}\n\n\t/**\n\t * Retrieve the list of levels which can be used for copy in this building\n\t * @param {Object} building The GeoJSON feature of the building\n\t * @return {float[]} List of level values containing data for copy\n\t */\n\tgetCopiableLevels(building) {\n\t\tif(!this._cacheOsmGeojson) { return null; }\n\t\telse {\n\t\t\tconst rawLevels = this._cacheOsmGeojson.features\n\t\t\t\t.filter(feature => (\n\t\t\t\t\tfeature.type === \"Feature\" && feature.properties.tags && feature.properties.tags.indoor === \"level\"\n\t\t\t\t\t&& this.isOverlappingEnough(building, feature)\n\t\t\t\t))\n\t\t\t\t.map(feature => this._listFeatureLevels(feature).properties.own.levels)\n\t\t\t\t.flat();\n\t\t\tconst levels = [...new Set(rawLevels)];\n\t\t\tlevels.sort((a,b) => parseFloat(a) - parseFloat(b));\n\t\t\treturn levels;\n\t\t}\n\t}\n\n\t/**\n\t * Retrieve the features being contained in a particular floor\n\t * @param {Object} floor The GeoJSON feature for the floor\n\t * @param {float} level The level being used\n\t * @param {Object} [options] Options\n\t * @param {Object} [options.building] The building feature (for adding additional info on features)\n\t * @param {boolean} [options.includeFloorParts] Also include floor parts\n\t * @return {Object} The GeoJSON feature collection of objects on this floor\n\t */\n\tgetFeaturesInFloor(floor, level, options) {\n\t\toptions = options || {};\n\t\tlet features = [];\n\t\tconst isNotExcludedFeature = (tags => (options.includeFloorParts || tags.indoor !== \"level\") && !tags.building && !tags[\"building:part\"]);\n\n\t\tif(this._cacheOsmGeojson) {\n\t\t\tconst floorBuff = floor && buffer(floor, 20, { units: \"meters\" });\n\t\t\tfeatures = this._cacheOsmGeojson\n\t\t\t\t.features\n\t\t\t\t.filter(feature => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\treturn (this._listFeatureLevels(feature).properties.own.levels || []).includes(level)\n\t\t\t\t\t\t\t&& feature.type === \"Feature\"\n\t\t\t\t\t\t\t&& isNotExcludedFeature(feature.properties.tags)\n\t\t\t\t\t\t\t&& (!floor || booleanIntersects(floorBuff, feature));\n\t\t\t\t\t}\n\t\t\t\t\tcatch(e) { return false; }\n\t\t\t\t});\n\n\t\t\t// Add custom rendering for doors on building contour\n\t\t\tif(options.building) {\n\t\t\t\tfeatures = features.map(f => {\n\t\t\t\t\tif([\"Point\", \"LineString\"].includes(f.geometry.type) && f.properties.tags.door) {\n\t\t\t\t\t\tf.properties.own.onBuildingContour = this.isOnContour(options.building, f);\n\t\t\t\t\t}\n\t\t\t\t\treturn f;\n\t\t\t\t});\n\t\t\t}\n\t\t\telse {\n\t\t\t\tconst buildings = this._cacheOsmGeojson.features.filter(f => f.type === \"Feature\" && [\"Polygon\",\"MultiPolygon\"].includes(f.geometry.type) && f.properties.tags.building);\n\n\t\t\t\tfeatures = features.map(f => {\n\t\t\t\t\tif(f.properties.tags.door && [\"Point\", \"LineString\"].includes(f.geometry.type)) {\n\t\t\t\t\t\tlet onContour = false;\n\t\t\t\t\t\tfor(let b of buildings) {\n\t\t\t\t\t\t\tif(this.isOnContour(b, f)) {\n\t\t\t\t\t\t\t\tonContour = true;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tf.properties.own.onBuildingContour = onContour;\n\t\t\t\t\t}\n\t\t\t\t\treturn f;\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tfeatures.sort((a, b) => parseInt(a.geometry.type === \"Point\") - parseInt(b.geometry.type === \"Point\"));\n\t\t}\n\n\t\treturn { type: \"FeatureCollection\", features: features };\n\t}\n\n\t/**\n\t * Retrieve the features being contained in a particular level of a building\n\t * @param {Object} building The GeoJSON feature for the building\n\t * @param {float} level The level being used\n\t * @return {Object} The GeoJSON feature collection of objects on this floor\n\t */\n\tgetFeaturesInLevel(building, level) {\n\t\tlet features = [];\n\t\tconst isNotExcludedFeature = (tags => tags.indoor !== \"level\" && !tags.building && !tags[\"building:part\"]);\n\n\t\tif(this._cacheOsmGeojson) {\n\t\t\tconst buildingBuff = building && buffer(building, 20, { units: \"meters\" });\n\t\t\tfeatures = this._cacheOsmGeojson\n\t\t\t\t.features\n\t\t\t\t.filter(feature => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\tthis._listFeatureLevels(feature).properties.own.levels || []).includes(level)\n\t\t\t\t\t\t\t&& feature.type === \"Feature\"\n\t\t\t\t\t\t\t&& isNotExcludedFeature(feature.properties.tags)\n\t\t\t\t\t\t\t&& (!building || booleanIntersects(buildingBuff, feature)\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tcatch(e) { return false; }\n\t\t\t\t});\n\n\t\t\t// Add custom rendering for doors on building contour\n\t\t\tif(building) {\n\t\t\t\tfeatures = features.map(f => {\n\t\t\t\t\tif([\"Point\", \"LineString\"].includes(f.geometry.type) && f.properties.tags.door) {\n\t\t\t\t\t\tf.properties.own.onBuildingContour = this.isOnContour(building, f);\n\t\t\t\t\t}\n\t\t\t\t\treturn f;\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tfeatures.sort((a, b) => parseInt(a.geometry.type === \"Point\") - parseInt(b.geometry.type === \"Point\"));\n\t\t}\n\n\t\treturn { type: \"FeatureCollection\", features: features };\n\t}\n\n\t/**\n\t * Does this given building contain any indoor-related feature ?\n\t * @param {Object} building The building to check\n\t * @return {boolean} True if it has indoor features\n\t */\n\thasIndoorFeatures(building) {\n\t\tlet result = false;\n\n\t\tif(building && this._cacheOsmGeojson) {\n\t\t\tconst isNotExcludedFeature = (tags => tags.level !== undefined && tags.indoor !== undefined && tags.indoor !== \"level\" && !tags.building && !tags[\"building:part\"]);\n\n\t\t\tfor(let i=0; i < this._cacheOsmGeojson.features.length; i++) {\n\t\t\t\tconst feature = this._cacheOsmGeojson.features[i];\n\n\t\t\t\tif(\n\t\t\t\t\tfeature.id.startsWith(\"way/\")\n\t\t\t\t\t&& feature.geometry.type !== \"MultiPolygon\"\n\t\t\t\t\t&& isNotExcludedFeature(feature.properties.tags)\n\t\t\t\t\t&& booleanIntersects(building, feature)\n\t\t\t\t) {\n\t\t\t\t\tresult = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * Search in edited data which buildings lacks an indoor=level outline.\n\t * @param {Object} diff The edits done by user (result of computeDiff function)\n\t * @return {Object} Missing level outlines in format { buildingId: { name: string, levels: int[] } }\n\t */\n\tfindMissingLevelOutlines(diff) {\n\t\tconst result = {};\n\n\t\tif(!this._cacheOsmGeojson) { return null; }\n\n\t\tthis._cacheOsmGeojson.features.forEach(f => {\n\t\t\tif(f.properties.tags && f.properties.tags.building) {\n\t\t\t\tconst name = f.properties.tags.name || f.properties.tags.ref || f.id;\n\t\t\t\tlet levels = this._listFeatureLevels(f, true).properties.own.levels;\n\t\t\t\tconst usedLevels = this.getCopiableLevels(f);\n\t\t\t\tlevels = levels.filter(lvl => !usedLevels.includes(lvl));\n\n\t\t\t\tif(levels.length > 0 && this.hasIndoorFeatures(f)) {\n\t\t\t\t\tresult[f.id] = { name: name, levels: levels };\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * Check if a small geometry is within the boundary of a large geometry (boundary included)\n\t * @private\n\t */\n\t_containsWithBoundary(large, small) {\n\t\tif(small.type !== \"Feature\" || large.type !== \"Feature\") { return false; }\n\t\telse if(deepEqual(small.geometry, large.geometry)) { return true; }\n\t\telse if(this._booleanContains(large, small)) { return true; }\n\t\telse if(booleanIntersects(large, small)) {\n\t\t\tconst coords = coordAll(small);\n\t\t\tconst wider = buffer(large, 0.01, { units: 'meters' }); // Fix for lack of precision on drawn geometries\n\n\t\t\t//Check all points lies within or on boundary\n\t\t\tfor(let c of coords) {\n\t\t\t\tif(!c || !booleanPointInPolygon(c, wider)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn true;\n\t\t}\n\t\telse { return false; }\n\t}\n\n\t/**\n\t * Create a new building feature in cached data, using given GeoJSON feature.\n\t * @param {Object} geojson The GeoJSON feature (should be a Polygon)\n\t * @return {Object} The clean building GeoJSON feature which was created\n\t */\n\tcreateNewBuilding(geojson) {\n\t\treturn this._do(new Action(Action.BUILDING_NEW, this._nextId, arguments));\n\t}\n\n\t/**\n\t * Raw building creation\n\t * @private\n\t */\n\t_createNewBuilding(geojson) {\n\t\t// Edit properties\n\t\tgeojson.id = \"way/\" + this._nextId--;\n\t\tgeojson.properties.tags = {\n\t\t\tbuilding: \"yes\"\n\t\t};\n\t\tgeojson.properties.own = {\n\t\t\tnew: true\n\t\t};\n\n\t\tgeojson = this._listFeatureLevels(geojson);\n\n\t\t// Add to cache\n\t\tthis._cacheOsmGeojson.features.push(geojson);\n\n\t\treturn geojson;\n\t}\n\n\t/**\n\t * Create a new floor feature in cached data, using given GeoJSON feature.\n\t * @param {Object} geojson The GeoJSON feature (should be a Polygon)\n\t * @param {float} level The level value for this feature\n\t * @return {Object} The clean floor GeoJSON feature which was created\n\t */\n\tcreateNewFloor(geojson, level) {\n\t\treturn this._do(new Action(Action.FLOOR_NEW, this._nextId, arguments));\n\t}\n\n\t/**\n\t * Raw floor creation\n\t * @private\n\t */\n\t_createNewFloor(geojson, level) {\n\t\t// Edit properties\n\t\tgeojson.id = \"way/\" + this._nextId--;\n\t\tgeojson.properties.tags = {\n\t\t\tindoor: \"level\",\n\t\t\tlevel: level.toString()\n\t\t};\n\t\tgeojson.properties.own = {\n\t\t\tnew: true\n\t\t};\n\n\t\tgeojson = this._listFeatureLevels(geojson);\n\n\t\t// Add to cache\n\t\tthis._cacheOsmGeojson.features.push(geojson);\n\n\t\treturn geojson;\n\t}\n\n\t/**\n\t * Create a new feature in cached data, using given GeoJSON feature.\n\t * @param {Object} geojson The GeoJSON feature\n\t * @param {float} level The level value for this feature\n\t * @param {Object} preset The preset to apply\n\t * @return {Object} The clean floor GeoJSON feature which was created\n\t */\n\tcreateNewFeature(geojson, level, preset) {\n\t\treturn this._do(new Action(Action.FEATURE_NEW, this._nextId, arguments));\n\t}\n\n\t/**\n\t * Raw feature creation\n\t * @private\n\t */\n\t_createNewFeature(geojson, level, preset) {\n\t\t// Edit properties\n\t\tlet type = \"invalid\";\n\t\tif(geojson.geometry.type === \"Point\") { type = \"node\"; }\n\t\telse if([ \"LineString\", \"Polygon\" ].includes(geojson.geometry.type)) { type = \"way\"; }\n\n\t\tgeojson.id = type + \"/\" + this._nextId--;\n\t\tgeojson.properties.tags = Object.assign({ level: level.toString() }, preset.tags);\n\t\tgeojson.properties.own = {\n\t\t\tnew: true\n\t\t};\n\n\t\tgeojson = this._listFeatureLevels(geojson);\n\n\t\t// Add to cache\n\t\tthis._cacheOsmGeojson.features.push(geojson);\n\n\t\treturn geojson;\n\t}\n\n\t/**\n\t * Copy an existing level data to another level.\n\t * @param {Object} building The GeoJSON feature of the building\n\t * @param {float} fromLevel The base level to copy data from\n\t * @param {float} toLevel The destination level\n\t */\n\tcopyLevel(building, fromLevel, toLevel) {\n\t\treturn this._do(new Action(Action.FLOOR_COPY, this._nextId, arguments));\n\t}\n\n\t/**\n\t * Raw feature copy\n\t * @private\n\t */\n\t_copyLevel(building, fromLevel, toLevel) {\n\t\ttoLevel = parseFloat(toLevel);\n\t\tfromLevel = parseFloat(fromLevel);\n\n\t\t// Find features to copy\n\t\tconst featuresToCopy = this.getFeaturesInFloor(building, fromLevel, { includeFloorParts: true })\n\t\t\t.features\n\t\t\t.filter(f => !this._listFeatureLevels(f).properties.own.levels.includes(toLevel));\n\n\t\t// Create new features\n\t\tconst featuresToCreate = featuresToCopy.map(f => (\n\t\t\tthis._listFeatureLevels({\n\t\t\t\tid: f.id.split(\"/\")[0] + \"/\" + this._nextId--,\n\t\t\t\ttype: \"Feature\",\n\t\t\t\tproperties: {\n\t\t\t\t\ttags: Object.assign({}, f.properties.tags, { level: toLevel.toString() }),\n\t\t\t\t\town: { new: true }\n\t\t\t\t},\n\t\t\t\tgeometry: Object.assign({}, f.geometry)\n\t\t\t})\n\t\t));\n\n\t\t// Add to cache\n\t\tfeaturesToCreate.forEach(f => {\n\t\t\tthis._cacheOsmGeojson.features.push(f);\n\t\t});\n\n\t\t// Send back list of created features IDs\n\t\treturn featuresToCreate.map(f => f.id);\n\t}\n\n\t/**\n\t * Copy a feature in cached data, using given GeoJSON feature.\n\t * @param {Object} geojson The GeoJSON feature to copy\n\t * @param {float} level The level value for this feature\n\t * @param {LatLng} center The center position where feature should be copied\n\t * @return {Object} The clean floor GeoJSON feature which was created\n\t */\n\tcopyFeature(geojson, level, center) {\n\t\treturn this._do(new Action(Action.FEATURE_COPY, this._nextId, arguments));\n\t}\n\n\t/**\n\t * Raw feature copy\n\t * @private\n\t */\n\t_copyFeature(geojson, level, center) {\n\t\t// Shift geometry\n\t\tconst prevCenter = GeoJSON.coordsToLatLng(centerOfMass(geojson).geometry.coordinates);\n\t\tconst dist = prevCenter.distanceTo(center);\n\t\tconst direction = bearingToAzimuth(bearing(GeoJSON.latLngToCoords(prevCenter), GeoJSON.latLngToCoords(center)));\n\t\tlet newfeature = transformTranslate(geojson, dist, direction, { units: 'meters', mutate: false });\n\n\t\tnewfeature.id = geojson.id.split(\"/\")[0] + \"/\" + this._nextId--;\n\t\tnewfeature.properties.tags.level = level.toString();\n\t\tnewfeature.properties.own = {\n\t\t\tnew: true\n\t\t};\n\n\t\tnewfeature = this._listFeatureLevels(newfeature);\n\n\t\t// Add to cache\n\t\tthis._cacheOsmGeojson.features.push(newfeature);\n\n\t\treturn newfeature;\n\t}\n\n\t/**\n\t * Edits an existing feature in cache using the one passed in parameter.\n\t * This should only be used for internal properties editing. Otherwise, use editFeatureGeometry or setFeatureTags.\n\t * @param {Object} feature The edited version of the feature\n\t * @param {boolean} [noCheckLevels] Skip checks for levels (default: false)\n\t * @return {Object} The clean version of the edited feature (to use in view)\n\t */\n\teditFeature(feature, noCheckLevels) {\n\t\t// Find index of this feature in GeoJSON cache\n\t\tconst featureCacheId = this._findCacheId(feature.id);\n\n\t\t// Save new version in cache\n\t\tif(featureCacheId !== -1) {\n\t\t\tif(!noCheckLevels) {\n\t\t\t\tfeature = this._listFeatureLevels(feature, true);\n\t\t\t}\n\n\t\t\tif(\n\t\t\t\tthis._cacheOsmGeojson.features[featureCacheId] !== feature\n\t\t\t\t&& !deepEqual(this._cacheOsmGeojson.features[featureCacheId], feature)\n\t\t\t) {\n\t\t\t\tthis._cacheOsmGeojson.features[featureCacheId] = feature;\n\t\t\t}\n\n\t\t\treturn feature;\n\t\t}\n\t\telse {\n\t\t\tconsole.error(\"Can't find feature in cache\");\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Edits feature geometry to make it rectangular\n\t * @param {string} featureId The feature ID\n\t * @param {Object} map The Leaflet map\n\t * @return {Object} The edited feature\n\t */\n\tmakeFeatureSquare(featureId, map) {\n\t\tconst featureCacheId = this._findCacheId(featureId);\n\n\t\treturn this._do(new Action(\n\t\t\tAction.FEATURE_GEOM_SQUARE,\n\t\t\t[\n\t\t\t\tfeatureId,\n\t\t\t\tfeatureCacheId !== -1 ? this._cacheOsmGeojson.features[featureCacheId].geometry : null\n\t\t\t],\n\t\t\targuments\n\t\t));\n\t}\n\n\t/**\n\t * Raw feature geometry editing\n\t * @private\n\t */\n\t_makeFeatureSquare(featureId, map) {\n\t\t// Find index of this feature in GeoJSON cache\n\t\tconst featureCacheId = this._findCacheId(featureId);\n\n\t\t// If found\n\t\tif(featureCacheId !== -1) {\n\t\t\tconst feature = this._listFeatureLevels(this._cacheOsmGeojson.features[featureCacheId]);\n\n\t\t\t// Look for possibly connected features\n\t\t\tlet connectedFeatures = [];\n\t\t\tlet connectedFeaturesCacheIds = [];\n\t\t\tconst updatedFeaturesPrev = [];\n\n\t\t\tif(feature.properties.own && feature.properties.own.levels && feature.properties.own.levels.length > 0) {\n\t\t\t\tconnectedFeatures = this._cacheOsmGeojson.features.filter((f,i) => {\n\t\t\t\t\tif(!f || f.id === feature.id || !f.properties.own || !f.properties.own.levels || !f.geometry || f.type !== \"Feature\") {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\t// Check levels\n\t\t\t\t\telse {\n\t\t\t\t\t\tlet hasSharedLevels = false;\n\t\t\t\t\t\tfor(let i=0; i < feature.properties.own.levels.length; i++) {\n\t\t\t\t\t\t\tlet lvl = feature.properties.own.levels[i];\n\t\t\t\t\t\t\tif(f.properties.own.levels.includes(lvl)) {\n\t\t\t\t\t\t\t\thasSharedLevels = true;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif(hasSharedLevels && !booleanDisjoint(feature, f) && !this._booleanContains(f, feature) && !this._booleanContains(feature, f)) {\n\t\t\t\t\t\t\tconnectedFeaturesCacheIds.push(i);\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst newFeature = Object.assign({}, this._cacheOsmGeojson.features[featureCacheId]);\n\t\t\tconst geometry = makeSquare(newFeature, map).geometry;\n\n\t\t\tif(!deepEqual(feature.geometry, geometry)) {\n\t\t\t\t// Save geometry\n\t\t\t\tnewFeature.geometry = geometry;\n\t\t\t\tthis._cacheOsmGeojson.features[featureCacheId] = newFeature;\n\t\t\t\tupdatedFeaturesPrev.push(feature);\n\n\t\t\t\t// Function to get nearest point on new geometry\n\t\t\t\tconst ftNearest = geometry.type === \"LineString\" ? newFeature : polygonToLine(newFeature);\n\t\t\t\tconst oldFtAsLine = feature.geometry.type === \"LineString\" ? feature : polygonToLine(feature);\n\t\t\t\tconst ftNodesNearest = { type: \"FeatureCollection\", features: ftNearest.geometry.coordinates.map(c => (\n\t\t\t\t\t{ type: \"Feature\", properties: {}, geometry: { type: \"Point\", coordinates: fixPrecision(c) } }\n\t\t\t\t)) };\n\n\t\t\t\tconst getNearestCoords = coords => {\n\t\t\t\t\treturn nearestPoint({ type: \"Point\", coordinates: coords }, ftNodesNearest).geometry.coordinates;\n\t\t\t\t};\n\t\t\t\tconst snapToFeature = coordsList => (\n\t\t\t\t\tcoordsList.map(coord => {\n\t\t\t\t\t\treturn booleanPointOnLine(coord, oldFtAsLine) ? getNearestCoords(coord) : coord;\n\t\t\t\t\t})\n\t\t\t\t);\n\n\t\t\t\t// Update connected features geometries\n\t\t\t\tconnectedFeaturesCacheIds.forEach((cacheId, i) => {\n\t\t\t\t\tconst connectedFeature = Object.assign({}, connectedFeatures[i]);\n\t\t\t\t\tconnectedFeature.geometry = Object.assign({}, connectedFeature.geometry);\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tswitch(connectedFeature.geometry.type) {\n\t\t\t\t\t\t\tcase \"Point\":\n\t\t\t\t\t\t\t\tconnectedFeature.geometry.coordinates = getNearestCoords(connectedFeature.geometry.coordinates);\n\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\tcase \"LineString\":\n\t\t\t\t\t\t\t\tconnectedFeature.geometry.coordinates = snapToFeature(connectedFeature.geometry.coordinates);\n\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\tcase \"Polygon\":\n\t\t\t\t\t\t\t\tconnectedFeature.geometry.coordinates = connectedFeature.geometry.coordinates.map(ct => snapToFeature(ct));\n\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\tconsole.log(\"Ignored snapping of feature\", connectedFeature.id);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Save if snapped version is different of existing one\n\t\t\t\t\t\tif(!deepEqual(connectedFeatures[i].geometry, connectedFeature.geometry)) {\n\t\t\t\t\t\t\tthis._cacheOsmGeojson.features[cacheId] = connectedFeature;\n\t\t\t\t\t\t\tupdatedFeaturesPrev.push(connectedFeatures[i]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcatch(e) {\n\t\t\t\t\t\tconsole.error(\"Can't snap for feature\", connectedFeature.id, e);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Save features in stack to allow restoring\n\t\t\tthis._actions[this._lastActionId].prev = updatedFeaturesPrev;\n\n\t\t\treturn newFeature;\n\t\t}\n\t\telse {\n\t\t\tconsole.error(\"Can't find feature in cache\");\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Changes the geometry of a given feature\n\t * @param {string} featureId The feature ID\n\t * @param {Object} geometry The new GeoJSON geometry\n\t * @return {Object} The edited feature\n\t */\n\teditFeatureGeometry(featureId, geometry) {\n\t\tconst featureCacheId = this._findCacheId(featureId);\n\n\t\treturn this._do(new Action(\n\t\t\tAction.FEATURE_GEOM_EDIT,\n\t\t\t[\n\t\t\t\tfeatureId,\n\t\t\t\tfeatureCacheId !== -1 ? this._cacheOsmGeojson.features[featureCacheId].geometry : null\n\t\t\t],\n\t\t\targuments\n\t\t));\n\t}\n\n\t/**\n\t * Raw feature geometry editing\n\t * @private\n\t */\n\t_editFeatureGeometry(featureId, geometry) {\n\t\t// Find index of this feature in GeoJSON cache\n\t\tconst featureCacheId = this._findCacheId(featureId);\n\n\t\t// Save new version in cache\n\t\tif(featureCacheId !== -1) {\n\t\t\tlet feature = Object.assign({}, this._cacheOsmGeojson.features[featureCacheId]);\n\n\t\t\tif(!deepEqual(feature.geometry, geometry)) {\n\t\t\t\t// Save geometry\n\t\t\t\tfeature.geometry = geometry;\n\t\t\t\tthis._cacheOsmGeojson.features[featureCacheId] = feature;\n\t\t\t}\n\n\t\t\treturn feature;\n\t\t}\n\t\telse {\n\t\t\tconsole.error(\"Can't find feature in cache\");\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Changes tags of a given feature.\n\t * @param {string} featureId The feature ID\n\t * @param {Object} tags The new tags to set on feature\n\t * @return {Object} The edited feature\n\t */\n\tsetFeatureTags(featureId, tags) {\n\t\tconst featureCacheId = this._findCacheId(featureId);\n\n\t\treturn this._do(new Action(\n\t\t\tAction.FEATURE_TAGS_EDIT,\n\t\t\t[\n\t\t\t\tfeatureId,\n\t\t\t\tfeatureCacheId !== -1 ? this._cacheOsmGeojson.features[featureCacheId].properties.tags : null\n\t\t\t],\n\t\t\targuments\n\t\t));\n\t}\n\n\t/**\n\t * Raw tag editing\n\t * @private\n\t */\n\t_setFeatureTags(featureId, tags) {\n\t\tconst featureCacheId = this._findCacheId(featureId);\n\n\t\t// Save in cache\n\t\tif(featureCacheId !== -1) {\n\t\t\tlet feature = this._cacheOsmGeojson.features[featureCacheId];\n\n\t\t\tif(!deepEqual(feature.properties.tags, tags)) {\n\t\t\t\tconst hasRepeatOn = feature.properties.tags.repeat_on !== undefined || tags.repeat_on !== undefined;\n\n\t\t\t\tfeature.properties.tags = tags;\n\t\t\t\tfeature = this._listFeatureLevels(feature, true);\n\n\t\t\t\t// Handle utility nodes\n\t\t\t\tif(feature.id.startsWith(\"node/\")) {\n\t\t\t\t\tfeature.properties.own.utilityNode = !this.hasMainTags(tags);\n\t\t\t\t}\n\n\t\t\t\t// Clean-up level tag\n\t\t\t\tif((tags.level && !hasRepeatOn) || (!tags.level && hasRepeatOn)) {\n\t\t\t\t\tfeature.properties.tags.level = this._cleanLevelTag(feature.properties.own.levels);\n\t\t\t\t\tdelete feature.properties.tags.repeat_on;\n\t\t\t\t}\n\t\t\t\telse if(tags.level && hasRepeatOn) {\n\t\t\t\t\tif(this._isVerticalFeature(feature) && feature.properties.own.levels.length > 1) {\n\t\t\t\t\t\t// Two minimal values for level tag\n\t\t\t\t\t\tfeature.properties.tags.level = this._cleanLevelTag(feature.properties.own.levels.slice(0, 2));\n\n\t\t\t\t\t\t// Other in repeat_on\n\t\t\t\t\t\tif(feature.properties.own.levels.length > 2) {\n\t\t\t\t\t\t\tfeature.properties.tags.repeat_on = this._cleanLevelTag(feature.properties.own.levels.slice(2));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tdelete feature.properties.tags.repeat_on;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if(feature.properties.own.levels.length > 0) {\n\t\t\t\t\t\t// Minimal level in level tag\n\t\t\t\t\t\tfeature.properties.tags.level = feature.properties.own.levels[0];\n\n\t\t\t\t\t\t// Other values in repeat_on\n\t\t\t\t\t\tif(feature.properties.own.levels.length > 1) {\n\t\t\t\t\t\t\tfeature.properties.tags.repeat_on = this._cleanLevelTag(feature.properties.own.levels.slice(1));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tdelete feature.properties.tags.repeat_on;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdelete feature.properties.tags.level;\n\t\t\t\t\t\tdelete feature.properties.tags.repeat_on;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Re-compute building levels\n\t\t\t\tif(tags.building) {\n\t\t\t\t\tfeature.properties.own.levelsComputed = false;\n\t\t\t\t\tfeature = this.getBuildingLevels(feature);\n\t\t\t\t}\n\n\t\t\t\tthis._cacheOsmGeojson.features[featureCacheId] = feature;\n\t\t\t}\n\n\t\t\treturn feature;\n\t\t}\n\t\telse {\n\t\t\tconsole.error(\"Can't find feature in cache\");\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Is a feature having main tags (important tags)\n\t * @param {Object} tags The list of tags\n\t * @return {boolean} True if it has important tags\n\t */\n\thasMainTags(tags) {\n\t\treturn Object.keys(tags).filter(t => !IGNORED_TAGS.includes(t)).length > 0;\n\t}\n\n\t/**\n\t * Makes clean version of level=* tag\n\t * @private\n\t */\n\t_cleanLevelTag(levels) {\n\t\t// Create clean ranges array\n\t\tconst ranges = [];\n\n\t\tlevels.forEach((l,i) => {\n\t\t\tif(i === 0) {\n\t\t\t\tranges.push(l);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tconst prevR = ranges[ranges.length-1];\n\n\t\t\t\tif(Array.isArray(prevR)) {\n\t\t\t\t\tconst prevL = prevR[1];\n\t\t\t\t\tif(prevL === l-1) {\n\t\t\t\t\t\tranges[ranges.length-1][1] = l;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tranges.push(l);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif(prevR === l-1) {\n\t\t\t\t\t\tranges.pop();\n\t\t\t\t\t\tranges.push([prevR, l]);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tranges.push(l);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// Convert into string\n\t\treturn ranges.map(r => (\n\t\t\ttypeof r === \"number\"\n\t\t\t?\n\t\t\tr.toString()\n\t\t\t:\n\t\t\t(r[0] === r[1]-1 ? r[0].toString()+\";\"+r[1].toString() : r[0].toString()+\"-\"+r[1].toString())\n\t\t)).join(\";\");\n\t}\n\n\t/**\n\t * Deletes a given feature.\n\t * @param {Object} feature The feature\n\t * @param {boolean} deleteInside Also delete contained features (only for building/level, defaults to false)\n\t */\n\tdeleteFeature(feature, deleteInside) {\n\t\treturn this._do(new Action(\n\t\t\tAction.FEATURE_DELETE,\n\t\t\tnull,\n\t\t\targuments\n\t\t));\n\t}\n\n\t/**\n\t * Raw feature deletion\n\t * @private\n\t */\n\t_deleteFeature(feature, deleteInside) {\n\t\tconst featureCacheId = this._findCacheId(feature.id);\n\t\tif(featureCacheId !== -1) {\n\t\t\tthis._cacheOsmGeojson.features.splice(featureCacheId, 1);\n\n\t\t\tconst isBuilding = feature.properties.tags.building !== undefined;\n\t\t\tconst isLevel = feature.properties.tags.indoor === \"level\";\n\t\t\tconst level = isLevel && parseFloat(feature.properties.tags.level);\n\n\t\t\tif(deleteInside && (isBuilding || (isLevel && !isNaN(level)))) {\n\t\t\t\tconst deleted = [];\n\t\t\t\tfor(let i=0; i < this._cacheOsmGeojson.features.length; i++) {\n\t\t\t\t\tconst current = this._cacheOsmGeojson.features[i];\n\t\t\t\t\tif(\n\t\t\t\t\t\tcurrent.properties.tags.building === undefined\n\t\t\t\t\t\t&& current.properties.tags[\"building:part\"] === undefined\n\t\t\t\t\t\t&& (isBuilding || (isLevel && deepEqual(current.properties.own.levels, [ level ])))\n\t\t\t\t\t\t&& this._containsWithBoundary(feature, current)\n\t\t\t\t\t) {\n\t\t\t\t\t\tthis._cacheOsmGeojson.features.splice(i, 1);\n\t\t\t\t\t\tdeleted.push(current);\n\t\t\t\t\t\ti--;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Save deleted feature for undoing\n\t\t\t\tif(deleted.length > 0) {\n\t\t\t\t\tthis._actions[this._lastActionId].prev = deleted;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tconsole.log(\"Feature not found in cache\");\n\t\t}\n\t}\n\n\t/**\n\t * Find the feature associated to the OSM node at given coordinates\n\t * @param {LatLng} latlng The coordinates of the node\n\t * @param {Object} [collection] The GeoJSON FeatureCollection to use (by default currently cached data)\n\t * @return {Object} The found node feature (or null if nothing found)\n\t */\n\tfindNodeFeature(latlng, collection) {\n\t\tcollection = collection || this._cacheOsmGeojson;\n\t\tlet result = null;\n\n\t\tif(collection) {\n\t\t\tconst features =\n\t\t\t\tcollection\n\t\t\t\t.features\n\t\t\t\t.filter(f => (\n\t\t\t\t\tf.type === \"Feature\"\n\t\t\t\t\t&& f.geometry.type === \"Point\"\n\t\t\t\t\t&& parseFloat(f.geometry.coordinates[0]) === latlng.lng\n\t\t\t\t\t&& parseFloat(f.geometry.coordinates[1]) === latlng.lat\n\t\t\t\t));\n\n\t\t\tif(features.length === 1) { result = features[0]; }\n\t\t}\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * Find a particular feature in cache\n\t * @param {string} featureId The feature ID\n\t * @param {Object} [collection] The GeoJSON FeatureCollection to use (by default currently cached data)\n\t * @return {Object} The found feature, or null if not found\n\t */\n\tfindFeature(featureId, collection) {\n\t\treturn (collection || this._cacheOsmGeojson).features.find(f => f.id === featureId);\n\t}\n\n\t/**\n\t * Is the small feature on the contour of the wide one ?\n\t * @return {boolean} True if on contour\n\t */\n\tisOnContour(wide, small) {\n\t\treturn !this._booleanContains(wide, small) && this._containsWithBoundary(wide, small);\n\t}\n\n\t/**\n\t * @return The original GeoJSON collection (without edits)\n\t */\n\tgetBaseCollection() {\n\t\treturn this._completeGeoJSON(osmtogeojson(this._cacheOsmXml, { flatProperties: false, uninterestingTags: () => false }));\n\t}\n\n\t/**\n\t * Creates the diff object for current state of the map\n\t * @return {Object} Object with OSM IDs as keys, diff for element as values\n\t */\n\tasync computeDiff() {\n\t\tconst startTs = Date.now();\n\t\tconst prev = this.getBaseCollection();\n\t\tconst next = this._cacheOsmGeojson;\n\n\t\tconst result = this._addDiffMedata(\n\t\t\tawait this._analyzeDiff(prev, next),\n\t\t\tprev,\n\t\t\tnext\n\t\t);\n\n\t\tconsole.log(\"Processed in\", Date.now() - startTs, \"ms\");\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * Creates a new OSM changeset, and uploads to OSM API user edits.\n\t * @param {Object} tags Tags to apply on changeset\n\t * @return {Promise} Resolves on changeset ID if succeed\n\t */\n\tasync sendOSMData(tags) {\n\t\tif(window.editor_user && window.editor_user_auth) {\n\t\t\tconst diff = await this.computeDiff();\n\n\t\t\t// Set authentication info\n\t\t\tthis._osmApi._auth = window.editor_user_auth;\n\n\t\t\t// Create changeset\n\t\t\tconst mytags = Object.assign({ host: window.EDITOR_URL, locale: I18n.locale }, tags);\n\t\t\tdelete mytags.comment;\n\n\t\t\tlet changesetId = null;\n\n\t\t\ttry {\n\t\t\t\tchangesetId = await this._osmApi.createChangeset(\n\t\t\t\t\twindow.EDITOR_NAME+' '+PACKAGE.version,\n\t\t\t\t\ttags.comment || I18n.t(\"Edited building indoors\"),\n\t\t\t\t\tmytags\n\t\t\t\t);\n\t\t\t}\n\t\t\tcatch(e) {\n\t\t\t\treturn new Error(\"Changeset creation failed\");\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tif(changesetId) {\n\t\t\t\t\tconst newElementsIds = {};\n\n\t\t\t\t\t// Sort operations in order to avoid dependency rejections from API\n\t\t\t\t\tconst order = [\n\t\t\t\t\t\t\"node-created\", \"node-edited\",\n\t\t\t\t\t\t\"way-created\", \"way-edited\",\n\t\t\t\t\t\t\"relation-created\", \"relation-edited\",\n\t\t\t\t\t\t\"relation-deleted\", \"way-deleted\", \"node-deleted\"\n\t\t\t\t\t];\n\t\t\t\t\tconst orderFeat = e => (order.indexOf(e[0].split(\"/\")[0] + \"-\" + (e[1].deleted ? \"deleted\" : (e[1].created ? \"created\" : \"edited\"))));\n\t\t\t\t\tconst sort = (a, b) => (orderFeat(a) - orderFeat(b));\n\t\t\t\t\tconst entries = Object.entries(diff).sort(sort);\n\n\t\t\t\t\t// Apply diff and send nodes to API\n\t\t\t\t\tfor(const e of entries) {\n\t\t\t\t\t\tconst [ elemId, elemDiff ] = e;\n\t\t\t\t\t\tconst element = await this._transformDiffIntoElements(elemId, elemDiff, newElementsIds);\n\n\t\t\t\t\t\tif(element) {\n\t\t\t\t\t\t\tconst res = await this._sendElementToApi(elemId, elemDiff, element, newElementsIds, changesetId);\n\t\t\t\t\t\t\tif(!res) {\n\t\t\t\t\t\t\t\treturn new Error(\"Can't upload element\", elemId);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tconsole.warn(\"No element found for\", e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Close changeset\n\t\t\t\t\tawait this._osmApi.closeChangeset(changesetId);\n\t\t\t\t\tthis._disableBeforeUnload();\n\n\t\t\t\t\treturn changesetId;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn new Error(\"Can't create changeset\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tcatch(e) {\n\t\t\t\treturn e;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tconsole.error(\"You should be authenticated before sending your changes\");\n\t\t\treturn new Error(\"Not authenticated\");\n\t\t}\n\t}\n\n\t/**\n\t * @private\n\t */\n\tasync _transformDiffIntoElements(elemId, elemDiff, newElementsIds) {\n\t\tlet element = null;\n\n\t\t// Replace nodes ID in newNodes\n\t\tif(elemDiff.newNodes && elemDiff.newNodes.filter(n => n.startsWith(\"node/-\")).length > 0) {\n\t\t\telemDiff.newNodes = elemDiff.newNodes\n\t\t\t\t.map(n => n.startsWith(\"node/-\") ? newElementsIds[n] : n)\n\t\t\t\t.filter(n => typeof n === \"string\");\n\t\t}\n\n\t\t// Replace members ID in newMembers\n\t\tif(elemDiff.newMembers && elemDiff.newMembers.filter(m => m.feature.startsWith(\"node/-\")).length > 0) {\n\t\t\telemDiff.newMembers = elemDiff.newMembers\n\t\t\t\t.map(m => {\n\t\t\t\t\tif(m.feature.startsWith(\"node/-\")) {\n\t\t\t\t\t\tm.feature = newElementsIds[m.feature];\n\t\t\t\t\t}\n\t\t\t\t\treturn m;\n\t\t\t\t})\n\t\t\t\t.filter(m => typeof m.feature === \"string\");\n\t\t}\n\n\t\t// Create new element\n\t\tif(elemDiff.created) {\n\t\t\tif(elemId.startsWith(\"node/\")) {\n\t\t\t\telement = this._osmApi.createNodeElement(elemDiff.newCoords[1], elemDiff.newCoords[0], elemDiff.newTags, elemId.substring(5));\n\t\t\t}\n\t\t\telse if(elemId.startsWith(\"way/\")) {\n\t\t\t\telement = this._osmApi.createWayElement(elemDiff.newNodes, elemDiff.newTags, elemId.substring(4));\n\t\t\t}\n\t\t\telse if(elemId.startsWith(\"relation/\")) {\n\t\t\t\t//TODO No relation created for now\n\t\t\t}\n\t\t}\n\t\t// Or reuse existing one\n\t\telse {\n\t\t\telement = this._osmApi.findElementWithinOSMCollection(this._cacheOsmJson, elemId);\n\n\t\t\t// Call API if element not available locally\n\t\t\tif(!element) {\n\t\t\t\telement = await this._osmApi.fetchElement(elemId);\n\t\t\t}\n\t\t}\n\n\t\tif(element) {\n\t\t\t// Operations not done in create/delete\n\t\t\tif(!elemDiff.created && !elemDiff.deleted) {\n\t\t\t\t// Change tags\n\t\t\t\tif(elemDiff.newTags) {\n\t\t\t\t\telement = this._osmApi.replaceTags(element, elemDiff.newTags);\n\t\t\t\t}\n\n\t\t\t\t// Change nodes list\n\t\t\t\tif(elemDiff.newNodes) {\n\t\t\t\t\telement = this._osmApi.setNodeIdsForWay(element, elemDiff.newNodes);\n\t\t\t\t}\n\n\t\t\t\t// Change coordinates\n\t\t\t\tif(elemDiff.newCoords) {\n\t\t\t\t\telement = this._osmApi.setCoordinates(element, elemDiff.newCoords[1], elemDiff.newCoords[0]);\n\t\t\t\t}\n\n\t\t\t\t// Change members list\n\t\t\t\tif(elemDiff.newMembers) {\n\t\t\t\t\telement = this._osmApi.setRelationMembers(element, elemDiff.newMembers.map(m => ({ id: m.feature, role: m.role })));\n\t\t\t\t}\n\n\t\t\t\telement = this._osmApi.setTimestampToNow(element);\n\t\t\t}\n\t\t}\n\n\t\treturn element;\n\t}\n\n\t/**\n\t * @private\n\t */\n\tasync _sendElementToApi(elemId, elemDiff, element, newElementsIds, changesetId) {\n\t\tif(elemDiff.deleted) {\n// \t\t\tconsole.log(\"delete\", element, elemDiff);\n\t\t\treturn await this._osmApi.deleteElement(element, changesetId);\n\t\t}\n\t\telse {\n// \t\t\tconsole.log(\"create/update\", element, elemDiff);\n\t\t\tconst result = await this._osmApi.sendElement(element, changesetId);\n\n\t\t\tif(result) {\n\t\t\t\t// Store object ID if created\n\t\t\t\tif(elemDiff.created) {\n\t\t\t\t\tnewElementsIds[elemId] = element._type + \"/\" + result; //TODO To change at osm-request update\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Cancel last edit made by user (if any)\n\t */\n\tundo() {\n\t\tif(this.canUndo()) {\n\t\t\tconst revert = this._actions[this._lastActionId];\n\t\t\tthis._lastActionId--;\n\n\t\t\tswitch(revert.type) {\n\t\t\t\t// Delete feature from cache\n\t\t\t\tcase Action.BUILDING_NEW:\n\t\t\t\t\tPubSub.publish(\"body.select.building\", { building: null });\n\t\t\t\t\t// eslint-disable-next-line\n\t\t\t\tcase Action.FLOOR_NEW:\n\t\t\t\t\tPubSub.publish(\"body.select.floor\", { floor: null });\n\t\t\t\t\t// eslint-disable-next-line\n\t\t\t\tcase Action.FEATURE_NEW:\n\t\t\t\t\tPubSub.publish(\"body.select.feature\", { feature: null });\n\t\t\t\t\tconst fid = this._findCacheId(revert.next[0].id);\n\t\t\t\t\tif(fid !== -1) {\n\t\t\t\t\t\tthis._cacheOsmGeojson.features.splice(fid, 1);\n\t\t\t\t\t}\n\t\t\t\t\tthis._nextId = revert.prev;\n\t\t\t\t\tbreak;\n\n\t\t\t\t// Delete copied features\n\t\t\t\tcase Action.FLOOR_COPY:\n\t\t\t\t\tPubSub.publish(\"body.select.feature\", { feature: null });\n\t\t\t\t\tPubSub.publish(\"body.select.floor\", { floor: null });\n\t\t\t\t\tthis._cacheOsmGeojson.features = this._cacheOsmGeojson.features.filter(f => parseInt(f.id.split(\"/\")[1]) > revert.prev);\n\t\t\t\t\tthis._nextId = revert.prev;\n\t\t\t\t\tbreak;\n\n\t\t\t\t// Reset previous tags\n\t\t\t\tcase Action.FEATURE_TAGS_EDIT:\n\t\t\t\t\tthis._setFeatureTags(...revert.prev);\n\t\t\t\t\tbreak;\n\n\t\t\t\t// Restore previous geometry\n\t\t\t\tcase Action.FEATURE_GEOM_EDIT:\n\t\t\t\t\tthis._editFeatureGeometry(...revert.prev);\n\t\t\t\t\tbreak;\n\n\t\t\t\t// Restore every previous geometries\n\t\t\t\tcase Action.FEATURE_GEOM_SQUARE:\n\t\t\t\t\trevert.prev.forEach(f => {\n\t\t\t\t\t\tconst cacheId = this._findCacheId(f.id);\n\t\t\t\t\t\tif(cacheId >= 0) {\n\t\t\t\t\t\t\tthis._cacheOsmGeojson.features[cacheId] = f;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\n\t\t\t\t// Restore deleted feature\n\t\t\t\tcase Action.FEATURE_DELETE:\n\t\t\t\t\tthis._cacheOsmGeojson.features.push(revert.next[0]);\n\t\t\t\t\tif(revert.next[1] && revert.prev) {\n\t\t\t\t\t\tthis._cacheOsmGeojson.features = this._cacheOsmGeojson.features.concat(revert.prev);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\t// Uncopy feature\n\t\t\t\tcase Action.FEATURE_COPY:\n\t\t\t\t\tPubSub.publish(\"body.select.feature\", { feature: null });\n\t\t\t\t\tthis._cacheOsmGeojson.features.pop();\n\t\t\t\t\tthis._nextId = revert.prev;\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Save an action into stack\n\t * @private\n\t */\n\t_do(action, noSave) {\n\t\tif(!noSave) {\n\t\t\t// Discard next actions, as they will be overwritten by new one\n\t\t\tif(this._actions.length > this._lastActionId + 1) {\n\t\t\t\tthis._actions = this._actions.slice(0, this._lastActionId+1);\n\t\t\t}\n\n\t\t\t// Save this action\n\t\t\tthis._actions.push(action);\n\t\t\tthis._lastActionId++;\n\t\t\tthis._enableBeforeUnload();\n\t\t}\n\n\t\t// Perform the actual action\n\t\tswitch(action.type) {\n\t\t\tcase Action.BUILDING_NEW:\n\t\t\t\treturn this._createNewBuilding(...action.next);\n\n\t\t\tcase Action.FLOOR_NEW:\n\t\t\t\treturn this._createNewFloor(...action.next);\n\n\t\t\tcase Action.FLOOR_COPY:\n\t\t\t\treturn this._copyLevel(...action.next);\n\n\t\t\tcase Action.FEATURE_NEW:\n\t\t\t\treturn this._createNewFeature(...action.next);\n\n\t\t\tcase Action.FEATURE_TAGS_EDIT:\n\t\t\t\t// Merge current and last action if same tag edited\n\t\t\t\tif(\n\t\t\t\t\t!noSave && this._actions.length >= 2\n\t\t\t\t\t&& this._actions[this._actions.length-2].type === Action.FEATURE_TAGS_EDIT\n\t\t\t\t) {\n\t\t\t\t\tconst prevAction = this._actions[this._actions.length-2];\n\t\t\t\t\tconst currAction = this._actions[this._actions.length-1];\n\n\t\t\t\t\t// Same feature\n\t\t\t\t\tif(currAction.next[0] === prevAction.next[0]) {\n\t\t\t\t\t\tconst tagdiff = [];\n\t\t\t\t\t\tconst prevTags = prevAction.next[1];\n\t\t\t\t\t\tconst currTags = currAction.next[1];\n\n\t\t\t\t\t\tObject.entries(currTags).forEach(ct => {\n\t\t\t\t\t\t\tif(ct[1] !== prevTags[ct[0]]) {\n\t\t\t\t\t\t\t\ttagdiff.push(ct[0]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t// Only one edited tag\n\t\t\t\t\t\tif(tagdiff.length === 1 && (!prevAction.lastMerge || prevAction.lastMerge === tagdiff[0])) {\n\t\t\t\t\t\t\tif(this._lastActionId === this._actions.length-1) {\n\t\t\t\t\t\t\t\tthis._lastActionId--;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tthis._actions.splice(this._actions.length-2, 1);\n\t\t\t\t\t\t\tcurrAction.prev = prevAction.prev;\n\t\t\t\t\t\t\tcurrAction.lastMerge = tagdiff[0];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn this._setFeatureTags(...action.next);\n\n\t\t\tcase Action.FEATURE_GEOM_EDIT:\n\t\t\t\treturn this._editFeatureGeometry(...action.next);\n\n\t\t\tcase Action.FEATURE_GEOM_SQUARE:\n\t\t\t\treturn this._makeFeatureSquare(...action.next);\n\n\t\t\tcase Action.FEATURE_DELETE:\n\t\t\t\treturn this._deleteFeature(...action.next);\n\n\t\t\tcase Action.FEATURE_COPY:\n\t\t\t\treturn this._copyFeature(...action.next);\n\n\t\t\tdefault:\n\t\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Computes differences between original data and currently cached data.\n\t * @private\n\t */\n\tasync _analyzeDiff(prev, next) {\n\t\treturn new Promise(resolve => { setTimeout(() => {\n\n\t\t\t// Create indexes of features from prev/next\n\t\t\tconst prevFeaturesById = {};\n\t\t\tconst nextFeaturesById = {};\n\t\t\tprev.features.forEach(f => prevFeaturesById[f.id] = f);\n\t\t\tnext.features.forEach(f => nextFeaturesById[f.id] = f);\n\n\n\t\t\tlet diff = {};\n\t\t\tconst nodeNegativeIds = next.features.filter(f => f.id.startsWith(\"node/-\")).map(f => parseInt(f.id.substring(5)));\n\t\t\tnodeNegativeIds.sort((a,b) => a-b);\n\t\t\tlet nextNodeId = { val: nodeNegativeIds.length > 0 ? nodeNegativeIds[0] - 1 : -1 };\n\t\t\tnext.features = next.features.map(f => this._listFeatureLevels(f));\n\n\t\t\t// Fix nodes that should not change\n\t\t\tconst fixedNodesIds = new Set();\n\n\t\t\tnext.features.forEach(fNext => {\n\t\t\t\tlet fPrev;\n\n\t\t\t\tswitch(fNext.id.split(\"/\")[0]) {\n\t\t\t\t\tcase \"node\":\n\t\t\t\t\t\tif(!fNext.properties.own) { fNext.properties.own = {}; }\n\t\t\t\t\t\tfNext.properties.own.fixed = fNext.properties.own.fixed || this.hasMainTags(fNext.properties.tags);\n\t\t\t\t\t\tif(fNext.properties.own.fixed) { fixedNodesIds.add(fNext.id); }\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase \"way\":\n\t\t\t\t\t\t// If it hasn't changed, fix nodes\n\t\t\t\t\t\tif(this.hasMainTags(fNext.properties.tags)) {\n\t\t\t\t\t\t\tfPrev = prevFeaturesById[fNext.id];\n\n\t\t\t\t\t\t\tif(fPrev && deepEqual(fPrev.geometry, fNext.geometry)) {\n\t\t\t\t\t\t\t\tfNext.properties.own.nodes.filter(nId => !fixedNodesIds.has(nId)).forEach(nId => {\n\t\t\t\t\t\t\t\t\tconst nNext = nextFeaturesById[nId];\n\t\t\t\t\t\t\t\t\tif(nNext) {\n\t\t\t\t\t\t\t\t\t\tnNext.properties.own.fixed = true;\n\t\t\t\t\t\t\t\t\t\tfixedNodesIds.add(nId);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Updates on existing features\n\t\t\tprev.features.forEach(fPrev => {\n\t\t\t\tlet fNext = nextFeaturesById[fPrev.id];\n\t\t\t\tlet featDeleted = !fNext;\n\n\t\t\t\t// Check that we're not deleting an used node\n\t\t\t\tif(featDeleted && fPrev.id.startsWith(\"node/\")) {\n\t\t\t\t\tfor(let nextF of next.features) {\n\t\t\t\t\t\tif(\n\t\t\t\t\t\t\tnextF && nextF.properties.own\n\t\t\t\t\t\t\t&& (\n\t\t\t\t\t\t\t\t(nextF.id.startsWith(\"way/\") && nextF.properties.own.nodes && nextF.properties.own.nodes.find(e => e === fPrev.id))\n\t\t\t\t\t\t\t\t|| (nextF.id.startsWith(\"relation/\") && nextF.properties.own.members && nextF.properties.own.members.find(e => e.feature === fPrev.id))\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tfeatDeleted = false;\n\t\t\t\t\t\t\tfNext = Object.assign({}, fPrev, { properties: { tags: {} } });\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tlet tagsChanged = !featDeleted && !deepEqual(fPrev.properties.tags, fNext.properties.tags);\n\t\t\t\tlet geomChanged = !featDeleted && !deepEqual(fPrev.geometry, fNext.geometry);\n\t\t\t\tlet mbrsChanged = !featDeleted && fPrev.id.startsWith(\"relation/\") && fPrev.properties.own.members.filter(m => diff[m.feature] && diff[m.feature].deleted).length > 0;\n\n\t\t\t\tif(featDeleted || tagsChanged || geomChanged || mbrsChanged) {\n\t\t\t\t\tdiff[fPrev.id] = {};\n\t\t\t\t\tif(featDeleted) { diff[fPrev.id].deleted = true; }\n\t\t\t\t\tif(tagsChanged) { diff[fPrev.id].newTags = this._cleanFeatureTags(fNext.properties.tags); }\n\n\t\t\t\t\t// Geometry changes\n\t\t\t\t\tif(geomChanged) {\n\t\t\t\t\t\t// Node\n\t\t\t\t\t\tif(fPrev.id.startsWith(\"node/\")) {\n\t\t\t\t\t\t\tdiff[fPrev.id].newCoords = fNext.geometry.coordinates;\n\t\t\t\t\t\t\tif(!fNext.properties.own) { fNext.properties.own = {}; }\n\t\t\t\t\t\t\tfNext.properties.own.fixed = this.hasMainTags(fNext.properties.tags);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Way\n\t\t\t\t\t\telse if(fPrev.id.startsWith(\"way/\")) {\n\t\t\t\t\t\t\tdiff = this._assignNodesToWay(diff, prev, next, prevFeaturesById, nextFeaturesById, fPrev, fNext, nextNodeId);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Relation (with geom)\n\t\t\t\t\t\telse if(fPrev.id.startsWith(\"relation/\") && fPrev.type === \"Feature\") {\n\t\t\t\t\t\t\t// Several outer closed ways\n\t\t\t\t\t\t\tif(\n\t\t\t\t\t\t\t\tfNext.geometry.type === \"MultiPolygon\"\n\t\t\t\t\t\t\t\t&& fPrev.properties.own.members.filter(m => m.role === \"inner\").length === 0\n\t\t\t\t\t\t\t\t&& fPrev.properties.own.members.length === fNext.geometry.coordinates.length\n\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t// Associate right way member to appropriate polygon ring\n\t\t\t\t\t\t\t\tconst availableWays = fPrev.properties.own.members.map(m => prevFeaturesById[m.feature]).filter(w => w !== null);\n\n\t\t\t\t\t\t\t\tif(availableWays.length === fNext.geometry.coordinates.length) {\n\t\t\t\t\t\t\t\t\t// Check for identical geometries\n\t\t\t\t\t\t\t\t\tlet polyFeatures = fNext.geometry.coordinates.map(polygon => {\n\t\t\t\t\t\t\t\t\t\tlet found = null;\n\n\t\t\t\t\t\t\t\t\t\tfor(let i=0; i < availableWays.length; i++) {\n\t\t\t\t\t\t\t\t\t\t\tif(deepEqual(\n\t\t\t\t\t\t\t\t\t\t\t\tavailableWays[i].geometry.type === \"LineString\" ?\n\t\t\t\t\t\t\t\t\t\t\t\t\t[ availableWays[i].geometry.coordinates ]\n\t\t\t\t\t\t\t\t\t\t\t\t\t: availableWays[i].geometry.coordinates,\n\t\t\t\t\t\t\t\t\t\t\t\tpolygon\n\t\t\t\t\t\t\t\t\t\t\t)) {\n\t\t\t\t\t\t\t\t\t\t\t\t// If it has changed in next collection, save for update\n\t\t\t\t\t\t\t\t\t\t\t\tconst wayNext = nextFeaturesById[availableWays[i].id];\n\t\t\t\t\t\t\t\t\t\t\t\tif(wayNext && !deepEqual(wayNext.geometry, availableWays[i].geometry)) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tfound = wayNext.geometry;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t// If no changes, just skip it\n\t\t\t\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t\t\t\tfound = \"same\";\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\t\tavailableWays.splice(i, 0);\n\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\treturn found;\n\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\t// Check for most looking alike geometries\n\t\t\t\t\t\t\t\t\tpolyFeatures = polyFeatures.map((rf,polygonId) => {\n\t\t\t\t\t\t\t\t\t\tif(!rf) {\n\t\t\t\t\t\t\t\t\t\t\tlet mostCommonPct = 0;\n\t\t\t\t\t\t\t\t\t\t\tlet mostCommonFeat = null;\n\t\t\t\t\t\t\t\t\t\t\tconst polygon = fNext.geometry.coordinates[polygonId];\n\n\t\t\t\t\t\t\t\t\t\t\tavailableWays.forEach((w, i) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Compute percentage of common nodes\n\t\t\t\t\t\t\t\t\t\t\t\tconst commonNodes = intersectionArray(\n\t\t\t\t\t\t\t\t\t\t\t\t\tpolygon[0],\n\t\t\t\t\t\t\t\t\t\t\t\t\tw.geometry.type === \"LineString\" ? w.geometry.coordinates : w.geometry.coordinates[0]\n\t\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\t\tconst commonNodesPct = commonNodes.length / polygon[0].length;\n\n\t\t\t\t\t\t\t\t\t\t\t\tif(commonNodesPct > mostCommonPct) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tmostCommonPct = commonNodesPct;\n\t\t\t\t\t\t\t\t\t\t\t\t\tmostCommonFeat = w;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\t\t\trf = nextFeaturesById[mostCommonFeat.id];\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\treturn rf;\n\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\t// Update ways accordingly\n\t\t\t\t\t\t\t\t\tpolyFeatures.forEach((rf, i) => {\n\t\t\t\t\t\t\t\t\t\tif(rf !== null && rf !== \"same\") {\n\t\t\t\t\t\t\t\t\t\t\tconst polygon = fNext.geometry.coordinates[i];\n\t\t\t\t\t\t\t\t\t\t\trf.geometry.coordinates = rf.geometry.type === \"LineString\" ? polygon[0] : polygon;\n\t\t\t\t\t\t\t\t\t\t\tdiff = this._assignNodesToWay(diff, prev, next, prevFeaturesById, nextFeaturesById, prevFeaturesById[rf.id], rf, nextNodeId);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// One outer closed way and several inner closed ways (and no added/deleted rings)\n\t\t\t\t\t\t\telse if(\n\t\t\t\t\t\t\t\tfNext.geometry.type === \"Polygon\"\n\t\t\t\t\t\t\t\t&& fPrev.properties.own.members.filter(m => m.role === \"outer\").length === 1\n\t\t\t\t\t\t\t\t&& fPrev.geometry.coordinates.length === fNext.geometry.coordinates.length\n\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t// Associate right way member to appropriate polygon ring\n\t\t\t\t\t\t\t\tconst availableWays = fPrev.properties.own.members.map(m => prevFeaturesById[m.feature]).filter(w => w !== null);\n\n\t\t\t\t\t\t\t\tif(availableWays.length === fNext.geometry.coordinates.length) {\n\t\t\t\t\t\t\t\t\t// Check for identical geometries\n\t\t\t\t\t\t\t\t\tlet ringFeatures = fNext.geometry.coordinates.map(ring => {\n\t\t\t\t\t\t\t\t\t\tlet found = null;\n\n\t\t\t\t\t\t\t\t\t\tfor(let i=0; i < availableWays.length; i++) {\n\t\t\t\t\t\t\t\t\t\t\tif(deepEqual(\n\t\t\t\t\t\t\t\t\t\t\t\tavailableWays[i].geometry.type === \"LineString\" ?\n\t\t\t\t\t\t\t\t\t\t\t\t\tavailableWays[i].geometry.coordinates\n\t\t\t\t\t\t\t\t\t\t\t\t\t: availableWays[i].geometry.coordinates[0],\n\t\t\t\t\t\t\t\t\t\t\t\tring\n\t\t\t\t\t\t\t\t\t\t\t)) {\n\t\t\t\t\t\t\t\t\t\t\t\t// If it has changed in next collection, save for update\n\t\t\t\t\t\t\t\t\t\t\t\tconst wayNext = nextFeaturesById[availableWays[i].id];\n\t\t\t\t\t\t\t\t\t\t\t\tif(wayNext && !deepEqual(wayNext.geometry, availableWays[i].geometry)) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tfound = wayNext.geometry;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t// If no changes, just skip it\n\t\t\t\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t\t\t\tfound = \"same\";\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\t\tavailableWays.splice(i, 0);\n\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\treturn found;\n\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\t// Check for most looking alike geometries\n\t\t\t\t\t\t\t\t\tringFeatures = ringFeatures.map((rf,ringId) => {\n\t\t\t\t\t\t\t\t\t\tif(!rf) {\n\t\t\t\t\t\t\t\t\t\t\tlet mostCommonPct = 0;\n\t\t\t\t\t\t\t\t\t\t\tlet mostCommonFeat = null;\n\t\t\t\t\t\t\t\t\t\t\tconst ring = fNext.geometry.coordinates[ringId];\n\n\t\t\t\t\t\t\t\t\t\t\tavailableWays.forEach((w, i) => {\n\t\t\t\t\t\t\t\t\t\t\t\t// Compute percentage of common nodes\n\t\t\t\t\t\t\t\t\t\t\t\tconst commonNodes = intersectionArray(\n\t\t\t\t\t\t\t\t\t\t\t\t\tring,\n\t\t\t\t\t\t\t\t\t\t\t\t\tw.geometry.type === \"LineString\" ? w.geometry.coordinates : w.geometry.coordinates[0]\n\t\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\t\tconst commonNodesPct = commonNodes.length / ring.length;\n\n\t\t\t\t\t\t\t\t\t\t\t\tif(commonNodesPct > mostCommonPct) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tmostCommonPct = commonNodesPct;\n\t\t\t\t\t\t\t\t\t\t\t\t\tmostCommonFeat = w;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\t\t\trf = nextFeaturesById[mostCommonFeat.id];\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\treturn rf;\n\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\t// Update ways accordingly\n\t\t\t\t\t\t\t\t\tringFeatures.forEach((rf, i) => {\n\t\t\t\t\t\t\t\t\t\tif(rf !== null && rf !== \"same\") {\n\t\t\t\t\t\t\t\t\t\t\tconst ring = fNext.geometry.coordinates[i];\n\t\t\t\t\t\t\t\t\t\t\trf.geometry.coordinates = rf.geometry.type === \"LineString\" ? ring : [ring];\n\t\t\t\t\t\t\t\t\t\t\tdiff = this._assignNodesToWay(diff, prev, next, prevFeaturesById, nextFeaturesById, prevFeaturesById[rf.id], rf, nextNodeId);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tconsole.log(\"Ignored complex multipolygon\", fPrev.id);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Relation members changes\n\t\t\t\t\tif(mbrsChanged) {\n\t\t\t\t\t\tdiff[fPrev.id].newMembers = fPrev.properties.own.members.filter(m => !diff[m.feature] || !diff[m.feature].deleted);\n\t\t\t\t\t\tif(diff[fPrev.id].newMembers.length === 0) {\n\t\t\t\t\t\t\tdiff[fPrev.id] = { deleted: true };\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\n\t\t\t// New features\n\t\t\tnext.features\n\t\t\t.filter(f => !prevFeaturesById[f.id])\n\t\t\t.forEach(fNext => {\n\t\t\t\tdiff[fNext.id] = {\n\t\t\t\t\tcreated: true,\n\t\t\t\t\tnewTags: this._cleanFeatureTags(fNext.properties.tags)\n\t\t\t\t};\n\n\t\t\t\t// Geometry\n\t\t\t\tif(fNext.id.startsWith(\"node/\")) {\n\t\t\t\t\tdiff[fNext.id].newCoords = fNext.geometry.coordinates;\n\t\t\t\t\tif(!fNext.properties.own) { fNext.properties.own = {}; }\n\t\t\t\t\tfNext.properties.own.fixed = true;\n\t\t\t\t}\n\t\t\t\telse if(fNext.id.startsWith(\"way/\")) {\n\t\t\t\t\tdiff = this._assignNodesToWay(diff, prev, next, prevFeaturesById, nextFeaturesById, null, fNext, nextNodeId);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// We don't allow creating new relations for now\n\t\t\t\t}\n\t\t\t});\n\n\n\t\t\tconst nodesAvailable = {};\n\t\t\tnext.features\n\t\t\t.forEach(f => {\n\t\t\t\tif(f.id.startsWith(\"node/\")) {\n\t\t\t\t\tnodesAvailable[f.id] = f.geometry.coordinates;\n\t\t\t\t}\n\t\t\t\telse if(f.id.startsWith(\"way/\")) {\n\t\t\t\t\tconst nodesIds = (diff[f.id] && diff[f.id].newNodes ? diff[f.id].newNodes : f.properties.own.nodes);\n\t\t\t\t\tnodesIds.forEach(n => {\n\t\t\t\t\t\tconst f = nextFeaturesById[n] || prevFeaturesById[n];\n\t\t\t\t\t\tif(f) {\n\t\t\t\t\t\t\tnodesAvailable[n] = f.geometry.coordinates;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tObject.entries(diff)\n\t\t\t.filter(e => e[0].startsWith(\"node/\") && e[1].newCoords)\n\t\t\t.forEach(e => nodesAvailable[e[0]] = e[1].newCoords);\n\n\t\t\t// Add nodes overlapping ways, but not part of them\n\t\t\t// It only merges in specific cases, to keep things connected\n\t\t\tconst roomIndoorTagValues = [\"room\", \"area\", \"corridor\", \"wall\", \"level\"];\n\t\t\tconst dedupeLevels = features => [...new Set(features.map(f => f.properties.own.levels).flat().filter(l => !isNaN(l)))];\n\t\t\tconst nodesFromWays = ways => (\n\t\t\t\t[...new Set(\n\t\t\t\t\tways.map(f => diff[f.id] && diff[f.id].newNodes ? diff[f.id].newNodes : f.properties.own.nodes).flat()\n\t\t\t\t)]\n\t\t\t\t.map(n => [ n, nodesAvailable[n] ])\n\t\t\t\t.filter(n => n[1] !== null)\n\t\t\t);\n\n\t\t\tconst waysInNext = next.features.filter(f => f.id.startsWith(\"way/\"));\n\t\t\tconst waysRoads = waysInNext.filter(f => f.properties.tags.highway);\n\t\t\tconst waysRooms = waysInNext.filter(f => f.properties.tags.indoor && roomIndoorTagValues.includes(f.properties.tags.indoor));\n\t\t\tconst waysBuilding = waysInNext.filter(f => f.properties.tags.building || f.properties.tags[\"building:part\"]);\n\t\t\tconst nodesDoors = next.features.filter(f => f.id.startsWith(\"node\") && (f.properties.tags.door || f.properties.tags.entrance));\n\n\t\t\t// Doors + buildings\n\t\t\tif(nodesDoors.length > 0 && waysBuilding.length > 0) {\n\t\t\t\tdiff = this._connectNodesToWays(\n\t\t\t\t\tdiff, prev, next, prevFeaturesById, nextFeaturesById,\n\t\t\t\t\tnodesDoors.map(f => [ f.id, nodesAvailable[f.id] ]),\n\t\t\t\t\twaysBuilding,\n\t\t\t\t\tnodesAvailable\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Doors + roads/rooms\n\t\t\tdedupeLevels(nodesDoors)\n\t\t\t.forEach(lvl => {\n\t\t\t\tdiff = this._connectNodesToWays(\n\t\t\t\t\tdiff, prev, next, prevFeaturesById, nextFeaturesById,\n\t\t\t\t\tnodesDoors.filter(f => f.properties.own.levels.includes(lvl)).map(f => [ f.id, nodesAvailable[f.id] ]),\n\t\t\t\t\twaysInNext.filter(f => (\n\t\t\t\t\t\tf.properties.own.levels.includes(lvl)\n\t\t\t\t\t\t&& (\n\t\t\t\t\t\t\tf.properties.tags.highway\n\t\t\t\t\t\t\t|| (f.properties.tags.indoor && roomIndoorTagValues.includes(f.properties.tags.indoor))\n\t\t\t\t\t\t)\n\t\t\t\t\t)),\n\t\t\t\t\tnodesAvailable\n\t\t\t\t);\n\t\t\t});\n\n\t\t\t// Roads vertices + roads\n\t\t\tdedupeLevels(waysRoads)\n\t\t\t.forEach(lvl => {\n\t\t\t\tconst waysRoadsLvl = waysRoads.filter(f => f.properties.own.levels.includes(lvl));\n\n\t\t\t\tdiff = this._connectNodesToWays(\n\t\t\t\t\tdiff, prev, next, prevFeaturesById, nextFeaturesById,\n\t\t\t\t\tnodesFromWays(waysRoadsLvl),\n\t\t\t\t\twaysRoadsLvl,\n\t\t\t\t\tnodesAvailable\n\t\t\t\t);\n\t\t\t});\n\n\t\t\t// Room vertices + rooms\n\t\t\tdedupeLevels(waysRooms)\n\t\t\t.forEach(lvl => {\n\t\t\t\tconst waysRoomsLvl = waysRooms.filter(f => f.properties.own.levels.includes(lvl));\n\n\t\t\t\tdiff = this._connectNodesToWays(\n\t\t\t\t\tdiff, prev, next, prevFeaturesById, nextFeaturesById,\n\t\t\t\t\tnodesFromWays(waysRoomsLvl),\n\t\t\t\t\twaysRoomsLvl,\n\t\t\t\t\tnodesAvailable\n\t\t\t\t);\n\t\t\t});\n\n\t\t\t// Room vertices + buildings\n\t\t\tconst nodesFromRooms = nodesFromWays(waysRooms);\n\t\t\tif(nodesFromRooms.length > 0 && waysBuilding.length > 0) {\n\t\t\t\tdiff = this._connectNodesToWays(\n\t\t\t\t\tdiff, prev, next, prevFeaturesById, nextFeaturesById,\n\t\t\t\t\tnodesFromRooms,\n\t\t\t\t\twaysBuilding,\n\t\t\t\t\tnodesAvailable\n\t\t\t\t);\n\t\t\t}\n\n\n\t\t\t// Check for duplicated nodes\n\t\t\tconst nodeByCoords = {};\n\t\t\tObject.entries(nodesAvailable).forEach(e => {\n\t\t\t\tconst [ nid, coords ] = e;\n\t\t\t\tconst coordsStr = JSON.stringify(coords);\n\t\t\t\tif(nodeByCoords[coordsStr]) {\n\t\t\t\t\tnodeByCoords[coordsStr].push(nid);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tnodeByCoords[coordsStr] = [ nid ];\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tObject.entries(nodeByCoords)\n\t\t\t.map(e => {\n\t\t\t\tif(e[1].length <= 1) { return null; }\n\t\t\t\telse {\n\t\t\t\t\t// Several nodes at same coordinates\n\t\t\t\t\t// Are they different POIs or utility nodes to merge ?\n\t\t\t\t\tconst nodesToMerge = e[1].map(nid => {\n\t\t\t\t\t\t// Check in diff\n\t\t\t\t\t\tif(diff[nid] && diff[nid].newTags) {\n\t\t\t\t\t\t\treturn this.hasMainTags(diff[nid].newTags) && !diff[nid].newTags.door ? null : nid;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Check in next collection\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tconst f = nextFeaturesById[nid];\n\n\t\t\t\t\t\t\tif(f) {\n\t\t\t\t\t\t\t\treturn this.hasMainTags(f.properties.tags) && !f.properties.tags.door ? null : nid;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t.filter(nid => nid !== null);\n\n\t\t\t\t\tif(nodesToMerge.length > 1) {\n\t\t\t\t\t\treturn [ e[0], nodesToMerge ];\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t\t.filter(e => e !== null)\n\t\t\t.forEach(e => {\n\t\t\t\tconst nodes = e[1];\n\t\t\t\tconst toKeep = nodes.shift();\n\n\t\t\t\t// Delete duplicated nodes\n\t\t\t\tnodes.forEach(n => {\n\t\t\t\t\tlet tagsToTransfer;\n\n\t\t\t\t\tif(n.startsWith(\"node/-\")) {\n\t\t\t\t\t\ttagsToTransfer = diff[n] && diff[n].newTags;\n\t\t\t\t\t\tdelete diff[n];\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\ttagsToTransfer = (diff[n] && diff[n].newTags) || (prevFeaturesById[n] && prevFeaturesById[n].properties.tags);\n\t\t\t\t\t\tdiff[n] = { deleted: true };\n\t\t\t\t\t}\n\n\t\t\t\t\tdiff = this._replaceNodeInDiff(diff, next, n, toKeep);\n\n\t\t\t\t\t// Copy tags from deleted node to destination node\n\t\t\t\t\tif(tagsToTransfer && Object.keys(tagsToTransfer).length > 0) {\n\t\t\t\t\t\tif(!diff[toKeep]) {\n\t\t\t\t\t\t\tdiff[toKeep] = { newTags: tagsToTransfer };\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if(!diff[toKeep].newTags) {\n\t\t\t\t\t\t\tdiff[toKeep].newTags = tagsToTransfer;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tdiff[toKeep].newTags = Object.assign({}, diff[toKeep].newTags, tagsToTransfer);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\n\n\t\t\t// Unused nodes\n\t\t\tconst newUsedNodes = new Set();\n\t\t\tObject.entries(diff).forEach(e => {\n\t\t\t\tif(e[0].startsWith(\"way/\") && e[1].newNodes) {\n\t\t\t\t\te[1].newNodes.forEach(n => newUsedNodes.add(n));\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tconst newNodes = Object.entries(diff).filter(e => e[0].startsWith(\"node/-\"));\n\n\t\t\t// Look for existing, now useless, nodes\n\t\t\tnext.features\n\t\t\t.filter(f => (\n\t\t\t\tf.id.startsWith(\"node/\")\n\t\t\t\t&& !f.id.startsWith(\"node/-\")\n\t\t\t\t&& (\n\t\t\t\t\t(diff[f.id] && diff[f.id].deleted)\n\t\t\t\t\t||\n\t\t\t\t\t(\n\t\t\t\t\t\t!this.hasMainTags(f.properties.tags) // It's not a POI\n\t\t\t\t\t\t&& !newUsedNodes.has(f.id) // It's not used by a new way\n\t\t\t\t\t\t&& (\n\t\t\t\t\t\t\t!f.properties.own\n\t\t\t\t\t\t\t|| !f.properties.own.ways\n\t\t\t\t\t\t\t|| f.properties.own.ways.filter(w => (diff[w] === undefined || (!diff[w].newNodes && !diff[w].deleted))).length === 0\n\t\t\t\t\t\t)\n\t\t\t\t\t\t&& !f.properties.own.fixed\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t))\n\t\t\t.forEach(fNext => {\n\t\t\t\t// Try to reuse instead of deleting\n\t\t\t\tif(newNodes.length > 0) {\n\t\t\t\t\tconst [ toReplaceId, toReplaceData ] = newNodes.pop();\n\n\t\t\t\t\t// Replace node\n\t\t\t\t\tdelete diff[toReplaceId];\n\t\t\t\t\tif(!fNext.id.startsWith(\"node/-\")) {\n\t\t\t\t\t\tdelete toReplaceData.created;\n\t\t\t\t\t}\n\t\t\t\t\tif(deepEqual(toReplaceData.newTags, fNext.properties.tags)) {\n\t\t\t\t\t\tdelete toReplaceData.newTags;\n\t\t\t\t\t}\n\t\t\t\t\tdiff[fNext.id] = toReplaceData;\n\n\t\t\t\t\t// Replace node references\n\t\t\t\t\tdiff = this._replaceNodeInDiff(diff, next, toReplaceId, fNext.id);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif(fNext.id.startsWith(\"node/-\")) {\n\t\t\t\t\t\tdelete diff[fNext.id];\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdiff[fNext.id] = { deleted: true };\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Double check if list of nodes really changed for way\n\t\t\tObject.entries(diff)\n\t\t\t.filter(e => e[0].startsWith(\"way/\") && e[1].newNodes)\n\t\t\t.forEach(e => {\n\t\t\t\tconst fPrev = prevFeaturesById[e[0]];\n\n\t\t\t\tif(fPrev && deepEqual(fPrev.properties.own.nodes, e[1].newNodes)) {\n\t\t\t\t\tdelete e[1].newNodes;\n\t\t\t\t\tif(Object.keys(e[1]).length === 0) {\n\t\t\t\t\t\tdelete diff[e[0]];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\n\t\t\t// Remove eventual features having no changes after all\n\t\t\tObject.entries(diff)\n\t\t\t.filter(e => Object.keys(e[1]).length === 0)\n\t\t\t.forEach(e => {\n\t\t\t\tdelete diff[e[0]];\n\t\t\t});\n\n\n// \t\t\tconsole.log(\"prev\", prev);\n// \t\t\tconsole.log(\"next\", next);\n// \t\t\tconsole.log(\"diff\", diff);\n\n\t\t\tresolve(diff);\n\t\t}, 0); });\n\t}\n\n\t_cleanFeatureTags(tags) {\n\t\tconst newTags = Object.assign({}, tags);\n\t\tfor(let k in newTags) {\n\t\t\tif(k.trim().length === 0 || typeof newTags[k] !== \"string\" || newTags[k].trim().length === 0) {\n\t\t\t\tdelete newTags[k];\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif(k.trim() !== k) {\n\t\t\t\t\tnewTags[k.trim()] = newTags[k].trim();\n\t\t\t\t\tdelete newTags[k];\n\t\t\t\t}\n\n\t\t\t\tif(newTags[k] && newTags[k].trim() !== newTags[k]) {\n\t\t\t\t\tnewTags[k] = newTags[k].trim();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn newTags;\n\t}\n\n\t/**\n\t * Add metadata to diff for display\n\t * @private\n\t */\n\t_addDiffMedata(diff, prev, next) {\n\t\t// Create indexes of features from prev/next\n\t\tconst prevFeaturesById = {};\n\t\tconst nextFeaturesById = {};\n\t\tprev.features.forEach(f => prevFeaturesById[f.id] = f);\n\t\tnext.features.forEach(f => nextFeaturesById[f.id] = f);\n\n\t\tObject.entries(diff)\n\t\t.forEach(e => {\n\t\t\tconst [ elemId, elemDiff ] = e;\n\t\t\tconst element = nextFeaturesById[elemId] || prevFeaturesById[elemId];\n\t\t\tconst tags = elemDiff.newTags || (element && element.properties.tags) || {};\n\n\t\t\telemDiff.metadata = {\n\t\t\t\ttags: tags,\n\t\t\t\tgeometry: element && element.geometry && element.geometry.type,\n\t\t\t\tname: (\n\t\t\t\t\ttags.name\n\t\t\t\t\t|| tags.ref\n\t\t\t\t\t|| tags.brand\n\t\t\t\t\t|| (\n\t\t\t\t\t\twindow.presetsManager\n\t\t\t\t\t\t&& [...new Set(\n\t\t\t\t\t\t\twindow.presetsManager.findPresetsForFeature({ properties: { tags: tags } })\n\t\t\t\t\t\t\t.map(p => p.name)\n\t\t\t\t\t\t)].join(\", \")\n\t\t\t\t\t)\n\t\t\t\t\t|| elemId\n\t\t\t\t)\n\t\t\t};\n\t\t});\n\n\t\treturn diff;\n\t}\n\n\t/**\n\t * Replaces a node ID in all objects using it\n\t * @private\n\t */\n\t_replaceNodeInDiff(diff, next, oldId, newId) {\n\t\tnext.features\n\t\t.filter(f => f.id.startsWith(\"way/\"))\n\t\t.forEach(f => {\n\t\t\t// Change in diff\n\t\t\tif(diff[f.id] && diff[f.id].newNodes && diff[f.id].newNodes.includes(oldId)) {\n\t\t\t\twhile(diff[f.id].newNodes.includes(oldId)) {\n\t\t\t\t\tdiff[f.id].newNodes[diff[f.id].newNodes.indexOf(oldId)] = newId;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Change in feature properties and insert in diff\n\t\t\tif((!diff[f.id] || !diff[f.id].newNodes) && f.properties.own && f.properties.own.nodes && f.properties.own.nodes.includes(oldId)) {\n\t\t\t\tif(!diff[f.id]) { diff[f.id] = {}; }\n\t\t\t\tdiff[f.id].newNodes = f.properties.own.nodes.map(n => n === oldId ? newId : n);\n\t\t\t}\n\t\t});\n\n\t\treturn diff;\n\t}\n\n\t/**\n\t * Add information of which node is used by way\n\t * @private\n\t */\n\t_assignNodesToWay(diff, prev, next, prevFeaturesById, nextFeaturesById, fPrev, fNext, nextNodeId) {\n\t\t// Empty node list\n\t\tconst fid = fNext.id;\n\t\tlet geom = fNext.geometry.type === \"LineString\" ? fNext.geometry.coordinates : fNext.geometry.coordinates[0];\n\t\tgeom = geom.filter((c, i) => i === 0 || !deepEqual(geom[i-1], c)); // Avoid following coordinates duplicates\n\n\t\tif(!diff[fid]) { diff[fid] = {}; }\n\t\tdiff[fid].newNodes = Array.from({\n\t\t\tlength: geom.length\n\t\t});\n\n\t\t// Try to find nodes at correct position\n\t\tgeom.forEach((coords, i) => {\n\t\t\tconst node = this.findNodeFeature({ lat: coords[1], lng: coords[0] }, next);\n\n\t\t\tif(node) {\n\t\t\t\tdiff[fid].newNodes[i] = node.id;\n\t\t\t}\n\t\t});\n\n\t\t// Associate nodes to the way\n\t\tfor(let i=0; i < diff[fid].newNodes.length; i++) {\n\t\t\tlet nodeId = diff[fid].newNodes[i];\n\t\t\tlet coords = geom[i];\n\n\t\t\t// If this node still not defined\n\t\t\tif(!nodeId) {\n\t\t\t\t// Check again if not newly created node is available\n\t\t\t\tconst newNode = coords && this.findNodeFeature({ lat: coords[1], lng: coords[0] }, next);\n\n\t\t\t\t// Look for nodes exclusively used by this way (for reuse)\n\t\t\t\tconst availableNodes = !newNode && fPrev ? fPrev.properties.own.nodes.filter(nodeId => {\n\t\t\t\t\tif(diff[fid].newNodes.includes(nodeId)) {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tconst nodeNext = nextFeaturesById[nodeId];\n\t\t\t\t\t\tif(!nodeNext) { return false; }\n\t\t\t\t\t\telse if(!nodeNext.properties || !nodeNext.properties.own) { return true; }\n\t\t\t\t\t\telse if(nodeNext.properties.own.fixed) { return false; }\n\t\t\t\t\t\telse if(!nodeNext.properties.own.ways) { return true; }\n\t\t\t\t\t\telse if(nodeNext.properties.own.ways.length > 1) { return false; }\n\t\t\t\t\t\telse if(nodeNext.properties.own.ways.length === 1 && nodeNext.properties.own.ways[0] === fid) { return true; }\n\t\t\t\t\t\telse { return true; }\n\t\t\t\t\t}\n\t\t\t\t}) : null;\n\n\t\t\t\tif(newNode) {\n\t\t\t\t\tdiff[fid].newNodes[i] = newNode.id;\n\t\t\t\t\tnewNode.properties.own.fixed = true;\n\t\t\t\t}\n\t\t\t\t// Reuse available one\n\t\t\t\telse if(availableNodes && availableNodes.length > 0) {\n\t\t\t\t\tconst nodeId = availableNodes.shift();\n\t\t\t\t\tdiff[nodeId] = { newCoords: coords };\n\t\t\t\t\tdiff[fid].newNodes[i] = nodeId;\n\t\t\t\t}\n\t\t\t\t// Or create new node\n\t\t\t\telse {\n\t\t\t\t\tnodeId = \"node/\" + nextNodeId.val--;\n\t\t\t\t\tdiff[nodeId] = { created: true, newCoords: coords, newTags: {} };\n\t\t\t\t\tdiff[fid].newNodes[i] = nodeId;\n\n\t\t\t\t\t// Push in current data, to make these new nodes reusable\n\t\t\t\t\tnext.features.push({\n\t\t\t\t\t\ttype: \"Feature\",\n\t\t\t\t\t\tgeometry: { type: \"Point\", coordinates: diff[nodeId].newCoords },\n\t\t\t\t\t\tid: nodeId,\n\t\t\t\t\t\tproperties: { tags: {}, own: { fixed: true, ways: [ fid ] } }\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn diff;\n\t}\n\n\t/**\n\t * Find coordinates of a node against all data available\n\t * @private\n\t */\n\t_findCoords(id, diff, prev, next, prevFeaturesById, nextFeaturesById) {\n\t\tif(diff[id] && diff[id].newCoords) { return diff[id].newCoords; }\n\t\telse {\n\t\t\tlet f = nextFeaturesById[id] || prevFeaturesById[id];\n\t\t\tif(f) { return f.geometry.coordinates; }\n\t\t\telse { return null; }\n\t\t}\n\t}\n\n\t/**\n\t * Makes nodes connected to ways if they overlap them.\n\t * @private\n\t */\n\t_connectNodesToWays(diff, prev, next, prevFeaturesById, nextFeaturesById, concernedNodes, concernedWays, nodesCoords) {\n\t\tif(concernedNodes.length > 0) {\n\t\t\tconcernedWays.forEach(way => {\n\t\t\t\t// Find potential nodes\n\t\t\t\tconst [ minX, minY, maxX, maxY ] = bbox(way);\n\t\t\t\tconst nearNodes = concernedNodes.filter(n => n[1][0] >= minX && n[1][0] <= maxX && n[1][1] >= minY && n[1][1] <= maxY);\n\n\t\t\t\tif(nearNodes.length > 0) {\n\t\t\t\t\tlet wayNodesIds = (diff[way.id] && diff[way.id].newNodes ? diff[way.id].newNodes : way.properties.own.nodes).slice(0);\n\t\t\t\t\tlet hasChanged = false;\n\n\t\t\t\t\t// Check every segment\n\t\t\t\t\tfor(let i=0; i < wayNodesIds.length - 1; i++) {\n\t\t\t\t\t\tconst nodeStartCoords = nodesCoords[wayNodesIds[i]] || this._findCoords(wayNodesIds[i], diff, prev, next, prevFeaturesById, nextFeaturesById);\n\t\t\t\t\t\tconst nodeEndCoords = nodesCoords[wayNodesIds[i+1]] || this._findCoords(wayNodesIds[i+1], diff, prev, next, prevFeaturesById, nextFeaturesById);\n\n\t\t\t\t\t\t// Check every available node\n\t\t\t\t\t\tif(nodeStartCoords && nodeEndCoords) {\n\t\t\t\t\t\t\tfor(let j=0; j < nearNodes.length; j++) {\n\t\t\t\t\t\t\t\t// If aligned with segment, merge\n\t\t\t\t\t\t\t\tconst [ nodeMidId, nodeMidCoords ] = nearNodes[j];\n\t\t\t\t\t\t\t\tif(\n\t\t\t\t\t\t\t\t\tthis._isOnLine(\n\t\t\t\t\t\t\t\t\t\tNumber(nodeStartCoords[0]),\n\t\t\t\t\t\t\t\t\t\tNumber(nodeStartCoords[1]),\n\t\t\t\t\t\t\t\t\t\tNumber(nodeMidCoords[0]),\n\t\t\t\t\t\t\t\t\t\tNumber(nodeMidCoords[1]),\n\t\t\t\t\t\t\t\t\t\tNumber(nodeEndCoords[0]),\n\t\t\t\t\t\t\t\t\t\tNumber(nodeEndCoords[1]),\n\t\t\t\t\t\t\t\t\t\t2e-7\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\twayNodesIds.splice(i+1, 0, nodeMidId);\n\t\t\t\t\t\t\t\t\thasChanged = true;\n\t\t\t\t\t\t\t\t\ti--;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif(hasChanged) {\n\t\t\t\t\t\t\tif(!diff[way.id]) { diff[way.id] = {}; }\n\t\t\t\t\t\t\tdiff[way.id].newNodes = wayNodesIds;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn diff;\n\t}\n\n\t/**\n\t * Is the point B near to line AC ?\n\t * @private\n\t */\n\t_isOnLine(xa, ya, xb, yb, xc, yc, tolerance) {\n\t\tif((xa === xb && ya === yb) || (xb === xc && yb === yc)) {\n\t\t\treturn false;\n\t\t}\n\t\telse if(((xa <= xb && xb <= xc) || (xa >= xb && xb >= xc)) && ((ya <= yb && yb <= yc) || (ya >= yb && yb >= yc))) {\n\t\t\tconst Dx = xc - xa;\n\t\t\tconst Dy = yc - ya;\n\t\t\tconst d = Math.abs(Dy*xb - Dx*yb - xa*yc+xc*ya)/Math.sqrt(Math.pow(Dx, 2) + Math.pow(Dy, 2));\n\t\t\treturn d <= tolerance;\n\t\t}\n\t\telse {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Add other info to GeoJSON cache, in order to keep track of relations between objects\n\t * @private\n\t */\n\t_completeGeoJSON(collection) {\n\t\t//Add namespace for the editor\n\t\tconst featureById = {};\n\t\tcollection.features = collection.features.filter(f => GeoJSONValidation.valid(f));\n\t\tcollection.features.forEach(f => {\n\t\t\tf.properties.own = {};\n\t\t\tfeatureById[f.id] = f;\n\t\t\tthis._listFeatureLevels(f, true);\n\t\t});\n\n\t\t//Check every feature\n\t\tconst list = this._cacheOsmXml.children[0];\n\t\tfor(let entry of list.children) {\n\t\t\t// Nodes\n\t\t\tif(entry.nodeName === \"node\") {\n\t\t\t\tconst id = \"node/\"+entry.getAttribute(\"id\");\n\n\t\t\t\t//Add utility nodes (not having \"useful\" tags)\n\t\t\t\tif(!featureById[id]) {\n\t\t\t\t\tconst feature = {\n\t\t\t\t\t\tid: id,\n\t\t\t\t\t\ttype: \"Feature\",\n\t\t\t\t\t\tgeometry: {\n\t\t\t\t\t\t\ttype: \"Point\",\n\t\t\t\t\t\t\tcoordinates: fixPrecision([ entry.getAttribute(\"lon\"), entry.getAttribute(\"lat\") ])\n\t\t\t\t\t\t},\n\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\town: { levels: [], utilityNode: true },\n\t\t\t\t\t\t\ttags: {}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\tfeatureById[id] = feature;\n\t\t\t\t\tcollection.features.push(feature);\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Ways\n\t\t\telse if(entry.nodeName === \"way\") {\n\t\t\t\tconst wayId = \"way/\"+entry.getAttribute(\"id\");\n\t\t\t\tconst way = featureById[wayId];\n\n\t\t\t\t// List nodes being a part of this way\n\t\t\t\tif(way) {\n\t\t\t\t\tway.properties.own.nodes = [];\n\n\t\t\t\t\tfor(let subentry of entry.children) {\n\t\t\t\t\t\tif(subentry.nodeName === \"nd\") {\n\t\t\t\t\t\t\tconst nodeId = \"node/\"+subentry.getAttribute(\"ref\");\n\t\t\t\t\t\t\tconst node = featureById[nodeId];\n\t\t\t\t\t\t\tway.properties.own.nodes.push(nodeId);\n\n\t\t\t\t\t\t\tif(node) {\n\t\t\t\t\t\t\t\tif(!node.properties.own.ways) { node.properties.own.ways = []; }\n\t\t\t\t\t\t\t\tnode.properties.own.ways.push(wayId);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Relations\n\t\t\telse if(entry.nodeName === \"relation\") {\n\t\t\t\tconst id = \"relation/\"+entry.getAttribute(\"id\");\n\t\t\t\tconst relation = featureById[id];\n\n\t\t\t\tif(relation) {\n\t\t\t\t\trelation.properties.own.members = [];\n\n\t\t\t\t\tfor(let subentry of entry.children) {\n\t\t\t\t\t\tif(subentry.nodeName === \"member\") {\n\t\t\t\t\t\t\trelation.properties.own.members.push({\n\t\t\t\t\t\t\t\trole: subentry.getAttribute(\"role\"),\n\t\t\t\t\t\t\t\tfeature: subentry.getAttribute(\"type\")+\"/\"+subentry.getAttribute(\"ref\")\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// Append missing relation in data\n\t\t\t\telse {\n\t\t\t\t\tconst tags = {};\n\t\t\t\t\tconst members = [];\n\n\t\t\t\t\t// Parse data\n\t\t\t\t\tfor(let subentry of entry.children) {\n\t\t\t\t\t\tif(subentry.nodeName === \"member\") {\n\t\t\t\t\t\t\tmembers.push({\n\t\t\t\t\t\t\t\trole: subentry.getAttribute(\"role\"),\n\t\t\t\t\t\t\t\tfeature: subentry.getAttribute(\"type\")+\"/\"+subentry.getAttribute(\"ref\")\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if(subentry.nodeName === \"tag\") {\n\t\t\t\t\t\t\ttags[subentry.getAttribute(\"k\")] = subentry.getAttribute(\"v\");\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tcollection.features.push({\n\t\t\t\t\t\tid: id,\n\t\t\t\t\t\ttype: \"Relation\",\n\t\t\t\t\t\tgeometry: null,\n\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\town: { members: members },\n\t\t\t\t\t\t\ttags: tags\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn collection;\n\t}\n\n\t/**\n\t * Find index of this feature in GeoJSON cache\n\t * @private\n\t */\n\t_findCacheId(featureId, collection) {\n\t\treturn (collection || this._cacheOsmGeojson).features.findIndex(f => f.id === featureId);\n\t}\n\n\t/**\n\t * Compute proper list of levels for a given feature\n\t * @param {Object} feature The feature to compute\n\t * @return {Object} The same feature, with list of levels in feature.properties.own.levels\n\t * @private\n\t */\n\t_listFeatureLevels(feature, force) {\n\t\tif(!force && feature.properties.own && (feature.properties.own.levels || feature.properties.own.utilityNode)) {\n\t\t\treturn feature;\n\t\t}\n\t\telse {\n\t\t\tif(!feature.properties.own) {\n\t\t\t\tfeature.properties.own = {};\n\t\t\t}\n\n\t\t\tfeature.properties.own.levels = [];\n\n\t\t\tconst tags = feature.properties.tags;\n\n\t\t\t//No tags\n\t\t\tif((tags === null || Object.keys(tags).length === 0) && (!feature.properties.relations || feature.properties.relations.length === 0)) {\n\t\t\t\tfeature.properties.own.levels = [ 0 ];\n\t\t\t}\n\t\t\t//Tag level + repeat_on\n\t\t\telse if(tags.level !== undefined && tags.repeat_on !== undefined) {\n\t\t\t\tconst lvl1 = this._parseLevelsFloat(tags.level);\n\t\t\t\tconst lvl2 = this._parseLevelsFloat(tags.repeat_on);\n\n\t\t\t\tif(lvl1 !== null && lvl2 !== null) {\n\t\t\t\t\t// Levels from level=* + repeat_on=* removing duplicates\n\t\t\t\t\tfeature.properties.own.levels = lvl1.concat(lvl2.filter((i) => lvl1.indexOf(i) < 0));\n\t\t\t\t}\n\t\t\t\telse if(lvl1 !== null) {\n\t\t\t\t\t// Levels only from level=* because no repeat_on=*\n\t\t\t\t\tfeature.properties.own.levels = lvl1;\n\t\t\t\t}\n\t\t\t\telse if(lvl2 !== null) {\n\t\t\t\t\t// Levels only from repeat_on=* because no level=*\n\t\t\t\t\tfeature.properties.own.levels = lvl2;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// No levels provided, use default level 0\n\t\t\t\t\tfeature.properties.own.levels = [ 0 ];\n\t\t\t\t}\n\t\t\t}\n\t\t\t//Tag level\n\t\t\telse if(tags.level !== undefined) {\n\t\t\t\tfeature.properties.own.levels = this._parseLevelsFloat(tags.level);\n\t\t\t}\n\t\t\t//Tag repeat_on\n\t\t\telse if(tags.repeat_on !== undefined) {\n\t\t\t\tfeature.properties.own.levels = this._parseLevelsFloat(tags.repeat_on);\n\t\t\t}\n\t\t\t//Tag min_level and max_level\n\t\t\telse if(tags.min_level !== undefined && tags.max_level !== undefined) {\n\t\t\t\tfeature.properties.own.levels = this._parseLevelsFloat(tags.min_level+\"-\"+tags.max_level);\n\t\t\t}\n\t\t\t//Tag buildingpart:verticalpassage:floorrange\n\t\t\telse if(tags[\"buildingpart:verticalpassage:floorrange\"] !== undefined) {\n\t\t\t\tfeature.properties.own.levels = this._parseLevelsFloat(tags[\"buildingpart:verticalpassage:floorrange\"]);\n\t\t\t}\n\t\t\t//Tag building:levels\n\t\t\telse if(tags[\"building:levels\"] !== undefined) {\n\t\t\t\tconst lvlsGround = Math.ceil(parseFloat(tags[\"building:levels\"]));\n\t\t\t\tconst lvlsRoof = tags[\"roof:levels\"] !== undefined ? Math.ceil(parseFloat(tags[\"roof:levels\"])) : 0;\n\t\t\t\tconst lvlsUground = tags[\"building:levels:underground\"] !== undefined ? Math.ceil(parseFloat(tags[\"building:levels:underground\"])) : 0;\n\n\t\t\t\tfeature.properties.own.levels = this._parseLevelsFloat(\n\t\t\t\t\t(-lvlsUground)\n\t\t\t\t\t+ \"-\"\n\t\t\t\t\t+ ((lvlsGround+lvlsRoof) - 1)\n\t\t\t\t);\n\t\t\t}\n\t\t\t//Relations (type=level or type=multipolygon)\n\t\t\telse if(feature.properties.relations !== undefined && feature.properties.relations.length > 0) {\n\t\t\t\tfeature.properties.own.levels = [];\n\n\t\t\t\t//Try to find type=level relations, and add level value in level array\n\t\t\t\tfor(const rel of feature.properties.relations) {\n\t\t\t\t\tif(rel.reltags.type === \"level\" && rel.reltags.level !== undefined) {\n\t\t\t\t\t\tconst relLevel = this._parseLevelsFloat(rel.reltags.level);\n\n\t\t\t\t\t\t//Test if level value in relation is unique\n\t\t\t\t\t\tif(relLevel.length === 1) {\n\t\t\t\t\t\t\tfeature.properties.own.levels.push(relLevel[0]);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tconsole.error(\"Invalid level value for relation \"+rel.rel);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if(rel.reltags.type === \"multipolygon\" && rel.reltags.level !== undefined) {\n\t\t\t\t\t\tconst relLevels = this._parseLevelsFloat(rel.reltags.level);\n\n\t\t\t\t\t\trelLevels.forEach(lvl => {\n\t\t\t\t\t\t\tif(!feature.properties.own.levels.includes(lvl)) {\n\t\t\t\t\t\t\t\tfeature.properties.own.levels.push(lvl);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t//Reset list if no level found\n\t\t\tif(!feature.properties.own.levels) {\n\t\t\t\tfeature.properties.own.levels = [];\n\t\t\t}\n\n\t\t\t// Set default level to 0 if none found and not a landuse like feature\n\t\t\tif(feature.properties.own.levels.length === 0 && !this._isLanduse(feature)) {\n\t\t\t\tfeature.properties.own.levels = [ 0 ];\n\t\t\t}\n\n\t\t\tfeature.properties.own.levels.sort(sortNumberArray);\n\t\t\treturn feature;\n\t\t}\n\t}\n\n\t_isVerticalFeature(feature) {\n\t\tconst t = feature.properties.tags;\n\t\treturn (\n\t\t\t[\"elevator\", \"steps\"].includes(t.highway)\n\t\t\t|| t.conveying\n\t\t);\n\t}\n\n\t_isLanduse(feature) {\n\t\tconst t = feature.properties.tags;\n\t\treturn (\n\t\t\tt.landuse\n\t\t\t|| [\"school\",\"university\",\"college\",\"hospital\"].includes(t.amenity)\n\t\t\t|| t.boundary\n\t\t\t|| t[\"disused:boundary\"]\n\t\t\t|| (t.leisure === \"sports_centre\" && !t.building)\n\t\t);\n\t}\n\n\t/**\n\t * Failsafe wrapper around booleanContains\n\t * @private\n\t */\n\t_booleanContains(wide, small) {\n\t\ttry {\n\t\t\t// Check types\n\t\t\tconst types = {\n\t\t\t\t\"MultiPolygon\": [ \"MultiPolygon\", \"Polygon\", \"LineString\", \"Point\" ],\n\t\t\t\t\"Polygon\": [ \"Polygon\", \"LineString\", \"Point\" ],\n\t\t\t\t\"LineString\": [ \"LineString\", \"Point\" ],\n\t\t\t\t\"Point\": [ \"Point\" ]\n\t\t\t};\n\n\t\t\treturn types[wide.geometry.type].includes(small.geometry.type) && booleanContains(wide, small);\n\t\t}\n\t\tcatch(e) {\n\t\t\tconsole.error(\"Unsupported operation for \", wide.id, small.id);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Is the editor in capacity of handling the wanted geometry editing of relation\n\t * @param {Object} prev The relation old feature\n\t * @param {Object} next The relation new feature\n\t * @return {boolean} True if editor supports wanted geometry edit\n\t */\n\tisRelationEditingSupported(prev, next) {\n\t\tif(prev && next && prev.type === \"Feature\" && next.type === \"Feature\" && prev.geometry.type === next.geometry.type) {\n\t\t\tif(next.geometry.type === \"MultiPolygon\") {\n\t\t\t\t// Several outer polygons (same amount) + no inner\n\t\t\t\treturn (\n\t\t\t\t\tprev.properties.own.members.filter(m => m.role === \"inner\").length === 0\n\t\t\t\t\t&& prev.properties.own.members.length === next.geometry.coordinates.length\n\t\t\t\t\t&& next.geometry.coordinates.filter(p => !Array.isArray(p)).length === 0\n\t\t\t\t);\n\t\t\t}\n\t\t\telse if(next.geometry.type === \"Polygon\") {\n\t\t\t\t// A single outer polygon + several inner (same amount)\n\t\t\t\treturn (\n\t\t\t\t\tprev.properties.own.members.filter(m => m.role === \"outer\").length === 1\n\t\t\t\t\t&& prev.geometry.coordinates.length === next.geometry.coordinates.length\n\t\t\t\t\t&& next.geometry.coordinates.filter(r => !Array.isArray(r) || (new Set(r.map(c => c.join(\",\")))).size < 3).length === 0\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t* Parses levels list.\n\t* @param str The levels as a string (for example \"1;5\", \"1,3\", \"1-3\", \"-1--6\", \"from 1 to 42\" or \"-2 to 6\")\n\t* @return The parsed levels as a float array, or null if invalid\n\t* @private\n\t*/\n\t_parseLevelsFloat(str) {\n\t\tif(!str || typeof str !== \"string\" || str.trim().length === 0) {\n\t\t\treturn null;\n\t\t}\n\n\t\tlet result = null;\n\n\t\t//Level values separated by ';'\n\t\tconst regex1 = /^-?\\d+(?:\\.\\d+)?(?:;-?\\d+(?:\\.\\d+)?)*$/;\n\n\t\t//Level values separated by ','\n\t\tconst regex2 = /^-?\\d+(?:\\.\\d+)?(?:,-?\\d+(?:\\.\\d+)?)*$/;\n\n\t\tif(regex1.test(str)) {\n\t\t\tresult = str.split(';').map(parseFloat);\n\t\t\tresult.sort(sortNumberArray);\n\t\t}\n\t\telse if(regex2.test(str)) {\n\t\t\tresult = str.split(',').map(parseFloat);\n\t\t\tresult.sort(sortNumberArray);\n\t\t}\n\t\t//Level intervals\n\t\telse {\n\t\t\tlet regexResult = null;\n\t\t\tlet min = null;\n\t\t\tlet max = null;\n\n\t\t\t//Level values (only integers) in an interval, bounded with '-'\n\t\t\tconst regex3 = /^(-?\\d+)-(-?\\d+)$/;\n\n\t\t\t//Level values from start to end (example: \"-3 to 2\")\n\t\t\tconst regex4 = /^(?:\\w+ )?(-?\\d+) to (-?\\d+)$/;\n\n\t\t\tif(regex3.test(str)) {\n\t\t\t\tregexResult = regex3.exec(str);\n\t\t\t\tmin = parseInt(regexResult[1]);\n\t\t\t\tmax = parseInt(regexResult[2]);\n\t\t\t}\n\t\t\telse if(regex4.test(str)) {\n\t\t\t\tregexResult = regex4.exec(str);\n\t\t\t\tmin = parseInt(regexResult[1]);\n\t\t\t\tmax = parseInt(regexResult[2]);\n\t\t\t}\n\n\t\t\t//Add values between min and max\n\t\t\tif(regexResult !== null && min !== null && max !== null) {\n\t\t\t\tresult = [];\n\t\t\t\tif(min > max) {\n\t\t\t\t\tconst tmp = min;\n\t\t\t\t\tmin = max;\n\t\t\t\t\tmax = tmp;\n\t\t\t\t}\n\n\t\t\t\t//Add intermediate values\n\t\t\t\tfor(let i = min; i !== max; i = i + ((max-min) / Math.abs(max-min))) {\n\t\t\t\t\tresult.push(i);\n\t\t\t\t}\n\n\t\t\t\tresult.push(max);\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * Enable message before quitting page\n\t * @private\n\t */\n\t_enableBeforeUnload() {\n\t\twindow.onbeforeunload = () => {\n\t\t\treturn I18n.t(\"Did you save all your changes ? If not, your changes will be lost.\")\n\t\t};\n\t}\n\n\t/**\n\t * Disable message before quitting page\n\t * @private\n\t */\n\t_disableBeforeUnload() {\n\t\twindow.onbeforeunload = null;\n\t}\n}\n\nexport default VectorDataManager;\n","/*\n * This file is part of OsmInEdit, released under ISC license (see LICENSE.md)\n *\n * Copyright (c) Adrien Pavie 2019\n * Copyright (c) Daimler AG 2019\n *\n * Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n *\n */\n\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport Body from './view/Body';\nimport I18n from './config/locales/ui';\nimport ImageryManager from './ctrl/ImageryManager';\nimport { osmAuth } from 'osm-auth';\nimport PresetsManager from './ctrl/PresetsManager';\nimport PubSub from 'pubsub-js';\nimport request from 'request-promise-native';\nimport VectorDataManager from './ctrl/VectorDataManager';\n\n/**\n * App is the application starter.\n * It creates mostly everything.\n */\nclass App {\n\tconstructor() {\n\t\tthis._initI18n();\n\t\tthis._initCtrl();\n\t\tthis._initView();\n\t\tthis._initAuth();\n\t}\n\n\t/**\n\t * Initializes internationalization system\n\t * @private\n\t */\n\t_initI18n() {\n\t\tlet locale = null;\n\t\tif(window.navigator.languages) {\n\t\t\tfor(const l of window.navigator.languages) {\n\t\t\t\tif(I18n.supportedLocales.includes(l)) {\n\t\t\t\t\tlocale = l;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tI18n.changeLocale(locale || window.navigator.userLanguage || window.navigator.language);\n\t}\n\n\t/**\n\t * Creates controller objects.\n\t * @private\n\t */\n\t_initCtrl() {\n\t\twindow.vectorDataManager = new VectorDataManager();\n\t\twindow.presetsManager = new PresetsManager();\n\t\twindow.imageryManager = new ImageryManager();\n\n\t\t// Preload some data\n\t\twindow.presetsManager.loadPresets();\n\t\twindow.imageryManager.getAvailableImagery();\n\t}\n\n\t/**\n\t * Create view components\n\t * @private\n\t */\n\t_initView() {\n\t\tReactDOM.render(<Body />, document.getElementById('root'));\n\t\tdocument.title=window.EDITOR_NAME;\n\n\t\t// Disabling context menu\n\t\tdocument.oncontextmenu = () => {\n\t\t\treturn false;\n\t\t};\n\t}\n\n\t/**\n\t * Launches authentication process\n\t * @private\n\t */\n\t_initAuth() {\n\t\tconst opts = {\n\t\t\tapiUrl: window.CONFIG.osm_api_url,\n\t\t\turl: window.CONFIG.osm_api_url,\n\t\t\tclient_id: window.CONFIG.oauth_consumer_key,\n\t\t\tredirect_uri: window.EDITOR_URL,\n\t\t\tscope: \"read_prefs write_api\",\n\t\t\tsinglepage: true\n\t\t};\n\t\twindow.editor_user_auth = osmAuth(opts);\n\n\t\tconst params = this._readURLParams(window.location.href);\n\n\t\tif(params.code) {\n\t\t\twindow.editor_user_auth.authenticate(() => {\n\t\t\t\tthis._checkAuth();\n\t\t\t\tlocalStorage.setItem(\"oauth_token\", params.code);\n\t\t\t\twindow.history.replaceState({}, \"\", window.location.href.replace(/\\?.*/, \"\"));\n\t\t\t});\n\t\t}\n\t\telse if(localStorage.getItem(\"oauth_token\")) {\n\t\t\twindow.editor_user_auth.bootstrapToken(localStorage.getItem(\"oauth_token\"), () => {\n\t\t\t\tthis._checkAuth();\n\t\t\t});\n\t\t}\n\t\telse {\n\t\t\t//Check if we receive auth token\n\t\t\tthis._checkAuth();\n\t\t\tthis.authWait = setInterval(this._checkAuth.bind(this), 100);\n\t\t}\n\n\n\t\t/**\n\t\t * Event for logging in user\n\t\t * @event app.user.login\n\t\t * @memberof App\n\t\t */\n\t\tPubSub.subscribe(\"app.user.login\", (msg, data) => {\n\t\t\tif(!window.editor_user_auth.authenticated()) {\n\t\t\t\twindow.editor_user_auth.authenticate((err, res) => {\n\t\t\t\t\tif(err) {\n\t\t\t\t\t\tconsole.error(err);\n\t\t\t\t\t\talert(I18n.t(\"Oops ! Something went wrong when trying to log you in\"));\n\t\t\t\t\t\tPubSub.publish(\"app.user.logout\");\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tthis._checkAuth();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Event for logging out user (not done yet)\n\t\t * @event app.user.logout\n\t\t * @memberof App\n\t\t */\n\t\tPubSub.subscribe(\"app.user.logout\", (msg, data) => {\n\t\t\tif(window.editor_user_auth && window.editor_user_auth.authenticated()) {\n\t\t\t\twindow.editor_user_auth.logout();\n\t\t\t}\n\n\t\t\twindow.editor_user = null;\n\t\t\tlocalStorage.removeItem(\"oauth_token\");\n\n\t\t\t/**\n\t\t\t * Event when user has been successfully logged out\n\t\t\t * @event app.user.left\n\t\t\t * @memberof App\n\t\t\t */\n\t\t\tPubSub.publish(\"app.user.left\");\n\t\t});\n\t}\n\n\t/**\n\t * Check if authentication happened\n\t * @private\n\t */\n\t_checkAuth() {\n\t\tif(window.editor_user_auth.authenticated()) {\n\t\t\tif(this.authWait) {\n\t\t\t\tclearInterval(this.authWait);\n\t\t\t}\n\n\t\t\t//Get user details\n\t\t\twindow.editor_user_auth.xhr({\n\t\t\t\tmethod: 'GET',\n\t\t\t\tpath: '/api/0.6/user/details'\n\t\t\t}, (err, details) => {\n\t\t\t\tif(err) {\n\t\t\t\t\tconsole.log(err);\n\t\t\t\t\twindow.editor_user_auth.logout();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\ttry {\n\t\t\t\t\t\twindow.editor_user = {\n\t\t\t\t\t\t\tid: details.firstChild.childNodes[1].attributes.id.value,\n\t\t\t\t\t\t\tname: details.firstChild.childNodes[1].attributes.display_name.value,\n\t\t\t\t\t\t\tauth: window.editor_user_auth\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * Event when user has been successfully logged in\n\t\t\t\t\t\t * @event app.user.ready\n\t\t\t\t\t\t * @memberof App\n\t\t\t\t\t\t */\n\t\t\t\t\t\tPubSub.publish(\"app.user.ready\", { username: window.editor_user.name });\n\t\t\t\t\t\tconsole.log(\"Logged in as\", window.editor_user.name);\n\t\t\t\t\t}\n\t\t\t\t\tcatch(e) {\n\t\t\t\t\t\tconsole.error(e);\n\t\t\t\t\t\tPubSub.publish(\"app.user.logout\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Parse URL parameters\n\t * @private\n\t */\n\t_readURLParams(str) {\n\t\tconst u = str.split('?');\n\n\t\tif(u.length > 1) {\n\t\t\tconst p = u[1].split('#')[0];\n\n\t\t\treturn p.split('&').filter(function (pair) {\n\t\t\t\treturn pair !== '';\n\t\t\t}).reduce(function(obj, pair){\n\t\t\t\tvar parts = pair.split('=');\n\t\t\t\tobj[decodeURIComponent(parts[0])] = (null === parts[1]) ?\n\t\t\t\t\t'' : decodeURIComponent(parts[1]);\n\t\t\t\treturn obj;\n\t\t\t}, {});\n\t\t}\n\t\telse {\n\t\t\treturn {};\n\t\t}\n\t}\n}\n\n\n/*\n * Global variables definition\n */\n\nwindow.EDITOR_URL = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/')) + \"/\";\nwindow.UNUSABLE_ICONS = new Set();\n\n// Dynamically load config file\nrequest(window.EDITOR_URL + \"/config.json\")\n.then(configTxt => {\n\twindow.CONFIG = JSON.parse(configTxt);\n\twindow.EDITOR_NAME = window.CONFIG.editor_name;\n\n\t// Create app\n\tnew App();\n})\n.catch(e => {\n\tconsole.error(e);\n\talert(\"Can't load configuration file, please report this issue.\");\n});\n"],"sourceRoot":""}